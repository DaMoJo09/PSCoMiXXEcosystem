<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a0a0a">
    <title>Press Start CoMixx</title>
    
    <!-- iOS PERFORMANCE MODE - Disable heavy animations only -->
    <script>
    // Simplified iOS fix - only disable heavy animations, NOT transforms
    if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
        var style = document.createElement('style');
        style.id = 'ios-performance-fix';
        style.textContent = [
            '.stars, .stars-layer-2, .stars-layer-3, .comet, .nebula, .particle { display: none !important; }',
            '.space-bg { background: #000 !important; }'
        ].join('');
        document.head.appendChild(style);
        
        document.addEventListener('DOMContentLoaded', function() {
            document.body.classList.add('ios-performance-mode');
        });
    }
    </script>
    
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-HLMLY9K2FZ"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-HLMLY9K2FZ', {
            page_title: 'Press Start CoMixx',
            send_page_view: true
        });
        
        // GA4 Event Tracking Helper
        function trackEvent(eventName, params = {}) {
            if (typeof gtag === 'function') {
                gtag('event', eventName, params);
            }
        }
    </script>
    
    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icon-152.png">
    <link rel="apple-touch-icon" sizes="120x120" href="icon-120.png">
    <link rel="apple-touch-icon" href="icon-180.png">
    <link rel="manifest" href="manifest.json">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Bangers&display=swap');
        
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        /* ============ iOS CRASH PREVENTION - SIMPLIFIED ============ */
        
        /* Hide tooltips on touch devices to avoid sticky tooltips */
        @media (hover: none) {
            [data-tooltip]:hover::after,
            [data-tooltip]:hover::before {
                display: none;
            }
        }
        
        /* iOS Performance Mode - applied via JavaScript on iOS devices */
        .ios-performance-mode .stars,
        .ios-performance-mode .stars-layer-2,
        .ios-performance-mode .stars-layer-3,
        .ios-performance-mode .comet,
        .ios-performance-mode .nebula,
        .ios-performance-mode .particle {
            display: none !important;
        }
        
        .ios-performance-mode .space-bg {
            background: #000 !important;
        }
        
        /* Custom tooltip styles */
        [data-tooltip] {
            position: relative;
        }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            color: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            border: 1px solid #333;
            pointer-events: none;
            animation: tooltipFade 0.2s ease;
        }
        [data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #000;
            z-index: 1001;
        }
        @keyframes tooltipFade {
            from { opacity: 0; transform: translateX(-50%) translateY(4px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        /* Hide tooltips on touch devices to avoid sticky tooltips */
        @media (hover: none) {
            [data-tooltip]:hover::after,
            [data-tooltip]:hover::before {
                display: none;
            }
        }
        
        /* LEGAL GATE STYLES */
        .legal-gate {
            position: fixed;
            inset: 0;
            z-index: 99999;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .legal-gate.hidden {
            display: none;
        }
        
        .legal-modal {
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .legal-header {
            padding: 20px 24px;
            background: linear-gradient(180deg, #111, #0a0a0a);
            border-bottom: 1px solid #222;
            text-align: center;
        }
        
        .legal-logo {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 28px;
            color: #fff;
            letter-spacing: 4px;
            margin-bottom: 4px;
        }
        
        .legal-subtitle {
            font-size: 10px;
            color: #666;
            letter-spacing: 2px;
        }
        
        .legal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            font-size: 12px;
            line-height: 1.7;
            color: #999;
        }
        
        .legal-body h2 {
            font-size: 14px;
            color: #fff;
            margin: 20px 0 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legal-body h2:first-child {
            margin-top: 0;
        }
        
        .legal-body p {
            margin-bottom: 12px;
        }
        
        .legal-body ul {
            margin: 8px 0 12px 20px;
        }
        
        .legal-body li {
            margin-bottom: 4px;
        }
        
        .legal-body strong {
            color: #fff;
        }
        
        .legal-footer {
            padding: 20px 24px;
            background: #111;
            border-top: 1px solid #222;
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
            z-index: 100;
        }
        
        .legal-btn {
            width: 100%;
            padding: 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            letter-spacing: 1px;
            transition: all 0.2s;
            position: relative;
            z-index: 101;
        }
        
        .legal-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .legal-btn.primary {
            background: #fff;
            color: #000;
            border: none;
        }
        
        .legal-btn.primary:hover:not(:disabled) {
            background: #ddd;
        }
        
        .legal-btn.secondary {
            background: transparent;
            color: #666;
            border: 1px solid #333;
        }
        
        .legal-btn.secondary:hover {
            border-color: #666;
            color: #999;
        }
        
        .legal-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: #0a0a0a;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .legal-checkbox input {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            accent-color: #fff;
        }
        
        .legal-checkbox span {
            font-size: 11px;
            color: #888;
            line-height: 1.5;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
            position: fixed;
            inset: 0;
        }
        
        .app {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            background: #000;
        }
        
        /* FUTURISTIC SPACE BACKGROUND */
        .space-bg {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
            background: radial-gradient(ellipse at 50% 100%, #0a0a0a 0%, #000 50%, #000 100%);
        }
        
        /* Dense starfield - multiple layers for depth */
        .stars {
            position: absolute;
            width: 200%;
            height: 200%;
            background-image: 
                radial-gradient(1px 1px at 10px 10px, #fff, transparent),
                radial-gradient(1px 1px at 50px 30px, #fff, transparent),
                radial-gradient(1px 1px at 100px 60px, rgba(255,255,255,0.8), transparent),
                radial-gradient(2px 2px at 150px 20px, #fff, transparent),
                radial-gradient(1px 1px at 200px 90px, #fff, transparent),
                radial-gradient(1px 1px at 250px 40px, rgba(255,255,255,0.6), transparent),
                radial-gradient(2px 2px at 300px 120px, #fff, transparent),
                radial-gradient(1px 1px at 350px 70px, #fff, transparent),
                radial-gradient(1px 1px at 400px 150px, rgba(255,255,255,0.7), transparent),
                radial-gradient(2px 2px at 450px 30px, #fff, transparent),
                radial-gradient(1px 1px at 480px 100px, #fff, transparent);
            background-size: 500px 200px;
            animation: starDrift 80s linear infinite;
        }
        
        .stars-layer-2 {
            position: absolute;
            width: 200%;
            height: 200%;
            background-image: 
                radial-gradient(1px 1px at 25px 50px, #fff, transparent),
                radial-gradient(1.5px 1.5px at 75px 25px, rgba(255,255,255,0.9), transparent),
                radial-gradient(1px 1px at 125px 80px, #fff, transparent),
                radial-gradient(1px 1px at 175px 45px, rgba(255,255,255,0.7), transparent),
                radial-gradient(2px 2px at 225px 95px, #fff, transparent),
                radial-gradient(1px 1px at 275px 35px, #fff, transparent),
                radial-gradient(1px 1px at 325px 75px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1.5px 1.5px at 375px 15px, #fff, transparent),
                radial-gradient(1px 1px at 425px 65px, #fff, transparent);
            background-size: 450px 150px;
            animation: starDrift 120s linear infinite reverse;
            opacity: 0.7;
        }
        
        .stars-layer-3 {
            position: absolute;
            width: 200%;
            height: 200%;
            background-image: 
                radial-gradient(3px 3px at 100px 100px, rgba(255,255,255,0.4), transparent),
                radial-gradient(2px 2px at 300px 150px, rgba(255,255,255,0.3), transparent),
                radial-gradient(4px 4px at 500px 80px, rgba(255,255,255,0.2), transparent);
            background-size: 800px 300px;
            animation: starDrift 200s linear infinite;
            opacity: 0.5;
        }
        
        @keyframes starDrift {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-50%, -50%); }
        }
        
        /* Subtle grid overlay for sci-fi feel */
        .grid-overlay {
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridPulse 4s ease-in-out infinite;
        }
        
        @keyframes gridPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.5; }
        }
        
        /* Floating particles */
        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #fff;
            border-radius: 50%;
            opacity: 0;
            animation: particleFloat 10s ease-in-out infinite;
        }
        
        @keyframes particleFloat {
            0% { opacity: 0; transform: translateY(100vh) scale(0); }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { opacity: 0; transform: translateY(-100px) scale(1); }
        }
        
        /* Comet/shooting star - more elegant */
        .comet {
            position: absolute;
            width: 150px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), rgba(255,255,255,0.8), #fff);
            opacity: 0;
            animation: cometFly 12s ease-in-out infinite;
            transform-origin: right center;
        }
        
        .comet::before {
            content: '';
            position: absolute;
            right: 0;
            top: -2px;
            width: 5px;
            height: 5px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px #fff, 0 0 20px rgba(255,255,255,0.5);
        }
        
        .comet:nth-child(1) { top: 15%; left: 5%; animation-delay: 0s; transform: rotate(35deg); }
        .comet:nth-child(2) { top: 45%; left: 70%; animation-delay: 4s; transform: rotate(25deg); }
        .comet:nth-child(3) { top: 75%; left: 20%; animation-delay: 8s; transform: rotate(40deg); }
        
        @keyframes cometFly {
            0% { opacity: 0; transform: translateX(0) rotate(35deg); }
            5% { opacity: 1; }
            15% { opacity: 0; transform: translateX(400px) rotate(35deg); }
            100% { opacity: 0; }
        }
        
        /* Nebula glow - subtle */
        .nebula {
            position: absolute;
            width: 400px;
            height: 400px;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.08;
            animation: nebulaFloat 40s ease-in-out infinite;
        }
        
        .nebula-1 {
            background: radial-gradient(circle, rgba(255,255,255,0.4) 0%, transparent 70%);
            top: -100px;
            left: -100px;
        }
        
        .nebula-2 {
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            bottom: -150px;
            right: -100px;
            animation-delay: -20s;
        }
        
        @keyframes nebulaFloat {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(30px, 20px) scale(1.05); }
        }
        
        /* Battle hit animations */
        @keyframes cardHit {
            0% { transform: translateX(0) rotate(0deg); }
            10% { transform: translateX(-20px) rotate(-5deg); }
            20% { transform: translateX(15px) rotate(3deg); }
            30% { transform: translateX(-10px) rotate(-2deg); }
            40% { transform: translateX(5px) rotate(1deg); }
            50% { transform: translateX(0) rotate(0deg); }
        }
        
        @keyframes cardWin {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); box-shadow: 0 0 30px rgba(255,255,255,0.8); }
            100% { transform: scale(1); }
        }
        
        @keyframes cardLose {
            0% { transform: scale(1); filter: brightness(1); }
            25% { transform: scale(0.95); filter: brightness(0.5); }
            50% { transform: scale(1); filter: brightness(1); }
            75% { transform: scale(0.97); filter: brightness(0.7); }
            100% { transform: scale(1); filter: brightness(1); }
        }
        
        .card-hit { animation: cardHit 0.5s ease-out; }
        .card-win { animation: cardWin 0.6s ease-out; }
        .card-lose { animation: cardLose 0.6s ease-out; }
        
        /* ========== CREATOR STUDIO THEME - BLACK & WHITE ========== */
        :root {
            --studio-bg: #0a0a0a;
            --studio-sidebar: #111111;
            --studio-accent: #ffffff;
            --studio-accent-dark: #888888;
            --studio-text: #ffffff;
            --studio-text-muted: #888888;
            --studio-border: #2a2a2a;
            --studio-hover: #1a1a1a;
            --studio-active: #222222;
            --studio-success: #ffffff;
            --studio-warning: #cccccc;
            --studio-danger: #888888;
        }
        
        /* Light Mode */
        .light-mode {
            --studio-bg: #f5f5f5;
            --studio-sidebar: #ffffff;
            --studio-accent: #000000;
            --studio-accent-dark: #666666;
            --studio-text: #000000;
            --studio-text-muted: #666666;
            --studio-border: #e0e0e0;
            --studio-hover: #f0f0f0;
            --studio-active: #e8e8e8;
            --studio-success: #000000;
            --studio-warning: #444444;
            --studio-danger: #666666;
        }
        
        .light-mode .space-bg {
            background: var(--studio-bg) !important;
        }
        
        .light-mode .stars {
            opacity: 0 !important;
        }
        
        .light-mode .canvas {
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }
        
        .light-mode .panel {
            border-color: #ccc;
        }
        
        .light-mode .panel.selected {
            border-color: #000;
        }
        
        .light-mode .gizmo-handle {
            background: #000;
            border-color: #000;
            color: #fff;
        }
        
        .light-mode .gizmo-handle.rotate {
            background: linear-gradient(145deg, #333, #000);
        }
        
        .light-mode .gizmo-line {
            background: linear-gradient(180deg, rgba(0,0,0,0.9), rgba(0,0,0,0.3));
        }
        
        .light-mode .element .el-gizmo-handle {
            background: #000;
            border-color: #000;
            color: #fff;
        }
        
        .light-mode .element .el-gizmo-rotate {
            background: linear-gradient(145deg, #333, #000);
        }
        
        .light-mode .element.selected::after {
            border-color: rgba(0,0,0,0.6);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        
        .light-mode .sheet {
            background: #fff;
            border-color: #e0e0e0;
        }
        
        .light-mode .toast {
            background: #000;
            color: #fff;
        }
        
        /* Header - Creator Studio Style */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--studio-sidebar);
            border-bottom: 1px solid var(--studio-border);
            flex-shrink: 0;
            position: relative;
            z-index: 10;
            gap: 12px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .header-back {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: transparent;
            border: 1px solid var(--studio-border);
            color: var(--studio-text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .header-back:hover {
            background: var(--studio-hover);
            color: var(--studio-text);
        }
        
        .header-title {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .header-title-main {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 16px;
            color: var(--studio-text);
            letter-spacing: 1px;
        }
        
        .header-title-sub {
            font-size: 10px;
            color: var(--studio-text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 6px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            flex-shrink: 1;
            min-width: 0;
        }
        
        /* Mobile header adjustments */
        @media (max-width: 767px) {
            .header {
                padding: 6px 8px;
                gap: 8px;
            }
            .header-actions {
                gap: 4px;
                padding-right: 8px;
            }
            .header-btn {
                padding: 6px 8px;
                font-size: 10px;
            }
            .header-title-main {
                font-size: 13px;
            }
            .header-title-sub {
                font-size: 9px;
            }
            .hide-mobile {
                display: none !important;
            }
        }
        
        .header-btn {
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        
        .header-btn-ghost {
            background: transparent;
            border: 1px solid var(--studio-border);
            color: var(--studio-text-muted);
        }
        
        .header-btn-ghost:hover {
            background: var(--studio-hover);
            color: var(--studio-text);
            border-color: var(--studio-accent-dark);
        }
        
        .header-btn-primary {
            background: var(--studio-accent);
            border: none;
            color: #1a1216;
        }
        
        .header-btn-primary:hover {
            background: #e4b5c5;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: clamp(8px, 2vw, 12px);
        }
        
        .logo-img {
            width: clamp(32px, 9vw, 44px);
            height: clamp(32px, 9vw, 44px);
            border-radius: 8px;
            object-fit: contain;
        }
        
        .logo-text {
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(14px, 3.5vw, 20px);
            letter-spacing: 2px;
            line-height: 1.1;
            color: var(--studio-text);
        }
        
        .logo-text span {
            display: block;
            font-size: clamp(10px, 2.5vw, 13px);
            color: var(--studio-accent);
            letter-spacing: 1px;
        }
        
        /* ========== CREATOR STUDIO SIDEBAR ========== */
        
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 220px;
            background: var(--studio-sidebar);
            border-right: 1px solid var(--studio-border);
            display: flex;
            flex-direction: column;
            z-index: 200;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .sidebar.open {
            transform: translateX(0);
        }
        
        @media (min-width: 1024px) {
            .sidebar {
                transform: translateX(0);
            }
            
            .sidebar-toggle {
                display: none !important;
            }
            
            .studio-main {
                margin-left: 220px;
            }
        }
        
        .sidebar-toggle {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--studio-sidebar);
            border: 1px solid var(--studio-border);
            color: var(--studio-text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 250;
            transition: all 0.15s ease;
        }
        
        .sidebar-toggle:hover, .sidebar-toggle.active {
            background: var(--studio-hover);
            color: var(--studio-text);
        }
        
        .sidebar-header {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--studio-border);
        }
        
        .sidebar-logo {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            object-fit: contain;
        }
        
        .sidebar-brand {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 16px;
            color: var(--studio-text);
            letter-spacing: 2px;
            line-height: 1.2;
        }
        
        .sidebar-brand span {
            color: var(--studio-accent);
            font-size: 12px;
        }
        
        .sidebar-section {
            padding: 12px 0;
        }
        
        .sidebar-section-title {
            padding: 8px 16px;
            font-size: 10px;
            font-weight: 600;
            color: var(--studio-text-muted);
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            color: var(--studio-text-muted);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s ease;
            border-left: 3px solid transparent;
        }
        
        .sidebar-item:hover {
            background: var(--studio-hover);
            color: var(--studio-text);
        }
        
        .sidebar-item.active {
            background: var(--studio-active);
            color: var(--studio-text);
            border-left-color: var(--studio-accent);
        }
        
        .sidebar-footer {
            margin-top: auto;
            border-top: 1px solid var(--studio-border);
            padding: 12px;
        }
        
        .sidebar-user {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .sidebar-user:hover {
            background: var(--studio-hover);
        }
        
        .sidebar-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .sidebar-avatar-placeholder {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--studio-accent-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--studio-text);
            font-weight: 600;
            font-size: 14px;
        }
        
        .sidebar-user-info {
            flex: 1;
            min-width: 0;
        }
        
        .sidebar-user-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--studio-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .sidebar-user-email {
            font-size: 11px;
            color: var(--studio-text-muted);
        }
        
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 199;
            display: none;
        }
        
        .sidebar-overlay.show {
            display: block;
        }
        
        /* ========== STUDIO MAIN LAYOUT ========== */
        
        .studio-main {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: var(--studio-bg);
        }
        
        .workspace {
            flex: 1;
            display: flex;
            overflow: hidden;
            min-height: 0;
        }
        
        .canvas-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: visible;
            min-height: 0;
        }
        
        /* Mobile Toolbar - ensure always visible on mobile */
        @media (max-width: 767px) {
            .mobile-toolbar {
                display: flex !important;
                position: relative;
                z-index: 50;
            }
        }
        
        /* ========== MOBILE RESPONSIVE FIXES ========== */
        
        @media (max-width: 600px) {
            .floating-elements-bar {
                display: none !important; /* Hide on mobile - mobile toolbar has same options */
            }
            .floating-collab-bar {
                top: 48px !important;
                padding: 5px 10px !important;
                gap: 4px !important;
                font-size: 9px !important;
                max-width: 92vw !important;
            }
            .floating-collab-bar span {
                font-size: 9px !important;
            }
            .floating-collab-bar button {
                padding: 3px 6px !important;
                font-size: 8px !important;
            }
        }
        
        /* Very small phones */
        @media (max-width: 380px) {
            .floating-collab-bar {
                padding: 4px 8px !important;
            }
        }
        
        /* Show floating bar only on desktop/tablet */
        @media (min-width: 601px) {
            .floating-elements-bar {
                display: flex !important;
            }
        }
        
        /* Sheets - fit mobile viewport */
        .sheet {
            max-height: 90vh !important;
            max-width: 100vw !important;
            overflow: hidden;
        }
        
        @media (max-width: 600px) {
            .sheet {
                max-height: 85vh !important;
                border-radius: 20px 20px 0 0 !important;
            }
            .sheet-body {
                max-height: calc(85vh - 60px) !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 20px !important;
            }
        }
        
        /* Bottom nav safe area */
        @media (max-width: 600px) {
            .bottom-nav-mobile {
                padding-bottom: max(12px, env(safe-area-inset-bottom)) !important;
            }
        }
        
        /* Orientation overlay for tablets */
        /* Orientation overlay - DISABLED */
        .orientation-overlay {
            display: none !important;
        }
        
        /* Phone-specific layout adjustments */
        @media (max-width: 600px) {
            .canvas-wrapper {
                padding: 8px !important;
            }
            .page-controls {
                padding: 4px 8px !important;
                gap: 4px !important;
            }
            .page-controls button {
                padding: 6px 10px !important;
                font-size: 11px !important;
            }
            .spread-controls {
                padding: 4px !important;
                gap: 4px !important;
            }
            .spread-btn {
                padding: 6px 10px !important;
                font-size: 10px !important;
            }
        }
        
        /* Prevent content overflow */
        * {
            box-sizing: border-box;
        }
        
        html, body {
            overflow-x: hidden;
            max-width: 100vw;
        }
        
        /* Right panel (Layers) */
        .layers-panel {
            width: 200px;
            background: var(--studio-sidebar);
            border-left: 1px solid var(--studio-border);
            display: none;
            flex-direction: column;
        }
        
        @media (min-width: 1200px) {
            .layers-panel {
                display: flex;
            }
        }
        
        .layers-panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--studio-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .layers-panel-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--studio-text);
        }
        
        .layers-panel-close {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            background: transparent;
            border: none;
            color: var(--studio-text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .layers-panel-close:hover {
            background: var(--studio-hover);
            color: var(--studio-text);
        }
        
        /* Helper classes */
        .hide-mobile {
            display: none;
        }
        
        @media (min-width: 768px) {
            .hide-mobile {
                display: inline;
            }
        }
        
        /* Updated action panel - FIXED: moved to top-right corner so it doesn't block photo */
        .action-panel {
            position: fixed;
            top: 60px;
            right: 8px;
            bottom: auto;
            left: auto;
            transform: none;
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 6px;
            background: rgba(10, 10, 20, 0.95);
            border: 1px solid #333;
            border-radius: 12px;
            z-index: 100;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
            max-height: 60vh;
            overflow-y: auto;
            scrollbar-width: none;
        }
        
        @media (max-width: 768px) {
            .action-panel {
                top: 55px;
                right: 5px;
                max-height: 50vh;
            }
        }
        
        .action-panel::-webkit-scrollbar {
            display: none;
        }
        
        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1px;
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid #333;
            background: transparent;
            cursor: pointer;
            min-width: 44px;
            flex-shrink: 0;
            transition: all 0.15s ease;
            font-size: 16px;
        }
        
        .action-btn span {
            font-size: 8px;
            color: #888;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .action-btn:hover {
            background: var(--studio-hover);
            border-color: var(--studio-accent-dark);
        }
        
        .action-btn:hover span {
            color: var(--studio-text);
        }
        
        .action-btn.blue { color: var(--studio-text); }
        .action-btn.green { color: var(--studio-text); }
        .action-btn.orange { color: var(--studio-text); }
        .action-btn.red { color: var(--studio-text-muted); }
        .action-btn.purple { color: var(--studio-text); }
        
        .action-btn:active { 
            transform: scale(0.95); 
        }
        
        /* Main Content - Studio Layout */
        .main {
            flex: 1;
            display: flex;
            flex-direction: row;
            overflow: visible;
            background: var(--studio-bg);
            min-height: 0;
            position: relative;
            z-index: 5;
        }
        
        /* Tool Strip - Left Side */
        .tool-strip {
            width: 48px;
            background: var(--studio-sidebar);
            border-right: 1px solid var(--studio-border);
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 8px 0;
            gap: 4px;
            flex-shrink: 0;
        }
        
        @media (min-width: 768px) {
            .tool-strip {
                display: flex;
            }
            
            .mobile-toolbar {
                display: none !important;
            }
        }
        
        /* Mobile Toolbar */
        .mobile-toolbar {
            display: flex;
            background: var(--studio-sidebar);
            border-top: 1px solid var(--studio-border);
            padding: 8px;
            gap: 6px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .mobile-toolbar .tool-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--studio-border);
            background: transparent;
            color: var(--studio-text-muted);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .mobile-toolbar .tool-btn:hover,
        .mobile-toolbar .tool-btn:active {
            background: var(--studio-hover);
            color: var(--studio-text);
            border-color: var(--studio-accent-dark);
        }
        
        .mobile-toolbar .tool-btn.save-btn {
            background: var(--studio-accent);
            color: var(--studio-bg);
            border-color: var(--studio-accent);
        }
        
        .tool-strip-btn {
            width: 38px;
            height: 38px;
            border-radius: 8px;
            background: transparent;
            border: none;
            color: var(--studio-text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 18px;
        }
        
        .tool-strip-btn:hover {
            background: var(--studio-hover);
            color: var(--studio-text);
        }
        
        .tool-strip-btn.active {
            background: var(--studio-active);
            color: var(--studio-accent);
        }
        
        .tool-strip-divider {
            width: 24px;
            height: 1px;
            background: var(--studio-border);
            margin: 8px 0;
        }
        
        .tab-content {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }
        
        .tab-content.active {
            display: flex;
        }
        
        /* Canvas Area - Studio Style */
        .canvas-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px;
            position: relative;
            overflow: visible;
            min-height: 0;
            background: var(--studio-bg);
        }
        
        /* Spread Navigation Bar */
        .spread-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 8px 0;
            color: var(--studio-text-muted);
            font-size: 12px;
        }
        
        .spread-nav-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--studio-sidebar);
            border: 1px solid var(--studio-border);
            color: var(--studio-text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .spread-nav-btn:hover {
            background: var(--studio-hover);
            color: var(--studio-text);
        }
        
        .spread-nav-text {
            font-weight: 500;
        }
        
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 24px;
        }
        
        .zoom-btn {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            background: transparent;
            border: 1px solid var(--studio-border);
            color: var(--studio-text-muted);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .zoom-btn:hover {
            background: var(--studio-hover);
        }
        
        .zoom-level {
            font-size: 11px;
            color: var(--studio-text-muted);
            min-width: 36px;
            text-align: center;
        }
        
        .canvas {
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            position: relative;
            overflow: visible !important;
            max-height: 100%;
            max-width: 100%;
        }
        
        /* Comic canvas - FILLS THE SCREEN */
        .canvas-comic {
            width: min(98%, 520px);
            aspect-ratio: 8.5 / 11;
            max-height: 88%;
        }
        
        @media (min-width: 768px) {
            .canvas-comic {
                width: min(90%, 600px);
                max-height: 92%;
            }
        }
        
        @media (min-width: 1024px) {
            .canvas-comic {
                width: min(75%, 680px);
            }
        }
        
        /* Card canvas - BIGGER */
        .canvas-card {
            width: min(85%, 320px);
            aspect-ratio: 2.5 / 3.5;
            max-height: 80%;
        }
        
        @media (min-width: 768px) {
            .canvas-card {
                width: min(60%, 380px);
            }
        }
        
        /* Cover canvas - BIGGER & IMMERSIVE */
        .canvas-cover {
            width: min(85%, 340px);
            aspect-ratio: 6.625 / 10.25;
            max-height: 82%;
        }
        
        @media (min-width: 768px) {
            .canvas-cover {
                width: min(65%, 420px);
                max-height: 88%;
            }
        }
        
        /* Panels */
        .panel {
            position: absolute;
            background: #fafafa;
            cursor: pointer;
            overflow: visible !important;
            border: 2px solid #e0e0e0;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }
        
        .panel:hover:not(.selected) {
            border-color: #ccc;
        }
        
        .panel.selected {
            border-color: var(--studio-accent);
            box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
            z-index: 50 !important;
            overflow: visible !important;
        }
        
        .panel.selected::after {
            content: '';
            position: absolute;
            inset: -4px;
            border: 2px solid var(--studio-accent);
            border-radius: 8px;
            pointer-events: none;
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
            animation: selectPulse 2s ease-in-out infinite;
        }
        
        .panel.selected .panel-content {
            overflow: hidden;
            border-radius: inherit;
            cursor: move;
        }
        
        /* PS Express handles for panels too */
        .panel .ps-handle {
            z-index: 100 !important;
        }
        
        .panel.selected .ps-handle {
            display: block;
        }
        
        .panel-media {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            pointer-events: none;
            background: #fafafa;
            transform-origin: center center;
        }
        
        /* Only use GPU acceleration on desktop */
        @media (hover: hover) and (pointer: fine) {
            .panel-media {
                will-change: transform;
            }
        }
        
        video.panel-media {
            background: #000;
            object-fit: contain;
        }
        
        .panel-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #bbb;
            font-size: 11px;
            font-weight: 500;
            background: #fafafa;
            gap: 8px;
        }
        
        .panel-placeholder-icon {
            font-size: 24px;
            color: #ddd;
        }
        
        .panel-placeholder-text {
            text-align: center;
            line-height: 1.4;
            color: #aaa;
        }
        
        .panel-placeholder-hint {
            font-size: 9px;
            color: #ccc;
        }
        
        /* Elements */
        .element {
            position: absolute;
            cursor: grab;
            touch-action: none;
            z-index: 20;
            transition: filter 0.15s ease;
            overflow: visible;
        }
        
        .element.selected {
            z-index: 30 !important;
            overflow: visible !important;
        }
        
        .element:active {
            cursor: grabbing;
        }
        
        .element:hover:not(.selected) {
            filter: brightness(1.05);
        }
        
        .element .delete-btn, .element .edit-btn {
            position: absolute;
            width: 32px;
            height: 32px;
            min-width: 32px;
            min-height: 32px;
            border: 2px solid rgba(255,255,255,0.9);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            cursor: pointer;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }
        
        .element .delete-btn { 
            top: -16px; 
            right: -16px; 
            background: linear-gradient(145deg, #333, #111);
            color: #fff;
        }
        
        .element .delete-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        
        .element .delete-btn:active {
            transform: scale(0.95);
            background: linear-gradient(145deg, #222, #000);
        }
        
        .element .edit-btn { 
            top: -16px; 
            left: -16px; 
            background: linear-gradient(145deg, #fff, #ddd);
            color: #000;
        }
        
        .element .edit-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(255,255,255,0.3);
        }
        
        .element .edit-btn:active {
            transform: scale(0.95);
            background: linear-gradient(145deg, #ddd, #bbb);
        }
        
        .element.selected .delete-btn, .element.selected .edit-btn { 
            display: flex; 
            animation: gizmoFadeIn 0.2s ease-out 0.1s both;
        }
        
        .image-transform-controls {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 8px 12px;
            border-radius: 20px;
            display: flex;
            gap: 6px;
            z-index: 50;
        }
        
        .image-transform-controls button {
            width: 32px;
            height: 32px;
            border-radius: 16px;
            background: #444;
            border: none;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            touch-action: manipulation;
        }
        
        .bubble {
            min-width: 50px;
            padding: clamp(10px, 2vw, 16px);
            font-family: 'Bangers', cursive;
            font-size: clamp(12px, 3vw, 18px);
            text-align: center;
            background: #fff;
            color: #000;
            border: clamp(2px, 0.5vw, 3px) solid #000;
            border-radius: 16px;
            position: relative;
            max-width: clamp(120px, 40vw, 220px);
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        .bubble::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            border: 10px solid transparent;
            border-top-color: #000;
        }
        
        .bubble.shout { background: #ffeb3b; border: 3px solid #999; }
        .bubble.burst { background: #ff5722; color: #fff; border-radius: 0; clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); }
        .bubble.burst::after { display: none; }
        
        .bubble.whisper { 
            background: rgba(200,200,200,0.7); 
            color: #555; 
            font-style: italic; 
            font-size: 12px;
            border: 2px dashed #999;
        }
        .bubble.whisper::after { border-top-color: rgba(200,200,200,0.7); }
        
        .bubble.thought { 
            background: #fff; 
            border-radius: 50%; 
            padding: 16px 20px;
        }
        .bubble.thought::after { 
            border: none;
            width: 12px; height: 12px;
            background: #fff;
            border-radius: 50%;
            bottom: -8px;
        }
        .bubble.thought::before {
            content: '';
            position: absolute;
            width: 8px; height: 8px;
            background: #fff;
            border-radius: 50%;
            bottom: -16px;
            left: calc(50% + 10px);
        }
        
        .bubble.scream { 
            background: #ff1744; 
            color: #fff; 
            font-weight: 900;
            text-transform: uppercase;
            border: 4px solid #b71c1c;
            animation: shake 0.3s ease-in-out infinite;
        }
        .bubble.scream::after { border-top-color: #ff1744; }
        @keyframes shake {
            0%, 100% { transform: rotate(-1deg); }
            50% { transform: rotate(1deg); }
        }
        
        .bubble.robot { 
            background: #263238; 
            color: #4fc3f7; 
            font-family: 'Courier New', monospace;
            border: 2px solid #4fc3f7;
            border-radius: 4px;
        }
        .bubble.robot::after { border-top-color: #263238; }
        
        .bubble.drip { 
            background: linear-gradient(180deg, #e040fb, #7c4dff); 
            color: #fff; 
            border-radius: 20px 20px 20px 4px;
            font-family: 'Bangers', cursive;
        }
        .bubble.drip::after { border-top-color: #7c4dff; }
        
        .bubble.glitch { 
            background: #000; 
            color: #0f0; 
            font-family: 'Courier New', monospace;
            border: 2px solid #0f0;
            text-shadow: 2px 0 #f00, -2px 0 #00f;
            animation: glitch 0.5s ease-in-out infinite;
        }
        .bubble.glitch::after { border-top-color: #000; }
        @keyframes glitch {
            0%, 100% { text-shadow: 2px 0 #f00, -2px 0 #00f; }
            50% { text-shadow: -2px 0 #f00, 2px 0 #00f; }
        }
        
        .bubble.retro { 
            background: #f5e6d3; 
            color: #5d4037; 
            border: 3px solid #8d6e63;
            font-family: 'Courier New', monospace;
            border-radius: 4px;
            box-shadow: 4px 4px 0 #5d4037;
        }
        .bubble.retro::after { border-top-color: #f5e6d3; }
        
        .bubble.neon { 
            background: #0a0a1a; 
            color: #fff; 
            border: 2px solid #00ffff;
            box-shadow: 0 0 10px #00ffff, inset 0 0 10px rgba(0,255,255,0.1);
            text-shadow: 0 0 10px #00ffff;
        }
        .bubble.neon::after { border-top-color: #0a0a1a; }
        
        .bubble.graffiti { 
            background: linear-gradient(135deg, #ff6b35, #f7931e, #ffeb3b); 
            color: #000; 
            font-family: 'Bangers', cursive;
            font-weight: 900;
            border-radius: 8px;
            border: 3px solid #000;
        }
        .bubble.graffiti::after { display: none; }
        
        .effect {
            font-family: 'Bangers', cursive;
            font-size: clamp(20px, 6vw, 32px);
            text-shadow: 2px 2px 0 rgba(0,0,0,0.3);
        }
        
        .emoji-sticker { font-size: clamp(28px, 8vw, 48px); }
        
        /* Page Bar */
        /* Page Bar - Studio Style */
        .page-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--studio-sidebar);
            border-top: 1px solid var(--studio-border);
            flex-shrink: 0;
        }
        
        .page-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--studio-border);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .page-dot:hover {
            background: var(--studio-accent-dark);
        }
        
        .page-dot.active {
            width: 24px;
            border-radius: 5px;
            background: var(--studio-accent);
        }
        
        .page-add {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: transparent;
            border: 1px solid var(--studio-border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 8px;
            color: var(--studio-text-muted);
            transition: all 0.15s ease;
        }
        
        .page-add:hover {
            background: var(--studio-hover);
            color: var(--studio-text);
            border-color: var(--studio-accent-dark);
        }
        
        /* Toolbar - Studio Style */
        .toolbar {
            display: flex;
            gap: 6px;
            padding: 10px 12px;
            background: var(--studio-sidebar);
            border-top: 1px solid var(--studio-border);
            overflow-x: auto;
            flex-shrink: 0;
            -webkit-overflow-scrolling: touch;
        }
        
        .tool-btn {
            flex-shrink: 0;
            height: 38px;
            padding: 0 14px;
            border-radius: 6px;
            background: transparent;
            border: 1px solid var(--studio-border);
            color: var(--studio-text-muted);
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.15s ease;
        }
        
        .tool-btn:hover {
            background: var(--studio-hover);
            color: var(--studio-text);
            border-color: var(--studio-accent-dark);
        }
        
        .tool-btn:active { 
            background: var(--studio-active); 
        }
        
        .tool-btn.save-btn { 
            background: var(--studio-accent);
            color: var(--studio-bg);
            border: none;
            font-weight: 600;
        }
        
        .tool-btn.save-btn:hover {
            background: #e4b5c5;
        }
        
        /* Bottom Nav - Studio Style (Mobile Only) */
        .bottom-nav {
            display: flex;
            background: var(--studio-sidebar);
            border-top: 1px solid var(--studio-border);
            padding: 6px 0;
            flex-shrink: 0;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding-bottom: max(6px, env(safe-area-inset-bottom));
        }
        
        @media (min-width: 1024px) {
            .bottom-nav {
                display: none;
            }
            
            .studio-main {
                padding-bottom: 0;
            }
        }
        
        @media (max-width: 1023px) {
            .studio-main {
                padding-bottom: 70px;
            }
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            cursor: pointer;
            color: var(--studio-text-muted);
            transition: all 0.15s ease;
        }
        
        .nav-item:hover {
            color: var(--studio-text);
        }
        
        .nav-item.active { 
            color: var(--studio-accent);
        }
        
        .nav-item span { 
            font-size: 10px; 
            font-weight: 600; 
            letter-spacing: 0.5px; 
        }
        
        /* Bottom Spread Bar - Desktop Style */
        .spread-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 10px 16px;
            background: var(--studio-bg);
            border-top: 1px solid var(--studio-border);
        }
        
        .spread-btn {
            padding: 10px 18px;
            border-radius: 6px;
            background: var(--studio-sidebar);
            border: 1px solid var(--studio-border);
            color: var(--studio-text-muted);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s ease;
        }
        
        .spread-btn:hover {
            background: var(--studio-hover);
            color: var(--studio-text);
            border-color: var(--studio-accent-dark);
        }
        
        /* ========== IMMERSIVE FULL-SCREEN READER ========== */
        .reader {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: #000;
            overflow: hidden;
        }
        
        .reader-bg {
            position: absolute;
            inset: 0;
            background: 
                radial-gradient(ellipse at 20% 0%, rgba(102, 126, 234, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(244, 114, 182, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(74, 222, 128, 0.05) 0%, transparent 60%),
                linear-gradient(180deg, #0a0a12 0%, #0f0a1a 50%, #0a0f1a 100%);
        }
        
        .reader-bg-stars {
            position: absolute;
            inset: 0;
            background-image: 
                radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 30% 65%, rgba(255,255,255,0.6), transparent),
                radial-gradient(2px 2px at 55% 15%, rgba(255,255,255,0.7), transparent),
                radial-gradient(1px 1px at 70% 80%, rgba(255,255,255,0.5), transparent),
                radial-gradient(1px 1px at 85% 35%, rgba(255,255,255,0.9), transparent),
                radial-gradient(2px 2px at 95% 70%, rgba(255,255,255,0.4), transparent);
            background-size: 100% 100%;
            animation: twinkle 5s ease-in-out infinite alternate;
        }
        
        @keyframes twinkle {
            0% { opacity: 0.3; }
            100% { opacity: 0.7; }
        }
        
        .reader-content {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Horizontal (Tap) Mode */
        .reader.horizontal .reader-page-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .reader-page {
            max-width: 100%;
            max-height: 100%;
            border-radius: 0;
            box-shadow: 0 0 100px rgba(0,0,0,0.8);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s;
        }
        
        /* Vertical (Scroll) Mode */
        .reader.vertical .reader-content {
            overflow-y: auto;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scroll-snap-type: y mandatory;
        }
        
        .reader.vertical .reader-page-container {
            scroll-snap-align: start;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px 0;
        }
        
        .reader.vertical .reader-page {
            max-height: 90vh;
            width: auto;
        }
        
        /* Page Transitions */
        .reader-page.trans-fade-in { animation: fadeIn 0.4s ease-out; }
        .reader-page.trans-slide-left { animation: slideFromRight 0.4s ease-out; }
        .reader-page.trans-slide-right { animation: slideFromLeft 0.4s ease-out; }
        .reader-page.trans-zoom { animation: zoomIn 0.4s ease-out; }
        .reader-page.trans-flip { animation: fadeIn 0.3s ease-out; } /* Fallback for all */
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideFromRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideFromLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes flipIn { from { transform: rotateY(-90deg); opacity: 0; } to { transform: rotateY(0); opacity: 1; } }
        
        /* Only enable flip on iPad/tablet and desktop */
        @media (min-width: 768px) {
            .reader-page.trans-flip { animation: flipIn 0.5s ease-out; perspective: 1000px; }
        }
        
        /* Respect reduced motion preferences */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Mobile performance optimizations */
        @media (max-width: 767px) {
            .panel, .panel-media, .page-element {
                will-change: auto !important;
                transform: none !important;
            }
            .neon-btn, .neon-fab, .nav-item.neon, .sidebar-item.neon {
                transition-duration: 0.15s;
            }
            @keyframes neonPulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.8; }
            }
        }
        
        /* Floating Header */
        .reader-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: linear-gradient(180deg, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.7) 70%, transparent 100%);
            transition: transform 0.3s, opacity 0.3s;
        }
        
        .reader-header.hidden {
            transform: translateY(-100%);
            opacity: 0;
        }
        
        .reader-title-group {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .reader-logo {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 22px;
            background: linear-gradient(135deg, #fff 0%, #fff 50%, #fff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 3px;
        }
        
        .reader-comic-title {
            font-family: 'Bangers', cursive;
            font-size: 20px;
            color: #fff;
            text-shadow: 0 2px 20px rgba(102, 126, 234, 0.5);
        }
        
        .reader-header-btns {
            display: flex;
            gap: 8px;
        }
        
        .reader-btn {
            padding: 10px 18px;
            border-radius: 25px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            backdrop-filter: blur(20px);
            transition: all 0.2s;
        }
        
        .reader-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        
        .reader-btn.active {
            background: linear-gradient(135deg, #fff, #e0e0e0);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .reader-btn-close {
            background: rgba(255, 59, 48, 0.8);
        }
        
        .reader-btn-close:hover {
            background: rgba(255, 59, 48, 1);
        }
        
        /* Floating Footer Nav */
        .reader-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: linear-gradient(0deg, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.7) 70%, transparent 100%);
            transition: transform 0.3s, opacity 0.3s;
        }
        
        .reader-footer.hidden {
            transform: translateY(100%);
            opacity: 0;
        }
        
        .reader-progress {
            width: 100%;
            max-width: 400px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        
        .reader-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #fff, #fff);
            border-radius: 2px;
            transition: width 0.3s;
        }
        
        .reader-nav {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .reader-nav-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            backdrop-filter: blur(20px);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .reader-nav-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #fff, #e0e0e0);
            transform: scale(1.1);
            box-shadow: 0 5px 25px rgba(102, 126, 234, 0.5);
        }
        
        .reader-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .reader-page-info {
            text-align: center;
            min-width: 120px;
        }
        
        .reader-page-num {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 28px;
            color: #fff;
            letter-spacing: 2px;
        }
        
        .reader-page-label {
            font-size: 11px;
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Tap Zones for Horizontal Mode */
        .reader-tap-zone {
            position: absolute;
            top: 80px;
            bottom: 120px;
            width: 25%;
            z-index: 50;
            cursor: pointer;
        }
        
        .reader-tap-zone.left { left: 0; }
        .reader-tap-zone.right { right: 0; }
        
        .reader-tap-zone:active {
            background: radial-gradient(circle at center, rgba(102, 126, 234, 0.2), transparent 70%);
        }
        
        /* Page thumbnails strip */
        .reader-thumbs {
            display: flex;
            gap: 8px;
            padding: 12px;
            overflow-x: auto;
            max-width: 100%;
        }
        
        .reader-thumb {
            width: 50px;
            height: 65px;
            border-radius: 6px;
            border: 2px solid transparent;
            overflow: hidden;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s;
            background: #222;
        }
        
        .reader-thumb:hover {
            border-color: rgba(255,255,255,0.5);
        }
        
        .reader-thumb.active {
            border-color:#fff;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.5);
        }
        
        .reader-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* ========== TRANSFORM GIZMOS (PS Express Style) ========== */
        .gizmo-container {
            position: absolute;
            pointer-events: none;
            z-index: 50;
        }
        
        .gizmo-box {
            position: absolute;
            border: 2px solid rgba(99, 102, 241, 0.8);
            box-shadow: 0 0 0 1px rgba(0,0,0,0.2), 0 0 20px rgba(99, 102, 241, 0.3);
            pointer-events: none;
            border-radius: 4px;
        }
        
        /* ========== PHOTOSHOP EXPRESS STYLE HANDLES - BIGGER & VISIBLE ========== */
        
        .ps-handle {
            position: absolute;
            background: #fff;
            border: 2px solid #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            pointer-events: auto !important;
            z-index: 10000 !important;
            touch-action: none;
        }
        
        /* Corner handles - bigger white squares */
        .ps-handle.corner {
            width: 16px;
            height: 16px;
        }
        
        /* Edge handles - bigger white rectangles */
        .ps-handle.edge.horizontal {
            width: 24px;
            height: 8px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .ps-handle.edge.vertical {
            width: 8px;
            height: 24px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        /* Corner positions */
        .ps-handle.corner.nw { top: -8px; left: -8px; cursor: nw-resize; }
        .ps-handle.corner.ne { top: -8px; right: -8px; cursor: ne-resize; }
        .ps-handle.corner.sw { bottom: -8px; left: -8px; cursor: sw-resize; }
        .ps-handle.corner.se { bottom: -8px; right: -8px; cursor: se-resize; }
        
        /* Edge positions */
        .ps-handle.edge.top { top: -4px; cursor: n-resize; }
        .ps-handle.edge.bottom { bottom: -4px; cursor: s-resize; }
        .ps-handle.edge.left { left: -4px; cursor: w-resize; }
        .ps-handle.edge.right { right: -4px; cursor: e-resize; }
            cursor: grabbing;
            transform: translateX(-50%) scale(0.95);
            background: linear-gradient(145deg, #ddd, #bbb);
        }
        
        .gizmo-line {
            position: absolute;
            top: -60px;
            left: 50%;
            width: 3px;
            height: 48px;
            background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.3));
            transform: translateX(-50%);
            pointer-events: none;
            z-index: 999 !important;
            border-radius: 2px;
        }
        
        .element-gizmo {
            position: absolute;
            pointer-events: none;
        }
        
        /* ========== CLEAN WHITE PS HANDLES - IPHONE 16 OPTIMIZED ========== */
        
        .element .ps-handle {
            display: none;
        }
        
        .element.selected .ps-handle {
            display: block !important;
            background: #ffffff !important;
            border: 2px solid #000000 !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
            z-index: 99999 !important;
            /* iPhone 16 specific touch fixes */
            -webkit-touch-callout: none !important;
            -webkit-user-select: none !important;
            user-select: none !important;
            touch-action: manipulation !important;
        }
        
        /* Panel handles visibility */
        .panel .ps-handle {
            z-index: 99999 !important;
            display: none;
        }
        
        .panel.selected .ps-handle {
            display: block !important;
            background: #ffffff !important;
            border: 2px solid #000000 !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
            /* iPhone 16 specific touch fixes */
            -webkit-touch-callout: none !important;
            -webkit-user-select: none !important;
            user-select: none !important;
            touch-action: manipulation !important;
        }
        
        .element .el-gizmo-rotate {
            position: absolute;
            top: -55px;
            left: 50%;
            transform: translateX(-50%);
            width: 36px;
            height: 36px;
            background: linear-gradient(145deg, #fff, #ddd);
            border: 3px solid #fff;
            border-radius: 50%;
            cursor: grab;
            pointer-events: auto !important;
            box-shadow: 
                0 4px 14px rgba(0,0,0,0.45),
                0 0 0 2px rgba(0,0,0,0.12),
                inset 0 2px 4px rgba(255,255,255,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #000;
            z-index: 1001 !important;
            touch-action: none;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .element.selected .el-gizmo-rotate {
            display: flex;
            animation: gizmoFadeIn 0.2s ease-out 0.05s both;
        }
        
        .element .el-gizmo-rotate:hover {
            transform: translateX(-50%) scale(1.15);
            box-shadow: 
                0 6px 22px rgba(0,0,0,0.55),
                0 0 0 4px rgba(255,255,255,0.25),
                inset 0 2px 4px rgba(255,255,255,0.5);
        }
        
        .element .el-gizmo-rotate:active {
            cursor: grabbing;
            transform: translateX(-50%) scale(0.95);
            background: linear-gradient(145deg, #ddd, #bbb);
        }
        

        
        /* ========== CLEAN BLACK SELECTION INDICATORS ========== */
        
        .element.selected {
            outline: 2px solid #000000 !important; /* Black outline */
            outline-offset: 2px;
        }
        
        .panel.selected {
            outline: 2px solid #000000 !important; /* Black outline */
            outline-offset: 2px;
        }
        
        /* ========== SLEEK FULL-SCREEN DRAW MODE ========== */
        .draw-mode {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: #0a0a0f;
            overflow: hidden;
        }
        
        .draw-mode-bg {
            position: absolute;
            inset: 0;
            background: 
                radial-gradient(ellipse at 30% 20%, rgba(102, 126, 234, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(244, 114, 182, 0.06) 0%, transparent 50%);
            pointer-events: none;
        }
        
        /* Floating Header */
        .draw-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, transparent 100%);
        }
        
        .draw-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            color: #fff;
            letter-spacing: 3px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .draw-badge {
            background: linear-gradient(135deg, #fff, #fff);
            color: #000;
            font-size: 10px;
            padding: 4px 10px;
            border-radius: 12px;
            font-family: sans-serif;
            font-weight: 600;
            letter-spacing: 0;
        }
        
        .draw-actions {
            display: flex;
            gap: 8px;
        }
        
        .draw-btn {
            padding: 10px 18px;
            border-radius: 25px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            background: rgba(255,255,255,0.1);
            color: #fff;
            backdrop-filter: blur(10px);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .draw-btn:hover { background: rgba(255,255,255,0.2); transform: translateY(-1px); }
        .draw-btn.save { background: linear-gradient(135deg, #fff, #fff); color: #000; }
        .draw-btn.close { background: rgba(255, 59, 48, 0.8); padding: 10px 14px; }
        
        /* Full Screen Canvas */
        .draw-canvas-area {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .draw-canvas-frame {
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .draw-canvas {
            display: block;
            touch-action: none;
            cursor: crosshair;
            background: #fff;
        }
        
        /* Floating Tool Palette - Left Side */
        .draw-palette {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 6px;
            background: rgba(20, 20, 30, 0.95);
            padding: 12px;
            border-radius: 16px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            z-index: 50;
        }
        
        .draw-tool {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: 2px solid transparent;
            background: rgba(255,255,255,0.05);
            color: #888;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        
        .draw-tool:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .draw-tool.active { border-color:#fff; background: rgba(102, 126, 234, 0.2); color: #fff; }
        
        .draw-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 4px 0; }
        
        /* Floating Color Palette - Right Side */
        .draw-colors {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: rgba(20, 20, 30, 0.95);
            padding: 12px;
            border-radius: 16px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            z-index: 50;
        }
        
        .draw-color {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .draw-color:hover { transform: scale(1.15); }
        .draw-color.active { border:2px solid #fff; }
        
        .draw-size-ctrl {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.1);
            margin-top: 4px;
        }
        
        .draw-size-label {
            font-size: 10px;
            color: #888;
        }
        
        .draw-size-dot {
            background: #fff;
            border-radius: 50%;
        }
        
        /* Floating Footer */
        .draw-footer {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(20, 20, 30, 0.95);
            padding: 8px 16px;
            border-radius: 25px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 50;
        }
        
        .draw-footer-btn {
            padding: 8px 12px;
            border-radius: 16px;
            border: none;
            background: transparent;
            color: #888;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.15s;
        }
        
        .draw-footer-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .draw-footer-divider { width: 1px; height: 20px; background: rgba(255,255,255,0.15); }
        
        /* Animation Timeline */
        .draw-timeline {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 12px 20px;
            background: linear-gradient(0deg, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.8) 80%, transparent 100%);
            z-index: 50;
        }
        
        .draw-timeline-inner {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(20, 20, 30, 0.9);
            padding: 10px 16px;
            border-radius: 16px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .draw-play-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #fff, #fff);
            color: #000;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .draw-play-btn:hover { transform: scale(1.1); box-shadow: 0 4px 20px rgba(74, 222, 128, 0.4); }
        .draw-play-btn.playing { background: linear-gradient(135deg, #aaa, #888); }
        
        .draw-frames {
            display: flex;
            gap: 8px;
            flex: 1;
            overflow-x: auto;
            padding: 4px 0;
            scrollbar-width: thin;
            scrollbar-color:#fff transparent;
        }
        
        .draw-frames::-webkit-scrollbar { height: 4px; }
        .draw-frames::-webkit-scrollbar-track { background: transparent; }
        .draw-frames::-webkit-scrollbar-thumb { background: #fff; border-radius: 2px; }
        
        .draw-frame {
            width: 52px;
            height: 68px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            flex-shrink: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #666;
            transition: all 0.15s;
            overflow: hidden;
        }
        
        .draw-frame:hover { border-color: rgba(255,255,255,0.4); }
        .draw-frame.active { 
            border-color:#fff; 
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3), 0 4px 12px rgba(0,0,0,0.3); 
        }
        
        .draw-frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .draw-frame.add {
            border-style: dashed;
            font-size: 24px;
            color:#fff;
        }
        
        .draw-frame.add:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color:#fff;
        }
        
        .draw-timeline-actions {
            display: flex;
            gap: 4px;
        }
        
        .draw-timeline-btn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: none;
            background: rgba(255,255,255,0.05);
            color: #888;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        
        .draw-timeline-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .draw-timeline-btn.active { background: rgba(102, 126, 234, 0.2); color:#fff; }
        
        .draw-timeline-divider {
            width: 1px;
            height: 30px;
            background: rgba(255,255,255,0.1);
        }
        
        .draw-fps-ctrl {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .draw-fps-label {
            font-size: 11px;
            color: #888;
            min-width: 45px;
        }
        
        .draw-size-ctrl {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
            margin-top: 6px;
        }
        
        .draw-size-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        
        .draw-size-btn:hover {
            background: rgba(102, 126, 234, 0.3);
        }
        
        .draw-size-preview {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        
        .draw-size-dot {
            background: #fff;
            border-radius: 50%;
        }
        
        .draw-size-label {
            font-size: 10px;
            color: #888;
        }
        
        .draw-fps-slider {
            width: 60px;
            height: 4px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            outline: none;
        }
        
        .draw-fps-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
        }
        
        /* Legacy classes for compatibility */
        .draw-overlay { display: none; }
        
        .draw-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            background: #16161f;
            border-bottom: 1px solid #2a2a3a;
            flex-shrink: 0;
        }
        
        .draw-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 18px;
            color: #fff;
            letter-spacing: 2px;
        }
        
        .draw-header-tools {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .draw-header-btn {
            padding: 8px 14px;
            border-radius: 6px;
            border: none;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            background: #2a2a3a;
            color: #fff;
            transition: all 0.15s;
        }
        
        .draw-header-btn:hover { background: #3a3a4a; }
        .draw-header-btn.primary { background: linear-gradient(135deg, #fff, #e0e0e0); }
        
        .draw-toolbar-top {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #1a1a24;
            border-bottom: 1px solid #2a2a3a;
            flex-shrink: 0;
            overflow-x: auto;
        }
        
        .draw-tool-group {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .draw-tool-label {
            font-size: 11px;
            color: #666;
            margin-right: 6px;
            white-space: nowrap;
        }
        
        .draw-tool-btn {
            padding: 8px 12px;
            border-radius: 6px;
            border: 2px solid transparent;
            background: #2a2a3a;
            color: #ccc;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
            transition: all 0.15s;
        }
        
        .draw-tool-btn:hover { background: #3a3a4a; color: #fff; }
        .draw-tool-btn.active { border-color:#fff; background: rgba(102,126,234,0.2); color: #fff; }
        
        .draw-divider {
            width: 1px;
            height: 28px;
            background: #3a3a4a;
            margin: 0 4px;
            flex-shrink: 0;
        }
        
        .draw-size-slider, .draw-fps-slider {
            width: 80px;
            height: 4px;
            -webkit-appearance: none;
            background: #3a3a4a;
            border-radius: 2px;
            outline: none;
        }
        
        .draw-size-slider::-webkit-slider-thumb, .draw-fps-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .draw-color-picker {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 3px solid #fff;
            cursor: pointer;
            padding: 0;
        }
        
        .draw-opacity-label {
            font-size: 11px;
            color: #666;
        }
        
        .draw-canvas-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #12121a;
            overflow: hidden;
            position: relative;
        }
        
        .draw-canvas-wrapper {
            position: relative;
            box-shadow: 0 8px 40px rgba(0,0,0,0.6);
            border-radius: 4px;
            max-width: 95%;
            max-height: 95%;
        }
        
        .draw-canvas {
            display: block;
            touch-action: none;
            cursor: crosshair;
            background: #fff;
            border-radius: 4px;
        }
        
        .draw-frame-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: #16161f;
            border-top: 1px solid #2a2a3a;
            flex-shrink: 0;
        }
        
        .draw-frame-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .draw-frame-btn {
            padding: 8px 14px;
            border-radius: 6px;
            border: none;
            background: #2a2a3a;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
        }
        
        .draw-frame-btn:hover { background: #3a3a4a; }
        .draw-frame-btn.play { background: linear-gradient(135deg, #fff, #fff); color: #000; }
        
        .draw-frames {
            display: flex;
            gap: 8px;
            flex: 1;
            overflow-x: auto;
            padding: 4px;
        }
        
        .draw-frame-thumb {
            width: 60px;
            height: 78px;
            background: #1a1a24;
            border: 2px solid #3a3a4a;
            border-radius: 6px;
            flex-shrink: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .draw-frame-thumb:hover { border-color:#fff; }
        .draw-frame-thumb.active { border-color:#fff; box-shadow: 0 0 0 2px rgba(102,126,234,0.3); }
        
        .draw-frame-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .draw-frame-num {
            position: absolute;
            bottom: 3px;
            right: 5px;
            font-size: 9px;
            color: #fff;
            background: rgba(0,0,0,0.7);
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .draw-onion-skin, .draw-fps {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .draw-onion-label {
            font-size: 11px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }
        
        /* ========== PS EXPRESS STYLE MEDIA EDITOR ========== */
        .media-editor {
            position: fixed;
            inset: 0;
            z-index: 1100;
            background: #000;
            display: flex;
            flex-direction: column;
            touch-action: none;
        }
        
        .media-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(0,0,0,0.9);
            z-index: 10;
        }
        
        .media-editor-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 18px;
            color: #fff;
            letter-spacing: 2px;
        }
        
        .media-editor-btns {
            display: flex;
            gap: 8px;
        }
        
        .media-editor-btn {
            padding: 10px 20px;
            border-radius: 25px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .media-editor-btn.cancel {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }
        
        .media-editor-btn.done {
            background: linear-gradient(135deg, #fff, #fff);
            color: #000;
        }
        
        .media-editor-canvas {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            background: 
                linear-gradient(45deg, #1a1a1a 25%, transparent 25%),
                linear-gradient(-45deg, #1a1a1a 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #1a1a1a 75%),
                linear-gradient(-45deg, transparent 75%, #1a1a1a 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #0d0d0d;
        }
        
        .media-editor-frame {
            position: absolute;
            border: 2px dashed rgba(102, 126, 234, 0.5);
            pointer-events: none;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.6);
        }
        
        .media-editor-image {
            position: absolute;
            transform-origin: center center;
            cursor: grab;
            max-width: none;
            max-height: none;
        }
        
        .media-editor-image:active {
            cursor: grabbing;
        }
        
        .media-editor-image.video {
            object-fit: contain;
        }
        
        .media-editor-footer {
            padding: 16px;
            background: rgba(0,0,0,0.9);
            z-index: 10;
        }
        
        .media-editor-tools {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .media-editor-tool {
            padding: 12px 20px;
            border-radius: 25px;
            border: 2px solid #333;
            background: #1a1a1a;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .media-editor-tool:hover {
            border-color:#fff;
        }
        
        .media-editor-tool.active {
            border-color:#fff;
            background: rgba(102, 126, 234, 0.2);
        }
        
        .media-editor-slider-row {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 8px 0;
        }
        
        .media-editor-slider-label {
            font-size: 12px;
            color: #888;
            width: 60px;
        }
        
        .media-editor-slider {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            background: #333;
            border-radius: 2px;
            outline: none;
        }
        
        .media-editor-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #fff, #e0e0e0);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .media-editor-slider-value {
            font-size: 14px;
            color: #fff;
            width: 50px;
            text-align: right;
        }
        
        .media-editor-hint {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }
        
        /* Sheets */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            opacity: 0;
            visibility: hidden;
            z-index: 9998;
            transition: all 0.3s;
        }
        
        .overlay.show { opacity: 1; visibility: visible; }
        
        .sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--studio-sidebar);
            border-radius: 24px 24px 0 0;
            max-height: 80vh;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            z-index: 9999;
            padding-bottom: env(safe-area-inset-bottom);
            border-top: 2px solid var(--studio-accent);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }
        
        .sheet-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 599;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .sheet-backdrop.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .sheet.show { transform: translateY(0); }
        
        .sheet-handle {
            width: 48px;
            height: 5px;
            background: var(--studio-border);
            border-radius: 3px;
            margin: 14px auto;
        }
        
        .sheet-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px 16px;
        }
        
        .sheet-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(18px, 4vw, 24px);
            letter-spacing: 3px;
            color: var(--studio-text);
        }
        
        .sheet-close {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--studio-hover);
            border: 1px solid var(--studio-border);
            color: var(--studio-text);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .sheet-close:hover {
            background: var(--studio-active);
        }
        
        .sheet-body {
            padding: 16px;
            overflow-y: auto;
            max-height: 55vh;
            -webkit-overflow-scrolling: touch;
            background: var(--studio-sidebar);
        }
        
        .grid-3 { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: clamp(8px, 2vw, 12px); 
        }
        .grid-5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: clamp(6px, 1.5vw, 10px); }
        
        .template-card {
            aspect-ratio: 8.5/11;
            background: #fff;
            border-radius: 8px;
            border: 3px solid #444;
            position: relative;
            cursor: pointer;
        }
        
        .template-card.selected { border-color:#fff; box-shadow: 0 0 0 3px rgba(102,126,234,0.4); }
        .mini-panel { position: absolute; background: #ddd; border: 2px solid #666; }
        
        .option-btn {
            background: var(--studio-bg);
            border: 2px solid var(--studio-border);
            border-radius: 12px;
            padding: clamp(12px, 3vw, 18px);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 80px;
            transition: all 0.15s ease;
        }
        
        .option-btn:hover {
            border-color: var(--studio-accent);
            background: var(--studio-hover);
        }
        
        .option-btn:active { 
            border-color: var(--studio-accent); 
            transform: scale(0.95);
        }
        
        .effect-btn {
            aspect-ratio: 1;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-family: 'Bangers', cursive;
            font-size: clamp(12px, 3vw, 16px);
            color: #fff;
        }
        
        .effect-btn:active { transform: scale(0.95); }
        
        .emoji-btn {
            aspect-ratio: 1;
            font-size: clamp(24px, 6vw, 32px);
            background: #1a1a1a;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .emoji-btn:active { transform: scale(0.9); }
        
        .input {
            width: 100%;
            padding: clamp(12px, 3vw, 16px);
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            margin-bottom: 12px;
            font-family: inherit;
            resize: vertical;
        }
        
        .input:focus { outline: none; border-color:#fff; }
        
        .btn {
            width: 100%;
            padding: clamp(14px, 3.5vw, 18px);
            border-radius: 14px;
            font-size: clamp(14px, 3.5vw, 18px);
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 3px;
            cursor: pointer;
            border: none;
        }
        
        .btn-primary { background: #fff; color: #000; }
        .btn-secondary { background: #1a1a1a; color: #fff; border: 2px solid #333; }
        .btn:active { transform: scale(0.98); }
        
        /* Card Evolution States */
        .ps-card { transition: all 0.3s ease; position: relative; }
        .ps-card--damaged { filter: grayscale(0.4) brightness(0.8); }
        .ps-card--damaged::after {
            content: ""; position: absolute; inset: 0;
            background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.1) 10px, rgba(0,0,0,0.1) 20px);
            pointer-events: none; opacity: 0.5;
        }
        .ps-card--enhanced { box-shadow: 0 0 15px rgba(255, 215, 0, 0.6); }
        .ps-card--legendary_form { 
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.9), 0 0 40px rgba(255, 165, 0, 0.4);
            animation: legendaryPulse 2s infinite;
        }
        .ps-card--mythic_ascended {
            box-shadow: 0 0 25px cyan, 0 0 50px magenta;
            animation: mythicPulse 3s infinite;
        }
        
        @keyframes legendaryPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.9); }
            50% { box-shadow: 0 0 30px rgba(255, 215, 0, 1), 0 0 60px rgba(255, 165, 0, 0.6); }
        }
        
        @keyframes mythicPulse {
            0%, 100% { transform: translateY(0); filter: brightness(1); box-shadow: 0 0 25px cyan, 0 0 50px magenta; }
            50% { transform: translateY(-3px); filter: brightness(1.15); box-shadow: 0 0 35px cyan, 0 0 70px magenta; }
        }
        
        /* Battle Mode UI */
        .battle-arena {
            position: fixed; inset: 0; z-index: 9999;
            background: linear-gradient(180deg, #0a0a1a 0%, #1a0a2a 100%);
            display: flex; flex-direction: column;
        }
        .battle-header {
            padding: 16px; background: rgba(0,0,0,0.5);
            display: flex; justify-content: space-between; align-items: center;
        }
        .battle-cards {
            flex: 1; display: flex; justify-content: center; align-items: center; gap: 40px;
            padding: 20px;
        }
        .battle-card-slot {
            width: 180px; height: 250px; border-radius: 12px;
            background: rgba(255,255,255,0.05); border: 3px solid #333;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s;
        }
        .battle-card-slot.winner { border-color: #fff; box-shadow: 0 0 30px rgba(34, 197, 94, 0.5); }
        .battle-card-slot.loser { border-color: #888; opacity: 0.7; }
        .battle-vs {
            font-size: 48px; font-weight: bold; color: #999;
            text-shadow: 0 0 20px rgba(245, 158, 11, 0.8);
        }
        .battle-log {
            background: rgba(0,0,0,0.6); padding: 16px; max-height: 200px;
            overflow-y: auto; font-family: monospace; font-size: 13px; color: #ccc;
        }
        .battle-actions {
            padding: 20px; background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;
        }
        .stat-btn {
            padding: 14px 28px; border-radius: 12px; border: none;
            font-size: 14px; font-weight: bold; cursor: pointer;
            transition: all 0.2s;
        }
        .stat-btn:hover { transform: scale(1.05); }
        .stat-btn.pwr { background: linear-gradient(135deg, #fff, #16a34a); color: #fff; }
        .stat-btn.spd { background: linear-gradient(135deg, #ccc, #2563eb); color: #fff; }
        .stat-btn.int { background: linear-gradient(135deg, #fff, #db2777); color: #fff; }
        
        /* Durability Bar */
        .durability-bar {
            height: 6px; background: #333; border-radius: 3px; overflow: hidden; margin-top: 8px;
        }
        .durability-bar-fill {
            height: 100%; transition: width 0.3s;
        }
        .durability-bar-fill.high { background: #fff; }
        .durability-bar-fill.medium { background: #999; }
        .durability-bar-fill.low { background: #888; }
        
        /* XP Bar */
        .xp-bar {
            height: 4px; background: #1a1a2e; border-radius: 2px; overflow: hidden;
        }
        .xp-bar-fill {
            height: 100%; background: linear-gradient(90deg, #bbb, #fff);
            transition: width 0.3s;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: clamp(100px, 18vh, 140px);
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            color: #000;
            padding: clamp(12px, 3vw, 16px) clamp(20px, 5vw, 32px);
            border-radius: 30px;
            font-weight: 700;
            font-size: clamp(13px, 3vw, 16px);
            opacity: 0;
            z-index: 500;
            pointer-events: none;
            transition: opacity 0.3s;
            white-space: nowrap;
        }
        
        .toast.show { opacity: 1; }
        
        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 400;
            padding: 24px;
        }
        
        .modal-box {
            background: #1a1a1a;
            border-radius: 24px;
            padding: clamp(20px, 5vw, 28px);
            width: 100%;
            max-width: 340px;
        }
        
        .modal-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(20px, 5vw, 26px);
            text-align: center;
            margin-bottom: 20px;
        }
        
        .modal-btns { display: flex; gap: 10px; }
        .modal-btns .btn { flex: 1; }
        
        /* Loading */
        .loading {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 600;
        }
        
        .spinner {
            width: clamp(40px, 10vw, 60px);
            height: clamp(40px, 10vw, 60px);
            border: 4px solid #333;
            border-top-color:#fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .loading-text {
            margin-top: 20px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(16px, 4vw, 22px);
            letter-spacing: 2px;
        }
        
        /* Card Content */
        .card-content {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: clamp(4px, 1vw, 8px);
        }
        
        /* ========== EPIC CARD CREATOR - NEXT LEVEL ========== */
        .card-builder {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            background: #030305;
            z-index: 500;
            overflow: hidden;
        }
        
        /* FLOATING ACTION BAR - Always visible */
        .card-action-bar {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(0,0,0,0.95);
            border: 2px solid #333;
            border-radius: 50px;
            z-index: 600;
            backdrop-filter: blur(20px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.8), inset 0 1px 0 rgba(255,255,255,0.1);
        }
        
        /* Cool B&W Cyber Buttons */
        .cyber-btn {
            padding: 10px 16px;
            border: 2px solid #444;
            border-radius: 8px;
            background: linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%);
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }
        
        .cyber-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.4s ease;
        }
        
        .cyber-btn:hover::before {
            left: 100%;
        }
        
        .cyber-btn:hover {
            border-color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255,255,255,0.2);
        }
        
        .cyber-btn:active {
            transform: translateY(0);
        }
        
        /* Accent button variants */
        .cyber-btn.primary {
            background: linear-gradient(180deg, #fff 0%, #ccc 100%);
            color: #000;
            border-color: #fff;
        }
        
        .cyber-btn.danger {
            border-color: #666;
            box-shadow: 0 0 15px rgba(255,255,255,0.1);
        }
        
        .cyber-btn.danger:hover {
            background: #fff;
            color: #000;
            box-shadow: 0 0 25px rgba(255,255,255,0.3);
        }
        
        /* Icon-only buttons */
        .cyber-btn.icon-only {
            padding: 10px 12px;
        }
        
        @media (max-width: 600px) {
            .card-action-bar {
                bottom: 70px;
                padding: 8px 12px;
                gap: 6px;
                max-width: 95vw;
                overflow-x: auto;
            }
            .cyber-btn {
                padding: 8px 10px;
                font-size: 10px;
            }
            .cyber-btn span.label {
                display: none;
            }
        }
        
        .card-builder-bg {
            position: absolute;
            inset: 0;
            background: 
                radial-gradient(ellipse at 20% 30%, rgba(201, 162, 39, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 70%, rgba(102, 126, 234, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(139, 92, 246, 0.05) 0%, transparent 70%);
            pointer-events: none;
        }
        
        /* Animated particles background */
        .card-particles {
            position: absolute;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #c9a227;
            border-radius: 50%;
            opacity: 0;
            animation: floatParticle 4s ease-in-out infinite;
        }
        
        @keyframes floatParticle {
            0%, 100% { opacity: 0; transform: translateY(100vh) scale(0); }
            10% { opacity: 0.8; }
            90% { opacity: 0.6; }
            100% { opacity: 0; transform: translateY(-50px) scale(1); }
        }
        
        @keyframes gridDrift {
            0% { transform: translate(0, 0); }
            100% { transform: translate(40px, 40px); }
        }
        
        @keyframes holoShift {
            0% { background-position: 200% 50%; }
            100% { background-position: -200% 50%; }
        }
        
        @keyframes holoText {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }
        
        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
        }
        
        .card-builder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            z-index: 10;
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, transparent 100%);
        }
        
        .card-builder-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            color: #fff;
            letter-spacing: 3px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-rarity-badge {
            font-size: 9px;
            padding: 4px 10px;
            border-radius: 12px;
            font-family: sans-serif;
            font-weight: 700;
            letter-spacing: 1px;
            animation: rarityPulse 2s ease-in-out infinite;
        }
        
        .card-rarity-badge.common { background: #6b7280; color: #fff; }
        .card-rarity-badge.uncommon { background: linear-gradient(135deg, #fff, #16a34a); color: #fff; }
        .card-rarity-badge.rare { background: linear-gradient(135deg, #ccc, #1d4ed8); color: #fff; }
        .card-rarity-badge.epic { background: linear-gradient(135deg, #bbb, #6d28d9); color: #fff; }
        .card-rarity-badge.legendary { background: linear-gradient(135deg, #999, #d97706); color: #000; animation: legendaryGlow 1.5s ease-in-out infinite; }
        .card-rarity-badge.mythic { background: linear-gradient(135deg, #fff, #be185d, #7c3aed); color: #fff; animation: mythicGlow 1s ease-in-out infinite; }
        
        @keyframes rarityPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes legendaryGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(245, 158, 11, 0.5); }
            50% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.8), 0 0 30px rgba(245, 158, 11, 0.4); }
        }
        
        @keyframes mythicGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(236, 72, 153, 0.5), 0 0 20px rgba(124, 58, 237, 0.3); }
            50% { box-shadow: 0 0 25px rgba(236, 72, 153, 0.8), 0 0 40px rgba(124, 58, 237, 0.5); }
        }
        
        /* Template Picker */
        .card-templates {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            padding: 4px;
            scrollbar-width: none;
        }
        
        .card-templates::-webkit-scrollbar { display: none; }
        
        .card-template-btn {
            padding: 6px 12px;
            border-radius: 16px;
            border: 2px solid transparent;
            background: rgba(255,255,255,0.1);
            color: #888;
            font-size: 11px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .card-template-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }
        .card-template-btn.active { border-color: #c9a227; background: rgba(201, 162, 39, 0.2); color: #c9a227; }
        
        /* Card Stage */
        .card-builder-stage {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            perspective: 2000px;
            padding: 10px;
            position: relative;
            z-index: 10;
        }
        
        /* 3D Card Container */
        .card-3d-wrap {
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            z-index: 20;
        }
        
        .card-3d-wrap:hover {
            transform: rotateY(5deg) rotateX(-3deg) scale(1.02);
        }
        
        .card-3d-wrap.flipped {
            transform: rotateY(180deg);
        }
        
        /* Disable 3D on phones for performance */
        @media (max-width: 767px) {
            .card-3d-wrap {
                transform-style: flat;
                transition: transform 0.3s ease, opacity 0.3s ease;
            }
            .card-3d-wrap:hover {
                transform: scale(1.02);
            }
            .card-3d-wrap.flipped {
                transform: scale(0.95);
                opacity: 0.9;
            }
            .card-builder-stage {
                perspective: none;
            }
        }
        
        /* Card Face - BIGGER */
        .epic-card {
            width: min(300px, 80vw);
            height: min(420px, 65vh);
            border-radius: 16px;
            position: relative;
            backface-visibility: hidden;
            overflow: visible;
            box-shadow: 0 25px 80px rgba(0,0,0,0.6);
        }
        
        .epic-card .card-inner {
            width: 100%;
            height: 100%;
        }
        
        .epic-card.back {
            position: absolute;
            top: 0;
            left: 0;
            transform: rotateY(180deg);
        }
        
        /* Card Border Glow based on rarity */
        .epic-card::before {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 18px;
            z-index: -1;
        }
        
        .epic-card.common::before { background: linear-gradient(135deg, #6b7280, #4b5563); }
        .epic-card.uncommon::before { background: linear-gradient(135deg, #fff, #16a34a); }
        .epic-card.rare::before { background: linear-gradient(135deg, #ccc, #1d4ed8); box-shadow: 0 0 30px rgba(59, 130, 246, 0.4); }
        .epic-card.epic::before { background: linear-gradient(135deg, #bbb, #6d28d9); box-shadow: 0 0 40px rgba(139, 92, 246, 0.4); }
        .epic-card.legendary::before { 
            background: linear-gradient(135deg, #fbbf24, #999, #d97706); 
            box-shadow: 0 0 50px rgba(245, 158, 11, 0.5);
            animation: borderGlow 2s ease-in-out infinite;
        }
        .epic-card.mythic::before { 
            background: linear-gradient(135deg, #fff, #ccc, #bbb, #ccc); 
            background-size: 300% 300%;
            animation: mythicBorder 3s ease infinite;
            box-shadow: 0 0 60px rgba(236, 72, 153, 0.4), 0 0 100px rgba(139, 92, 246, 0.3);
        }
        
        @keyframes borderGlow {
            0%, 100% { box-shadow: 0 0 30px rgba(245, 158, 11, 0.4); }
            50% { box-shadow: 0 0 60px rgba(245, 158, 11, 0.7), 0 0 80px rgba(245, 158, 11, 0.3); }
        }
        
        @keyframes mythicBorder {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Holographic Overlay */
        .holo-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(
                125deg,
                transparent 0%,
                rgba(255,255,255,0.1) 15%,
                transparent 30%,
                rgba(255,200,100,0.1) 45%,
                transparent 60%,
                rgba(100,200,255,0.1) 75%,
                transparent 100%
            );
            background-size: 200% 200%;
            pointer-events: none;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s;
            mix-blend-mode: overlay;
        }
        
        .card-3d-wrap:hover .holo-overlay {
            opacity: 1;
            animation: holoShine 3s ease-in-out infinite;
        }
        
        @keyframes holoShine {
            0% { background-position: 200% 0%; }
            100% { background-position: -200% 0%; }
        }
        
        /* Sparkle Effect for Legendary+ */
        .sparkle-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 51;
            overflow: hidden;
        }
        
        .sparkle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #fff 0%, transparent 70%);
            border-radius: 50%;
            opacity: 0;
            animation: sparkle 2s ease-in-out infinite;
        }
        
        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
        }
        
        /* Card Inner Content */
        .card-inner {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%);
            padding: 8px;
            position: relative;
        }
        
        .card-frame-inner {
            flex: 1;
            border: 3px solid;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #fff;
        }
        
        /* Card Header with animated gradient */
        .card-title-bar {
            padding: 10px 12px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 16px;
            text-align: center;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
        }
        
        .card-title-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        /* Card Image Area */
        .card-image-area {
            flex: 1;
            background: #222;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .card-image-area img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .card-image-placeholder {
            color: #666;
            text-align: center;
            font-size: 12px;
        }
        
        /* Card Name Bar */
        .card-name-bar {
            padding: 8px 12px;
            font-family: 'Bangers', cursive;
            font-size: 18px;
            text-align: center;
            letter-spacing: 1px;
        }
        
        /* Animated Stats */
        .card-stats-bar {
            padding: 8px 12px;
            display: flex;
            justify-content: space-around;
            gap: 8px;
        }
        
        .stat-item {
            flex: 1;
            text-align: center;
        }
        
        .stat-label {
            font-size: 8px;
            color: #888;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
        }
        
        .stat-bar-wrap {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 2px;
        }
        
        .stat-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 1s ease-out;
        }
        
        .stat-bar.pwr { background: linear-gradient(90deg, #888, #aaa); }
        .stat-bar.spd { background: linear-gradient(90deg, #ccc, #06b6d4); }
        .stat-bar.int { background: linear-gradient(90deg, #bbb, #ccc); }
        
        .stat-value {
            font-size: 14px;
            font-weight: 700;
            color: #fff;
        }
        
        /* QR Code */
        .card-qr {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 40px;
            height: 40px;
            background: #fff;
            border-radius: 4px;
            padding: 4px;
        }
        
        /* Card Actions */
        .card-builder-actions {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            padding: 16px;
            background: linear-gradient(0deg, rgba(0,0,0,0.95) 0%, transparent 100%);
            z-index: 10;
        }
        
        .card-action-btn {
            padding: 10px 16px;
            border-radius: 20px;
            border: none;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            background: rgba(255,255,255,0.1);
            color: #fff;
            backdrop-filter: blur(10px);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .card-action-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        
        .card-action-btn.primary {
            background: linear-gradient(135deg, #c9a227, #f4d03f);
            color: #000;
        }
        
        .card-action-btn.primary:hover {
            box-shadow: 0 8px 25px rgba(201, 162, 39, 0.4);
        }
        
        .card-action-btn.magic {
            background: linear-gradient(135deg, #bbb, #ccc);
            color: #fff;
        }
        
        /* Rarity Selector */
        .rarity-selector {
            display: flex;
            gap: 4px;
        }
        
        .rarity-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        
        .rarity-dot:hover { transform: scale(1.2); }
        .rarity-dot.active { border-color: #fff; box-shadow: 0 0 10px currentColor; }
        
        .rarity-dot.common { background: #6b7280; }
        .rarity-dot.uncommon { background: #fff; }
        .rarity-dot.rare { background: #ccc; }
        .rarity-dot.epic { background: #bbb; }
        .rarity-dot.legendary { background: linear-gradient(135deg, #999, #fbbf24); }
        .rarity-dot.mythic { background: linear-gradient(135deg, #fff, #bbb); }

        /* Card Content */
        .card-content {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: clamp(4px, 1vw, 8px);
        }
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Card Builder Actions */
        .card-builder-actions {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 16px;
            background: linear-gradient(0deg, rgba(0,0,0,0.9) 0%, transparent 100%);
        }
        
        .card-action-btn {
            padding: 12px 20px;
            border-radius: 25px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            background: rgba(255,255,255,0.1);
            color: #fff;
            backdrop-filter: blur(10px);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .card-action-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        
        .card-action-btn.gold {
            background: linear-gradient(135deg, #c9a227, #f4d03f);
            color: #000;
        }
        
        .card-action-btn.gold:hover {
            box-shadow: 0 8px 25px rgba(201, 162, 39, 0.4);
        }
        
        /* Style Picker */
        .card-style-picker {
            display: flex;
            gap: 8px;
            padding: 8px;
        }
        
        .card-style-option {
            width: 40px;
            height: 52px;
            border-radius: 6px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
        }
        
        .card-style-option:hover {
            transform: scale(1.1);
        }
        
        .card-style-option.active {
            border-color: #fff;
            box-shadow: 0 0 15px rgba(255,255,255,0.3);
        }
        
        .card-style-option.gold { background: linear-gradient(135deg, #c9a227, #1a1a2e); }
        .card-style-option.silver { background: linear-gradient(135deg, #aaa, #2a2a3e); }
        .card-style-option.fire { background: linear-gradient(135deg, #ff4500, #1a0a0a); }
        .card-style-option.ice { background: linear-gradient(135deg, #00bfff, #0a1a2a); }
        .card-style-option.neon { background: linear-gradient(135deg, #ff00ff, #0a0a1a); }
        .card-style-option.nature { background: linear-gradient(135deg, #fff, #0a1a0a); }
        
        .card-frame {
            flex: 1;
            border: clamp(2px, 0.5vw, 4px) solid #c9a227;
            border-radius: 8px;
            background: #fff;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .card-header {
            background: linear-gradient(90deg, #c9a227, #f4d03f, #c9a227);
            padding: clamp(4px, 1vw, 10px);
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(10px, 2.5vw, 14px);
            color: #1a1a2e;
            text-align: center;
        }
        
        .card-image {
            flex: 1;
            background: #ddd;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: clamp(8px, 2vw, 11px);
            min-height: 60px;
        }
        
        .card-name {
            background: linear-gradient(90deg, #c9a227, #f4d03f, #c9a227);
            padding: clamp(4px, 1vw, 8px);
            font-family: 'Bangers', cursive;
            font-size: clamp(12px, 3vw, 16px);
            color: #1a1a2e;
            text-align: center;
        }
        
        .card-stats {
            background: #1a1a2e;
            padding: clamp(4px, 1vw, 8px);
            color: #c9a227;
            font-size: clamp(8px, 2vw, 11px);
            display: flex;
            justify-content: space-around;
        }
        
        /* Cover Content */
        .cover-content {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #222;
        }
        
        .cover-header {
            background: linear-gradient(90deg, #e53935, #c62828);
            padding: clamp(4px, 1vw, 10px) clamp(8px, 2vw, 14px);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .cover-logo {
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(10px, 2.5vw, 14px);
            color: #fff;
        }
        
        .cover-issue {
            background: #fff;
            color: #c62828;
            padding: 2px clamp(4px, 1vw, 8px);
            font-size: clamp(8px, 2vw, 11px);
            border-radius: 4px;
            font-weight: 700;
        }
        
        .cover-main {
            flex: 1;
            background: #444;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: clamp(8px, 2vw, 14px);
            position: relative;
            min-height: 100px;
        }
        
        .cover-title {
            font-family: 'Bangers', cursive;
            font-size: clamp(16px, 4vw, 24px);
            color: #fff;
            text-shadow: 2px 2px 0 #000;
            text-align: center;
        }
        
        .cover-tagline {
            font-size: clamp(8px, 2vw, 11px);
            color: #ffeb3b;
            text-align: center;
            margin-top: 6px;
            background: rgba(0,0,0,0.7);
            padding: clamp(2px, 0.5vw, 6px) clamp(6px, 1.5vw, 10px);
            border-radius: 4px;
        }
        
        .cover-footer {
            background: #111;
            padding: clamp(4px, 1vw, 8px) clamp(8px, 2vw, 14px);
            display: flex;
            justify-content: space-between;
            color: #666;
            font-size: clamp(8px, 2vw, 10px);
        }
        
        #exportCanvas { display: none; }
        
        .save-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 500;
            padding: 20px;
        }
        
        .save-preview-img {
            max-width: 90%;
            max-height: 50vh;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .save-instructions {
            text-align: center;
            margin-top: 24px;
            padding: 20px;
            background: #1a1a1a;
            border-radius: 16px;
            max-width: 320px;
        }
        
        .save-instructions h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 22px;
            letter-spacing: 2px;
            margin-bottom: 16px;
            color: #34c759;
        }
        
        .save-step {
            display: flex;
            align-items: center;
            gap: 12px;
            text-align: left;
            padding: 10px 0;
            font-size: 15px;
            border-bottom: 1px solid #333;
        }
        
        .save-step:last-child {
            border-bottom: none;
        }
        
        .save-step-num {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #fff, #e0e0e0);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .save-close-btn {
            margin-top: 20px;
            padding: 16px 48px;
            background: linear-gradient(135deg, #fff, #e0e0e0);
            border: none;
            border-radius: 30px;
            color: #fff;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            letter-spacing: 3px;
            cursor: pointer;
        }
        
        .save-close-btn:active {
            transform: scale(0.95);
        }
        
        /* ========== STUDIO MODE - Unified Drawing & Animation ========== */
        .studio-overlay {
            position: fixed;
            inset: 0;
            background: #0d0d14;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .studio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            background: #16161f;
            border-bottom: 1px solid #2a2a3a;
            flex-shrink: 0;
        }
        
        .studio-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 18px;
            color: #fff;
            letter-spacing: 3px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .studio-title-badge {
            background: linear-gradient(135deg, #fff, #fff);
            color: #000;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-family: sans-serif;
            letter-spacing: 0;
        }
        
        .studio-header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .studio-btn {
            padding: 8px 14px;
            border-radius: 6px;
            border: none;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            background: #2a2a3a;
            color: #fff;
            transition: all 0.15s;
        }
        
        .studio-btn:hover { background: #3a3a4a; }
        .studio-btn:active { transform: scale(0.97); }
        .studio-btn.primary { background: linear-gradient(135deg, #fff, #e0e0e0); }
        .studio-btn.success { background: linear-gradient(135deg, #fff, #fff); color: #000; }
        .studio-btn.danger { background: #dc2626; }
        
        .studio-tabs {
            display: flex;
            background: #16161f;
            border-bottom: 1px solid #2a2a3a;
            flex-shrink: 0;
        }
        
        .studio-tab {
            padding: 12px 24px;
            font-size: 13px;
            font-weight: 600;
            color: #888;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.15s;
        }
        
        .studio-tab:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .studio-tab.active { color:#fff; border-bottom-color:#fff; }
        
        .studio-toolbar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #1a1a24;
            border-bottom: 1px solid #2a2a3a;
            flex-shrink: 0;
            overflow-x: auto;
        }
        
        .studio-tool-group {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .studio-tool-label {
            font-size: 11px;
            color: #666;
            margin-right: 6px;
            white-space: nowrap;
        }
        
        .studio-tool {
            padding: 8px 12px;
            border-radius: 6px;
            border: 2px solid transparent;
            background: #2a2a3a;
            color: #ccc;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
            transition: all 0.15s;
        }
        
        .studio-tool:hover { background: #3a3a4a; color: #fff; }
        .studio-tool.active { border-color:#fff; background: rgba(102,126,234,0.2); color: #fff; }
        
        .studio-divider {
            width: 1px;
            height: 28px;
            background: #3a3a4a;
            margin: 0 8px;
            flex-shrink: 0;
        }
        
        .studio-slider {
            width: 80px;
            height: 4px;
            -webkit-appearance: none;
            background: #3a3a4a;
            border-radius: 2px;
            outline: none;
        }
        
        .studio-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .studio-color-swatch {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: transform 0.15s;
        }
        
        .studio-color-swatch:hover { transform: scale(1.1); }
        .studio-color-swatch.active { border:2px solid #fff; }
        
        .studio-color-input {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 3px solid #fff;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
        
        .studio-main {
            flex: 1;
            display: flex;
            background: #12121a;
            overflow: hidden;
        }
        
        .studio-canvas-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }
        
        .studio-canvas-wrapper {
            position: relative;
            box-shadow: 0 8px 40px rgba(0,0,0,0.6);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .studio-canvas {
            display: block;
            touch-action: none;
            cursor: crosshair;
            background: #fff;
        }
        
        .studio-canvas-bg {
            position: absolute;
            inset: 0;
            pointer-events: none;
            background-size: cover;
            background-position: center;
        }
        
        .studio-sidebar {
            width: 280px;
            background: #16161f;
            border-left: 1px solid #2a2a3a;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        
        .studio-sidebar-title {
            padding: 12px 16px;
            font-size: 12px;
            font-weight: 600;
            color: #888;
            border-bottom: 1px solid #2a2a3a;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .studio-sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        
        .studio-anim-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: #1a1a24;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s;
        }
        
        .studio-anim-item:hover { background: #22222e; }
        .studio-anim-item.active { border-color:#fff; }
        
        .studio-anim-icon {
            font-size: 20px;
        }
        
        .studio-anim-info {
            flex: 1;
        }
        
        .studio-anim-name {
            font-size: 13px;
            color: #fff;
            font-weight: 500;
        }
        
        .studio-anim-desc {
            font-size: 10px;
            color: #666;
        }
        
        .studio-footer {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: #16161f;
            border-top: 1px solid #2a2a3a;
            flex-shrink: 0;
        }
        
        .studio-frames {
            display: flex;
            gap: 8px;
            flex: 1;
            overflow-x: auto;
            padding: 4px;
        }
        
        .studio-frame {
            width: 64px;
            height: 80px;
            background: #1a1a24;
            border: 2px solid #3a3a4a;
            border-radius: 6px;
            flex-shrink: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.15s;
            overflow: hidden;
        }
        
        .studio-frame:hover { border-color:#fff; }
        .studio-frame.active { border-color:#fff; box-shadow: 0 0 0 2px rgba(102,126,234,0.3); }
        
        .studio-frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .studio-frame-num {
            position: absolute;
            bottom: 3px;
            right: 5px;
            font-size: 9px;
            color: #fff;
            background: rgba(0,0,0,0.7);
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .studio-frame-add {
            background: transparent;
            border: 2px dashed #3a3a4a;
            color: #666;
            font-size: 24px;
        }
        
        .studio-frame-add:hover {
            border-color:#fff;
            color:#fff;
        }
        
        .studio-playback {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .studio-fps {
            font-size: 11px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Transform controls in studio */
        .studio-transform {
            padding: 16px;
        }
        
        .studio-transform-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .studio-transform-label {
            width: 80px;
            font-size: 12px;
            color: #888;
        }
        
        .studio-transform-slider {
            flex: 1;
        }
        
        .studio-transform-value {
            width: 50px;
            font-size: 12px;
            color: #fff;
            text-align: right;
        }
        
        /* Animation Mode Styles */
        .animate-overlay {
            position: fixed;
            inset: 0;
            background: #0a0a0a;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .animate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #111;
            border-bottom: 1px solid #333;
        }
        
        .animate-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            color: #fff;
        }
        
        .animate-preview-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            overflow: hidden;
        }
        
        .animate-canvas {
            position: relative;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            overflow: hidden;
            aspect-ratio: 8.5/11;
            max-height: 100%;
            max-width: 100%;
        }
        
        .animate-panel {
            position: absolute;
            background-size: cover;
            background-position: center;
            border: 2px solid #000;
            cursor: pointer;
            transition: outline 0.2s;
        }
        
        .animate-panel:hover {
            outline: 3px solid #fff;
        }
        
        .animate-panel.selected {
            outline: 3px solid #fff;
        }
        
        .animate-panel-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #fff;
            color: #fff;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .animate-element {
            position: absolute;
            cursor: pointer;
        }
        
        .animate-element.selected {
            outline: 2px dashed #fff;
        }
        
        .animate-timeline {
            background: #111;
            border-top: 1px solid #333;
            padding: 12px 16px;
        }
        
        .timeline-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
        }
        
        .timeline-track {
            display: flex;
            gap: 4px;
            overflow-x: auto;
            padding: 8px 0;
        }
        
        .timeline-item {
            flex-shrink: 0;
            width: 60px;
            height: 50px;
            background: #1a1a2e;
            border: 2px solid #333;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #fff;
            cursor: pointer;
        }
        
        .timeline-item.active {
            border-color: #fff;
            background: rgba(244, 114, 182, 0.2);
        }
        
        .timeline-item.has-anim {
            border-color: #fff;
        }
        
        .animate-controls {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            background: #0a0a0a;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .anim-btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: 2px solid #333;
            background: #1a1a2e;
            color: #fff;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .anim-btn:active {
            transform: scale(0.95);
        }
        
        .anim-btn.active {
            border-color: #fff;
            background: #fff;
        }
        
        .anim-btn.play {
            background: linear-gradient(135deg, #fff, #fff);
            border-color: #fff;
        }
        
        .animate-options {
            background: #111;
            padding: 12px 16px;
            border-top: 1px solid #333;
        }
        
        .anim-option-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .anim-option-label {
            font-size: 12px;
            color: #888;
            width: 80px;
        }
        
        .anim-option-btns {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .anim-type-btn {
            padding: 8px 12px;
            border-radius: 6px;
            border: 2px solid #333;
            background: #1a1a2e;
            color: #fff;
            font-size: 11px;
            cursor: pointer;
        }
        
        .anim-type-btn.active {
            border-color: #fff;
            background: rgba(244, 114, 182, 0.3);
        }
        
        /* Animation Keyframes */
        @keyframes anim-fade {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes anim-slide-left {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes anim-slide-right {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes anim-slide-up {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes anim-slide-down {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes anim-zoom {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes anim-pop {
            0% { transform: scale(0); }
            70% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        @keyframes anim-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        @keyframes anim-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        @keyframes anim-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes anim-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes anim-flash {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0; }
        }
        
        @keyframes anim-kenburns-in {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(1.3); opacity: 1; }
        }
        
        @keyframes anim-kenburns-out {
            from { transform: scale(1.3); opacity: 1; }
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes anim-kenburns-left {
            from { transform: scale(1.2) translateX(5%); opacity: 1; }
            to { transform: scale(1.2) translateX(-5%); opacity: 1; }
        }
        
        @keyframes anim-kenburns-right {
            from { transform: scale(1.2) translateX(-5%); opacity: 1; }
            to { transform: scale(1.2) translateX(5%); opacity: 1; }
        }
        
        @keyframes anim-float {
            0%, 100% { transform: translate(-50%, -50%) translateY(0); }
            50% { transform: translate(-50%, -50%) translateY(-15px); }
        }
        
        @keyframes anim-jello {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            25% { transform: translate(-50%, -50%) scale(1.1, 0.9); }
            50% { transform: translate(-50%, -50%) scale(0.9, 1.1); }
            75% { transform: translate(-50%, -50%) scale(1.05, 0.95); }
        }
        
        .playing-fade { animation: anim-fade 0.5s ease-out forwards; }
        .playing-slide-left { animation: anim-slide-left 0.5s ease-out forwards; }
        .playing-slide-right { animation: anim-slide-right 0.5s ease-out forwards; }
        .playing-slide-up { animation: anim-slide-up 0.5s ease-out forwards; }
        .playing-slide-down { animation: anim-slide-down 0.5s ease-out forwards; }
        .playing-zoom { animation: anim-zoom 0.4s ease-out forwards; }
        .playing-pop { animation: anim-pop 0.4s ease-out forwards; }
        .playing-shake { animation: anim-shake 0.5s ease-in-out forwards; }
        .playing-bounce { animation: anim-bounce 0.6s ease-in-out forwards; }
        .playing-spin { animation: anim-spin 0.6s ease-in-out forwards; }
        .playing-pulse { animation: anim-pulse 0.5s ease-in-out infinite; }
        .playing-flash { animation: anim-flash 0.5s ease-in-out forwards; }
        .playing-kenburns-in { animation: anim-kenburns-in 3s ease-out forwards; overflow: hidden; }
        .playing-kenburns-out { animation: anim-kenburns-out 3s ease-out forwards; overflow: hidden; }
        .playing-kenburns-left { animation: anim-kenburns-left 3s ease-in-out forwards; overflow: hidden; }
        .playing-kenburns-right { animation: anim-kenburns-right 3s ease-in-out forwards; overflow: hidden; }
        .playing-float { animation: anim-float 2s ease-in-out infinite; }
        .playing-jello { animation: anim-jello 0.8s ease-in-out forwards; }
        
        /* Page Transition Animations */
        @keyframes page-fade {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes page-slide-left {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        @keyframes page-slide-right {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        @keyframes page-flip {
            0% { transform: perspective(1000px) rotateY(-90deg); opacity: 0; }
            100% { transform: perspective(1000px) rotateY(0); opacity: 1; }
        }
        
        @keyframes page-zoom {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .page-trans-fade { animation: page-fade 0.4s ease-out; }
        .page-trans-slide-left { animation: page-slide-left 0.4s ease-out; }
        .page-trans-slide-right { animation: page-slide-right 0.4s ease-out; }
        .page-trans-flip { animation: page-fade 0.3s ease-out; } /* Fallback to fade on all devices */
        .page-trans-zoom { animation: page-zoom 0.4s ease-out; }
        
        /* Only enable flip animation on iPad/tablet and desktop - phones get fade instead */
        @media (min-width: 768px) {
            .page-trans-flip { animation: page-flip 0.5s ease-out; }
        }
        
        /* Reduce animation complexity on mobile for performance */
        @media (max-width: 767px) {
            .page-trans-zoom { animation: page-fade 0.3s ease-out; }
            .reader-page.trans-flip { animation: none; }
        }
        
        /* ========== NEON BUTTON STYLES ========== */
        .neon-btn {
            background: rgba(15, 15, 25, 0.9);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            overflow: hidden;
        }
        
        .neon-btn svg {
            stroke: #0ff;
            filter: drop-shadow(0 0 3px rgba(0, 255, 255, 0.5));
            transition: all 0.15s ease;
        }
        
        .neon-btn:hover {
            border-color: rgba(0, 255, 255, 0.6);
            box-shadow: 
                0 0 15px rgba(0, 255, 255, 0.3),
                0 0 30px rgba(0, 255, 255, 0.1),
                inset 0 0 15px rgba(0, 255, 255, 0.05);
        }
        
        .neon-btn:hover svg {
            filter: drop-shadow(0 0 5px rgba(0, 255, 255, 0.8)) drop-shadow(0 0 10px rgba(0, 255, 255, 0.4));
        }
        
        .neon-btn:active {
            transform: scale(0.92);
            border-color: #f0f;
            box-shadow: 
                0 0 20px rgba(255, 0, 255, 0.5),
                0 0 40px rgba(255, 0, 255, 0.3),
                inset 0 0 20px rgba(255, 0, 255, 0.1);
        }
        
        .neon-btn:active svg {
            stroke: #f0f;
            filter: drop-shadow(0 0 6px #f0f) drop-shadow(0 0 12px #f0f);
        }
        
        /* Magenta variant */
        .neon-btn.magenta {
            border-color: rgba(255, 0, 255, 0.3);
        }
        
        .neon-btn.magenta svg {
            stroke: #f0f;
            filter: drop-shadow(0 0 3px rgba(255, 0, 255, 0.5));
        }
        
        .neon-btn.magenta:hover {
            border-color: rgba(255, 0, 255, 0.6);
            box-shadow: 
                0 0 15px rgba(255, 0, 255, 0.3),
                0 0 30px rgba(255, 0, 255, 0.1);
        }
        
        .neon-btn.magenta:active {
            border-color: #0ff;
            box-shadow: 
                0 0 20px rgba(0, 255, 255, 0.5),
                0 0 40px rgba(0, 255, 255, 0.3);
        }
        
        .neon-btn.magenta:active svg {
            stroke: #0ff;
            filter: drop-shadow(0 0 6px #0ff) drop-shadow(0 0 12px #0ff);
        }
        
        /* Dual gradient variant */
        .neon-btn.dual {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.05), rgba(255, 0, 255, 0.05));
            border-color: rgba(0, 255, 255, 0.2);
            border-image: linear-gradient(135deg, rgba(0, 255, 255, 0.4), rgba(255, 0, 255, 0.4)) 1;
        }
        
        /* Nav item neon style */
        .nav-item.neon {
            transition: all 0.2s ease;
        }
        
        .nav-item.neon svg {
            stroke: #555;
            transition: all 0.15s ease;
        }
        
        .nav-item.neon:active {
            transform: scale(0.9);
        }
        
        .nav-item.neon:active svg {
            stroke: #f0f;
            filter: drop-shadow(0 0 6px #f0f);
        }
        
        .nav-item.neon.active svg {
            stroke: #0ff;
            filter: drop-shadow(0 0 4px #0ff) drop-shadow(0 0 8px #0ff);
            animation: neonPulse 2s ease-in-out infinite;
        }
        
        .nav-item.neon.active span {
            color: #0ff;
            text-shadow: 0 0 8px rgba(0, 255, 255, 0.5);
        }
        
        @keyframes neonPulse {
            0%, 100% { filter: drop-shadow(0 0 4px #0ff) drop-shadow(0 0 8px #0ff); }
            50% { filter: drop-shadow(0 0 8px #0ff) drop-shadow(0 0 16px #0ff); }
        }
        
        /* Tool button neon style */
        .tool-btn.neon {
            background: rgba(15, 15, 25, 0.9);
            border: 1px solid rgba(0, 255, 255, 0.25);
            border-radius: 10px;
            transition: all 0.2s ease;
        }
        
        .tool-btn.neon svg {
            stroke: #0ff;
            filter: drop-shadow(0 0 2px rgba(0, 255, 255, 0.4));
            transition: all 0.15s ease;
        }
        
        .tool-btn.neon:hover {
            border-color: rgba(0, 255, 255, 0.5);
            box-shadow: 0 0 12px rgba(0, 255, 255, 0.2);
        }
        
        .tool-btn.neon:active {
            transform: scale(0.9);
            border-color: #f0f;
        }
        
        .tool-btn.neon:active svg {
            stroke: #f0f;
            filter: drop-shadow(0 0 4px #f0f);
        }
        
        .tool-btn.neon.active {
            background: rgba(0, 255, 255, 0.15);
            border-color: #0ff;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3), inset 0 0 10px rgba(0, 255, 255, 0.1);
        }
        
        .tool-btn.neon.active svg {
            stroke: #0ff;
            filter: drop-shadow(0 0 4px #0ff) drop-shadow(0 0 8px #0ff);
        }
        
        /* Tool strip button neon style */
        .tool-strip-btn.neon {
            background: rgba(15, 15, 25, 0.9);
            border: 1px solid rgba(0, 255, 255, 0.25);
            transition: all 0.2s ease;
        }
        
        .tool-strip-btn.neon svg {
            stroke: #0ff;
            filter: drop-shadow(0 0 2px rgba(0, 255, 255, 0.4));
            transition: all 0.15s ease;
        }
        
        .tool-strip-btn.neon:hover {
            border-color: rgba(0, 255, 255, 0.5);
            box-shadow: 0 0 12px rgba(0, 255, 255, 0.2);
            background: rgba(0, 255, 255, 0.1);
        }
        
        .tool-strip-btn.neon:active {
            transform: scale(0.9);
            border-color: #f0f;
        }
        
        .tool-strip-btn.neon:active svg {
            stroke: #f0f;
            filter: drop-shadow(0 0 4px #f0f);
        }
        
        .tool-strip-btn.neon.active {
            background: rgba(0, 255, 255, 0.15);
            border-color: #0ff;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3), inset 0 0 10px rgba(0, 255, 255, 0.1);
        }
        
        .tool-strip-btn.neon.active svg {
            stroke: #0ff;
            filter: drop-shadow(0 0 4px #0ff) drop-shadow(0 0 8px #0ff);
        }
        
        /* Header button neon */
        .header-btn.neon {
            background: rgba(15, 15, 25, 0.8);
            border: 1px solid rgba(0, 255, 255, 0.3);
            transition: all 0.2s ease;
        }
        
        .header-btn.neon svg {
            stroke: #0ff;
            filter: drop-shadow(0 0 2px rgba(0, 255, 255, 0.4));
        }
        
        .header-btn.neon:active {
            transform: scale(0.9);
            border-color: #f0f;
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.4);
        }
        
        .header-btn.neon:active svg {
            stroke: #f0f;
            filter: drop-shadow(0 0 4px #f0f);
        }
        
        /* Sidebar item neon */
        .sidebar-item.neon {
            transition: all 0.2s ease;
        }
        
        .sidebar-item.neon svg {
            stroke: #0ff;
            filter: drop-shadow(0 0 2px rgba(0, 255, 255, 0.3));
            transition: all 0.15s ease;
        }
        
        .sidebar-item.neon:hover {
            background: rgba(0, 255, 255, 0.1);
        }
        
        .sidebar-item.neon:active svg {
            stroke: #f0f;
            filter: drop-shadow(0 0 4px #f0f);
        }
        
        .sidebar-item.neon.active {
            background: rgba(0, 255, 255, 0.15);
            border-left: 2px solid #0ff;
            box-shadow: inset 0 0 20px rgba(0, 255, 255, 0.1);
        }
        
        .sidebar-item.neon.active svg {
            stroke: #0ff;
            filter: drop-shadow(0 0 4px #0ff);
        }
        /* ========== END NEON STYLES ========== */
        
        /* Neon Floating Action Buttons (FAB) */
        .neon-fab {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 1px solid rgba(0, 255, 255, 0.4);
            background: rgba(15, 15, 25, 0.9);
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
        }
        
        .neon-fab:hover {
            border-color: rgba(0, 255, 255, 0.7);
            box-shadow: 
                0 0 15px rgba(0, 255, 255, 0.4),
                0 0 30px rgba(0, 255, 255, 0.2),
                inset 0 0 10px rgba(0, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .neon-fab:active {
            transform: scale(0.9);
            border-color: #f0f;
            box-shadow: 
                0 0 20px rgba(255, 0, 255, 0.5),
                0 0 40px rgba(255, 0, 255, 0.3),
                inset 0 0 15px rgba(255, 0, 255, 0.15);
        }
        
        .neon-fab.magenta {
            border-color: rgba(255, 0, 255, 0.4);
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.2);
        }
        
        .neon-fab.magenta:hover {
            border-color: rgba(255, 0, 255, 0.7);
            box-shadow: 
                0 0 15px rgba(255, 0, 255, 0.4),
                0 0 30px rgba(255, 0, 255, 0.2);
        }
        
        .neon-fab.magenta:active {
            border-color: #0ff;
            box-shadow: 
                0 0 20px rgba(0, 255, 255, 0.5),
                0 0 40px rgba(0, 255, 255, 0.3);
        }
        
        /* Post FAB - special gradient style - CIRCULAR */
        .neon-fab.post-fab {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.15), rgba(255, 0, 255, 0.15)) !important;
            border: 2px solid #f0f !important;
            border-radius: 50% !important;
            box-shadow: 
                0 0 10px rgba(0, 255, 255, 0.3),
                0 0 10px rgba(255, 0, 255, 0.3);
            width: 44px !important;
            height: 44px !important;
            min-width: 44px !important;
            min-height: 44px !important;
        }
        
        .neon-fab.post-fab:hover {
            box-shadow: 
                0 0 20px rgba(0, 255, 255, 0.5),
                0 0 20px rgba(255, 0, 255, 0.5);
            transform: scale(1.1);
            border-color: #0ff;
        }
        
        .neon-fab.post-fab:active {
            transform: scale(0.9);
            box-shadow: 
                0 0 30px rgba(255, 255, 255, 0.6);
        }
        
        /* Disable heavy animations on mobile */
        @media (max-width: 767px) {
            .neon-fab.post-fab {
                animation: none;
                border-radius: 50% !important;
            }
            .neon-btn, .neon-fab, .sidebar-item.neon, .nav-item.neon {
                transition-duration: 0.1s;
            }
            /* Mobile performance boost */
            * {
                -webkit-tap-highlight-color: transparent;
            }
            .sheet, .sidebar, .studio-main, .canvas {
                will-change: auto;
            }
            .btn, button {
                transition: none !important;
            }
            .header-btn, .action-btn {
                transition: transform 0.1s !important;
            }
            /* Disable all glow/shadow animations on mobile */
            .neon-btn:hover, .neon-fab:hover, .action-btn.neon:hover {
                box-shadow: none !important;
            }
            /* KILL ALL 3D ON MOBILE - Prevents crashes */
            *, *::before, *::after {
                transform-style: flat !important;
                perspective: none !important;
                backface-visibility: visible !important;
            }
            @keyframes flipIn { from { opacity: 0; } to { opacity: 1; } }
            @keyframes cardReveal { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
            @keyframes page-flip { from { opacity: 0; } to { opacity: 1; } }
        }
        
        /* Action button neon styles */
        .action-btn.neon {
            background: rgba(15, 15, 25, 0.9);
            border: 1px solid rgba(0, 255, 255, 0.3);
            transition: all 0.2s ease;
        }
        
        .action-btn.neon svg {
            stroke: #0ff;
            filter: drop-shadow(0 0 2px rgba(0, 255, 255, 0.4));
        }
        
        .action-btn.neon:hover {
            border-color: rgba(0, 255, 255, 0.6);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
            background: rgba(0, 255, 255, 0.1);
        }
        
        .action-btn.neon:active {
            transform: scale(0.9);
            border-color: #f0f;
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.5);
        }
        
        .action-btn.neon:active svg {
            stroke: #f0f;
            filter: drop-shadow(0 0 4px #f0f);
        }
        
        .action-btn.neon.blue { border-color: rgba(0, 200, 255, 0.4); }
        .action-btn.neon.green { border-color: rgba(0, 255, 150, 0.4); }
        .action-btn.neon.orange { border-color: rgba(255, 150, 0, 0.4); }
        .action-btn.neon.purple { border-color: rgba(200, 0, 255, 0.4); }
        .action-btn.neon.red { border-color: rgba(255, 50, 100, 0.4); }
        
        .action-btn.neon.blue:hover { box-shadow: 0 0 15px rgba(0, 200, 255, 0.4); }
        .action-btn.neon.green:hover { box-shadow: 0 0 15px rgba(0, 255, 150, 0.4); }
        .action-btn.neon.orange:hover { box-shadow: 0 0 15px rgba(255, 150, 0, 0.4); }
        .action-btn.neon.purple:hover { box-shadow: 0 0 15px rgba(200, 0, 255, 0.4); }
        .action-btn.neon.red:hover { box-shadow: 0 0 15px rgba(255, 50, 100, 0.4); }
    </style>
    
    <!-- Firebase for Multiplayer - Primary CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Firebase Loading Check -->
    <script>
        window.firebaseLoaded = typeof firebase !== 'undefined';
        if (!window.firebaseLoaded) {
            console.error('Firebase failed to load from primary CDN');
        } else {
            
        }
    </script>
    <!-- html2canvas for post thumbnails -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <!-- Legal Gate Click Handlers - Must be before the buttons -->
    <script>
    function handleLegal1Click() {
        if (document.getElementById('legalCheck1').checked) {
            acceptLegalGate1();
        } else {
            alert('Please check the box to agree to the terms');
        }
    }
    
    function handleLegal2Click() {
        if (document.getElementById('legalCheck2').checked) {
            acceptLegalGate2();
        } else {
            alert('Please check the box to agree to the terms');
        }
    }
    
    function acceptLegalGate1() {
        const timestamp = new Date().toISOString();
        localStorage.setItem('pscomixx_nda_accepted', 'true');
        localStorage.setItem('pscomixx_nda_timestamp', timestamp);
        
        document.getElementById('legalGate1').classList.add('hidden');
        document.getElementById('legalGate2').classList.remove('hidden');
    }
    
    function acceptLegalGate2() {
        const timestamp = new Date().toISOString();
        localStorage.setItem('pscomixx_terms_accepted', 'true');
        localStorage.setItem('pscomixx_terms_timestamp', timestamp);
        localStorage.setItem('pscomixx_legal_full_accepted', 'true');
        localStorage.setItem('pscomixx_legal_accepted', 'true');
        localStorage.setItem('pscomixx_legal_timestamp', timestamp);
        localStorage.setItem('pscomixx_legal_version', '1.0.0');
        
        document.getElementById('legalGate1').classList.add('hidden');
        document.getElementById('legalGate2').classList.add('hidden');
        // Trigger app render if S exists
        if (typeof S !== 'undefined') {
            S.legalAccepted = true;
            S.legalAcceptedAt = timestamp;
            if (typeof render === 'function') render();
        }
    }
    </script>

    <!-- LEGAL GATE - CONFIDENTIAL ENTRY & IP PROTECTION -->
    <div id="legalGate1" class="legal-gate">
        <div class="legal-modal">
            <div class="legal-header">
                <div style="font-size:32px;margin-bottom:8px"></div>
                <div class="legal-logo">PRESS START GAMING INC</div>
                <div class="legal-subtitle">MADMIXEDMEDIA LLC</div>
                <div style="font-size:9px;color:#444;margin-top:8px">CONFIDENTIAL ENTRY & INTELLECTUAL PROPERTY DISCLOSURE</div>
                <div style="font-size:8px;color:#333;margin-top:4px">Effective Upon Entry  Legally Binding Agreement</div>
            </div>
            <div class="legal-body">
                <div style="background:#1a0a0a;border:1px solid #ff000033;border-radius:8px;padding:16px;margin-bottom:20px">
                    <p style="color:#ff6b6b;font-size:12px;text-align:center;margin:0;font-weight:bold"> STOP AND READ CAREFULLY </p>
                    <p style="color:#ff9999;font-size:11px;text-align:center;margin:8px 0 0 0">This is a LEGALLY BINDING AGREEMENT. By proceeding, you are entering into a contractual relationship with PRESS START GAMING INC and MADMIXEDMEDIA LLC.</p>
                </div>
                
                <p style="color:#fff;font-size:13px;text-align:center;margin-bottom:20px">By entering, accessing, browsing, previewing, testing, demonstrating, viewing, inspecting, or using any part of this platform, application, website, software, service, or any related materials ("Platform"), you <strong>expressly acknowledge and irrevocably agree</strong> that this Platform contains confidential, proprietary, and trade-secret information owned <strong>exclusively and solely</strong> by PRESS START GAMING INC and MADMIXEDMEDIA LLC ("Company", "We", "Us", "Our").</p>
                
                <div style="background:#330000;border:1px solid #660000;border-radius:8px;padding:12px;margin-bottom:20px">
                    <p style="color:#ff4444;text-align:center;font-weight:bold;margin:0;font-size:13px"> IF YOU DO NOT AGREE TO ALL TERMS, YOU MUST EXIT IMMEDIATELY AND NOT ACCESS ANY PART OF THIS PLATFORM </p>
                </div>
                
                <h2> 1. CONFIDENTIAL & PROPRIETARY SYSTEMS</h2>
                <p>This Platform includes, embodies, and incorporates protected intellectual property, including but not limited to:</p>
                <ul>
                    <li>App architecture, system design, and technical infrastructure</li>
                    <li>UI/UX systems, designs, flows, and user experience patterns</li>
                    <li>Feature logic, algorithms, and functional implementations</li>
                    <li>AI workflows, pipelines, prompts, and machine learning systems</li>
                    <li>Automation systems, scripts, and process automations</li>
                    <li>Monetization structures, pricing models, and revenue systems</li>
                    <li>Creator economy systems and marketplace mechanics</li>
                    <li>Educational integrations, curricula, and learning systems</li>
                    <li>Business operations, methods, strategies, and processes</li>
                    <li>Database schemas, data structures, and information architecture</li>
                    <li>API designs, integrations, and technical interfaces</li>
                    <li>Marketing strategies, growth tactics, and user acquisition methods</li>
                    <li>Partnership structures, deal frameworks, and business relationships</li>
                </ul>
                <p>All of the above constitute <strong>confidential trade secrets, proprietary systems, and protected intellectual property</strong> under federal and state law, including the Defend Trade Secrets Act (DTSA), California Uniform Trade Secrets Act (CUTSA), and applicable international IP treaties.</p>
                
                <h2> 2. ABSOLUTE PROHIBITION ON COPYING, CLONING, OR COMPETITIVE USE</h2>
                <p>You <strong>unconditionally and irrevocably agree</strong> that you shall NOT, directly or indirectly, alone or in concert with others, now or at any time in the future:</p>
                <ul>
                    <li>Copy, replicate, reproduce, clone, or imitate this Platform in whole or in part</li>
                    <li>Build, develop, design, or assist in building any competing, similar, or derivative product</li>
                    <li>Reverse engineer, decompile, disassemble, or decode any feature, function, or system</li>
                    <li>Scrape, harvest, extract, or collect any data, content, prompts, or workflows</li>
                    <li>Recreate, replicate, or implement similar monetization systems or business models</li>
                    <li>Extract, utilize, or exploit business logic, methods, or processes for any commercial purpose</li>
                    <li>Share, disclose, transmit, or communicate non-public features with any third party</li>
                    <li>Use any knowledge gained from this Platform to compete with the Company</li>
                    <li>Assist, advise, consult, or enable any third party in any of the above activities</li>
                    <li>Create any work that is substantially similar to or derived from this Platform</li>
                </ul>
                <p>Any such action constitutes <strong>willful misappropriation of trade secrets, unfair competition, breach of contract, and tortious interference</strong>, subjecting you to the maximum penalties available under law.</p>
                
                <h2> 3. NDA-BY-ACCESS (BINDING CONFIDENTIALITY AGREEMENT)</h2>
                <p>By merely accessing, viewing, or interacting with this Platform in any way, you <strong>automatically and immediately enter into a binding, enforceable Non-Disclosure Agreement (NDA)</strong> and confidentiality obligation with the Company. You expressly agree that you will not, under any circumstances:</p>
                <ul>
                    <li>Disclose, reveal, or communicate any non-public features or functionality</li>
                    <li>Share, distribute, or transmit internal workflows or processes</li>
                    <li>Publish, post, or disseminate screenshots, recordings, or descriptions of private tools</li>
                    <li>Reveal, expose, or describe system methods, techniques, or implementations</li>
                    <li>Expose, publish, or discuss backend, automation, or infrastructure logic</li>
                    <li>Discuss confidential information in any public forum, social media, or with competitors</li>
                </ul>
                <p>This confidentiality duty <strong>applies with or without account creation, registration, or payment</strong>, and continues <strong>indefinitely and in perpetuity</strong> even after you cease using the Platform.</p>
                
                <h2> 4. SEVERELY LIMITED LICENSE  NO RIGHTS TO SYSTEMS OR METHODS</h2>
                <p>You are granted an extremely limited, immediately revocable, non-exclusive, non-transferable, personal, view-only and use-only license strictly and solely for:</p>
                <ul>
                    <li>Personal, non-commercial use as an end user</li>
                    <li>Educational participation as authorized by your institution</li>
                    <li>Authorized platform usage in accordance with these terms</li>
                </ul>
                <p><strong>ABSOLUTELY NO LICENSE IS GRANTED</strong> to any source code, algorithms, automation methods, AI systems, pipelines, prompts, business processes, platform architecture, trade secrets, or intellectual property of any kind. <strong>All rights not expressly granted herein are fully, completely, and unconditionally reserved by the Company.</strong></p>
                
                <h2> 5. STRICT RESTRICTIONS ON SCREENSHOTS, RECORDINGS & SHARING</h2>
                <p><strong>You ARE permitted to share:</strong></p>
                <ul>
                    <li>Your own originally created content (comics, cards, covers you make)</li>
                    <li>Public-facing features explicitly designated for sharing</li>
                </ul>
                <p><strong>You are STRICTLY PROHIBITED from sharing:</strong></p>
                <ul>
                    <li>Admin dashboards, control panels, or management interfaces</li>
                    <li>Backend tools, developer features, or internal systems</li>
                    <li>Private workflows, processes, or operational methods</li>
                    <li>Automation logic, AI prompts, or system configurations</li>
                    <li>System architecture, technical documentation, or infrastructure details</li>
                    <li>Pricing strategies, business metrics, or financial information</li>
                    <li>Any unreleased, beta, or non-public features</li>
                </ul>
                <p><strong>Unauthorized disclosure constitutes a material breach of this agreement and actionable trade-secret misappropriation.</strong></p>
                
                <h2> 6. ENFORCEMENT, REMEDIES & LIQUIDATED DAMAGES</h2>
                <p>Any violation of this agreement may result in <strong>immediate and severe consequences</strong>, including but not limited to:</p>
                <ul>
                    <li>Immediate and permanent termination of all access without notice</li>
                    <li>Permanent ban from all Company platforms, products, and services</li>
                    <li>Civil lawsuit seeking compensatory and punitive damages</li>
                    <li>Emergency injunctive and equitable relief</li>
                    <li>Statutory damages under DTSA and CUTSA</li>
                    <li>Liquidated damages of <strong>$50,000 USD minimum per violation</strong></li>
                    <li>Full recovery of attorney fees, court costs, and investigation expenses</li>
                    <li>Criminal referral where applicable under federal and state law</li>
                </ul>
                <p><strong>Exclusive Jurisdiction & Venue:</strong> State and Federal Courts located in the State of California, USA. You irrevocably consent to personal jurisdiction and waive any objection to venue.</p>
                
                <h2> 7. GLOBAL & UNIVERSAL APPLICATION</h2>
                <p>These protections, restrictions, and obligations apply <strong>worldwide, universally, and without exception</strong> across:</p>
                <ul>
                    <li>All websites, domains, and web applications</li>
                    <li>All mobile applications (iOS, Android, and all platforms)</li>
                    <li>All software builds, versions, and releases</li>
                    <li>All educational, classroom, and institutional versions</li>
                    <li>All commercial, enterprise, and professional versions</li>
                    <li>All beta, alpha, preview, and development versions</li>
                    <li>All future products, services, and platforms by the Company</li>
                </ul>
                
                <h2> 8. SEVERABILITY & SURVIVAL</h2>
                <p>If any provision of this agreement is found unenforceable, all other provisions remain in full force and effect. All confidentiality, non-compete, IP protection, and indemnification obligations <strong>survive termination indefinitely</strong>.</p>
                
                <h2> 9. ENTIRE AGREEMENT & MODIFICATIONS</h2>
                <p>This constitutes the entire agreement regarding confidentiality and IP protection. The Company reserves the right to modify these terms at any time; continued use constitutes acceptance of modifications.</p>
            </div>
            <div class="legal-footer">
                <label class="legal-checkbox" style="cursor:pointer">
                    <input type="checkbox" id="legalCheck1">
                    <span><strong>I HAVE READ, UNDERSTOOD, AND AGREE TO BE LEGALLY BOUND BY ALL TERMS ABOVE.</strong> I understand this Platform contains protected intellectual property and trade secrets. I agree not to copy, clone, disclose, compete, or misappropriate any information. I accept NDA-by-access confidentiality obligations. I understand violations may result in severe civil liability, liquidated damages of $50,000+ per violation, and potential criminal prosecution.</span>
                </label>
                <button type="button" class="legal-btn primary" id="legalBtn1" onclick="handleLegal1Click()" style="border:none;background:#fff;color:#000;cursor:pointer"> ENTER  I AGREE TO ALL TERMS</button>
                <button type="button" class="legal-btn secondary" onclick="window.location='https://google.com'" style="cursor:pointer"> EXIT  I DO NOT AGREE</button>
                <p style="font-size:9px;color:#444;text-align:center;margin-top:12px">By clicking "ENTER", you are executing a legally binding contract. Timestamp and acceptance will be recorded.</p>
            </div>
        </div>
    </div>
    
    <!-- LEGAL GATE 2 - USER AGREEMENT & PROMOTIONAL LICENSE -->
    <div id="legalGate2" class="legal-gate hidden">
        <div class="legal-modal">
            <div class="legal-header">
                <div style="font-size:32px;margin-bottom:8px"></div>
                <div class="legal-logo">MASTER USER AGREEMENT</div>
                <div class="legal-subtitle">TERMS OF SERVICE  PROMOTIONAL LICENSE  PRIVACY POLICY</div>
                <div style="font-size:8px;color:#333;margin-top:4px">PRESS START GAMING INC  MADMIXEDMEDIA LLC</div>
            </div>
            <div class="legal-body">
                <p style="color:#fff;font-size:13px;text-align:center;margin-bottom:20px">This legally binding agreement applies to ALL PSCoMiXX, Press Start, and MADMixedMedia platforms, products, and services (web, mobile, desktop, and all future platforms).</p>
                
                <h2> 1. USER CONTENT OWNERSHIP & REPRESENTATIONS</h2>
                <p>You retain ownership of original content you create using this Platform. However, by creating and uploading content, <strong>you represent and warrant</strong> that:</p>
                <ul>
                    <li>You own or have all necessary rights, licenses, and permissions to the content</li>
                    <li>Your content does not infringe any third-party intellectual property rights</li>
                    <li>Your content does not violate any applicable laws or regulations</li>
                    <li>You have obtained all necessary releases from any identifiable individuals</li>
                    <li>You are solely responsible for any claims arising from your content</li>
                </ul>
                
                <h2> 2. COMPREHENSIVE PROMOTIONAL & MEDIA LICENSE GRANT</h2>
                <p>By uploading, creating, posting, or transmitting any content to this Platform, you hereby <strong>irrevocably grant</strong> to PRESS START GAMING INC, MADMIXEDMEDIA LLC, and their affiliates, successors, assigns, licensees, and sublicensees a:</p>
                <p style="background:#111;padding:12px;border-radius:8px;color:#fff;font-weight:bold;text-align:center">PERPETUAL  WORLDWIDE  ROYALTY-FREE  FULLY TRANSFERABLE  FREELY SUBLICENSABLE  IRREVOCABLE LICENSE</p>
                <p>To use your content in any manner whatsoever, including but not limited to the rights to:</p>
                <ul>
                    <li>Host, store, cache, backup, and archive</li>
                    <li>Reproduce, copy, duplicate, and replicate</li>
                    <li>Modify, adapt, edit, alter, transform, and create derivative works</li>
                    <li>Display, exhibit, perform, publish, and broadcast</li>
                    <li>Advertise, market, promote, and publicize</li>
                    <li>Distribute, transmit, stream, and disseminate</li>
                    <li>Sell, license, sublicense, and commercialize</li>
                    <li>Create previews, excerpts, compilations, and promotional materials</li>
                    <li>Use in any media format or technology now known or hereafter developed</li>
                </ul>
                <p><strong>Authorized distribution channels include (without limitation):</strong></p>
                <ul>
                    <li>All social media platforms (Instagram, TikTok, YouTube, Facebook, X/Twitter, LinkedIn, etc.)</li>
                    <li>Paid advertisements, sponsored content, and promotional campaigns</li>
                    <li>Company websites, apps, products, and services</li>
                    <li>Press releases, news articles, media coverage, and publicity</li>
                    <li>Films, videos, documentaries, and multimedia productions</li>
                    <li>Investor presentations, pitch decks, and fundraising materials</li>
                    <li>Sponsor communications, partnership materials, and B2B marketing</li>
                    <li>Educational programs, curricula, training materials, and academic publications</li>
                    <li>Trade shows, festivals, exhibitions, conferences, and live events</li>
                    <li>App stores, marketplaces, and distribution platforms</li>
                    <li>Print materials, merchandise, physical products, and packaging</li>
                    <li>NFTs, digital collectibles, and blockchain-based applications</li>
                </ul>
                
                <h2> 3. WAIVER OF COMPENSATION & MORAL RIGHTS</h2>
                <p><strong>You expressly and irrevocably waive any and all rights to:</strong></p>
                <ul>
                    <li>Compensation, payment, royalties, or revenue sharing of any kind</li>
                    <li>Prior notice, approval, or consent for any use of your content</li>
                    <li>Attribution or credit (unless separately agreed in writing)</li>
                    <li>Any "moral rights" or similar rights under any jurisdiction</li>
                    <li>Privacy or publicity claims arising from authorized use</li>
                </ul>
                <p style="background:#1a1a00;border:1px solid #333300;padding:10px;border-radius:6px;color:#ffff99;font-size:11px">
                    <strong> IMPORTANT:</strong> This license SURVIVES account deletion, termination, or discontinuation of use. This license applies equally to FREE users, PAID users, EDUCATIONAL users, and COMMERCIAL users.
                </p>
                
                <h2> 4. AI-GENERATED CONTENT DISCLOSURE & DISCLAIMER</h2>
                <p>This Platform may utilize artificial intelligence and machine learning technologies. You acknowledge and agree that:</p>
                <ul>
                    <li>AI-generated output may not be unique, original, or exclusive</li>
                    <li>Similar or identical AI output may be provided to other users</li>
                    <li>You assume <strong>all responsibility</strong> for publishing, distributing, or commercializing AI content</li>
                    <li>The Company makes no representations regarding copyright ownership of AI output</li>
                    <li>The Company <strong>disclaims all liability</strong> for any copyright, trademark, or IP disputes arising from AI content</li>
                    <li>You will defend and indemnify the Company against any AI-related IP claims</li>
                </ul>
                
                <h2> 5. MONETIZATION, PAYMENTS & FINANCIAL TERMS</h2>
                <ul>
                    <li>Creators are solely responsible for all applicable taxes, duties, and government charges</li>
                    <li>Platform fees, commissions, and transaction costs may apply to certain features</li>
                    <li>No specific revenue, income, or earnings is represented, warranted, or guaranteed</li>
                    <li>Payment terms, thresholds, and methods are subject to change at Company's discretion</li>
                    <li>The Company reserves the right to suspend payments pending investigation of violations</li>
                </ul>
                
                <h2> 6. PRINTING, MERCHANDISE & PHYSICAL PRODUCTS</h2>
                <p>If you utilize any print-on-demand, merchandise, or physical product features:</p>
                <ul>
                    <li>You represent and warrant that you own all rights to printed/produced content</li>
                    <li>You are solely responsible for any third-party IP claims related to physical products</li>
                    <li>The Company is not liable for print quality, shipping, fulfillment, or third-party vendor errors</li>
                    <li>Returns, refunds, and disputes are subject to applicable vendor policies</li>
                </ul>
                
                <h2> 7. EDUCATIONAL USE & MINOR USERS</h2>
                <ul>
                    <li>Teachers, administrators, and institutions are responsible for managing student access and conduct</li>
                    <li>Parents and legal guardians must provide consent for users under 18 years of age</li>
                    <li>Educational institutions represent they have authority to bind students to these terms</li>
                    <li><strong>Student-created content remains subject to the full Promotional License granted above</strong></li>
                    <li>The Company may feature student work in educational showcases, marketing, and promotional materials</li>
                    <li>COPPA, FERPA, and other educational privacy laws are the responsibility of the educational institution</li>
                </ul>
                
                <h2> 8. STRICTLY PROHIBITED CONTENT & CONDUCT</h2>
                <p>The following is <strong>absolutely prohibited</strong> and will result in immediate termination and potential legal action:</p>
                <ul>
                    <li>Hate speech, harassment, bullying, discrimination, or threats of violence</li>
                    <li>Child sexual abuse material (CSAM), child exploitation, or endangerment of minors</li>
                    <li>Terrorism, extremism, radicalization, or incitement to violence</li>
                    <li>Malware, viruses, hacking tools, or malicious code</li>
                    <li>Non-consensual deepfakes, revenge porn, or intimate imagery</li>
                    <li>Copyright infringement, trademark violations, or IP theft</li>
                    <li>Fraud, scams, phishing, or deceptive practices</li>
                    <li>Illegal drug content, weapons trafficking, or criminal activity</li>
                    <li>Spam, unauthorized advertising, or platform manipulation</li>
                </ul>
                
                <h2> 9. COMPREHENSIVE DISCLAIMER OF WARRANTIES</h2>
                <p style="background:#111;padding:12px;border-radius:8px;color:#ff9999;font-size:11px">
                    THE PLATFORM IS PROVIDED STRICTLY "AS IS" AND "AS AVAILABLE" WITHOUT ANY WARRANTIES OF ANY KIND, EXPRESS OR IMPLIED. THE COMPANY EXPRESSLY DISCLAIMS ALL WARRANTIES INCLUDING, WITHOUT LIMITATION, IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, TITLE, NON-INFRINGEMENT, ACCURACY, RELIABILITY, AVAILABILITY, SECURITY, AND ANY WARRANTIES ARISING FROM COURSE OF DEALING OR USAGE OF TRADE. USE OF THIS PLATFORM IS ENTIRELY AT YOUR OWN RISK.
                </p>
                
                <h2> 10. LIMITATION OF LIABILITY</h2>
                <p style="background:#111;padding:12px;border-radius:8px;color:#ffcc99;font-size:11px">
                    TO THE MAXIMUM EXTENT PERMITTED BY LAW, IN NO EVENT SHALL THE COMPANY, ITS OFFICERS, DIRECTORS, EMPLOYEES, AGENTS, AFFILIATES, OR LICENSORS BE LIABLE FOR ANY INDIRECT, INCIDENTAL, SPECIAL, CONSEQUENTIAL, PUNITIVE, OR EXEMPLARY DAMAGES, INCLUDING WITHOUT LIMITATION DAMAGES FOR LOSS OF PROFITS, GOODWILL, DATA, OR OTHER INTANGIBLE LOSSES, REGARDLESS OF WHETHER SUCH DAMAGES WERE FORESEEABLE OR WHETHER THE COMPANY WAS ADVISED OF THE POSSIBILITY THEREOF. THE COMPANY'S TOTAL AGGREGATE LIABILITY SHALL NOT EXCEED THE GREATER OF $100 USD OR THE AMOUNT YOU PAID TO THE COMPANY IN THE PAST 12 MONTHS.
                </p>
                
                <h2> 11. INDEMNIFICATION & HOLD HARMLESS</h2>
                <p>You agree to <strong>unconditionally defend, indemnify, and hold harmless</strong> the Company, its officers, directors, employees, agents, affiliates, successors, and assigns from and against any and all claims, damages, obligations, losses, liabilities, costs, debt, and expenses (including but not limited to attorney's fees) arising from:</p>
                <ul>
                    <li>Your use of the Platform or any content you create, upload, or distribute</li>
                    <li>Your violation of these terms or any applicable law</li>
                    <li>Your violation of any third-party rights, including IP rights</li>
                    <li>Any claim that your content caused damage to a third party</li>
                </ul>
                
                <h2> 12. GOVERNING LAW, JURISDICTION & DISPUTE RESOLUTION</h2>
                <ul>
                    <li><strong>Governing Law:</strong> State of California, USA (without regard to conflict of law principles)</li>
                    <li><strong>Exclusive Jurisdiction:</strong> State and Federal courts located in California</li>
                    <li><strong>Mandatory Arbitration:</strong> Disputes shall first be submitted to binding arbitration under AAA rules</li>
                    <li><strong>Class Action Waiver:</strong> You waive any right to participate in class action lawsuits</li>
                    <li><strong>Jury Trial Waiver:</strong> You waive any right to a jury trial</li>
                </ul>
                
                <h2> 13. PRIVACY POLICY SUMMARY</h2>
                <p><strong>Data We Collect:</strong> Account information, usage analytics, device information, content you create, and interaction data.</p>
                <p><strong>How We Use Data:</strong> To provide services, improve the Platform, personalize experience, send communications, and for marketing purposes.</p>
                <p><strong>Data Sharing:</strong> We may share data with service providers, business partners, and as required by law. We do NOT sell personal data to third-party data brokers.</p>
                <p><strong>Data Retention:</strong> We retain data as long as necessary for business purposes and legal compliance.</p>
                <p><strong>Your Rights:</strong> You may request access, correction, or deletion of personal data subject to legal limitations.</p>
                <p> <strong>Data & Privacy Requests:</strong> <span style="color:#fff"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="bad7d5d0d5d9c8dfdbced3ccdf8bfaddd7dbd3d694d9d5d7">[email&#160;protected]</a></span></p>
                
                <h2> 14. GENERAL PROVISIONS</h2>
                <ul>
                    <li><strong>Entire Agreement:</strong> This constitutes the entire agreement between you and the Company</li>
                    <li><strong>Severability:</strong> If any provision is unenforceable, remaining provisions continue in effect</li>
                    <li><strong>Waiver:</strong> Failure to enforce any right does not constitute waiver</li>
                    <li><strong>Assignment:</strong> You may not assign your rights; Company may freely assign</li>
                    <li><strong>Modifications:</strong> Company reserves the right to modify terms at any time; continued use constitutes acceptance</li>
                    <li><strong>Survival:</strong> Provisions regarding IP, indemnification, limitations, and dispute resolution survive termination</li>
                </ul>
            </div>
            <div class="legal-footer">
                <label class="legal-checkbox" style="cursor:pointer">
                    <input type="checkbox" id="legalCheck2">
                    <span><strong>I HAVE READ, UNDERSTOOD, AND AGREE TO BE LEGALLY BOUND BY THE COMPLETE USER AGREEMENT, TERMS OF SERVICE, PROMOTIONAL LICENSE, AND PRIVACY POLICY.</strong> I grant the perpetual, worldwide, royalty-free promotional license described above. I understand my content may be used for any promotional, commercial, or marketing purpose worldwide without compensation. I waive any claims to moral rights, prior approval, or attribution. I accept mandatory arbitration and waive class action rights.</span>
                </label>
                <button type="button" class="legal-btn primary" id="legalBtn2" onclick="handleLegal2Click()" style="border:none;background:#fff;color:#000;cursor:pointer"> ACCEPT ALL TERMS & CONTINUE</button>
                <button type="button" class="legal-btn secondary" onclick="window.location='https://google.com'" style="cursor:pointer"> DECLINE & EXIT</button>
                <p style="font-size:9px;color:#444;text-align:center;margin-top:12px">By clicking "ACCEPT", you are executing a legally binding contract. Your acceptance, timestamp, and device information will be recorded for legal compliance.</p>
            </div>
        </div>
    </div>
    
    <input type="file" id="fileInput" accept="image/*,video/*" style="display:none" onchange="handleFile(event)">
    <div class="app" id="app"></div>
    <canvas id="exportCanvas"></canvas>
    
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    // ============ GLOBAL ERROR HANDLER ============
    window.onerror = function(msg, url, lineNo, columnNo, error) {
        console.error('Global error:', msg, 'at line', lineNo);
        // Don't let errors crash the app
        return true;
    };
    
    window.addEventListener('unhandledrejection', function(event) {
        console.error('Unhandled promise rejection:', event.reason);
        event.preventDefault();
    });
    
    // ============ COMPREHENSIVE iOS STABILITY SYSTEM ============
    (function() {
        var isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
        var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        
        if (isIOS) {
            // ========== iOS-SPECIFIC PERFORMANCE FIXES ==========
            
            // 1. Limit animation frame rate to ~30fps on iOS to reduce GPU pressure
            var originalRequestAnimationFrame = window.requestAnimationFrame;
            var lastTime = 0;
            window.requestAnimationFrame = function(callback) {
                var now = Date.now();
                if (now - lastTime < 33) { // ~30fps limit
                    return setTimeout(function() { callback(now); }, 33);
                }
                lastTime = now;
                return originalRequestAnimationFrame.call(window, callback);
            };
            
            // 2. Aggressive interval cleanup on visibility change
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    // Clear ALL intervals and timeouts (nuclear option for memory cleanup)
                    var highestId = window.setTimeout(function() {}, 0);
                    for (var i = 0; i < highestId; i++) {
                        window.clearInterval(i);
                        window.clearTimeout(i);
                    }
                    
                    // Clear known app intervals
                    if (window.drawAnimInterval) { clearInterval(window.drawAnimInterval); window.drawAnimInterval = null; }
                    if (window.panelAnimIntervals) { 
                        Object.keys(window.panelAnimIntervals).forEach(function(k) { 
                            clearInterval(window.panelAnimIntervals[k]); 
                        }); 
                        window.panelAnimIntervals = {}; 
                    }
                    if (window.gifInterval) { clearInterval(window.gifInterval); window.gifInterval = null; }
                    window.drawAnimRunning = false;
                    
                    // Force garbage collection hint
                    if (window.gc) window.gc();
                }
            });
            
            // 3. Handle orientation changes gracefully - simplified
            var orientationDebounce = null;
            
            window.addEventListener('resize', function() {
                if (orientationDebounce) clearTimeout(orientationDebounce);
                
                // Stop animations during resize
                if (window.drawAnimInterval) { clearInterval(window.drawAnimInterval); window.drawAnimInterval = null; }
                window.drawAnimRunning = false;
                
                // Debounced re-render after resize settles
                orientationDebounce = setTimeout(function() {
                    try { render(); } catch(e) { console.warn('Resize render:', e); }
                }, 400);
            });
            
            window.addEventListener('orientationchange', function() {
                if (orientationDebounce) clearTimeout(orientationDebounce);
                
                if (window.drawAnimInterval) { clearInterval(window.drawAnimInterval); window.drawAnimInterval = null; }
                window.drawAnimRunning = false;
                
                orientationDebounce = setTimeout(function() {
                    try { render(); } catch(e) { console.warn('Orientation render:', e); }
                }, 600);
            });
            
            // 4. Prevent multi-touch conflicts (more than 2 fingers)
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length > 2) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // 5. Mark body for iOS performance mode
            window.addEventListener('load', function() {
                document.body.classList.add('ios-performance-mode');
            });
        }
        
        if (isMobile) {
            // ========== UNIFIED TOUCH HANDLER SYSTEM ==========
            var activeTouches = new Map();
            
            // Track all touches to prevent conflicts
            document.addEventListener('touchstart', function(e) {
                Array.from(e.touches).forEach(function(touch) {
                    activeTouches.set(touch.identifier, {
                        x: touch.clientX,
                        y: touch.clientY,
                        target: e.target,
                        timestamp: Date.now()
                    });
                });
            }, { passive: true });
            
            document.addEventListener('touchend', function(e) {
                Array.from(e.changedTouches).forEach(function(touch) {
                    activeTouches.delete(touch.identifier);
                });
                
                // Clear if no touches left
                if (activeTouches.size === 0) {
                    setTimeout(function() { activeTouches.clear(); }, 100);
                }
            }, { passive: true });
            
            // Clear all animation intervals helper
            var clearAllIntervals = function() {
                if (window.drawAnimInterval) { clearInterval(window.drawAnimInterval); window.drawAnimInterval = null; }
                if (window.panelAnimIntervals) { 
                    Object.keys(window.panelAnimIntervals).forEach(function(k) { 
                        clearInterval(window.panelAnimIntervals[k]); 
                    }); 
                    window.panelAnimIntervals = {}; 
                }
                if (window.gifInterval) { clearInterval(window.gifInterval); window.gifInterval = null; }
                window.drawAnimRunning = false;
            };
            
            // Stop intervals when page hidden
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) clearAllIntervals();
            });
            
            // Mobile resize is handled by the unified handler above
        }
    })();
    
    // ============ LEGAL GATE SYSTEM ============
    // Version tracking for re-acceptance on updates
    const LEGAL_VERSION = '1.0.0';
    const LEGAL_VERSION_KEY = 'pscomixx_legal_version';
    
    // Check if legal acceptance is valid
    function checkLegalAcceptance() {
        const accepted = localStorage.getItem('pscomixx_legal_full_accepted') === 'true';
        const version = localStorage.getItem(LEGAL_VERSION_KEY);
        
        // Require re-acceptance if version changed
        if (accepted && version === LEGAL_VERSION) {
            document.getElementById('legalGate1').classList.add('hidden');
            document.getElementById('legalGate2').classList.add('hidden');
            return true;
        }
        return false;
    }
    
    // Checkbox enable/disable for buttons
    document.addEventListener('DOMContentLoaded', function() {
        const check1 = document.getElementById('legalCheck1');
        const btn1 = document.getElementById('legalBtn1');
        const check2 = document.getElementById('legalCheck2');
        const btn2 = document.getElementById('legalBtn2');
        
        if (check1 && btn1) {
            check1.addEventListener('change', function() {
                btn1.disabled = !this.checked;
            });
        }
        
        if (check2 && btn2) {
            check2.addEventListener('change', function() {
                btn2.disabled = !this.checked;
            });
        }
        
        // Check if already accepted
        checkLegalAcceptance();
    });
    
    // Accept first gate (NDA/IP)
    function acceptLegalGate1() {
        const timestamp = new Date().toISOString();
        const acceptanceData = {
            type: 'NDA_IP_AGREEMENT',
            version: LEGAL_VERSION,
            timestamp: timestamp,
            userAgent: navigator.userAgent,
            language: navigator.language,
            platform: navigator.platform,
            screenRes: window.screen.width + 'x' + window.screen.height,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
        };
        
        localStorage.setItem('pscomixx_nda_accepted', 'true');
        localStorage.setItem('pscomixx_nda_timestamp', timestamp);
        localStorage.setItem('pscomixx_nda_data', JSON.stringify(acceptanceData));
        
        // Log acceptance (for records)
        
        
        
        // Show second gate
        document.getElementById('legalGate1').classList.add('hidden');
        document.getElementById('legalGate2').classList.remove('hidden');
    }
    
    // Accept second gate (User Agreement)
    function acceptLegalGate2() {
        const timestamp = new Date().toISOString();
        const acceptanceData = {
            type: 'USER_AGREEMENT_PROMO_LICENSE',
            version: LEGAL_VERSION,
            timestamp: timestamp,
            userAgent: navigator.userAgent,
            language: navigator.language,
            platform: navigator.platform,
            screenRes: window.screen.width + 'x' + window.screen.height,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            ndaAcceptedAt: localStorage.getItem('pscomixx_nda_timestamp')
        };
        
        localStorage.setItem('pscomixx_terms_accepted', 'true');
        localStorage.setItem('pscomixx_terms_timestamp', timestamp);
        localStorage.setItem('pscomixx_terms_data', JSON.stringify(acceptanceData));
        localStorage.setItem('pscomixx_legal_full_accepted', 'true');
        localStorage.setItem('pscomixx_legal_accepted', 'true');
        localStorage.setItem('pscomixx_legal_timestamp', timestamp);
        localStorage.setItem(LEGAL_VERSION_KEY, LEGAL_VERSION);
        
        // Log acceptance
        
        
        
        
        // Hide gate and show app
        document.getElementById('legalGate2').classList.add('hidden');
        
        // Update state
        if (typeof S !== 'undefined') {
            S.legalAccepted = true;
            S.legalAcceptedAt = timestamp;
        }
    }
    
    // Function to reset legal acceptance (for testing or updates)
    function resetLegalAcceptance() {
        localStorage.removeItem('pscomixx_nda_accepted');
        localStorage.removeItem('pscomixx_nda_timestamp');
        localStorage.removeItem('pscomixx_terms_accepted');
        localStorage.removeItem('pscomixx_terms_timestamp');
        localStorage.removeItem('pscomixx_legal_full_accepted');
        localStorage.removeItem('pscomixx_legal_accepted');
        localStorage.removeItem('pscomixx_legal_timestamp');
        localStorage.removeItem(LEGAL_VERSION_KEY);
        location.reload();
    }
    // ============================================
    
    // Setup file input handler once on load
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('fileInput').addEventListener('change', handleFile);
    });
    
    const S = {
        // SUBSCRIPTION & PREMIUM SYSTEM
        userTier: localStorage.getItem('pscomixx_tier') || 'free', // free, plus, pro, classroom
        tierExpiry: localStorage.getItem('pscomixx_tier_expiry') || null,
        exportsToday: parseInt(localStorage.getItem('pscomixx_exports_today') || '0'),
        exportsDate: localStorage.getItem('pscomixx_exports_date') || new Date().toDateString(),
        aiGensThisMonth: parseInt(localStorage.getItem('pscomixx_ai_gens_month') || '0'),
        aiGensMonth: localStorage.getItem('pscomixx_ai_gens_month_date') || new Date().getMonth().toString(),
        
        // ADMIN FEATURE TOGGLES (saved to localStorage)
        adminConfig: JSON.parse(localStorage.getItem('pscomixx_admin_config') || JSON.stringify({
            watermarksEnabled: true,        // Add watermark to free tier exports
            exportLimitsEnabled: true,      // Enforce daily export limits
            premiumFeaturesLocked: true,    // Lock premium features for free tier
            classroomMode: false,           // Unlock all features (for classroom)
            aiLimitsEnabled: true,          // Enforce AI generation limits
            showUpgradePrompts: true,       // Show upgrade modals
            maintenanceMode: false,         // Disable app for maintenance
            debugMode: false                // Show debug info
        })),
        
        // TIER LIMITS
        TIER_LIMITS: {
            free: { exports: 3, aiGens: 0, cloudSaves: 5, watermark: true },
            plus: { exports: 10, aiGens: 10, cloudSaves: 50, watermark: false },
            pro: { exports: 999, aiGens: 999, cloudSaves: 999, watermark: false },
            classroom: { exports: 999, aiGens: 50, cloudSaves: 100, watermark: false }
        },
        
        // LEGAL & ONBOARDING
        legalAccepted: localStorage.getItem('pscomixx_legal_accepted') === 'true',
        legalAcceptedAt: localStorage.getItem('pscomixx_legal_timestamp') || null,
        userAge: localStorage.getItem('pscomixx_user_age') || null,
        parentalConsent: localStorage.getItem('pscomixx_parental_consent') === 'true',
        isSchoolAccount: localStorage.getItem('pscomixx_school_account') === 'true',
        creatorToggles: JSON.parse(localStorage.getItem('pscomixx_creator_toggles') || '{"socialMedia":true,"promoAds":true,"festival":true,"sponsors":true}'),
        
        // AI IMAGE LAB - Model Selection
        aiModel: localStorage.getItem('pscomixx_ai_model') || 'pollinations',
        aiLabOpen: false,
        aiPrompt: '',
        aiGenerating: false,
        aiGeneratedImage: null,
        
        // AI Model Definitions
        AI_MODELS: {
            'flux': {
                name: 'Flow Studio',
                engine: 'FLUX.1-schnell',
                icon: '',
                description: 'High-quality and smooth. Creates polished comic art with natural flow, clean shading, and cinematic lighting.',
                bestFor: 'Comic covers, hero shots, key art, vibrant backgrounds',
                styleTip: 'Add detail + lighting cues: "Clean 2D comic art, dramatic shadows, bold outlines, dynamic pose"',
                endpoint: 'https://image.pollinations.ai/prompt/{prompt}?model=flux&width=512&height=512&nologo=true'
            },
            'pollinations': {
                name: 'Classic Freestyle',
                engine: 'Pollinations',
                icon: '',
                description: 'Fast, loose, imaginative. Soft, dreamy, stylized looks perfect for experimenting.',
                bestFor: 'Backgrounds, quick character tests, dream panels, fast drafts',
                styleTip: 'Be casual and expressive: "Trippy neon comic city, glitch graffiti, surreal atmosphere"',
                endpoint: 'https://image.pollinations.ai/prompt/{prompt}?width=512&height=512&nologo=true'
            },
            'anime': {
                name: 'Anime Studio',
                engine: 'Pony Diffusion',
                icon: '',
                description: 'Bright anime look with consistent characters. Expressive eyes, smooth shading, stable output.',
                bestFor: 'Manga-style pages, anime characters, cute mascots, bright scenes',
                styleTip: 'Keep prompts short + vibe-focused: "Anime hero, sharp cel shading, expressive eyes"',
                endpoint: 'https://image.pollinations.ai/prompt/{prompt},anime style,cel shading?width=512&height=512&nologo=true'
            },
            'comic': {
                name: 'Comic LineLab',
                engine: 'SDXL Comic',
                icon: '',
                description: 'Pure comic book look. Thick lines, flat colors, inking consistency, stylized shadows.',
                bestFor: 'Traditional comic pages, consistent characters, retro/modern comic style',
                styleTip: 'Mention line weight + flat color: "Thick black ink lines, flat colors, 90s comic style"',
                endpoint: 'https://image.pollinations.ai/prompt/{prompt},comic book style,thick ink lines,flat colors?width=512&height=512&nologo=true'
            },
            'sketch': {
                name: 'Sketch Mode',
                engine: 'Turbo',
                icon: '',
                description: 'INSANELY fast. Great for quick roughs, silhouettes, and layout ideas.',
                bestFor: 'Panel planning, silhouette blocking, pose ideas, storyboard thumbnails',
                styleTip: 'Keep it simple: "Rough comic sketch, simple lines, storyboard frame"',
                endpoint: 'https://image.pollinations.ai/prompt/{prompt},sketch,rough lines,storyboard?width=512&height=512&nologo=true'
            },
            'painterly': {
                name: 'Style Blender',
                engine: 'Kandinsky',
                icon: '',
                description: 'Painterly + abstract. Softer gradients, emotional scenes, fantasy landscapes.',
                bestFor: 'Emotional scenes, magic/dream sequences, painterly backgrounds',
                styleTip: 'Describe mood, not detail: "Misty blue forest, soft brush strokes, dreamy lighting"',
                endpoint: 'https://image.pollinations.ai/prompt/{prompt},painterly,soft gradients,atmospheric?width=512&height=512&nologo=true'
            },
            'consistent': {
                name: 'Character Lock',
                engine: 'SDXL LoRA',
                icon: '',
                description: 'Same character every time. Consistent faces across pages for long-form comics.',
                bestFor: 'Series characters, repeat panels, identity consistency, visual novels',
                styleTip: 'Add character details: "consistent character, comic pose, clean lines, waist-up shot"',
                endpoint: 'https://image.pollinations.ai/prompt/{prompt},consistent character design,same face?width=512&height=512&nologo=true'
            },
            'toon': {
                name: 'Retro Toon',
                engine: 'SD Cartoon',
                icon: '',
                description: 'Saturday-morning-cartoon style. Thick outlines, bright flat colors, expressive shapes.',
                bestFor: 'Humor comics, kids book-style panels, cartoon characters',
                styleTip: 'Keep it playful: "Bright cartoon, exaggerated shapes, thick outlines, playful energy"',
                endpoint: 'https://image.pollinations.ai/prompt/{prompt},cartoon style,thick outlines,bright colors,playful?width=512&height=512&nologo=true'
            }
        },
        
        activeTab: 'comic',
        activeSheet: null,
        sidebarOpen: false,
        lightMode: false,
        zoom: 100,
        toast: null,
        pages: [createPage()],
        currentPage: 0,
        selectedPanel: null,
        selectedElement: null,
        editModal: null,
        editText: '',
        pendingBubble: null,
        pendingEffect: null,
        effectColor: '#ff0000',
        emojiCat: 0, // emoji category tab
        effectCat: 0, // effect category tab
        loading: false,
        savePreview: null,
        saveHelp: null,
        upgradeModal: null, // { show: true, feature: 'exports'|'ai'|'premium' }
        cardFlipped: false,
        coverFlipped: false,
        previewMode: false,
        previewPage: 0,
        readerLayout: 'horizontal', // 'horizontal' (tap) or 'vertical' (scroll)
        readerUIVisible: true,
        // Media Editor (PS Express style)
        mediaEditor: null, // { type: 'panel'|'card-front'|'card-back'|'cover-front'|'cover-back', index: number, src: string, scale: 1, rotation: 0, offsetX: 0, offsetY: 0 }
        // Share tab properties
        shareTitle: '',
        creatorName: '',
        shareDesc: '',
        publishSuccess: null,
        // Drawing mode properties
        drawMode: false,
        drawTool: 'pen', // pen, marker, eraser
        drawColor: '#000000',
        drawSize: 4, // brush size
        drawHistory: [], // for undo
        drawRedoStack: [], // for redo
        drawFrameIndex: 0,
        drawFPS: 12,
        onionSkin: true, // Auto onion skin like FlipaClip
        animPlaying: false,
        drawUIHidden: false, // FlipaClip hide UI toggle
        copiedFrame: null, // Reserved for future use
        drawPanelIndex: null, // null = full page, number = specific panel
        // Animation properties
        animateMode: false,
        animatePreview: false,
        animatePlaying: false,
        pageTransition: 'fade', // fade, slide-left, slide-right, flip, zoom
        previewTransClass: '',
        // UNIFIED STUDIO MODE
        studioMode: false,
        studioPanel: null, // which panel is being edited (null = full page)
        studioTab: 'draw', // draw, animate, transform
        studioFrameIndex: 0,
        studioFPS: 12,
        studioOnionSkin: false,
        studioPlaying: false,
        
        // ========== PRESS START ECOSYSTEM ==========
        
        // AUTHENTICATION
        isSignedIn: false,
        playerName: localStorage.getItem('pscomixx_player_name') || '',
        playerEmail: null,
        playerPhoto: null,
        
        // USER PROFILE
        user: {
            id: 'user_' + Date.now(),
            name: 'New Player',
            handle: '@player',
            avatar: null,
            credits: 50, // Starting credits
            xp: 0,
            level: 1,
            joinDate: new Date().toISOString(),
            isTeacher: false,
            classCode: null
        },
        
        // CARD COLLECTION
        cardCollection: [],
        activeCardIndex: 0, // Which card is being edited
        lockedCardId: null, // One card can be protected from battles
        
        // CREDITS ECONOMY
        CREDIT_REWARDS: {
            'read_comic': 5,
            'rate_comic': 10,
            'create_comic': 25,
            'share_comic': 15,
            'viral_comic': 50, // 100+ views
            'complete_chapter': 100,
            'win_battle': 5,
            'win_battle_keeps': 25,
            'daily_login': 10,
            'first_card': 50,
            'teacher_bonus': 0 // Variable
        },
        
        // RARITY UPGRADE COSTS
        RARITY_COSTS: {
            'UNCOMMON': 100,
            'RARE': 250,
            'EPIC': 500,
            'LEGENDARY': 1000,
            'MYTHIC': 2500
        },
        
        // BATTLE SYSTEM
        battleMode: false,
        battleType: 'friendly', // friendly, ranked, keeps
        battleOpponent: null,
        battleResult: null,
        battleHistory: [],
        battleRecord: { wins: 0, losses: 0 },
        battleWageredCard: null,
        battleOpponentCard: null,
        
        // COMIC FEED (simulated for demo)
        comicFeed: [
            { id: 1, title: 'Space Adventure', creator: '@cosmic_kid', views: 234, likes: 45, thumbnail: null },
            { id: 2, title: 'Ninja School', creator: '@shadow_master', views: 189, likes: 38, thumbnail: null },
            { id: 3, title: 'Robot Friends', creator: '@tech_wizard', views: 156, likes: 29, thumbnail: null },
            { id: 4, title: 'Dragon Quest', creator: '@fire_breather', views: 312, likes: 67, thumbnail: null },
            { id: 5, title: 'Super Squad', creator: '@hero_maker', views: 278, likes: 52, thumbnail: null }
        ],
        
        // LEADERBOARD
        leaderboard: [
            { rank: 1, name: 'DragonMaster', handle: '@dragon_m', credits: 4250, rarity: 'MYTHIC', wins: 89 },
            { rank: 2, name: 'NinjaQueen', handle: '@ninja_q', credits: 3800, rarity: 'LEGENDARY', wins: 76 },
            { rank: 3, name: 'CosmicKid', handle: '@cosmic_k', credits: 3200, rarity: 'LEGENDARY', wins: 64 },
            { rank: 4, name: 'TechWizard', handle: '@tech_w', credits: 2900, rarity: 'EPIC', wins: 58 },
            { rank: 5, name: 'FireBreather', handle: '@fire_b', credits: 2400, rarity: 'EPIC', wins: 45 }
        ],
        
        // BOOK PROGRESS (Press Start chapters)
        bookProgress: {
            chapters: [
                { id: 1, title: 'Press Start: Begin Your Journey', completed: false, reward: 100 },
                { id: 2, title: 'Level Up Your Mindset', completed: false, reward: 100 },
                { id: 3, title: 'Building Your Character', completed: false, reward: 100 },
                { id: 4, title: 'The Power of XP', completed: false, reward: 150 },
                { id: 5, title: 'Boss Battles in Life', completed: false, reward: 150 },
                { id: 6, title: 'Finding Your Guild', completed: false, reward: 150 },
                { id: 7, title: 'Side Quests Matter', completed: false, reward: 200 },
                { id: 8, title: 'Respawn: Learning from Failure', completed: false, reward: 200 },
                { id: 9, title: 'Multiplayer Mode', completed: false, reward: 200 },
                { id: 10, title: 'The Final Boss', completed: false, reward: 300 },
                { id: 11, title: 'New Game+', completed: false, reward: 500 },
                { id: 12, title: 'Becoming the Hero', completed: false, reward: 500 }
            ],
            totalEarned: 0
        },
        
        // TEACHER DASHBOARD
        teacherMode: false,
        classroom: {
            code: 'PRESS' + Math.random().toString(36).substring(2, 6).toUpperCase(),
            name: 'My Classroom',
            students: [
                { id: 1, name: 'Alex Johnson', credits: 450, rarity: 'RARE', comicsCreated: 8, comicsRead: 24 },
                { id: 2, name: 'Sam Williams', credits: 320, rarity: 'UNCOMMON', comicsCreated: 5, comicsRead: 18 },
                { id: 3, name: 'Jordan Lee', credits: 680, rarity: 'EPIC', comicsCreated: 12, comicsRead: 35 },
                { id: 4, name: 'Taylor Brown', credits: 210, rarity: 'COMMON', comicsCreated: 3, comicsRead: 12 },
                { id: 5, name: 'Morgan Davis', credits: 890, rarity: 'LEGENDARY', comicsCreated: 15, comicsRead: 48 }
            ],
            challenges: [
                { id: 1, title: 'First to EPIC!', reward: 200, deadline: '2025-02-01', winner: null },
                { id: 2, title: 'Create 5 Comics', reward: 150, deadline: '2025-01-20', winner: 'Jordan Lee' }
            ],
            settings: {
                allowKeepsBattles: false,
                requireBattleApproval: true,
                battleHoursOnly: true,
                battleHoursStart: '12:00',
                battleHoursEnd: '13:00'
            }
        },
        
        // UI STATE FOR NEW SCREENS
        activeScreen: null, // 'collection', 'feed', 'leaderboard', 'progress', 'teacher', 'profile'
        
        // ========== CARD ENGINE CONFIG ==========
        
        // Rarity configuration with stat pools and upgrade costs
        RARITY_CONFIG: {
            'COMMON':    { statPointPool: 150, upgradeCost: 0,    color: '#9ca3af', glow: 'none' },
            'UNCOMMON':  { statPointPool: 180, upgradeCost: 100,  color: '#fff', glow: '0 0 10px #fff' },
            'RARE':      { statPointPool: 210, upgradeCost: 250,  color: '#ccc', glow: '0 0 12px #ccc' },
            'EPIC':      { statPointPool: 250, upgradeCost: 500,  color: '#a855f7', glow: '0 0 15px #a855f7' },
            'LEGENDARY': { statPointPool: 300, upgradeCost: 1000, color: '#999', glow: '0 0 20px #999' },
            'MYTHIC':    { statPointPool: 350, upgradeCost: 2500, color: '#06b6d4', glow: '0 0 25px #06b6d4, 0 0 50px #fff' }
        },
        
        // Legacy support
        RARITY_POOLS: {
            'COMMON': 150,
            'UNCOMMON': 180,
            'RARE': 210,
            'EPIC': 250,
            'LEGENDARY': 300,
            'MYTHIC': 350
        },
        
        // Battle modes available
        BATTLE_MODES: [
            { id: 'BASE_FRIENDLY', name: 'Friendly Battle', icon: '', description: 'Safe practice - no card loss', reward: 5 },
            { id: 'BASE_FOR_KEEPS', name: 'For Keeps', icon: '', description: 'Winner takes opponent card!', reward: 25 },
            { id: 'CHAOS', name: 'Chaos Mode', icon: '', description: 'Random modifiers each round', reward: 15 },
            { id: 'DECLARE_WAR', name: 'I Declare War', icon: '', description: 'First to 10 points wins', reward: 20 },
            { id: 'PS21', name: 'PS21', icon: '', description: 'Blackjack-style card game', reward: 15 },
            { id: 'RUMBLE_ROYALE', name: 'Rumble Royale', icon: '', description: 'Endless streak vs AI', reward: 5 },
            { id: 'TAG_TEAM', name: 'Tag Team 2v2', icon: '', description: '2 cards vs 2 cards', reward: 25 },
            { id: 'SUDDEN_DEATH', name: 'Sudden Death', icon: '', description: 'One round, high variance', reward: 15 },
            { id: 'MYSTERY_PACK', name: 'Mystery Pack Duel', icon: '', description: 'Random pack showdown', reward: 20 }
        ],
        
        // Chaos mode modifiers
        CHAOS_MODIFIERS: [
            { id: 'DOUBLE_INT', name: 'Brain Boost', icon: '', description: 'INT doubled!' },
            { id: 'DOUBLE_PWR', name: 'Power Surge', icon: '', description: 'PWR doubled!' },
            { id: 'DOUBLE_SPD', name: 'Speed Demon', icon: '', description: 'SPD doubled!' },
            { id: 'ZERO_PWR', name: 'Power Drain', icon: '', description: 'PWR set to 0!' },
            { id: 'ZERO_SPD', name: 'Slow Motion', icon: '', description: 'SPD set to 0!' },
            { id: 'ZERO_INT', name: 'Brain Fog', icon: '', description: 'INT set to 0!' },
            { id: 'LEGENDARY_NERF', name: 'Giant Killer', icon: '', description: 'Legendary+ cards -20% PWR' },
            { id: 'LOW_RARITY_BUFF', name: 'Underdog', icon: '', description: 'Common/Uncommon +10 all stats' },
            { id: 'STAT_SWAP', name: 'Switcheroo', icon: '', description: 'PWR and INT swap!' },
            { id: 'LOWEST_RARITY_WINS', name: 'Reverse Rarity', icon: '', description: 'Lowest rarity wins round!' },
            { id: 'RANDOM_BOOST', name: 'Lucky Star', icon: '', description: 'Random stat +25' },
            { id: 'DURABILITY_MATTERS', name: 'Battle Worn', icon: '', description: 'Stats scale with durability' }
        ],
        
        // Current battle state
        currentBattle: {
            mode: null,
            phase: 'SELECT', // SELECT, BATTLE, ROUND, RESULT
            playerCards: [],
            aiCards: [],
            currentRound: 0,
            playerScore: 0,
            aiScore: 0,
            rounds: [],
            chaosModifier: null,
            streakCount: 0,
            ps21State: null,
            warPoints: { player: 0, ai: 0 },
            log: []
        },
        
        card: { 
            id: 'card_' + Date.now(),
            title: 'HERO CARD', 
            name: 'YOUR NAME', 
            frontImage: null,
            backImage: null,
            backBgImage: null,
            frontTransform: { scale: 1, rotation: 0, offsetX: 0, offsetY: 0 },
            backTransform: { scale: 1, rotation: 0, offsetX: 0, offsetY: 0 },
            bio: 'A mysterious hero with incredible powers...', 
            style: 'gold',
            template: 'classic',
            stats: { pwr: 50, spd: 50, int: 50 },
            stat1Label: 'PWR',
            stat2Label: 'SPD', 
            stat3Label: 'INT',
            backTitle: 'ORIGIN STORY',
            abilities: 'Super strength, flight, laser vision',
            quote: '"With great power..."',
            rarity: 'COMMON',
            cardNumber: '#001',
            edition: '',
            handle: '',
            affiliation: '',
            realName: '',
            borderColor: '#999',
            accentColor: '#bbb',
            textColor: '#ffffff',
            holoEffect: 'none',
            texture: 'none',
            titleFont: 'Bebas Neue',
            nameFont: 'Bebas Neue',
            bodyFont: 'system-ui',
            team: '',
            position: '',
            jersey: '',
            season: '2025',
            pointsUsed: 150,
            shareCode: null,
            origin: 'created',
            wonFrom: null,
            wonFromPlayer: null,
            category: 'heroes',
            locked: false,
            createdAt: new Date().toISOString(),
            // ===== NEW EVOLUTION PROPERTIES =====
            xp: 0,
            level: 0,
            durability: 100,
            battlesPlayed: 0,
            battlesWon: 0,
            battlesLost: 0,
            evolutionState: 'BASE', // DAMAGED, BASE, ENHANCED, LEGENDARY_FORM, MYTHIC_ASCENDED
            streakBest: 0,
            lastBattleDate: null
        },
        cover: { 
            series: 'PRESS START', 
            issue: '#1', 
            title: 'ADVENTURE', 
            tagline: 'THE STORY BEGINS', 
            price: '$4.99', 
            backText: 'In a world where heroes rise...', 
            style: 'classic',
            template: 'classic', 
            frontImage: null,
            backImage: null,
            backBgImage: null,
            barcodeImage: null,
            frontTransform: { scale: 1, rotation: 0, offsetX: 0, offsetY: 0 },
            backTransform: { scale: 1, rotation: 0, offsetX: 0, offsetY: 0 },
            author: 'Created by YOU',
            credits: 'Art & Story: Your Name\nColors: Your Name',
            website: 'pscomixx.online',
            // Font settings
            titleFont: 'Bangers',
            seriesFont: 'Bangers',
            bodyFont: 'system-ui'
        },
        // Card Collection System
        cardCollection: [],
        cardCategories: [
            { id: 'heroes', name: 'Heroes', icon: '', color: '#ccc' },
            { id: 'villains', name: 'Villains', icon: '', color: '#888' },
            { id: 'legends', name: 'Legends', icon: '', color: '#999' },
            { id: 'mythic', name: 'Mythic', icon: '', color: '#bbb' },
            { id: 'sports', name: 'Sports', icon: '', color: '#fff' },
            { id: 'won', name: 'Won in Battle', icon: '', color: '#fff' }
        ],
        // Available fonts
        FONTS: [
            { name: 'Bangers', category: 'comic' },
            { name: 'Bebas Neue', category: 'display' },
            { name: 'Creepster', category: 'horror' },
            { name: 'Permanent Marker', category: 'handwritten' },
            { name: 'Anton', category: 'display' },
            { name: 'Luckiest Guy', category: 'comic' },
            { name: 'Bungee', category: 'display' },
            { name: 'Black Ops One', category: 'display' },
            { name: 'Russo One', category: 'display' },
            { name: 'Righteous', category: 'display' },
            { name: 'Pacifico', category: 'script' },
            { name: 'Lobster', category: 'script' },
            { name: 'Dancing Script', category: 'script' },
            { name: 'Orbitron', category: 'scifi' },
            { name: 'Press Start 2P', category: 'pixel' },
            { name: 'VT323', category: 'pixel' },
            { name: 'Cinzel', category: 'elegant' },
            { name: 'Playfair Display', category: 'elegant' },
            { name: 'Georgia', category: 'serif' },
            { name: 'system-ui', category: 'system' }
        ],
        
        // ========== PACK SYSTEM & AI CARDS ==========
        
        // Card origin types - CREATED cards get bonuses!
        CARD_ORIGINS: {
            'created_photo': { name: 'Photo Card', icon: '', statBonus: 1.10, xpMultiplier: 1.5, pointsBonus: 2.0 },
            'created_drawing': { name: 'Hand-Drawn', icon: '', statBonus: 1.15, xpMultiplier: 2.0, pointsBonus: 2.5 },
            'created_animated': { name: 'Animated', icon: '', statBonus: 1.20, xpMultiplier: 2.5, pointsBonus: 3.0 },
            'created_ai': { name: 'AI Assisted', icon: '', statBonus: 1.05, xpMultiplier: 1.2, pointsBonus: 1.5 },
            'pack_starter': { name: 'Starter Pack', icon: '', statBonus: 1.0, xpMultiplier: 1.0, pointsBonus: 1.0 },
            'pack_bronze': { name: 'Bronze Pack', icon: '', statBonus: 1.0, xpMultiplier: 1.0, pointsBonus: 1.0 },
            'pack_silver': { name: 'Silver Pack', icon: '', statBonus: 1.0, xpMultiplier: 1.0, pointsBonus: 1.0 },
            'pack_gold': { name: 'Gold Pack', icon: '', statBonus: 1.0, xpMultiplier: 1.0, pointsBonus: 1.0 },
            'pack_mythic': { name: 'Mythic Pack', icon: '', statBonus: 1.0, xpMultiplier: 1.0, pointsBonus: 1.0 },
            'won_battle': { name: 'Battle Won', icon: '', statBonus: 1.0, xpMultiplier: 1.0, pointsBonus: 1.0 }
        },
        
        // Pack types available for purchase
        PACK_TYPES: [
            { id: 'starter', name: 'Starter Pack', cost: 0, cards: 5, icon: '', color: '#fff', oneTime: true,
              description: 'Welcome gift! 5 cards to begin',
              rarityWeights: { COMMON: 100 } },
            { id: 'bronze', name: 'Bronze Pack', cost: 50, cards: 3, icon: '', color: '#cd7f32',
              description: 'Basic pack with Uncommon chance',
              rarityWeights: { COMMON: 70, UNCOMMON: 25, RARE: 5 } },
            { id: 'silver', name: 'Silver Pack', cost: 150, cards: 3, icon: '', color: '#c0c0c0',
              description: 'Better odds for Rare cards',
              rarityWeights: { COMMON: 20, UNCOMMON: 50, RARE: 25, EPIC: 5 } },
            { id: 'gold', name: 'Gold Pack', cost: 400, cards: 5, icon: '', color: '#ffd700',
              description: 'Premium with Epic guaranteed',
              rarityWeights: { UNCOMMON: 20, RARE: 40, EPIC: 30, LEGENDARY: 8, MYTHIC: 2 } },
            { id: 'mythic', name: 'Mythic Pack', cost: 1000, cards: 5, icon: '', color: '#e879f9',
              description: 'Legendary guaranteed!',
              rarityWeights: { RARE: 20, EPIC: 45, LEGENDARY: 30, MYTHIC: 5 } }
        ],
        
        // Templates available for pack cards (uses existing templates)
        CARD_TEMPLATES: ['classic', 'retro', 'neon', 'tcg', 'premium', 'minimal'],
        
        // Character archetypes for AI card generation
        CARD_ARCHETYPES: [
            { type: 'hero', templates: ['classic', 'tcg'], names: ['Titan', 'Blaze', 'Storm', 'Phoenix', 'Nova', 'Apex', 'Valor', 'Echo', 'Raven', 'Atlas'] },
            { type: 'villain', templates: ['neon', 'tcg'], names: ['Venom', 'Shadow', 'Havoc', 'Doom', 'Chaos', 'Dread', 'Malice', 'Reaper', 'Wraith', 'Scorn'] },
            { type: 'monster', templates: ['retro', 'neon'], names: ['Kraken', 'Chimera', 'Hydra', 'Golem', 'Basilisk', 'Wendigo', 'Leviathan', 'Behemoth', 'Cerberus', 'Manticore'] },
            { type: 'robot', templates: ['neon', 'minimal'], names: ['Unit-X', 'Mecha-7', 'Cyber', 'Proto', 'Nexus', 'Sigma', 'Delta', 'Omega', 'Core', 'Spark'] },
            { type: 'mystic', templates: ['premium', 'classic'], names: ['Oracle', 'Sage', 'Mystic', 'Arcane', 'Ethereal', 'Celestial', 'Void', 'Astral', 'Seraph', 'Enigma'] },
            { type: 'warrior', templates: ['classic', 'tcg'], names: ['Ronin', 'Gladius', 'Spartan', 'Samurai', 'Knight', 'Berserker', 'Paladin', 'Warlord', 'Sentinel', 'Guardian'] },
            { type: 'speedster', templates: ['neon', 'minimal'], names: ['Flash', 'Bolt', 'Rush', 'Velocity', 'Sonic', 'Blur', 'Swift', 'Dash', 'Tempo', 'Impulse'] },
            { type: 'psychic', templates: ['premium', 'neon'], names: ['Mentis', 'Psi', 'Telepath', 'Cognito', 'Mindwave', 'Psyche', 'Zen', 'Focus', 'Vision', 'Prism'] }
        ],
        
        // Titles/prefixes for card names
        CARD_TITLES: ['The', 'Captain', 'Doctor', 'Master', 'Lord', 'Lady', 'Agent', 'General', 'Commander', 'Dark', 'Mighty', 'Swift', 'Ancient', 'Neo', 'Ultra', 'Prime'],
        
        // Suffixes for variety
        CARD_SUFFIXES: ['Prime', 'X', 'Alpha', 'Omega', 'Zero', 'One', 'Max', 'Ultra', 'Neo', 'EX', 'MK2', 'V2', 'Redux', 'Evolved'],
        
        // Avatars/emojis for pack cards
        CARD_AVATARS: {
            hero: ['', '', '', '', '', '', '', '', '', ''],
            villain: ['', '', '', '', '', '', '', '', '', ''],
            monster: ['', '', '', '', '', '', '', '', '', ''],
            robot: ['', '', '', '', '', '', '', '', '', ''],
            mystic: ['', '', '', '', '', '', '', '', '', ''],
            warrior: ['', '', '', '', '', '', '', '', '', ''],
            speedster: ['', '', '', '', '', '', '', '', '', ''],
            psychic: ['', '', '', '', '', '', '', '', '', '']
        },
        
        // Backstory templates for flavor
        CARD_BACKSTORIES: [
            "Born from the chaos of a dying star, {name} emerged with powers beyond comprehension.",
            "Once a normal citizen, {name} was transformed by a mysterious experiment.",
            "The last of an ancient bloodline, {name} carries the weight of generations.",
            "Created in a secret lab, {name} broke free to forge their own destiny.",
            "Trained since childhood by legendary masters, {name} has no equal in combat.",
            "After witnessing injustice, {name} swore an oath to protect the innocent.",
            "{name} hails from a dimension where physics obeys different laws.",
            "The artifact chose {name} as its champion across all realities.",
            "Mutated by cosmic radiation, {name} discovered powers and responsibility.",
            "A guardian from the future, {name} travels through time to prevent catastrophe."
        ],
        
        // Special abilities for flavor text
        CARD_ABILITIES: [
            "Energy Manipulation", "Super Strength", "Time Dilation", "Mind Control",
            "Elemental Mastery", "Dimensional Shift", "Regeneration", "Invisibility",
            "Telekinesis", "Super Speed", "Force Fields", "Energy Projection",
            "Shapeshifting", "Telepathy", "Matter Creation", "Reality Warping",
            "Technopathy", "Weather Control", "Gravity Manipulation", "Soul Binding"
        ],
        
        // Quotes for cards
        CARD_QUOTES: [
            '"Power is nothing without purpose."',
            '"In darkness, I am the light."',
            '"No challenge too great, no enemy too strong."',
            '"My will is unbreakable."',
            '"The storm answers to me."',
            '"Time bends to my command."',
            '"Fear is just another weapon."',
            '"I fight for those who cannot."',
            '"Evolution is inevitable."',
            '"The future belongs to the bold."'
        ],
        
        // Pack state
        packInventory: [],
        starterPackClaimed: false,
        packOpening: null, // Current pack being opened
        packResults: [], // Cards from last opened pack
        
        // Collection stats
        collectionStats: {
            totalCards: 0,
            createdCards: 0,
            packCards: 0,
            wonCards: 0,
            byRarity: { COMMON: 0, UNCOMMON: 0, RARE: 0, EPIC: 0, LEGENDARY: 0, MYTHIC: 0 }
        },
        
        // Unlock requirements for battle modes
        BATTLE_UNLOCK_REQUIREMENTS: {
            'BASE_FRIENDLY': 1,
            'CHAOS': 1,
            'PS21': 1,
            'SUDDEN_DEATH': 1,
            'BASE_FOR_KEEPS': 3,
            'DECLARE_WAR': 3,
            'TAG_TEAM': 2,
            'RUMBLE_ROYALE': 3,
            'MYSTERY_PACK': 5
        },
        
        // Milestones and rewards
        COLLECTION_MILESTONES: [
            { cards: 1, reward: 0, unlock: 'Friendly Battle', badge: ' First Card' },
            { cards: 3, reward: 25, unlock: 'For Keeps & War', badge: ' Collector' },
            { cards: 5, reward: 50, unlock: 'All Battle Modes', badge: ' Battle Ready' },
            { cards: 10, reward: 100, unlock: 'Bronze Pack', badge: ' Deck Builder' },
            { cards: 15, reward: 150, unlock: 'Silver Pack', badge: ' Rising Star' },
            { cards: 25, reward: 250, unlock: 'Deck Customization', badge: ' Card Master' },
            { cards: 40, reward: 400, unlock: 'Gold Pack', badge: ' Elite Collector' },
            { cards: 52, reward: 1000, unlock: 'Full Deck Achievement', badge: ' FULL DECK!' }
        ],
        
        // ========== COLLABORATION MODE ==========
        collabSession: null,
        collabMode: false,
        collabRole: null,
        collabPages: [],
        collabParticipants: [],
        collabName: '',
        
        // Collab limits
        COLLAB_MAX_PARTICIPANTS: 30,
        COLLAB_MAX_PAGES: 100,
        
        // ========== COMMUNITY FEED ==========
        communityFeed: JSON.parse(localStorage.getItem('pscomixx_feed') || '[]'),
        fullscreenPost: null, // Index of post being viewed fullscreen
        feedLoading: false,
        feedTab: 'foryou',
        savedPosts: JSON.parse(localStorage.getItem('pscomixx_saved') || '[]'),
        
        // Social features
        following: JSON.parse(localStorage.getItem('pscomixx_following') || '[]'),
        followers: JSON.parse(localStorage.getItem('pscomixx_followers') || '[]'),
        friends: JSON.parse(localStorage.getItem('pscomixx_friends') || '[]'),
        friendRequests: JSON.parse(localStorage.getItem('pscomixx_friend_requests') || '[]'),
        
        // Messages
        conversations: JSON.parse(localStorage.getItem('pscomixx_convos') || '[]'),
        activeConvo: null,
        
        // Comments
        activePostComments: null,
        
        // Notifications
        notifications: JSON.parse(localStorage.getItem('pscomixx_notifs') || '[]'),
        
        // View profile
        viewingProfile: null,
        
        // Post modal
        postModal: null
    };
    
    // Save state to localStorage
    function saveState() {
        try {
            // Save player info
            if (S.playerName) localStorage.setItem('pscomixx_player_name', S.playerName);
            if (S.playerEmail) localStorage.setItem('pscomixx_player_email', S.playerEmail);
            if (S.playerPhoto) localStorage.setItem('pscomixx_player_photo', S.playerPhoto);
            localStorage.setItem('pscomixx_is_signed_in', S.isSignedIn ? 'true' : 'false');
            
            // Save card collection
            if (S.cardCollection && S.cardCollection.length > 0) {
                localStorage.setItem('pscomixx_card_collection', JSON.stringify(S.cardCollection));
            }
            
            // Save coins and battle record
            localStorage.setItem('pscomixx_coins', String(S.coins || 0));
            if (S.battleRecord) {
                localStorage.setItem('pscomixx_battle_record', JSON.stringify(S.battleRecord));
            }
            
            // Save current card
            if (S.card) {
                localStorage.setItem('pscomixx_current_card', JSON.stringify(S.card));
            }
            
            
        } catch (e) {
            console.error('Error saving state:', e);
        }
    }
    
    // Load state from localStorage
    function loadState() {
        try {
            // Load player info
            const playerName = localStorage.getItem('pscomixx_player_name');
            const playerEmail = localStorage.getItem('pscomixx_player_email');
            const playerPhoto = localStorage.getItem('pscomixx_player_photo');
            const isSignedIn = localStorage.getItem('pscomixx_is_signed_in') === 'true';
            
            if (playerName) S.playerName = playerName;
            if (playerEmail) S.playerEmail = playerEmail;
            if (playerPhoto) S.playerPhoto = playerPhoto;
            if (isSignedIn) S.isSignedIn = true;
            
            // Load card collection
            const savedCollection = localStorage.getItem('pscomixx_card_collection');
            if (savedCollection) {
                S.cardCollection = JSON.parse(savedCollection);
            }
            
            // Load coins and battle record
            const savedCoins = localStorage.getItem('pscomixx_coins');
            if (savedCoins) S.coins = parseInt(savedCoins, 10) || 0;
            
            const savedBattleRecord = localStorage.getItem('pscomixx_battle_record');
            if (savedBattleRecord) {
                S.battleRecord = JSON.parse(savedBattleRecord);
            }
            
            // Load current card
            const savedCard = localStorage.getItem('pscomixx_current_card');
            if (savedCard) {
                S.card = JSON.parse(savedCard);
            }
            
            
        } catch (e) {
            console.error('Error loading state:', e);
        }
    }
    
    // Load saved state on startup
    loadState();
    
    // Font loading helper
    function loadFont(fontName) {
        if (fontName === 'system-ui' || fontName === 'Georgia') return;
        const link = document.createElement('link');
        link.href = 'https://fonts.googleapis.com/css2?family=' + fontName.replace(/ /g, '+') + ':wght@400;700&display=swap';
        link.rel = 'stylesheet';
        if (!document.querySelector('link[href*="' + fontName.replace(/ /g, '+') + '"]')) {
            document.head.appendChild(link);
        }
    }
    
    // Load initial fonts
    ['Bangers', 'Bebas Neue', 'Creepster'].forEach(loadFont);

    function createPage() {
        return {
            id: Date.now(),
            templateId: 'manga-1',
            panels: [{x:2,y:2,w:60,h:38},{x:64,y:2,w:34,h:18},{x:64,y:22,w:34,h:18},{x:2,y:42,w:96,h:24},{x:2,y:68,w:47,h:30},{x:51,y:68,w:47,h:30}],
            panelMedia: {},
            panelFilters: {},
            panelElements: {},
            pageElements: [],
            transition: 'none' // Page transition effect
        };
    }

    const TEMPLATES = [
        {id:'full',name:'Full Page',panels:[{x:2,y:2,w:96,h:96}]},
        {id:'2-row',name:'2 Rows',panels:[{x:2,y:2,w:96,h:47},{x:2,y:51,w:96,h:47}]},
        {id:'3-row',name:'3 Rows',panels:[{x:2,y:2,w:96,h:31},{x:2,y:35,w:96,h:31},{x:2,y:68,w:96,h:30}]},
        {id:'4-grid',name:'4 Grid',panels:[{x:2,y:2,w:47,h:47},{x:51,y:2,w:47,h:47},{x:2,y:51,w:47,h:47},{x:51,y:51,w:47,h:47}]},
        {id:'6-grid',name:'6 Grid',panels:[{x:2,y:2,w:31,h:47},{x:35,y:2,w:31,h:47},{x:68,y:2,w:30,h:47},{x:2,y:51,w:31,h:47},{x:35,y:51,w:31,h:47},{x:68,y:51,w:30,h:47}]},
        {id:'manga-1',name:'Manga',panels:[{x:2,y:2,w:60,h:38},{x:64,y:2,w:34,h:18},{x:64,y:22,w:34,h:18},{x:2,y:42,w:96,h:24},{x:2,y:68,w:47,h:30},{x:51,y:68,w:47,h:30}]},
        {id:'action',name:'Action',panels:[{x:2,y:2,w:96,h:48},{x:2,y:52,w:32,h:46},{x:36,y:52,w:32,h:46},{x:70,y:52,w:28,h:46}]},
        {id:'hero',name:'Hero Shot',panels:[{x:2,y:2,w:60,h:96},{x:64,y:2,w:34,h:31},{x:64,y:35,w:34,h:31},{x:64,y:68,w:34,h:30}]},
        {id:'dramatic',name:'Dramatic',panels:[{x:2,y:2,w:96,h:60},{x:2,y:64,w:48,h:34},{x:52,y:64,w:46,h:34}]},
        {id:'splash',name:'Splash',panels:[{x:2,y:2,w:70,h:70},{x:74,y:2,w:24,h:34},{x:74,y:38,w:24,h:34},{x:2,y:74,w:96,h:24}]},
        {id:'dynamic',name:'Dynamic',panels:[{x:2,y:2,w:48,h:47},{x:52,y:2,w:46,h:47},{x:2,y:51,w:46,h:47},{x:50,y:51,w:48,h:47}]},
        {id:'slant-1',name:'Slant',panels:[{x:2,y:2,w:96,h:30,skew:-3},{x:2,y:34,w:47,h:30,skew:3},{x:51,y:34,w:47,h:30,skew:-3},{x:2,y:68,w:96,h:30,skew:3}]},
        {id:'burst',name:'Burst',panels:[{x:20,y:20,w:60,h:60},{x:2,y:2,w:25,h:25},{x:73,y:2,w:25,h:25},{x:2,y:73,w:25,h:25},{x:73,y:73,w:25,h:25}]},
        {id:'stairs',name:'Stairs',panels:[{x:2,y:2,w:40,h:30},{x:30,y:25,w:40,h:30},{x:58,y:48,w:40,h:30},{x:2,y:70,w:96,h:28}]}
    ];

    const FILTERS = [
        {id:'none',name:'None',css:''},
        {id:'bw',name:'B&W',css:'grayscale(100%)'},
        {id:'sepia',name:'Sepia',css:'sepia(100%)'},
        {id:'vintage',name:'Vintage',css:'sepia(50%) contrast(90%) brightness(90%)'},
        {id:'comic',name:'Comic',css:'contrast(150%) saturate(150%)'},
        {id:'pop',name:'Pop Art',css:'contrast(200%) saturate(200%) brightness(110%)'},
        {id:'noir',name:'Noir',css:'grayscale(100%) contrast(150%) brightness(80%)'},
        {id:'sunset',name:'Sunset',css:'sepia(30%) saturate(150%) hue-rotate(-20deg)'},
        {id:'cool',name:'Cool',css:'saturate(80%) hue-rotate(180deg)'},
        {id:'warm',name:'Warm',css:'saturate(120%) hue-rotate(-30deg) brightness(105%)'},
        {id:'fade',name:'Fade',css:'opacity(70%) brightness(110%)'},
        {id:'dramatic',name:'Dramatic',css:'contrast(130%) brightness(90%) saturate(120%)'}
    ];

    const CARD_PRESETS = [
        {id:'hero',name:'Hero',style:'gold',title:'HERO CARD'},
        {id:'villain',name:'Villain',style:'fire',title:'VILLAIN'},
        {id:'legendary',name:'Legendary',style:'gold',title:'LEGENDARY'},
        {id:'rare',name:'Rare',style:'silver',title:'RARE CARD'},
        {id:'epic',name:'Epic',style:'fire',title:'EPIC'},
        {id:'common',name:'Common',style:'silver',title:'COMMON'}
    ];

    const COVER_PRESETS = [
        {id:'action',name:'Action',style:'classic',series:'ACTION COMICS'},
        {id:'horror',name:'Horror',style:'dark',series:'TALES OF TERROR'},
        {id:'romance',name:'Romance',style:'vintage',series:'LOVE STORIES'},
        {id:'scifi',name:'Sci-Fi',style:'dark',series:'FUTURE WORLDS'},
        {id:'fantasy',name:'Fantasy',style:'vintage',series:'MYSTIC REALMS'},
        {id:'superhero',name:'Superhero',style:'classic',series:'SUPER HEROES'}
    ];

    const BUBBLES = [
        {name:'Speech',cls:''},
        {name:'Shout!',cls:'shout'},
        {name:'Burst!',cls:'burst'},
        {name:'Whisper',cls:'whisper'},
        {name:'Thought',cls:'thought'},
        {name:'Scream!',cls:'scream'},
        {name:'Robot',cls:'robot'},
        {name:'Drip',cls:'drip'},
        {name:'Glitch',cls:'glitch'},
        {name:'Retro',cls:'retro'},
        {name:'Neon',cls:'neon'},
        {name:'Graffiti',cls:'graffiti'}
    ];
    const EFFECTS = [
        // Classic
        {text:'POW!',color:'#ff0000'},
        {text:'BANG!',color:'#ff9800'},
        {text:'BOOM!',color:'#ffeb3b'},
        {text:'ZAP!',color:'#2196f3'},
        {text:'WHAM!',color:'#9c27b0'},
        {text:'CRASH!',color:'#4caf50'},
        // Action
        {text:'KAPOW!',color:'#e91e63'},
        {text:'SMASH!',color:'#f44336'},
        {text:'SLAM!',color:'#ff5722'},
        {text:'THWACK!',color:'#795548'},
        {text:'WHOOSH!',color:'#00bcd4'},
        {text:'ZOOM!',color:'#3f51b5'},
        // Impact
        {text:'SPLAT!',color:'#8bc34a'},
        {text:'CRACK!',color:'#ffc107'},
        {text:'SNAP!',color:'#ff4081'},
        {text:'POP!',color:'#7c4dff'},
        {text:'BIFF!',color:'#00e676'},
        {text:'BONK!',color:'#ff6e40'},
        // Sounds
        {text:'SIZZLE!',color:'#ff1744'},
        {text:'BUZZ!',color:'#ffea00'},
        {text:'CRUNCH!',color:'#d500f9'},
        {text:'SWOOSH!',color:'#00b0ff'},
        {text:'THUD!',color:'#6d4c41'},
        {text:'CLICK!',color:'#b388ff'},
        // Gen-Z / Slang
        {text:'SLAY!',color:'#e040fb'},
        {text:'RIZZ!',color:'#ff80ab'},
        {text:'BUSSIN!',color:'#69f0ae'},
        {text:'NO CAP!',color:'#40c4ff'},
        {text:'FIRE!',color:'#ff6d00'},
        {text:'GOAT!',color:'#ffd600'},
        {text:'YEET!',color:'#76ff03'},
        {text:'BRUH!',color:'#ea80fc'},
        {text:'SHEESH!',color:'#18ffff'},
        {text:'W!',color:'#00e5ff'},
        {text:'L!',color:'#ff1744'},
        {text:'NPC!',color:'#b2ff59'},
        // Custom
        {text:'CUSTOM',color:'custom'}
    ];
    const EFFECT_COLORS = ['#ff0000','#ff9800','#ffeb3b','#4caf50','#2196f3','#9c27b0','#ff1493','#00ffff','#ff4081','#7c4dff','#00e676','#ffd600','#e040fb','#76ff03','#f50057','#651fff'];
    const EMOJIS = [
        // Faces
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','',
        // Gestures
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','','',
        // People
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        // Animals
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        // Nature
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        // Food
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        // Activities & Sports
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        // Objects
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        // Symbols
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','0',
        '1','2','3','4','5','6','7','8','9','','','#','*','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        // Special & Gaming
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','','',
        '','','','','','','','','','','','','','','',''
    ];

    const icon = (n, s=24) => {
        const icons = {
            play: '<polygon points="5,3 19,12 5,21" fill="currentColor"/>',
            x: '<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>',
            plus: '<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>',
            image: '<rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>',
            bubble: '<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>',
            zap: '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',
            grid: '<rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>',
            smile: '<circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/>',
            comic: '<rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/>',
            card: '<rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="18" x2="12" y2="18"/>',
            book: '<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>',
            trash: '<polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>',
            edit: '<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>',
            save: '<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/>',
            share: '<circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>',
            upload: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>',
            globe: '<circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>',
            check: '<polyline points="20 6 9 17 4 12"/>',
            pencil: '<path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>',
            eraser: '<path d="M20 20H7L2 15l10-10 8 8-5 7z"/><path d="M18 13l-8-8"/>',
            paintbrush: '<path d="M18.37 2.63L14 7l-1.59-1.59a2 2 0 0 0-2.82 0L8 7l9 9 1.59-1.59a2 2 0 0 0 0-2.82L17 10l4.37-4.37a2.12 2.12 0 1 0-3-3z"/><path d="M9 8c-2 3-4 3.5-7 4l8 10c2-1 6-5 6-7"/>',
            undo: '<path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/>',
            redo: '<path d="M21 7v6h-6"/><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13"/>',
            sun: '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>',
            moon: '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>',
            home: '<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>',
            menu: '<line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/>',
            'arrow-left': '<line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/>',
            'chevron-left': '<polyline points="15 18 9 12 15 6"/>',
            'chevron-right': '<polyline points="9 18 15 12 9 6"/>',
            'mouse-pointer': '<path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/><path d="M13 13l6 6"/>',
            move: '<polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="15 19 12 22 9 19"/><polyline points="19 9 22 12 19 15"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/>',
            layout: '<rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/>',
            type: '<polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/>',
            'message-circle': '<path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>',
            sparkles: '<path d="M12 3L14 8L20 9L15 13L17 20L12 16L7 20L9 13L4 9L10 8L12 3Z"/>',
            video: '<polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/>',
            star: '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>',
            'git-branch': '<line x1="6" y1="3" x2="6" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/>',
            'book-open': '<path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>',
            folder: '<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>',
            user: '<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>',
            settings: '<circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>',
            'shopping-bag': '<path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/>',
            'file-text': '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>',
            mail: '<path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>',
            layers: '<polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/>',
            download: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>',
            maximize: '<path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>',
            shuffle: '<polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/>'
        };
        return `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${icons[n]||''}</svg>`;
    };

    const toast = m => { 
        S.toast = m; 
        // On mobile, update DOM directly instead of full render
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        if (isMobile) {
            let toastEl = document.getElementById('mobile-toast');
            if (!toastEl) {
                toastEl = document.createElement('div');
                toastEl.id = 'mobile-toast';
                toastEl.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#222;color:#fff;padding:12px 24px;border-radius:8px;font-size:13px;z-index:99999;pointer-events:none;';
                document.body.appendChild(toastEl);
            }
            toastEl.textContent = m;
            toastEl.style.display = 'block';
            setTimeout(() => { 
                toastEl.style.display = 'none'; 
                S.toast = null; 
            }, 2000);
        } else {
            render(); 
            setTimeout(() => { S.toast = null; render(); }, 2500); 
        }
    };
    
    // Card style helper functions
    function getCardBg(style) {
        const styles = {
            gold: 'linear-gradient(135deg, #1a1a2e, #16213e)',
            silver: 'linear-gradient(135deg, #2a2a3e, #3a3a4e)',
            fire: 'linear-gradient(135deg, #1a0505, #2a0a0a)',
            ice: 'linear-gradient(135deg, #051a2a, #0a2540)',
            neon: 'linear-gradient(135deg, #1a0520, #0a0520)',
            nature: 'linear-gradient(135deg, #0a1a0a, #102010)'
        };
        return styles[style] || styles.gold;
    }
    
    function getCardAccent(style) {
        const accents = {
            gold: '#c9a227',
            silver: '#aaa',
            fire: '#ff4500',
            ice: '#00bfff',
            neon: '#ff00ff',
            nature: '#fff'
        };
        return accents[style] || accents.gold;
    }
    
    function getCardGradient(style) {
        const grads = {
            gold: 'linear-gradient(90deg, #c9a227, #f4d03f, #c9a227)',
            silver: 'linear-gradient(90deg, #888, #ccc, #888)',
            fire: 'linear-gradient(90deg, #ff4500, #ff8c00, #ff4500)',
            ice: 'linear-gradient(90deg, #00bfff, #87ceeb, #00bfff)',
            neon: 'linear-gradient(90deg, #ff00ff, #00ffff, #ff00ff)',
            nature: 'linear-gradient(90deg, #fff, #86efac, #fff)'
        };
        return grads[style] || grads.gold;
    }
    
    function getCardStatsBg(style) {
        const bgs = {
            gold: '#1a1a2e',
            silver: '#2a2a3e',
            fire: '#1a0505',
            ice: '#051a2a',
            neon: '#1a0520',
            nature: '#0a1a0a'
        };
        return bgs[style] || bgs.gold;
    }
    
    function randomizeCardStats() {
        S.card.stats = {
            pwr: Math.floor(Math.random() * 40) + 60,
            spd: Math.floor(Math.random() * 40) + 60,
            int: Math.floor(Math.random() * 40) + 60
        };
        // Random rarity
        const rarities = ['COMMON', 'UNCOMMON', 'RARE', 'EPIC', 'LEGENDARY', 'MYTHIC'];
        S.card.rarity = rarities[Math.floor(Math.random() * rarities.length)];
        toast(' Stats randomized!');
        render();
    }
    
    // Rarity-based styling
    function getRarityColor(rarity) {
        const colors = {
            'COMMON': '#6b7280',
            'UNCOMMON': '#fff',
            'RARE': '#ccc',
            'EPIC': '#bbb',
            'LEGENDARY': '#999',
            'MYTHIC': '#fff'
        };
        return colors[rarity] || colors.LEGENDARY;
    }
    
    function getRarityGradient(rarity) {
        const grads = {
            'COMMON': 'linear-gradient(135deg, #6b7280, #9ca3af)',
            'UNCOMMON': 'linear-gradient(135deg, #fff, #fff)',
            'RARE': 'linear-gradient(135deg, #ccc, #ddd)',
            'EPIC': 'linear-gradient(135deg, #bbb, #a78bfa)',
            'LEGENDARY': 'linear-gradient(135deg, #999, #fbbf24, #999)',
            'MYTHIC': 'linear-gradient(135deg, #fff, #ccc, #bbb)'
        };
        return grads[rarity] || grads.LEGENDARY;
    }
    
    // POINT POOL SYSTEM - Fair stat distribution
    function getPointPool() {
        return S.RARITY_POOLS[S.card.rarity] || 150;
    }
    
    function getPointsUsed() {
        return (S.card.stats.pwr || 0) + (S.card.stats.spd || 0) + (S.card.stats.int || 0);
    }
    
    function getPointsRemaining() {
        return getPointPool() - getPointsUsed();
    }
    
    // Render stat bars for card backs - works with any template colors
    function renderStatBars(template, borderColor) {
        const pwr = S.card.stats?.pwr || 50;
        const spd = S.card.stats?.spd || 50;
        const int = S.card.stats?.int || 50;
        const label1 = S.card.stat1Label || 'PWR';
        const label2 = S.card.stat2Label || 'SPD';
        const label3 = S.card.stat3Label || 'INT';
        
        const bgColor = template==='retro'?'#d4c4a1':template==='neon'?'#1a0a2a':template==='minimal'?'#f0f0f0':'rgba(0,0,0,0.3)';
        const textColor = template==='retro'?'#5a3a1a':template==='minimal'?'#333':'#fff';
        const barBg = template==='retro'?'#8b4513':template==='minimal'?'#ddd':'#333';
        
        return `
            <div style="margin:8px 0;padding:10px;background:${bgColor};border-radius:8px">
                <div style="display:flex;flex-direction:column;gap:6px">
                    <div style="display:flex;align-items:center;gap:8px">
                        <span style="width:40px;font-size:10px;color:${textColor};font-weight:bold">${label1}</span>
                        <div style="flex:1;height:8px;background:${barBg};border-radius:4px;overflow:hidden">
                            <div style="width:${pwr}%;height:100%;background:#fff;border-radius:4px"></div>
                        </div>
                        <span style="width:24px;font-size:10px;color:#fff;font-weight:bold;text-align:right">${pwr}</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px">
                        <span style="width:40px;font-size:10px;color:${textColor};font-weight:bold">${label2}</span>
                        <div style="flex:1;height:8px;background:${barBg};border-radius:4px;overflow:hidden">
                            <div style="width:${spd}%;height:100%;background:#ddd;border-radius:4px"></div>
                        </div>
                        <span style="width:24px;font-size:10px;color:#ddd;font-weight:bold;text-align:right">${spd}</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px">
                        <span style="width:40px;font-size:10px;color:${textColor};font-weight:bold">${label3}</span>
                        <div style="flex:1;height:8px;background:${barBg};border-radius:4px;overflow:hidden">
                            <div style="width:${int}%;height:100%;background:#fff;border-radius:4px"></div>
                        </div>
                        <span style="width:24px;font-size:10px;color:#fff;font-weight:bold;text-align:right">${int}</span>
                    </div>
                </div>
            </div>`;
    }
    
    function updateStat(statKey, value) {
        const newVal = parseInt(value) || 0;
        const clampedVal = Math.max(0, Math.min(100, newVal)); // Max 100 per stat
        
        // Calculate what the new total would be
        const otherStats = Object.keys(S.card.stats)
            .filter(k => k !== statKey)
            .reduce((sum, k) => sum + (S.card.stats[k] || 0), 0);
        const newTotal = otherStats + clampedVal;
        const pool = getPointPool();
        
        // If over budget, cap this stat
        if (newTotal > pool) {
            S.card.stats[statKey] = Math.max(0, pool - otherStats);
            toast(` Point limit reached! ${S.card.rarity} = ${pool} points`);
        } else {
            S.card.stats[statKey] = clampedVal;
        }
        render();
    }
    
    function setCardRarity(rarity) {
        const oldPool = getPointPool();
        S.card.rarity = rarity;
        const newPool = getPointPool();
        
        // If downgrading rarity, may need to reduce stats
        if (getPointsUsed() > newPool) {
            // Proportionally reduce all stats
            const ratio = newPool / getPointsUsed();
            S.card.stats.pwr = Math.floor(S.card.stats.pwr * ratio);
            S.card.stats.spd = Math.floor(S.card.stats.spd * ratio);
            S.card.stats.int = Math.floor(S.card.stats.int * ratio);
            toast(` Stats adjusted for ${rarity} (${newPool} pts)`);
        } else if (newPool > oldPool) {
            toast(` ${rarity}! +${newPool - oldPool} stat points available!`);
        } else {
            toast(` ${rarity} card!`);
        }
        renderPreserveScroll();
    }
    
    function setCardTemplate(template) {
        S.card.template = template;
        // Set default styles based on template
        const templates = {
            classic: { 
                title: 'HERO CARD', 
                borderColor: '#c9a227',
                bgGradient: 'linear-gradient(180deg,#1a1a2e,#0f0f1a)',
                titleBg: 'linear-gradient(135deg,#c9a227,#f4d03f)',
                titleColor: '#000',
                showStats: true,
                frameStyle: 'solid'
            },
            retro: { 
                title: 'GARBAGE PAIL', 
                borderColor: '#d4a574',
                bgGradient: 'linear-gradient(180deg,#f5e6d3,#e8d5b7)',
                titleBg: 'linear-gradient(135deg,#8b0000,#cd5c5c)',
                titleColor: '#fff',
                showStats: false,
                frameStyle: 'vintage'
            },
            neon: { 
                title: 'NEON NIGHTS', 
                borderColor: '#00ffff',
                bgGradient: 'linear-gradient(180deg,#0a0a1a,#1a0a2e)',
                titleBg: 'linear-gradient(135deg,#ff00ff,#00ffff)',
                titleColor: '#fff',
                showStats: true,
                frameStyle: 'glow'
            },
            tcg: { 
                title: 'BATTLE CARD', 
                borderColor: '#ff6b35',
                bgGradient: 'linear-gradient(180deg,#1a1a2e,#2a1a1a)',
                titleBg: 'linear-gradient(135deg,#ff6b35,#ff8c42)',
                titleColor: '#fff',
                showStats: true,
                frameStyle: 'tcg'
            },
            premium: { 
                title: 'PREMIUM', 
                borderColor: '#e91e63',
                bgGradient: 'linear-gradient(135deg,#1a0a1a,#2a1a2e)',
                titleBg: 'linear-gradient(135deg,#e91e63,#9c27b0)',
                titleColor: '#fff',
                showStats: false,
                frameStyle: 'premium'
            },
            minimal: { 
                title: 'PLAYER NAME', 
                borderColor: '#333',
                bgGradient: '#ffffff',
                titleBg: '#111',
                titleColor: '#fff',
                showStats: true,
                frameStyle: 'minimal'
            }
        };
        if (templates[template]) {
            S.card.templateStyle = templates[template];
        }
        toast(` ${template.charAt(0).toUpperCase() + template.slice(1)} style!`);
        renderPreserveScroll();
    }
    
    function getCardTemplateStyle() {
        const t = S.card.template || 'classic';
        const styles = {
            classic: {
                border: `5px solid ${getRarityColor(S.card.rarity||'LEGENDARY')}`,
                bg: 'linear-gradient(180deg,#1a1a2e,#0f0f1a)',
                frameBg: '#fff',
                titleBg: getRarityGradient(S.card.rarity||'LEGENDARY'),
                titleColor: ['LEGENDARY','MYTHIC'].includes(S.card.rarity||'LEGENDARY')?'#000':'#fff',
                nameBg: getRarityGradient(S.card.rarity||'LEGENDARY'),
                nameColor: ['LEGENDARY','MYTHIC'].includes(S.card.rarity||'LEGENDARY')?'#000':'#fff',
                showStats: true,
                showNumber: true,
                imageRadius: '0',
                font: "'Bebas Neue', sans-serif"
            },
            retro: {
                border: '8px solid #d4a574',
                bg: 'linear-gradient(180deg,#f5e6d3,#e8d5b7)',
                frameBg: 'linear-gradient(180deg,#f5e6d3,#d4c4a1)',
                titleBg: 'linear-gradient(135deg,#8b0000,#a52a2a)',
                titleColor: '#fff',
                nameBg: 'linear-gradient(135deg,#8b0000,#a52a2a)',
                nameColor: '#ffd700',
                showStats: false,
                showNumber: true,
                imageRadius: '0',
                font: "'Bangers', cursive"
            },
            neon: {
                border: '4px solid #00ffff',
                bg: 'linear-gradient(180deg,#0a0a1a,#1a0a2e)',
                frameBg: 'transparent',
                titleBg: 'transparent',
                titleColor: '#00ffff',
                nameBg: 'linear-gradient(135deg,rgba(255,0,255,0.3),rgba(0,255,255,0.3))',
                nameColor: '#fff',
                showStats: true,
                showNumber: false,
                imageRadius: '12px',
                font: "'Bebas Neue', sans-serif",
                glow: '0 0 30px #00ffff, 0 0 60px #ff00ff'
            },
            tcg: {
                border: '6px solid #ff6b35',
                bg: 'linear-gradient(180deg,#1a1a2e,#0f0f1a)',
                frameBg: '#111',
                titleBg: 'linear-gradient(135deg,#ff6b35,#ff8c42)',
                titleColor: '#fff',
                nameBg: '#ff6b35',
                nameColor: '#fff',
                showStats: true,
                showNumber: true,
                imageRadius: '8px',
                font: "'Bebas Neue', sans-serif"
            },
            premium: {
                border: '3px solid transparent',
                borderImage: 'linear-gradient(135deg,#e91e63,#9c27b0,#3f51b5) 1',
                bg: 'linear-gradient(135deg,#1a0a1a,#0a1a2a)',
                frameBg: 'transparent',
                titleBg: 'transparent',
                titleColor: '#e91e63',
                nameBg: 'linear-gradient(135deg,#e91e63,#9c27b0)',
                nameColor: '#fff',
                showStats: false,
                showNumber: true,
                imageRadius: '16px',
                font: "'Bebas Neue', sans-serif"
            },
            minimal: {
                border: '3px solid #222',
                bg: '#fff',
                frameBg: '#fff',
                titleBg: '#111',
                titleColor: '#fff',
                nameBg: '#111',
                nameColor: '#fff',
                showStats: true,
                showNumber: false,
                imageRadius: '0',
                font: "system-ui, sans-serif"
            }
        };
        return styles[t] || styles.classic;
    }
    
    function generateCardId() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let id = 'PS-';
        for (let i = 0; i < 6; i++) {
            id += chars[Math.floor(Math.random() * chars.length)];
        }
        S.card.cardId = id;
        toast(` Card ID: ${id}`);
        render();
    }
    
    function flipCard() {
        S.cardFlipped = !S.cardFlipped;
        render();
    }
    
    // Generate a simple QR code pattern (visual representation)
    function generateQRPattern(code) {
        // This creates a visual pattern that looks like a QR code
        // In production, you'd use a real QR library
        const seed = code.split('').reduce((a, c) => a + c.charCodeAt(0), 0);
        let pattern = '';
        for (let i = 0; i < 25; i++) {
            const bit = ((seed * (i + 1) * 7) % 2);
            pattern += bit ? '' : ' ';
            if ((i + 1) % 5 === 0) pattern += '\n';
        }
        return pattern;
    }
    
    // Generate unique card code
    function generateCardCode() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let code = 'PS';
        for (let i = 0; i < 6; i++) {
            code += chars[Math.floor(Math.random() * chars.length)];
        }
        return code;
    }
    
    function shareCard() {
        // Generate unique code for this card
        const cardCode = generateCardCode();
        S.card.shareCode = cardCode;
        
        toast(' Preparing card for sharing...');
        
        // Create share text
        const shareText = ` ${S.card.name}'s Card!\n` +
            ` ${S.card.rarity}\n` +
            ` ${S.card.stat1Label||'PWR'}: ${S.card.stats?.pwr||50} | ${S.card.stat2Label||'SPD'}: ${S.card.stats?.spd||50} | ${S.card.stat3Label||'INT'}: ${S.card.stats?.int||50}\n` +
            ` Code: ${cardCode}\n` +
            ` Make your own at pscomixx.online`;
        
        saveToPhotos('card').then(() => {
            if (navigator.share) {
                navigator.share({
                    title: S.card.name + ' - Press Start Card',
                    text: shareText,
                    url: 'https://pscomixx.online/card/' + cardCode
                }).catch(() => {
                    // Fallback to clipboard
                    navigator.clipboard.writeText(shareText);
                    toast(' Card code copied! ' + cardCode);
                });
            } else {
                navigator.clipboard.writeText(shareText);
                toast(' Card code copied! ' + cardCode);
            }
        });
        
        render();
    }
    
    // CARD BATTLE MODE
    S.battleMode = false;
    S.battleOpponent = null;
    S.battleResult = null;
    
    // ========== CREDITS & ECONOMY SYSTEM ==========
    
    function earnCredits(action, bonus = 0) {
        const reward = (S.CREDIT_REWARDS[action] || 0) + bonus;
        if (reward > 0) {
            S.user.credits += reward;
            S.user.xp += Math.floor(reward / 2);
            checkLevelUp();
            toast(` +${reward} Credits! (${action.replace(/_/g, ' ')})`);
            saveUserData();
        }
        return reward;
    }
    
    function spendCredits(amount, reason) {
        if (S.user.credits >= amount) {
            S.user.credits -= amount;
            toast(` -${amount} Credits spent on ${reason}`);
            saveUserData();
            return true;
        } else {
            toast(` Not enough credits! Need ${amount}, have ${S.user.credits}`);
            return false;
        }
    }
    
    function checkLevelUp() {
        const xpNeeded = S.user.level * 100;
        if (S.user.xp >= xpNeeded) {
            S.user.level++;
            S.user.xp -= xpNeeded;
            toast(` LEVEL UP! You're now Level ${S.user.level}!`);
        }
    }
    
    function upgradeRarity() {
        const rarityOrder = ['COMMON', 'UNCOMMON', 'RARE', 'EPIC', 'LEGENDARY', 'MYTHIC'];
        const currentIdx = rarityOrder.indexOf(S.card.rarity);
        if (currentIdx >= rarityOrder.length - 1) {
            toast(' Already at MYTHIC! Maximum rarity reached!');
            return;
        }
        const nextRarity = rarityOrder[currentIdx + 1];
        const cost = S.RARITY_COSTS[nextRarity];
        
        if (spendCredits(cost, `${nextRarity} upgrade`)) {
            S.card.rarity = nextRarity;
            toast(` UPGRADED to ${nextRarity}! +${S.RARITY_POOLS[nextRarity] - S.RARITY_POOLS[rarityOrder[currentIdx]]} stat points!`);
            render();
        }
    }
    
    function getNextRarityCost() {
        const rarityOrder = ['COMMON', 'UNCOMMON', 'RARE', 'EPIC', 'LEGENDARY', 'MYTHIC'];
        const currentIdx = rarityOrder.indexOf(S.card.rarity);
        if (currentIdx >= rarityOrder.length - 1) return null;
        return { rarity: rarityOrder[currentIdx + 1], cost: S.RARITY_COSTS[rarityOrder[currentIdx + 1]] };
    }
    
    // ========== CARD COLLECTION SYSTEM ==========
    
    function saveCardToCollection() {
        const cardCopy = JSON.parse(JSON.stringify(S.card));
        cardCopy.id = 'card_' + Date.now();
        cardCopy.createdAt = new Date().toISOString();
        
        // Determine origin type based on content
        if (cardCopy.frontImage) {
            // Check if it's a drawing (has animation frames)
            const page = getPage();
            const hasDrawing = page.panelDrawings || page.drawFrames?.length > 1;
            if (hasDrawing) {
                cardCopy.origin = 'created_animated';
            } else {
                cardCopy.origin = 'created_photo';
            }
        } else {
            cardCopy.origin = 'created_photo'; // Still counts as created even without image
        }
        
        // Calculate quality score
        const quality = calculateCardQuality(cardCopy);
        cardCopy.qualityScore = quality.percentage;
        cardCopy.qualityGrade = quality.grade;
        
        // Check for gibberish - warn but still save
        if (isGibberish(cardCopy.name)) {
            toast(' Add a real name for bonus stats!');
        }
        
        // Apply creation bonuses
        applyCreationBonuses(cardCopy);
        
        // Show quality feedback
        const multipliers = getCardMultipliers(cardCopy);
        let bonusMsg = '';
        if (multipliers.stats > 1) {
            const bonusPercent = Math.round((multipliers.stats - 1) * 100);
            bonusMsg = ` (+${bonusPercent}% stats!)`;
        }
        
        S.cardCollection.push(cardCopy);
        
        // Update stats
        updateCollectionStats();
        checkMilestones();
        
        // Earn credits
        earnCredits('first_card');
        
        toast(` "${cardCopy.name}" saved!${bonusMsg} Grade: ${quality.grade}`);
        
        // Track card creation
        trackEvent('card_created', {
            card_rarity: cardCopy.rarity,
            card_quality: quality.grade,
            has_image: !!cardCopy.frontImage
        });
        trackActivity('card_created', { rarity: cardCopy.rarity, quality: quality.grade });
        
        saveUserData();
        render();
    }
    
    function loadCardFromCollection(index) {
        if (S.cardCollection[index]) {
            S.card = JSON.parse(JSON.stringify(S.cardCollection[index]));
            S.activeCardIndex = index;
            toast(` Loaded "${S.card.name}"`);
            render();
        }
    }
    
    function deleteCardFromCollection(index) {
        if (S.cardCollection.length <= 1) {
            toast(' Can\'t delete your last card!');
            return;
        }
        const card = S.cardCollection[index];
        if (card.locked) {
            toast(' This card is locked! Unlock it first.');
            return;
        }
        S.cardCollection.splice(index, 1);
        if (S.activeCardIndex >= S.cardCollection.length) {
            S.activeCardIndex = S.cardCollection.length - 1;
        }
        toast(` Deleted "${card.name}"`);
        saveUserData();
        render();
    }
    
    function toggleCardLock(index) {
        if (S.lockedCardId && S.cardCollection[index].id !== S.lockedCardId) {
            // Unlock previous card first
            const prevLocked = S.cardCollection.find(c => c.id === S.lockedCardId);
            if (prevLocked) prevLocked.locked = false;
        }
        S.cardCollection[index].locked = !S.cardCollection[index].locked;
        S.lockedCardId = S.cardCollection[index].locked ? S.cardCollection[index].id : null;
        toast(S.cardCollection[index].locked ? ' Card protected from battles!' : ' Card unlocked');
        saveUserData();
        render();
    }
    
    // ========== CARD QUALITY & CREATION SYSTEM ==========
    
    // Detect gibberish/spam content
    function isGibberish(text) {
        if (!text || typeof text !== 'string') return true;
        const cleaned = text.trim();
        
        // Too short
        if (cleaned.length < 2) return true;
        
        // All same character (aaaa, 1111, etc)
        if (/^(.)\1+$/.test(cleaned)) return true;
        
        // All single characters with spaces (a a a a)
        if (/^(.\s)+.$/.test(cleaned)) return true;
        
        // Same word repeated (test test test)
        const words = cleaned.toLowerCase().split(/\s+/);
        if (words.length > 2 && words.every(w => w === words[0])) return true;
        
        // Just numbers
        if (/^\d+$/.test(cleaned)) return true;
        
        // Keyboard mashing patterns (asdfgh, qwerty, etc)
        const keyboardPatterns = ['qwerty', 'asdfgh', 'zxcvbn', 'qazwsx', '123456', 'abcdef'];
        if (keyboardPatterns.some(p => cleaned.toLowerCase().includes(p))) return true;
        
        // Random consonants with no vowels (longer than 4 chars)
        if (cleaned.length > 4 && !/[aeiouAEIOU]/.test(cleaned)) return true;
        
        // Excessive special characters
        const specialRatio = (cleaned.match(/[^a-zA-Z0-9\s]/g) || []).length / cleaned.length;
        if (specialRatio > 0.5) return true;
        
        return false;
    }
    
    // Score text quality (0-100)
    function scoreTextQuality(text, minLength = 3, idealLength = 20) {
        if (!text || typeof text !== 'string') return 0;
        if (isGibberish(text)) return 0;
        
        const cleaned = text.trim();
        let score = 0;
        
        // Length score (up to 40 points)
        const lengthScore = Math.min(40, (cleaned.length / idealLength) * 40);
        score += lengthScore;
        
        // Word variety (up to 30 points)
        const words = cleaned.toLowerCase().split(/\s+/).filter(w => w.length > 1);
        const uniqueWords = new Set(words);
        const varietyRatio = words.length > 0 ? uniqueWords.size / words.length : 0;
        score += varietyRatio * 30;
        
        // Proper capitalization bonus (up to 10 points)
        if (/^[A-Z]/.test(cleaned)) score += 5;
        if (/[.!?]$/.test(cleaned)) score += 5;
        
        // Multiple sentences bonus (up to 20 points)
        const sentences = cleaned.split(/[.!?]+/).filter(s => s.trim().length > 0);
        score += Math.min(20, sentences.length * 5);
        
        return Math.round(Math.min(100, score));
    }
    
    // Calculate card quality score based on filled fields
    function calculateCardQuality(card) {
        let totalScore = 0;
        let maxScore = 0;
        const breakdown = {};
        
        // Name (required, 15 points max)
        maxScore += 15;
        const nameScore = scoreTextQuality(card.name, 2, 15);
        breakdown.name = Math.round(nameScore * 0.15);
        totalScore += breakdown.name;
        
        // Has custom image (25 points - biggest bonus for creativity!)
        maxScore += 25;
        if (card.frontImage) {
            breakdown.image = 25;
            totalScore += 25;
        } else {
            breakdown.image = 0;
        }
        
        // Bio/description (20 points max)
        maxScore += 20;
        const bioScore = scoreTextQuality(card.bio, 10, 100);
        breakdown.bio = Math.round(bioScore * 0.2);
        totalScore += breakdown.bio;
        
        // Quote (10 points max)
        maxScore += 10;
        const quoteScore = scoreTextQuality(card.quote, 5, 30);
        breakdown.quote = Math.round(quoteScore * 0.1);
        totalScore += breakdown.quote;
        
        // Abilities (10 points max)
        maxScore += 10;
        const abilitiesScore = scoreTextQuality(card.abilities, 5, 50);
        breakdown.abilities = Math.round(abilitiesScore * 0.1);
        totalScore += breakdown.abilities;
        
        // Real name (5 points)
        maxScore += 5;
        if (card.realName && !isGibberish(card.realName)) {
            breakdown.realName = 5;
            totalScore += 5;
        } else {
            breakdown.realName = 0;
        }
        
        // Handle (5 points)
        maxScore += 5;
        if (card.handle && card.handle.length > 1) {
            breakdown.handle = 5;
            totalScore += 5;
        } else {
            breakdown.handle = 0;
        }
        
        // Affiliation/Team (5 points)
        maxScore += 5;
        if ((card.affiliation && !isGibberish(card.affiliation)) || (card.team && !isGibberish(card.team))) {
            breakdown.team = 5;
            totalScore += 5;
        } else {
            breakdown.team = 0;
        }
        
        // Custom stat labels (5 points for customization)
        maxScore += 5;
        const defaultLabels = ['PWR', 'SPD', 'INT'];
        if (card.stat1Label && !defaultLabels.includes(card.stat1Label)) breakdown.customStats = 5;
        else breakdown.customStats = 0;
        totalScore += breakdown.customStats;
        
        return {
            score: totalScore,
            maxScore: maxScore,
            percentage: Math.round((totalScore / maxScore) * 100),
            breakdown: breakdown,
            grade: totalScore >= 80 ? 'S' : totalScore >= 60 ? 'A' : totalScore >= 40 ? 'B' : totalScore >= 20 ? 'C' : 'D'
        };
    }
    
    // Get stat multiplier based on card origin and quality
    function getCardMultipliers(card) {
        const origin = S.CARD_ORIGINS[card.origin] || S.CARD_ORIGINS['pack_bronze'];
        const quality = calculateCardQuality(card);
        
        // Base multiplier from origin
        let statMultiplier = origin.statBonus;
        let xpMultiplier = origin.xpMultiplier;
        let pointsMultiplier = origin.pointsBonus;
        
        // Quality bonus (up to +20% for perfect score)
        const qualityBonus = 1 + (quality.percentage / 500); // Max +20%
        statMultiplier *= qualityBonus;
        pointsMultiplier *= qualityBonus;
        
        return {
            stats: statMultiplier,
            xp: xpMultiplier,
            points: pointsMultiplier,
            quality: quality
        };
    }
    
    // Apply creation bonuses to card stats
    function applyCreationBonuses(card) {
        const multipliers = getCardMultipliers(card);
        
        // Store original stats
        card.baseStats = { ...card.stats };
        
        // Apply stat bonus
        if (multipliers.stats > 1) {
            card.stats.pwr = Math.min(100, Math.round(card.stats.pwr * multipliers.stats));
            card.stats.spd = Math.min(100, Math.round(card.stats.spd * multipliers.stats));
            card.stats.int = Math.min(100, Math.round(card.stats.int * multipliers.stats));
        }
        
        // Store multipliers for display
        card.multipliers = multipliers;
        card.qualityGrade = multipliers.quality.grade;
        card.qualityScore = multipliers.quality.percentage;
        
        return card;
    }
    
    // ========== PACK SYSTEM ==========
    
    // Generate a random AI card for packs
    function generatePackCard(packType, guaranteedRarity = null) {
        // Determine rarity
        const packConfig = S.PACK_TYPES.find(p => p.id === packType);
        let rarity = guaranteedRarity;
        
        if (!rarity) {
            const weights = packConfig.rarityWeights;
            const totalWeight = Object.values(weights).reduce((a, b) => a + b, 0);
            let roll = Math.random() * totalWeight;
            
            for (const [r, weight] of Object.entries(weights)) {
                roll -= weight;
                if (roll <= 0) {
                    rarity = r;
                    break;
                }
            }
        }
        
        // Pick random archetype
        const archetype = S.CARD_ARCHETYPES[Math.floor(Math.random() * S.CARD_ARCHETYPES.length)];
        
        // Generate name with more variety
        const useTitle = Math.random() > 0.4;
        const useSuffix = Math.random() > 0.6;
        const baseName = archetype.names[Math.floor(Math.random() * archetype.names.length)];
        let name = baseName;
        
        if (useTitle) {
            const title = S.CARD_TITLES[Math.floor(Math.random() * S.CARD_TITLES.length)];
            name = `${title} ${baseName}`;
        }
        if (useSuffix) {
            const suffix = S.CARD_SUFFIXES[Math.floor(Math.random() * S.CARD_SUFFIXES.length)];
            name = `${name} ${suffix}`;
        }
        
        // Pick RANDOM template from ALL available (not just archetype-specific)
        const allTemplates = S.CARD_TEMPLATES || ['classic', 'retro', 'neon', 'tcg', 'premium', 'minimal'];
        const template = allTemplates[Math.floor(Math.random() * allTemplates.length)];
        
        // Generate random accent color for variety
        const accentColors = [
            '#ff6b6b', '#4ecdc4', '#ffe66d', '#95e1d3', '#f38181', 
            '#aa96da', '#fcbad3', '#a8d8ea', '#ff9f43', '#6c5ce7',
            '#00cec9', '#fd79a8', '#74b9ff', '#55efc4', '#ffeaa7',
            '#dfe6e9', '#b2bec3', '#636e72', '#2d3436', '#e17055'
        ];
        const accentColor = accentColors[Math.floor(Math.random() * accentColors.length)];
        
        // Generate card number/edition for collectibility
        const cardNumber = Math.floor(Math.random() * 999) + 1;
        const edition = Math.random() > 0.95 ? '1ST EDITION' : Math.random() > 0.8 ? 'LIMITED' : 'STANDARD';
        const serialNumber = `#${String(cardNumber).padStart(3, '0')}/${edition === '1ST EDITION' ? '100' : edition === 'LIMITED' ? '500' : '999'}`;
        
        // Holographic/foil chance based on rarity
        const holoChance = { 'COMMON': 0.05, 'UNCOMMON': 0.15, 'RARE': 0.35, 'EPIC': 0.6, 'LEGENDARY': 0.85, 'MYTHIC': 1.0 };
        const isHolo = Math.random() < (holoChance[rarity] || 0.1);
        
        // Random avatar from archetype
        const avatars = S.CARD_AVATARS[archetype.type] || [''];
        const avatar = avatars[Math.floor(Math.random() * avatars.length)];
        
        // Generate AI image using Pollinations
        const cardSeed = Date.now() + Math.floor(Math.random() * 10000);
        
        // Build AI prompt based on archetype and rarity
        const rarityStyles = {
            'COMMON': 'simple, clean lines, basic shading',
            'UNCOMMON': 'detailed, dynamic pose, good lighting',
            'RARE': 'highly detailed, dramatic lighting, epic composition',
            'EPIC': 'ultra detailed, cinematic lighting, powerful aura, glowing effects',
            'LEGENDARY': 'masterpiece, hyper detailed, golden hour lighting, legendary aura, particle effects',
            'MYTHIC': 'godlike, transcendent, reality-bending visuals, cosmic energy, divine presence'
        };
        
        const archetypePrompts = {
            'hero': ['heroic superhero, muscular build, cape flowing, confident pose', 'brave hero standing tall, fists raised, determined expression', 'flying superhero, arms outstretched, city below', 'hero in action, saving civilians, dynamic angle'],
            'villain': ['dark villain, menacing stance, shadowy background', 'evil mastermind, sinister grin, dark throne', 'powerful antagonist, destructive powers, chaos around', 'mysterious villain, hooded figure, glowing eyes'],
            'monster': ['fearsome beast, sharp fangs and claws, roaring', 'ancient creature, scales and horns, intimidating size', 'nightmare monster, tentacles, otherworldly', 'primal beast, fur and muscles, hunting pose'],
            'robot': ['advanced mech suit, glowing core, combat ready', 'sleek android, chrome finish, LED eyes', 'battle robot, heavy armor, weapons systems', 'futuristic cyborg, half human half machine'],
            'mystic': ['powerful wizard, casting spell, magic circles', 'ancient sorcerer, flowing robes, staff raised', 'ethereal mage, floating, surrounded by energy', 'dark magician, arcane symbols, mystical fog'],
            'warrior': ['armored knight, sword drawn, battle stance', 'fierce samurai, katana ready, focused', 'barbarian warrior, dual axes, war cry', 'elite soldier, tactical gear, combat ready'],
            'speedster': ['blur of motion, lightning trail, running fast', 'speed demon, aerodynamic suit, wind effects', 'time manipulator, frozen moment, fast forward', 'racing hero, sonic boom, ground cracking'],
            'psychic': ['mind reader, glowing purple eyes, telepathic waves', 'telekinetic master, objects floating, concentration', 'psychic warrior, mental energy, third eye open', 'astral projector, spirit form, cosmic background']
        };
        
        // Random art styles for variety
        const artStyles = [
            'anime art style, vibrant colors, cel shaded',
            'comic book art, bold lines, halftone dots',
            'digital painting, realistic rendering, dramatic',
            'manga style, black and white with color accents',
            'concept art, painterly, atmospheric',
            'retro 80s style, neon colors, synthwave aesthetic'
        ];
        
        // Random backgrounds
        const backgrounds = [
            'epic cityscape background', 'dark mysterious void', 'cosmic space nebula',
            'ancient temple ruins', 'futuristic tech lab', 'fiery volcanic landscape',
            'stormy sky with lightning', 'mystical forest glow', 'abstract energy patterns'
        ];
        
        // Random poses
        const poses = [
            'action pose', 'standing heroic', 'battle ready stance', 
            'dramatic angle from below', 'side profile view', 'floating mid-air'
        ];
        
        // Select random elements
        const archetypeOptions = archetypePrompts[archetype.type] || ['powerful character'];
        const basePrompt = archetypeOptions[Math.floor(Math.random() * archetypeOptions.length)];
        const stylePrompt = rarityStyles[rarity] || 'detailed';
        const artStyle = artStyles[Math.floor(Math.random() * artStyles.length)];
        const background = backgrounds[Math.floor(Math.random() * backgrounds.length)];
        const pose = poses[Math.floor(Math.random() * poses.length)];
        
        // Combine into full prompt with lots of variety
        const fullPrompt = encodeURIComponent(`${basePrompt}, ${pose}, ${background}, ${stylePrompt}, ${artStyle}, trading card game character, portrait format, no text, no watermark, high quality`);
        
        // Use Pollinations AI for image generation
        const frontImage = `https://image.pollinations.ai/prompt/${fullPrompt}?width=400&height=560&seed=${cardSeed}&nologo=true`;
        
        // Generate stats based on rarity
        const pool = S.RARITY_CONFIG[rarity].statPointPool;
        const pwr = Math.floor(Math.random() * Math.min(100, pool * 0.45)) + Math.floor(pool * 0.1);
        const remaining = pool - pwr;
        const spd = Math.floor(Math.random() * Math.min(100, remaining * 0.55)) + Math.floor(pool * 0.1);
        const int = Math.min(100, Math.max(10, pool - pwr - spd));
        
        // Generate backstory
        const backstoryTemplate = S.CARD_BACKSTORIES[Math.floor(Math.random() * S.CARD_BACKSTORIES.length)];
        const bio = backstoryTemplate.replace('{name}', baseName);
        
        // Generate abilities
        const numAbilities = rarity === 'MYTHIC' ? 3 : rarity === 'LEGENDARY' ? 2 : 1;
        const abilities = [];
        const availableAbilities = [...S.CARD_ABILITIES];
        for (let i = 0; i < numAbilities; i++) {
            const idx = Math.floor(Math.random() * availableAbilities.length);
            abilities.push(availableAbilities.splice(idx, 1)[0]);
        }
        
        // Generate quote
        const quote = S.CARD_QUOTES[Math.floor(Math.random() * S.CARD_QUOTES.length)];
        
        // Create card object
        const card = {
            id: 'pack_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
            name: name,
            title: rarity === 'MYTHIC' ? 'MYTHIC HERO' : rarity === 'LEGENDARY' ? 'LEGENDARY' : edition === '1ST EDITION' ? '1ST EDITION' : 'HERO CARD',
            rarity: rarity,
            template: template,
            origin: 'pack_' + packType,
            frontImage: frontImage, // AI-generated character art!
            avatar: avatar,
            archetype: archetype.type,
            stats: { pwr, spd, int },
            bio: bio,
            abilities: abilities.join(', '),
            quote: quote,
            handle: '@' + baseName.toLowerCase().replace(/\s+/g, '_'),
            stat1Label: 'PWR',
            stat2Label: 'SPD',
            stat3Label: 'INT',
            createdAt: new Date().toISOString(),
            xp: 0,
            level: 0,
            durability: 100,
            battlesPlayed: 0,
            battlesWon: 0,
            battlesLost: 0,
            evolutionState: 'BASE',
            isPackCard: true,
            // NEW variety properties
            accentColor: accentColor,
            serialNumber: serialNumber,
            edition: edition,
            isHolo: isHolo,
            cardNumber: cardNumber
        };
        
        return card;
    }
    
    // Open a pack
    function openPack(packType) {
        const packConfig = S.PACK_TYPES.find(p => p.id === packType);
        if (!packConfig) {
            toast(' Invalid pack type!');
            return;
        }
        
        // Check one-time packs
        if (packConfig.oneTime && S.starterPackClaimed) {
            toast(' You already claimed your starter pack!');
            return;
        }
        
        // Check credits
        if (packConfig.cost > 0 && S.user.credits < packConfig.cost) {
            toast(` Need ${packConfig.cost} credits! You have ${S.user.credits}`);
            return;
        }
        
        // Spend credits
        if (packConfig.cost > 0) {
            S.user.credits -= packConfig.cost;
        }
        
        // Mark starter claimed
        if (packConfig.oneTime) {
            S.starterPackClaimed = true;
        }
        
        // Generate cards
        const cards = [];
        for (let i = 0; i < packConfig.cards; i++) {
            // Gold/Mythic packs guarantee at least one high rarity
            let guaranteedRarity = null;
            if (i === 0) {
                if (packType === 'gold') guaranteedRarity = 'EPIC';
                if (packType === 'mythic') guaranteedRarity = 'LEGENDARY';
            }
            cards.push(generatePackCard(packType, guaranteedRarity));
        }
        
        // Sort by rarity (best last for reveal)
        const rarityOrder = ['COMMON', 'UNCOMMON', 'RARE', 'EPIC', 'LEGENDARY', 'MYTHIC'];
        cards.sort((a, b) => rarityOrder.indexOf(a.rarity) - rarityOrder.indexOf(b.rarity));
        
        // Start pack opening experience
        S.packOpening = {
            packType: packType,
            packConfig: packConfig,
            cards: cards,
            currentIndex: -1, // -1 = showing pack, 0+ = revealing cards
            phase: 'intro', // intro, revealing, complete
            revealedCards: []
        };
        
        S.activeSheet = 'pack-opening';
        saveUserData();
        render();
    }
    
    // Reveal next card in pack
    function revealNextCard() {
        if (!S.packOpening) return;
        
        S.packOpening.currentIndex++;
        
        if (S.packOpening.currentIndex >= S.packOpening.cards.length) {
            // All cards revealed
            S.packOpening.phase = 'complete';
            
            // Add all cards to collection
            S.packOpening.cards.forEach(card => {
                S.cardCollection.push(card);
            });
            
            // Update collection stats
            updateCollectionStats();
            checkMilestones();
            
            // Track pack opened event
            trackEvent('pack_opened', {
                pack_type: S.packOpening.packType,
                cards_received: S.packOpening.cards.length
            });
            trackActivity('pack_opened', { packType: S.packOpening.packType });
            
            saveUserData();
        } else {
            S.packOpening.phase = 'revealing';
            const card = S.packOpening.cards[S.packOpening.currentIndex];
            S.packOpening.revealedCards.push(card);
            
            // Play reveal effects based on rarity
            if (card.rarity === 'MYTHIC') {
                toast(' MYTHIC PULL! ');
            } else if (card.rarity === 'LEGENDARY') {
                toast(' LEGENDARY! ');
            } else if (card.rarity === 'EPIC') {
                toast(' EPIC! ');
            }
        }
        
        render();
    }
    
    // Close pack opening
    function closePackOpening() {
        S.packOpening = null;
        S.activeSheet = null;
        render();
    }
    
    // Update collection stats
    function updateCollectionStats() {
        S.collectionStats = {
            totalCards: S.cardCollection.length,
            createdCards: S.cardCollection.filter(c => c.origin?.startsWith('created')).length,
            packCards: S.cardCollection.filter(c => c.origin?.startsWith('pack')).length,
            wonCards: S.cardCollection.filter(c => c.origin === 'won_battle').length,
            byRarity: {
                COMMON: S.cardCollection.filter(c => c.rarity === 'COMMON').length,
                UNCOMMON: S.cardCollection.filter(c => c.rarity === 'UNCOMMON').length,
                RARE: S.cardCollection.filter(c => c.rarity === 'RARE').length,
                EPIC: S.cardCollection.filter(c => c.rarity === 'EPIC').length,
                LEGENDARY: S.cardCollection.filter(c => c.rarity === 'LEGENDARY').length,
                MYTHIC: S.cardCollection.filter(c => c.rarity === 'MYTHIC').length
            }
        };
    }
    
    // Check milestones
    function checkMilestones() {
        const total = S.cardCollection.length;
        
        S.COLLECTION_MILESTONES.forEach(milestone => {
            if (total >= milestone.cards && !S.claimedMilestones?.includes(milestone.cards)) {
                if (!S.claimedMilestones) S.claimedMilestones = [];
                S.claimedMilestones.push(milestone.cards);
                
                if (milestone.reward > 0) {
                    S.user.credits += milestone.reward;
                    toast(` MILESTONE! ${milestone.cards} cards - ${milestone.badge} +${milestone.reward} `);
                } else {
                    toast(` MILESTONE! ${milestone.cards} cards - ${milestone.badge}`);
                }
            }
        });
    }
    
    // Render pack shop - B&W CYBER STYLE
    function renderPackShop() {
        if (S.activeSheet !== 'pack-shop') return '';
        
        return `
            <div class="sheet show" style="max-height:95vh;background:#0a0a0a">
                <div class="sheet-handle" style="background:#333"></div>
                <div class="sheet-header" style="background:#111;border-bottom:1px solid #333">
                    <span class="sheet-title" style="font-family:'Bebas Neue',sans-serif;letter-spacing:3px"> CARD SHOP</span>
                    <button class="sheet-close" onclick="S.activeSheet=null;render()" style="background:#222;border:1px solid #444">${icon('x', 18)}</button>
                </div>
                <div class="sheet-body" style="max-height:85vh;overflow-y:auto;padding-bottom:100px;background:#0a0a0a">
                    
                    <!-- Credits Display - B&W -->
                    <div style="background:linear-gradient(135deg,#151515,#0a0a0a);border-radius:16px;padding:20px;margin-bottom:20px;text-align:center;border:1px solid #333">
                        <div style="font-size:12px;color:#666;margin-bottom:8px;letter-spacing:2px">YOUR CREDITS</div>
                        <div style="font-size:48px;font-weight:bold;color:#fff"> ${S.user.credits}</div>
                        <div style="font-size:11px;color:#555;margin-top:8px">Collection: ${S.cardCollection.length}/52 cards</div>
                    </div>
                    
                    <!-- Starter Pack (if not claimed) - B&W -->
                    ${!S.starterPackClaimed ? `
                        <button onclick="openPack('starter')" class="cyber-btn" style="width:100%;padding:20px;margin-bottom:16px;background:linear-gradient(180deg,#1a1a1a,#0a0a0a);border-color:#fff;position:relative;overflow:hidden">
                            <div style="position:absolute;top:8px;right:8px;background:#fff;color:#000;padding:4px 12px;font-size:10px;font-weight:bold;border-radius:4px">FREE!</div>
                            <div style="display:flex;align-items:center;gap:16px;width:100%">
                                <div style="font-size:40px"></div>
                                <div style="flex:1;text-align:left">
                                    <div style="font-size:16px;font-weight:bold;color:#fff">STARTER PACK</div>
                                    <div style="font-size:11px;color:#888;margin:4px 0;text-transform:none;letter-spacing:0">5 cards to begin your journey!</div>
                                </div>
                            </div>
                        </button>
                    ` : ''}
                    
                    <!-- Pack Grid - B&W -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                        ${S.PACK_TYPES.filter(p => !p.oneTime).map(pack => `
                            <button onclick="${S.user.credits >= pack.cost ? `openPack('${pack.id}')` : ''}" 
                                class="cyber-btn" style="flex-direction:column;padding:16px;height:auto;background:linear-gradient(180deg,#151515,#080808);border-color:${S.user.credits >= pack.cost ? '#444' : '#222'};opacity:${S.user.credits >= pack.cost ? '1' : '0.4'};cursor:${S.user.credits >= pack.cost ? 'pointer' : 'not-allowed'}">
                                <div style="text-align:center;width:100%">
                                    <div style="font-size:32px;margin-bottom:8px">${pack.icon}</div>
                                    <div style="font-size:13px;font-weight:bold;color:#fff">${pack.name}</div>
                                    <div style="font-size:10px;color:#666;margin:6px 0;line-height:1.4;text-transform:none;letter-spacing:0">${pack.description}</div>
                                    <div style="font-size:9px;color:#555;margin-bottom:8px">${pack.cards} cards</div>
                                    <div style="padding:8px 16px;background:#222;border-radius:6px;display:inline-block;border:1px solid #333">
                                        <span style="font-size:13px;font-weight:bold;color:#fff"> ${pack.cost}</span>
                                    </div>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                    
                    <!-- Pack Odds Info - B&W -->
                    <div style="margin-top:20px;padding:16px;background:#111;border-radius:12px;border:1px solid #222">
                        <div style="font-size:11px;color:#555;margin-bottom:12px;text-align:center;letter-spacing:2px">RARITY ODDS</div>
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;text-align:center">
                            <div style="padding:8px;background:#0a0a0a;border-radius:8px;border:1px solid #222">
                                <div style="font-size:10px;color:#888">Bronze</div>
                                <div style="font-size:8px;color:#555;margin-top:4px">70% C / 25% U / 5% R</div>
                            </div>
                            <div style="padding:8px;background:#0a0a0a;border-radius:8px;border:1px solid #222">
                                <div style="font-size:10px;color:#888">Silver</div>
                                <div style="font-size:8px;color:#555;margin-top:4px">50% U / 25% R / 5% E</div>
                            </div>
                            <div style="padding:8px;background:#0a0a0a;border-radius:8px;border:1px solid #222">
                                <div style="font-size:10px;color:#888">Gold</div>
                                <div style="font-size:8px;color:#555;margin-top:4px">Epic guaranteed!</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Creation Bonus Info - B&W -->
                    <div style="margin-top:16px;padding:16px;background:#111;border-radius:12px;border:1px solid #444">
                        <div style="font-size:11px;color:#fff;margin-bottom:8px;font-weight:bold;letter-spacing:1px"> CREATE YOUR OWN!</div>
                        <div style="font-size:10px;color:#888;line-height:1.6">
                            Created cards get <strong style="color:#fff">BONUS STATS</strong>:<br>
                             Photo cards: +10% stats, 1.5x XP<br>
                             Hand-drawn: +15% stats, 2x XP<br>
                             Animated: +20% stats, 2.5x XP<br>
                            <span style="color:#999">More detail = More bonuses!</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Render pack opening experience
    function renderPackOpening() {
        if (S.activeSheet !== 'pack-opening' || !S.packOpening) return '';
        
        const po = S.packOpening;
        const pack = po.packConfig;
        const currentCard = po.currentIndex >= 0 && po.currentIndex < po.cards.length ? po.cards[po.currentIndex] : null;
        
        return `
            <div style="position:fixed;inset:0;background:linear-gradient(180deg,#0a0a1a,#1a0a2e);z-index:10001;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px">
                
                ${po.phase === 'intro' ? `
                    <!-- Pack Intro -->
                    <div style="text-align:center;animation:packFloat 2s ease-in-out infinite">
                        <div style="font-size:120px;margin-bottom:20px;filter:drop-shadow(0 0 30px ${pack.color})">${pack.icon}</div>
                        <div style="font-family:'Bangers',cursive;font-size:32px;color:${pack.color};margin-bottom:10px">${pack.name.toUpperCase()}</div>
                        <div style="font-size:14px;color:#888;margin-bottom:30px">${pack.cards} cards inside!</div>
                        <button onclick="revealNextCard()" style="padding:16px 40px;border-radius:30px;border:none;background:linear-gradient(135deg,${pack.color},#fff);color:#000;font-size:18px;font-weight:bold;cursor:pointer;animation:pulse 1.5s infinite">
                            TAP TO OPEN
                        </button>
                    </div>
                ` : po.phase === 'revealing' && currentCard ? `
                    <!-- Card Reveal -->
                    <div style="text-align:center">
                        <div style="font-size:14px;color:#888;margin-bottom:20px">Card ${po.currentIndex + 1} of ${po.cards.length}</div>
                        
                        <div style="position:relative;width:200px;height:280px;margin:0 auto 20px;perspective:1000px">
                            <div style="width:100%;height:100%;background:linear-gradient(135deg,#1a1a2e,#0f0f1a);border-radius:16px;border:4px solid ${getRarityColor(currentCard.rarity)};box-shadow:0 0 40px ${getRarityColor(currentCard.rarity)};padding:12px;display:flex;flex-direction:column;animation:cardReveal 0.5s ease-out">
                                <div style="font-size:10px;color:${getRarityColor(currentCard.rarity)};text-align:left">${currentCard.rarity}</div>
                                <div style="flex:1;background:#222;border-radius:12px;margin:8px 0;display:flex;align-items:center;justify-content:center;font-size:64px">
                                    ${currentCard.avatar || ''}
                                </div>
                                <div style="font-size:16px;font-weight:bold;color:#fff;text-align:center">${currentCard.name}</div>
                                <div style="display:flex;justify-content:center;gap:8px;margin-top:8px">
                                    <span style="font-size:10px;color:#888">PWR ${currentCard.stats.pwr}</span>
                                    <span style="font-size:10px;color:#ccc">SPD ${currentCard.stats.spd}</span>
                                    <span style="font-size:10px;color:#bbb">INT ${currentCard.stats.int}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="font-size:12px;color:#888;margin-bottom:20px">${currentCard.archetype?.toUpperCase() || 'HERO'}</div>
                        
                        <button onclick="revealNextCard()" style="padding:14px 36px;border-radius:25px;border:none;background:linear-gradient(135deg,#999,#d97706);color:#000;font-size:16px;font-weight:bold;cursor:pointer">
                            ${po.currentIndex + 1 < po.cards.length ? ' NEXT CARD' : ' FINISH'}
                        </button>
                    </div>
                ` : `
                    <!-- Complete -->
                    <div style="text-align:center">
                        <div style="font-size:64px;margin-bottom:20px"></div>
                        <div style="font-family:'Bangers',cursive;font-size:28px;color:#fff;margin-bottom:20px">PACK COMPLETE!</div>
                        
                        <div style="display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin-bottom:30px">
                            ${po.cards.map(card => `
                                <div style="width:60px;height:80px;background:linear-gradient(135deg,#1a1a2e,#0f0f1a);border-radius:8px;border:2px solid ${getRarityColor(card.rarity)};display:flex;flex-direction:column;align-items:center;justify-content:center;padding:4px">
                                    <div style="font-size:24px">${card.avatar || ''}</div>
                                    <div style="font-size:8px;color:${getRarityColor(card.rarity)};margin-top:2px">${card.rarity}</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="font-size:12px;color:#888;margin-bottom:20px">
                            ${po.cards.filter(c => c.rarity === 'LEGENDARY' || c.rarity === 'MYTHIC').length > 0 ? ' Amazing pulls!' : 'Added to your collection!'}
                        </div>
                        
                        <button onclick="closePackOpening()" style="padding:14px 36px;border-radius:25px;border:none;background:#fff;color:#000;font-size:16px;font-weight:bold;cursor:pointer">
                             AWESOME!
                        </button>
                    </div>
                `}
            </div>
            
            <style>
                @keyframes packFloat {
                    0%, 100% { transform: translateY(0) rotate(-2deg); }
                    50% { transform: translateY(-10px) rotate(2deg); }
                }
                @keyframes cardReveal {
                    from { transform: rotateY(180deg) scale(0.5); opacity: 0; }
                    to { transform: rotateY(0) scale(1); opacity: 1; }
                }
            </style>
        `;
    }
    
    // ========== BATTLE SYSTEM V2 - FOR KEEPS ==========
    
    function startBattle(type = 'friendly') {
        S.battleMode = true;
        S.battleType = type;
        S.battleOpponent = generateRandomOpponent();
        S.battleResult = null;
        S.battleRound = 0;
        S.battleScores = { you: 0, opponent: 0 };
        S.battleRounds = [];
        trackEvent('battle_started', { battle_type: type });
        render();
    }
    
    function generateRandomOpponent() {
        const names = ['Shadow Wolf', 'Blaze Phoenix', 'Storm Titan', 'Frost Giant', 'Thunder Bear', 'Cyber Dragon', 'Mystic Sage', 'Iron Golem', 'Void Walker', 'Star Crusher', 'Neon Ninja', 'Crystal Witch'];
        const avatars = ['', '', '', '', '', '', '', '', '', '', '', ''];
        const rarities = ['COMMON', 'UNCOMMON', 'RARE', 'EPIC', 'LEGENDARY'];
        
        // Match difficulty to player's rarity
        const playerRarityIdx = rarities.indexOf(S.card.rarity);
        const oppRarityIdx = Math.max(0, Math.min(rarities.length - 1, playerRarityIdx + Math.floor(Math.random() * 3) - 1));
        const rarity = rarities[oppRarityIdx];
        const pool = S.RARITY_POOLS[rarity];
        
        // Distribute points randomly but fairly
        const pwr = Math.floor(Math.random() * Math.min(100, pool * 0.5)) + 10;
        const remaining = pool - pwr;
        const spd = Math.floor(Math.random() * Math.min(100, remaining * 0.6)) + 10;
        const int = Math.min(100, pool - pwr - spd);
        
        const idx = Math.floor(Math.random() * names.length);
        
        return {
            id: 'opp_' + Date.now(),
            name: names[idx],
            avatar: avatars[idx],
            rarity: rarity,
            stats: { pwr, spd, int },
            totalPower: pwr + spd + int,
            handle: '@' + names[idx].toLowerCase().replace(' ', '_')
        };
    }
    
    function battleStat(stat) {
        const myVal = S.card.stats[stat] || 0;
        const oppVal = S.battleOpponent.stats[stat] || 0;
        
        // Add some randomness (10%)
        const myRoll = myVal * (0.9 + Math.random() * 0.2);
        const oppRoll = oppVal * (0.9 + Math.random() * 0.2);
        
        let roundWinner;
        if (myRoll > oppRoll) {
            roundWinner = 'you';
            S.battleScores.you++;
        } else if (oppRoll > myRoll) {
            roundWinner = 'opponent';
            S.battleScores.opponent++;
        } else {
            roundWinner = 'tie';
        }
        
        S.battleRounds.push({ stat, myVal, oppVal, winner: roundWinner, margin: Math.abs(Math.round(myRoll - oppRoll)) });
        S.battleRound++;
        
        // Check if battle is over (best of 3)
        if (S.battleScores.you >= 2 || S.battleScores.opponent >= 2 || S.battleRound >= 3) {
            finalizeBattle();
        } else {
            render();
        }
    }
    
    function finalizeBattle() {
        const won = S.battleScores.you > S.battleScores.opponent;
        const tied = S.battleScores.you === S.battleScores.opponent;
        
        S.battleResult = {
            winner: won ? 'you' : (tied ? 'tie' : 'opponent'),
            scores: { ...S.battleScores },
            rounds: [...S.battleRounds]
        };
        
        // Apply rewards/penalties based on battle type
        if (won) {
            S.battleRecord.wins++;
            if (S.battleType === 'friendly') {
                earnCredits('win_battle');
            } else if (S.battleType === 'keeps') {
                earnCredits('win_battle_keeps');
                // Win opponent's card!
                const wonCard = {
                    id: 'card_' + Date.now(),
                    name: S.battleOpponent.name,
                    rarity: S.battleOpponent.rarity,
                    stats: { ...S.battleOpponent.stats },
                    template: 'classic',
                    origin: 'won_battle',
                    wonFrom: S.battleOpponent.handle,
                    wonFromPlayer: S.battleOpponent.name,
                    category: 'won', // Auto-categorize as won in battle
                    createdAt: new Date().toISOString(),
                    frontImage: null,
                    bio: `Won in battle from ${S.battleOpponent.handle}`,
                    title: 'BATTLE TROPHY',
                    stat1Label: 'PWR',
                    stat2Label: 'SPD',
                    stat3Label: 'INT'
                };
                S.cardCollection.push(wonCard);
                toast(` WON "${S.battleOpponent.name}" card!`);
            }
        } else if (!tied && S.battleType === 'keeps') {
            S.battleRecord.losses++;
            // Lose your wagered card!
            if (S.battleWageredCard !== null && S.cardCollection.length > 1) {
                const lostCard = S.cardCollection[S.battleWageredCard];
                if (!lostCard.locked) {
                    S.cardCollection.splice(S.battleWageredCard, 1);
                    toast(` LOST "${lostCard.name}" card!`);
                }
            }
        } else {
            S.battleRecord.losses++;
        }
        
        // Log battle history
        S.battleHistory.push({
            date: new Date().toISOString(),
            opponent: S.battleOpponent.name,
            type: S.battleType,
            result: S.battleResult.winner,
            scores: S.battleResult.scores
        });
        
        // Track battle completion
        trackEvent('battle_complete', {
            battle_type: S.battleType,
            result: S.battleResult.winner,
            player_score: S.battleScores.you,
            opponent_score: S.battleScores.opponent
        });
        trackActivity('battle_complete', { type: S.battleType, result: S.battleResult.winner });
        
        saveUserData();
        render();
    }
    
    // ========== MULTIPLAYER BATTLE SYSTEM (FIREBASE) ==========
    
    // Firebase configuration for Press Start Cards
    const firebaseConfig = {
        apiKey: "AIzaSyD6IyObBjrdJ-mgQAO974P04j78Z98gvv8",
        authDomain: "pscomixxcards.firebaseapp.com",
        databaseURL: "https://pscomixxcards-default-rtdb.firebaseio.com",
        projectId: "pscomixxcards",
        storageBucket: "pscomixxcards.firebasestorage.app",
        messagingSenderId: "604754061354",
        appId: "1:604754061354:web:771f0f4b99759ff0827b53",
        measurementId: "G-HLMLY9K2FZ"
    };
    
    // Initialize Firebase (with fallback)
    let firebaseDb = null;
    let firebaseReady = false;
    let firebaseAuth = null;
    let currentUser = null;
    
    function initFirebase() {
        try {
            if (typeof firebase !== 'undefined' && !firebase.apps?.length) {
                firebase.initializeApp(firebaseConfig);
                firebaseDb = firebase.database();
                firebaseAuth = firebase.auth();
                firebaseReady = true;
                
                
                // Handle redirect result (for mobile sign-in) - MUST be called first
                firebaseAuth.getRedirectResult()
                    .then((result) => {
                        if (result && result.user) {
                            
                            const user = result.user;
                            S.playerName = user.displayName || user.email?.split('@')[0] || 'Player';
                            S.playerEmail = user.email;
                            S.playerPhoto = user.photoURL;
                            S.isSignedIn = true;
                            saveState();
                            toast('Welcome, ' + S.playerName + '!');
                            render();
                        }
                    })
                    .catch((error) => {
                        if (error.code !== 'auth/no-auth-event') {
                            console.error('Redirect result error:', error);
                            toast('Sign-in error: ' + error.code);
                        }
                    });
                
                // Listen for auth state changes
                firebaseAuth.onAuthStateChanged((user) => {
                    currentUser = user;
                    if (user) {
                        S.playerName = user.displayName || user.email?.split('@')[0] || 'Player';
                        S.playerEmail = user.email;
                        S.playerPhoto = user.photoURL;
                        S.isSignedIn = true;
                        saveState();
                        
                        
                        // Track sign in
                        trackEvent('login', { method: 'Google' });
                    } else {
                        S.isSignedIn = false;
                        S.playerPhoto = null;
                    }
                    render();
                });
            } else if (firebase.apps?.length) {
                firebaseDb = firebase.database();
                firebaseAuth = firebase.auth();
                firebaseReady = true;
            }
        } catch (e) {
            console.log('Firebase not available, using demo mode:', e.message);
            firebaseReady = false;
        }
    }
    
    // Google Sign-In
    function signInWithGoogle() {
        toast('Attempting sign-in...');
        
        
        
        
        
        if (!firebaseAuth) {
            toast('ERROR: Firebase not loaded!');
            alert('Firebase Auth is not available. Please check your internet connection and refresh the page.');
            return;
        }
        
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.addScope('email');
        provider.addScope('profile');
        provider.setCustomParameters({ prompt: 'select_account' });
        
        // Always try popup first - works on both desktop and mobile
        toast('Opening Google sign-in...');
        
        firebaseAuth.signInWithPopup(provider)
            .then((result) => {
                
                const user = result.user;
                S.playerName = user.displayName || user.email?.split('@')[0] || 'Player';
                S.playerEmail = user.email;
                S.playerPhoto = user.photoURL;
                S.isSignedIn = true;
                saveState();
                toast('Welcome, ' + S.playerName + '!');
                render();
            })
            .catch((error) => {
                console.error('Sign-in error:', error.code, error.message);
                
                if (error.code === 'auth/popup-closed-by-user') {
                    toast('Sign-in cancelled');
                } else if (error.code === 'auth/popup-blocked') {
                    toast('Popup blocked - check your browser settings');
                    alert('Your browser blocked the sign-in popup.\n\nPlease allow popups for this site, or try a different browser.');
                } else if (error.code === 'auth/unauthorized-domain') {
                    toast('Domain not authorized!');
                    alert('This domain is not authorized.\n\nDomain: ' + window.location.hostname);
                } else {
                    toast('Sign-in failed: ' + error.code);
                }
            });
    }
    
    // Handle redirect result (for mobile sign-in)
    function handleRedirectResult() {
        if (!firebaseAuth) return;
        
        firebaseAuth.getRedirectResult()
            .then((result) => {
                if (result && result.user) {
                    const user = result.user;
                    S.playerName = user.displayName || 'Player';
                    S.playerEmail = user.email;
                    S.playerPhoto = user.photoURL;
                    S.isSignedIn = true;
                    saveState();
                    toast('Welcome, ' + S.playerName + '!');
                    render();
                }
            })
            .catch((error) => {
                if (error.code !== 'auth/no-auth-event') {
                    console.error('Redirect result error:', error);
                }
            });
    }
    
    // Sign Out
    function signOut() {
        if (!firebaseAuth) return;
        
        firebaseAuth.signOut()
            .then(() => {
                S.isSignedIn = false;
                S.playerPhoto = null;
                toast('Signed out');
                render();
            })
            .catch((error) => {
                console.error('Sign-out error:', error);
            });
    }
    
    // ============ ADMIN CONFIGURATION ============
    // Change these values to update admin access
    const ADMIN_PASSWORD = 'Tykneet0308!';
    const ADMIN_EMAILS = ['mojocreative1@gmail.com']; // Add emails here to grant access
    // ===============================================
    
    // Admin verification
    function verifyAdmin() {
        const passInput = document.getElementById('adminPass');
        const enteredPass = passInput?.value || '';
        
        // Check password first
        if (enteredPass !== ADMIN_PASSWORD) {
            toast('Invalid password');
            if (passInput) passInput.value = '';
            return;
        }
        
        // Check email restriction if user is signed in
        if (S.isSignedIn && S.playerEmail) {
            const userEmail = S.playerEmail.toLowerCase();
            const isAuthorized = ADMIN_EMAILS.some(email => email.toLowerCase() === userEmail);
            if (!isAuthorized) {
                toast('Access denied - email not authorized');
                if (passInput) passInput.value = '';
                return;
            }
        }
        
        // Grant admin access
        S.adminMode = true;
        S.activeSheet = 'admin-dashboard';
        loadAdminStats();
        toast('Welcome, Admin!');
        render();
    }
    
    // Admin stats state
    S.adminStats = {
        totalUsers: 0,
        activeToday: 0,
        totalBattles: 0,
        packsOpened: 0,
        revenue: '0.00',
        premiumUsers: 0,
        avgSession: 0,
        cardsCreated: 0,
        comicsExported: 0,
        dailyLogins: 0
    };
    
    // Load admin stats from Firebase
    function loadAdminStats() {
        if (!firebaseReady || !firebaseDb) {
            // Demo stats for testing
            S.adminStats = {
                totalUsers: 47,
                activeToday: 12,
                totalBattles: 234,
                packsOpened: 892,
                revenue: '127.50',
                premiumUsers: 8,
                avgSession: 14,
                cardsCreated: 1456,
                comicsExported: 89,
                dailyLogins: 23
            };
            render();
            return;
        }
        
        // Real Firebase stats
        const statsRef = firebaseDb.ref('admin/stats');
        statsRef.once('value').then((snapshot) => {
            const data = snapshot.val();
            if (data) {
                S.adminStats = { ...S.adminStats, ...data };
            }
            render();
        }).catch((error) => {
            console.error('Error loading admin stats:', error);
        });
    }
    
    // Refresh admin stats
    function refreshAdminStats() {
        toast('Refreshing stats...');
        loadAdminStats();
    }
    
    // Export admin data as CSV
    function exportAdminData() {
        const csvContent = [
            ['Metric', 'Value'],
            ['Total Users', S.adminStats.totalUsers],
            ['Active Today', S.adminStats.activeToday],
            ['Total Battles', S.adminStats.totalBattles],
            ['Packs Opened', S.adminStats.packsOpened],
            ['Revenue', '$' + S.adminStats.revenue],
            ['Premium Users', S.adminStats.premiumUsers],
            ['Avg Session (min)', S.adminStats.avgSession],
            ['Cards Created', S.adminStats.cardsCreated],
            ['Comics Exported', S.adminStats.comicsExported],
            ['Daily Logins (7d avg)', S.adminStats.dailyLogins],
            ['Export Date', new Date().toISOString()]
        ].map(row => row.join(',')).join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'pressstart_analytics_' + new Date().toISOString().split('T')[0] + '.csv';
        a.click();
        URL.revokeObjectURL(url);
        toast('Data exported!');
    }
    
    // Track user activity (call this on key events)
    function trackActivity(eventType, data = {}) {
        if (!firebaseReady || !firebaseDb) return;
        
        const activityRef = firebaseDb.ref('analytics/events').push();
        activityRef.set({
            type: eventType,
            userId: S.multiplayer?.playerId || 'anonymous',
            userName: S.playerName || 'Guest',
            timestamp: Date.now(),
            ...data
        }).catch(console.error);
        
        // Update stats counters
        if (eventType === 'battle_complete') {
            firebaseDb.ref('admin/stats/totalBattles').transaction(val => (val || 0) + 1);
        } else if (eventType === 'pack_opened') {
            firebaseDb.ref('admin/stats/packsOpened').transaction(val => (val || 0) + 1);
        } else if (eventType === 'card_created') {
            firebaseDb.ref('admin/stats/cardsCreated').transaction(val => (val || 0) + 1);
        } else if (eventType === 'comic_exported') {
            firebaseDb.ref('admin/stats/comicsExported').transaction(val => (val || 0) + 1);
        }
    }
    
    // Initialize on load
    setTimeout(initFirebase, 100);
    
    // Multiplayer state
    S.multiplayer = {
        isHost: false,
        battleCode: null,
        opponentCard: null,
        opponentName: null,
        phase: 'idle', // idle, hosting, joining, waiting, selecting, reveal, result
        myChoice: null,
        opponentChoice: null,
        roundNumber: 0,
        myScore: 0,
        opponentScore: 0,
        rounds: [],
        usedStats: [],
        lastSync: null,
        chatMessages: [],
        unsubscribe: null,
        playerId: 'player_' + Math.random().toString(36).substr(2, 9)
    };
    
    // Generate unique battle code
    function generateBattleCode() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let code = '';
        for (let i = 0; i < 6; i++) {
            code += chars[Math.floor(Math.random() * chars.length)];
        }
        return code;
    }
    
    // Serialize card for battle (smaller payload)
    function serializeCardForBattle(card) {
        return {
            id: card.id,
            name: card.name,
            rarity: card.rarity,
            stats: { pwr: card.stats?.pwr || 0, spd: card.stats?.spd || 0, int: card.stats?.int || 0 },
            template: card.template,
            level: card.level || 0,
            // Don't send large images over Firebase - use avatar instead
            avatar: card.avatar || '',
            hasImage: !!card.frontImage
        };
    }
    
    // Create a multiplayer battle (HOST)
    async function hostMultiplayerBattle(battleType = 'friendly') {
        const code = generateBattleCode();
        
        S.multiplayer = {
            isHost: true,
            battleCode: code,
            battleType: battleType,
            opponentCard: null,
            opponentName: null,
            phase: 'hosting',
            myChoice: null,
            opponentChoice: null,
            roundNumber: 0,
            myScore: 0,
            opponentScore: 0,
            rounds: [],
            usedStats: [],
            lastSync: Date.now(),
            chatMessages: [],
            playerId: S.multiplayer.playerId
        };
        
        const battleData = {
            code: code,
            host: {
                id: S.multiplayer.playerId,
                name: S.card.name,
                playerName: S.user.name,
                card: serializeCardForBattle(S.card)
            },
            guest: null,
            battleType: battleType,
            phase: 'waiting_for_opponent',
            currentRound: null,
            rounds: [],
            chat: [],
            hostScore: 0,
            guestScore: 0,
            created: Date.now(),
            expires: Date.now() + 600000
        };
        
        if (firebaseReady && firebaseDb) {
            try {
                await firebaseDb.ref('battles/' + code).set(battleData);
                startFirebaseListener(code);
                toast(` Battle code: ${code}`);
            } catch (e) {
                console.error('Firebase write error:', e);
                toast(' Could not create battle. Try again.');
                return;
            }
        } else {
            // Fallback: localStorage for same-device testing
            localStorage.setItem('ps_battle_' + code, JSON.stringify(battleData));
            startLocalPolling(code);
            toast(` Battle code: ${code} (local mode)`);
        }
        
        S.activeSheet = 'multiplayer-lobby';
        render();
    }
    
    // Join a multiplayer battle (GUEST)
    async function joinMultiplayerBattle(code) {
        code = code.toUpperCase().trim();
        
        if (code.length !== 6) {
            toast(' Enter a 6-character code');
            return false;
        }
        
        let battle = null;
        
        if (firebaseReady && firebaseDb) {
            try {
                const snapshot = await firebaseDb.ref('battles/' + code).once('value');
                battle = snapshot.val();
            } catch (e) {
                console.error('Firebase read error:', e);
                toast(' Could not find battle');
                return false;
            }
        } else {
            // Fallback: localStorage
            const data = localStorage.getItem('ps_battle_' + code);
            battle = data ? JSON.parse(data) : null;
        }
        
        if (!battle) {
            toast(' Battle not found! Check the code.');
            return false;
        }
        
        if (battle.expires < Date.now()) {
            toast(' Battle expired! Ask for a new code.');
            return false;
        }
        
        if (battle.guest) {
            toast(' Battle already has an opponent!');
            return false;
        }
        
        // Join the battle
        const guestData = {
            id: S.multiplayer.playerId,
            name: S.card.name,
            playerName: S.user.name,
            card: serializeCardForBattle(S.card)
        };
        
        S.multiplayer = {
            isHost: false,
            battleCode: code,
            battleType: battle.battleType,
            opponentCard: battle.host.card,
            opponentName: battle.host.name,
            opponentPlayerName: battle.host.playerName,
            phase: 'ready',
            myChoice: null,
            opponentChoice: null,
            roundNumber: 0,
            myScore: 0,
            opponentScore: 0,
            rounds: [],
            usedStats: [],
            lastSync: Date.now(),
            chatMessages: [],
            playerId: S.multiplayer.playerId
        };
        
        if (firebaseReady && firebaseDb) {
            try {
                await firebaseDb.ref('battles/' + code).update({
                    guest: guestData,
                    phase: 'both_ready'
                });
                startFirebaseListener(code);
            } catch (e) {
                console.error('Firebase update error:', e);
                toast(' Could not join battle');
                return false;
            }
        } else {
            battle.guest = guestData;
            battle.phase = 'both_ready';
            localStorage.setItem('ps_battle_' + code, JSON.stringify(battle));
            startLocalPolling(code);
        }
        
        S.activeSheet = 'multiplayer-battle';
        toast(` Joined battle against ${battle.host.name}!`);
        render();
        return true;
    }
    
    // Firebase real-time listener
    function startFirebaseListener(code) {
        if (!firebaseReady || !firebaseDb) return;
        
        // Clean up previous listener
        if (S.multiplayer.unsubscribe) {
            S.multiplayer.unsubscribe();
        }
        
        const battleRef = firebaseDb.ref('battles/' + code);
        
        const onValue = battleRef.on('value', (snapshot) => {
            const battle = snapshot.val();
            if (!battle) {
                stopMultiplayerListener();
                S.multiplayer.phase = 'disconnected';
                toast(' Battle ended!');
                render();
                return;
            }
            
            handleBattleUpdate(battle);
        });
        
        S.multiplayer.unsubscribe = () => battleRef.off('value', onValue);
    }
    
    // Local polling fallback
    let localPollInterval = null;
    
    function startLocalPolling(code) {
        if (localPollInterval) clearInterval(localPollInterval);
        
        localPollInterval = setInterval(() => {
            const data = localStorage.getItem('ps_battle_' + code);
            if (!data) {
                stopMultiplayerListener();
                S.multiplayer.phase = 'disconnected';
                toast(' Battle ended!');
                render();
                return;
            }
            
            const battle = JSON.parse(data);
            handleBattleUpdate(battle);
        }, 500);
        
        S.multiplayer.unsubscribe = () => clearInterval(localPollInterval);
    }
    
    // Handle battle state updates
    function handleBattleUpdate(battle) {
        const mp = S.multiplayer;
        const isHost = mp.isHost;
        
        // Host: Check if guest joined
        if (isHost && mp.phase === 'hosting' && battle.guest) {
            mp.opponentCard = battle.guest.card;
            mp.opponentName = battle.guest.name;
            mp.opponentPlayerName = battle.guest.playerName;
            mp.phase = 'ready';
            S.activeSheet = 'multiplayer-battle';
            toast(` ${battle.guest.name} joined!`);
            render();
            return;
        }
        
        // Check for round completion
        if (battle.currentRound && battle.currentRound.complete && !mp.processedRound) {
            mp.processedRound = battle.currentRound.number;
            
            const round = battle.currentRound;
            const winner = round.winner;
            
            // Update scores
            if (winner === 'host') {
                if (isHost) mp.myScore++; else mp.opponentScore++;
            } else if (winner === 'guest') {
                if (isHost) mp.opponentScore++; else mp.myScore++;
            }
            
            // Record round
            mp.rounds.push({
                number: round.number,
                hostStat: round.hostChoice,
                guestStat: round.guestChoice,
                winner: winner
            });
            
            mp.roundNumber = round.number;
            mp.usedStats.push(isHost ? round.hostChoice : round.guestChoice);
            mp.opponentChoice = isHost ? round.guestChoice : round.hostChoice;
            
            // Check if battle is over
            if (mp.myScore >= 2 || mp.opponentScore >= 2 || mp.roundNumber >= 3) {
                finalizeMultiplayerBattle();
            } else {
                mp.phase = 'selecting';
                mp.myChoice = null;
                render();
            }
            return;
        }
        
        // Check if opponent made choice (show waiting indicator)
        if (battle.currentRound && !battle.currentRound.complete) {
            const oppMadeChoice = isHost ? battle.currentRound.guestChoice : battle.currentRound.hostChoice;
            if (oppMadeChoice && mp.phase !== 'opponent_ready') {
                // Opponent chose but we haven't - or we both chose
            }
        }
        
        // Sync chat
        if (battle.chat && battle.chat.length > mp.chatMessages.length) {
            mp.chatMessages = [...battle.chat];
            render();
        }
        
        mp.lastSync = Date.now();
    }
    
    // Make a stat choice in multiplayer
    async function multiplayerChooseStat(stat) {
        const mp = S.multiplayer;
        
        if (mp.usedStats.includes(stat)) {
            toast(' Already used this stat!');
            return;
        }
        
        const code = mp.battleCode;
        const isHost = mp.isHost;
        const myStatValue = S.card.stats[stat] || 0;
        
        mp.myChoice = stat;
        mp.phase = 'waiting_opponent';
        mp.processedRound = null; // Reset processed flag
        render();
        
        if (firebaseReady && firebaseDb) {
            try {
                const battleRef = firebaseDb.ref('battles/' + code);
                const snapshot = await battleRef.once('value');
                const battle = snapshot.val();
                
                if (!battle) {
                    toast(' Battle not found!');
                    return;
                }
                
                // Initialize or update current round
                let currentRound = battle.currentRound || {
                    number: (mp.roundNumber || 0) + 1,
                    hostChoice: null,
                    guestChoice: null,
                    hostValue: null,
                    guestValue: null,
                    complete: false
                };
                
                // Set our choice
                if (isHost) {
                    currentRound.hostChoice = stat;
                    currentRound.hostValue = myStatValue;
                } else {
                    currentRound.guestChoice = stat;
                    currentRound.guestValue = myStatValue;
                }
                
                // Check if both players have chosen
                if (currentRound.hostChoice && currentRound.guestChoice) {
                    // Determine winner
                    const hostRoll = currentRound.hostValue * (0.9 + Math.random() * 0.2);
                    const guestRoll = currentRound.guestValue * (0.9 + Math.random() * 0.2);
                    
                    if (hostRoll > guestRoll) {
                        currentRound.winner = 'host';
                    } else if (guestRoll > hostRoll) {
                        currentRound.winner = 'guest';
                    } else {
                        currentRound.winner = 'tie';
                    }
                    currentRound.complete = true;
                    
                    // Update scores
                    const updates = {
                        currentRound: currentRound,
                        hostScore: (battle.hostScore || 0) + (currentRound.winner === 'host' ? 1 : 0),
                        guestScore: (battle.guestScore || 0) + (currentRound.winner === 'guest' ? 1 : 0)
                    };
                    
                    await battleRef.update(updates);
                } else {
                    await battleRef.update({ currentRound: currentRound });
                }
                
                toast(` You chose ${stat.toUpperCase()}!`);
            } catch (e) {
                console.error('Firebase choice error:', e);
                toast(' Error making choice');
            }
        } else {
            // Local fallback
            const data = localStorage.getItem('ps_battle_' + code);
            if (!data) return;
            
            const battle = JSON.parse(data);
            
            let currentRound = battle.currentRound || {
                number: (mp.roundNumber || 0) + 1,
                hostChoice: null,
                guestChoice: null,
                hostValue: null,
                guestValue: null,
                complete: false
            };
            
            if (isHost) {
                currentRound.hostChoice = stat;
                currentRound.hostValue = myStatValue;
            } else {
                currentRound.guestChoice = stat;
                currentRound.guestValue = myStatValue;
            }
            
            if (currentRound.hostChoice && currentRound.guestChoice) {
                const hostRoll = currentRound.hostValue * (0.9 + Math.random() * 0.2);
                const guestRoll = currentRound.guestValue * (0.9 + Math.random() * 0.2);
                
                currentRound.winner = hostRoll > guestRoll ? 'host' : guestRoll > hostRoll ? 'guest' : 'tie';
                currentRound.complete = true;
                
                battle.hostScore = (battle.hostScore || 0) + (currentRound.winner === 'host' ? 1 : 0);
                battle.guestScore = (battle.guestScore || 0) + (currentRound.winner === 'guest' ? 1 : 0);
            }
            
            battle.currentRound = currentRound;
            localStorage.setItem('ps_battle_' + code, JSON.stringify(battle));
            toast(` You chose ${stat.toUpperCase()}!`);
        }
    }
    
    // Stop listening
    function stopMultiplayerListener() {
        if (S.multiplayer.unsubscribe) {
            S.multiplayer.unsubscribe();
            S.multiplayer.unsubscribe = null;
        }
        if (localPollInterval) {
            clearInterval(localPollInterval);
            localPollInterval = null;
        }
    }
    
    // Finalize multiplayer battle
    async function finalizeMultiplayerBattle() {
        stopMultiplayerListener();
        
        const mp = S.multiplayer;
        const won = mp.myScore > mp.opponentScore;
        const tied = mp.myScore === mp.opponentScore;
        
        mp.phase = 'result';
        mp.finalResult = won ? 'victory' : (tied ? 'tie' : 'defeat');
        
        // Apply rewards
        if (won) {
            S.battleRecord.wins++;
            if (mp.battleType === 'friendly') {
                earnCredits('win_battle', 10); // Bonus for PvP
                toast(' Victory! +10 credits!');
            } else if (mp.battleType === 'keeps') {
                earnCredits('win_battle_keeps', 50);
                // Add opponent's card to collection (simplified version)
                if (mp.opponentCard) {
                    const wonCard = {
                        ...mp.opponentCard,
                        id: 'won_' + Date.now(),
                        origin: 'won_pvp',
                        wonFrom: mp.opponentName,
                        createdAt: new Date().toISOString()
                    };
                    S.cardCollection.push(wonCard);
                    toast(` Won "${mp.opponentName}"'s card!`);
                }
            }
        } else if (!tied) {
            S.battleRecord.losses++;
        }
        
        // Clean up Firebase battle after a delay
        setTimeout(() => {
            if (firebaseReady && firebaseDb && mp.battleCode) {
                firebaseDb.ref('battles/' + mp.battleCode).remove().catch(() => {});
            }
        }, 30000); // Keep battle data for 30 seconds for both players to see result
        
        saveUserData();
        render();
    }
    
    // Send chat message
    async function sendBattleChat(message) {
        if (!message.trim()) return;
        
        const mp = S.multiplayer;
        const code = mp.battleCode;
        
        const chatMsg = {
            from: mp.isHost ? 'host' : 'guest',
            name: S.card.name,
            message: message.trim(),
            time: Date.now()
        };
        
        if (firebaseReady && firebaseDb) {
            try {
                await firebaseDb.ref('battles/' + code + '/chat').push(chatMsg);
            } catch (e) {
                console.error('Chat error:', e);
            }
        } else {
            const data = localStorage.getItem('ps_battle_' + code);
            if (data) {
                const battle = JSON.parse(data);
                if (!battle.chat) battle.chat = [];
                battle.chat.push(chatMsg);
                localStorage.setItem('ps_battle_' + code, JSON.stringify(battle));
            }
        }
        
        mp.chatMessages.push(chatMsg);
        render();
    }
    
    // Quick chat messages
    const QUICK_CHATS = [
        ' Good luck!',
        ' Bring it on!',
        ' Nice move!',
        ' Oops!',
        ' GG!',
        ' Let\'s go!',
        ' Hmm...',
        ' Speed!'
    ];
    
    // Exit multiplayer battle
    function exitMultiplayerBattle() {
        stopMultiplayerListener();
        
        // Clean up battle if host and not complete
        if (S.multiplayer.isHost && S.multiplayer.phase !== 'result' && S.multiplayer.battleCode) {
            if (firebaseReady && firebaseDb) {
                firebaseDb.ref('battles/' + S.multiplayer.battleCode).remove().catch(() => {});
            } else {
                localStorage.removeItem('ps_battle_' + S.multiplayer.battleCode);
            }
        }
        
        S.multiplayer = {
            isHost: false,
            battleCode: null,
            opponentCard: null,
            opponentName: null,
            phase: 'idle',
            myChoice: null,
            opponentChoice: null,
            roundNumber: 0,
            myScore: 0,
            opponentScore: 0,
            rounds: [],
            usedStats: [],
            lastSync: null,
            chatMessages: [],
            playerId: S.multiplayer.playerId
        };
        
        S.activeSheet = null;
        render();
    }
    
    // Render multiplayer lobby
    function renderMultiplayerLobby() {
        if (S.activeSheet !== 'multiplayer-lobby') return '';
        
        const mp = S.multiplayer;
        const isFirebase = firebaseReady;
        
        return `
            <div style="position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:10000;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px">
                
                ${mp.phase === 'hosting' ? `
                    <!-- Hosting - Waiting for Opponent -->
                    <div style="text-align:center">
                        <div style="font-size:64px;margin-bottom:20px"></div>
                        <div style="font-family:'Bangers',cursive;font-size:32px;color:#999;margin-bottom:10px">BATTLE ARENA</div>
                        <div style="font-size:14px;color:#888;margin-bottom:10px">${mp.battleType === 'keeps' ? ' FOR KEEPS - Winner takes card!' : ' Friendly Battle'}</div>
                        <div style="font-size:11px;color:${isFirebase?'#fff':'#999'};margin-bottom:30px">${isFirebase?' Online Mode':' Same Device Only'}</div>
                        
                        <div style="background:linear-gradient(135deg,#1a1a2e,#2a2a4e);padding:30px 50px;border-radius:20px;border:3px solid #999;margin-bottom:30px">
                            <div style="font-size:12px;color:#888;margin-bottom:10px">SHARE THIS CODE</div>
                            <div style="font-family:'Bebas Neue',sans-serif;font-size:48px;color:#fff;letter-spacing:8px">${mp.battleCode}</div>
                        </div>
                        
                        <div style="display:flex;align-items:center;gap:10px;color:#888;margin-bottom:30px">
                            <div class="pulse-dot" style="width:12px;height:12px;background:#999;border-radius:50%;animation:pulse 1.5s infinite"></div>
                            <span>Waiting for opponent to join...</span>
                        </div>
                        
                        <div style="font-size:12px;color:#666;margin-bottom:20px">
                            ${isFirebase ? 'Opponent can join from ANY device!' : 'Opponent must be on same device/network'}
                        </div>
                        
                        <button onclick="navigator.clipboard.writeText('${mp.battleCode}');toast(' Code copied!')" style="padding:12px 30px;border-radius:25px;border:none;background:#fff;color:#000;font-weight:700;cursor:pointer;margin-bottom:15px">
                             Copy Code
                        </button>
                        
                        <br>
                        
                        <button onclick="exitMultiplayerBattle()" style="padding:10px 20px;border-radius:20px;border:1px solid #444;background:transparent;color:#888;cursor:pointer;margin-top:10px">
                             Cancel
                        </button>
                    </div>
                ` : `
                    <!-- Join Battle Screen -->
                    <div style="text-align:center">
                        <div style="font-size:64px;margin-bottom:20px"></div>
                        <div style="font-family:'Bangers',cursive;font-size:32px;color:#999;margin-bottom:10px">JOIN BATTLE</div>
                        <div style="font-size:11px;color:${isFirebase?'#fff':'#999'};margin-bottom:30px">${isFirebase?' Online Mode':' Same Device Only'}</div>
                        
                        <div style="margin-bottom:30px">
                            <input type="text" id="battleCodeInput" placeholder="ENTER CODE" 
                                maxlength="6" 
                                style="font-family:'Bebas Neue',sans-serif;font-size:36px;text-align:center;letter-spacing:8px;padding:20px 30px;border-radius:15px;border:3px solid #444;background:#111;color:#fff;width:280px;text-transform:uppercase"
                                oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')">
                        </div>
                        
                        <button onclick="const code=document.getElementById('battleCodeInput').value;if(code.length===6)joinMultiplayerBattle(code);else toast('Enter 6-character code')" 
                            style="padding:15px 40px;border-radius:30px;border:none;background:linear-gradient(135deg,#fff,#16a34a);color:#fff;font-size:16px;font-weight:700;cursor:pointer;margin-bottom:20px">
                             JOIN BATTLE
                        </button>
                        
                        <br>
                        
                        <button onclick="S.activeSheet=null;render()" style="padding:10px 20px;border-radius:20px;border:1px solid #444;background:transparent;color:#888;cursor:pointer">
                             Back
                        </button>
                    </div>
                `}
            </div>
            
            <style>
                @keyframes pulse {
                    0%, 100% { opacity: 1; transform: scale(1); }
                    50% { opacity: 0.5; transform: scale(1.2); }
                }
            </style>
        `;
    }
    
    // Render multiplayer battle arena
    function renderMultiplayerBattle() {
        if (S.activeSheet !== 'multiplayer-battle') return '';
        
        const mp = S.multiplayer;
        const myCard = S.card;
        const oppCard = mp.opponentCard;
        
        // Determine last round result for animations
        const lastRound = mp.rounds.length > 0 ? mp.rounds[mp.rounds.length - 1] : null;
        const iWonLastRound = lastRound && ((mp.isHost && lastRound.winner === 'host') || (!mp.isHost && lastRound.winner === 'guest'));
        const iLostLastRound = lastRound && lastRound.winner !== 'tie' && !iWonLastRound;
        const myCardAnim = mp.justProcessedRound ? (iWonLastRound ? 'card-win' : iLostLastRound ? 'card-lose' : '') : '';
        const oppCardAnim = mp.justProcessedRound ? (iLostLastRound ? 'card-win' : iWonLastRound ? 'card-lose' : '') : '';
        
        return `
            <div style="position:fixed;inset:0;background:#000;z-index:10000;display:flex;flex-direction:column;overflow:hidden">
                
                <!-- Starfield Background -->
                <div class="space-bg" style="position:absolute;inset:0;z-index:0">
                    <div class="stars"></div>
                    <div class="stars-layer-2"></div>
                </div>
                
                <!-- Header -->
                <div style="padding:15px 20px;background:rgba(0,0,0,0.8);display:flex;justify-content:space-between;align-items:center;position:relative;z-index:10;border-bottom:1px solid #333">
                    <div style="display:flex;align-items:center;gap:10px">
                        <span style="font-size:10px;padding:4px 10px;background:${mp.battleType==='keeps'?'#fff':'#333'};border-radius:20px;color:${mp.battleType==='keeps'?'#000':'#fff'};border:1px solid #fff">${mp.battleType==='keeps'?'FOR KEEPS':'FRIENDLY'}</span>
                        <span style="font-size:11px;color:#888">Round ${mp.roundNumber + 1}/3</span>
                    </div>
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:14px;color:#666">${mp.battleCode}</div>
                    <button onclick="exitMultiplayerBattle()" style="padding:6px 12px;border-radius:15px;border:1px solid #444;background:transparent;color:#888;font-size:11px;cursor:pointer">EXIT</button>
                </div>
                
                <!-- Score -->
                <div style="display:flex;justify-content:center;gap:40px;padding:20px;background:rgba(0,0,0,0.5);position:relative;z-index:10">
                    <div style="text-align:center">
                        <div style="font-size:48px;font-weight:bold;color:#fff;text-shadow:0 0 20px rgba(255,255,255,0.5)">${mp.myScore}</div>
                        <div style="font-size:11px;color:#888">YOU</div>
                    </div>
                    <div style="font-family:'Bangers',cursive;font-size:28px;color:#fff;align-self:center">VS</div>
                    <div style="text-align:center">
                        <div style="font-size:48px;font-weight:bold;color:#fff;text-shadow:0 0 20px rgba(255,255,255,0.3)">${mp.opponentScore}</div>
                        <div style="font-size:11px;color:#888">OPP</div>
                    </div>
                </div>
                
                <!-- Cards - FULL SIZE BATTLE CARDS -->
                <div style="flex:1;display:flex;justify-content:center;align-items:center;gap:20px;padding:20px;position:relative;z-index:10">
                    
                    <!-- Your Card - Full Display -->
                    <div style="text-align:center" class="${myCardAnim}">
                        <div style="width:160px;height:224px;border-radius:12px;border:3px solid #fff;overflow:hidden;box-shadow:0 10px 40px rgba(255,255,255,0.2);position:relative;background:#111">
                            <!-- Card Image -->
                            <div style="position:absolute;inset:0;${myCard.frontImage ? `background:url('${myCard.frontImage}') center/cover` : 'background:linear-gradient(180deg,#222,#111)'};filter:grayscale(100%)"></div>
                            
                            <!-- Card Overlay -->
                            <div style="position:absolute;inset:0;background:linear-gradient(transparent 40%,rgba(0,0,0,0.95));display:flex;flex-direction:column;justify-content:flex-end;padding:10px">
                                <div style="font-size:8px;color:#888;margin-bottom:2px">${myCard.rarity}  Lv.${myCard.level||0}</div>
                                <div style="font-size:13px;color:#fff;font-weight:bold;text-shadow:1px 1px 3px #000">${myCard.name}</div>
                                
                                <!-- Stats Row -->
                                <div style="display:flex;justify-content:space-between;margin-top:8px;padding:6px;background:rgba(0,0,0,0.6);border-radius:6px">
                                    <div style="text-align:center;flex:1">
                                        <div style="font-size:12px;font-weight:bold;color:#fff">${myCard.stats?.pwr||0}</div>
                                        <div style="font-size:7px;color:#888">PWR</div>
                                    </div>
                                    <div style="text-align:center;flex:1;border-left:1px solid #333;border-right:1px solid #333">
                                        <div style="font-size:12px;font-weight:bold;color:#fff">${myCard.stats?.spd||0}</div>
                                        <div style="font-size:7px;color:#888">SPD</div>
                                    </div>
                                    <div style="text-align:center;flex:1">
                                        <div style="font-size:12px;font-weight:bold;color:#fff">${myCard.stats?.int||0}</div>
                                        <div style="font-size:7px;color:#888">INT</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Rarity Border Glow -->
                            <div style="position:absolute;inset:-3px;border:3px solid ${getRarityColor(myCard.rarity)};border-radius:14px;pointer-events:none;box-shadow:inset 0 0 20px ${getRarityColor(myCard.rarity)}40"></div>
                        </div>
                        <div style="font-size:11px;color:#fff;margin-top:10px;font-weight:bold">YOUR CARD</div>
                    </div>
                    
                    <!-- VS Indicator -->
                    <div style="text-align:center;padding:0 10px">
                        ${mp.phase === 'waiting_opponent' ? `
                            <div style="width:50px;height:50px;border:2px solid #fff;border-radius:50%;display:flex;align-items:center;justify-content:center;animation:pulse 1.5s infinite">
                                <div style="font-size:16px;color:#fff"></div>
                            </div>
                            <div style="font-size:9px;color:#888;margin-top:8px">Waiting...</div>
                        ` : `
                            <div style="width:50px;height:50px;border:2px solid #fff;border-radius:50%;display:flex;align-items:center;justify-content:center">
                                <div style="font-family:'Bangers',cursive;font-size:18px;color:#fff">VS</div>
                            </div>
                        `}
                    </div>
                    
                    <!-- Opponent Card - Full Display -->
                    <div style="text-align:center" class="${oppCardAnim}">
                        <div style="width:160px;height:224px;border-radius:12px;border:3px solid #666;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.5);position:relative;background:#111">
                            <!-- Card Image -->
                            <div style="position:absolute;inset:0;${oppCard?.frontImage ? `background:url('${oppCard.frontImage}') center/cover` : oppCard?.hasImage ? `background:url('${oppCard.frontImage}') center/cover` : 'background:linear-gradient(180deg,#1a1a1a,#0a0a0a)'};filter:grayscale(100%)"></div>
                            
                            <!-- Card Overlay -->
                            <div style="position:absolute;inset:0;background:linear-gradient(transparent 40%,rgba(0,0,0,0.95));display:flex;flex-direction:column;justify-content:flex-end;padding:10px">
                                <div style="font-size:8px;color:#666;margin-bottom:2px">${oppCard?.rarity||'?'}  Lv.${oppCard?.level||0}</div>
                                <div style="font-size:13px;color:#fff;font-weight:bold;text-shadow:1px 1px 3px #000">${oppCard?.name||'Opponent'}</div>
                                
                                <!-- Stats Row (hidden until revealed) -->
                                <div style="display:flex;justify-content:space-between;margin-top:8px;padding:6px;background:rgba(0,0,0,0.6);border-radius:6px">
                                    <div style="text-align:center;flex:1">
                                        <div style="font-size:12px;font-weight:bold;color:#888">${oppCard?.stats?.pwr||'?'}</div>
                                        <div style="font-size:7px;color:#666">PWR</div>
                                    </div>
                                    <div style="text-align:center;flex:1;border-left:1px solid #333;border-right:1px solid #333">
                                        <div style="font-size:12px;font-weight:bold;color:#888">${oppCard?.stats?.spd||'?'}</div>
                                        <div style="font-size:7px;color:#666">SPD</div>
                                    </div>
                                    <div style="text-align:center;flex:1">
                                        <div style="font-size:12px;font-weight:bold;color:#888">${oppCard?.stats?.int||'?'}</div>
                                        <div style="font-size:7px;color:#666">INT</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Rarity Border -->
                            <div style="position:absolute;inset:-3px;border:3px solid ${getRarityColor(oppCard?.rarity||'COMMON')};border-radius:14px;pointer-events:none"></div>
                        </div>
                        <div style="font-size:11px;color:#888;margin-top:10px">${mp.opponentPlayerName || 'OPPONENT'}</div>
                    </div>
                </div>
                
                <!-- Round History -->
                ${mp.rounds.length > 0 ? `
                    <div style="display:flex;justify-content:center;gap:8px;padding:10px;position:relative;z-index:10">
                        ${mp.rounds.map((r, i) => {
                            const iWon = (mp.isHost && r.winner === 'host') || (!mp.isHost && r.winner === 'guest');
                            return `
                                <div style="background:${iWon ? 'rgba(255,255,255,0.2)' : r.winner === 'tie' ? 'rgba(255,255,255,0.1)' : 'rgba(255,255,255,0.05)'};padding:8px 12px;border-radius:8px;text-align:center;border:1px solid ${iWon ? '#fff' : '#333'}">
                                    <div style="font-size:9px;color:#888">R${i+1}</div>
                                    <div style="font-size:14px;color:#fff">${iWon ? 'W' : r.winner === 'tie' ? 'T' : 'L'}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : ''}
                
                <!-- Action Area -->
                <div style="padding:20px;background:rgba(0,0,0,0.8);position:relative;z-index:10;border-top:1px solid #333">
                    ${mp.phase === 'result' ? `
                        <!-- Final Result -->
                        <div style="text-align:center;padding:20px;background:${mp.finalResult==='victory'?'rgba(255,255,255,0.1)':'rgba(0,0,0,0.3)'};border-radius:16px;margin-bottom:15px;border:2px solid ${mp.finalResult==='victory'?'#fff':'#333'}">
                            <div style="font-family:'Bangers',cursive;font-size:32px;color:#fff;text-shadow:0 0 20px rgba(255,255,255,0.5)">
                                ${mp.finalResult==='victory'?'VICTORY!':mp.finalResult==='tie'?'TIE!':'DEFEAT!'}
                            </div>
                            <div style="font-size:14px;color:#888;margin-top:8px">${mp.myScore} - ${mp.opponentScore}</div>
                        </div>
                        <div style="display:flex;justify-content:center;gap:10px">
                            <button onclick="exitMultiplayerBattle()" style="padding:12px 30px;border-radius:25px;border:2px solid #fff;background:#fff;color:#000;font-weight:700;cursor:pointer">DONE</button>
                        </div>
                    ` : mp.phase === 'waiting_opponent' ? `
                        <!-- Waiting for opponent -->
                        <div style="text-align:center;color:#888">
                            <div style="font-size:14px;margin-bottom:10px">You chose <strong style="color:#fff">${mp.myChoice?.toUpperCase()}</strong></div>
                            <div style="display:flex;align-items:center;justify-content:center;gap:8px">
                                <div style="width:10px;height:10px;background:#fff;border-radius:50%;animation:pulse 1.5s infinite"></div>
                                <span>Waiting for opponent's choice...</span>
                            </div>
                        </div>
                    ` : `
                        <!-- Stat Selection -->
                        <div style="text-align:center;margin-bottom:15px;font-size:12px;color:#888">
                            Choose your stat! ${mp.usedStats.length > 0 ? `(Used: ${mp.usedStats.map(s=>s.toUpperCase()).join(', ')})` : ''}
                        </div>
                        <div style="display:flex;justify-content:center;gap:12px">
                            <button onclick="multiplayerChooseStat('pwr')" ${mp.usedStats.includes('pwr')?'disabled':''} 
                                style="padding:16px 24px;border-radius:12px;border:2px solid ${mp.usedStats.includes('pwr')?'#333':'#fff'};background:${mp.usedStats.includes('pwr')?'#111':'#fff'};color:${mp.usedStats.includes('pwr')?'#444':'#000'};font-weight:700;cursor:${mp.usedStats.includes('pwr')?'not-allowed':'pointer'};min-width:80px">
                                <div style="font-size:10px;opacity:0.6">PWR</div>
                                <div style="font-size:24px">${myCard.stats?.pwr||0}</div>
                            </button>
                            <button onclick="multiplayerChooseStat('spd')" ${mp.usedStats.includes('spd')?'disabled':''}
                                style="padding:16px 24px;border-radius:12px;border:2px solid ${mp.usedStats.includes('spd')?'#333':'#fff'};background:${mp.usedStats.includes('spd')?'#111':'#fff'};color:${mp.usedStats.includes('spd')?'#444':'#000'};font-weight:700;cursor:${mp.usedStats.includes('spd')?'not-allowed':'pointer'};min-width:80px">
                                <div style="font-size:10px;opacity:0.6">SPD</div>
                                <div style="font-size:24px">${myCard.stats?.spd||0}</div>
                            </button>
                            <button onclick="multiplayerChooseStat('int')" ${mp.usedStats.includes('int')?'disabled':''}
                                style="padding:16px 24px;border-radius:12px;border:2px solid ${mp.usedStats.includes('int')?'#333':'#fff'};background:${mp.usedStats.includes('int')?'#111':'#fff'};color:${mp.usedStats.includes('int')?'#444':'#000'};font-weight:700;cursor:${mp.usedStats.includes('int')?'not-allowed':'pointer'};min-width:80px">
                                <div style="font-size:10px;opacity:0.6">INT</div>
                                <div style="font-size:24px">${myCard.stats?.int||0}</div>
                            </button>
                        </div>
                    `}
                </div>
                
                <!-- Quick Chat -->
                <div style="padding:10px 20px;background:rgba(0,0,0,0.9);display:flex;gap:8px;overflow-x:auto;position:relative;z-index:10">
                    ${QUICK_CHATS.map(msg => `
                        <button onclick="sendBattleChat('${msg}')" style="padding:6px 12px;border-radius:15px;border:1px solid #333;background:transparent;color:#888;font-size:11px;cursor:pointer;white-space:nowrap">${msg}</button>
                    `).join('')}
                </div>
                
                <!-- Chat Messages -->
                ${mp.chatMessages.length > 0 ? `
                    <div style="position:absolute;bottom:140px;left:20px;right:20px;display:flex;flex-direction:column;gap:5px;pointer-events:none;z-index:20">
                        ${mp.chatMessages.slice(-3).map(msg => `
                            <div style="background:rgba(0,0,0,0.9);padding:8px 12px;border-radius:12px;${msg.from === (mp.isHost ? 'host' : 'guest') ? 'margin-left:auto;border:1px solid #fff' : 'margin-right:auto;border:1px solid #333'};max-width:60%">
                                <span style="font-size:10px;color:#888">${msg.name}:</span>
                                <span style="font-size:12px;color:#fff;margin-left:5px">${msg.message}</span>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    // ========================================
    // CARD ENGINE V2 - FULL IMPLEMENTATION
    // ========================================
    
    // ----- CARD HELPERS -----
    
    function getTotalPower(card) {
        const stats = card.stats || { pwr: 0, spd: 0, int: 0 };
        return (stats.pwr || 0) + (stats.spd || 0) + (stats.int || 0);
    }
    
    function getStatRatio(card) {
        const config = S.RARITY_CONFIG[card.rarity] || S.RARITY_CONFIG['COMMON'];
        const total = getTotalPower(card);
        return config.statPointPool > 0 ? total / config.statPointPool : 0;
    }
    
    function rollStat(card, stat, variancePercent = 10) {
        const base = card.stats?.[stat] || 0;
        const variance = base * variancePercent / 100;
        const delta = (Math.random() * 2 - 1) * variance;
        return Math.round(base + delta);
    }
    
    function getCardLevel(card) {
        return Math.floor((card.xp || 0) / 10);
    }
    
    function grantCardXp(card, amount) {
        card.xp = (card.xp || 0) + amount;
        card.level = getCardLevel(card);
        updateEvolutionState(card);
        return card;
    }
    
    function damageCard(card, amount = 10) {
        card.durability = Math.max(0, (card.durability || 100) - amount);
        updateEvolutionState(card);
        return card;
    }
    
    function healCard(card, amount = 2) {
        card.durability = Math.min(100, (card.durability || 100) + amount);
        updateEvolutionState(card);
        return card;
    }
    
    // ----- EVOLUTION SYSTEM -----
    
    function updateEvolutionState(card) {
        const statRatio = getStatRatio(card);
        const level = card.level || 0;
        const durability = card.durability ?? 100;
        const rarity = card.rarity || 'COMMON';
        
        if (durability <= 30) {
            card.evolutionState = 'DAMAGED';
        } else if (rarity === 'MYTHIC' && level >= 15 && statRatio >= 0.9) {
            card.evolutionState = 'MYTHIC_ASCENDED';
        } else if (rarity === 'LEGENDARY' || (rarity === 'MYTHIC' && statRatio >= 0.8)) {
            card.evolutionState = 'LEGENDARY_FORM';
        } else if (level >= 5 || statRatio >= 0.7) {
            card.evolutionState = 'ENHANCED';
        } else {
            card.evolutionState = 'BASE';
        }
        
        return card;
    }
    
    function getEvolutionStyles(evolutionState) {
        switch (evolutionState) {
            case 'DAMAGED':
                return { filter: 'grayscale(0.4) brightness(0.8)', boxShadow: 'none', animation: '' };
            case 'ENHANCED':
                return { filter: '', boxShadow: '0 0 12px rgba(255, 215, 0, 0.5)', animation: '' };
            case 'LEGENDARY_FORM':
                return { filter: '', boxShadow: '0 0 18px rgba(255, 215, 0, 0.9)', animation: 'pulse 2s infinite' };
            case 'MYTHIC_ASCENDED':
                return { filter: 'brightness(1.1)', boxShadow: '0 0 24px cyan, 0 0 48px magenta', animation: 'mythicPulse 3s infinite' };
            default: // BASE
                return { filter: '', boxShadow: '', animation: '' };
        }
    }
    
    // ----- AI CARD GENERATION -----
    
    function generateAICard(targetRarity = null) {
        const names = ['Shadow Wolf', 'Blaze Phoenix', 'Storm Titan', 'Frost Giant', 'Thunder Bear', 
                       'Cyber Dragon', 'Mystic Sage', 'Iron Golem', 'Void Walker', 'Star Crusher', 
                       'Neon Ninja', 'Crystal Witch', 'Dark Knight', 'Solar Flare', 'Quantum Ghost'];
        const avatars = ['', '', '', '', '', '', '', '', '', '', '', '', '', '', ''];
        const rarities = ['COMMON', 'UNCOMMON', 'RARE', 'EPIC', 'LEGENDARY', 'MYTHIC'];
        
        // Match or vary from player rarity
        const playerRarityIdx = rarities.indexOf(S.card.rarity || 'COMMON');
        let rarityIdx;
        if (targetRarity) {
            rarityIdx = rarities.indexOf(targetRarity);
        } else {
            rarityIdx = Math.max(0, Math.min(rarities.length - 1, playerRarityIdx + Math.floor(Math.random() * 3) - 1));
        }
        const rarity = rarities[rarityIdx];
        const pool = S.RARITY_CONFIG[rarity].statPointPool;
        
        // Distribute stats
        const pwr = Math.floor(Math.random() * Math.min(100, pool * 0.5)) + 10;
        const remaining = pool - pwr;
        const spd = Math.floor(Math.random() * Math.min(100, remaining * 0.6)) + 10;
        const int = Math.min(100, pool - pwr - spd);
        
        const idx = Math.floor(Math.random() * names.length);
        
        return {
            id: 'ai_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
            name: names[idx],
            avatar: avatars[idx],
            rarity: rarity,
            stats: { pwr, spd, int },
            xp: Math.floor(Math.random() * 100),
            level: Math.floor(Math.random() * 10),
            durability: 70 + Math.floor(Math.random() * 30),
            evolutionState: 'BASE',
            handle: '@' + names[idx].toLowerCase().replace(/ /g, '_')
        };
    }
    
    function generateAICards(count, rarity = null) {
        const cards = [];
        for (let i = 0; i < count; i++) {
            cards.push(generateAICard(rarity));
        }
        return cards;
    }
    
    // ----- BATTLE ROUND LOGIC -----
    
    function playBaseRound(playerCard, aiCard, stat) {
        const p = rollStat(playerCard, stat, 10);
        const a = rollStat(aiCard, stat, 10);
        return {
            winner: p > a ? 'PLAYER' : (a > p ? 'AI' : 'TIE'),
            playerRoll: p,
            aiRoll: a,
            stat: stat,
            margin: Math.abs(p - a)
        };
    }
    
    function applyChaosModifier(card, modifier) {
        const c = { ...card, stats: { ...card.stats } };
        
        switch (modifier.id) {
            case 'DOUBLE_INT': c.stats.int *= 2; break;
            case 'DOUBLE_PWR': c.stats.pwr *= 2; break;
            case 'DOUBLE_SPD': c.stats.spd *= 2; break;
            case 'ZERO_PWR': c.stats.pwr = 0; break;
            case 'ZERO_SPD': c.stats.spd = 0; break;
            case 'ZERO_INT': c.stats.int = 0; break;
            case 'LEGENDARY_NERF':
                if (c.rarity === 'LEGENDARY' || c.rarity === 'MYTHIC') {
                    c.stats.pwr = Math.round(c.stats.pwr * 0.8);
                }
                break;
            case 'LOW_RARITY_BUFF':
                if (c.rarity === 'COMMON' || c.rarity === 'UNCOMMON') {
                    c.stats.pwr += 10;
                    c.stats.spd += 10;
                    c.stats.int += 10;
                }
                break;
            case 'STAT_SWAP':
                const temp = c.stats.pwr;
                c.stats.pwr = c.stats.int;
                c.stats.int = temp;
                break;
            case 'RANDOM_BOOST':
                const statKeys = ['pwr', 'spd', 'int'];
                c.stats[statKeys[Math.floor(Math.random() * 3)]] += 25;
                break;
            case 'DURABILITY_MATTERS':
                const durMult = (c.durability || 100) / 100;
                c.stats.pwr = Math.round(c.stats.pwr * durMult);
                c.stats.spd = Math.round(c.stats.spd * durMult);
                c.stats.int = Math.round(c.stats.int * durMult);
                break;
        }
        
        return c;
    }
    
    function getCardValueFor21(card) {
        const statKeys = ['pwr', 'spd', 'int'];
        const statUsed = statKeys[Math.floor(Math.random() * statKeys.length)];
        const raw = card.stats?.[statUsed] || 0;
        let value = Math.ceil(raw / 10);
        
        // 10% chance for crit (double value, cap at 11)
        const isCrit = Math.random() < 0.1;
        if (isCrit) value = Math.min(11, value * 2);
        
        return { value, statUsed, isCrit };
    }
    
    // ----- GAME MODE: BASE BATTLE -----
    
    function startAdvancedBattle(mode) {
        S.currentBattle = {
            mode: mode,
            phase: 'BATTLE',
            playerCards: [S.card],
            aiCards: generateAICards(mode === 'TAG_TEAM' ? 2 : (mode === 'RUMBLE_ROYALE' ? 10 : 1)),
            currentRound: 0,
            playerScore: 0,
            aiScore: 0,
            rounds: [],
            chaosModifier: null,
            streakCount: 0,
            ps21State: mode === 'PS21' ? { playerTotal: 0, aiTotal: 0, playerCards: [], aiCards: [], phase: 'DEAL' } : null,
            warPoints: { player: 0, ai: 0 },
            log: [` ${S.BATTLE_MODES.find(m => m.id === mode)?.name || mode} Started!`]
        };
        
        S.battleMode = true;
        S.activeBattleMode = mode;
        
        // For PS21, deal initial cards
        if (mode === 'PS21') {
            dealPS21InitialCards();
        }
        
        render();
    }
    
    function playAdvancedRound(chosenStat = null) {
        const battle = S.currentBattle;
        const mode = battle.mode;
        const stats = ['pwr', 'spd', 'int'];
        const stat = chosenStat || stats[Math.floor(Math.random() * stats.length)];
        
        let playerCard = battle.playerCards[0];
        let aiCard = battle.aiCards[battle.currentRound] || battle.aiCards[0];
        
        // Apply chaos modifier if in Chaos mode
        if (mode === 'CHAOS') {
            const modifier = S.CHAOS_MODIFIERS[Math.floor(Math.random() * S.CHAOS_MODIFIERS.length)];
            battle.chaosModifier = modifier;
            battle.log.push(` CHAOS: ${modifier.name} - ${modifier.description}`);
            
            // Special rule check
            if (modifier.id === 'LOWEST_RARITY_WINS') {
                const rarityOrder = ['COMMON', 'UNCOMMON', 'RARE', 'EPIC', 'LEGENDARY', 'MYTHIC'];
                const pIdx = rarityOrder.indexOf(playerCard.rarity);
                const aIdx = rarityOrder.indexOf(aiCard.rarity || 'COMMON');
                const winner = pIdx < aIdx ? 'PLAYER' : (aIdx < pIdx ? 'AI' : 'TIE');
                battle.rounds.push({ stat: 'rarity', winner, playerRoll: pIdx, aiRoll: aIdx, modifier });
                if (winner === 'PLAYER') battle.playerScore++;
                else if (winner === 'AI') battle.aiScore++;
                battle.currentRound++;
                battle.log.push(`${winner === 'PLAYER' ? '' : ''} Round ${battle.currentRound}: ${winner} wins (Lowest Rarity)`);
                checkBattleEnd();
                return;
            }
            
            playerCard = applyChaosModifier(playerCard, modifier);
            aiCard = applyChaosModifier(aiCard, modifier);
        }
        
        // Sudden Death uses 40% variance
        const variance = mode === 'SUDDEN_DEATH' ? 40 : 10;
        const result = {
            ...playBaseRound(playerCard, aiCard, stat),
            modifier: battle.chaosModifier
        };
        
        // Re-roll with different stat on tie for Sudden Death
        if (mode === 'SUDDEN_DEATH' && result.winner === 'TIE') {
            const newStat = stats.filter(s => s !== stat)[Math.floor(Math.random() * 2)];
            const reroll = playBaseRound(playerCard, aiCard, newStat);
            result.winner = reroll.winner === 'TIE' ? 'PLAYER' : reroll.winner; // Force winner on double tie
            result.stat = newStat;
            result.rerolled = true;
        }
        
        battle.rounds.push(result);
        if (result.winner === 'PLAYER') battle.playerScore++;
        else if (result.winner === 'AI') battle.aiScore++;
        battle.currentRound++;
        
        const emoji = result.winner === 'PLAYER' ? '' : (result.winner === 'AI' ? '' : '');
        battle.log.push(`${emoji} Round ${battle.currentRound}: ${stat.toUpperCase()} - You: ${result.playerRoll} vs AI: ${result.aiRoll}`);
        
        checkBattleEnd();
    }
    
    function checkBattleEnd() {
        const battle = S.currentBattle;
        const mode = battle.mode;
        let battleOver = false;
        let playerWon = false;
        
        // Different win conditions per mode
        switch (mode) {
            case 'BASE_FRIENDLY':
            case 'BASE_FOR_KEEPS':
            case 'CHAOS':
            case 'TAG_TEAM':
                // Best of 3
                battleOver = battle.playerScore >= 2 || battle.aiScore >= 2 || battle.currentRound >= 3;
                playerWon = battle.playerScore > battle.aiScore;
                break;
            case 'SUDDEN_DEATH':
                // Single round
                battleOver = battle.currentRound >= 1;
                playerWon = battle.playerScore > battle.aiScore;
                break;
            case 'RUMBLE_ROYALE':
                // Streak mode - lose ends it, or win all 10
                if (battle.aiScore > 0) {
                    battleOver = true;
                    playerWon = false;
                } else if (battle.playerScore >= 10) {
                    battleOver = true;
                    playerWon = true;
                }
                battle.streakCount = battle.playerScore;
                break;
            case 'DECLARE_WAR':
                // First to 10 points
                battleOver = battle.warPoints.player >= 10 || battle.warPoints.ai >= 10;
                playerWon = battle.warPoints.player >= 10;
                break;
        }
        
        if (battleOver) {
            finalizAdvancedBattle(playerWon);
        } else {
            render();
        }
    }
    
    function finalizAdvancedBattle(playerWon) {
        const battle = S.currentBattle;
        const mode = battle.mode;
        const modeConfig = S.BATTLE_MODES.find(m => m.id === mode);
        let creditsEarned = 0;
        let xpEarned = 0;
        
        // Calculate rewards based on mode
        if (playerWon) {
            creditsEarned = modeConfig?.reward || 5;
            xpEarned = 3;
            
            // Bonus rewards
            if (mode === 'RUMBLE_ROYALE') {
                if (battle.streakCount >= 5) creditsEarned += 50;
                if (battle.streakCount >= 10) {
                    creditsEarned += 100;
                    xpEarned += 5;
                    battle.log.push(' PERFECT STREAK! Bonus rewards!');
                }
            }
            if (mode === 'PS21' && battle.ps21State?.playerTotal === 21) {
                creditsEarned = 30;
                battle.log.push(' PERFECT 21! Double credits!');
            }
            if (mode === 'BASE_FOR_KEEPS') {
                // Add AI card to collection
                const wonCard = {
                    ...battle.aiCards[0],
                    id: 'card_' + Date.now(),
                    origin: 'won_battle',
                    wonFrom: battle.aiCards[0].handle,
                    wonFromPlayer: battle.aiCards[0].name,
                    category: 'won',
                    createdAt: new Date().toISOString()
                };
                S.cardCollection.push(wonCard);
                battle.log.push(` Won "${wonCard.name}" card!`);
            }
            
            S.battleRecord.wins++;
            battle.log.push(` Victory! +${creditsEarned} credits, +${xpEarned} XP`);
        } else {
            xpEarned = 1;
            creditsEarned = mode === 'TAG_TEAM' ? 10 : (mode === 'PS21' ? 5 : 0);
            
            // Durability damage on loss
            damageCard(S.card, 10);
            
            // For Keeps loss
            if (mode === 'BASE_FOR_KEEPS' && S.battleWageredCard !== null) {
                const lostCard = S.cardCollection[S.battleWageredCard];
                if (lostCard && !lostCard.locked) {
                    S.cardCollection.splice(S.battleWageredCard, 1);
                    battle.log.push(` Lost "${lostCard.name}" card!`);
                }
            }
            
            S.battleRecord.losses++;
            battle.log.push(` Defeat! +${xpEarned} XP, -10 durability`);
        }
        
        // Apply rewards
        S.userCredits = (S.userCredits || 0) + creditsEarned;
        grantCardXp(S.card, xpEarned);
        S.card.battlesPlayed = (S.card.battlesPlayed || 0) + 1;
        if (playerWon) S.card.battlesWon = (S.card.battlesWon || 0) + 1;
        else S.card.battlesLost = (S.card.battlesLost || 0) + 1;
        S.card.lastBattleDate = new Date().toISOString();
        
        // Update streak
        if (mode === 'RUMBLE_ROYALE' && battle.streakCount > (S.card.streakBest || 0)) {
            S.card.streakBest = battle.streakCount;
        }
        
        battle.phase = 'RESULT';
        battle.result = {
            winner: playerWon ? 'PLAYER' : 'AI',
            creditsEarned,
            xpEarned
        };
        
        // Add to battle history
        S.battleHistory.push({
            date: new Date().toISOString(),
            mode: mode,
            opponent: battle.aiCards[0]?.name || 'AI',
            result: playerWon ? 'win' : 'loss',
            creditsEarned,
            xpEarned,
            streak: battle.streakCount
        });
        
        saveUserData();
        render();
    }
    
    function exitAdvancedBattle() {
        S.currentBattle = { mode: null, phase: 'SELECT', playerCards: [], aiCards: [], currentRound: 0, playerScore: 0, aiScore: 0, rounds: [], log: [] };
        S.battleMode = false;
        S.activeBattleMode = null;
        render();
    }
    
    // ----- PS21 (BLACKJACK) SPECIFIC -----
    
    function dealPS21InitialCards() {
        const battle = S.currentBattle;
        const ps21 = battle.ps21State;
        
        // Deal 2 cards each
        for (let i = 0; i < 2; i++) {
            const pCard = getCardValueFor21(S.card);
            ps21.playerCards.push(pCard);
            ps21.playerTotal += pCard.value;
            
            const aiCard = generateAICard();
            const aCard = getCardValueFor21(aiCard);
            ps21.aiCards.push(aCard);
            ps21.aiTotal += aCard.value;
        }
        
        // Legendary bust protection
        if (ps21.playerTotal === 22 && (S.card.rarity === 'LEGENDARY' || S.card.rarity === 'MYTHIC')) {
            ps21.playerTotal = 21;
            battle.log.push(' Legendary Bust Protection! 22  21');
        }
        
        ps21.phase = 'PLAYER_TURN';
        battle.log.push(` Dealt! Your total: ${ps21.playerTotal}`);
    }
    
    function ps21Hit() {
        const ps21 = S.currentBattle.ps21State;
        const card = getCardValueFor21(S.card);
        ps21.playerCards.push(card);
        ps21.playerTotal += card.value;
        
        S.currentBattle.log.push(` Hit! +${card.value} (${card.statUsed.toUpperCase()})${card.isCrit ? ' CRIT!' : ''} = ${ps21.playerTotal}`);
        
        // Bust check with legendary protection
        if (ps21.playerTotal > 21) {
            if (ps21.playerTotal === 22 && (S.card.rarity === 'LEGENDARY' || S.card.rarity === 'MYTHIC')) {
                ps21.playerTotal = 21;
                S.currentBattle.log.push(' Bust Protection! 22  21');
            } else {
                S.currentBattle.log.push(' BUST!');
                ps21.phase = 'RESULT';
                finalizPS21(false);
                return;
            }
        }
        render();
    }
    
    function ps21Stay() {
        const ps21 = S.currentBattle.ps21State;
        ps21.phase = 'AI_TURN';
        S.currentBattle.log.push(` Stay at ${ps21.playerTotal}`);
        
        // AI plays
        while (ps21.aiTotal < 17) {
            const aiCard = generateAICard();
            const card = getCardValueFor21(aiCard);
            ps21.aiCards.push(card);
            ps21.aiTotal += card.value;
            S.currentBattle.log.push(` AI hits: +${card.value} = ${ps21.aiTotal}`);
        }
        
        // Determine winner
        const playerWon = ps21.aiTotal > 21 || (ps21.playerTotal <= 21 && ps21.playerTotal > ps21.aiTotal);
        S.currentBattle.log.push(` Final: You ${ps21.playerTotal} vs AI ${ps21.aiTotal}`);
        finalizPS21(playerWon);
    }
    
    function ps21DoubleDown() {
        const ps21 = S.currentBattle.ps21State;
        ps21.doubledDown = true;
        S.currentBattle.log.push(' DOUBLE DOWN!');
        ps21Hit();
        if (ps21.phase !== 'RESULT') {
            ps21Stay();
        }
    }
    
    function finalizPS21(playerWon) {
        const ps21 = S.currentBattle.ps21State;
        let credits = playerWon ? 15 : 5;
        
        if (playerWon && ps21.playerTotal === 21) credits = 30;
        if (playerWon && ps21.doubledDown) credits = 50;
        
        S.currentBattle.ps21State.phase = 'RESULT';
        S.currentBattle.playerScore = playerWon ? 1 : 0;
        S.currentBattle.aiScore = playerWon ? 0 : 1;
        finalizAdvancedBattle(playerWon);
    }
    
    // ----- DECLARE WAR SPECIFIC -----
    
    function playWarRound() {
        const battle = S.currentBattle;
        const playerCard = S.card;
        const aiCard = generateAICard();
        
        const totalP = getTotalPower(playerCard);
        const totalA = getTotalPower(aiCard);
        const diff = Math.abs(totalP - totalA);
        
        battle.log.push(` You: ${totalP} vs AI: ${totalA}`);
        
        if (diff > 5) {
            // Clear winner
            if (totalP > totalA) {
                battle.warPoints.player++;
                battle.log.push(' +1 point');
            } else {
                battle.warPoints.ai++;
                battle.log.push(' AI +1 point');
            }
        } else {
            // WAR!
            battle.log.push(' WAR! Backup cards fight!');
            resolveWar();
        }
        
        checkBattleEnd();
    }
    
    function resolveWar() {
        const battle = S.currentBattle;
        const backupP = S.cardCollection.length > 0 ? S.cardCollection[Math.floor(Math.random() * S.cardCollection.length)] : S.card;
        const backupA = generateAICard();
        const stat = ['pwr', 'spd', 'int'][Math.floor(Math.random() * 3)];
        
        const p = rollStat(backupP, stat, 10);
        const a = rollStat(backupA, stat, 10);
        
        battle.log.push(` WAR ${stat.toUpperCase()}: ${p} vs ${a}`);
        
        if (p === a) {
            // Double WAR
            battle.log.push(' DOUBLE WAR!');
            S.userCredits = (S.userCredits || 0) + 10;
            if (Math.random() > 0.5) {
                battle.warPoints.player += 5;
                battle.log.push(' DOUBLE WAR WIN! +5 points');
            } else {
                battle.warPoints.ai += 5;
                battle.log.push(' DOUBLE WAR LOSS! AI +5 points');
            }
        } else if (p > a) {
            battle.warPoints.player += 3;
            S.userCredits = (S.userCredits || 0) + 5;
            battle.log.push(' WAR WIN! +3 points');
        } else {
            battle.warPoints.ai += 3;
            battle.log.push(' WAR LOSS! AI +3 points');
        }
    }
    
    // ========== CARD COLLECTION MANAGEMENT ==========
    
    function openCardCollection() {
        S.activeSheet = 'collection';
        S.collectionFilter = 'all';
        render();
    }
    
    function filterCollection(category) {
        S.collectionFilter = category;
        render();
    }
    
    function getFilteredCollection() {
        if (!S.collectionFilter || S.collectionFilter === 'all') {
            return S.cardCollection;
        }
        return S.cardCollection.filter(c => c.category === S.collectionFilter);
    }
    
    function setCardCategory(cardIndex, category) {
        if (S.cardCollection[cardIndex]) {
            S.cardCollection[cardIndex].category = category;
            saveUserData();
            toast(` Moved to ${S.cardCategories.find(c=>c.id===category)?.name || category}`);
            render();
        }
    }
    
    function viewCollectionCard(index) {
        const card = S.cardCollection[index];
        if (card) {
            S.viewingCollectionCard = index;
            S.activeSheet = 'collection-card-view';
            render();
        }
    }
    
    function equipCollectionCard(index) {
        const card = S.cardCollection[index];
        if (card) {
            // Copy card data to active card
            Object.assign(S.card, {
                ...card,
                id: S.card.id // Keep original ID
            });
            S.activeSheet = null;
            toast(` ${card.name} equipped!`);
            render();
        }
    }
    
    function deleteCollectionCard(index) {
        if (S.cardCollection[index] && !S.cardCollection[index].locked) {
            const name = S.cardCollection[index].name;
            S.cardCollection.splice(index, 1);
            saveUserData();
            toast(` ${name} removed from collection`);
            S.activeSheet = 'collection';
            render();
        } else {
            toast(' Card is locked!');
        }
    }
    
    function addCurrentCardToCollection() {
        const newCard = JSON.parse(JSON.stringify(S.card));
        newCard.id = 'card_' + Date.now();
        newCard.addedAt = new Date().toISOString();
        S.cardCollection.push(newCard);
        saveUserData();
        toast(` Added "${newCard.name}" to collection!`);
    }
    
    function getCollectionStats() {
        const total = S.cardCollection.length;
        const byRarity = {};
        const byCategory = {};
        const wonInBattle = S.cardCollection.filter(c => c.origin === 'won_battle').length;
        
        S.cardCollection.forEach(c => {
            byRarity[c.rarity] = (byRarity[c.rarity] || 0) + 1;
            byCategory[c.category || 'uncategorized'] = (byCategory[c.category || 'uncategorized'] || 0) + 1;
        });
        
        return { total, byRarity, byCategory, wonInBattle };
    }
    
    function closeBattle() {
        S.battleMode = false;
        S.battleOpponent = null;
        S.battleResult = null;
        S.battleWageredCard = null;
        render();
    }
    
    // ========== COMIC FEED SYSTEM ==========
    
    function readComic(comicId) {
        const comic = S.comicFeed.find(c => c.id === comicId);
        if (comic) {
            comic.views++;
            earnCredits('read_comic');
            toast(` Reading "${comic.title}" by ${comic.creator}`);
        }
        render();
    }
    
    function likeComic(comicId) {
        const comic = S.comicFeed.find(c => c.id === comicId);
        if (comic) {
            comic.likes++;
            earnCredits('rate_comic');
            toast(` Liked "${comic.title}"!`);
        }
        render();
    }
    
    function publishComic() {
        // Add current comic to feed
        const newComic = {
            id: S.comicFeed.length + 1,
            title: S.cover.title || 'Untitled',
            creator: S.user.handle,
            views: 0,
            likes: 0,
            thumbnail: null // Would be generated from cover
        };
        S.comicFeed.unshift(newComic);
        earnCredits('create_comic');
        toast(` Published "${newComic.title}" to the feed!`);
        render();
    }
    
    // ========== BOOK PROGRESS SYSTEM ==========
    
    function completeChapter(chapterId) {
        const chapter = S.bookProgress.chapters.find(c => c.id === chapterId);
        if (chapter && !chapter.completed) {
            chapter.completed = true;
            S.bookProgress.totalEarned += chapter.reward;
            earnCredits('complete_chapter', chapter.reward - S.CREDIT_REWARDS.complete_chapter);
            toast(` Completed "${chapter.title}"! +${chapter.reward} bonus credits!`);
            saveUserData();
            render();
        }
    }
    
    function getBookProgress() {
        const completed = S.bookProgress.chapters.filter(c => c.completed).length;
        const total = S.bookProgress.chapters.length;
        return { completed, total, percentage: Math.round((completed / total) * 100) };
    }
    
    // ========== TEACHER DASHBOARD ==========
    
    function toggleTeacherMode() {
        S.teacherMode = !S.teacherMode;
        S.user.isTeacher = S.teacherMode;
        toast(S.teacherMode ? ' Teacher Mode ON' : ' Student Mode');
        render();
    }
    
    function awardBonusCredits(studentId, amount, reason) {
        const student = S.classroom.students.find(s => s.id === studentId);
        if (student) {
            student.credits += amount;
            toast(` Awarded ${amount} credits to ${student.name} for ${reason}`);
            render();
        }
    }
    
    function createChallenge(title, reward, deadline) {
        S.classroom.challenges.push({
            id: S.classroom.challenges.length + 1,
            title,
            reward,
            deadline,
            winner: null
        });
        toast(` Created challenge: "${title}"`);
        render();
    }
    
    // ========== DATA PERSISTENCE ==========
    
    function saveUserData() {
        const data = {
            user: S.user,
            cardCollection: S.cardCollection,
            battleRecord: S.battleRecord,
            battleHistory: S.battleHistory,
            bookProgress: S.bookProgress,
            lockedCardId: S.lockedCardId
        };
        try {
            localStorage.setItem('pressStartData', JSON.stringify(data));
        } catch (e) {
            
        }
    }
    
    function loadUserData() {
        try {
            const saved = localStorage.getItem('pressStartData');
            if (saved) {
                const data = JSON.parse(saved);
                if (data.user) S.user = { ...S.user, ...data.user };
                if (data.cardCollection) S.cardCollection = data.cardCollection;
                if (data.battleRecord) S.battleRecord = data.battleRecord;
                if (data.battleHistory) S.battleHistory = data.battleHistory;
                if (data.bookProgress) S.bookProgress = data.bookProgress;
                if (data.lockedCardId) S.lockedCardId = data.lockedCardId;
            }
        } catch (e) {
            
        }
    }
    
    // Initialize on load
    loadUserData();
    if (S.cardCollection.length === 0) {
        // Add starter card to collection
        S.cardCollection.push(JSON.parse(JSON.stringify(S.card)));
    }
    
    function renderBattleMode() {
        if (!S.battleMode) return '';
        
        // Check if using new advanced battle system
        if (S.currentBattle && S.currentBattle.mode) {
            return renderAdvancedBattle();
        }
        
        // Legacy battle mode (friendly/keeps)
        const opp = S.battleOpponent;
        const result = S.battleResult;
        const scores = S.battleScores || { you: 0, opponent: 0 };
        const rounds = S.battleRounds || [];
        const usedStats = rounds.map(r => r.stat);
        
        return `
            <div style="position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:10000;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;overflow-y:auto">
                <!-- Header -->
                <div style="text-align:center;margin-bottom:16px">
                    <div style="font-family:'Bangers',cursive;font-size:clamp(28px,8vw,36px);color:${S.battleType==='keeps'?'#888':'#999'};text-shadow:0 0 20px ${S.battleType==='keeps'?'#888':'#999'}">
                        ${S.battleType==='keeps'?' FOR KEEPS BATTLE ':' CARD BATTLE '}
                    </div>
                    <div style="font-size:12px;color:#888;margin-top:4px">Best of 3 rounds  ${S.battleType==='keeps'?' WINNER TAKES CARD':'Friendly match'}</div>
                </div>
                
                <!-- Score Display -->
                <div style="display:flex;gap:20px;align-items:center;margin-bottom:16px;background:rgba(255,255,255,0.05);padding:12px 24px;border-radius:30px">
                    <div style="text-align:center">
                        <div style="font-size:28px;color:#fff;font-weight:800">${scores.you}</div>
                        <div style="font-size:10px;color:#888">YOU</div>
                    </div>
                    <div style="font-size:14px;color:#666"></div>
                    <div style="text-align:center">
                        <div style="font-size:28px;color:#888;font-weight:800">${scores.opponent}</div>
                        <div style="font-size:10px;color:#888">OPP</div>
                    </div>
                </div>
                
                <!-- Battle Arena -->
                <div style="display:flex;gap:16px;align-items:center;margin-bottom:20px">
                    <!-- Your Card -->
                    <div style="text-align:center">
                        <div class="ps-card ps-card--${(S.card.evolutionState||'base').toLowerCase()}" style="width:140px;height:190px;background:linear-gradient(135deg,#1a1a2e,#0a0a1a);border-radius:12px;border:3px solid ${getRarityColor(S.card.rarity)};padding:10px;display:flex;flex-direction:column">
                            <div style="font-size:9px;color:${getRarityColor(S.card.rarity)}">${S.card.rarity}  Lv.${S.card.level||0}</div>
                            <div style="flex:1;background:#222;border-radius:8px;margin:6px 0;display:flex;align-items:center;justify-content:center;overflow:hidden">
                                ${S.card.frontImage ? `<img src="${S.card.frontImage}" style="width:100%;height:100%;object-fit:cover">` : `<span style="font-size:36px"></span>`}
                            </div>
                            <div style="font-size:12px;color:#fff;font-weight:700">${S.card.name || 'YOU'}</div>
                        </div>
                        <div style="font-size:11px;color:#fff;margin-top:6px">YOUR CARD</div>
                        <!-- Durability -->
                        <div class="durability-bar" style="width:140px;margin-top:4px">
                            <div class="durability-bar-fill ${(S.card.durability??100) > 60 ? 'high' : (S.card.durability??100) > 30 ? 'medium' : 'low'}" style="width:${S.card.durability ?? 100}%"></div>
                        </div>
                    </div>
                    
                    <!-- VS -->
                    <div style="font-family:'Bangers',cursive;font-size:36px;color:#888;text-shadow:0 0 30px #888">VS</div>
                    
                    <!-- Opponent Card -->
                    <div style="text-align:center">
                        <div style="width:140px;height:190px;background:linear-gradient(135deg,#2a1a1a,#1a0a0a);border-radius:12px;border:3px solid ${getRarityColor(opp.rarity)};padding:10px;display:flex;flex-direction:column">
                            <div style="font-size:9px;color:${getRarityColor(opp.rarity)}">${opp.rarity}</div>
                            <div style="flex:1;background:#222;border-radius:8px;margin:6px 0;display:flex;align-items:center;justify-content:center">
                                <span style="font-size:36px">${opp.avatar || ''}</span>
                            </div>
                            <div style="font-size:12px;color:#fff;font-weight:700">${opp.name}</div>
                        </div>
                        <div style="font-size:11px;color:#888;margin-top:6px">${opp.handle}</div>
                    </div>
                </div>
                
                <!-- Round History -->
                ${rounds.length > 0 ? `
                    <div style="display:flex;gap:8px;margin-bottom:16px">
                        ${rounds.map((r, i) => `
                            <div style="background:${r.winner==='you'?'rgba(34,197,94,0.3)':r.winner==='opponent'?'rgba(239,68,68,0.3)':'rgba(245,158,11,0.3)'};padding:8px 12px;border-radius:8px;text-align:center">
                                <div style="font-size:9px;color:#888">R${i+1}</div>
                                <div style="font-size:11px;color:#fff;font-weight:600">${r.stat.toUpperCase()}</div>
                                <div style="font-size:10px;color:${r.winner==='you'?'#fff':'#888'}">${r.myVal}-${r.oppVal}</div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${!result ? `
                    <!-- Stat Buttons -->
                    <div style="font-size:11px;color:#888;margin-bottom:8px">Round ${(S.battleRound||0)+1}: Choose your stat!</div>
                    <div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;justify-content:center">
                        <button onclick="battleStat('pwr')" ${usedStats.includes('pwr')?'disabled':''} style="padding:14px 20px;border-radius:12px;border:none;background:${usedStats.includes('pwr')?'#333':'linear-gradient(135deg,#888,#aaa)'};color:#fff;font-weight:700;cursor:${usedStats.includes('pwr')?'not-allowed':'pointer'};min-width:90px;opacity:${usedStats.includes('pwr')?'0.5':'1'}">
                            <div style="font-size:10px;opacity:0.8">${S.card.stat1Label||'PWR'}</div>
                            <div style="font-size:22px">${S.card.stats?.pwr||50}</div>
                            <div style="font-size:9px;opacity:0.6">vs ${opp.stats.pwr}</div>
                        </button>
                        <button onclick="battleStat('spd')" ${usedStats.includes('spd')?'disabled':''} style="padding:14px 20px;border-radius:12px;border:none;background:${usedStats.includes('spd')?'#333':'linear-gradient(135deg,#ccc,#06b6d4)'};color:#fff;font-weight:700;cursor:${usedStats.includes('spd')?'not-allowed':'pointer'};min-width:90px;opacity:${usedStats.includes('spd')?'0.5':'1'}">
                            <div style="font-size:10px;opacity:0.8">${S.card.stat2Label||'SPD'}</div>
                            <div style="font-size:22px">${S.card.stats?.spd||50}</div>
                            <div style="font-size:9px;opacity:0.6">vs ${opp.stats.spd}</div>
                        </button>
                        <button onclick="battleStat('int')" ${usedStats.includes('int')?'disabled':''} style="padding:14px 20px;border-radius:12px;border:none;background:${usedStats.includes('int')?'#333':'linear-gradient(135deg,#bbb,#ccc)'};color:#fff;font-weight:700;cursor:${usedStats.includes('int')?'not-allowed':'pointer'};min-width:90px;opacity:${usedStats.includes('int')?'0.5':'1'}">
                            <div style="font-size:10px;opacity:0.8">${S.card.stat3Label||'INT'}</div>
                            <div style="font-size:22px">${S.card.stats?.int||50}</div>
                            <div style="font-size:9px;opacity:0.6">vs ${opp.stats.int}</div>
                        </button>
                    </div>
                ` : ''}
                
                <!-- Final Result -->
                ${result ? `
                    <div style="text-align:center;padding:24px;background:${result.winner==='you'?'rgba(34,197,94,0.2)':result.winner==='opponent'?'rgba(239,68,68,0.2)':'rgba(245,158,11,0.2)'};border-radius:16px;margin-bottom:20px;min-width:280px">
                        <div style="font-size:48px;margin-bottom:8px">${result.winner==='you'?'':result.winner==='opponent'?'':''}</div>
                        <div style="font-size:28px;color:${result.winner==='you'?'#fff':result.winner==='opponent'?'#888':'#999'};font-weight:700;font-family:'Bangers',cursive">
                            ${result.winner==='you'?'VICTORY!':result.winner==='opponent'?'DEFEAT!':'TIE!'}
                        </div>
                        <div style="font-size:14px;color:#888;margin-top:8px">
                            Final Score: ${result.scores.you} - ${result.scores.opponent}
                        </div>
                        ${S.battleType==='keeps' && result.winner==='you' ? `
                            <div style="margin-top:12px;padding:10px;background:rgba(34,197,94,0.3);border-radius:8px">
                                <div style="font-size:12px;color:#fff"> You won "${opp.name}" card!</div>
                            </div>
                        ` : ''}
                        ${S.battleType==='keeps' && result.winner==='opponent' ? `
                            <div style="margin-top:12px;padding:10px;background:rgba(239,68,68,0.3);border-radius:8px">
                                <div style="font-size:12px;color:#888"> You lost your card!</div>
                            </div>
                        ` : ''}
                        ${S.battleType==='friendly' && result.winner==='you' ? `
                            <div style="margin-top:8px;font-size:12px;color:#fff">+5  Credits earned!</div>
                        ` : ''}
                    </div>
                ` : ''}
                
                <!-- Actions -->
                <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
                    ${result ? `
                        <button onclick="S.activeSheet='battle-modes';closeBattle()" style="padding:12px 24px;border-radius:30px;border:none;background:#fff;color:#000;font-weight:700;cursor:pointer;font-size:13px"> More Battles</button>
                    ` : ''}
                    <button onclick="closeBattle()" style="padding:12px 24px;border-radius:30px;border:none;background:rgba(255,255,255,0.1);color:#fff;font-weight:700;cursor:pointer;font-size:13px"> Exit</button>
                </div>
                
                <!-- Battle Record -->
                <div style="margin-top:20px;font-size:11px;color:#666">
                    Your Record: ${S.battleRecord?.wins||0}W - ${S.battleRecord?.losses||0}L  Card XP: ${S.card.xp||0}
                </div>
            </div>
        `;
    }
    
    // Advanced Battle Arena UI
    function renderAdvancedBattle() {
        const battle = S.currentBattle;
        const mode = battle.mode;
        const modeConfig = S.BATTLE_MODES.find(m => m.id === mode);
        const phase = battle.phase;
        const aiCard = battle.aiCards[0] || {};
        
        // PS21 special rendering
        if (mode === 'PS21' && battle.ps21State) {
            return renderPS21Battle();
        }
        
        // Declare War special rendering
        if (mode === 'DECLARE_WAR') {
            return renderWarBattle();
        }
        
        return `
            <div class="battle-arena">
                <!-- Header -->
                <div class="battle-header">
                    <button onclick="exitAdvancedBattle()" style="padding:8px 16px;border-radius:20px;border:none;background:rgba(255,255,255,0.1);color:#fff;cursor:pointer"> Exit</button>
                    <div style="text-align:center">
                        <div style="font-family:'Bangers',cursive;font-size:24px;color:#999">${modeConfig?.icon || ''} ${modeConfig?.name || mode}</div>
                        <div style="font-size:11px;color:#888">${modeConfig?.description || ''}</div>
                    </div>
                    <div style="font-size:12px;color:#888">+${modeConfig?.reward || 0} </div>
                </div>
                
                <!-- Score -->
                <div style="display:flex;justify-content:center;gap:40px;padding:16px;background:rgba(0,0,0,0.3)">
                    <div style="text-align:center">
                        <div style="font-size:36px;font-weight:bold;color:#fff">${battle.playerScore}</div>
                        <div style="font-size:11px;color:#888">YOU</div>
                    </div>
                    <div style="font-size:24px;color:#666;align-self:center">${mode === 'RUMBLE_ROYALE' ? ` ${battle.streakCount}` : 'VS'}</div>
                    <div style="text-align:center">
                        <div style="font-size:36px;font-weight:bold;color:#888">${battle.aiScore}</div>
                        <div style="font-size:11px;color:#888">AI</div>
                    </div>
                </div>
                
                <!-- Cards -->
                <div class="battle-cards">
                    <!-- Your Card -->
                    <div style="text-align:center">
                        <div class="battle-card-slot ${phase==='RESULT'?(battle.result?.winner==='PLAYER'?'winner':'loser'):''}" style="border-color:${getRarityColor(S.card.rarity)}">
                            <div style="text-align:center;padding:10px">
                                ${S.card.frontImage ? `<img src="${S.card.frontImage}" style="width:80px;height:80px;border-radius:8px;object-fit:cover">` : `<div style="font-size:48px"></div>`}
                                <div style="font-size:14px;font-weight:bold;color:#fff;margin-top:8px">${S.card.name}</div>
                                <div style="font-size:10px;color:${getRarityColor(S.card.rarity)}">${S.card.rarity}</div>
                                <div style="font-size:11px;color:#888;margin-top:4px">
                                    PWR ${S.card.stats?.pwr||0}  SPD ${S.card.stats?.spd||0}  INT ${S.card.stats?.int||0}
                                </div>
                            </div>
                        </div>
                        <div style="font-size:12px;color:#fff;margin-top:8px">YOUR CARD</div>
                    </div>
                    
                    <div class="battle-vs">${battle.chaosModifier ? battle.chaosModifier.icon : 'VS'}</div>
                    
                    <!-- AI Card -->
                    <div style="text-align:center">
                        <div class="battle-card-slot ${phase==='RESULT'?(battle.result?.winner==='AI'?'winner':'loser'):''}" style="border-color:${getRarityColor(aiCard.rarity)}">
                            <div style="text-align:center;padding:10px">
                                <div style="font-size:48px">${aiCard.avatar || ''}</div>
                                <div style="font-size:14px;font-weight:bold;color:#fff;margin-top:8px">${aiCard.name || 'AI'}</div>
                                <div style="font-size:10px;color:${getRarityColor(aiCard.rarity)}">${aiCard.rarity || 'COMMON'}</div>
                                <div style="font-size:11px;color:#888;margin-top:4px">
                                    PWR ${aiCard.stats?.pwr||0}  SPD ${aiCard.stats?.spd||0}  INT ${aiCard.stats?.int||0}
                                </div>
                            </div>
                        </div>
                        <div style="font-size:12px;color:#888;margin-top:8px">${aiCard.handle || '@ai_opponent'}</div>
                    </div>
                </div>
                
                <!-- Chaos Modifier Display -->
                ${battle.chaosModifier ? `
                    <div style="text-align:center;padding:12px;background:linear-gradient(135deg,#4c1d95,#1e1b4b);margin:0 20px;border-radius:12px">
                        <div style="font-size:20px">${battle.chaosModifier.icon}</div>
                        <div style="font-size:14px;font-weight:bold;color:#fff">${battle.chaosModifier.name}</div>
                        <div style="font-size:11px;color:#a78bfa">${battle.chaosModifier.description}</div>
                    </div>
                ` : ''}
                
                <!-- Battle Log -->
                <div class="battle-log">
                    ${battle.log.map(l => `<div style="margin:4px 0">${l}</div>`).join('')}
                </div>
                
                <!-- Actions -->
                <div class="battle-actions">
                    ${phase === 'RESULT' ? `
                        <button onclick="exitAdvancedBattle()" class="stat-btn" style="background:linear-gradient(135deg,#fff,#16a34a)"> Done (+${battle.result?.creditsEarned||0} )</button>
                        <button onclick="S.activeSheet='battle-modes';exitAdvancedBattle()" class="stat-btn" style="background:linear-gradient(135deg,#999,#d97706)"> More Battles</button>
                    ` : mode === 'SUDDEN_DEATH' || mode === 'RUMBLE_ROYALE' ? `
                        <button onclick="playAdvancedRound()" class="stat-btn" style="background:linear-gradient(135deg,#888,#dc2626);font-size:18px;padding:20px 40px"> FIGHT!</button>
                    ` : `
                        <button onclick="playAdvancedRound('pwr')" class="stat-btn pwr">PWR ${S.card.stats?.pwr||0}</button>
                        <button onclick="playAdvancedRound('spd')" class="stat-btn spd">SPD ${S.card.stats?.spd||0}</button>
                        <button onclick="playAdvancedRound('int')" class="stat-btn int">INT ${S.card.stats?.int||0}</button>
                    `}
                </div>
            </div>
        `;
    }
    
    // PS21 (Blackjack) Battle UI
    function renderPS21Battle() {
        const battle = S.currentBattle;
        const ps21 = battle.ps21State;
        const phase = ps21.phase;
        
        return `
            <div class="battle-arena">
                <div class="battle-header">
                    <button onclick="exitAdvancedBattle()" style="padding:8px 16px;border-radius:20px;border:none;background:rgba(255,255,255,0.1);color:#fff;cursor:pointer"> Exit</button>
                    <div style="text-align:center">
                        <div style="font-family:'Bangers',cursive;font-size:28px;color:#999"> PS21</div>
                        <div style="font-size:11px;color:#888">Get closest to 21 without busting!</div>
                    </div>
                    <div></div>
                </div>
                
                <!-- Totals -->
                <div style="display:flex;justify-content:center;gap:60px;padding:24px">
                    <div style="text-align:center">
                        <div style="font-size:64px;font-weight:bold;color:${ps21.playerTotal > 21 ? '#888' : ps21.playerTotal === 21 ? '#fff' : '#fff'}">${ps21.playerTotal}</div>
                        <div style="font-size:14px;color:#888">YOUR TOTAL</div>
                        <div style="display:flex;gap:4px;justify-content:center;margin-top:8px">
                            ${ps21.playerCards.map(c => `<div style="padding:4px 8px;background:rgba(255,255,255,0.1);border-radius:4px;font-size:11px;color:#fff">${c.value}${c.isCrit?'':''}</div>`).join('')}
                        </div>
                    </div>
                    <div style="align-self:center;font-size:24px;color:#666">VS</div>
                    <div style="text-align:center">
                        <div style="font-size:64px;font-weight:bold;color:${ps21.aiTotal > 21 ? '#888' : ps21.aiTotal === 21 ? '#fff' : '#888'}">${phase === 'PLAYER_TURN' ? '?' : ps21.aiTotal}</div>
                        <div style="font-size:14px;color:#888">AI TOTAL</div>
                        <div style="display:flex;gap:4px;justify-content:center;margin-top:8px">
                            ${ps21.aiCards.map((c, i) => `<div style="padding:4px 8px;background:rgba(255,255,255,0.1);border-radius:4px;font-size:11px;color:#fff">${phase === 'PLAYER_TURN' && i > 0 ? '?' : c.value}</div>`).join('')}
                        </div>
                    </div>
                </div>
                
                <!-- Log -->
                <div class="battle-log">
                    ${battle.log.map(l => `<div style="margin:4px 0">${l}</div>`).join('')}
                </div>
                
                <!-- Actions -->
                <div class="battle-actions">
                    ${phase === 'PLAYER_TURN' ? `
                        <button onclick="ps21Hit()" class="stat-btn" style="background:linear-gradient(135deg,#fff,#16a34a);font-size:16px"> HIT</button>
                        <button onclick="ps21Stay()" class="stat-btn" style="background:linear-gradient(135deg,#999,#d97706);font-size:16px"> STAY</button>
                        ${ps21.playerCards.length === 2 ? `
                            <button onclick="ps21DoubleDown()" class="stat-btn" style="background:linear-gradient(135deg,#bbb,#7c3aed);font-size:16px"> DOUBLE</button>
                        ` : ''}
                    ` : phase === 'RESULT' ? `
                        <button onclick="exitAdvancedBattle()" class="stat-btn" style="background:linear-gradient(135deg,#fff,#16a34a)"> Done (+${battle.result?.creditsEarned||0} )</button>
                    ` : `
                        <div style="color:#888">AI is playing...</div>
                    `}
                </div>
            </div>
        `;
    }
    
    // Declare War Battle UI
    function renderWarBattle() {
        const battle = S.currentBattle;
        
        return `
            <div class="battle-arena">
                <div class="battle-header">
                    <button onclick="exitAdvancedBattle()" style="padding:8px 16px;border-radius:20px;border:none;background:rgba(255,255,255,0.1);color:#fff;cursor:pointer"> Exit</button>
                    <div style="text-align:center">
                        <div style="font-family:'Bangers',cursive;font-size:28px;color:#888"> I DECLARE WAR</div>
                        <div style="font-size:11px;color:#888">First to 10 points wins!</div>
                    </div>
                    <div></div>
                </div>
                
                <!-- War Points -->
                <div style="display:flex;justify-content:center;gap:60px;padding:24px">
                    <div style="text-align:center">
                        <div style="font-size:72px;font-weight:bold;color:#fff">${battle.warPoints.player}</div>
                        <div style="font-size:14px;color:#888">YOUR POINTS</div>
                    </div>
                    <div style="align-self:center">
                        <div style="font-size:32px;color:#999"></div>
                        <div style="font-size:11px;color:#666">FIRST TO 10</div>
                    </div>
                    <div style="text-align:center">
                        <div style="font-size:72px;font-weight:bold;color:#888">${battle.warPoints.ai}</div>
                        <div style="font-size:14px;color:#888">AI POINTS</div>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div style="padding:0 40px;margin-bottom:20px">
                    <div style="display:flex;height:12px;border-radius:6px;overflow:hidden;background:#333">
                        <div style="width:${battle.warPoints.player * 10}%;background:linear-gradient(90deg,#fff,#16a34a);transition:width 0.3s"></div>
                        <div style="flex:1"></div>
                        <div style="width:${battle.warPoints.ai * 10}%;background:linear-gradient(90deg,#dc2626,#888);transition:width 0.3s"></div>
                    </div>
                </div>
                
                <!-- Log -->
                <div class="battle-log">
                    ${battle.log.map(l => `<div style="margin:4px 0">${l}</div>`).join('')}
                </div>
                
                <!-- Actions -->
                <div class="battle-actions">
                    ${battle.phase === 'RESULT' ? `
                        <button onclick="exitAdvancedBattle()" class="stat-btn" style="background:linear-gradient(135deg,#fff,#16a34a)"> Done (+${battle.result?.creditsEarned||0} )</button>
                    ` : `
                        <button onclick="playWarRound()" class="stat-btn" style="background:linear-gradient(135deg,#888,#dc2626);font-size:18px;padding:20px 60px"> DRAW CARD</button>
                    `}
                </div>
            </div>
        `;
    }
    
    function getPage() {
        var page = S.pages[S.currentPage];
        if (!page) {
            page = createPage();
            S.pages[S.currentPage] = page;
        }
        if (!page.panelMedia) page.panelMedia = {};
        if (!page.panelFilters) page.panelFilters = {};
        if (!page.pageElements) page.pageElements = [];
        return page;
    }
    
    // ========== TIER & PREMIUM UTILITIES ==========
    
    function getUserTier() {
        try {
            // Classroom mode overrides everything
            if (S.adminConfig && S.adminConfig.classroomMode) return 'classroom';
            return S.userTier || 'free';
        } catch(e) {
            console.error('getUserTier error:', e);
            return 'free';
        }
    }
    
    function getTierLimits() {
        try {
            return S.TIER_LIMITS[getUserTier()] || S.TIER_LIMITS.free;
        } catch(e) {
            console.error('getTierLimits error:', e);
            return { exports: 3, aiGens: 0, cloudSaves: 5, watermark: true };
        }
    }
    
    function isPremium() {
        try {
            const tier = getUserTier();
            return tier === 'plus' || tier === 'pro' || tier === 'classroom';
        } catch(e) {
            console.error('isPremium error:', e);
            return false;
        }
    }
    
    function canExport() {
        try {
            if (!S.adminConfig || !S.adminConfig.exportLimitsEnabled) return true;
            if (S.adminConfig.classroomMode) return true;
        
            // Reset counter if new day
            const today = new Date().toDateString();
            if (S.exportsDate !== today) {
                S.exportsToday = 0;
                S.exportsDate = today;
                localStorage.setItem('pscomixx_exports_today', '0');
                localStorage.setItem('pscomixx_exports_date', today);
            }
            
            const limits = getTierLimits();
            return S.exportsToday < limits.exports;
        } catch(e) {
            console.error('canExport error:', e);
            return true;
        }
    }
    
    function getExportsRemaining() {
        try {
            const limits = getTierLimits();
            return Math.max(0, limits.exports - S.exportsToday);
        } catch(e) {
            return 3;
        }
    }
    
    function incrementExportCount() {
        try {
            S.exportsToday++;
            localStorage.setItem('pscomixx_exports_today', S.exportsToday.toString());
        } catch(e) {
            console.error('incrementExportCount error:', e);
        }
    }
    
    function canUseAI() {
        try {
            if (!S.adminConfig || !S.adminConfig.aiLimitsEnabled) return true;
            if (S.adminConfig.classroomMode) return true;
            
            const tier = getUserTier();
            if (tier === 'free') return false;
            
            // Reset if new month
            const currentMonth = new Date().getMonth().toString();
            if (S.aiGensMonth !== currentMonth) {
                S.aiGensThisMonth = 0;
                S.aiGensMonth = currentMonth;
                localStorage.setItem('pscomixx_ai_gens_month', '0');
                localStorage.setItem('pscomixx_ai_gens_month_date', currentMonth);
            }
            
            const limits = getTierLimits();
            return S.aiGensThisMonth < limits.aiGens;
        } catch(e) {
            console.error('canUseAI error:', e);
            return true;
        }
    }
    
    function shouldShowWatermark() {
        try {
            if (!S.adminConfig || !S.adminConfig.watermarksEnabled) return false;
            if (S.adminConfig.classroomMode) return false;
            return getTierLimits().watermark;
        } catch(e) {
            console.error('shouldShowWatermark error:', e);
            return false;
        }
    }
    
    function showUpgradeModal(feature = 'premium') {
        try {
            if (!S.adminConfig || !S.adminConfig.showUpgradePrompts) return;
            S.upgradeModal = { show: true, feature: feature };
            render();
        } catch(e) {
            console.error('showUpgradeModal error:', e);
        }
    }
    
    function closeUpgradeModal() {
        S.upgradeModal = null;
        render();
    }
    
    function setUserTier(tier) {
        S.userTier = tier;
        localStorage.setItem('pscomixx_tier', tier);
        toast(` Tier set to ${tier.toUpperCase()}`);
        render();
    }
    
    function saveAdminConfig() {
        localStorage.setItem('pscomixx_admin_config', JSON.stringify(S.adminConfig));
        toast(' Admin config saved');
    }
    
    function addWatermark(ctx, width, height) {
        if (!shouldShowWatermark()) return;
        
        ctx.save();
        
        // Semi-transparent watermark bar at bottom
        ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        ctx.fillRect(0, height - 40, width, 40);
        
        // Watermark text
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 14px Arial, sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('Made with CoMiXX  Upgrade for no watermark', width / 2, height - 20);
        
        // Diagonal watermark for extra visibility
        ctx.globalAlpha = 0.1;
        ctx.font = 'bold 48px Arial, sans-serif';
        ctx.translate(width / 2, height / 2);
        ctx.rotate(-Math.PI / 6);
        ctx.fillStyle = '#fff';
        ctx.fillText('CoMiXX', 0, 0);
        
        ctx.restore();
    }
    
    var uploadTarget = null;
    var uploadIdx = null;
    
    // AI IMAGE GENERATION (Pollinations.ai - FREE!)
    S.aiGenModal = null; // { target: 'panel'|'card-front'|'card-back'|'cover-front'|'cover-back', index: number }
    S.aiGenPrompt = '';
    S.aiGenLoading = false;
    S.aiGenPreview = null;
    S.aiGenStyle = 'anime'; // anime, realistic, comic, fantasy, cyberpunk
    
    function openAIGen(target, index) {
        S.aiGenModal = { target, index };
        S.aiGenPrompt = '';
        S.aiGenPreview = null;
        S.aiGenLoading = false;
        render();
    }
    
    function closeAIGen() {
        S.aiGenModal = null;
        S.aiGenPrompt = '';
        S.aiGenPreview = null;
        S.aiGenLoading = false;
        render();
    }
    
    function generateAIImage() {
        if (!S.aiGenPrompt.trim()) {
            toast('Please enter a prompt!');
            return;
        }
        
        S.aiGenLoading = true;
        render();
        
        // Get selected model configuration
        const model = S.AI_MODELS[S.aiModel] || S.AI_MODELS['pollinations'];
        
        // Build the image URL using the model's endpoint template
        const fullPrompt = encodeURIComponent(S.aiGenPrompt.trim());
        const imageUrl = model.endpoint.replace('{prompt}', fullPrompt);
        
        // Create image to test loading
        const img = new Image();
        img.crossOrigin = 'anonymous';
        
        img.onload = function() {
            S.aiGenLoading = false;
            S.aiGenPreview = imageUrl;
            render();
            toast(' Generated with ' + model.name + '!');
        };
        
        img.onerror = function() {
            S.aiGenLoading = false;
            render();
            toast('Error generating image. Try again!');
        };
        
        img.src = imageUrl;
    }
    
    function useAIImage() {
        if (!S.aiGenPreview || !S.aiGenModal) return;
        
        const target = S.aiGenModal.target;
        const idx = S.aiGenModal.index;
        
        // Apply the image to the target
        if (target === 'panel') {
            const page = getPage();
            if (!page.panelMedia) page.panelMedia = {};
            page.panelMedia[idx] = { 
                type: 'image', 
                src: S.aiGenPreview, 
                transform: { scale: 1, rotation: 0, offsetX: 0, offsetY: 0 }
            };
        } else if (target === 'card-front') {
            S.card.frontImage = S.aiGenPreview;
            S.card.frontTransform = { scale: 1, rotation: 0, offsetX: 0, offsetY: 0 };
        } else if (target === 'card-back') {
            S.card.backImage = S.aiGenPreview;
            S.card.backTransform = { scale: 1, rotation: 0, offsetX: 0, offsetY: 0 };
        } else if (target === 'cover-front') {
            S.cover.frontImage = S.aiGenPreview;
            S.cover.frontTransform = { scale: 1, rotation: 0, offsetX: 0, offsetY: 0 };
        } else if (target === 'cover-back') {
            S.cover.backImage = S.aiGenPreview;
            S.cover.backTransform = { scale: 1, rotation: 0, offsetX: 0, offsetY: 0 };
        }
        
        toast(' AI image applied!');
        closeAIGen();
    }
    
    function saveAIImageToPhotos() {
        if (!S.aiGenPreview) return;
        
        // Show the save preview modal with the AI generated image
        S.savePreview = {
            dataUrl: S.aiGenPreview,
            type: 'ai-image'
        };
        render();
    }
    
    function renderAIGenModal() {
        if (!S.aiGenModal) return '';
        
        return `
            <div style="position:fixed;inset:0;background:#000;z-index:10001;display:flex;flex-direction:column;overflow-y:auto">
                <!-- Header -->
                <div style="padding:16px 20px;border-bottom:1px solid #222;display:flex;justify-content:space-between;align-items:center;background:#0a0a0a">
                    <div>
                        <div style="font-family:'Bangers',cursive;font-size:24px;color:#fff"> AI IMAGE LAB</div>
                        <div style="font-size:11px;color:#666">Choose Your Art Engine</div>
                    </div>
                    <button onclick="closeAIGen()" style="background:none;border:none;color:#fff;font-size:24px;cursor:pointer"></button>
                </div>
                
                <div style="flex:1;overflow-y:auto;padding:16px">
                    <!-- Model Selector -->
                    <div style="margin-bottom:20px">
                        <div style="font-size:11px;color:#888;margin-bottom:10px;font-weight:600">SELECT ART ENGINE</div>
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
                            ${Object.entries(S.AI_MODELS).map(([id, model]) => `
                                <div onclick="S.aiModel='${id}';localStorage.setItem('pscomixx_ai_model','${id}');render()" 
                                     style="padding:12px;border-radius:12px;border:2px solid ${S.aiModel===id?'#fff':'#333'};background:${S.aiModel===id?'rgba(255,255,255,0.1)':'#111'};cursor:pointer;transition:all 0.2s">
                                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                                        <span style="font-size:18px">${model.icon}</span>
                                        <span style="font-size:13px;font-weight:700;color:${S.aiModel===id?'#fff':'#ccc'}">${model.name}</span>
                                    </div>
                                    <div style="font-size:9px;color:#666">${model.engine}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Selected Model Info -->
                    <div style="margin-bottom:16px;padding:14px;background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:12px;border:1px solid #333">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                            <span style="font-size:24px">${S.AI_MODELS[S.aiModel].icon}</span>
                            <div>
                                <div style="font-size:14px;font-weight:700;color:#fff">${S.AI_MODELS[S.aiModel].name}</div>
                                <div style="font-size:10px;color:#888">${S.AI_MODELS[S.aiModel].engine}</div>
                            </div>
                        </div>
                        <div style="font-size:11px;color:#aaa;line-height:1.5;margin-bottom:8px">${S.AI_MODELS[S.aiModel].description}</div>
                        <div style="font-size:10px;color:#4a9eff"> Best for: ${S.AI_MODELS[S.aiModel].bestFor}</div>
                    </div>
                    
                    <!-- Prompt Input -->
                    <div style="margin-bottom:16px">
                        <label style="font-size:11px;color:#888;display:block;margin-bottom:6px;font-weight:600">DESCRIBE YOUR IMAGE</label>
                        <textarea 
                            placeholder="${S.AI_MODELS[S.aiModel].styleTip}"
                            style="width:100%;height:80px;background:#111;border:1px solid #333;border-radius:12px;padding:12px;color:#fff;font-size:13px;resize:none;box-sizing:border-box"
                            oninput="S.aiGenPrompt=this.value"
                        >${S.aiGenPrompt}</textarea>
                        <div style="font-size:9px;color:#555;margin-top:4px"> ${S.AI_MODELS[S.aiModel].styleTip}</div>
                    </div>
                    
                    <!-- Quick Style Tags -->
                    <div style="margin-bottom:16px">
                        <div style="font-size:10px;color:#666;margin-bottom:8px">QUICK ADD:</div>
                        <div style="display:flex;flex-wrap:wrap;gap:6px">
                            ${['dramatic lighting', 'dynamic pose', 'comic style', 'bold outlines', 'vibrant colors', 'dark mood', 'action shot', 'portrait'].map(tag => `
                                <button onclick="S.aiGenPrompt=(S.aiGenPrompt?S.aiGenPrompt+', ':'')+' ${tag}';render()" style="padding:6px 10px;border-radius:15px;border:1px solid #333;background:#1a1a1a;color:#888;font-size:10px;cursor:pointer">+${tag}</button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Generate Button -->
                    <button onclick="generateAIImage()" ${S.aiGenLoading?'disabled':''} style="width:100%;padding:16px;border-radius:12px;border:none;background:${S.aiGenLoading?'#333':'linear-gradient(135deg,#667eea,#764ba2)'};color:#fff;font-size:15px;font-weight:700;cursor:${S.aiGenLoading?'wait':'pointer'};margin-bottom:16px;box-shadow:${S.aiGenLoading?'none':'0 4px 15px rgba(102,126,234,0.4)'}">
                        ${S.aiGenLoading ? ' Creating with ' + S.AI_MODELS[S.aiModel].name + '...' : ' Generate with ' + S.AI_MODELS[S.aiModel].name}
                    </button>
                    
                    <!-- Preview -->
                    ${S.aiGenPreview ? `
                        <div style="text-align:center">
                            <div style="font-size:10px;color:#888;margin-bottom:8px">GENERATED IMAGE</div>
                            <div style="width:100%;max-width:350px;margin:0 auto;aspect-ratio:1;border-radius:16px;overflow:hidden;border:2px solid #333;margin-bottom:12px">
                                <img src="${S.aiGenPreview}" style="width:100%;height:100%;object-fit:cover">
                            </div>
                            <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
                                <button onclick="generateAIImage()" style="padding:10px 20px;border-radius:20px;border:1px solid #444;background:transparent;color:#fff;font-size:12px;cursor:pointer"> Regenerate</button>
                                <button onclick="saveAIImageToPhotos()" style="padding:10px 20px;border-radius:20px;border:1px solid #666;background:transparent;color:#fff;font-size:12px;cursor:pointer"> Save</button>
                                <button onclick="useAIImage()" style="padding:10px 20px;border-radius:20px;border:none;background:#fff;color:#000;font-size:12px;font-weight:700;cursor:pointer"> Use Image</button>
                            </div>
                        </div>
                    ` : `
                        <div style="padding:40px;text-align:center;color:#444;font-size:13px">
                            ${S.aiGenLoading ? '<div style="font-size:32px;margin-bottom:12px"></div>Creating your masterpiece...' : '<div style="font-size:32px;margin-bottom:12px"></div>Enter a prompt and select your art engine'}
                        </div>
                    `}
                </div>
            </div>
        `;
    }
    
    // Show image source options (Upload or AI)
    S.imageOptionsModal = null; // { target, index }
    
    function showImageOptions(target, index) {
        S.imageOptionsModal = { target, index };
        render();
    }
    
    function closeImageOptions() {
        S.imageOptionsModal = null;
        // Don't render here on mobile - let the next action handle it
        if (window.innerWidth >= 768) {
            render();
        }
    }
    
    function renderImageOptionsModal() {
        if (!S.imageOptionsModal) return '';
        
        const { target, index } = S.imageOptionsModal;
        const isMobile = window.innerWidth < 768;
        
        return `
            <div onclick="closeImageOptions();${isMobile ? '' : 'render();'}" style="position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px">
                <div onclick="event.stopPropagation()" style="background:#111;border:1px solid #333;border-radius:20px;padding:24px;max-width:320px;width:100%;text-align:center">
                    <div style="font-size:20px;color:#fff;font-weight:700;margin-bottom:8px">Add Image</div>
                    <div style="font-size:13px;color:#888;margin-bottom:24px">Choose how to add your image</div>
                    
                    <div style="display:flex;flex-direction:column;gap:12px">
                        <button onclick="S.imageOptionsModal=null;triggerUpload('${target}',${index !== undefined ? index : 'null'})" style="padding:16px;border-radius:12px;border:2px solid #fff;background:transparent;color:#fff;font-size:15px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px">
                             Upload Photo
                        </button>
                        <button onclick="closeImageOptions();openAIGen('${target}',${index !== undefined ? index : 'null'})" style="padding:16px;border-radius:12px;border:none;background:#fff;color:#000;font-size:15px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px">
                             Generate with AI
                        </button>
                        <button onclick="closeImageOptions();render();" style="padding:12px;border-radius:12px;border:1px solid #444;background:transparent;color:#666;font-size:13px;cursor:pointer">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    function triggerUpload(t, i) { 
        uploadTarget = t; 
        uploadIdx = (i !== undefined && i !== null) ? i : null;
        console.log('triggerUpload called:', t, i);
        var fileInput = document.getElementById('fileInput');
        if (fileInput) {
            fileInput.click(); 
        }
    }
    
    function handleFile(e) {
        var files = e.target.files;
        if (!files || files.length === 0) {
            console.log('No file selected');
            return;
        }
        
        var f = files[0];
        
        // Store the target and index immediately
        var target = uploadTarget;
        var idx = uploadIdx;
        
        // Detect if it's a video file
        var isVideo = f.type.startsWith('video/');
        
        console.log('handleFile - target:', target, 'idx:', idx, 'file:', f.name, 'size:', f.size, 'isVideo:', isVideo);
        
        // Validate we have a target
        if (!target) {
            console.error('No upload target set');
            toast('Error: No target selected');
            e.target.value = '';
            return;
        }
        
        // For panels, validate we have an index
        if (target === 'panel' && (idx === null || idx === undefined)) {
            console.error('Panel target but no index');
            toast('Error: Please select a panel first');
            e.target.value = '';
            return;
        }
        
        toast('Loading...');
        
        // Check file size - limit to 5MB on mobile to prevent crashes
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const maxSize = isMobile ? 5 * 1024 * 1024 : 20 * 1024 * 1024;
        if (f.size > maxSize) {
            toast('Image too large. Max ' + (isMobile ? '5MB' : '20MB'));
            e.target.value = '';
            return;
        }
        
        // USE BLOB URL FOR MOBILE (much more memory efficient)
        if (isMobile) {
            try {
                var blobUrl = URL.createObjectURL(f);
                applyMediaToTarget(target, idx, blobUrl, isVideo);
                toast(isVideo ? ' Video added!' : ' Added!');
                
                // Simple delayed render for mobile
                setTimeout(function() { 
                    try { render(); } catch(e) { console.error('Render error:', e); } 
                }, 200);
            } catch(err) {
                console.error('Blob URL error:', err);
                toast('Error processing file');
            }
            e.target.value = '';
            return;
        }
        
        // Desktop: use data URL for persistence
        var reader = new FileReader();
        
        reader.onload = function(ev) {
            try {
                var result = ev.target.result;
                
                if (!result) {
                    toast('Error reading file');
                    return;
                }
                
                applyMediaToTarget(target, idx, result, isVideo);
                toast(isVideo ? ' Video added!' : ' Added!');
                setTimeout(() => { try { render(); } catch(e) {} }, 50);
            } catch(err) {
                console.error('Image error:', err);
                toast('Error processing image');
            }
        };
        
        reader.onerror = function(err) {
            console.error('FileReader error:', err);
            toast('Error reading file');
        };
        
        reader.readAsDataURL(f);
        
        // Reset the input after starting the read
        e.target.value = '';
    }
    
    function applyMediaToTarget(target, idx, src, isVideo) {
        if (target === 'panel') {
            var page = getPage();
            if (!page.panelMedia) page.panelMedia = {};
            page.panelMedia[idx] = { 
                src: src, 
                isVideo: isVideo,
                scale: 1, 
                rotation: 0, 
                offsetX: 0, 
                offsetY: 0 
            };
            S.selectedPanel = idx;
        } else if (target === 'card-front') {
            S.card.frontImage = src;
            S.card.frontTransform = { scale: 1, rotation: 0, offsetX: 0, offsetY: 0 };
        } else if (target === 'card-back') {
            S.card.backImage = src;
            S.card.backTransform = { scale: 1, rotation: 0, offsetX: 0, offsetY: 0 };
        } else if (target === 'card-back-bg') {
            S.card.backBgImage = src;
        } else if (target === 'cover-front') {
            S.cover.frontImage = src;
            S.cover.frontTransform = { scale: 1, rotation: 0, offsetX: 0, offsetY: 0 };
        } else if (target === 'cover-back') {
            S.cover.backImage = src;
            S.cover.backTransform = { scale: 1, rotation: 0, offsetX: 0, offsetY: 0 };
        } else if (target === 'cover-back-bg') {
            S.cover.backBgImage = src;
        } else if (target === 'cover-barcode') {
            S.cover.barcodeImage = src;
        } else if (target === 'card') {
            S.card.frontImage = src;
            S.card.frontTransform = { scale: 1, rotation: 0, offsetX: 0, offsetY: 0 };
        } else if (target === 'cover') {
            S.cover.frontImage = src;
            S.cover.frontTransform = { scale: 1, rotation: 0, offsetX: 0, offsetY: 0 };
        }
    }

    function selectPanel(i, e) { 
        e?.stopPropagation(); 
        const wasSelected = S.selectedPanel === i;
        S.selectedPanel = wasSelected ? null : i; 
        S.selectedElement = null; 
        
        // If tapping an empty panel, show image options
        const page = getPage();
        const media = page && page.panelMedia ? page.panelMedia[i] : null;
        if (!wasSelected && !media) {
            showImageOptions('panel', i);
            return;
        }
        
        // CHANGED: If tapping a panel WITH media, open transform frame directly
        if (!wasSelected && media && media.src) {
            openMediaEditor('panel', i);
            return;
        }
        
        // On mobile with media, don't render - controls are inline
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        if (isMobile && media) {
            // Just update selection visually
            document.querySelectorAll('.panel').forEach((p, idx) => {
                p.classList.toggle('selected', idx === i && !wasSelected);
            });
            return;
        }
        
        render(); 
    }
    function clearSelection() { S.selectedPanel = null; S.selectedElement = null; render(); }
    function clearMedia(i) { delete getPage().panelMedia[i]; S.selectedPanel = null; toast('Removed!'); render(); }
    
    // Quick controls - use same pattern as gesture handlers
    function quickScale(idx, delta) {
        const page = getPage();
        if (!page || !page.panelMedia || !page.panelMedia[idx]) return;
        const media = page.panelMedia[idx];
        media.scale = Math.max(0.3, Math.min(5, (media.scale || 1) + delta));
        
        // Update DOM directly for smooth feedback (same as gesture handlers)
        const panels = document.querySelectorAll('.panel');
        if (panels[idx]) {
            const img = panels[idx].querySelector('.panel-media');
            if (img) {
                img.style.transform = `scale(${media.scale || 1}) rotate(${media.rotation || 0}deg) translate(${media.offsetX || 0}%, ${media.offsetY || 0}%)`;
            }
        }
    }
    
    function quickClear(idx) {
        const page = getPage();
        if (!page || !page.panelMedia) return;
        delete page.panelMedia[idx];
        render();
        toast('Removed!');
    }
    
    function selectElement(id, e) { 
        if (e) { e.stopPropagation(); e.preventDefault(); }
        S.selectedElement = S.selectedElement === id ? null : id; 
        S.selectedPanel = null; 
        render(); 
    }

    // Drag functionality - simplified and reliable
    let isDragging = false;
    let dragEl = null;
    let dragStartX = 0;
    let dragStartY = 0;
    let dragOrigX = 0;
    let dragOrigY = 0;
    let canvasRect = null;
    
    function startDrag(e, id) {
        // Don't start drag if clicking on edit/delete buttons
        if (e.target.closest('.edit-btn') || e.target.closest('.delete-btn')) {
            return;
        }
        
        e.preventDefault();
        e.stopPropagation();
        
        const el = getPage().pageElements.find(x => x.id === id);
        if (!el) return;
        
        const canvas = document.querySelector('.canvas-comic');
        if (!canvas) return;
        
        isDragging = true;
        dragEl = el;
        canvasRect = canvas.getBoundingClientRect();
        
        const touch = e.touches ? e.touches[0] : e;
        dragStartX = touch.clientX;
        dragStartY = touch.clientY;
        dragOrigX = el.x;
        dragOrigY = el.y;
        
        S.selectedElement = id;
        S.selectedPanel = null;
        
        // Add global listeners
        window.addEventListener('mousemove', onDrag, { passive: false });
        window.addEventListener('mouseup', endDrag);
        window.addEventListener('touchmove', onDrag, { passive: false });
        window.addEventListener('touchend', endDrag);
        window.addEventListener('touchcancel', endDrag);
    }
    
    function onDrag(e) {
        if (!isDragging || !dragEl || !canvasRect) return;
        e.preventDefault();
        
        const touch = e.touches ? e.touches[0] : e;
        const dx = touch.clientX - dragStartX;
        const dy = touch.clientY - dragStartY;
        
        const pctX = (dx / canvasRect.width) * 100;
        const pctY = (dy / canvasRect.height) * 100;
        
        dragEl.x = Math.max(5, Math.min(95, dragOrigX + pctX));
        dragEl.y = Math.max(5, Math.min(95, dragOrigY + pctY));
        
        // Update element directly in DOM
        const elDiv = document.querySelector(`[data-elid="${dragEl.id}"]`);
        if (elDiv) {
            elDiv.style.left = dragEl.x + '%';
            elDiv.style.top = dragEl.y + '%';
        }
    }
    
    function endDrag(e) {
        if (isDragging) {
            isDragging = false;
            dragEl = null;
            canvasRect = null;
            render();
        }
        
        window.removeEventListener('mousemove', onDrag);
        window.removeEventListener('mouseup', endDrag);
        window.removeEventListener('touchmove', onDrag);
        window.removeEventListener('touchend', endDrag);
        window.removeEventListener('touchcancel', endDrag);
    }
    
    function rotateElement(deg) {
        if (!S.selectedElement) return;
        const el = getPage().pageElements.find(x => x.id === S.selectedElement);
        if (el) {
            el.rotation = (el.rotation || 0) + deg;
            render();
        }
    }
    
    function scaleElement(amount) {
        if (!S.selectedElement) return;
        const el = getPage().pageElements.find(x => x.id === S.selectedElement);
        if (el) {
            el.scale = Math.max(0.3, Math.min(3, (el.scale || 1) + amount));
            render();
        }
    }
    
    function resetElementTransform() {
        if (!S.selectedElement) return;
        const el = getPage().pageElements.find(x => x.id === S.selectedElement);
        if (el) {
            el.rotation = 0;
            el.scale = 1;
            render();
        }
    }
    
    // ========== PANEL GIZMO INTERACTIONS ==========
    // Exact code from working version
    
    let panelGizmoActive = false;
    let panelGizmoType = ''; // 'drag', 'scale', 'rotate', 'pinch'
    let panelGizmoIndex = 0;
    let panelGizmoStartX = 0, panelGizmoStartY = 0;
    let panelGizmoStartValues = {};
    
    let panelPinchActive = false;
    let panelPinchStartDist = 0;
    let panelPinchStartAngle = 0;
    let panelPinchStartScale = 1;
    let panelPinchStartRotation = 0;
    let panelPinchIndex = 0;
    
    function getPinchData(touches) {
        if (!touches || touches.length < 2) return { dist: 100, angle: 0, centerX: 0, centerY: 0 };
        const t1 = touches[0];
        const t2 = touches[1];
        const dx = t2.clientX - t1.clientX;
        const dy = t2.clientY - t1.clientY;
        return {
            dist: Math.hypot(dx, dy),
            angle: Math.atan2(dy, dx) * 180 / Math.PI,
            centerX: (t1.clientX + t2.clientX) / 2,
            centerY: (t1.clientY + t2.clientY) / 2
        };
    }
    
    function startPanelDrag(e, idx) {
        // Don't interfere with PS Express handles
        if (e.target.closest('.ps-handle')) return;
        
        // iPhone 16 specific fixes
        console.log('startPanelDrag called on iPhone 16', idx);
        
        // Check for pinch gesture (2 fingers)
        if (e.touches && e.touches.length === 2) {
            e.preventDefault();
            e.stopPropagation();
            
            const media = getPage().panelMedia[idx];
            if (!media) return;
            
            panelPinchActive = true;
            panelPinchIndex = idx;
            
            const pinch = getPinchData(e.touches);
            panelPinchStartDist = pinch.dist;
            panelPinchStartAngle = pinch.angle;
            panelPinchStartScale = media.scale || 1;
            panelPinchStartRotation = media.rotation || 0;
            
            window.addEventListener('touchmove', onPanelPinch, { passive: false, capture: true });
            window.addEventListener('touchend', endPanelPinch, { passive: false, capture: true });
            return;
        }
        
        // Single touch = drag image within panel
        e.preventDefault();
        e.stopPropagation();
        
        const media = getPage().panelMedia[idx];
        if (!media) return;
        
        console.log('Starting image drag for media:', media);
        
        panelGizmoActive = true;
        panelGizmoType = 'drag';
        panelGizmoIndex = idx;
        
        const touch = e.touches ? e.touches[0] : e;
        panelGizmoStartX = touch.clientX;
        panelGizmoStartY = touch.clientY;
        panelGizmoStartValues = {
            offsetX: media.offsetX || 0,
            offsetY: media.offsetY || 0
        };
        
        // iPhone 16 specific event binding with capture
        window.addEventListener('mousemove', onPanelGizmo, { passive: false, capture: true });
        window.addEventListener('mouseup', endPanelGizmo, { passive: false, capture: true });
        window.addEventListener('touchmove', onPanelGizmo, { passive: false, capture: true });
        window.addEventListener('touchend', endPanelGizmo, { passive: false, capture: true });
        
        // iPhone 16 visual feedback for image drag
        const img = e.target.closest('.panel-media');
        if (img) {
            img.style.opacity = '0.8'; // Visual feedback that drag started
        }
    }
    
    function onPanelPinch(e) {
        if (!panelPinchActive) return;
        if (!e.touches || e.touches.length < 2) return;
        e.preventDefault();
        
        const media = getPage().panelMedia[panelPinchIndex];
        if (!media) return;
        
        const pinch = getPinchData(e.touches);
        
        // Calculate scale change
        const scaleRatio = pinch.dist / panelPinchStartDist;
        media.scale = Math.max(0.2, Math.min(5, panelPinchStartScale * scaleRatio));
        
        // Calculate rotation change
        const angleDiff = pinch.angle - panelPinchStartAngle;
        media.rotation = Math.round(panelPinchStartRotation + angleDiff);
        
        // Update DOM directly for smooth feedback
        const panels = document.querySelectorAll('.panel');
        const panel = panels[panelPinchIndex];
        if (panel) {
            const img = panel.querySelector('.panel-media');
            if (img) {
                img.style.transform = `scale(${media.scale}) rotate(${media.rotation}deg) translate(${media.offsetX || 0}%, ${media.offsetY || 0}%)`;
            }
        }
    }
    
    function endPanelPinch(e) {
        if (panelPinchActive) {
            panelPinchActive = false;
            render();
            toast(`Scale: ${(getPage().panelMedia[panelPinchIndex]?.scale || 1).toFixed(1)}x`);
        }
        
        // iPhone 16 specific cleanup with capture
        window.removeEventListener('touchmove', onPanelPinch, { capture: true });
        window.removeEventListener('touchend', endPanelPinch, { capture: true });
        
        // Fallback cleanup
        window.removeEventListener('touchmove', onPanelPinch);
        window.removeEventListener('touchend', endPanelPinch);
    }
    
    function startPanelScale(e, idx, corner) {
        console.log('startPanelScale called', idx, corner);
        
        // iPhone 16 specific fixes
        if (e.touches && e.touches.length > 1) return; // Only single touch
        
        e.preventDefault();
        e.stopPropagation();
        
        const media = getPage().panelMedia[idx];
        console.log('media:', media);
        if (!media) return;
        
        panelGizmoActive = true;
        panelGizmoType = 'scale';
        panelGizmoIndex = idx;
        panelGizmoHandleType = corner; // Store handle type
        
        const touch = e.touches ? e.touches[0] : e;
        panelGizmoStartX = touch.clientX;
        panelGizmoStartY = touch.clientY;
        panelGizmoStartValues = {
            scale: media.scale || 1
        };
        
        // iPhone 16 specific event binding with capture
        window.addEventListener('mousemove', onPanelGizmo, { passive: false, capture: true });
        window.addEventListener('mouseup', endPanelGizmo, { passive: false, capture: true });
        window.addEventListener('touchmove', onPanelGizmo, { passive: false, capture: true });
        window.addEventListener('touchend', endPanelGizmo, { passive: false, capture: true });
        
        // iPhone 16 visual feedback
        const handle = e.target;
        if (handle) {
            handle.style.transform = 'scale(1.2)';
            handle.style.background = '#ffff00'; // Yellow feedback
        }
    }
    
    function startPanelRotate(e, idx) {
        console.log('startPanelRotate called', idx);
        e.preventDefault();
        e.stopPropagation();
        
        const media = getPage().panelMedia[idx];
        console.log('media:', media);
        if (!media) return;
        
        panelGizmoActive = true;
        panelGizmoType = 'rotate';
        panelGizmoIndex = idx;
        
        const touch = e.touches ? e.touches[0] : e;
        panelGizmoStartX = touch.clientX;
        panelGizmoStartY = touch.clientY;
        panelGizmoStartValues = {
            rotation: media.rotation || 0
        };
        
        window.addEventListener('mousemove', onPanelGizmo, { passive: false });
        window.addEventListener('mouseup', endPanelGizmo);
        window.addEventListener('touchmove', onPanelGizmo, { passive: false });
        window.addEventListener('touchend', endPanelGizmo);
    }
    
    function onPanelGizmo(e) {
        if (!panelGizmoActive) return;
        e.preventDefault();
        
        const media = getPage().panelMedia[panelGizmoIndex];
        if (!media) return;
        
        const touch = e.touches ? e.touches[0] : e;
        const dx = touch.clientX - panelGizmoStartX;
        const dy = touch.clientY - panelGizmoStartY;
        
        if (panelGizmoType === 'drag') {
            // Move the image within panel - scale by 0.5 for fine control
            media.offsetX = Math.max(-100, Math.min(100, panelGizmoStartValues.offsetX + dx * 0.3));
            media.offsetY = Math.max(-100, Math.min(100, panelGizmoStartValues.offsetY + dy * 0.3));
        } else if (panelGizmoType === 'scale') {
            // Scale based on diagonal drag distance
            const dist = Math.hypot(dx, dy) * (dx + dy > 0 ? 1 : -1);
            media.scale = Math.max(0.5, Math.min(5, panelGizmoStartValues.scale + dist * 0.005));
        } else if (panelGizmoType === 'rotate') {
            // Rotate based on horizontal movement
            media.rotation = Math.round(panelGizmoStartValues.rotation + dx * 0.5);
        }
        
        // Update DOM directly for smooth interaction
        const panel = document.querySelectorAll('.panel')[panelGizmoIndex];
        if (panel) {
            const img = panel.querySelector('.panel-media');
            if (img) {
                img.style.transform = `scale(${media.scale || 1}) rotate(${media.rotation || 0}deg) translate(${media.offsetX || 0}%, ${media.offsetY || 0}%)`;
            }
        }
    }
    
    function endPanelGizmo() {
        if (panelGizmoActive) {
            panelGizmoActive = false;
            render();
            
            // Reset handle appearance on iPhone 16
            const handles = document.querySelectorAll('.ps-handle');
            handles.forEach(handle => {
                handle.style.transform = '';
                handle.style.background = '#ffffff';
            });
            
            // Reset image opacity after drag
            const images = document.querySelectorAll('.panel-media');
            images.forEach(img => {
                img.style.opacity = '';
            });
        }
        
        // iPhone 16 specific cleanup with capture
        window.removeEventListener('mousemove', onPanelGizmo, { capture: true });
        window.removeEventListener('mouseup', endPanelGizmo, { capture: true });
        window.removeEventListener('touchmove', onPanelGizmo, { capture: true });
        window.removeEventListener('touchend', endPanelGizmo, { capture: true });
        
        // Fallback cleanup for older event bindings
        window.removeEventListener('mousemove', onPanelGizmo);
        window.removeEventListener('mouseup', endPanelGizmo);
        window.removeEventListener('touchmove', onPanelGizmo);
        window.removeEventListener('touchend', endPanelGizmo);
    }
    
    // Button-based transform controls - FIXED to apply all transforms
    function adjustPanelMedia(idx, action) {
        const page = getPage();
        if (!page || !page.panelMedia) return;
        const media = page.panelMedia[idx];
        if (!media) return;
        
        switch(action) {
            case 'scaleUp':
                media.scale = Math.min(5, (media.scale || 1) + 0.2);
                toast('Zoom: ' + (media.scale).toFixed(1) + 'x');
                break;
            case 'scaleDown':
                media.scale = Math.max(0.3, (media.scale || 1) - 0.2);
                toast('Zoom: ' + (media.scale).toFixed(1) + 'x');
                break;
            case 'rotateLeft':
                media.rotation = (media.rotation || 0) - 15;
                toast('Rotation: ' + media.rotation + '');
                break;
            case 'rotateRight':
                media.rotation = (media.rotation || 0) + 15;
                toast('Rotation: ' + media.rotation + '');
                break;
            case 'moveUp':
                media.offsetY = Math.max(-100, (media.offsetY || 0) - 10);
                break;
            case 'moveDown':
                media.offsetY = Math.min(100, (media.offsetY || 0) + 10);
                break;
            case 'moveLeft':
                media.offsetX = Math.max(-100, (media.offsetX || 0) - 10);
                break;
            case 'moveRight':
                media.offsetX = Math.min(100, (media.offsetX || 0) + 10);
                break;
            case 'reset':
                media.scale = 1;
                media.rotation = 0;
                media.offsetX = 0;
                media.offsetY = 0;
                toast('Reset!');
                break;
        }
        
        // FIXED: Apply FULL transform including rotation and offset
        const panels = document.querySelectorAll('.panel');
        const panel = panels[idx];
        if (panel) {
            const img = panel.querySelector('.panel-media');
            if (img) {
                img.style.transform = `scale(${media.scale || 1}) rotate(${media.rotation || 0}deg) translate(${media.offsetX || 0}%, ${media.offsetY || 0}%)`;
            }
        }
        
        // No automatic render - user taps elsewhere when done
    }
    
    // ========== PS EXPRESS STYLE MEDIA EDITOR ==========
    
    let mediaEditorStartX = 0, mediaEditorStartY = 0;
    let mediaEditorStartScale = 1, mediaEditorStartRotation = 0;
    let mediaEditorPinchStart = 0;
    let mediaEditorIsDragging = false;
    
    function openMediaEditor(type, index = 0) {
        // Get current source and transform based on type
        let src = '', transform = { scale: 1, rotation: 0, offsetX: 0, offsetY: 0 };
        
        if (type === 'panel') {
            const media = getPage().panelMedia[index];
            if (!media) return;
            src = media.src;
            transform = { scale: media.scale || 1, rotation: media.rotation || 0, offsetX: media.offsetX || 0, offsetY: media.offsetY || 0 };
        } else if (type === 'card-front') {
            src = S.card.frontImage;
            transform = S.card.frontTransform || { scale: 1, rotation: 0, offsetX: 0, offsetY: 0 };
        } else if (type === 'card-back') {
            src = S.card.backImage;
            transform = S.card.backTransform || { scale: 1, rotation: 0, offsetX: 0, offsetY: 0 };
        } else if (type === 'cover-front') {
            src = S.cover.frontImage;
            transform = S.cover.frontTransform || { scale: 1, rotation: 0, offsetX: 0, offsetY: 0 };
        } else if (type === 'cover-back') {
            src = S.cover.backImage;
            transform = S.cover.backTransform || { scale: 1, rotation: 0, offsetX: 0, offsetY: 0 };
        }
        
        if (!src) return;
        
        S.mediaEditor = { type, index, src, ...transform };
        render();
        setTimeout(initMediaEditorTouch, 100);
    }
    
    function closeMediaEditor(save = false) {
        if (save && S.mediaEditor) {
            const { type, index, scale, rotation, offsetX, offsetY } = S.mediaEditor;
            const transform = { scale, rotation, offsetX, offsetY };
            
            if (type === 'panel') {
                const media = getPage().panelMedia[index];
                if (media) Object.assign(media, transform);
            } else if (type === 'card-front') {
                S.card.frontTransform = transform;
            } else if (type === 'card-back') {
                S.card.backTransform = transform;
            } else if (type === 'cover-front') {
                S.cover.frontTransform = transform;
            } else if (type === 'cover-back') {
                S.cover.backTransform = transform;
            }
            toast('Transform applied!');
        }
        
        S.mediaEditor = null;
        render();
    }
    
    function updateMediaEditor(prop, value) {
        if (!S.mediaEditor) return;
        S.mediaEditor[prop] = value;
        render();
    }
    
    function resetMediaEditor() {
        if (!S.mediaEditor) return;
        S.mediaEditor.scale = 1;
        S.mediaEditor.rotation = 0;
        S.mediaEditor.offsetX = 0;
        S.mediaEditor.offsetY = 0;
        render();
    }
    
    function initMediaEditorTouch() {
        const canvas = document.querySelector('.media-editor-canvas');
        const img = document.querySelector('.media-editor-image');
        if (!canvas || !img) return;
        
        // Mouse/Touch drag for position
        const handleStart = (e) => {
            if (e.touches && e.touches.length > 1) return; // Ignore multi-touch for drag
            mediaEditorIsDragging = true;
            const point = e.touches ? e.touches[0] : e;
            mediaEditorStartX = point.clientX - (S.mediaEditor.offsetX * 2);
            mediaEditorStartY = point.clientY - (S.mediaEditor.offsetY * 2);
        };
        
        const handleMove = (e) => {
            if (!mediaEditorIsDragging) return;
            if (e.touches && e.touches.length > 1) return;
            e.preventDefault();
            const point = e.touches ? e.touches[0] : e;
            S.mediaEditor.offsetX = Math.round((point.clientX - mediaEditorStartX) / 2);
            S.mediaEditor.offsetY = Math.round((point.clientY - mediaEditorStartY) / 2);
            // Clamp
            S.mediaEditor.offsetX = Math.max(-100, Math.min(100, S.mediaEditor.offsetX));
            S.mediaEditor.offsetY = Math.max(-100, Math.min(100, S.mediaEditor.offsetY));
            render();
        };
        
        const handleEnd = () => {
            mediaEditorIsDragging = false;
        };
        
        // Pinch zoom
        const handleTouchStart = (e) => {
            if (e.touches.length === 2) {
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                mediaEditorPinchStart = Math.hypot(dx, dy);
                mediaEditorStartScale = S.mediaEditor.scale;
            }
        };
        
        const handleTouchMove = (e) => {
            if (e.touches.length === 2) {
                e.preventDefault();
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                const dist = Math.hypot(dx, dy);
                const scaleDelta = dist / mediaEditorPinchStart;
                S.mediaEditor.scale = Math.max(0.5, Math.min(5, mediaEditorStartScale * scaleDelta));
                render();
            }
        };
        
        // Wheel zoom
        const handleWheel = (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            S.mediaEditor.scale = Math.max(0.5, Math.min(5, S.mediaEditor.scale + delta));
            render();
        };
        
        img.addEventListener('mousedown', handleStart);
        img.addEventListener('touchstart', handleStart, { passive: true });
        img.addEventListener('touchstart', handleTouchStart, { passive: true });
        
        document.addEventListener('mousemove', handleMove);
        document.addEventListener('touchmove', handleMove, { passive: false });
        document.addEventListener('touchmove', handleTouchMove, { passive: false });
        
        document.addEventListener('mouseup', handleEnd);
        document.addEventListener('touchend', handleEnd);
        
        canvas.addEventListener('wheel', handleWheel, { passive: false });
    }
    
    function renderMediaEditor() {
        if (!S.mediaEditor) return '';
        const { src, scale, rotation, offsetX, offsetY, type, index } = S.mediaEditor;
        const isVideo = src.startsWith('data:video') || src.includes('.mp4');
        
        // Calculate frame size (the visible area)
        const frameW = 280;
        const frameH = 400;
        
        return `
            <div class="media-editor">
                <div class="media-editor-header">
                    <div class="media-editor-title">TRANSFORM MEDIA</div>
                    <div class="media-editor-btns">
                        <button class="media-editor-btn cancel" onclick="closeMediaEditor(false)">Cancel</button>
                        <button class="media-editor-btn done" onclick="closeMediaEditor(true)"> Done</button>
                    </div>
                </div>
                
                <div class="media-editor-canvas">
                    <div class="media-editor-frame" style="width:${frameW}px;height:${frameH}px"></div>
                    ${isVideo 
                        ? `<video class="media-editor-image video" src="${src}" autoplay loop muted playsinline style="transform:translate(${offsetX}px,${offsetY}px) scale(${scale}) rotate(${rotation}deg);width:${frameW * 1.5}px"></video>`
                        : `<img class="media-editor-image" src="${src}" style="transform:translate(${offsetX}px,${offsetY}px) scale(${scale}) rotate(${rotation}deg);width:${frameW * 1.5}px" draggable="false">`
                    }
                </div>
                
                <div class="media-editor-footer">
                    <div class="media-editor-tools">
                        <button class="media-editor-tool" onclick="resetMediaEditor()"> Reset</button>
                        <button class="media-editor-tool" onclick="updateMediaEditor('rotation', ${rotation - 90})"> -90</button>
                        <button class="media-editor-tool" onclick="updateMediaEditor('rotation', ${rotation + 90})"> +90</button>
                        <button class="media-editor-tool" onclick="updateMediaEditor('scale', 1)">Fit</button>
                    </div>
                    
                    <div class="media-editor-slider-row">
                        <span class="media-editor-slider-label">Scale</span>
                        <input type="range" class="media-editor-slider" min="10" max="400" value="${Math.round(scale * 100)}" 
                               onchange="updateMediaEditor('scale', this.value / 100)"
                               oninput="this.nextElementSibling.textContent = this.value + '%'">
                        <span class="media-editor-slider-value">${Math.round(scale * 100)}%</span>
                    </div>
                    
                    <div class="media-editor-slider-row">
                        <span class="media-editor-slider-label">Rotate</span>
                        <input type="range" class="media-editor-slider" min="-180" max="180" value="${rotation}"
                               onchange="updateMediaEditor('rotation', parseInt(this.value))"
                               oninput="this.nextElementSibling.textContent = this.value + ''">
                        <span class="media-editor-slider-value">${rotation}</span>
                    </div>
                    
                    <div class="media-editor-tools" style="margin-top:8px;border-top:1px solid #333;padding-top:8px">
                        <button class="media-editor-tool" onclick="replaceMediaFromEditor()" style="background:#333"> Replace</button>
                        <button class="media-editor-tool" onclick="deleteMediaFromEditor()" style="background:#500;color:#f88"> Delete</button>
                    </div>
                    
                    <div class="media-editor-hint">Drag image to reposition  Pinch to zoom  Scroll to scale</div>
                </div>
            </div>
        `;
    }
    
    // Legacy transform functions (redirect to new editor)
    function transformPanelImage(prop, amount) {
        const media = getPage().panelMedia[S.selectedPanel];
        if (!media) return;
        if (prop === 'scale') media.scale = Math.max(0.5, Math.min(3, (media.scale || 1) + amount));
        else if (prop === 'rotation') media.rotation = (media.rotation || 0) + amount;
        else if (prop === 'offsetX') media.offsetX = Math.max(-50, Math.min(50, (media.offsetX || 0) + amount));
        else if (prop === 'offsetY') media.offsetY = Math.max(-50, Math.min(50, (media.offsetY || 0) + amount));
        render();
    }
    
    // Delete media from within the editor
    function deleteMediaFromEditor() {
        if (!S.mediaEditor) return;
        const { type, index } = S.mediaEditor;
        
        if (type === 'panel') {
            delete getPage().panelMedia[index];
            toast('Image removed');
        } else if (type === 'card-front') {
            S.card.frontImage = null;
            toast('Card image removed');
        } else if (type === 'card-back') {
            S.card.backImage = null;
            toast('Back image removed');
        } else if (type === 'cover-front') {
            S.cover.frontImage = null;
            toast('Cover image removed');
        } else if (type === 'cover-back') {
            S.cover.backImage = null;
            toast('Back cover removed');
        }
        
        S.mediaEditor = null;
        S.selectedPanel = null;
        render();
    }
    
    // Replace media from within the editor
    function replaceMediaFromEditor() {
        if (!S.mediaEditor) return;
        const { type, index } = S.mediaEditor;
        
        // Close editor and open image options
        S.mediaEditor = null;
        showImageOptions(type, index);
    }
    
    function resetPanelImageTransform() {
        const media = getPage().panelMedia[S.selectedPanel];
        if (media) { media.scale = 1; media.rotation = 0; media.offsetX = 0; media.offsetY = 0; }
        render();
    }
    
    function transformCardImage(prop, amount, side = 'front') {
        const key = side === 'back' ? 'backTransform' : 'frontTransform';
        if (!S.card[key]) S.card[key] = { scale: 1, rotation: 0, offsetX: 0, offsetY: 0 };
        const t = S.card[key];
        if (prop === 'scale') t.scale = Math.max(0.5, Math.min(3, (t.scale || 1) + amount));
        else if (prop === 'rotation') t.rotation = (t.rotation || 0) + amount;
        else if (prop === 'offsetX') t.offsetX = Math.max(-50, Math.min(50, (t.offsetX || 0) + amount));
        else if (prop === 'offsetY') t.offsetY = Math.max(-50, Math.min(50, (t.offsetY || 0) + amount));
        render();
    }
    
    function resetCardImageTransform(side = 'front') {
        S.card[side === 'back' ? 'backTransform' : 'frontTransform'] = { scale: 1, rotation: 0, offsetX: 0, offsetY: 0 };
        render();
    }
    
    function transformCoverImage(prop, amount, side = 'front') {
        const key = side === 'back' ? 'backTransform' : 'frontTransform';
        if (!S.cover[key]) S.cover[key] = { scale: 1, rotation: 0, offsetX: 0, offsetY: 0 };
        const t = S.cover[key];
        if (prop === 'scale') t.scale = Math.max(0.5, Math.min(3, (t.scale || 1) + amount));
        else if (prop === 'rotation') t.rotation = (t.rotation || 0) + amount;
        else if (prop === 'offsetX') t.offsetX = Math.max(-50, Math.min(50, (t.offsetX || 0) + amount));
        else if (prop === 'offsetY') t.offsetY = Math.max(-50, Math.min(50, (t.offsetY || 0) + amount));
        render();
    }
    
    function resetCoverImageTransform(side = 'front') {
        S.cover[side === 'back' ? 'backTransform' : 'frontTransform'] = { scale: 1, rotation: 0, offsetX: 0, offsetY: 0 };
        render();
    }
    
    // ========== ELEMENT GIZMO INTERACTIONS (Designrr-style) ==========
    
    let elGizmoActive = false;
    let elGizmoType = ''; // 'scale' or 'rotate'
    let elGizmoId = 0;
    let elGizmoHandleType = ''; // Which handle type for scaling
    let elGizmoStartX = 0, elGizmoStartY = 0;
    let elGizmoStartScale = 1, elGizmoStartRotation = 0;
    
    function startElScale(e, id, handleType) {
        e.preventDefault();
        e.stopPropagation();
        
        const el = getPage().pageElements.find(x => x.id === id);
        if (!el) return;
        
        elGizmoActive = true;
        elGizmoType = 'scale';
        elGizmoId = id;
        elGizmoHandleType = handleType; // Store which handle type
        
        const touch = e.touches ? e.touches[0] : e;
        elGizmoStartX = touch.clientX;
        elGizmoStartY = touch.clientY;
        elGizmoStartScale = el.scale || 1;
        
        window.addEventListener('mousemove', onElGizmo, { passive: false });
        window.addEventListener('mouseup', endElGizmo);
        window.addEventListener('touchmove', onElGizmo, { passive: false });
        window.addEventListener('touchend', endElGizmo);
    }
    
    function startElRotate(e, id) {
        e.preventDefault();
        e.stopPropagation();
        
        const el = getPage().pageElements.find(x => x.id === id);
        if (!el) return;
        
        elGizmoActive = true;
        elGizmoType = 'rotate';
        elGizmoId = id;
        
        const touch = e.touches ? e.touches[0] : e;
        elGizmoStartX = touch.clientX;
        elGizmoStartY = touch.clientY;
        elGizmoStartRotation = el.rotation || 0;
        
        window.addEventListener('mousemove', onElGizmo, { passive: false });
        window.addEventListener('mouseup', endElGizmo);
        window.addEventListener('touchmove', onElGizmo, { passive: false });
        window.addEventListener('touchend', endElGizmo);
    }
    
    function onElGizmo(e) {
        if (!elGizmoActive) return;
        e.preventDefault();
        
        const el = getPage().pageElements.find(x => x.id === elGizmoId);
        if (!el) return;
        
        const touch = e.touches ? e.touches[0] : e;
        const dx = touch.clientX - elGizmoStartX;
        const dy = touch.clientY - elGizmoStartY;
        
        if (elGizmoType === 'scale') {
            // Different scaling behavior based on handle type
            if (['nw', 'ne', 'sw', 'se'].includes(elGizmoHandleType)) {
                // Corner handles: proportional scaling
                const dist = Math.hypot(dx, dy) * (dx + dy > 0 ? 1 : -1);
                el.scale = Math.max(0.3, Math.min(4, elGizmoStartScale + dist * 0.008));
            } else if (['top', 'bottom'].includes(elGizmoHandleType)) {
                // Top/bottom edges: height scaling only
                el.scaleY = Math.max(0.3, Math.min(4, (el.scaleY || 1) + dy * 0.008));
            } else if (['left', 'right'].includes(elGizmoHandleType)) {
                // Left/right edges: width scaling only
                el.scaleX = Math.max(0.3, Math.min(4, (el.scaleX || 1) + dx * 0.008));
            }
        } else if (elGizmoType === 'rotate') {
            // Rotate based on horizontal movement
            el.rotation = Math.round(elGizmoStartRotation + dx * 0.8);
        }
        
        // Update DOM directly for smooth interaction
        const elDiv = document.querySelector(`[data-elid="${elGizmoId}"]`);
        if (elDiv) {
            const scaleX = el.scaleX || el.scale || 1;
            const scaleY = el.scaleY || el.scale || 1;
            elDiv.style.transform = `translate(-50%,-50%) rotate(${el.rotation || 0}deg) scale(${scaleX}, ${scaleY})`;
        }
    }
    
    function endElGizmo() {
        if (elGizmoActive) {
            elGizmoActive = false;
            render();
        }
        window.removeEventListener('mousemove', onElGizmo);
        window.removeEventListener('mouseup', endElGizmo);
        window.removeEventListener('touchmove', onElGizmo);
        window.removeEventListener('touchend', endElGizmo);
    }
    
    function enterPreviewMode() {
        S.previewMode = true;
        S.previewPage = 0;
        render();
        // Start panel animations after render
        setTimeout(startPanelAnimations, 100);
    }
    
    function exitPreviewMode() {
        stopPanelAnimations();
        S.previewMode = false;
        render();
    }
    
    function nextPreviewPage() {
        const totalPages = S.pages.length + 2; // +2 for cover front/back, card is shown on last page
        if (S.previewPage < totalPages) {
            S.previewPage++;
            render();
            setTimeout(startPanelAnimations, 100);
        }
    }
    
    function prevPreviewPage() {
        if (S.previewPage > 0) {
            S.previewPage--;
            render();
            setTimeout(startPanelAnimations, 100);
        }
    }
    
    function nextPreviewPageAnimated() {
        const totalPages = S.pages.length + 3;
        if (S.previewPage < totalPages - 1) {
            S.previewTransClass = 'page-trans-' + S.pageTransition;
            S.previewPage++;
            render();
            setTimeout(() => {
                S.previewTransClass = '';
                startPanelAnimations();
            }, 500);
        }
    }
    
    function prevPreviewPageAnimated() {
        if (S.previewPage > 0) {
            // Use opposite direction for back navigation
            let transClass = 'page-trans-' + S.pageTransition;
            if (S.pageTransition === 'slide-left') {
                transClass = 'page-trans-slide-right';
            }
            S.previewTransClass = transClass;
            S.previewPage--;
            render();
            setTimeout(() => {
                S.previewTransClass = '';
                startPanelAnimations();
            }, 500);
        }
    }
    
    function setPageTransition(trans) {
        S.pageTransition = trans;
        render();
    }

    // ===== DRAWING MODE FUNCTIONS =====
    
    let drawCanvas = null;
    let drawCtx = null;
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;
    
    const DRAW_COLORS = [
        '#000000', '#ffffff', '#ff0000', '#ff6600', '#ffcc00', 
        '#00cc00', '#0066ff', '#9933ff', '#ff66cc', '#666666'
    ];
    
    const DRAW_SIZES = [2, 4, 8, 16, 32];
    
    function enterDrawMode() {
        // Initialize drawing for current page
        const page = getPage();
        if (!page.drawingData) {
            page.drawingData = null; // Will store base64 image data
        }
        S.drawMode = true;
        S.drawTool = 'pen';
        S.drawColor = '#000000';
        S.drawSize = 4;
        S.drawHistory = [];
        S.drawRedoStack = [];
        render();
        
        // Initialize canvas after render
        setTimeout(initDrawCanvas, 100);
    }
    
    function exitDrawMode(save = false) {
        // Stop any running animation
        stopDrawAnimation();
        
        if (save && drawCanvas) {
            // Save current frame first
            saveCurrentFrame();
            
            const page = getPage();
            
            if (S.drawPanelIndex !== null) {
                // Panel drawings are already saved in place via saveCurrentFrame
                toast(`Panel ${S.drawPanelIndex + 1} animation saved! (${page.panelDrawings[S.drawPanelIndex].frames.length} frames)`);
            } else {
                // Full page drawings - also set legacy drawingData to first frame
                if (page.drawFrames && page.drawFrames[0]) {
                    page.drawingData = page.drawFrames[0];
                }
                toast(`Animation saved! (${page.drawFrames?.length || 1} frames)`);
            }
            
            saveState();
        }
        
        S.drawMode = false;
        S.drawPanelIndex = null;
        S.drawFrameIndex = 0;
        drawCanvas = null;
        drawCtx = null;
        render();
    }
    
    function initDrawCanvas() {
        drawCanvas = document.getElementById('drawCanvas');
        if (!drawCanvas) return;
        
        // Remove old event listeners by cloning
        const newCanvas = drawCanvas.cloneNode(true);
        drawCanvas.parentNode.replaceChild(newCanvas, drawCanvas);
        drawCanvas = newCanvas;
        
        drawCtx = drawCanvas.getContext('2d');
        
        // Get the canvas parent container
        const container = drawCanvas.parentElement;
        if (!container) return;
        
        const rect = container.getBoundingClientRect();
        let w = rect.width;
        let h = rect.height;
        
        // Ensure minimum size
        w = Math.max(w, 280);
        h = Math.max(h, 200);
        
        // High DPI support
        const dpr = window.devicePixelRatio || 1;
        drawCanvas.width = w * dpr;
        drawCanvas.height = h * dpr;
        drawCanvas.style.width = w + 'px';
        drawCanvas.style.height = h + 'px';
        
        // Reset context after resize
        drawCtx = drawCanvas.getContext('2d');
        drawCtx.scale(dpr, dpr);
        
        // Clear history for new frame
        S.drawHistory = [];
        S.drawRedoStack = [];
        
        // White background first
        drawCtx.fillStyle = '#fff';
        drawCtx.fillRect(0, 0, w, h);
        
        // Get frames using helper (supports panel mode)
        const frames = getCurrentFrames();
        const currentFrame = S.drawFrameIndex || 0;
        const frameData = frames[currentFrame];
        const prevFrameData = currentFrame > 0 ? frames[currentFrame - 1] : null;
        
        // Track loading state
        let onionSkinLoaded = false;
        let currentFrameLoaded = false;
        
        function finishInit() {
            if (S.onionSkin && prevFrameData && !onionSkinLoaded) return;
            if (frameData && !currentFrameLoaded) return;
            
            // Save initial state to history
            S.drawHistory.push(drawCanvas.toDataURL());
            
            // Add fresh event listeners
            drawCanvas.addEventListener('pointerdown', startDraw);
            drawCanvas.addEventListener('pointermove', draw);
            drawCanvas.addEventListener('pointerup', endDraw);
            drawCanvas.addEventListener('pointerleave', endDraw);
            drawCanvas.addEventListener('pointercancel', endDraw);
        }
        
        // Step 1: Draw onion skin (previous frame) if enabled
        if (S.onionSkin && prevFrameData && prevFrameData !== frameData) {
            const prevImg = new Image();
            prevImg.onload = function() {
                drawCtx.globalAlpha = 0.25;
                drawCtx.drawImage(prevImg, 0, 0, w, h);
                drawCtx.globalAlpha = 1;
                onionSkinLoaded = true;
                loadCurrentFrame();
            };
            prevImg.onerror = function() {
                onionSkinLoaded = true;
                loadCurrentFrame();
            };
            prevImg.src = prevFrameData;
        } else {
            onionSkinLoaded = true;
            loadCurrentFrame();
        }
        
        // Step 2: Load current frame data on top
        function loadCurrentFrame() {
            if (frameData) {
                const img = new Image();
                img.onload = function() {
                    // Don't clear - draw on top of onion skin
                    drawCtx.drawImage(img, 0, 0, w, h);
                    currentFrameLoaded = true;
                    finishInit();
                };
                img.onerror = function() {
                    currentFrameLoaded = true;
                    finishInit();
                };
                img.src = frameData;
            } else if (S.drawPanelIndex === null) {
                // Full page mode: draw panel guides for new frames
                const page = getPage();
                if (page.drawingData && currentFrame === 0) {
                    const img = new Image();
                    img.onload = function() {
                        drawCtx.drawImage(img, 0, 0, w, h);
                        currentFrameLoaded = true;
                        finishInit();
                    };
                    img.onerror = function() {
                        drawPanelGuides(w, h);
                        currentFrameLoaded = true;
                        finishInit();
                    };
                    img.src = page.drawingData;
                } else {
                    drawPanelGuides(w, h);
                    currentFrameLoaded = true;
                    finishInit();
                }
            } else {
                // Panel mode: just white canvas (already drawn)
                currentFrameLoaded = true;
                finishInit();
            }
        }
    }
    
    function drawPanelGuides(w, h) {
        const page = getPage();
        drawCtx.strokeStyle = '#ddd';
        drawCtx.lineWidth = 1;
        drawCtx.setLineDash([5, 5]);
        
        page.panels.forEach(p => {
            const px = (p.x / 100) * w;
            const py = (p.y / 100) * h;
            const pw = (p.w / 100) * w;
            const ph = (p.h / 100) * h;
            drawCtx.strokeRect(px, py, pw, ph);
        });
        
        drawCtx.setLineDash([]);
    }
    
    function getDrawCoords(e) {
        const rect = drawCanvas.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        const scaleX = drawCanvas.width / rect.width;
        const scaleY = drawCanvas.height / rect.height;
        return {
            x: (e.clientX - rect.left) * scaleX / dpr,
            y: (e.clientY - rect.top) * scaleY / dpr
        };
    }
    
    // Store start position for shape tools
    let shapeStartX = 0, shapeStartY = 0;
    let shapePreviewState = null;
    
    function startDraw(e) {
        e.preventDefault();
        isDrawing = true;
        const coords = getDrawCoords(e);
        lastX = coords.x;
        lastY = coords.y;
        shapeStartX = coords.x;
        shapeStartY = coords.y;
        
        // Save state for shape preview
        if (['line', 'rect', 'circle'].includes(S.drawTool)) {
            shapePreviewState = drawCanvas.toDataURL();
        }
        
        // For freehand tools, draw initial dot
        if (['pen', 'pencil', 'marker', 'brush'].includes(S.drawTool)) {
            drawCtx.beginPath();
            drawCtx.arc(lastX, lastY, getToolSize() / 2, 0, Math.PI * 2);
            drawCtx.fillStyle = S.drawColor;
            if (S.drawTool === 'marker') drawCtx.globalAlpha = 0.3;
            drawCtx.fill();
            drawCtx.globalAlpha = 1;
        }
    }
    
    function getToolSize() {
        switch (S.drawTool) {
            case 'pencil': return Math.max(1, S.drawSize * 0.5);
            case 'marker': return S.drawSize * 2;
            case 'brush': return S.drawSize * 1.5;
            case 'eraser': return S.drawSize * 3;
            default: return S.drawSize;
        }
    }
    
    function draw(e) {
        if (!isDrawing) return;
        e.preventDefault();
        
        const coords = getDrawCoords(e);
        
        // Shape tools - preview
        if (['line', 'rect', 'circle'].includes(S.drawTool)) {
            // Restore to start state
            if (shapePreviewState) {
                const img = new Image();
                img.onload = function() {
                    const dpr = window.devicePixelRatio || 1;
                    const w = drawCanvas.width / dpr;
                    const h = drawCanvas.height / dpr;
                    drawCtx.clearRect(0, 0, w, h);
                    drawCtx.drawImage(img, 0, 0, w, h);
                    drawShape(coords.x, coords.y, false);
                };
                img.src = shapePreviewState;
            }
            return;
        }
        
        // Freehand tools
        drawCtx.beginPath();
        drawCtx.moveTo(lastX, lastY);
        drawCtx.lineTo(coords.x, coords.y);
        
        if (S.drawTool === 'eraser') {
            drawCtx.strokeStyle = '#fff';
            drawCtx.lineWidth = getToolSize();
            drawCtx.globalCompositeOperation = 'destination-out';
        } else if (S.drawTool === 'marker') {
            drawCtx.strokeStyle = S.drawColor;
            drawCtx.lineWidth = getToolSize();
            drawCtx.globalAlpha = 0.3;
        } else if (S.drawTool === 'pencil') {
            drawCtx.strokeStyle = S.drawColor;
            drawCtx.lineWidth = getToolSize();
            drawCtx.globalAlpha = 0.8;
        } else if (S.drawTool === 'brush') {
            drawCtx.strokeStyle = S.drawColor;
            drawCtx.lineWidth = getToolSize();
            drawCtx.globalAlpha = 0.9;
        } else {
            drawCtx.strokeStyle = S.drawColor;
            drawCtx.lineWidth = getToolSize();
            drawCtx.globalAlpha = 1;
        }
        
        drawCtx.lineCap = 'round';
        drawCtx.lineJoin = 'round';
        drawCtx.stroke();
        
        // Reset
        drawCtx.globalCompositeOperation = 'source-over';
        drawCtx.globalAlpha = 1;
        
        lastX = coords.x;
        lastY = coords.y;
    }
    
    function drawShape(endX, endY, final) {
        drawCtx.strokeStyle = S.drawColor;
        drawCtx.fillStyle = S.drawColor;
        drawCtx.lineWidth = S.drawSize;
        drawCtx.lineCap = 'round';
        
        if (S.drawTool === 'line') {
            drawCtx.beginPath();
            drawCtx.moveTo(shapeStartX, shapeStartY);
            drawCtx.lineTo(endX, endY);
            drawCtx.stroke();
        } else if (S.drawTool === 'rect') {
            const w = endX - shapeStartX;
            const h = endY - shapeStartY;
            drawCtx.strokeRect(shapeStartX, shapeStartY, w, h);
        } else if (S.drawTool === 'circle') {
            const radius = Math.sqrt(Math.pow(endX - shapeStartX, 2) + Math.pow(endY - shapeStartY, 2));
            drawCtx.beginPath();
            drawCtx.arc(shapeStartX, shapeStartY, radius, 0, Math.PI * 2);
            drawCtx.stroke();
        }
    }
    
    function endDraw(e) {
        if (isDrawing) {
            // For shape tools, draw final shape
            if (['line', 'rect', 'circle'].includes(S.drawTool) && shapePreviewState) {
                const coords = getDrawCoords(e);
                // Restore and draw final
                const img = new Image();
                img.onload = function() {
                    const dpr = window.devicePixelRatio || 1;
                    const w = drawCanvas.width / dpr;
                    const h = drawCanvas.height / dpr;
                    drawCtx.clearRect(0, 0, w, h);
                    drawCtx.drawImage(img, 0, 0, w, h);
                    drawShape(coords.x, coords.y, true);
                    shapePreviewState = null;
                    saveDrawState();
                };
                img.src = shapePreviewState;
            } else {
                saveDrawState();
            }
            isDrawing = false;
        }
    }
    
    function saveDrawState() {
        if (!drawCanvas || !drawCtx) return;
        const dataUrl = drawCanvas.toDataURL();
        // Avoid duplicate states
        if (S.drawHistory.length > 0 && S.drawHistory[S.drawHistory.length - 1] === dataUrl) return;
        S.drawHistory.push(dataUrl);
        S.drawRedoStack = []; // Clear redo on new action
        // Limit history to 20 states
        if (S.drawHistory.length > 20) {
            S.drawHistory.shift();
        }
    }
    
    function undoDraw() {
        if (!drawCanvas || !drawCtx || S.drawHistory.length <= 1) return;
        
        // Move current state to redo
        S.drawRedoStack.push(S.drawHistory.pop());
        
        // Restore previous state
        const prevState = S.drawHistory[S.drawHistory.length - 1];
        const img = new Image();
        img.onload = function() {
            const dpr = window.devicePixelRatio || 1;
            const w = drawCanvas.width / dpr;
            const h = drawCanvas.height / dpr;
            drawCtx.clearRect(0, 0, w, h);
            drawCtx.drawImage(img, 0, 0, w, h);
        };
        img.src = prevState;
        toast(' Undo');
    }
    
    function redoDraw() {
        if (!drawCanvas || !drawCtx || S.drawRedoStack.length === 0) return;
        
        const nextState = S.drawRedoStack.pop();
        S.drawHistory.push(nextState);
        
        const img = new Image();
        img.onload = function() {
            const dpr = window.devicePixelRatio || 1;
            const w = drawCanvas.width / dpr;
            const h = drawCanvas.height / dpr;
            drawCtx.clearRect(0, 0, w, h);
            drawCtx.drawImage(img, 0, 0, w, h);
        };
        img.src = nextState;
        toast(' Redo');
    }
    
    function clearDrawing() {
        if (!drawCanvas || !drawCtx) return;
        const dpr = window.devicePixelRatio || 1;
        const w = drawCanvas.width / dpr;
        const h = drawCanvas.height / dpr;
        drawCtx.fillStyle = '#fff';
        drawCtx.fillRect(0, 0, w, h);
        
        // Only draw panel guides in full page mode
        if (S.drawPanelIndex === null) {
            drawPanelGuides(w, h);
        }
        saveDrawState();
        toast('Canvas cleared');
    }
    
    function setDrawTool(tool) {
        S.drawTool = tool;
        // Update tool buttons without full render
        const toolPalette = document.querySelector('.tool-palette');
        if (toolPalette) {
            toolPalette.querySelectorAll('button').forEach(btn => {
                const btnTool = btn.getAttribute('data-tool');
                if (btnTool) {
                    btn.style.background = btnTool === tool ? '#333' : 'transparent';
                    btn.style.borderColor = btnTool === tool ? '#fff' : 'transparent';
                }
            });
        }
        toast(tool.charAt(0).toUpperCase() + tool.slice(1));
    }
    
    function setDrawColor(color) {
        S.drawColor = color;
        // Update UI without full render
        document.querySelectorAll('[data-color]').forEach(el => {
            const isActive = el.dataset.color === color;
            el.style.width = isActive ? '32px' : '26px';
            el.style.height = isActive ? '32px' : '26px';
            el.style.border = isActive ? '3px solid #fff' : (el.dataset.color === '#ffffff' ? '2px solid #444' : '2px solid transparent');
        });
    }
    
    function setDrawSize(size) {
        S.drawSize = Math.max(1, Math.min(50, size));
        // Update size preview without full render
        const preview = document.querySelector('[data-size-preview]');
        if (preview) {
            preview.style.width = Math.min(S.drawSize, 24) + 'px';
            preview.style.height = Math.min(S.drawSize, 24) + 'px';
        }
    }
    
    // Get current frames array (panel or page)
    function getCurrentFrames() {
        const page = getPage();
        if (S.drawPanelIndex !== null) {
            if (!page.panelDrawings) page.panelDrawings = {};
            if (!page.panelDrawings[S.drawPanelIndex]) {
                page.panelDrawings[S.drawPanelIndex] = { frames: [null] };
            }
            return page.panelDrawings[S.drawPanelIndex].frames;
        } else {
            if (!page.drawFrames) page.drawFrames = [null];
            return page.drawFrames;
        }
    }
    
    // Save current canvas to current frame
    function saveCurrentFrame() {
        if (!drawCanvas) return;
        const frames = getCurrentFrames();
        frames[S.drawFrameIndex || 0] = drawCanvas.toDataURL('image/png');
    }
    
    // Animation frame functions
    function selectDrawFrame(idx) {
        saveCurrentFrame();
        S.drawFrameIndex = idx;
        // Don't call full render - just reinit the canvas
        updateFrameUI();
        setTimeout(initDrawCanvas, 100);
    }
    
    function addDrawFrame() {
        saveCurrentFrame();
        const frames = getCurrentFrames();
        // Add a blank frame - onion skin will show previous frame content
        frames.push(null);
        S.drawFrameIndex = frames.length - 1;
        // Don't call full render - just update frame UI and reinit canvas
        updateFrameUI();
        setTimeout(initDrawCanvas, 100);
        toast(`Frame ${S.drawFrameIndex + 1} added`);
    }
    
    function duplicateDrawFrame() {
        saveCurrentFrame();
        const frames = getCurrentFrames();
        // Duplicate copies the current frame content
        const currentData = drawCanvas ? drawCanvas.toDataURL('image/png') : frames[S.drawFrameIndex || 0];
        frames.splice(S.drawFrameIndex + 1, 0, currentData);
        S.drawFrameIndex++;
        // Don't call full render - just update frame UI and reinit canvas
        updateFrameUI();
        setTimeout(initDrawCanvas, 100);
        toast('Frame duplicated');
    }
    
    function deleteDrawFrame() {
        const frames = getCurrentFrames();
        if (frames.length <= 1) {
            toast('Cannot delete last frame');
            return;
        }
        frames.splice(S.drawFrameIndex, 1);
        if (S.drawFrameIndex >= frames.length) {
            S.drawFrameIndex = frames.length - 1;
        }
        updateFrameUI();
        setTimeout(initDrawCanvas, 100);
        toast('Frame deleted');
    }
    
    // Update just the frame thumbnails without full render
    function updateFrameUI() {
        const page = getPage();
        const isPanelMode = S.drawPanelIndex !== null;
        const frames = isPanelMode 
            ? (page.panelDrawings?.[S.drawPanelIndex]?.frames || [null])
            : (page.drawFrames || [null]);
        const currentFrame = S.drawFrameIndex || 0;
        
        // Find the frame container and update it
        const frameContainer = document.querySelector('[style*="max-width:300px"]');
        if (frameContainer) {
            frameContainer.innerHTML = frames.map((f, i) => `
                <div onclick="selectDrawFrame(${i})" data-frame-index="${i}" style="width:50px;height:36px;border-radius:6px;border:2px solid ${i===currentFrame?'#fff':'#444'};background:${f?'url('+f+') center/cover':'#333'};cursor:pointer;flex-shrink:0;position:relative;overflow:hidden">
                    ${!f ? '<span style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#666;font-size:11px">'+(i+1)+'</span>' : ''}
                    ${i===currentFrame ? '<div style="position:absolute;top:2px;right:2px;width:12px;height:12px;background:#fff;border-radius:50%;font-size:7px;color:#fff;display:flex;align-items:center;justify-content:center">'+(i+1)+'</div>' : ''}
                </div>
            `).join('');
        }
    }
    
    function toggleOnionSkin() {
        S.onionSkin = !S.onionSkin;
        toast(S.onionSkin ? 'Onion skin ON' : 'Onion skin OFF');
        // Re-init canvas to show/hide onion skin without full render
        setTimeout(initDrawCanvas, 100);
    }
    
    function setDrawFPS(fps) {
        S.drawFPS = fps;
        // Update without full render
        const label = document.querySelector('[data-fps-label]');
        if (label) label.textContent = fps + ' fps';
    }
    
    // Animation state - use window to persist
    window.drawAnimInterval = null;
    window.drawAnimRunning = false;
    
    function toggleDrawAnimation() {
        if (window.drawAnimRunning) {
            // Stop animation
            window.drawAnimRunning = false;
            if (window.drawAnimInterval) {
                clearInterval(window.drawAnimInterval);
                window.drawAnimInterval = null;
            }
            S.animPlaying = false;
            render();
            setTimeout(initDrawCanvas, 50); // Re-init to restore proper state
        } else {
            // Start animation
            const frames = getCurrentFrames();
            if (!frames || frames.length <= 1) {
                toast('Add more frames to animate!');
                return;
            }
            
            // Save current frame before animating
            saveCurrentFrame();
            
            window.drawAnimRunning = true;
            S.animPlaying = true;
            render();
            
            const fps = S.drawFPS || 12;
            window.drawAnimInterval = setInterval(() => {
                if (!window.drawAnimRunning) {
                    clearInterval(window.drawAnimInterval);
                    window.drawAnimInterval = null;
                    return;
                }
                
                const frms = getCurrentFrames();
                S.drawFrameIndex = ((S.drawFrameIndex || 0) + 1) % frms.length;
                
                // Update canvas without full render
                const canvas = document.getElementById('drawCanvas');
                if (canvas && frms[S.drawFrameIndex]) {
                    const ctx = canvas.getContext('2d');
                    const dpr = window.devicePixelRatio || 1;
                    const w = canvas.width / dpr;
                    const h = canvas.height / dpr;
                    
                    const img = new Image();
                    img.onload = () => {
                        ctx.clearRect(0, 0, w, h);
                        ctx.fillStyle = '#fff';
                        ctx.fillRect(0, 0, w, h);
                        ctx.drawImage(img, 0, 0, w, h);
                    };
                    img.src = frms[S.drawFrameIndex];
                } else if (canvas) {
                    // Blank frame
                    const ctx = canvas.getContext('2d');
                    const dpr = window.devicePixelRatio || 1;
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, 0, canvas.width / dpr, canvas.height / dpr);
                }
                
                // Update frame indicator
                document.querySelectorAll('[data-frame-index]').forEach(el => {
                    el.style.borderColor = parseInt(el.dataset.frameIndex) === S.drawFrameIndex ? '#fff' : '#444';
                });
            }, 1000 / fps);
        }
    }
    
    function stopDrawAnimation() {
        window.drawAnimRunning = false;
        if (window.drawAnimInterval) {
            clearInterval(window.drawAnimInterval);
            window.drawAnimInterval = null;
        }
        S.animPlaying = false;
    }
    
    // Panel animation player - runs animated drawings in comic view
    window.panelAnimIntervals = {};
    
    function startPanelAnimations() {
        stopPanelAnimations(); // Clear any existing
        
        // Get current page data
        const page = S.pages[S.previewMode ? S.previewPage - 1 : S.currentPage];
        if (!page || !page.panelDrawings) return;
        
        // Find all animated panel drawings in DOM
        document.querySelectorAll('.panel-drawing[data-frame-count]').forEach(img => {
            const frameCount = parseInt(img.dataset.frameCount);
            if (frameCount <= 1) return;
            
            const panelId = img.dataset.panel;
            const panelData = page.panelDrawings[panelId];
            if (!panelData || !panelData.frames) return;
            
            const frames = panelData.frames;
            let frameIndex = 0;
            
            window.panelAnimIntervals[panelId] = setInterval(() => {
                frameIndex = (frameIndex + 1) % frames.length;
                if (frames[frameIndex]) {
                    img.src = frames[frameIndex];
                }
            }, 100); // ~10fps
        });
    }
    
    function stopPanelAnimations() {
        Object.keys(window.panelAnimIntervals).forEach(key => {
            clearInterval(window.panelAnimIntervals[key]);
        });
        window.panelAnimIntervals = {};
    }
    
    // Panel-specific drawing mode
    function enterPanelDrawMode(panelIndex) {
        S.drawMode = true;
        S.drawPanelIndex = panelIndex;
        S.drawFrameIndex = 0;
        S.drawHistory = [];
        S.drawRedoStack = [];
        
        // Initialize panel drawings if not exists
        const page = getPage();
        if (!page.panelDrawings) page.panelDrawings = {};
        if (!page.panelDrawings[panelIndex]) {
            page.panelDrawings[panelIndex] = { frames: [null] };
        }
        
        render();
        setTimeout(initDrawCanvas, 50);
    }
    
    function enterFullPageDrawMode() {
        S.drawMode = true;
        S.drawPanelIndex = null; // null means full page
        S.drawFrameIndex = 0;
        S.drawHistory = [];
        S.drawRedoStack = [];
        render();
        setTimeout(initDrawCanvas, 50);
    }
    
    function renderDrawMode() {
        if (!S.drawMode) return '';
        
        const colors = ['#000000', '#ffffff', '#ff3b30', '#ff9500', '#ffcc00', '#34c759', '#007aff', '#af52de', '#ff2d55', '#8e8e93'];
        const page = getPage();
        
        // Get frames - either panel-specific or full page
        const isPanelMode = S.drawPanelIndex !== null;
        const frames = isPanelMode 
            ? (page.panelDrawings?.[S.drawPanelIndex]?.frames || [null])
            : (page.drawFrames || [null]);
        const currentFrame = S.drawFrameIndex || 0;
        const uiHidden = S.drawUIHidden || false;
        
        // Get panel info for display
        const panelLabel = isPanelMode ? `Panel ${S.drawPanelIndex + 1}` : 'Full Page';
        const isMobile = window.innerWidth < 768;
        
        return `
            <div class="flipaclip-mode" style="position:fixed;inset:0;z-index:9999;background:#111;display:flex;flex-direction:column;overflow-y:auto;-webkit-overflow-scrolling:touch">
                
                <!-- Top Bar - FIXED for mobile access -->
                <div style="display:flex;justify-content:space-between;align-items:center;padding:${isMobile?'8px 10px':'12px 16px'};background:#000;border-bottom:1px solid #333;opacity:${uiHidden?'0':'1'};pointer-events:${uiHidden?'none':'auto'};transition:opacity 0.3s;flex-shrink:0;min-height:${isMobile?'50px':'auto'};position:sticky;top:0;z-index:100">
                    <button onclick="exitDrawMode(false)" style="width:${isMobile?'40px':'36px'};height:${isMobile?'40px':'36px'};border-radius:50%;border:1px solid #333;background:#222;color:#fff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0"></button>
                    <span style="color:#fff;font-size:${isMobile?'11px':'13px'};font-weight:600;letter-spacing:1px;flex:1;text-align:center;overflow:hidden;white-space:nowrap">${panelLabel.toUpperCase()}</span>
                    <button onclick="exitDrawMode(true)" style="padding:${isMobile?'10px 16px':'8px 20px'};border-radius:4px;border:none;background:#fff;color:#000;font-size:${isMobile?'12px':'11px'};font-weight:700;cursor:pointer;letter-spacing:1px;flex-shrink:0">SAVE</button>
                </div>
                
                <!-- Canvas Area -->
                <div style="flex:1;display:flex;align-items:center;justify-content:center;background:#1a1a1a;position:relative;overflow:hidden;min-height:${isMobile?'200px':'300px'}" onclick="${uiHidden?'S.drawUIHidden=false;render()':''}">
                    <!-- Floating Tool Palette (Left) - Hidden on very small mobile -->
                    <div class="tool-palette" style="position:absolute;left:${isMobile?'6px':'12px'};top:50%;transform:translateY(-50%);background:#000;border:1px solid #444;border-radius:8px;padding:${isMobile?'4px':'6px'};display:${isMobile && window.innerWidth < 400 ? 'none' : 'flex'};flex-direction:column;gap:2px;opacity:${uiHidden?'0':'1'};pointer-events:${uiHidden?'none':'auto'};transition:opacity 0.3s;z-index:100">
                        <button data-tool="pen" onclick="event.stopPropagation();setDrawTool('pen')" style="width:${isMobile?'36px':'40px'};height:${isMobile?'36px':'40px'};border-radius:4px;border:1px solid ${S.drawTool==='pen'?'#fff':'transparent'};background:${S.drawTool==='pen'?'#333':'transparent'};color:#fff;font-size:16px;cursor:pointer" title="Pen"></button>
                        <button data-tool="eraser" onclick="event.stopPropagation();setDrawTool('eraser')" style="width:${isMobile?'36px':'40px'};height:${isMobile?'36px':'40px'};border-radius:4px;border:1px solid ${S.drawTool==='eraser'?'#fff':'transparent'};background:${S.drawTool==='eraser'?'#333':'transparent'};color:#fff;font-size:14px;cursor:pointer" title="Eraser"></button>
                        <button onclick="event.stopPropagation();clearDrawing()" style="width:${isMobile?'36px':'40px'};height:${isMobile?'36px':'40px'};border-radius:4px;border:1px solid #333;background:transparent;color:#666;font-size:10px;cursor:pointer" title="Clear">CLR</button>
                    </div>
                    
                    <!-- Canvas -->
                    <div style="width:90%;max-width:600px;${isPanelMode ? 'aspect-ratio:4/3' : 'aspect-ratio:16/9'};background:#f5f5f0;border-radius:2px;box-shadow:0 20px 60px rgba(0,0,0,0.8);position:relative;overflow:hidden;border:2px solid #fff">
                        <canvas id="drawCanvas" style="position:absolute;inset:0;width:100%;height:100%;cursor:crosshair;touch-action:none"></canvas>
                    </div>
                </div>
                
                <!-- Bottom Bar - Simplified for mobile -->
                <div style="background:#000;border-top:1px solid #333;padding:${isMobile?'8px':'12px 16px'};display:flex;flex-direction:column;gap:${isMobile?'6px':'10px'};opacity:${uiHidden?'0':'1'};pointer-events:${uiHidden?'none':'auto'};transition:opacity 0.3s;flex-shrink:0">
                    
                    <!-- Frame Controls Row -->
                    <div style="display:flex;justify-content:center;align-items:center;gap:${isMobile?'4px':'8px'};flex-wrap:wrap">
                        <button onclick="undoDraw()" style="width:32px;height:32px;border-radius:4px;border:1px solid #333;background:transparent;color:#888;font-size:14px;cursor:pointer"></button>
                        <button onclick="prevDrawFrame()" style="width:32px;height:32px;border-radius:4px;border:1px solid #333;background:transparent;color:#666;font-size:12px;cursor:pointer"></button>
                        <button onclick="toggleDrawAnimation()" style="width:40px;height:40px;border-radius:4px;border:1px solid ${window.drawAnimRunning?'#fff':'#333'};background:${window.drawAnimRunning?'#fff':'transparent'};color:${window.drawAnimRunning?'#000':'#fff'};font-size:16px;cursor:pointer">${window.drawAnimRunning?'':''}</button>
                        <button onclick="nextDrawFrame()" style="width:32px;height:32px;border-radius:4px;border:1px solid #333;background:transparent;color:#666;font-size:12px;cursor:pointer"></button>
                        <button onclick="addDrawFrame()" style="width:32px;height:32px;border-radius:4px;border:1px dashed #444;background:transparent;color:#666;font-size:18px;cursor:pointer" title="New Frame">+</button>
                    </div>
                    
                    <!-- Frame Thumbnails -->
                    <div style="display:flex;align-items:center;gap:4px;justify-content:center;overflow-x:auto;padding:4px 0;-webkit-overflow-scrolling:touch">
                        ${frames.map((f, i) => `
                            <div onclick="selectDrawFrame(${i})" data-frame-index="${i}" style="width:40px;height:30px;border-radius:4px;border:2px solid ${i===currentFrame?'#fff':'#333'};background:${f?'url('+f+') center/cover':'#222'};cursor:pointer;flex-shrink:0;position:relative;overflow:hidden">
                                <span style="position:absolute;bottom:1px;right:2px;font-size:8px;color:${i===currentFrame?'#fff':'#666'};font-weight:bold">${i+1}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Color Bar - Compact -->
                    <div style="display:flex;align-items:center;justify-content:center;gap:${isMobile?'4px':'6px'};flex-wrap:wrap">
                        ${colors.map(c => `
                            <div onclick="S.drawColor='${c}'" style="width:${S.drawColor===c?'26px':'22px'};height:${S.drawColor===c?'26px':'22px'};border-radius:50%;background:${c};cursor:pointer;border:${S.drawColor===c?'2px solid #fff':'1px solid rgba(255,255,255,0.3)'}"></div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    // Animation frame functions
    function prevDrawFrame() {
        if (S.drawFrameIndex > 0) {
            saveCurrentFrame();
            S.drawFrameIndex--;
            updateFrameUI();
            setTimeout(initDrawCanvas, 100);
        }
    }
    
    function nextDrawFrame() {
        const frames = getCurrentFrames();
        if (S.drawFrameIndex < frames.length - 1) {
            saveCurrentFrame();
            S.drawFrameIndex++;
            updateFrameUI();
            setTimeout(initDrawCanvas, 100);
        }
    }

    // ===== ANIMATION MODE FUNCTIONS =====
    
    const PANEL_ANIMATIONS = [
        { id: 'none', name: 'None', icon: '' },
        { id: 'fade', name: 'Fade', icon: '' },
        { id: 'slide-left', name: 'Slide Left', icon: '' },
        { id: 'slide-right', name: 'Slide Right', icon: '' },
        { id: 'slide-up', name: 'Slide Up', icon: '' },
        { id: 'slide-down', name: 'Slide Down', icon: '' },
        { id: 'zoom', name: 'Zoom', icon: '' },
        { id: 'pop', name: 'Pop', icon: '' },
        { id: 'kenburns-in', name: 'KB Zoom In', icon: '' },
        { id: 'kenburns-out', name: 'KB Zoom Out', icon: '' },
        { id: 'kenburns-left', name: 'KB Pan Left', icon: '' },
        { id: 'kenburns-right', name: 'KB Pan Right', icon: '' }
    ];
    
    const ELEMENT_ANIMATIONS = [
        { id: 'none', name: 'None', icon: '' },
        { id: 'fade', name: 'Fade', icon: '' },
        { id: 'pop', name: 'Pop', icon: '' },
        { id: 'bounce', name: 'Bounce', icon: '' },
        { id: 'shake', name: 'Shake', icon: '' },
        { id: 'spin', name: 'Spin', icon: '' },
        { id: 'pulse', name: 'Pulse', icon: '' },
        { id: 'flash', name: 'Flash', icon: '' },
        { id: 'float', name: 'Float', icon: '' },
        { id: 'jello', name: 'Jello', icon: '' }
    ];
    
    const PAGE_TRANSITIONS = [
        { id: 'none', name: 'None', icon: '' },
        { id: 'fade', name: 'Fade', icon: '' },
        { id: 'slide-left', name: 'Slide Left', icon: '' },
        { id: 'slide-right', name: 'Slide Right', icon: '' },
        { id: 'flip', name: 'Page Flip', icon: '' },
        { id: 'zoom', name: 'Zoom', icon: '' }
    ];
    
    const ANIM_SPEEDS = [
        { id: 'fast', name: 'Fast', duration: 0.3 },
        { id: 'normal', name: 'Normal', duration: 0.5 },
        { id: 'slow', name: 'Slow', duration: 0.8 },
        { id: 'very-slow', name: 'Cinematic', duration: 3.0 }
    ];
    
    let animSelectedPanel = null;
    let animSelectedElement = null;
    let animPlayTimeout = null;
    
    function enterAnimateMode() {
        const page = getPage();
        // Initialize animation data if not exists
        if (!page.panelAnimations) {
            page.panelAnimations = {};
        }
        if (!page.elementAnimations) {
            page.elementAnimations = {};
        }
        S.animateMode = true;
        S.animatePlaying = false;
        animSelectedPanel = 0;
        animSelectedElement = null;
        render();
    }
    
    function exitAnimateMode() {
        S.animateMode = false;
        S.animatePlaying = false;
        if (animPlayTimeout) clearTimeout(animPlayTimeout);
        render();
    }
    
    function selectAnimPanel(idx) {
        animSelectedPanel = idx;
        animSelectedElement = null;
        render();
    }
    
    function selectAnimElement(id) {
        animSelectedElement = id;
        animSelectedPanel = null;
        render();
    }
    
    function setAnimationType(type) {
        const page = getPage();
        if (animSelectedPanel !== null) {
            if (!page.panelAnimations[animSelectedPanel]) {
                page.panelAnimations[animSelectedPanel] = { type: 'none', speed: 'normal', delay: 0 };
            }
            page.panelAnimations[animSelectedPanel].type = type;
        } else if (animSelectedElement !== null) {
            if (!page.elementAnimations[animSelectedElement]) {
                page.elementAnimations[animSelectedElement] = { type: 'none', speed: 'normal', delay: 0 };
            }
            page.elementAnimations[animSelectedElement].type = type;
        }
        render();
    }
    
    function setAnimationSpeed(speed) {
        const page = getPage();
        if (animSelectedPanel !== null && page.panelAnimations[animSelectedPanel]) {
            page.panelAnimations[animSelectedPanel].speed = speed;
        } else if (animSelectedElement !== null && page.elementAnimations[animSelectedElement]) {
            page.elementAnimations[animSelectedElement].speed = speed;
        }
        render();
    }
    
    function setAnimationDelay(delay) {
        const page = getPage();
        if (animSelectedPanel !== null && page.panelAnimations[animSelectedPanel]) {
            page.panelAnimations[animSelectedPanel].delay = delay;
        } else if (animSelectedElement !== null && page.elementAnimations[animSelectedElement]) {
            page.elementAnimations[animSelectedElement].delay = delay;
        }
        render();
    }
    
    function playPageAnimation() {
        S.animatePlaying = true;
        render();
        
        // Calculate total animation duration
        const page = getPage();
        let maxTime = 0;
        
        // Check panel animations
        page.panels.forEach((p, i) => {
            const anim = page.panelAnimations[i];
            if (anim && anim.type !== 'none') {
                const speed = ANIM_SPEEDS.find(s => s.id === anim.speed) || ANIM_SPEEDS[1];
                const time = (anim.delay || 0) + speed.duration;
                if (time > maxTime) maxTime = time;
            }
        });
        
        // Check element animations
        page.pageElements.forEach(el => {
            const anim = page.elementAnimations[el.id];
            if (anim && anim.type !== 'none') {
                const speed = ANIM_SPEEDS.find(s => s.id === anim.speed) || ANIM_SPEEDS[1];
                const time = (anim.delay || 0) + speed.duration;
                if (time > maxTime) maxTime = time;
            }
        });
        
        // Stop after animation completes
        animPlayTimeout = setTimeout(() => {
            S.animatePlaying = false;
            render();
        }, (maxTime + 0.5) * 1000);
    }
    
    function stopPageAnimation() {
        S.animatePlaying = false;
        if (animPlayTimeout) clearTimeout(animPlayTimeout);
        render();
    }
    
    function getAnimClass(anim, isPlaying) {
        if (!isPlaying || !anim || anim.type === 'none') return '';
        return 'playing-' + anim.type;
    }
    
    function getAnimStyle(anim, isPlaying) {
        if (!isPlaying || !anim || anim.type === 'none') return '';
        const speed = ANIM_SPEEDS.find(s => s.id === anim.speed) || ANIM_SPEEDS[1];
        const delay = anim.delay || 0;
        return `animation-duration: ${speed.duration}s; animation-delay: ${delay}s; opacity: 0;`;
    }
    
    function renderAnimateMode() {
        if (!S.animateMode) return '';
        
        const page = getPage();
        const currentPanelAnim = animSelectedPanel !== null ? (page.panelAnimations[animSelectedPanel] || { type: 'none', speed: 'normal', delay: 0 }) : null;
        const currentElementAnim = animSelectedElement !== null ? (page.elementAnimations[animSelectedElement] || { type: 'none', speed: 'normal', delay: 0 }) : null;
        const currentAnim = currentPanelAnim || currentElementAnim;
        const animOptions = animSelectedPanel !== null ? PANEL_ANIMATIONS : ELEMENT_ANIMATIONS;
        
        return `
            <div class="animate-overlay">
                <div class="animate-header">
                    <div class="animate-title"> ANIMATE - Page ${S.currentPage + 1}</div>
                    <button onclick="exitAnimateMode()" style="background:none;border:none;color:#fff;font-size:24px;cursor:pointer">${icon('x', 24)}</button>
                </div>
                
                <div class="animate-preview-area">
                    <div class="animate-canvas" style="width:300px;height:388px">
                        ${page.panels.map((p, i) => {
                            const media = page.panelMedia[i];
                            const anim = page.panelAnimations[i] || { type: 'none' };
                            const animClass = getAnimClass(anim, S.animatePlaying);
                            const animStyle = getAnimStyle(anim, S.animatePlaying);
                            return `<div class="animate-panel ${animSelectedPanel === i ? 'selected' : ''} ${animClass}" 
                                style="left:${p.x}%;top:${p.y}%;width:${p.w}%;height:${p.h}%;${media ? 'background-image:url('+media.src+')' : 'background:#f0f0f0'};${animStyle}"
                                onclick="selectAnimPanel(${i})">
                                ${anim.type !== 'none' ? '<div class="animate-panel-badge">'+anim.type+'</div>' : ''}
                            </div>`;
                        }).join('')}
                        ${page.pageElements.map(el => {
                            const anim = page.elementAnimations[el.id] || { type: 'none' };
                            const animClass = getAnimClass(anim, S.animatePlaying);
                            const animStyle = getAnimStyle(anim, S.animatePlaying);
                            return `<div class="animate-element ${animSelectedElement === el.id ? 'selected' : ''} ${animClass}"
                                style="left:${el.x}%;top:${el.y}%;transform:translate(-50%,-50%) scale(0.6);${animStyle}"
                                onclick="selectAnimElement(${el.id})">
                                ${renderEl(el)}
                            </div>`;
                        }).join('')}
                    </div>
                </div>
                
                <div class="animate-timeline">
                    <div class="timeline-label"> TIMELINE - Tap panel/element to edit</div>
                    <div class="timeline-track">
                        ${page.panels.map((p, i) => {
                            const anim = page.panelAnimations[i];
                            const hasAnim = anim && anim.type !== 'none';
                            return `<div class="timeline-item ${animSelectedPanel === i ? 'active' : ''} ${hasAnim ? 'has-anim' : ''}" onclick="selectAnimPanel(${i})">
                                <div style="font-size:16px"></div>
                                <div>Panel ${i + 1}</div>
                                ${hasAnim ? '<div style="font-size:8px;color:#fff">'+anim.type+'</div>' : ''}
                            </div>`;
                        }).join('')}
                        ${page.pageElements.map(el => {
                            const anim = page.elementAnimations[el.id];
                            const hasAnim = anim && anim.type !== 'none';
                            const typeIcon = el.type === 'bubble' ? '' : el.type === 'effect' ? '' : '';
                            return `<div class="timeline-item ${animSelectedElement === el.id ? 'active' : ''} ${hasAnim ? 'has-anim' : ''}" onclick="selectAnimElement(${el.id})">
                                <div style="font-size:16px">${typeIcon}</div>
                                <div>${el.type}</div>
                                ${hasAnim ? '<div style="font-size:8px;color:#fff">'+anim.type+'</div>' : ''}
                            </div>`;
                        }).join('')}
                    </div>
                </div>
                
                ${currentAnim ? `
                <div class="animate-options">
                    <div class="anim-option-row">
                        <div class="anim-option-label">Animation</div>
                        <div class="anim-option-btns">
                            ${animOptions.map(a => `
                                <div class="anim-type-btn ${currentAnim.type === a.id ? 'active' : ''}" onclick="setAnimationType('${a.id}')">
                                    ${a.icon} ${a.name}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="anim-option-row">
                        <div class="anim-option-label">Speed</div>
                        <div class="anim-option-btns">
                            ${ANIM_SPEEDS.map(s => `
                                <div class="anim-type-btn ${currentAnim.speed === s.id ? 'active' : ''}" onclick="setAnimationSpeed('${s.id}')">
                                    ${s.name}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="anim-option-row">
                        <div class="anim-option-label">Delay</div>
                        <div class="anim-option-btns">
                            <div class="anim-type-btn ${(currentAnim.delay || 0) === 0 ? 'active' : ''}" onclick="setAnimationDelay(0)">None</div>
                            <div class="anim-type-btn ${currentAnim.delay === 0.2 ? 'active' : ''}" onclick="setAnimationDelay(0.2)">0.2s</div>
                            <div class="anim-type-btn ${currentAnim.delay === 0.5 ? 'active' : ''}" onclick="setAnimationDelay(0.5)">0.5s</div>
                            <div class="anim-type-btn ${currentAnim.delay === 1 ? 'active' : ''}" onclick="setAnimationDelay(1)">1s</div>
                        </div>
                    </div>
                </div>
                ` : '<div style="padding:16px;text-align:center;color:#888">Select a panel or element to add animation</div>'}
                
                <div style="background:#1a1a2e;padding:12px 16px;border-top:1px solid #333">
                    <div class="anim-option-row" style="margin-bottom:0">
                        <div class="anim-option-label"> Page Transition</div>
                        <div class="anim-option-btns">
                            ${PAGE_TRANSITIONS.map(t => `
                                <div class="anim-type-btn ${(page.transition || 'none') === t.id ? 'active' : ''}" onclick="setPageTransition('${t.id}')">
                                    ${t.icon} ${t.name}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <div class="animate-controls">
                    ${S.animatePlaying ? 
                        `<button class="anim-btn" onclick="stopPageAnimation()"> Stop</button>` :
                        `<button class="anim-btn play" onclick="playPageAnimation()"> Play Preview</button>`
                    }
                    <button class="anim-btn" onclick="S.activeSheet='export-animated';render()"> Export</button>
                    <button class="anim-btn" onclick="clearAllAnimations()"> Clear All</button>
                    <button class="anim-btn" onclick="exitAnimateMode()"> Done</button>
                </div>
            </div>
        `;
    }
    
    function clearAllAnimations() {
        const page = getPage();
        page.panelAnimations = {};
        page.elementAnimations = {};
        page.transition = 'none';
        toast('All animations cleared');
        render();
    }

    function addElement(type, data) {
        const el = { id: Date.now(), type, x: 30 + Math.random() * 40, y: 30 + Math.random() * 40, rotation: 0, scale: 1, ...data };
        getPage().pageElements.push(el);
        S.selectedElement = el.id;
        S.activeSheet = null;
        
        // Auto-sync to collab
        if (S.collabMode && S.collabSession) {
            syncPageToCollab();
        }
        
        render();
    }

    function startBubble(cls) { S.pendingBubble = cls; S.pendingEffect = null; S.editText = ''; S.activeSheet = 'enter-text'; render(); }
    
    function startCustomEffect() { S.pendingEffect = true; S.pendingBubble = null; S.editText = ''; S.activeSheet = 'custom-effect'; render(); }
    
    function confirmText() {
        if (!S.editText.trim()) { S.activeSheet = null; render(); return; }
        if (S.pendingBubble !== null) {
            addElement('bubble', { cls: S.pendingBubble, text: S.editText });
        } else if (S.pendingEffect) {
            addElement('effect', { text: S.editText.toUpperCase(), color: S.effectColor });
        }
        S.pendingBubble = null;
        S.pendingEffect = null;
        S.editText = '';
    }
    
    function addEffect(text, color) {
        if (color === 'custom') {
            startCustomEffect();
        } else {
            addElement('effect', { text, color });
        }
    }

    function handleEdit(e, id) {
        e.stopPropagation();
        const el = getPage().pageElements.find(x => x.id === id);
        if (el?.text) { S.editModal = { id }; S.editText = el.text; render(); }
    }

    function handleDelete(e, id) {
        e.stopPropagation();
        getPage().pageElements = getPage().pageElements.filter(x => x.id !== id);
        S.selectedElement = null;
        toast('Deleted!');
        
        // Auto-sync to collab
        if (S.collabMode && S.collabSession) {
            syncPageToCollab();
        }
        
        render();
    }

    function saveEdit() {
        const el = getPage().pageElements.find(x => x.id === S.editModal.id);
        if (el) el.text = S.editText;
        S.editModal = null;
        render();
    }

    function applyTemplate(id) {
        const t = TEMPLATES.find(x => x.id === id);
        if (!t) return;
        const p = getPage();
        p.templateId = id;
        p.panels = JSON.parse(JSON.stringify(t.panels));
        p.panelMedia = {};
        p.panelFilters = {};
        p.panelElements = {};
        S.activeSheet = null;
        render();
    }
    
    function applyFilter(filterId) {
        const p = getPage();
        if (!p.panelFilters) p.panelFilters = {};
        p.panelFilters[S.selectedPanel] = filterId;
        S.activeSheet = null;
        toast(filterId === 'none' ? 'Filter removed' : 'Filter applied!');
        render();
    }
    
    function applyCardPreset(presetId) {
        const preset = CARD_PRESETS.find(p => p.id === presetId);
        if (preset) {
            S.card.style = preset.style;
            S.card.title = preset.title;
            S.activeSheet = null;
            toast('Card preset applied!');
            render();
        }
    }
    
    function applyCoverPreset(presetId) {
        const preset = COVER_PRESETS.find(p => p.id === presetId);
        if (preset) {
            S.cover.style = preset.style;
            S.cover.series = preset.series;
            S.activeSheet = null;
            toast('Cover preset applied!');
            render();
        }
    }

    function addPage() { 
        S.pages.push(createPage()); 
        S.currentPage = S.pages.length - 1; 
        trackEvent('page_added', { total_pages: S.pages.length });
        render(); 
    }

    // ===== SAVE TO PHOTOS =====
    async function saveToPhotos(type) {
        // Check export limits first
        if (!canExport()) {
            showUpgradeModal('exports');
            return;
        }
        
        S.loading = true;
        S.activeSheet = null;
        S.saveHelp = null;
        render();
        
        await new Promise(function(r) { setTimeout(r, 300); });
        
        try {
            var canvas = document.getElementById('exportCanvas');
            var ctx = canvas.getContext('2d');
            
            if (type === 'comic') {
                await renderComic(canvas, ctx);
            } else if (type === 'card') {
                await renderCard(canvas, ctx);
            } else if (type === 'card-back') {
                await renderCardBack(canvas, ctx);
            } else if (type === 'cover') {
                await renderCover(canvas, ctx);
            } else if (type === 'cover-back') {
                await renderCoverBack(canvas, ctx);
            }
            
            // Add watermark for free tier
            addWatermark(ctx, canvas.width, canvas.height);
            
            await new Promise(function(r) { setTimeout(r, 100); });
            
            var dataUrl = canvas.toDataURL('image/png');
            
            // Increment export counter
            incrementExportCount();
            
            S.loading = false;
            S.savePreview = { dataUrl: dataUrl, type: type };
            render();
            
            // Track export event
            trackEvent('content_exported', {
                content_type: type,
                user_tier: getUserTier(),
                exports_today: S.exportsToday
            });
            
        } catch (err) {
            console.error('Save error:', err);
            S.loading = false;
            S.savePreview = null;
            // Fallback to help modal
            S.saveHelp = type;
            render();
        }
    }
    
    function closeSavePreview() {
        S.savePreview = null;
        render();
    }
    
    function showSaveHelp(type) {
        S.saveHelp = type;
        render();
    }
    
    function closeSaveHelp() {
        S.saveHelp = null;
        render();
    }

    async function renderComic(canvas, ctx) {
        try {
            canvas.width = 1080;
            canvas.height = 1400;
            
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, 1080, 1400);
            
            const page = getPage();
            if (!page) {
                throw new Error('No page found');
            }
            
            // Comic dimensions - 8.5:11 ratio
            const comicW = 900;
            const comicH = comicW * (11 / 8.5);
            const comicX = (1080 - comicW) / 2;
            const comicY = 50;
            
            // White background
            ctx.fillStyle = '#fff';
            ctx.fillRect(comicX, comicY, comicW, comicH);
            
            // Draw panels
            const panels = page.panels || [];
            for (let i = 0; i < panels.length; i++) {
                try {
                    const panel = panels[i];
                    if (!panel) continue;
                    
                    const px = comicX + (panel.x / 100) * comicW;
                    const py = comicY + (panel.y / 100) * comicH;
                    const pw = (panel.w / 100) * comicW;
                    const ph = (panel.h / 100) * comicH;
                    
                    // Panel background
                    ctx.fillStyle = '#f5f5f5';
                    ctx.fillRect(px, py, pw, ph);
                    
                    // Panel image
                    const media = page.panelMedia ? page.panelMedia[i] : null;
                    if (media && media.src) {
                        await loadAndDrawImage(ctx, media.src, px, py, pw, ph);
                    }
                    
                    // Panel border
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 4;
                    ctx.strokeRect(px, py, pw, ph);
                } catch (panelErr) {
                    console.warn('Panel error:', panelErr);
                }
            }
            
            // Draw all elements on top
            const elements = page.pageElements || [];
            for (let i = 0; i < elements.length; i++) {
                try {
                    const el = elements[i];
                    if (!el) continue;
                    
                    const ex = comicX + ((el.x || 50) / 100) * comicW;
                    const ey = comicY + ((el.y || 50) / 100) * comicH;
                    drawElementSimple(ctx, el, ex, ey);
                } catch (elErr) {
                    console.warn('Element error:', elErr);
                }
            }
            
            // Draw the drawing layer if exists
            if (page.drawingData) {
                try {
                    await new Promise((resolve, reject) => {
                        const drawImg = new Image();
                        drawImg.onload = function() {
                            ctx.globalCompositeOperation = 'multiply';
                            ctx.drawImage(drawImg, comicX, comicY, comicW, comicH);
                            ctx.globalCompositeOperation = 'source-over';
                            resolve();
                        };
                        drawImg.onerror = reject;
                        drawImg.src = page.drawingData;
                    });
                } catch (drawErr) {
                    console.warn('Drawing layer error:', drawErr);
                }
            }
            
            // Watermark
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.font = 'bold 24px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Made with PRESS START CoMixx', 540, 1370);
            
        } catch (err) {
            console.error('renderComic error:', err);
            throw err;
        }
    }
    
    function loadAndDrawImage(ctx, src, x, y, w, h) {
        return new Promise(resolve => {
            try {
                const img = new Image();
                img.onload = function() {
                    try {
                        const ir = img.width / img.height;
                        const pr = w / h;
                        let sx = 0, sy = 0, sw = img.width, sh = img.height;
                        if (ir > pr) {
                            sw = img.height * pr;
                            sx = (img.width - sw) / 2;
                        } else {
                            sh = img.width / pr;
                            sy = (img.height - sh) / 2;
                        }
                        ctx.drawImage(img, sx, sy, sw, sh, x, y, w, h);
                    } catch (e) {
                        console.warn('Draw error:', e);
                    }
                    resolve();
                };
                img.onerror = function() {
                    console.warn('Image load failed');
                    resolve();
                };
                img.src = src;
            } catch (e) {
                console.warn('Image setup error:', e);
                resolve();
            }
        });
    }
    
    function drawElementSimple(ctx, el, x, y) {
        try {
            ctx.save();
            ctx.translate(x, y);
            
            const rotation = el.rotation || 0;
            if (rotation) {
                ctx.rotate((rotation * Math.PI) / 180);
            }
            
            const elType = el.type || '';
            
            if (elType === 'bubble') {
                const text = String(el.text || '');
                const fontSize = el.fontSize || 22;
                ctx.font = 'bold ' + fontSize + 'px Bangers, cursive';
                
                // Better word wrap that handles long words
                const maxW = el.maxWidth || 280;
                const lines = [];
                
                // Split by newlines first, then by spaces
                const paragraphs = text.split('\n');
                
                for (let p = 0; p < paragraphs.length; p++) {
                    const words = paragraphs[p].split(' ');
                    let line = '';
                    
                    for (let i = 0; i < words.length; i++) {
                        let word = words[i];
                        
                        // Handle very long words - break them if needed
                        while (ctx.measureText(word).width > maxW) {
                            // Find break point
                            let breakAt = word.length - 1;
                            while (breakAt > 1 && ctx.measureText(word.substring(0, breakAt)).width > maxW) {
                                breakAt--;
                            }
                            
                            if (line) {
                                lines.push(line);
                                line = '';
                            }
                            lines.push(word.substring(0, breakAt));
                            word = word.substring(breakAt);
                        }
                        
                        const test = line ? line + ' ' + word : word;
                        if (ctx.measureText(test).width > maxW && line) {
                            lines.push(line);
                            line = word;
                        } else {
                            line = test;
                        }
                    }
                    if (line) lines.push(line);
                }
                
                if (lines.length === 0) lines.push('');
                
                // Measure max width of all lines
                let maxLineW = 60;
                for (let i = 0; i < lines.length; i++) {
                    const w = ctx.measureText(lines[i]).width;
                    if (w > maxLineW) maxLineW = w;
                }
                
                const padX = 24;
                const padY = 16;
                const lineH = fontSize * 1.35;
                const bubbleW = maxLineW + padX * 2;
                const bubbleH = lines.length * lineH + padY * 2;
                
                // Bubble color based on class
                const cls = el.cls || '';
                const bgColor = cls === 'shout' ? '#ffeb3b' : cls === 'burst' ? '#ff5722' : '#fff';
                const textColor = cls === 'burst' ? '#fff' : '#000';
                
                // Draw rounded bubble
                const r = Math.min(15, bubbleW * 0.1, bubbleH * 0.1);
                ctx.beginPath();
                ctx.moveTo(-bubbleW/2 + r, -bubbleH/2);
                ctx.lineTo(bubbleW/2 - r, -bubbleH/2);
                ctx.quadraticCurveTo(bubbleW/2, -bubbleH/2, bubbleW/2, -bubbleH/2 + r);
                ctx.lineTo(bubbleW/2, bubbleH/2 - r);
                ctx.quadraticCurveTo(bubbleW/2, bubbleH/2, bubbleW/2 - r, bubbleH/2);
                ctx.lineTo(-bubbleW/2 + r, bubbleH/2);
                ctx.quadraticCurveTo(-bubbleW/2, bubbleH/2, -bubbleW/2, bubbleH/2 - r);
                ctx.lineTo(-bubbleW/2, -bubbleH/2 + r);
                ctx.quadraticCurveTo(-bubbleW/2, -bubbleH/2, -bubbleW/2 + r, -bubbleH/2);
                ctx.closePath();
                
                ctx.fillStyle = bgColor;
                ctx.fill();
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // Tail pointing down
                ctx.beginPath();
                ctx.moveTo(-12, bubbleH/2 - 2);
                ctx.lineTo(0, bubbleH/2 + 18);
                ctx.lineTo(12, bubbleH/2 - 2);
                ctx.closePath();
                ctx.fillStyle = bgColor;
                ctx.fill();
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // Cover the tail connection line
                ctx.fillStyle = bgColor;
                ctx.fillRect(-12, bubbleH/2 - 4, 24, 6);
                
                // Draw text
                ctx.fillStyle = textColor;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const startY = -((lines.length - 1) * lineH) / 2;
                for (let i = 0; i < lines.length; i++) {
                    ctx.fillText(lines[i], 0, startY + i * lineH);
                }
                
            } else if (elType === 'effect') {
                const text = String(el.text || '');
                const fontSize = el.fontSize || 36;
                ctx.font = 'bold ' + fontSize + 'px Bangers, cursive';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 4;
                ctx.strokeText(text, 0, 0);
                
                ctx.fillStyle = el.color || '#ff0000';
                ctx.fillText(text, 0, 0);
                
            } else if (elType === 'emoji') {
                const emoji = String(el.emoji || '');
                const fontSize = el.fontSize || 48;
                ctx.font = fontSize + 'px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(emoji, 0, 0);
            }
            
            ctx.restore();
        } catch (e) {
            console.warn('drawElementSimple error:', e);
            ctx.restore();
        }
    }

    async function renderCard(canvas, ctx) {
        try {
            canvas.width = 750;
            canvas.height = 1050;
            
            // Get style colors
            var style = S.card.style || 'gold';
            var bgColor = style === 'silver' ? '#2a2a3e' : style === 'fire' ? '#1a0a0a' : '#1a1a2e';
            var accentColor = style === 'silver' ? '#aaa' : style === 'fire' ? '#ff4500' : '#c9a227';
            var accentGrad1 = style === 'silver' ? '#888' : style === 'fire' ? '#ff4500' : '#c9a227';
            var accentGrad2 = style === 'silver' ? '#ccc' : style === 'fire' ? '#ff8c00' : '#f4d03f';
            var textOnAccent = style === 'fire' ? '#fff' : '#1a1a2e';
            
            // Background
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, 750, 1050);
            
            // Border
            ctx.strokeStyle = accentColor;
            ctx.lineWidth = 12;
            ctx.strokeRect(30, 30, 690, 990);
            
            // Inner card
            ctx.fillStyle = bgColor;
            ctx.fillRect(42, 42, 666, 966);
            
            // Title bar with gradient effect
            var titleGrad = ctx.createLinearGradient(42, 42, 708, 42);
            titleGrad.addColorStop(0, accentGrad1);
            titleGrad.addColorStop(0.5, accentGrad2);
            titleGrad.addColorStop(1, accentGrad1);
            ctx.fillStyle = titleGrad;
            ctx.fillRect(42, 42, 666, 80);
            ctx.fillStyle = textOnAccent;
            ctx.font = 'bold 36px Bebas Neue, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(String(S.card.title || 'HERO CARD'), 375, 95);
            
            // Image area with border
            ctx.fillStyle = '#111';
            ctx.fillRect(55, 135, 640, 510);
            ctx.strokeStyle = accentColor;
            ctx.lineWidth = 4;
            ctx.strokeRect(55, 135, 640, 510);
            
            // Draw image with transform
            var imgSrc = S.card.frontImage || S.card.image;
            if (imgSrc) {
                var t = S.card.frontTransform || S.card.imageTransform || {};
                await loadAndDrawImageWithTransform(ctx, imgSrc, 60, 140, 630, 500, t);
            }
            
            // Name bar
            var nameGrad = ctx.createLinearGradient(42, 660, 708, 660);
            nameGrad.addColorStop(0, accentGrad1);
            nameGrad.addColorStop(0.5, accentGrad2);
            nameGrad.addColorStop(1, accentGrad1);
            ctx.fillStyle = nameGrad;
            ctx.fillRect(42, 660, 666, 80);
            ctx.fillStyle = textOnAccent;
            ctx.font = 'bold 48px Bangers, cursive';
            ctx.textAlign = 'center';
            ctx.fillText(String(S.card.name || 'YOUR NAME'), 375, 715);
            
            // Stats bar
            ctx.fillStyle = bgColor;
            ctx.fillRect(42, 760, 666, 60);
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 26px sans-serif';
            var stats = S.card.stats || { pwr: 85, spd: 70, int: 90 };
            ctx.fillText('PWR ' + stats.pwr + '   SPD ' + stats.spd + '   INT ' + stats.int, 375, 800);
            
            // Bio area (white box at bottom)
            ctx.fillStyle = '#fff';
            ctx.fillRect(55, 835, 640, 130);
            ctx.strokeStyle = accentColor;
            ctx.lineWidth = 2;
            ctx.strokeRect(55, 835, 640, 130);
            
            // Watermark
            ctx.fillStyle = '#666';
            ctx.font = '18px sans-serif';
            ctx.fillText('PRESS START CoMixx', 375, 990);
            
        } catch (err) {
            console.error('renderCard error:', err);
            throw err;
        }
    }
    
    function loadAndDrawImageWithTransform(ctx, src, x, y, w, h, transform) {
        return new Promise(resolve => {
            try {
                const img = new Image();
                img.onload = function() {
                    try {
                        ctx.save();
                        ctx.beginPath();
                        ctx.rect(x, y, w, h);
                        ctx.clip();
                        
                        var scale = transform.scale || 1;
                        var offsetX = (transform.offsetX || 0) * w / 100;
                        var offsetY = (transform.offsetY || 0) * h / 100;
                        
                        var cx = x + w / 2 + offsetX;
                        var cy = y + h / 2 + offsetY;
                        
                        var ir = img.width / img.height;
                        var pr = w / h;
                        var drawW, drawH;
                        
                        if (ir > pr) {
                            drawH = h * scale;
                            drawW = drawH * ir;
                        } else {
                            drawW = w * scale;
                            drawH = drawW / ir;
                        }
                        
                        ctx.drawImage(img, cx - drawW/2, cy - drawH/2, drawW, drawH);
                        ctx.restore();
                    } catch (e) {
                        console.warn('Draw transform error:', e);
                        ctx.restore();
                    }
                    resolve();
                };
                img.onerror = function() {
                    console.warn('Image load failed');
                    resolve();
                };
                img.src = src;
            } catch (e) {
                console.warn('Image setup error:', e);
                resolve();
            }
        });
    }

    async function renderCover(canvas, ctx) {
        try {
            canvas.width = 663;
            canvas.height = 1025;
            
            // Get style colors
            var style = S.cover.style || 'classic';
            var bgColor = style === 'dark' ? '#0a0a0a' : style === 'vintage' ? '#f4e4c1' : '#222';
            var headerColor = style === 'dark' ? '#333' : style === 'vintage' ? '#8b4513' : '#c62828';
            var textColor = style === 'vintage' ? '#3d2914' : '#fff';
            
            // Background
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, 663, 1025);
            
            // Header bar
            ctx.fillStyle = headerColor;
            ctx.fillRect(0, 0, 663, 70);
            ctx.fillStyle = textColor;
            ctx.font = 'bold 32px Bebas Neue, sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(String(S.cover.series || 'PRESS START'), 20, 48);
            
            // Issue badge
            ctx.fillStyle = style === 'vintage' ? '#f4e4c1' : '#fff';
            ctx.fillRect(570, 18, 70, 34);
            ctx.fillStyle = headerColor;
            ctx.font = 'bold 22px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(String(S.cover.issue || '#1'), 605, 44);
            
            // Main image with transform
            var imgSrc = S.cover.frontImage || S.cover.image;
            if (imgSrc) {
                var t = S.cover.frontTransform || S.cover.imageTransform || {};
                await loadAndDrawImageWithTransform(ctx, imgSrc, 0, 70, 663, 850, t);
            } else {
                ctx.fillStyle = '#444';
                ctx.fillRect(0, 70, 663, 850);
            }
            
            // Title with shadow
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 64px Bangers, cursive';
            ctx.textAlign = 'center';
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 5;
            var title = String(S.cover.title || 'ADVENTURE');
            ctx.strokeText(title, 331, 780);
            ctx.fillText(title, 331, 780);
            
            // Tagline bar
            ctx.fillStyle = 'rgba(0,0,0,0.8)';
            ctx.fillRect(130, 830, 400, 50);
            ctx.fillStyle = '#ffeb3b';
            ctx.font = 'bold 24px sans-serif';
            ctx.fillText(String(S.cover.tagline || 'THE STORY BEGINS'), 331, 863);
            
            // Footer
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 950, 663, 75);
            ctx.fillStyle = '#666';
            ctx.font = '18px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(' PRESS START CoMixx', 20, 995);
            ctx.textAlign = 'right';
            ctx.fillText('$4.99', 643, 995);
            
        } catch (err) {
            console.error('renderCover error:', err);
            throw err;
        }
    }

    async function renderCardBack(canvas, ctx) {
        try {
            canvas.width = 750;
            canvas.height = 1050;
            
            // Get style colors
            var bgColor = S.card.style === 'silver' ? '#2a2a3e' : S.card.style === 'fire' ? '#1a0a0a' : '#1a1a2e';
            var accentColor = S.card.style === 'silver' ? '#aaa' : S.card.style === 'fire' ? '#ff4500' : '#c9a227';
            
            // Background
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, 750, 1050);
            
            // Border
            ctx.strokeStyle = accentColor;
            ctx.lineWidth = 12;
            ctx.strokeRect(30, 30, 690, 990);
            
            // Inner white area
            ctx.fillStyle = '#fff';
            ctx.fillRect(42, 42, 666, 966);
            
            // Name header
            ctx.fillStyle = accentColor;
            ctx.font = 'bold 42px Bangers, cursive';
            ctx.textAlign = 'center';
            ctx.fillText(String(S.card.name || 'HERO'), 375, 120);
            
            // Bio text
            ctx.fillStyle = '#333';
            ctx.font = '24px sans-serif';
            ctx.textAlign = 'center';
            var bio = String(S.card.bio || 'A mysterious hero with incredible powers...');
            var words = bio.split(' ');
            var lines = [];
            var line = '';
            for (var i = 0; i < words.length; i++) {
                var test = line + words[i] + ' ';
                if (ctx.measureText(test).width > 600 && line) {
                    lines.push(line);
                    line = words[i] + ' ';
                } else {
                    line = test;
                }
            }
            if (line) lines.push(line);
            
            for (var j = 0; j < lines.length && j < 15; j++) {
                ctx.fillText(lines[j], 375, 200 + j * 40);
            }
            
            // Stats at bottom
            ctx.fillStyle = bgColor;
            ctx.fillRect(42, 860, 666, 148);
            ctx.fillStyle = accentColor;
            ctx.font = 'bold 32px sans-serif';
            var stats = S.card.stats || { pwr: 85, spd: 70, int: 90 };
            ctx.fillText('PWR ' + stats.pwr + '   SPD ' + stats.spd + '   INT ' + stats.int, 375, 920);
            
            // Watermark
            ctx.fillStyle = '#888';
            ctx.font = '20px sans-serif';
            ctx.fillText('PRESS START CoMixx', 375, 980);
            
        } catch (err) {
            console.error('renderCardBack error:', err);
            throw err;
        }
    }

    async function renderCoverBack(canvas, ctx) {
        try {
            canvas.width = 663;
            canvas.height = 1025;
            
            // Get style colors
            var bgColor = S.cover.style === 'dark' ? '#0a0a0a' : S.cover.style === 'vintage' ? '#f4e4c1' : '#222';
            var textColor = S.cover.style === 'vintage' ? '#3d2914' : '#ccc';
            
            // Background
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, 663, 1025);
            
            // Synopsis text
            ctx.fillStyle = textColor;
            ctx.font = '22px sans-serif';
            ctx.textAlign = 'left';
            var backText = String(S.cover.backText || 'An epic adventure awaits in this exciting new comic series!');
            var words = backText.split(' ');
            var lines = [];
            var line = '';
            for (var i = 0; i < words.length; i++) {
                var test = line + words[i] + ' ';
                if (ctx.measureText(test).width > 600 && line) {
                    lines.push(line);
                    line = words[i] + ' ';
                } else {
                    line = test;
                }
            }
            if (line) lines.push(line);
            
            for (var j = 0; j < lines.length && j < 20; j++) {
                ctx.fillText(lines[j], 30, 60 + j * 36);
            }
            
            // Footer area
            ctx.fillStyle = S.cover.style === 'vintage' ? '#d4a574' : '#111';
            ctx.fillRect(0, 920, 663, 105);
            
            // Barcode
            ctx.fillStyle = '#fff';
            ctx.fillRect(530, 940, 100, 70);
            ctx.fillStyle = '#000';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('BARCODE', 580, 980);
            
            // Copyright
            ctx.fillStyle = S.cover.style === 'vintage' ? '#5a3a1a' : '#666';
            ctx.font = '16px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(' PRESS START CoMixx', 30, 980);
            
            // Price
            ctx.fillText(String(S.cover.price || '$4.99'), 30, 1000);
            
        } catch (err) {
            console.error('renderCoverBack error:', err);
            throw err;
        }
    }

    // Share/Publish Functions
    async function publishToCommunity() {
        if (!S.creatorName || S.creatorName.trim() === '') {
            toast('Please enter your creator name first!');
            return;
        }
        
        S.loading = true;
        render();
        
        try {
            // Package the comic data
            const comicData = {
                title: S.shareTitle || S.cover.title || 'Untitled Comic',
                creator: S.creatorName,
                description: S.shareDesc || '',
                series: S.cover.series,
                issue: S.cover.issue,
                pages: S.pages.length,
                createdAt: new Date().toISOString(),
                // We'll add image data when backend is ready
            };
            
            // For now, show success and instructions
            S.loading = false;
            S.publishSuccess = comicData;
            render();
            
            // Show publish success modal
            showPublishSuccess(comicData);
            
        } catch (err) {
            console.error('Publish error:', err);
            S.loading = false;
            toast('Failed to publish. Please try again.');
            render();
        }
    }
    
    function showPublishSuccess(comicData) {
        S.activeSheet = 'publish-success';
        render();
    }
    
    async function exportAllPages() {
        toast('Exporting pages... This may take a moment');
        S.loading = true;
        render();
        
        try {
            // Export cover first
            await saveToPhotos('cover');
            await new Promise(r => setTimeout(r, 500));
            
            // Export each comic page
            for (let i = 0; i < S.pages.length; i++) {
                S.currentPage = i;
                await saveToPhotos('comic');
                await new Promise(r => setTimeout(r, 500));
            }
            
            // Export card
            await saveToPhotos('card');
            await new Promise(r => setTimeout(r, 500));
            
            // Export back cover
            await saveToPhotos('cover-back');
            
            S.loading = false;
            toast('All pages exported! Check your saves.');
            
            // Track comic export
            trackEvent('comic_exported', {
                page_count: S.pages.length,
                export_type: 'full_comic'
            });
            trackActivity('comic_exported', { pageCount: S.pages.length });
            
            render();
            
        } catch (err) {
            console.error('Export error:', err);
            S.loading = false;
            toast('Export failed. Try saving pages individually.');
            render();
        }
    }
    
    async function exportFullComic() {
        S.activeSheet = 'export-preview';
        S.exportStep = 0;
        render();
    }
    
    // ===== ANIMATED EXPORT FUNCTIONS =====
    
    async function exportAnimatedGIF() {
        S.activeSheet = null;
        S.loading = true;
        render();
        
        toast('Creating GIF... This may take a moment');
        
        try {
            const page = getPage();
            const frames = [];
            const frameCount = 30; // 30 frames for smooth animation
            const frameDelay = 100; // 100ms per frame = 10fps
            
            // Create a temporary canvas for rendering
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 540;
            tempCanvas.height = 700;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Render base comic (static elements)
            const baseCanvas = document.createElement('canvas');
            baseCanvas.width = 540;
            baseCanvas.height = 700;
            const baseCtx = baseCanvas.getContext('2d');
            
            // White background
            baseCtx.fillStyle = '#fff';
            baseCtx.fillRect(0, 0, 540, 700);
            
            // Draw panels without animation
            for (let i = 0; i < page.panels.length; i++) {
                const panel = page.panels[i];
                const px = (panel.x / 100) * 540;
                const py = (panel.y / 100) * 700;
                const pw = (panel.w / 100) * 540;
                const ph = (panel.h / 100) * 700;
                
                baseCtx.fillStyle = '#f0f0f0';
                baseCtx.fillRect(px, py, pw, ph);
                
                const media = page.panelMedia[i];
                if (media && media.src) {
                    await loadAndDrawImage(baseCtx, media.src, px, py, pw, ph);
                }
                
                baseCtx.strokeStyle = '#000';
                baseCtx.lineWidth = 2;
                baseCtx.strokeRect(px, py, pw, ph);
            }
            
            // Generate frames with animations
            for (let f = 0; f < frameCount; f++) {
                const progress = f / (frameCount - 1); // 0 to 1
                
                // Copy base to temp
                tempCtx.drawImage(baseCanvas, 0, 0);
                
                // Draw animated elements
                for (const el of page.pageElements) {
                    const anim = page.elementAnimations ? page.elementAnimations[el.id] : null;
                    const animType = anim ? anim.type : 'none';
                    const delay = anim ? (anim.delay || 0) : 0;
                    const animProgress = Math.max(0, Math.min(1, (progress - delay * 2) * 3));
                    
                    tempCtx.save();
                    const ex = (el.x / 100) * 540;
                    const ey = (el.y / 100) * 700;
                    tempCtx.translate(ex, ey);
                    
                    // Apply animation transform
                    let opacity = 1;
                    let scale = 1;
                    let offsetX = 0;
                    let offsetY = 0;
                    let rotation = 0;
                    
                    if (animType === 'fade') {
                        opacity = animProgress;
                    } else if (animType === 'pop') {
                        scale = animProgress < 0.7 ? animProgress * 1.5 : 1 + (1 - animProgress) * 0.3;
                        opacity = animProgress;
                    } else if (animType === 'bounce') {
                        offsetY = Math.sin(animProgress * Math.PI * 2) * -20 * (1 - animProgress);
                    } else if (animType === 'shake') {
                        offsetX = Math.sin(animProgress * Math.PI * 6) * 10 * (1 - animProgress);
                    } else if (animType === 'spin') {
                        rotation = animProgress * 360;
                    }
                    
                    tempCtx.globalAlpha = opacity;
                    tempCtx.translate(offsetX, offsetY);
                    tempCtx.rotate(rotation * Math.PI / 180);
                    tempCtx.scale(scale, scale);
                    
                    // Draw element
                    drawElementSimple(tempCtx, el, 0, 0);
                    
                    tempCtx.restore();
                }
                
                // Store frame
                frames.push(tempCanvas.toDataURL('image/png'));
            }
            
            // Create GIF using simple frame display approach
            // Show frames as animated preview that user can save
            S.loading = false;
            S.gifFrames = frames;
            S.gifFrameIndex = 0;
            S.activeSheet = 'gif-preview';
            render();
            
            // Start animation loop
            startGifPreview();
            
        } catch (err) {
            console.error('GIF export error:', err);
            S.loading = false;
            toast('GIF export failed. Try again.');
            render();
        }
    }
    
    let gifInterval = null;
    
    function startGifPreview() {
        if (gifInterval) clearInterval(gifInterval);
        gifInterval = setInterval(() => {
            if (S.gifFrames && S.activeSheet === 'gif-preview') {
                S.gifFrameIndex = (S.gifFrameIndex + 1) % S.gifFrames.length;
                const img = document.getElementById('gifPreviewImg');
                if (img) img.src = S.gifFrames[S.gifFrameIndex];
            } else {
                clearInterval(gifInterval);
            }
        }, 100);
    }
    
    function stopGifPreview() {
        if (gifInterval) clearInterval(gifInterval);
        S.gifFrames = null;
        S.activeSheet = null;
        render();
    }
    
    async function exportAnimatedVideo() {
        S.activeSheet = null;
        toast('Video export coming soon! Use GIF for now.');
        
        // Future: Use MediaRecorder API to create video
        // For now, show a message about the feature
        setTimeout(() => {
            S.activeSheet = 'video-coming-soon';
            render();
        }, 500);
    }
    
    async function exportWebComic() {
        S.activeSheet = null;
        S.loading = true;
        render();
        
        toast('Creating interactive web comic...');
        
        try {
            const page = getPage();
            
            // Generate HTML for interactive comic
            let panelsHTML = '';
            let elementsHTML = '';
            let animCSS = '';
            
            // Build panel HTML with animations
            page.panels.forEach((panel, i) => {
                const media = page.panelMedia[i];
                const anim = page.panelAnimations ? page.panelAnimations[i] : null;
                const animClass = anim && anim.type !== 'none' ? `anim-${anim.type}` : '';
                const delay = anim ? (anim.delay || 0) : i * 0.2;
                
                panelsHTML += `
                    <div class="panel ${animClass}" style="
                        position:absolute;
                        left:${panel.x}%;top:${panel.y}%;
                        width:${panel.w}%;height:${panel.h}%;
                        ${media ? 'background-image:url(' + media.src + ');background-size:cover;background-position:center;' : 'background:#f0f0f0;'}
                        border:2px solid #000;
                        animation-delay:${delay}s;
                    "></div>`;
            });
            
            // Build element HTML with animations
            page.pageElements.forEach(el => {
                const anim = page.elementAnimations ? page.elementAnimations[el.id] : null;
                const animClass = anim && anim.type !== 'none' ? `anim-${anim.type}` : '';
                const delay = anim ? (anim.delay || 0) : 0.5;
                
                let content = '';
                if (el.type === 'bubble') {
                    const bgColor = el.cls === 'shout' ? '#ffeb3b' : el.cls === 'burst' ? '#ff5722' : '#fff';
                    const textColor = el.cls === 'burst' ? '#fff' : '#000';
                    content = `<div style="background:${bgColor};color:${textColor};padding:12px 16px;border-radius:12px;border:2px solid #000;font-family:Bangers,cursive;font-size:16px">${el.text}</div>`;
                } else if (el.type === 'effect') {
                    content = `<div style="font-family:Bangers,cursive;font-size:32px;color:${el.color};text-shadow:2px 2px 0 #000">${el.text}</div>`;
                } else if (el.type === 'emoji') {
                    content = `<div style="font-size:36px">${el.emoji}</div>`;
                }
                
                elementsHTML += `
                    <div class="element ${animClass}" style="
                        position:absolute;
                        left:${el.x}%;top:${el.y}%;
                        transform:translate(-50%,-50%);
                        animation-delay:${delay}s;
                    ">${content}</div>`;
            });
            
            // Build the full HTML file
            const htmlContent = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>${S.cover.title || 'My Comic'} - Press Start CoMixx</title>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { background:#0a0a0a; display:flex; justify-content:center; align-items:center; min-height:100vh; padding:20px; }
        .comic { position:relative; width:100%; max-width:500px; aspect-ratio:8.5/11; background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.5); }
        .panel, .element { opacity:0; animation-fill-mode:forwards; }
        @keyframes fade { to { opacity:1; } }
        @keyframes slide-left { from { transform:translateX(-100%); } to { transform:translateX(0); opacity:1; } }
        @keyframes slide-right { from { transform:translateX(100%); } to { transform:translateX(0); opacity:1; } }
        @keyframes slide-up { from { transform:translateY(100%); } to { transform:translateY(0); opacity:1; } }
        @keyframes slide-down { from { transform:translateY(-100%); } to { transform:translateY(0); opacity:1; } }
        @keyframes zoom { from { transform:scale(0); } to { transform:scale(1); opacity:1; } }
        @keyframes pop { 0% { transform:scale(0); } 70% { transform:scale(1.2); } 100% { transform:scale(1); opacity:1; } }
        @keyframes bounce { 0%,100% { transform:translate(-50%,-50%) translateY(0); opacity:1; } 50% { transform:translate(-50%,-50%) translateY(-20px); } }
        @keyframes shake { 0%,100% { transform:translate(-50%,-50%) translateX(0); opacity:1; } 25% { transform:translate(-50%,-50%) translateX(-10px); } 75% { transform:translate(-50%,-50%) translateX(10px); } }
        .anim-fade { animation: fade 0.5s ease-out forwards; }
        .anim-slide-left { animation: slide-left 0.5s ease-out forwards; }
        .anim-slide-right { animation: slide-right 0.5s ease-out forwards; }
        .anim-slide-up { animation: slide-up 0.5s ease-out forwards; }
        .anim-slide-down { animation: slide-down 0.5s ease-out forwards; }
        .anim-zoom { animation: zoom 0.4s ease-out forwards; }
        .anim-pop { animation: pop 0.4s ease-out forwards; }
        .anim-bounce { animation: bounce 0.6s ease-in-out forwards; }
        .anim-shake { animation: shake 0.5s ease-in-out forwards; }
        .replay { position:fixed; bottom:20px; right:20px; padding:12px 24px; background:#fff; color:#fff; border:none; border-radius:8px; font-size:16px; cursor:pointer; }
        .credit { position:fixed; bottom:20px; left:20px; color:#666; font-size:12px; }
    </style>
</head>
<body>
    <div class="comic">
        ${panelsHTML}
        ${elementsHTML}
    </div>
    <button class="replay" onclick="location.reload()"> Replay</button>
    <div class="credit">Made with Press Start CoMixx</div>
</body>
</html>`;
            
            // Create downloadable file
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            S.loading = false;
            S.webComicUrl = url;
            S.activeSheet = 'web-comic-ready';
            render();
            
        } catch (err) {
            console.error('Web comic export error:', err);
            S.loading = false;
            toast('Export failed. Try again.');
            render();
        }
    }
    
    function downloadWebComic() {
        if (!S.webComicUrl) return;
        
        const a = document.createElement('a');
        a.href = S.webComicUrl;
        a.download = (S.cover.title || 'my-comic').toLowerCase().replace(/\s+/g, '-') + '.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        toast('Downloaded! Open the HTML file in a browser.');
        S.activeSheet = null;
        render();
    }
    
    function shareToSocial() {
        // Use Web Share API if available
        if (navigator.share) {
            navigator.share({
                title: S.shareTitle || S.cover.title || 'My Comic',
                text: 'Check out my comic made with Press Start CoMixx!',
                url: 'https://www.psstreaming.online'
            }).catch(err => {
                console.log('Share cancelled or failed:', err);
            });
        } else {
            // Fallback: show share options
            S.activeSheet = 'share-options';
            render();
        }
    }
    
    function copyShareLink() {
        const shareText = `Check out "${S.shareTitle || S.cover.title || 'My Comic'}" - made with Press Start CoMixx!  https://www.psstreaming.online`;
        
        if (navigator.clipboard) {
            navigator.clipboard.writeText(shareText).then(() => {
                toast('Link copied to clipboard!');
            }).catch(err => {
                console.log('Copy failed:', err);
                fallbackCopy(shareText);
            });
        } else {
            fallbackCopy(shareText);
        }
    }
    
    function fallbackCopy(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            toast('Link copied!');
        } catch (err) {
            toast('Could not copy. Try manually!');
        }
        document.body.removeChild(textarea);
    }

    function renderEl(el) {
        if (el.type === 'bubble') return `<div class="bubble ${el.cls || ''}">${el.text}</div>`;
        if (el.type === 'effect') return `<div class="effect" style="color:${el.color}">${el.text}</div>`;
        if (el.type === 'emoji') return `<div class="emoji-sticker">${el.emoji}</div>`;
        return '';
    }

    // ========== LEGAL GATE SYSTEM ==========
    
    S.legalStep = 'age'; // age, parental, terms, toggles
    S.legalScrolled = false;
    S.ageInput = '';
    
    function renderLegalGate() {
        return `
            <div style="position:fixed;inset:0;background:#000;display:flex;flex-direction:column;z-index:99999;overflow:hidden">
                <!-- Header -->
                <div style="padding:24px;text-align:center;border-bottom:1px solid #333">
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:32px;color:#fff;letter-spacing:4px">PRESS START</div>
                    <div style="font-family:'Bangers',cursive;font-size:24px;color:#fff">CoMiXX</div>
                    <div style="font-size:11px;color:#666;margin-top:8px">by MADMixedMEDIA LLC</div>
                </div>
                
                ${S.legalStep === 'age' ? renderAgeStep() : ''}
                ${S.legalStep === 'parental' ? renderParentalStep() : ''}
                ${S.legalStep === 'terms' ? renderTermsStep() : ''}
                ${S.legalStep === 'toggles' ? renderTogglesStep() : ''}
            </div>
        `;
    }
    
    function renderAgeStep() {
        return `
            <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px">
                <div style="font-size:48px;margin-bottom:16px"></div>
                <div style="font-size:20px;color:#fff;font-weight:700;margin-bottom:8px">Welcome, Creator!</div>
                <div style="font-size:14px;color:#888;margin-bottom:32px;text-align:center">Before we start, please confirm your age</div>
                
                <div style="display:flex;gap:12px;margin-bottom:24px">
                    <button onclick="setAgeGroup('under13')" style="padding:16px 24px;border-radius:12px;border:2px solid ${S.ageInput==='under13'?'#fff':'#333'};background:${S.ageInput==='under13'?'#fff':'#111'};color:${S.ageInput==='under13'?'#000':'#fff'};font-size:14px;cursor:pointer">
                        Under 13
                    </button>
                    <button onclick="setAgeGroup('13-17')" style="padding:16px 24px;border-radius:12px;border:2px solid ${S.ageInput==='13-17'?'#fff':'#333'};background:${S.ageInput==='13-17'?'#fff':'#111'};color:${S.ageInput==='13-17'?'#000':'#fff'};font-size:14px;cursor:pointer">
                        13 - 17
                    </button>
                    <button onclick="setAgeGroup('18+')" style="padding:16px 24px;border-radius:12px;border:2px solid ${S.ageInput==='18+'?'#fff':'#333'};background:${S.ageInput==='18+'?'#fff':'#111'};color:${S.ageInput==='18+'?'#000':'#fff'};font-size:14px;cursor:pointer">
                        18+
                    </button>
                </div>
                
                <div style="display:flex;gap:12px;align-items:center;margin-bottom:24px">
                    <input type="checkbox" id="schoolCheck" onchange="S.isSchoolAccount=this.checked;render()" ${S.isSchoolAccount?'checked':''} style="width:20px;height:20px;accent-color:#fff">
                    <label for="schoolCheck" style="font-size:13px;color:#888">I'm using this through a school program</label>
                </div>
                
                ${S.ageInput === 'under13' ? `
                    <div style="background:#111;border:1px solid #444;border-radius:12px;padding:16px;max-width:320px;text-align:center;margin-bottom:16px">
                        <div style="font-size:14px;color:#fff;font-weight:600">Age Requirement</div>
                        <div style="font-size:12px;color:#888;margin-top:8px">You must be at least 13 years old to use PSCoMiXX. Please ask a parent or teacher to set up a supervised account.</div>
                    </div>
                    <button onclick="window.location.href='about:blank'" style="padding:14px 32px;border-radius:25px;border:1px solid #444;background:#111;color:#888;font-size:14px;cursor:pointer">Exit</button>
                ` : S.ageInput ? `
                    <button onclick="proceedFromAge()" style="padding:14px 32px;border-radius:25px;border:none;background:#fff;color:#000;font-size:16px;font-weight:700;cursor:pointer">Continue </button>
                ` : ''}
            </div>
        `;
    }
    
    function renderParentalStep() {
        return `
            <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px">
                <div style="font-size:48px;margin-bottom:16px"></div>
                <div style="font-size:20px;color:#fff;font-weight:700;margin-bottom:8px">Parental Consent Required</div>
                <div style="font-size:14px;color:#888;margin-bottom:24px;text-align:center;max-width:320px">
                    This platform allows public creative publishing. A parent or legal guardian must approve your account.
                </div>
                
                <div style="background:#111;border:1px solid #333;border-radius:12px;padding:16px;max-width:360px;margin-bottom:24px">
                    <div style="font-size:12px;color:#fff;font-weight:600;margin-bottom:8px"> Parent/Guardian Agreement</div>
                    <div style="font-size:11px;color:#888;line-height:1.6">
                        By proceeding, a parent or legal guardian confirms they have reviewed the Terms of Service and Privacy Policy, and grants permission for this minor to use PSCoMiXX including the promotional license for created content.
                    </div>
                </div>
                
                <div style="display:flex;gap:12px;align-items:center;margin-bottom:24px">
                    <input type="checkbox" id="parentConsent" onchange="S.parentalConsent=this.checked;render()" style="width:20px;height:20px;accent-color:#fff">
                    <label for="parentConsent" style="font-size:13px;color:#fff">I am the parent/guardian and I approve</label>
                </div>
                
                <div style="display:flex;gap:12px">
                    <button onclick="S.legalStep='age';render()" style="padding:14px 24px;border-radius:25px;border:1px solid #444;background:transparent;color:#888;font-size:14px;cursor:pointer"> Back</button>
                    <button onclick="proceedFromParental()" ${!S.parentalConsent?'disabled':''} style="padding:14px 32px;border-radius:25px;border:none;background:${S.parentalConsent?'#fff':'#333'};color:${S.parentalConsent?'#000':'#666'};font-size:16px;font-weight:700;cursor:${S.parentalConsent?'pointer':'not-allowed'}">Continue </button>
                </div>
            </div>
        `;
    }
    
    function renderTermsStep() {
        return `
            <div style="flex:1;display:flex;flex-direction:column;padding:16px;overflow:hidden">
                <div style="font-size:16px;color:#fff;font-weight:700;margin-bottom:12px;text-align:center"> User Agreement & Platform License</div>
                
                <div id="termsScroll" onscroll="checkTermsScroll()" style="flex:1;background:#111;border:1px solid #333;border-radius:12px;padding:16px;overflow-y:auto;font-size:11px;color:#aaa;line-height:1.7;margin-bottom:16px">
                    ${getTermsContent()}
                </div>
                
                <div style="text-align:center;margin-bottom:12px">
                    ${S.legalScrolled ? 
                        `<span style="color:#fff;font-size:12px"> Agreement reviewed</span>` : 
                        `<span style="color:#888;font-size:12px"> Please scroll to read the full agreement</span>`
                    }
                </div>
                
                <div style="display:flex;gap:12px;justify-content:center">
                    <button onclick="declineLegal()" style="padding:14px 24px;border-radius:25px;border:1px solid #666;background:transparent;color:#888;font-size:14px;cursor:pointer">Decline</button>
                    <button onclick="S.legalStep='toggles';render()" ${!S.legalScrolled?'disabled':''} style="padding:14px 32px;border-radius:25px;border:none;background:${S.legalScrolled?'#fff':'#333'};color:${S.legalScrolled?'#000':'#666'};font-size:16px;font-weight:700;cursor:${S.legalScrolled?'pointer':'not-allowed'}">Accept </button>
                </div>
            </div>
        `;
    }
    
    function renderTogglesStep() {
        return `
            <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px">
                <div style="font-size:48px;margin-bottom:16px"></div>
                <div style="font-size:20px;color:#fff;font-weight:700;margin-bottom:8px">Creator Feature Settings</div>
                <div style="font-size:13px;color:#888;margin-bottom:24px;text-align:center">Choose how your work can be featured</div>
                
                <div style="background:#111;border:1px solid #333;border-radius:12px;padding:16px;width:100%;max-width:360px;margin-bottom:24px">
                    <div style="display:flex;flex-direction:column;gap:16px">
                        <label style="display:flex;align-items:center;gap:12px;cursor:pointer">
                            <input type="checkbox" ${S.creatorToggles.socialMedia?'checked':''} onchange="S.creatorToggles.socialMedia=this.checked" style="width:20px;height:20px;accent-color:#fff">
                            <div>
                                <div style="font-size:13px;color:#fff">Feature on social media</div>
                                <div style="font-size:10px;color:#666">Your work may appear on our social channels</div>
                            </div>
                        </label>
                        <label style="display:flex;align-items:center;gap:12px;cursor:pointer">
                            <input type="checkbox" ${S.creatorToggles.promoAds?'checked':''} onchange="S.creatorToggles.promoAds=this.checked" style="width:20px;height:20px;accent-color:#fff">
                            <div>
                                <div style="font-size:13px;color:#fff">Feature in promotional ads</div>
                                <div style="font-size:10px;color:#666">Your work may appear in advertising</div>
                            </div>
                        </label>
                        <label style="display:flex;align-items:center;gap:12px;cursor:pointer">
                            <input type="checkbox" ${S.creatorToggles.festival?'checked':''} onchange="S.creatorToggles.festival=this.checked" style="width:20px;height:20px;accent-color:#fff">
                            <div>
                                <div style="font-size:13px;color:#fff">Feature in Press Play Festival</div>
                                <div style="font-size:10px;color:#666">Your work may be showcased at events</div>
                            </div>
                        </label>
                        <label style="display:flex;align-items:center;gap:12px;cursor:pointer">
                            <input type="checkbox" ${S.creatorToggles.sponsors?'checked':''} onchange="S.creatorToggles.sponsors=this.checked" style="width:20px;height:20px;accent-color:#fff">
                            <div>
                                <div style="font-size:13px;color:#fff">Feature for sponsors & partners</div>
                                <div style="font-size:10px;color:#666">Your work may be shown to partners</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <button onclick="completeLegalAcceptance()" style="padding:16px 48px;border-radius:30px;border:none;background:#fff;color:#000;font-size:18px;font-weight:700;cursor:pointer">
                     START CREATING
                </button>
                
                <div style="font-size:10px;color:#666;margin-top:16px;text-align:center;max-width:300px">
                    By tapping START CREATING, you confirm that you have read, understood, and agreed to the PSCoMiXX User Agreement, Promotional License, Privacy Policy, and Community Guidelines.
                </div>
            </div>
        `;
    }
    
    function getTermsContent() {
        return `
            <h3 style="color:#fff;margin:0 0 12px 0;font-size:14px">PSCoMiXX / MADMixedMEDIA / PRESS START</h3>
            <h4 style="color:#ccc;margin:0 0 16px 0;font-size:13px">MASTER USER AGREEMENT & PLATFORM LICENSE</h4>
            
            <p style="color:#666;font-size:10px;margin-bottom:16px">Last Updated: ${new Date().toLocaleDateString()}</p>
            
            <p>By accessing or using PSCoMiXX and all affiliated applications, websites, tools, and services ("Platform"), operated by MADMixedMEDIA LLC and Press Start ("Company," "we," "our," or "us"), you agree to the following legally binding terms.</p>
            
            <p><strong style="color:#fff">If you do not agree, do not access or use the Platform.</strong></p>
            
            <h4 style="color:#fff;margin:16px 0 8px 0"> 1. AGE & ELIGIBILITY</h4>
            <ul style="margin:0 0 12px 16px;padding:0">
                <li>Minimum age: 13 years old</li>
                <li>Users under 18 require parent/guardian consent</li>
                <li>School accounts require district and teacher approval</li>
                <li>You affirm all information you provide is true and accurate</li>
            </ul>
            
            <h4 style="color:#fff;margin:16px 0 8px 0"> 2. ACCOUNTS & SECURITY</h4>
            <ul style="margin:0 0 12px 16px;padding:0">
                <li>You are responsible for all activity on your account</li>
                <li>Sharing login credentials is prohibited</li>
                <li>We may suspend accounts suspected of fraud or abuse</li>
            </ul>
            
            <h4 style="color:#fff;margin:16px 0 8px 0"> 3. USER CONTENT OWNERSHIP</h4>
            <p>You retain full legal ownership of all original content you create and upload, including comics, cards, characters, stories, animations, visual novels, and AI-assisted creations.</p>
            
            <h4 style="color:#fff;margin:16px 0 8px 0"> 4. GLOBAL PROMOTIONAL LICENSE</h4>
            <p>By uploading any content to the Platform, you irrevocably grant MADMixedMEDIA LLC, Press Start, and all affiliates a:</p>
            <p><strong style="color:#fff">Perpetual, worldwide, non-exclusive, royalty-free, sublicensable, transferable license</strong> to host, store, reproduce, modify, adapt, display, perform, publish, promote, advertise, market, broadcast, distribute, syndicate, and create excerpts, previews, trailers, and derivatives across ALL media formats now known or later developed.</p>
            
            <p>This includes: Mobile apps, websites, social media, paid advertising, print, app stores, press, film/TV, educational curriculum, investor materials, live events, festivals, and exhibitions.</p>
            
            <p>You waive any right to compensation, royalties, approval, prior notice, or attribution (unless separately agreed).</p>
            
            <p style="color:#fff"> This license survives account deletion<br>
             This license applies to free and paid users<br>
             This license covers viral distribution and resharing</p>
            
            <h4 style="color:#fff;margin:16px 0 8px 0"> 5. AI CONTENT DISCLOSURE</h4>
            <p>You acknowledge that the Platform uses AI-generated and AI-assisted tools. AI outputs may not be 100% original, similar results may be generated for other users, and you assume full responsibility for publishing AI-generated material. The Company holds no liability for AI copyright disputes.</p>
            
            <h4 style="color:#fff;margin:16px 0 8px 0"> 6. MONETIZATION & MARKETPLACE</h4>
            <p>You may be eligible to sell digital content, offer prints, license characters, and participate in creator programs. You are solely responsible for all tax obligations. Platform fees may apply. No guaranteed revenue is promised.</p>
            
            <h4 style="color:#fff;margin:16px 0 8px 0"> 7. EDUCATIONAL USE</h4>
            <p>When used in schools: Teachers manage student access, parents grant consent, and all student content remains promotable under Section 4. FERPA and COPPA standards are aligned with Platform policies.</p>
            
            <h4 style="color:#fff;margin:16px 0 8px 0"> 8. PROHIBITED CONTENT</h4>
            <p>Absolutely prohibited: Child sexual content or exploitation, hate speech, terrorism promotion, extreme violence, non-consensual deepfakes, copyright/trademark infringement, malware, explicit sexual content involving minors.</p>
            <p style="color:#fff"><strong>Violations = Immediate termination + possible law enforcement referral</strong></p>
            
            <h4 style="color:#fff;margin:16px 0 8px 0"> 9. TERMINATION & REMOVAL</h4>
            <p>We may remove any content at our discretion, suspend or ban accounts for violations, and cooperate with law enforcement. Users may delete accounts at any time.</p>
            
            <h4 style="color:#fff;margin:16px 0 8px 0"> 10. LIMITATION OF LIABILITY</h4>
            <p>The Platform is provided "AS IS" and "AS AVAILABLE." We are not liable for lost profits, data loss, platform downtime, third-party integrations, user disputes, AI errors, or copyright claims between users. Your use is at your sole risk.</p>
            
            <h4 style="color:#fff;margin:16px 0 8px 0"> 11. INDEMNIFICATION</h4>
            <p>You agree to defend, indemnify, and hold harmless the Company from any claims arising from your content, your use of the Platform, or your violation of any law or rights.</p>
            
            <h4 style="color:#fff;margin:16px 0 8px 0"> 12. GOVERNING LAW</h4>
            <p>These Terms are governed by the laws of the State of California, USA.</p>
            
            <h4 style="color:#fff;margin:16px 0 8px 0"> PRIVACY POLICY</h4>
            <p>We collect account info, content uploads, device data, and usage analytics. We do NOT sell personal data. Data is used for platform operations, security, user experience, and legal compliance.</p>
            
            <h4 style="color:#fff;margin:16px 0 8px 0"> COMMUNITY CODE OF CONDUCT</h4>
            <p>By using PSCoMiXX, you agree to: Respect creators, no plagiarism, no hate or harassment, no impersonation, no scams, no copyright theft. Violations may result in content removal, account termination, and legal consequences.</p>
            
            <div style="background:#222;border:1px solid #444;border-radius:8px;padding:12px;margin-top:20px">
                <p style="margin:0;color:#fff;font-weight:600;text-align:center">END OF AGREEMENT</p>
            </div>
        `;
    }
    
    function setAgeGroup(age) {
        S.ageInput = age;
        render();
    }
    
    function proceedFromAge() {
        localStorage.setItem('pscomixx_user_age', S.ageInput);
        localStorage.setItem('pscomixx_school_account', S.isSchoolAccount);
        
        if (S.ageInput === '13-17') {
            S.legalStep = 'parental';
        } else {
            S.legalStep = 'terms';
        }
        render();
    }
    
    function proceedFromParental() {
        if (S.parentalConsent) {
            localStorage.setItem('pscomixx_parental_consent', 'true');
            S.legalStep = 'terms';
            render();
        }
    }
    
    function checkTermsScroll() {
        const el = document.getElementById('termsScroll');
        if (el) {
            const scrolledToBottom = el.scrollHeight - el.scrollTop <= el.clientHeight + 50;
            if (scrolledToBottom && !S.legalScrolled) {
                S.legalScrolled = true;
                render();
            }
        }
    }
    
    function declineLegal() {
        if (confirm('Are you sure you want to decline? You will not be able to use PSCoMiXX.')) {
            window.location.href = 'about:blank';
        }
    }
    
    function completeLegalAcceptance() {
        const timestamp = new Date().toISOString();
        
        // Save all consent data
        localStorage.setItem('pscomixx_legal_accepted', 'true');
        localStorage.setItem('pscomixx_legal_timestamp', timestamp);
        localStorage.setItem('pscomixx_creator_toggles', JSON.stringify(S.creatorToggles));
        
        // Update state
        S.legalAccepted = true;
        S.legalAcceptedAt = timestamp;
        
        // Log consent (in production, send to server)
        console.log('Legal consent recorded:', {
            timestamp,
            age: S.ageInput,
            parentalConsent: S.parentalConsent,
            isSchoolAccount: S.isSchoolAccount,
            creatorToggles: S.creatorToggles
        });
        
        toast('Welcome to PSCoMiXX! ');
        render();
    }
    
    // Reset legal acceptance (for testing)
    function resetLegalAcceptance() {
        localStorage.removeItem('pscomixx_legal_accepted');
        localStorage.removeItem('pscomixx_legal_timestamp');
        localStorage.removeItem('pscomixx_user_age');
        localStorage.removeItem('pscomixx_parental_consent');
        localStorage.removeItem('pscomixx_school_account');
        localStorage.removeItem('pscomixx_creator_toggles');
        S.legalAccepted = false;
        S.legalStep = 'age';
        S.ageInput = '';
        S.parentalConsent = false;
        S.legalScrolled = false;
        render();
    }

    // Render while preserving scroll position (for card editor clicks)
    function renderPreserveScroll() {
        // Find any scrollable container
        const cardBuilder = document.querySelector('.card-builder');
        const scrollPos = cardBuilder ? cardBuilder.scrollTop : 0;
        const sheetBody = document.querySelector('.sheet-body');
        const sheetScroll = sheetBody ? sheetBody.scrollTop : 0;
        
        render();
        
        // Restore scroll after render
        requestAnimationFrame(() => {
            const newCardBuilder = document.querySelector('.card-builder');
            if (newCardBuilder && scrollPos) {
                newCardBuilder.scrollTop = scrollPos;
            }
            const newSheetBody = document.querySelector('.sheet-body');
            if (newSheetBody && sheetScroll) {
                newSheetBody.scrollTop = sheetScroll;
            }
        });
    }

    // Render debouncing for performance
    let renderTimeout = null;
    let lastRenderTime = 0;
    const MIN_RENDER_INTERVAL = 16; // ~60fps max
    
    function render() {
        // Debounce rapid render calls
        const now = Date.now();
        if (now - lastRenderTime < MIN_RENDER_INTERVAL) {
            if (renderTimeout) clearTimeout(renderTimeout);
            renderTimeout = setTimeout(render, MIN_RENDER_INTERVAL);
            return;
        }
        lastRenderTime = now;
        
        try {
            const app = document.getElementById('app');
            if (!app) return;
            
            // LEGAL GATE - Check localStorage directly (HTML gates already handled)
            const legalFull = localStorage.getItem('pscomixx_legal_full_accepted');
            const legalBasic = localStorage.getItem('pscomixx_legal_accepted');
            const legalPassed = legalFull === 'true' || legalBasic === 'true';
            
            if (!legalPassed) {
                app.innerHTML = '<div style="color:#fff;padding:40px;text-align:center">Please accept the terms to continue. <button onclick="location.reload()" style="padding:10px 20px;margin-top:20px">Reload</button></div>';
                return;
            }
            
            // Update S if needed
            S.legalAccepted = true;
            
            const page = getPage();

        if (S.loading) {
            app.innerHTML = `<div class="loading"><div class="spinner"></div><div class="loading-text">SAVING...</div></div>`;
            return;
        }

        app.innerHTML = `
            <!-- STUDIO BACKGROUND -->
            <div class="space-bg" style="background:var(--studio-bg)">
                <div class="stars" style="opacity:0.3"></div>
            </div>
            
            <!-- SIDEBAR OVERLAY (Mobile) -->
            <div class="sidebar-overlay ${S.sidebarOpen ? 'show' : ''}" onclick="S.sidebarOpen=false;render()"></div>
            
            <!-- SIDEBAR TOGGLE (Mobile) -->
            <div class="sidebar-toggle ${S.sidebarOpen ? 'active' : ''}" onclick="S.sidebarOpen=!S.sidebarOpen;render()">
                ${S.sidebarOpen ? icon('x', 20) : icon('menu', 20)}
            </div>
            
            <!-- LEFT SIDEBAR -->
            <div class="sidebar ${S.sidebarOpen ? 'open' : ''}">
                <div class="sidebar-header">
                    <svg class="sidebar-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40" width="40" height="40"><rect fill="#111" width="40" height="40" rx="8"/><text x="20" y="26" text-anchor="middle" fill="#fff" font-size="16" font-weight="bold">PS</text></svg>
                    <div class="sidebar-brand">CREATOR<span>STUDIO</span></div>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-section-title">CREATOR TOOLS</div>
                    <div class="sidebar-item neon ${S.activeTab === 'comic' ? 'active' : ''}" onclick="S.activeTab='comic';S.sidebarOpen=false;render()" title="Create comic pages with panels, bubbles and effects">
                        ${icon('grid', 16)} Comic Builder
                    </div>
                    <div class="sidebar-item neon ${S.activeTab === 'card' ? 'active' : ''}" onclick="S.activeTab='card';S.sidebarOpen=false;render()" title="Design trading cards with stats and abilities">
                        ${icon('star', 16)} Card Creator
                    </div>
                    <div class="sidebar-item neon ${S.activeTab === 'cover' ? 'active' : ''}" onclick="S.activeTab='cover';S.sidebarOpen=false;render()" title="Design professional comic book covers">
                        ${icon('book', 16)} Cover Architect
                    </div>
                    <div class="sidebar-item neon ${S.activeTab === 'share' ? 'active' : ''}" onclick="S.activeTab='share';S.sidebarOpen=false;render()" title="Export your work as images, PDF, or video">
                        ${icon('share', 16)} Share & Export
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-section-title">BATTLE & COLLECT</div>
                    <div class="sidebar-item neon" onclick="S.activeSheet='battle-modes';S.sidebarOpen=false;render()" title="Play card games and visual novel battles">
                        ${icon('zap', 16)} Battle Modes
                    </div>
                    <div class="sidebar-item neon" onclick="S.activeSheet='collection';S.sidebarOpen=false;render()" title="View all your saved comics and cards">
                        ${icon('folder', 16)} My Collection
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-section-title"> COLLABORATE</div>
                    <div class="sidebar-item neon" onclick="S.activeSheet='collab';S.sidebarOpen=false;render()" title="Create comics together in real-time">
                        ${icon('users', 16)} Start/Join Collab
                    </div>
                    <div class="sidebar-item neon" onclick="S.activeSheet='social-feed';S.sidebarOpen=false;render()" title="Share and discover comics from the community">
                        ${icon('grid', 16)}  Community Feed
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-section-title">AI TOOLS</div>
                    <div class="sidebar-item neon" onclick="showImageOptions('panel',S.selectedPanel||0);S.sidebarOpen=false" title="Generate images with AI">
                        ${icon('sparkles', 16)} AI Image Gen
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-section-title">ACCOUNT</div>
                    <div class="sidebar-item neon" onclick="S.activeSheet='profile';S.sidebarOpen=false;render()" title="Manage your profile and sign in">
                        ${icon('user', 16)} Profile
                    </div>
                </div>
                
                <div class="sidebar-section" style="border-top:1px solid var(--studio-border);padding-top:12px">
                    <div class="sidebar-item neon" onclick="toggleLightMode()" title="Switch between light and dark theme">
                        ${S.lightMode ? icon('moon', 16) : icon('sun', 16)} ${S.lightMode ? 'Dark Mode' : 'Light Mode'}
                    </div>
                    
                    <!-- Upgrade Button for Free Users -->
                    ${!isPremium() && S.adminConfig.showUpgradePrompts ? `
                    <div class="sidebar-item" onclick="S.activeSheet='pricing';S.sidebarOpen=false;render()" style="background:linear-gradient(90deg,rgba(139,92,246,0.2),transparent);border:1px solid rgba(139,92,246,0.3);margin-top:8px">
                        <span style="font-size:16px"></span>
                        <span style="color:#8b5cf6;font-weight:bold">Upgrade to Pro</span>
                    </div>` : ''}
                </div>
                
                <div class="sidebar-footer">
                    <div class="sidebar-user" onclick="S.activeSheet='profile';S.sidebarOpen=false;render()">
                        ${S.isSignedIn && S.playerPhoto ? 
                            `<img src="${S.playerPhoto}" class="sidebar-avatar">` : 
                            `<div class="sidebar-avatar-placeholder">${S.isSignedIn ? (S.playerName || 'U')[0].toUpperCase() : '?'}</div>`
                        }
                        <div class="sidebar-user-info">
                            <div class="sidebar-user-name">${S.isSignedIn ? (S.playerName || 'Creator') : 'Sign In'}${renderPremiumBadge(getUserTier())}</div>
                            <div class="sidebar-user-email">${S.isSignedIn ? (S.playerEmail || 'creator@ps.com').substring(0, 20) : 'Get started'}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- MAIN STUDIO AREA -->
            <div class="studio-main">
                <!-- TOP HEADER -->
                <div class="header">
                    <div class="header-left">
                        <button class="header-back" onclick="history.back()" style="margin-left:${window.innerWidth < 1024 ? '50px' : '0'}">${icon('arrow-left', 16)}</button>
                        <div class="header-title">
                            <div class="header-title-main">${S.comicTitle || 'Untitled Comic'}</div>
                            <div class="header-title-sub">${S.activeTab === 'card' ? 'Card Creator' : S.activeTab === 'cover' ? 'Cover Architect' : S.activeTab === 'share' ? 'Share & Export' : 'Comic Creator'}</div>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="header-btn header-btn-ghost neon" onclick="S.activeSheet='bubbles';render()" title="Bubbles">${icon('message-circle', 14)}</button>
                        <button class="header-btn header-btn-ghost neon" onclick="S.activeSheet='effects';render()" title="Effects">${icon('zap', 14)}</button>
                        <button class="header-btn header-btn-ghost neon" onclick="S.activeSheet='emoji';render()" title="Stickers">${icon('smile', 14)}</button>
                        <button class="header-btn header-btn-ghost neon" onclick="S.activeSheet='templates';render()">${icon('grid', 14)} <span class="hide-mobile">Templates</span></button>
                        <button class="header-btn header-btn-ghost neon" onclick="saveComic()">${icon('save', 14)} <span class="hide-mobile">Save</span></button>
                        <button class="header-btn header-btn-ghost neon" onclick="enterPreviewMode()">${icon('play', 14)} <span class="hide-mobile">Preview</span></button>
                        <button class="header-btn header-btn-primary" onclick="S.activeSheet='share-options';render()">${icon('download', 14)} Export</button>
                    </div>
                </div>
                
                <!-- WORKSPACE -->
                <div class="workspace">
                    <!-- TOOL STRIP -->
                    <div class="tool-strip">
                        <button class="tool-strip-btn neon active" title="Select">${icon('mouse-pointer', 18)}</button>
                        <button class="tool-strip-btn neon" title="Move">${icon('move', 18)}</button>
                        <div class="tool-strip-divider"></div>
                        <button class="tool-strip-btn neon" onclick="S.activeSheet='templates';render()" title="Panels">${icon('layout', 18)}</button>
                        <button class="tool-strip-btn neon" onclick="enterFullPageDrawMode()" title="Draw">${icon('pencil', 18)}</button>
                        <button class="tool-strip-btn neon" title="Eraser">${icon('eraser', 18)}</button>
                        <div class="tool-strip-divider"></div>
                        <button class="tool-strip-btn neon" onclick="S.activeSheet='bubbles';render()" title="Text">${icon('type', 18)}</button>
                        <button class="tool-strip-btn neon" onclick="S.activeSheet='bubbles';render()" title="Bubbles">${icon('message-circle', 18)}</button>
                        <button class="tool-strip-btn neon" onclick="showImageOptions('panel',S.selectedPanel||0)" title="Images">${icon('image', 18)}</button>
                        <button class="tool-strip-btn neon" onclick="S.activeSheet='effects';render()" title="Effects">${icon('sparkles', 18)}</button>
                        <div class="tool-strip-divider"></div>
                        <button class="tool-strip-btn neon" onclick="S.activeSheet='emoji';render()" title="Stickers">${icon('smile', 18)}</button>
                    </div>
                    
                    <!-- CANVAS CONTAINER -->
                    <div class="canvas-container">
                        <!-- SPREAD NAV -->
                        <div class="spread-nav">
                            <button class="spread-nav-btn" onclick="if(S.currentPage>0){S.currentPage--;render()}">${icon('chevron-left', 14)}</button>
                            <span class="spread-nav-text">Page ${S.currentPage + 1} of ${S.pages.length}</span>
                            <button class="spread-nav-btn" onclick="if(S.currentPage<S.pages.length-1){S.currentPage++;render()}">${icon('chevron-right', 14)}</button>
                            <div class="zoom-controls">
                                <button class="zoom-btn"></button>
                                <span class="zoom-level">100%</span>
                                <button class="zoom-btn">+</button>
                            </div>
                        </div>
                        
                        <!-- CANVAS AREA -->
                        <div class="canvas-area" onclick="clearSelection()">
                            <div class="canvas canvas-comic">
                                ${(page.panels || []).map((p, i) => {
                                    try {
                                        const media = page.panelMedia ? page.panelMedia[i] : null;
                                        // Full transform for both mobile and desktop - gestures update DOM directly
                                        const imgTransform = media ? 
                                            `transform: scale(${media.scale || 1}) rotate(${media.rotation || 0}deg) translate(${media.offsetX || 0}%, ${media.offsetY || 0}%);` : '';
                                        const mediaContent = media && media.src ? (media.isVideo ? 
                                            `<video class="panel-media" src="${media.src}" style="${imgTransform}" autoplay loop muted playsinline></video>` :
                                            `<img class="panel-media" src="${media.src}" style="${imgTransform}">`) : 
                                            `<div class="panel-placeholder">
                                                <div class="panel-placeholder-icon">+</div>
                                                <div class="panel-placeholder-text">Tap to add</div>
                                            </div>`;
                                        // Add touch handlers to panel-content ONLY if media exists
                                        const touchHandlers = media && media.src ? `ontouchstart="startPanelDrag(event,${i})" onmousedown="startPanelDrag(event,${i})"` : '';
                                        return `<div class="panel ${S.selectedPanel === i ? 'selected' : ''}" 
                                            style="left:${p.x}%;top:${p.y}%;width:${p.w}%;height:${p.h}%" 
                                            onclick="selectPanel(${i},event)">
                                            <div class="panel-content" style="width:100%;height:100%;overflow:hidden;position:relative" ${touchHandlers}>
                                                ${mediaContent}
                                            </div>
                                            ${S.selectedPanel === i ? `
                                                <!-- PS Express handles for selected panels -->
                                                <div class="ps-handle corner nw" onmousedown="startPanelScale(event,${i},'nw')" ontouchstart="startPanelScale(event,${i},'nw')"></div>
                                                <div class="ps-handle corner ne" onmousedown="startPanelScale(event,${i},'ne')" ontouchstart="startPanelScale(event,${i},'ne')"></div>
                                                <div class="ps-handle corner sw" onmousedown="startPanelScale(event,${i},'sw')" ontouchstart="startPanelScale(event,${i},'sw')"></div>
                                                <div class="ps-handle corner se" onmousedown="startPanelScale(event,${i},'se')" ontouchstart="startPanelScale(event,${i},'se')"></div>
                                                <div class="ps-handle edge horizontal top" onmousedown="startPanelScale(event,${i},'top')" ontouchstart="startPanelScale(event,${i},'top')"></div>
                                                <div class="ps-handle edge horizontal bottom" onmousedown="startPanelScale(event,${i},'bottom')" ontouchstart="startPanelScale(event,${i},'bottom')"></div>
                                                <div class="ps-handle edge vertical left" onmousedown="startPanelScale(event,${i},'left')" ontouchstart="startPanelScale(event,${i},'left')"></div>
                                                <div class="ps-handle edge vertical right" onmousedown="startPanelScale(event,${i},'right')" ontouchstart="startPanelScale(event,${i},'right')"></div>
                                            ` : ''}
                                        </div>`;
                                    } catch(e) { return ''; }
                                }).join('')}
                                ${page.drawingData ? `<img src="${page.drawingData}" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;mix-blend-mode:multiply">` : ''}
                                ${page.pageElements.map(el => `
                                    <div class="element ${S.selectedElement === el.id ? 'selected' : ''}" 
                                        data-elid="${el.id}"
                                        style="left:${el.x}%;top:${el.y}%;transform:translate(-50%,-50%) rotate(${el.rotation || 0}deg) scale(${el.scaleX || el.scale || 1}, ${el.scaleY || el.scale || 1})" 
                                        onmousedown="startDrag(event,${el.id})"
                                        ontouchstart="startDrag(event,${el.id})">
                                        ${renderEl(el)}
                                        <!-- Photoshop Express exact-style handles -->
                                        <div class="ps-handle corner nw" onmousedown="startElScale(event,${el.id},'nw')" ontouchstart="startElScale(event,${el.id},'nw')"></div>
                                        <div class="ps-handle corner ne" onmousedown="startElScale(event,${el.id},'ne')" ontouchstart="startElScale(event,${el.id},'ne')"></div>
                                        <div class="ps-handle corner sw" onmousedown="startElScale(event,${el.id},'sw')" ontouchstart="startElScale(event,${el.id},'sw')"></div>
                                        <div class="ps-handle corner se" onmousedown="startElScale(event,${el.id},'se')" ontouchstart="startElScale(event,${el.id},'se')"></div>
                                        <div class="ps-handle edge horizontal top" onmousedown="startElScale(event,${el.id},'top')" ontouchstart="startElScale(event,${el.id},'top')"></div>
                                        <div class="ps-handle edge horizontal bottom" onmousedown="startElScale(event,${el.id},'bottom')" ontouchstart="startElScale(event,${el.id},'bottom')"></div>
                                        <div class="ps-handle edge vertical left" onmousedown="startElScale(event,${el.id},'left')" ontouchstart="startElScale(event,${el.id},'left')"></div>
                                        <div class="ps-handle edge vertical right" onmousedown="startElScale(event,${el.id},'right')" ontouchstart="startElScale(event,${el.id},'right')"></div>
                                        <div class="edit-btn" ontouchend="event.preventDefault();event.stopPropagation();handleEdit(event,${el.id})" onclick="event.stopPropagation();handleEdit(event,${el.id})">${icon('edit', 12)}</div>
                                        <div class="delete-btn" ontouchend="event.preventDefault();event.stopPropagation();handleDelete(event,${el.id})" onclick="event.stopPropagation();handleDelete(event,${el.id})">${icon('x', 12)}</div>
                                    </div>`).join('')}
                            </div>
                            <!-- Action panel removed - using transform frame instead -->
                        </div>
                        
                        <!-- MOBILE TOOLBAR -->
                        <div class="mobile-toolbar">
                            <button class="tool-btn neon" onclick="S.activeSheet='templates';render()" title="Choose panel layout">${icon('grid', 18)}<span>Layout</span></button>
                            <button class="tool-btn neon" onclick="S.activeSheet='bubbles';render()" title="Add speech/thought bubble">${icon('message-circle', 18)}<span>Bubble</span></button>
                            <button class="tool-btn neon" onclick="S.activeSheet='effects';render()" title="Add sound effects">${icon('zap', 18)}<span>FX</span></button>
                            <button class="tool-btn neon" onclick="S.activeSheet='emoji';render()" title="Add stickers and emoji">${icon('smile', 18)}<span>Emoji</span></button>
                            <button class="tool-btn neon" onclick="enterFullPageDrawMode()" title="Draw on the page">${icon('pencil', 18)}<span>Draw</span></button>
                            <button class="tool-btn neon" onclick="S.activeSheet='collab';render()" title="Real-time collaboration" style="background:#111;border-color:#555">${icon('users', 18)}<span>Collab</span></button>
                            <button class="tool-btn save-btn" onclick="saveToPhotos('comic')" title="Save to camera roll">${icon('save', 18)}<span>Save</span></button>
                        </div>
                        
                        <!-- SPREAD BAR -->
                        <div class="spread-bar">
                            <button class="spread-btn" onclick="addPage()" title="Add a new page">+ Add Page</button>
                            <button class="spread-btn" onclick="enterPreviewMode()" title="View fullscreen">${icon('maximize', 14)} Full Screen</button>
                        </div>
                        
                        ${S.collabSession ? `
                        <!-- FLOATING COLLAB STATUS BAR -->
                        <div class="floating-collab-bar" style="position:fixed;top:55px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:6px;padding:6px 14px;background:#000;border:2px solid #22c55e;border-radius:50px;z-index:250;box-shadow:0 4px 20px rgba(34,197,94,0.3);max-width:90vw">
                            <div style="width:6px;height:6px;background:#22c55e;border-radius:50%;animation:pulse 2s infinite;flex-shrink:0"></div>
                            <span style="color:#22c55e;font-size:10px;font-weight:bold;white-space:nowrap" title="Your work syncs automatically">SYNC</span>
                            <span style="color:#888;font-size:10px;white-space:nowrap" title="Share this code">${S.collabSession.code}</span>
                            <span style="color:#888;font-size:10px;white-space:nowrap" title="Collaborators">${S.collabParticipants.length}</span>
                            <span style="color:#888;font-size:10px;white-space:nowrap" title="Pages created">${S.collabPages.length}</span>
                            <button onclick="finishCollabPage()" style="padding:4px 8px;background:#fff;color:#000;border:none;border-radius:12px;font-size:9px;font-weight:bold;cursor:pointer;white-space:nowrap;flex-shrink:0" title="Finish this page and start a new one"> DONE</button>
                            <button onclick="S.activeSheet='collab';render()" style="padding:4px 6px;background:#222;color:#fff;border:none;border-radius:12px;font-size:11px;cursor:pointer;flex-shrink:0" title="Collab settings"></button>
                        </div>
                        <style>
                            @keyframes pulse {
                                0%, 100% { opacity: 1; }
                                50% { opacity: 0.4; }
                            }
                        </style>
                        ` : ''}
                        
                        <!-- FLOATING ADD ELEMENTS BAR -->
                        <div class="floating-elements-bar" style="position:fixed;bottom:90px;left:50%;transform:translateX(-50%);display:flex;gap:6px;padding:10px 14px;background:rgba(10,10,18,0.95);border:1px solid rgba(0,255,255,0.3);border-radius:50px;z-index:150;box-shadow:0 4px 20px rgba(0,0,0,0.5),0 0 30px rgba(0,255,255,0.1);max-width:95vw">
                            <button class="neon-fab" onclick="S.activeSheet='bubbles';render()" title="Add Speech Bubble" data-tooltip="Speech Bubble"></button>
                            <button class="neon-fab" onclick="S.activeSheet='effects';render()" title="Add Sound Effect" data-tooltip="Sound Effect"></button>
                            <button class="neon-fab" onclick="S.activeSheet='emoji';render()" title="Add Sticker/Emoji" data-tooltip="Stickers"></button>
                            <button class="neon-fab" onclick="enterFullPageDrawMode()" title="Draw on Page" data-tooltip="Draw"></button>
                            <button class="neon-fab magenta" onclick="S.activeSheet='collab';render()" title="Real-time Collaboration" data-tooltip="Collaborate"></button>
                            <div style="width:1px;height:30px;background:rgba(255,255,255,0.2);margin:0 4px"></div>
                            <button class="neon-fab post-fab" onclick="shareToFeed()" title="Post to Community Feed" data-tooltip="Post"></button>
                        </div>
                    </div>
                    
                    <!-- LAYERS PANEL -->
                    <div class="layers-panel">
                        <div class="layers-panel-header">
                            <span class="layers-panel-title">${icon('layers', 14)} Layers</span>
                            <button class="layers-panel-close">${icon('x', 14)}</button>
                        </div>
                        <div style="padding:12px;color:var(--studio-text-muted);font-size:12px">
                            ${page.panels.length} panels<br>
                            ${page.pageElements.length} elements
                        </div>
                    </div>
                </div>
            </div>
                
                <div class="tab-content ${S.activeTab === 'card' ? 'active' : ''}">
                    <!-- This just triggers the card forge overlay -->
                </div>
                
                ${S.activeTab === 'card' ? `
                <!-- CARD FORGE - Full Screen Overlay -->
                <div class="card-builder" style="background:var(--studio-bg)">
                    <div class="card-builder-bg" style="opacity:0.3"></div>
                    
                    <!-- Animated Grid -->
                    <div style="position:absolute;inset:0;background-image:linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);background-size:40px 40px;pointer-events:none"></div>
                    
                    <!-- Close Button -->
                    <button onclick="S.activeTab='comic';render()" style="position:fixed;top:max(20px, env(safe-area-inset-top, 20px));right:16px;width:44px;height:44px;border-radius:8px;border:1px solid var(--studio-border);background:var(--studio-sidebar);color:var(--studio-text);font-size:20px;cursor:pointer;z-index:9999;display:flex;align-items:center;justify-content:center">${icon('x', 20)}</button>
                    
                    <!-- Header -->
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;padding-top:max(16px, env(safe-area-inset-top, 16px));z-index:10;position:relative;border-bottom:1px solid var(--studio-border)">
                        <div style="display:flex;align-items:center;gap:12px">
                            <div style="width:40px;height:40px;background:var(--studio-accent);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;color:var(--studio-bg)">${icon('star', 20)}</div>
                            <div>
                                <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--studio-text);letter-spacing:2px">CARD FORGE</div>
                                <div style="font-size:10px;color:var(--studio-text-muted)">${S.card.rarity || 'LEGENDARY'} CARD</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Rarity Selector -->
                    <div style="display:flex;justify-content:center;gap:6px;padding:12px;z-index:10;position:relative;background:var(--studio-sidebar);border-bottom:1px solid var(--studio-border)">
                        ${['COMMON','UNCOMMON','RARE','EPIC','LEGENDARY','MYTHIC'].map((r,i) => `
                            <div onclick="setCardRarity('${r}')" style="width:36px;height:36px;border-radius:6px;background:${S.card.rarity===r || (!S.card.rarity && r==='LEGENDARY') ? 'var(--studio-accent)' : 'transparent'};border:1px solid var(--studio-border);cursor:pointer;display:flex;align-items:center;justify-content:center;color:${S.card.rarity===r || (!S.card.rarity && r==='LEGENDARY') ? 'var(--studio-bg)' : 'var(--studio-text-muted)'};font-size:11px;font-weight:700;transition:all 0.15s">${r[0]}</div>
                        `).join('')}
                    </div>
                    
                    <!-- Template Bar -->
                    <div style="display:flex;justify-content:flex-start;gap:6px;padding:12px;overflow-x:auto;z-index:10;position:relative;scrollbar-width:none;-webkit-overflow-scrolling:touch;background:var(--studio-sidebar)">
                        ${[
                            {id:'classic',icon:'',name:'Classic'},
                            {id:'sports',icon:'',name:'Sports'},
                            {id:'anime',icon:'',name:'Anime'},
                            {id:'pokemon',icon:'',name:'Monster'},
                            {id:'id-badge',icon:'',name:'ID Badge'},
                            {id:'retro',icon:'',name:'Retro'},
                            {id:'neon',icon:'',name:'Neon'},
                            {id:'tcg',icon:'',name:'TCG'},
                            {id:'premium',icon:'',name:'Premium'},
                            {id:'holo',icon:'',name:'Holo'},
                            {id:'minimal',icon:'',name:'Minimal'}
                        ].map(t => `
                            <button onclick="setCardTemplate('${t.id}')" style="padding:8px 14px;border-radius:6px;border:1px solid ${!S.card.template && t.id==='classic' || S.card.template===t.id ? 'var(--studio-accent)' : 'var(--studio-border)'};background:${!S.card.template && t.id==='classic' || S.card.template===t.id ? 'var(--studio-active)' : 'transparent'};color:var(--studio-text);font-size:11px;cursor:pointer;white-space:nowrap;font-weight:500;transition:all 0.15s">${t.icon} ${t.name}</button>
                        `).join('')}
                    </div>
                    
                    <!-- POINT POOL INDICATOR -->
                    <div style="display:flex;justify-content:center;padding:8px 12px;gap:16px;font-size:11px;border-bottom:1px solid var(--studio-border)">
                        <div style="display:flex;align-items:center;gap:6px">
                            <span style="color:var(--studio-text-muted)">RARITY:</span>
                            <span style="color:var(--studio-text);font-weight:700">${S.card.rarity || 'LEGENDARY'}</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:6px">
                            <span style="color:var(--studio-text-muted)">POINTS:</span>
                            <span style="color:var(--studio-text);font-weight:700">${getPointsUsed()}/${getPointPool()}</span>
                            ${getPointsRemaining()>0?`<span style="color:var(--studio-text-muted)">(+${getPointsRemaining()} left)</span>`:''}
                        </div>
                    </div>
                    
                    <!-- THE CARD - FILLS VIEWPORT -->
                    <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:8px;position:relative;z-index:10">
                        <div onclick="flipCard()" style="cursor:pointer;transition:transform 0.3s ease,opacity 0.3s ease;${S.cardFlipped?'transform:scale(0.95);opacity:0.9':''}">
                            
                            <!-- FRONT OF CARD - MAXIMUM SIZE -->
                            <div id="card-front-content" style="width:min(440px,95vw);height:min(620px,82vh);border-radius:${S.card.template==='retro'?'8px':S.card.template==='minimal'?'4px':'20px'};background:${S.card.template==='retro'?'linear-gradient(180deg,#f5e6d3,#e8d5b7)':S.card.template==='neon'?'linear-gradient(180deg,#0a0a1a,#1a0a2e)':S.card.template==='minimal'?'#fff':'linear-gradient(180deg,#1a1a2e,#0f0f1a)'};padding:${S.card.template==='retro'?'6px':'10px'};box-shadow:${S.card.template==='neon'?'0 0 80px #00ffff50, 0 0 150px #ff00ff40':'0 50px 120px rgba(0,0,0,0.8)'};backface-visibility:hidden;position:relative;border:${S.card.template==='retro'?'10px solid #8b4513':S.card.template==='neon'?'4px solid #00ffff':S.card.template==='tcg'?'6px solid '+(S.card.borderColor||'#ff6b35'):S.card.template==='minimal'?'4px solid #222':'none'}">
                                
                                ${S.card.template==='retro' ? `
                                <!-- RETRO/GPK STYLE -->
                                <div style="height:100%;display:flex;flex-direction:column;position:relative">
                                    <!-- Logo Area -->
                                    <div style="position:absolute;top:8px;left:8px;background:#8b0000;color:#ffd700;padding:4px 8px;font-size:10px;font-weight:700;border-radius:2px;z-index:10">PEEL HERE</div>
                                    <div style="position:absolute;top:8px;right:8px;background:#f5e6d3;color:#8b4513;padding:4px 10px;font-size:14px;font-weight:800;border-radius:2px;z-index:10">${S.card.cardNumber || '001a'}</div>
                                    
                                    <!-- Title Banner -->
                                    <div style="background:linear-gradient(180deg,#8b0000,#a52a2a);padding:12px 16px;text-align:center;margin-bottom:-2px">
                                        <div style="font-family:'Bangers',cursive;font-size:clamp(24px,7vw,36px);color:#ffd700;text-shadow:2px 2px 0 #000,-1px -1px 0 #000;letter-spacing:2px">${S.card.title || 'GARBAGE PAIL'}</div>
                                    </div>
                                    
                                    <!-- Image - FULL BLEED -->
                                    <div onclick="event.stopPropagation();triggerUpload('card-front')" style="flex:1;background:#d4c4a1;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;position:relative">
                                        ${S.card.frontImage ? 
                                            `<img src="${S.card.frontImage}" style="width:100%;height:100%;object-fit:cover">` : 
                                            `<div style="color:#8b4513;text-align:center">${icon('image',60)}<br><span style="font-size:14px">TAP FOR IMAGE</span></div>`
                                        }
                                    </div>
                                    
                                    <!-- Name Plate -->
                                    <div style="background:linear-gradient(180deg,#8b0000,#a52a2a);padding:14px;text-align:center">
                                        <div style="font-family:'Bangers',cursive;font-size:clamp(22px,6vw,32px);color:#ffd700;text-shadow:2px 2px 0 #000;text-transform:uppercase">${S.card.name || 'MUGGED MARCUS'}</div>
                                    </div>
                                    
                                    <!-- Footer -->
                                    <div style="background:#f5e6d3;padding:4px 10px;font-size:8px;color:#8b4513;text-align:center"> CARD FORGE  PRTD. IN U.S.A.</div>
                                </div>
                                
                                ` : S.card.template==='neon' ? `
                                <!-- NEON STYLE -->
                                <div style="height:100%;display:flex;flex-direction:column;position:relative;padding:8px">
                                    <!-- Glow Border Effect -->
                                    <div style="position:absolute;inset:-3px;border-radius:20px;background:linear-gradient(45deg,#00ffff,#ff00ff,#00ffff);opacity:0.6;filter:blur(8px);z-index:-1"></div>
                                    
                                    <!-- Top Bar -->
                                    <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px">
                                        <div style="font-family:'Bebas Neue',sans-serif;font-size:14px;color:#00ffff;letter-spacing:3px">NIGHT CLUB</div>
                                        <div style="font-size:10px;color:#ff00ff"></div>
                                    </div>
                                    
                                    <!-- Image - DOMINANT -->
                                    <div onclick="event.stopPropagation();triggerUpload('card-front')" style="flex:1;border-radius:16px;overflow:hidden;cursor:pointer;position:relative;margin:8px">
                                        ${S.card.frontImage ? 
                                            `<img src="${S.card.frontImage}" style="width:100%;height:100%;object-fit:cover">` : 
                                            `<div style="width:100%;height:100%;background:#1a0a2a;display:flex;align-items:center;justify-content:center;color:#00ffff">${icon('image',70)}</div>`
                                        }
                                        <!-- Neon Overlay -->
                                        <div style="position:absolute;inset:0;background:linear-gradient(180deg,transparent 60%,rgba(255,0,255,0.3) 100%);pointer-events:none"></div>
                                    </div>
                                    
                                    <!-- Name -->
                                    <div style="padding:16px 12px;text-align:left">
                                        <div style="font-family:'Bangers',cursive;font-size:clamp(28px,8vw,40px);color:#fff;text-shadow:0 0 20px #ff00ff,0 0 40px #00ffff">${S.card.name || 'DJ AMANDA'}</div>
                                        <div style="font-size:12px;color:#00ffff;margin-top:4px">@${S.card.handle || 'SOCIALMEDIA'}</div>
                                    </div>
                                </div>
                                
                                ` : S.card.template==='tcg' ? `
                                <!-- TCG GAME CARD STYLE -->
                                <div style="height:100%;border:4px solid #ff6b35;border-radius:14px;overflow:hidden;display:flex;flex-direction:column;background:#111">
                                    <!-- Header -->
                                    <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:linear-gradient(90deg,#ff6b35,#ff8c42)">
                                        <span style="font-family:'Bebas Neue',sans-serif;font-size:18px;color:#fff;letter-spacing:2px">${S.card.title || 'HERO'}</span>
                                        <span style="background:#fff;color:#ff6b35;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:800">${S.card.cardNumber || '001'}</span>
                                    </div>
                                    
                                    <!-- Image with Frame -->
                                    <div style="margin:10px;border-radius:10px;overflow:hidden;flex:1;border:3px solid #ff6b35" onclick="event.stopPropagation();triggerUpload('card-front')">
                                        ${S.card.frontImage ? 
                                            `<img src="${S.card.frontImage}" style="width:100%;height:100%;object-fit:cover">` : 
                                            `<div style="width:100%;height:100%;background:#1a1a2e;display:flex;align-items:center;justify-content:center;color:#ff6b35">${icon('image',60)}</div>`
                                        }
                                    </div>
                                    
                                    <!-- Name Bar -->
                                    <div style="background:#ff6b35;padding:10px 14px;margin:0 10px">
                                        <div style="font-family:'Bangers',cursive;font-size:clamp(20px,6vw,28px);color:#fff;text-align:center">${S.card.name || 'OOZER'}</div>
                                    </div>
                                    
                                    <!-- Stats -->
                                    <div style="padding:12px 14px;display:flex;gap:8px;margin:10px;background:#1a1a1a;border-radius:8px">
                                        <div style="flex:1;text-align:center">
                                            <div style="font-size:10px;color:#ff6b35">HP</div>
                                            <div style="height:8px;background:#333;border-radius:4px;margin:4px 0"><div style="height:100%;width:${S.card.stats?.pwr||85}%;background:#ff6b35;border-radius:4px"></div></div>
                                            <div style="font-size:16px;font-weight:800;color:#fff">${S.card.stats?.pwr||85}</div>
                                        </div>
                                        <div style="flex:1;text-align:center">
                                            <div style="font-size:10px;color:#fff">ATK</div>
                                            <div style="height:8px;background:#333;border-radius:4px;margin:4px 0"><div style="height:100%;width:${S.card.stats?.spd||70}%;background:#fff;border-radius:4px"></div></div>
                                            <div style="font-size:16px;font-weight:800;color:#fff">${S.card.stats?.spd||70}</div>
                                        </div>
                                        <div style="flex:1;text-align:center">
                                            <div style="font-size:10px;color:#ddd">DEF</div>
                                            <div style="height:8px;background:#333;border-radius:4px;margin:4px 0"><div style="height:100%;width:${S.card.stats?.int||90}%;background:#ddd;border-radius:4px"></div></div>
                                            <div style="font-size:16px;font-weight:800;color:#fff">${S.card.stats?.int||90}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                ` : S.card.template==='premium' ? `
                                <!-- PREMIUM/ICON STYLE -->
                                <div style="height:100%;display:flex;flex-direction:column;position:relative;background:linear-gradient(135deg,#1a0a1a,#0a1a2a);border-radius:16px;overflow:hidden">
                                    <!-- Top Brand -->
                                    <div style="display:flex;justify-content:space-between;padding:14px 18px">
                                        <div>
                                            <div style="font-size:10px;color:#e91e63;letter-spacing:3px">ICON</div>
                                            <div style="font-size:8px;color:#666">NOVELTY CARDS</div>
                                        </div>
                                        <div style="text-align:right">
                                            <div style="font-size:12px;color:#fff;font-weight:700">MCMLLC</div>
                                            <div style="font-size:10px;color:#666">20<br>25</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Full Image -->
                                    <div onclick="event.stopPropagation();triggerUpload('card-front')" style="flex:1;margin:0 14px;border-radius:12px;overflow:hidden;cursor:pointer;position:relative">
                                        ${S.card.frontImage ? 
                                            `<img src="${S.card.frontImage}" style="width:100%;height:100%;object-fit:cover">` : 
                                            `<div style="width:100%;height:100%;background:linear-gradient(135deg,#2a1a3a,#1a2a3a);display:flex;align-items:center;justify-content:center;color:#e91e63">${icon('image',70)}</div>`
                                        }
                                        <!-- Gradient Overlay -->
                                        <div style="position:absolute;bottom:0;left:0;right:0;height:50%;background:linear-gradient(transparent,rgba(0,0,0,0.8));pointer-events:none"></div>
                                    </div>
                                    
                                    <!-- Name Banner -->
                                    <div style="padding:20px 18px;position:relative">
                                        <div style="background:linear-gradient(135deg,#e91e63,#9c27b0);padding:12px 20px;border-radius:8px;display:flex;justify-content:space-between;align-items:center">
                                            <div style="font-family:'Bangers',cursive;font-size:clamp(22px,6vw,30px);color:#fff">${S.card.name || 'ThreeOne'}</div>
                                            <div style="font-size:12px;color:#fff;opacity:0.8">${S.card.edition || '1 of 25'}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                ` : S.card.template==='minimal' ? `
                                <!-- MINIMAL CLEAN STYLE -->
                                <div style="height:100%;display:flex;flex-direction:column;background:#fff">
                                    <!-- Header -->
                                    <div style="background:#111;padding:12px 16px;display:flex;justify-content:space-between;align-items:center">
                                        <span style="font-size:14px;color:#fff;font-weight:600">${S.card.title || 'PLAYER NAME'}</span>
                                        <span style="background:#ff6b35;color:#fff;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700">${S.card.cardNumber || '10'}</span>
                                    </div>
                                    
                                    <!-- Image -->
                                    <div onclick="event.stopPropagation();triggerUpload('card-front')" style="flex:1;background:#f5f5f5;display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid #eee">
                                        ${S.card.frontImage ? 
                                            `<img src="${S.card.frontImage}" style="width:100%;height:100%;object-fit:cover">` : 
                                            `<div style="color:#ccc;text-align:center">${icon('image',50)}</div>`
                                        }
                                    </div>
                                    
                                    <!-- Stats -->
                                    <div style="padding:14px 16px;background:#111">
                                        <div style="display:flex;gap:12px;margin-bottom:10px">
                                            <div style="flex:1"><div style="font-size:9px;color:#888;margin-bottom:4px">HP</div><div style="height:6px;background:#333;border-radius:3px"><div style="height:100%;width:${S.card.stats?.pwr||85}%;background:linear-gradient(90deg,#fff,#86efac);border-radius:3px"></div></div></div>
                                            <div style="flex:1"><div style="font-size:9px;color:#888;margin-bottom:4px">ATK</div><div style="height:6px;background:#333;border-radius:3px"><div style="height:100%;width:${S.card.stats?.spd||70}%;background:linear-gradient(90deg,#999,#fbbf24);border-radius:3px"></div></div></div>
                                            <div style="flex:1"><div style="font-size:9px;color:#888;margin-bottom:4px">DEX</div><div style="height:6px;background:#333;border-radius:3px"><div style="height:100%;width:${S.card.stats?.int||90}%;background:linear-gradient(90deg,#888,#f87171);border-radius:3px"></div></div></div>
                                        </div>
                                        <div style="font-size:18px;color:#fff;font-weight:700;text-align:center">${S.card.name || 'PLAYER NAME'}</div>
                                    </div>
                                    
                                    <!-- Bio -->
                                    <div style="padding:12px 16px;background:#1a1a1a;font-size:10px;color:#888;line-height:1.5">${S.card.bio || 'Lorem ipsum dolor sit amet consectetur adipiscing elit...'}</div>
                                </div>
                                
                                ` : S.card.template==='sports' ? `
                                <!-- SPORTS CARD STYLE (NBA/NFL) -->
                                <div style="height:100%;display:flex;flex-direction:column;background:linear-gradient(135deg,#1a1a2e,#0a192f);border-radius:12px;overflow:hidden;border:4px solid ${S.card.borderColor||'#c9a227'}">
                                    <!-- Team Header -->
                                    <div style="background:linear-gradient(90deg,${S.card.borderColor||'#c9a227'},${S.card.accentColor||'#1a1a2e'});padding:10px 14px;display:flex;justify-content:space-between;align-items:center">
                                        <span style="font-family:'Bebas Neue',sans-serif;font-size:16px;color:#fff;letter-spacing:2px">${S.card.team || 'TEAM NAME'}</span>
                                        <span style="font-size:24px;font-weight:900;color:#fff">${S.card.jersey || '23'}</span>
                                    </div>
                                    
                                    <!-- Player Photo -->
                                    <div onclick="event.stopPropagation();triggerUpload('card-front')" style="flex:1;position:relative;cursor:pointer;overflow:hidden">
                                        ${S.card.frontImage ? 
                                            `<img src="${S.card.frontImage}" style="width:100%;height:100%;object-fit:cover">` : 
                                            `<div style="width:100%;height:100%;background:linear-gradient(180deg,#1a1a2e,#0a0a1a);display:flex;align-items:center;justify-content:center;color:#333">${icon('image',80)}</div>`
                                        }
                                        <!-- Diagonal Cut -->
                                        <div style="position:absolute;bottom:0;left:0;right:0;height:100px;background:linear-gradient(15deg,${S.card.borderColor||'#c9a227'} 50%,transparent 50%);opacity:0.9"></div>
                                        <!-- Position Badge -->
                                        <div style="position:absolute;top:12px;right:12px;background:rgba(0,0,0,0.7);color:#fff;padding:6px 12px;font-size:11px;font-weight:700;border-radius:4px">${S.card.position || 'PG'}</div>
                                    </div>
                                    
                                    <!-- Player Info -->
                                    <div style="padding:16px;background:#0a0a0f">
                                        <div style="font-family:'Bebas Neue',sans-serif;font-size:clamp(24px,7vw,36px);color:#fff;text-align:center;letter-spacing:2px">${S.card.name || 'PLAYER NAME'}</div>
                                        <div style="font-size:11px;color:${S.card.borderColor||'#c9a227'};text-align:center;margin-top:4px">${S.card.season || '2024-25'} SEASON</div>
                                    </div>
                                    
                                    <!-- Stats Bar -->
                                    <div style="display:flex;background:#000;padding:12px">
                                        <div style="flex:1;text-align:center;border-right:1px solid #333">
                                            <div style="font-size:9px;color:#888">${S.card.stat1Label||'PPG'}</div>
                                            <div style="font-size:20px;color:#fff;font-weight:800">${S.card.stats?.pwr||0}</div>
                                        </div>
                                        <div style="flex:1;text-align:center;border-right:1px solid #333">
                                            <div style="font-size:9px;color:#888">${S.card.stat2Label||'RPG'}</div>
                                            <div style="font-size:20px;color:#fff;font-weight:800">${S.card.stats?.spd||0}</div>
                                        </div>
                                        <div style="flex:1;text-align:center">
                                            <div style="font-size:9px;color:#888">${S.card.stat3Label||'APG'}</div>
                                            <div style="font-size:20px;color:#fff;font-weight:800">${S.card.stats?.int||0}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                ` : S.card.template==='anime' ? `
                                <!-- ANIME/JAPANESE TCG STYLE -->
                                <div style="height:100%;display:flex;flex-direction:column;background:linear-gradient(180deg,#1a0a2a,#0a0a1a);border-radius:12px;overflow:hidden;border:3px solid ${S.card.borderColor||'#e91e63'};position:relative">
                                    <!-- Decorative Lines -->
                                    <div style="position:absolute;top:0;left:0;width:100%;height:4px;background:linear-gradient(90deg,#e91e63,#9c27b0,#3f51b5,#00bcd4)"></div>
                                    
                                    <!-- Header -->
                                    <div style="padding:12px 14px;display:flex;justify-content:space-between;align-items:center">
                                        <div>
                                            <div style="font-size:10px;color:#e91e63;letter-spacing:2px"> ${S.card.rarity || 'RARE'}</div>
                                            <div style="font-family:'Bebas Neue',sans-serif;font-size:18px;color:#fff">${S.card.title || 'WARRIOR'}</div>
                                        </div>
                                        <div style="background:linear-gradient(135deg,#e91e63,#9c27b0);width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:900;color:#fff;border:3px solid #fff">${S.card.stats?.pwr||50}</div>
                                    </div>
                                    
                                    <!-- Artwork -->
                                    <div onclick="event.stopPropagation();triggerUpload('card-front')" style="flex:1;margin:0 12px;border-radius:8px;overflow:hidden;cursor:pointer;border:2px solid rgba(233,30,99,0.3);position:relative">
                                        ${S.card.frontImage ? 
                                            `<img src="${S.card.frontImage}" style="width:100%;height:100%;object-fit:cover">` : 
                                            `<div style="width:100%;height:100%;background:linear-gradient(135deg,#2a1a3a,#1a0a2a);display:flex;align-items:center;justify-content:center;color:#e91e63">${icon('image',70)}</div>`
                                        }
                                        <!-- Energy Aura -->
                                        <div style="position:absolute;inset:0;background:radial-gradient(ellipse at center,transparent 50%,rgba(233,30,99,0.2) 100%);pointer-events:none"></div>
                                    </div>
                                    
                                    <!-- Name Plate (Japanese style) -->
                                    <div style="margin:12px;padding:12px;background:rgba(233,30,99,0.1);border-left:4px solid #e91e63;border-radius:0 8px 8px 0">
                                        <div style="font-size:clamp(20px,6vw,28px);color:#fff;font-weight:700">${S.card.name || 'CHARACTER'}</div>
                                        <div style="font-size:11px;color:#e91e63;margin-top:4px">${S.card.affiliation || 'Guild / Faction'}</div>
                                    </div>
                                    
                                    <!-- Stats -->
                                    <div style="display:flex;gap:8px;padding:0 12px 12px">
                                        <div style="flex:1;background:rgba(0,0,0,0.4);border-radius:8px;padding:8px;text-align:center">
                                            <div style="font-size:9px;color:#9c27b0">ATK</div>
                                            <div style="font-size:18px;color:#fff;font-weight:700">${S.card.stats?.pwr||50}</div>
                                        </div>
                                        <div style="flex:1;background:rgba(0,0,0,0.4);border-radius:8px;padding:8px;text-align:center">
                                            <div style="font-size:9px;color:#00bcd4">DEF</div>
                                            <div style="font-size:18px;color:#fff;font-weight:700">${S.card.stats?.spd||50}</div>
                                        </div>
                                        <div style="flex:1;background:rgba(0,0,0,0.4);border-radius:8px;padding:8px;text-align:center">
                                            <div style="font-size:9px;color:#4caf50">SPD</div>
                                            <div style="font-size:18px;color:#fff;font-weight:700">${S.card.stats?.int||50}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                ` : S.card.template==='pokemon' ? `
                                <!-- MONSTER/POKEMON STYLE -->
                                <div style="height:100%;display:flex;flex-direction:column;background:#f5dc6e;border-radius:16px;overflow:hidden;border:8px solid #f5dc6e;position:relative">
                                    <!-- Header -->
                                    <div style="padding:8px 12px;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(180deg,#f5dc6e,#e8c84a)">
                                        <div style="display:flex;align-items:center;gap:8px">
                                            <span style="font-weight:700;font-size:14px;color:#333">BASIC</span>
                                            <span style="font-size:18px;font-weight:900;color:#333">${S.card.name || 'CREATURE'}</span>
                                        </div>
                                        <div style="display:flex;align-items:center;gap:4px">
                                            <span style="font-size:12px;color:#333">HP</span>
                                            <span style="font-size:24px;font-weight:900;color:#c62828">${S.card.stats?.pwr||60}</span>
                                            <span style="font-size:20px"></span>
                                        </div>
                                    </div>
                                    
                                    <!-- Artwork Frame -->
                                    <div style="margin:8px;border:6px solid #b8973b;border-radius:8px;overflow:hidden;flex:1" onclick="event.stopPropagation();triggerUpload('card-front')">
                                        ${S.card.frontImage ? 
                                            `<img src="${S.card.frontImage}" style="width:100%;height:100%;object-fit:cover;cursor:pointer">` : 
                                            `<div style="width:100%;height:100%;background:linear-gradient(180deg,#7ec8e3,#a8e6cf);display:flex;align-items:center;justify-content:center;color:#333;cursor:pointer">${icon('image',80)}</div>`
                                        }
                                    </div>
                                    
                                    <!-- Info Box -->
                                    <div style="margin:0 8px;padding:6px 10px;background:#fff;border-radius:6px;font-size:10px;color:#666;border:1px solid #ddd">
                                        ${S.card.bio || 'NO. 001 Monster Type. HT: 2\'04" WT: 13.2 lbs'}
                                    </div>
                                    
                                    <!-- Attacks -->
                                    <div style="margin:8px;background:#fff;border-radius:8px;overflow:hidden;border:1px solid #ddd">
                                        <div style="display:flex;align-items:center;padding:10px;border-bottom:1px solid #eee">
                                            <div style="display:flex;gap:4px;width:40px">
                                                <div style="width:16px;height:16px;border-radius:50%;background:linear-gradient(135deg,#f5dc6e,#b8973b)"></div>
                                            </div>
                                            <div style="flex:1;font-weight:700;color:#333">${S.card.abilities?.split(',')[0] || 'Quick Attack'}</div>
                                            <div style="font-size:16px;font-weight:900;color:#333">${S.card.stats?.spd||20}</div>
                                        </div>
                                        <div style="display:flex;align-items:center;padding:10px">
                                            <div style="display:flex;gap:4px;width:40px">
                                                <div style="width:16px;height:16px;border-radius:50%;background:linear-gradient(135deg,#f5dc6e,#b8973b)"></div>
                                                <div style="width:16px;height:16px;border-radius:50%;background:linear-gradient(135deg,#f5dc6e,#b8973b)"></div>
                                            </div>
                                            <div style="flex:1;font-weight:700;color:#333">${S.card.abilities?.split(',')[1] || 'Special Move'}</div>
                                            <div style="font-size:16px;font-weight:900;color:#333">${S.card.stats?.int||50}</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Footer -->
                                    <div style="padding:6px 12px;font-size:8px;color:#666;display:flex;justify-content:space-between">
                                        <span>weakness:  2</span>
                                        <span>retreat: </span>
                                        <span>${S.card.cardNumber || '001/165'}</span>
                                    </div>
                                </div>
                                
                                ` : S.card.template==='id-badge' ? `
                                <!-- ID BADGE STYLE -->
                                <div style="height:100%;display:flex;flex-direction:column;background:#fff;border-radius:12px;overflow:hidden;border:3px solid ${S.card.borderColor||'#1e3a5f'}">
                                    <!-- Company Header -->
                                    <div style="background:${S.card.borderColor||'#1e3a5f'};padding:16px;text-align:center">
                                        <div style="font-size:12px;color:rgba(255,255,255,0.7);letter-spacing:2px">${S.card.team || 'PRESS START ACADEMY'}</div>
                                        <div style="font-family:'Bebas Neue',sans-serif;font-size:24px;color:#fff;margin-top:4px">${S.card.title || 'STUDENT ID'}</div>
                                    </div>
                                    
                                    <!-- Photo -->
                                    <div style="padding:20px;display:flex;justify-content:center">
                                        <div onclick="event.stopPropagation();triggerUpload('card-front')" style="width:180px;height:220px;background:#f0f0f0;border:4px solid #ddd;cursor:pointer;overflow:hidden">
                                            ${S.card.frontImage ? 
                                                `<img src="${S.card.frontImage}" style="width:100%;height:100%;object-fit:cover">` : 
                                                `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#999">${icon('image',60)}</div>`
                                            }
                                        </div>
                                    </div>
                                    
                                    <!-- Name & Info -->
                                    <div style="text-align:center;padding:0 20px 16px">
                                        <div style="font-size:clamp(22px,6vw,32px);font-weight:700;color:#333">${S.card.name || 'STUDENT NAME'}</div>
                                        <div style="font-size:14px;color:#666;margin-top:4px">${S.card.position || 'Grade 10  Class A'}</div>
                                    </div>
                                    
                                    <!-- ID Details -->
                                    <div style="background:#f9f9f9;padding:16px 20px;flex:1">
                                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:12px">
                                            <div><span style="color:#999">ID:</span> <span style="color:#333;font-weight:600">${S.card.cardNumber || 'STU-2025-001'}</span></div>
                                            <div><span style="color:#999">Year:</span> <span style="color:#333;font-weight:600">${S.card.season || '2024-2025'}</span></div>
                                            <div><span style="color:#999">Dept:</span> <span style="color:#333;font-weight:600">${S.card.affiliation || 'Game Design'}</span></div>
                                            <div><span style="color:#999">Status:</span> <span style="color:#fff;font-weight:600">ACTIVE </span></div>
                                        </div>
                                    </div>
                                    
                                    <!-- QR Code Area -->
                                    <div style="padding:12px;background:#fff;display:flex;justify-content:space-between;align-items:center;border-top:2px dashed #ddd">
                                        <div style="width:60px;height:60px;background:#000;border-radius:4px;display:flex;align-items:center;justify-content:center">
                                            <div style="width:50px;height:50px;background:repeating-linear-gradient(0deg,#fff 0px,#fff 4px,#000 4px,#000 8px),repeating-linear-gradient(90deg,#fff 0px,#fff 4px,#000 4px,#000 8px);background-size:16px 16px"></div>
                                        </div>
                                        <div style="text-align:right;font-size:10px;color:#999">
                                            <div>Scan for verification</div>
                                            <div style="font-weight:700;color:#333">${S.card.handle || '@student_handle'}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                ` : S.card.template==='holo' ? `
                                <!-- HOLOGRAPHIC CARD -->
                                <div style="height:100%;display:flex;flex-direction:column;background:linear-gradient(135deg,#1a1a2e,#0a0a1a);border-radius:16px;overflow:hidden;position:relative">
                                    <!-- Animated Holo Background -->
                                    <div style="position:absolute;inset:0;background:linear-gradient(45deg,#ff000020,#ff880020,#ffff0020,#00ff0020,#0088ff20,#8800ff20,#ff00ff20);background-size:400% 400%;animation:holoShift 3s ease-in-out infinite;opacity:0.8"></div>
                                    <div style="position:absolute;inset:0;background:repeating-linear-gradient(45deg,transparent,transparent 2px,rgba(255,255,255,0.03) 2px,rgba(255,255,255,0.03) 4px)"></div>
                                    
                                    <!-- Content -->
                                    <div style="position:relative;height:100%;display:flex;flex-direction:column;padding:12px">
                                        <!-- Header -->
                                        <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:rgba(0,0,0,0.5);border-radius:10px;backdrop-filter:blur(4px)">
                                            <span style="font-family:'Bebas Neue',sans-serif;font-size:16px;color:#fff;letter-spacing:3px">${S.card.title || 'HOLO RARE'}</span>
                                            <span style="background:linear-gradient(135deg,#ffd700,#ff6b35);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:14px;font-weight:900">${S.card.rarity || 'MYTHIC'}</span>
                                        </div>
                                        
                                        <!-- Image -->
                                        <div onclick="event.stopPropagation();triggerUpload('card-front')" style="flex:1;margin:12px 0;border-radius:12px;overflow:hidden;cursor:pointer;position:relative;border:3px solid rgba(255,255,255,0.2)">
                                            ${S.card.frontImage ? 
                                                `<img src="${S.card.frontImage}" style="width:100%;height:100%;object-fit:cover">` : 
                                                `<div style="width:100%;height:100%;background:linear-gradient(180deg,#1a1a2e,#0a0a1a);display:flex;align-items:center;justify-content:center;color:#444">${icon('image',70)}</div>`
                                            }
                                            <!-- Rainbow shimmer overlay -->
                                            <div style="position:absolute;inset:0;background:linear-gradient(125deg,transparent 20%,rgba(255,0,0,0.1) 25%,rgba(255,165,0,0.1) 30%,rgba(255,255,0,0.1) 35%,rgba(0,255,0,0.1) 40%,rgba(0,0,255,0.1) 45%,rgba(128,0,128,0.1) 50%,transparent 55%);background-size:200% 200%;animation:holoShift 2s linear infinite;pointer-events:none"></div>
                                        </div>
                                        
                                        <!-- Name -->
                                        <div style="padding:12px;background:rgba(0,0,0,0.5);border-radius:10px;backdrop-filter:blur(4px);text-align:center">
                                            <div style="font-family:'Bangers',cursive;font-size:clamp(24px,7vw,36px);background:linear-gradient(90deg,#ff6b6b,#ffd93d,#6bff6b,#6bb3ff,#d66bff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-size:200% auto;animation:holoText 3s linear infinite">${S.card.name || 'ULTRA RARE'}</div>
                                            <div style="font-size:11px;color:#888;margin-top:4px">${S.card.cardNumber || '#001'}  ${S.card.edition || 'First Edition'}</div>
                                        </div>
                                        
                                        <!-- Stats -->
                                        <div style="display:flex;gap:8px;margin-top:12px">
                                            <div style="flex:1;background:rgba(255,0,0,0.2);border-radius:8px;padding:10px;text-align:center;border:1px solid rgba(255,0,0,0.3)">
                                                <div style="font-size:9px;color:#ff6b6b">${S.card.stat1Label||'PWR'}</div>
                                                <div style="font-size:22px;color:#fff;font-weight:800">${S.card.stats?.pwr||50}</div>
                                            </div>
                                            <div style="flex:1;background:rgba(0,255,0,0.2);border-radius:8px;padding:10px;text-align:center;border:1px solid rgba(0,255,0,0.3)">
                                                <div style="font-size:9px;color:#6bff6b">${S.card.stat2Label||'SPD'}</div>
                                                <div style="font-size:22px;color:#fff;font-weight:800">${S.card.stats?.spd||50}</div>
                                            </div>
                                            <div style="flex:1;background:rgba(0,100,255,0.2);border-radius:8px;padding:10px;text-align:center;border:1px solid rgba(0,100,255,0.3)">
                                                <div style="font-size:9px;color:#6bb3ff">${S.card.stat3Label||'INT'}</div>
                                                <div style="font-size:22px;color:#fff;font-weight:800">${S.card.stats?.int||50}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                ` : `
                                <!-- CLASSIC STYLE (default) -->
                                <div style="height:100%;border:5px solid ${getRarityColor(S.card.rarity||'LEGENDARY')};border-radius:16px;overflow:hidden;display:flex;flex-direction:column;background:#fff">
                                    <div style="padding:16px 18px;background:${getRarityGradient(S.card.rarity||'LEGENDARY')};color:${['LEGENDARY','MYTHIC'].includes(S.card.rarity||'LEGENDARY')?'#000':'#fff'};font-family:'Bebas Neue',sans-serif;font-size:clamp(22px,6vw,30px);text-align:center;letter-spacing:4px;display:flex;justify-content:space-between;align-items:center">
                                        <span>${S.card.title || 'HERO CARD'}</span>
                                        <span style="font-size:14px;opacity:0.8">${S.card.cardNumber || '#001'}</span>
                                    </div>
                                    <div onclick="event.stopPropagation();showImageOptions('card-front')" style="flex:1;background:linear-gradient(180deg,#1a1a2e,#0d0d15);display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;position:relative">
                                        ${S.card.frontImage ? 
                                            `<img src="${S.card.frontImage}" style="width:100%;height:100%;object-fit:cover">` : 
                                            `<div style="color:#555;text-align:center">${icon('image',70)}<br><span style="font-size:16px">TAP TO ADD PHOTO</span><br><span style="font-size:12px;color:#bbb">or use  AI</span></div>`
                                        }
                                    </div>
                                    <div style="padding:14px 18px;background:${getRarityGradient(S.card.rarity||'LEGENDARY')};color:${['LEGENDARY','MYTHIC'].includes(S.card.rarity||'LEGENDARY')?'#000':'#fff'};font-family:'Bangers',cursive;font-size:clamp(26px,7vw,38px);text-align:center;letter-spacing:2px">${S.card.name || 'YOUR NAME'}</div>
                                    <div style="padding:16px 20px;background:#0a0a0f;display:flex;gap:20px">
                                        <div style="flex:1;text-align:center">
                                            <div style="font-size:12px;color:#888;margin-bottom:6px"> PWR</div>
                                            <div style="height:10px;background:#222;border-radius:5px;overflow:hidden;margin-bottom:6px"><div style="height:100%;width:${S.card.stats?.pwr||85}%;background:linear-gradient(90deg,#888,#aaa);border-radius:5px"></div></div>
                                            <div style="font-size:clamp(22px,6vw,32px);font-weight:800;color:#fff">${S.card.stats?.pwr||85}</div>
                                        </div>
                                        <div style="flex:1;text-align:center">
                                            <div style="font-size:12px;color:#888;margin-bottom:6px"> SPD</div>
                                            <div style="height:10px;background:#222;border-radius:5px;overflow:hidden;margin-bottom:6px"><div style="height:100%;width:${S.card.stats?.spd||70}%;background:linear-gradient(90deg,#ccc,#06b6d4);border-radius:5px"></div></div>
                                            <div style="font-size:clamp(22px,6vw,32px);font-weight:800;color:#fff">${S.card.stats?.spd||70}</div>
                                        </div>
                                        <div style="flex:1;text-align:center">
                                            <div style="font-size:12px;color:#888;margin-bottom:6px"> INT</div>
                                            <div style="height:10px;background:#222;border-radius:5px;overflow:hidden;margin-bottom:6px"><div style="height:100%;width:${S.card.stats?.int||90}%;background:linear-gradient(90deg,#bbb,#ccc);border-radius:5px"></div></div>
                                            <div style="font-size:clamp(22px,6vw,32px);font-weight:800;color:#fff">${S.card.stats?.int||90}</div>
                                        </div>
                                    </div>
                                </div>
                                `}
                                
                                <!-- Holographic Shimmer (all templates) -->
                                <div style="position:absolute;inset:0;border-radius:20px;background:linear-gradient(125deg,transparent 0%,rgba(255,255,255,0.15) 20%,transparent 40%,rgba(255,220,100,0.1) 60%,transparent 80%);background-size:400% 400%;pointer-events:none;animation:holoShift 4s ease-in-out infinite;opacity:0.6"></div>
                            </div>
                            
                            <!-- BACK OF CARD - MATCHES TEMPLATE -->
                            <div id="card-back-content" style="display:${S.cardFlipped ? 'flex' : 'none'};width:min(440px,95vw);height:min(620px,82vh);border-radius:${S.card.template==='retro'?'8px':S.card.template==='minimal'?'4px':'20px'};background:${S.card.backBgImage ? 'url('+S.card.backBgImage+') center/cover' : S.card.template==='retro'?'#f5e6d3':S.card.template==='neon'?'#0a0a1a':S.card.template==='tcg'?'#111':S.card.template==='premium'?'linear-gradient(135deg,#1a0a1a,#0a1a2a)':S.card.template==='minimal'?'#fff':'linear-gradient(180deg,#1a1a2e,#0f0f1a)'};padding:12px;box-shadow:0 50px 120px rgba(0,0,0,0.8);position:absolute;top:0;left:0;border:${S.card.template==='retro'?'10px solid #8b4513':S.card.template==='neon'?'4px solid #00ffff':S.card.template==='tcg'?'6px solid '+(S.card.borderColor||'#ff6b35'):S.card.template==='minimal'?'4px solid #222':'none'};overflow:hidden;flex-direction:column">
                                
                                <!-- Background Image Overlay -->
                                ${S.card.backBgImage ? `<div style="position:absolute;inset:0;background:${S.card.template==='retro'?'rgba(245,230,211,0.85)':S.card.template==='neon'?'rgba(10,10,26,0.8)':S.card.template==='tcg'?'rgba(17,17,17,0.85)':S.card.template==='premium'?'rgba(26,10,26,0.8)':S.card.template==='minimal'?'rgba(255,255,255,0.9)':'rgba(26,26,46,0.85)'};pointer-events:none"></div>` : ''}
                                
                                ${S.card.template==='retro' ? `
                                <!-- RETRO BACK -->
                                <div style="height:100%;display:flex;flex-direction:column;position:relative;z-index:1">
                                    <div style="padding:12px;background:#8b4513;text-align:center">
                                        <div style="font-family:'Bangers',cursive;font-size:20px;color:#ffd700">${S.card.backTitle || S.card.name || 'CHARACTER'}</div>
                                        <div style="font-size:11px;color:#d4a574">${S.card.cardNumber || '#001'}</div>
                                    </div>
                                    <div onclick="event.stopPropagation();showImageOptions('card-back')" style="height:90px;background:#d4c4a1;display:flex;align-items:center;justify-content:center;cursor:pointer;margin:10px;border:3px solid #8b4513">
                                        ${S.card.backImage ? '<img src="'+S.card.backImage+'" style="width:100%;height:100%;object-fit:cover">' : '<span style="color:#8b4513">'+icon('image',32)+'</span>'}
                                    </div>
                                    ${renderStatBars('retro', '#8b4513')}
                                    <div style="flex:1;padding:10px 14px;overflow:auto">
                                        <p style="font-size:12px;color:#5a3a1a;line-height:1.6;margin:0 0 10px 0">${S.card.bio || 'Character description...'}</p>
                                        ${S.card.abilities ? '<p style="font-size:11px;color:#8b4513;margin:0 0 8px 0"><b>Powers:</b> '+S.card.abilities+'</p>' : ''}
                                        ${S.card.quote ? '<p style="font-size:11px;color:#666;font-style:italic">"'+S.card.quote+'"</p>' : ''}
                                    </div>
                                    <div style="padding:8px 14px;background:#8b4513;display:flex;justify-content:space-between;align-items:center">
                                        <span style="font-size:10px;color:#ffd700"> ${S.card.rarity || 'RARE'}</span>
                                        <span style="font-size:9px;color:#d4a574">PRESS START</span>
                                    </div>
                                </div>
                                
                                ` : S.card.template==='neon' ? `
                                <!-- NEON BACK -->
                                <div style="height:100%;display:flex;flex-direction:column;padding:8px">
                                    <div style="position:absolute;inset:-4px;border-radius:20px;background:linear-gradient(45deg,#00ffff,#ff00ff,#00ffff);opacity:0.5;filter:blur(10px);z-index:-1"></div>
                                    <div style="padding:10px;text-align:center">
                                        <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;color:#fff;text-shadow:0 0 20px #ff00ff">${S.card.backTitle || S.card.name || 'CHARACTER'}</div>
                                        <div style="font-size:10px;color:#00ffff">@${S.card.handle || 'username'}</div>
                                    </div>
                                    <div onclick="event.stopPropagation();showImageOptions('card-back')" style="height:80px;background:#1a0a2a;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;margin:6px;border:2px solid #00ffff40">
                                        ${S.card.backImage ? '<img src="'+S.card.backImage+'" style="width:100%;height:100%;object-fit:cover;border-radius:8px">' : '<span style="color:#00ffff">'+icon('image',28)+'</span>'}
                                    </div>
                                    ${renderStatBars('neon', '#00ffff')}
                                    <div style="flex:1;padding:10px;overflow:auto">
                                        <p style="font-size:12px;color:#ccc;line-height:1.5;margin:0 0 8px 0">${S.card.bio || 'Bio...'}</p>
                                        ${S.card.abilities ? '<p style="font-size:11px;color:#ff00ff;margin:0"> '+S.card.abilities+'</p>' : ''}
                                    </div>
                                    <div style="padding:10px;background:rgba(0,255,255,0.1);border-radius:8px;display:flex;justify-content:space-between;align-items:center">
                                        <span style="font-size:10px;color:#ff00ff"> ${S.card.rarity || 'RARE'}</span>
                                        <span style="font-size:9px;color:#00ffff">PRESS START</span>
                                    </div>
                                </div>
                                
                                ` : S.card.template==='tcg' ? `
                                <div style="height:100%;border:4px solid ${S.card.borderColor||'#ff6b35'};border-radius:14px;overflow:hidden;display:flex;flex-direction:column;background:#111">
                                    <div style="padding:12px 16px;background:${S.card.borderColor||'#ff6b35'};display:flex;justify-content:space-between;align-items:center">
                                        <span style="font-family:'Bebas Neue',sans-serif;font-size:18px;color:#fff">${S.card.name || 'CHARACTER'}</span>
                                        <span style="font-size:12px;color:#fff;opacity:0.8">${S.card.cardNumber || '#001'}</span>
                                    </div>
                                    <div onclick="event.stopPropagation();triggerUpload('card-back')" style="height:120px;background:#1a1a2e;margin:10px;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px solid ${S.card.borderColor||'#ff6b35'}40">
                                        ${S.card.backImage ? `<img src="${S.card.backImage}" style="width:100%;height:100%;object-fit:cover;border-radius:6px">` : `<span style="color:${S.card.borderColor||'#ff6b35'}">${icon('image',40)}</span>`}
                                    </div>
                                    <div style="flex:1;padding:16px;overflow:auto;background:#0a0a0a;margin:0 10px">
                                        <div style="font-size:11px;color:${S.card.borderColor||'#ff6b35'};margin-bottom:8px;letter-spacing:2px">BIOGRAPHY</div>
                                        <p style="font-size:13px;color:#ccc;line-height:1.6;margin:0 0 12px 0">${S.card.bio || 'Character backstory...'}</p>
                                        ${S.card.affiliation ? `<div style="font-size:11px;color:#888"><b>Affiliation:</b> ${S.card.affiliation}</div>` : ''}
                                        ${S.card.abilities ? `<div style="font-size:11px;color:#888;margin-top:6px"><b>Abilities:</b> ${S.card.abilities}</div>` : ''}
                                    </div>
                                    <div style="padding:12px 16px;background:${S.card.borderColor||'#ff6b35'};display:flex;justify-content:space-between;align-items:center;margin:10px;border-radius:8px">
                                        <span style="font-size:12px;color:#fff;font-weight:700">${S.card.rarity || 'RARE'}</span>
                                        <span style="font-size:10px;color:#fff;opacity:0.7">CARD FORGE TCG</span>
                                    </div>
                                </div>
                                
                                ` : S.card.template==='premium' ? `
                                <!-- PREMIUM BACK -->
                                <div style="height:100%;display:flex;flex-direction:column;border-radius:16px;overflow:hidden">
                                    <div style="padding:16px;display:flex;justify-content:space-between;align-items:center">
                                        <div style="font-size:10px;color:#e91e63;letter-spacing:2px">ICON CARDS</div>
                                        <div style="font-size:10px;color:#666">MCMLLC 2025</div>
                                    </div>
                                    <div onclick="event.stopPropagation();triggerUpload('card-back')" style="height:140px;margin:0 16px;border-radius:12px;overflow:hidden;cursor:pointer;background:#2a1a3a">
                                        ${S.card.backImage ? `<img src="${S.card.backImage}" style="width:100%;height:100%;object-fit:cover">` : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#e91e63">${icon('image',50)}</div>`}
                                    </div>
                                    <div style="flex:1;padding:20px;overflow:auto">
                                        ${S.card.realName ? `<div style="font-size:11px;color:#e91e63;margin-bottom:4px">Real Name: ${S.card.realName}</div>` : ''}
                                        <p style="font-size:14px;color:#ccc;line-height:1.7;margin:0 0 16px 0">${S.card.bio || 'Character description...'}</p>
                                        ${S.card.abilities ? `<p style="font-size:12px;color:#9c27b0"> ${S.card.abilities}</p>` : ''}
                                        ${S.card.quote ? `<p style="font-size:12px;color:#666;font-style:italic;margin-top:12px">"${S.card.quote}"</p>` : ''}
                                    </div>
                                    <div style="padding:14px 20px;background:linear-gradient(135deg,#e91e63,#9c27b0);display:flex;justify-content:space-between;align-items:center;margin:16px;border-radius:8px">
                                        <span style="font-size:14px;color:#fff;font-weight:600">${S.card.name || 'CHARACTER'}</span>
                                        <span style="font-size:11px;color:#fff;opacity:0.8">${S.card.edition || '1 of 25'}</span>
                                    </div>
                                </div>
                                
                                ` : S.card.template==='minimal' ? `
                                <!-- MINIMAL BACK -->
                                <div style="height:100%;display:flex;flex-direction:column;background:#fff">
                                    <div style="padding:14px 18px;background:#111;display:flex;justify-content:space-between;align-items:center">
                                        <span style="font-size:14px;color:#fff;font-weight:600">${S.card.name || 'PLAYER'}</span>
                                        <span style="font-size:12px;color:#888">${S.card.cardNumber || '#10'}</span>
                                    </div>
                                    <div onclick="event.stopPropagation();triggerUpload('card-back')" style="height:100px;background:#f5f5f5;display:flex;align-items:center;justify-content:center;cursor:pointer">
                                        ${S.card.backImage ? `<img src="${S.card.backImage}" style="width:100%;height:100%;object-fit:cover">` : `<span style="color:#ccc">${icon('image',36)}</span>`}
                                    </div>
                                    <div style="flex:1;padding:20px;overflow:auto">
                                        <p style="font-size:13px;color:#333;line-height:1.7;margin:0 0 14px 0">${S.card.bio || 'Character description...'}</p>
                                        ${S.card.abilities ? `<p style="font-size:12px;color:#666;margin:0 0 8px 0"><b>Abilities:</b> ${S.card.abilities}</p>` : ''}
                                        ${S.card.quote ? `<p style="font-size:12px;color:#999;font-style:italic">"${S.card.quote}"</p>` : ''}
                                    </div>
                                    <div style="padding:14px 18px;background:#111;display:flex;justify-content:space-between;align-items:center">
                                        <span style="font-size:12px;color:#fff">${S.card.rarity || 'STANDARD'}</span>
                                        <span style="font-size:10px;color:#666">CARD FORGE</span>
                                    </div>
                                </div>
                                
                                ` : S.card.template==='sports' ? `
                                <!-- SPORTS BACK -->
                                <div style="height:100%;display:flex;flex-direction:column;background:linear-gradient(180deg,#1a1a2e,#0d1117);border-radius:12px;overflow:hidden">
                                    <div style="padding:16px;background:linear-gradient(135deg,#ff6b35,#f7931e);display:flex;justify-content:space-between;align-items:center">
                                        <div>
                                            <div style="font-family:'Bebas Neue',sans-serif;font-size:24px;color:#fff;letter-spacing:2px">${S.card.name || 'ATHLETE'}</div>
                                            <div style="font-size:11px;color:rgba(255,255,255,0.7)">${S.card.affiliation || 'TEAM NAME'}</div>
                                        </div>
                                        <div style="font-size:28px;font-weight:900;color:#fff">${S.card.cardNumber || '#00'}</div>
                                    </div>
                                    <div style="display:flex;gap:12px;padding:12px">
                                        <div onclick="event.stopPropagation();triggerUpload('card-back')" style="width:100px;height:120px;background:#222;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px solid #ff6b35">
                                            ${S.card.backImage ? '<img src="'+S.card.backImage+'" style="width:100%;height:100%;object-fit:cover;border-radius:6px">' : '<span style="color:#ff6b35">'+icon('image',30)+'</span>'}
                                        </div>
                                        <div style="flex:1">
                                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                                                <div style="background:#222;padding:8px;border-radius:6px;text-align:center"><div style="font-size:9px;color:#888">PTS</div><div style="font-size:18px;color:#ff6b35;font-weight:700">${S.card.stats?.pwr||85}</div></div>
                                                <div style="background:#222;padding:8px;border-radius:6px;text-align:center"><div style="font-size:9px;color:#888">AST</div><div style="font-size:18px;color:#fff;font-weight:700">${S.card.stats?.spd||70}</div></div>
                                                <div style="background:#222;padding:8px;border-radius:6px;text-align:center"><div style="font-size:9px;color:#888">REB</div><div style="font-size:18px;color:#ddd;font-weight:700">${S.card.stats?.int||90}</div></div>
                                                <div style="background:#222;padding:8px;border-radius:6px;text-align:center"><div style="font-size:9px;color:#888">DEF</div><div style="font-size:18px;color:#a855f7;font-weight:700">${S.card.stats?.def||75}</div></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="flex:1;padding:16px;overflow:auto">
                                        <div style="font-size:10px;color:#ff6b35;letter-spacing:2px;margin-bottom:8px">CAREER HIGHLIGHTS</div>
                                        <p style="font-size:13px;color:#ccc;line-height:1.6;margin:0">${S.card.bio || 'Player stats and achievements...'}</p>
                                        ${S.card.abilities ? '<p style="font-size:12px;color:#888;margin-top:10px"> '+S.card.abilities+'</p>' : ''}
                                    </div>
                                    <div style="padding:12px 16px;background:#111;display:flex;justify-content:space-between;align-items:center;border-top:2px solid #ff6b35">
                                        <span style="font-size:11px;color:#ff6b35;font-weight:600">${S.card.rarity || 'ALL-STAR'}</span>
                                        <span style="font-size:10px;color:#666">SPORTS FORGE</span>
                                    </div>
                                </div>
                                
                                ` : S.card.template==='anime' ? `
                                <!-- ANIME BACK -->
                                <div style="height:100%;display:flex;flex-direction:column;background:linear-gradient(180deg,#1a0a2a,#0a0a1a);border-radius:12px;overflow:hidden;border:3px solid #e91e63">
                                    <div style="padding:14px;background:linear-gradient(135deg,#9c27b0,#e91e63);text-align:center">
                                        <div style="font-family:'Bangers',cursive;font-size:26px;color:#fff;text-shadow:2px 2px 0 #000">${S.card.name || 'CHARACTER'}</div>
                                        <div style="font-size:11px;color:rgba(255,255,255,0.8)">${S.card.affiliation || 'GUILD NAME'}</div>
                                    </div>
                                    <div style="position:relative;height:130px;background:linear-gradient(45deg,#2a1a3a,#1a2a4a);overflow:hidden">
                                        <div style="position:absolute;inset:0;background:url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><circle cx=\"20\" cy=\"20\" r=\"2\" fill=\"%23fff\" opacity=\"0.1\"/><circle cx=\"80\" cy=\"40\" r=\"1\" fill=\"%23fff\" opacity=\"0.2\"/><circle cx=\"50\" cy=\"80\" r=\"1.5\" fill=\"%23fff\" opacity=\"0.15\"/></svg>');opacity:0.5"></div>
                                        <div onclick="event.stopPropagation();triggerUpload('card-back')" style="position:absolute;inset:10px;border-radius:8px;background:#1a1a2e;display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px dashed #e91e63">
                                            ${S.card.backImage ? '<img src="'+S.card.backImage+'" style="width:100%;height:100%;object-fit:cover;border-radius:6px">' : '<span style="color:#e91e63">'+icon('image',36)+'</span>'}
                                        </div>
                                    </div>
                                    <div style="padding:12px;display:flex;justify-content:space-around;background:rgba(233,30,99,0.1)">
                                        <div style="text-align:center"><div style="font-size:9px;color:#888">ATK</div><div style="font-size:16px;color:#888;font-weight:700">${S.card.stats?.pwr||85}</div></div>
                                        <div style="text-align:center"><div style="font-size:9px;color:#888">SPD</div><div style="font-size:16px;color:#ccc;font-weight:700">${S.card.stats?.spd||70}</div></div>
                                        <div style="text-align:center"><div style="font-size:9px;color:#888">MAG</div><div style="font-size:16px;color:#a855f7;font-weight:700">${S.card.stats?.int||90}</div></div>
                                    </div>
                                    <div style="flex:1;padding:16px;overflow:auto">
                                        <p style="font-size:13px;color:#ddd;line-height:1.7;margin:0 0 12px 0">${S.card.bio || 'Character backstory...'}</p>
                                        ${S.card.abilities ? '<div style="font-size:12px;color:#e91e63"> <b>Skills:</b> '+S.card.abilities+'</div>' : ''}
                                        ${S.card.quote ? '<p style="font-size:11px;color:#888;font-style:italic;margin-top:10px">"'+S.card.quote+'"</p>' : ''}
                                    </div>
                                    <div style="padding:12px;background:linear-gradient(135deg,#e91e63,#9c27b0);display:flex;justify-content:space-between;align-items:center">
                                        <span style="font-size:12px;color:#fff"> ${S.card.rarity || 'SSR'}</span>
                                        <span style="font-size:10px;color:rgba(255,255,255,0.7)">ANIME FORGE</span>
                                    </div>
                                </div>
                                
                                ` : S.card.template==='pokemon' ? `
                                <!-- MONSTER/POKEMON BACK -->
                                <div style="height:100%;display:flex;flex-direction:column;background:#f5f5dc;border-radius:12px;overflow:hidden;border:4px solid #ffd700">
                                    <div style="padding:12px 16px;background:linear-gradient(135deg,#ffd700,#ffb300);display:flex;justify-content:space-between;align-items:center">
                                        <div style="font-family:'Bangers',cursive;font-size:22px;color:#333">${S.card.name || 'CREATURE'}</div>
                                        <div style="background:#fff;padding:4px 10px;border-radius:12px;font-size:11px;color:#333;font-weight:700">HP ${S.card.stats?.pwr||100}</div>
                                    </div>
                                    <div onclick="event.stopPropagation();triggerUpload('card-back')" style="height:140px;margin:10px;background:#fff;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:3px solid #ddd">
                                        ${S.card.backImage ? '<img src="'+S.card.backImage+'" style="width:100%;height:100%;object-fit:cover;border-radius:5px">' : '<span style="color:#ccc">'+icon('image',44)+'</span>'}
                                    </div>
                                    <div style="padding:12px;background:#fff;margin:0 10px;border-radius:8px">
                                        <div style="display:flex;gap:8px;margin-bottom:10px">
                                            <div style="flex:1;background:#888;padding:6px;border-radius:6px;text-align:center;color:#fff;font-size:10px;font-weight:700"> FIRE</div>
                                            <div style="flex:1;background:#ccc;padding:6px;border-radius:6px;text-align:center;color:#fff;font-size:10px;font-weight:700"> WATER</div>
                                        </div>
                                        <div style="font-size:12px;color:#333;margin-bottom:8px"><b>Type:</b> ${S.card.affiliation || 'Fire/Dragon'}</div>
                                        ${S.card.abilities ? '<div style="font-size:11px;color:#555;margin-bottom:6px"><b>Ability:</b> '+S.card.abilities+'</div>' : ''}
                                    </div>
                                    <div style="flex:1;padding:12px;overflow:auto;background:#f5f5dc">
                                        <p style="font-size:12px;color:#444;line-height:1.6;margin:0;font-style:italic">${S.card.bio || 'Creature description and lore...'}</p>
                                    </div>
                                    <div style="padding:10px 16px;background:linear-gradient(135deg,#ffd700,#ffb300);display:flex;justify-content:space-between;align-items:center">
                                        <span style="font-size:11px;color:#333;font-weight:600">${S.card.rarity || 'RARE'} </span>
                                        <span style="font-size:9px;color:#666">${S.card.cardNumber || '#001/100'}</span>
                                    </div>
                                </div>
                                
                                ` : S.card.template==='id-badge' ? `
                                <!-- ID BADGE BACK -->
                                <div style="height:100%;display:flex;flex-direction:column;background:#fff;border-radius:8px;overflow:hidden;border:2px solid #0066cc">
                                    <div style="padding:14px;background:linear-gradient(135deg,#0066cc,#004499);text-align:center">
                                        <div style="font-size:10px;color:rgba(255,255,255,0.7);letter-spacing:2px;margin-bottom:4px">OFFICIAL IDENTIFICATION</div>
                                        <div style="font-family:'Bebas Neue',sans-serif;font-size:24px;color:#fff">${S.card.affiliation || 'ORGANIZATION'}</div>
                                    </div>
                                    <div style="display:flex;padding:16px;gap:14px;background:#f8f9fa">
                                        <div onclick="event.stopPropagation();triggerUpload('card-back')" style="width:90px;height:110px;background:#e9ecef;border-radius:4px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid #dee2e6">
                                            ${S.card.backImage ? '<img src="'+S.card.backImage+'" style="width:100%;height:100%;object-fit:cover;border-radius:3px">' : '<span style="color:#adb5bd">'+icon('image',28)+'</span>'}
                                        </div>
                                        <div style="flex:1">
                                            <div style="font-size:18px;color:#212529;font-weight:700;margin-bottom:4px">${S.card.name || 'FULL NAME'}</div>
                                            <div style="font-size:12px;color:#0066cc;margin-bottom:8px">${S.card.handle || 'EMPLOYEE ID: 00000'}</div>
                                            <div style="font-size:11px;color:#495057"><b>Dept:</b> ${S.card.abilities || 'Operations'}</div>
                                            <div style="font-size:11px;color:#495057"><b>Level:</b> ${S.card.rarity || 'STANDARD'}</div>
                                        </div>
                                    </div>
                                    <div style="flex:1;padding:16px;overflow:auto;background:#fff">
                                        <div style="font-size:10px;color:#6c757d;letter-spacing:1px;margin-bottom:8px">ADDITIONAL INFORMATION</div>
                                        <p style="font-size:12px;color:#333;line-height:1.6;margin:0">${S.card.bio || 'Employee notes and clearance information...'}</p>
                                        ${S.card.quote ? '<p style="font-size:11px;color:#666;margin-top:10px;font-style:italic">"'+S.card.quote+'"</p>' : ''}
                                    </div>
                                    <div style="padding:12px 16px;background:#0066cc;display:flex;justify-content:space-between;align-items:center">
                                        <div style="display:flex;gap:16px">
                                            <div style="width:30px;height:30px;background:repeating-linear-gradient(45deg,#fff,#fff 2px,transparent 2px,transparent 4px);border-radius:2px"></div>
                                            <div style="width:30px;height:30px;background:repeating-linear-gradient(-45deg,#fff,#fff 2px,transparent 2px,transparent 4px);border-radius:2px"></div>
                                        </div>
                                        <span style="font-size:10px;color:#fff">VALID ${new Date().getFullYear()}</span>
                                    </div>
                                </div>
                                
                                ` : `
                                <!-- CLASSIC BACK (default) -->
                                <div style="height:100%;border:5px solid ${S.card.borderColor||getRarityColor(S.card.rarity||'LEGENDARY')};border-radius:16px;overflow:hidden;display:flex;flex-direction:column;background:#fff;position:relative;z-index:1">
                                    <div style="padding:14px;background:${getRarityGradient(S.card.rarity||'LEGENDARY')};color:${['LEGENDARY','MYTHIC'].includes(S.card.rarity||'LEGENDARY')?'#000':'#fff'};font-family:'Bebas Neue',sans-serif;font-size:20px;text-align:center;letter-spacing:3px;display:flex;justify-content:space-between;align-items:center">
                                        <span>${S.card.backTitle || S.card.name || 'CHARACTER'}</span>
                                        <span style="font-size:12px;opacity:0.7">${S.card.cardNumber || '#001'}</span>
                                    </div>
                                    <div onclick="event.stopPropagation();showImageOptions('card-back')" style="height:100px;background:#1a1a2e;display:flex;align-items:center;justify-content:center;cursor:pointer">
                                        ${S.card.backImage ? '<img src="'+S.card.backImage+'" style="width:100%;height:100%;object-fit:cover">' : '<span style="color:#666;font-size:13px">'+icon('image',32)+' Add Image</span>'}
                                    </div>
                                    ${renderStatBars('classic', S.card.borderColor)}
                                    <div style="flex:1;padding:12px 16px;background:#f8f8f8;overflow:auto">
                                        <p style="font-size:13px;color:#333;line-height:1.6;margin:0 0 10px 0">${S.card.bio || 'Add a bio or description...'}</p>
                                        ${S.card.abilities ? '<p style="font-size:12px;color:#555;margin:0 0 8px 0"><b> Abilities:</b> '+S.card.abilities+'</p>' : ''}
                                        ${S.card.affiliation ? '<p style="font-size:11px;color:#666;margin:0 0 6px 0"><b>Team:</b> '+S.card.affiliation+'</p>' : ''}
                                        ${S.card.quote ? '<p style="font-size:12px;color:#777;font-style:italic;margin:0">"'+S.card.quote+'"</p>' : ''}
                                    </div>
                                    <div style="padding:12px 16px;background:#0a0a0f;display:flex;justify-content:space-between;align-items:center">
                                        <span style="font-size:14px;color:${S.card.borderColor||getRarityColor(S.card.rarity||'LEGENDARY')};font-weight:700"> ${S.card.rarity || 'LEGENDARY'}</span>
                                        <span style="font-size:10px;color:#666">PRESS START</span>
                                    </div>
                                </div>
                                `}
                            </div>
                        </div>
                    </div>
                    
                    <!-- FLOATING ACTION BAR - Always Visible -->
                    <div class="card-action-bar">
                        <button onclick="S.activeSheet='card-edit';render()" class="cyber-btn icon-only" title="Edit Card"></button>
                        <button onclick="triggerUpload('card-front')" class="cyber-btn icon-only" title="Add Photo"></button>
                        <button onclick="flipCard()" class="cyber-btn icon-only" title="Flip Card"></button>
                        <div style="width:1px;background:#333;margin:0 4px"></div>
                        <button onclick="S.activeSheet='pack-shop';render()" class="cyber-btn" title="Card Shop">
                             <span class="label">SHOP</span>
                            <span style="background:#333;padding:2px 6px;border-radius:6px;font-size:9px">${S.user.credits}</span>
                        </button>
                        <button onclick="openCardCollection()" class="cyber-btn" title="Collection">
                             <span class="label">CARDS</span>
                            <span style="background:#333;padding:2px 6px;border-radius:6px;font-size:9px">${S.cardCollection.length}</span>
                        </button>
                        <button onclick="S.activeSheet='battle-modes';render()" class="cyber-btn danger" title="Battle">
                             <span class="label">BATTLE</span>
                        </button>
                        <div style="width:1px;background:#333;margin:0 4px"></div>
                        <button onclick="shareToFeed()" class="cyber-btn icon-only neon-post" title="Post to Feed" style="border-color:#f0f;box-shadow:0 0 10px rgba(255,0,255,0.3)"></button>
                        <button onclick="shareCard()" class="cyber-btn icon-only" title="Share"></button>
                        <button onclick="saveToPhotos('card')" class="cyber-btn primary icon-only" title="Save"></button>
                    </div>
                </div>
                ` : ''}
                
                <div class="tab-content ${S.activeTab === 'cover' ? 'active' : ''}">
                </div>
                
                ${S.activeTab === 'cover' ? `
                <!-- COVER ARCHITECT - Full Screen Overlay -->
                <div style="position:fixed;inset:0;background:var(--studio-bg);z-index:500;display:flex;flex-direction:column;overflow:hidden">
                    
                    <!-- Close Button -->
                    <button onclick="S.activeTab='comic';render()" style="position:fixed;top:max(20px, env(safe-area-inset-top, 20px));right:16px;width:44px;height:44px;border-radius:8px;border:1px solid var(--studio-border);background:var(--studio-sidebar);color:var(--studio-text);font-size:20px;cursor:pointer;z-index:9999;display:flex;align-items:center;justify-content:center">${icon('x', 20)}</button>
                    
                    <!-- COVER HEADER -->
                    <div style="display:flex;align-items:center;gap:12px;padding:16px 20px;padding-top:max(16px, env(safe-area-inset-top, 16px));background:var(--studio-sidebar);border-bottom:1px solid var(--studio-border)">
                        <div style="width:40px;height:40px;background:var(--studio-accent);border-radius:10px;display:flex;align-items:center;justify-content:center;color:var(--studio-bg)">${icon('book', 20)}</div>
                        <div>
                            <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--studio-text);letter-spacing:2px">COVER ARCHITECT</div>
                            <div style="font-size:10px;color:var(--studio-text-muted)">${S.cover.template ? S.cover.template.toUpperCase() : 'CLASSIC'} STYLE</div>
                        </div>
                    </div>
                    
                    <!-- COVER TEMPLATE SELECTOR -->
                    <div style="display:flex;justify-content:flex-start;gap:6px;padding:12px;overflow-x:auto;background:var(--studio-sidebar);z-index:10;scrollbar-width:none;border-bottom:1px solid var(--studio-border)">
                        ${[
                            {id:'classic',icon:'',name:'Classic'},
                            {id:'horror',icon:'',name:'Horror'},
                            {id:'scifi',icon:'',name:'Sci-Fi'},
                            {id:'manga',icon:'',name:'Manga'},
                            {id:'retro',icon:'',name:'Retro'},
                            {id:'minimal',icon:'',name:'Minimal'},
                            {id:'superhero',icon:'',name:'Superhero'},
                            {id:'noir',icon:'',name:'Noir'},
                            {id:'fantasy',icon:'',name:'Fantasy'},
                            {id:'western',icon:'',name:'Western'},
                            {id:'romance',icon:'',name:'Romance'}
                        ].map(t => `
                            <button onclick="S.cover.template='${t.id}';render()" style="padding:8px 14px;border-radius:6px;border:1px solid ${!S.cover.template && t.id==='classic' || S.cover.template===t.id ? 'var(--studio-accent)' : 'var(--studio-border)'};background:${!S.cover.template && t.id==='classic' || S.cover.template===t.id ? 'var(--studio-active)' : 'transparent'};color:var(--studio-text);font-size:11px;cursor:pointer;white-space:nowrap;font-weight:500;transition:all 0.15s">${t.icon} ${t.name}</button>
                        `).join('')}
                    </div>
                    
                    <!-- SIDE BY SIDE COVERS - MUCH BIGGER -->
                    <div style="flex:1;display:flex;align-items:center;justify-content:center;gap:16px;padding:12px;flex-wrap:wrap;background:var(--studio-bg);overflow:auto">
                        
                        <!-- FRONT COVER - BIGGER -->
                        <div style="text-align:center">
                            <div style="font-size:11px;color:#888;margin-bottom:6px;font-weight:600"> FRONT COVER</div>
                            
                            ${S.cover.template==='horror' ? `
                            <!-- HORROR TEMPLATE -->
                            <div id="cover-front-content" onclick="triggerUpload('cover-front')" style="width:min(320px,46vw);height:min(480px,68vh);border-radius:4px;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,0.7),0 0 40px rgba(139,0,0,0.3);cursor:pointer;background:#0a0a0a;display:flex;flex-direction:column;border:4px solid #3a0a0a">
                                <div style="padding:12px;text-align:center;background:linear-gradient(180deg,#1a0a0a,#0a0a0a)">
                                    <div style="font-family:'Creepster',cursive,'Bangers';font-size:clamp(12px,3vw,16px);color:#8b0000;letter-spacing:4px;text-transform:uppercase">${S.cover.series || 'TALES FROM THE CRYPT'}</div>
                                </div>
                                <div style="flex:1;background:${S.cover.frontImage ? 'url('+S.cover.frontImage+') center/cover' : '#1a0a0a'};position:relative;display:flex;flex-direction:column;justify-content:flex-end">
                                    ${!S.cover.frontImage ? `<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:#4a0a0a">${icon('image',56)}</div>` : ''}
                                    <div style="background:linear-gradient(transparent,rgba(0,0,0,0.95));padding:20px">
                                        <div style="font-family:'Creepster',cursive,'Bangers';font-size:clamp(28px,8vw,44px);color:#8b0000;text-shadow:0 0 20px #ff0000;letter-spacing:3px">${S.cover.title || 'NIGHTMARE'}</div>
                                        <div style="font-size:clamp(11px,3vw,15px);color:#666;font-style:italic">${S.cover.tagline || 'THEY ONLY COME OUT AT NIGHT'}</div>
                                    </div>
                                </div>
                                <div style="padding:10px 14px;display:flex;justify-content:space-between;background:#0a0a0a;border-top:2px solid #3a0a0a">
                                    <span style="font-size:10px;color:#4a0a0a">ISSUE ${S.cover.issue || '#1'}</span>
                                    <span style="font-size:10px;color:#8b0000;font-weight:700">${S.cover.price || '$4.99'}</span>
                                </div>
                            </div>
                            
                            ` : S.cover.template==='scifi' ? `
                            <!-- SCI-FI TEMPLATE -->
                            <div id="cover-front-content" onclick="triggerUpload('cover-front')" style="width:min(320px,46vw);height:min(480px,68vh);border-radius:8px;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,0.7),0 0 60px rgba(0,200,255,0.2);cursor:pointer;background:#030318;display:flex;flex-direction:column;border:3px solid #00d4ff">
                                <div style="padding:10px 14px;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(90deg,#00d4ff20,transparent,#ff00ff20)">
                                    <span style="font-family:'Orbitron','Bebas Neue',sans-serif;font-size:clamp(11px,2.5vw,14px);color:#00d4ff;letter-spacing:3px">${S.cover.series || 'STELLAR COMICS'}</span>
                                    <span style="font-size:10px;color:#ff00ff;font-family:monospace">VOL.${S.cover.issue || '001'}</span>
                                </div>
                                <div style="flex:1;background:${S.cover.frontImage ? 'url('+S.cover.frontImage+') center/cover' : 'linear-gradient(180deg,#030318,#0a0a2a)'};position:relative;display:flex;flex-direction:column;justify-content:flex-end">
                                    ${!S.cover.frontImage ? `<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:#00d4ff40">${icon('image',56)}</div>` : ''}
                                    <div style="position:absolute;inset:0;background:linear-gradient(135deg,transparent,rgba(0,212,255,0.1),transparent);pointer-events:none"></div>
                                    <div style="background:linear-gradient(transparent,rgba(0,0,0,0.9));padding:24px">
                                        <div style="font-family:'Orbitron','Bebas Neue',sans-serif;font-size:clamp(24px,7vw,38px);color:#fff;text-shadow:0 0 30px #00d4ff;letter-spacing:4px">${S.cover.title || 'NEBULA'}</div>
                                        <div style="font-size:clamp(10px,2.5vw,13px);color:#00d4ff;margin-top:4px">${S.cover.tagline || 'BEYOND THE STARS'}</div>
                                    </div>
                                </div>
                                <div style="padding:10px 14px;display:flex;justify-content:space-between;background:#030318;border-top:1px solid #00d4ff40">
                                    <span style="font-size:9px;color:#666;font-family:monospace"> ${S.cover.author || 'STELLAR STUDIOS'}</span>
                                    <span style="font-size:10px;color:#00d4ff">${S.cover.price || '$5.99'}</span>
                                </div>
                            </div>
                            
                            ` : S.cover.template==='manga' ? `
                            <!-- MANGA TEMPLATE -->
                            <div id="cover-front-content" onclick="triggerUpload('cover-front')" style="width:min(320px,46vw);height:min(480px,68vh);border-radius:4px;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,0.7);cursor:pointer;background:#fff;display:flex;flex-direction:column;border:3px solid #e91e63">
                                <div style="position:absolute;top:10px;right:10px;background:#e91e63;color:#fff;padding:6px 12px;font-size:10px;font-weight:700;border-radius:2px;z-index:5">VOL.${S.cover.issue || '1'}</div>
                                <div style="flex:1;background:${S.cover.frontImage ? 'url('+S.cover.frontImage+') center/cover' : '#fce4ec'};position:relative;display:flex;flex-direction:column;justify-content:flex-end">
                                    ${!S.cover.frontImage ? `<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:#e91e6380">${icon('image',56)}</div>` : ''}
                                    <div style="background:linear-gradient(transparent,rgba(255,255,255,0.95));padding:20px;text-align:center">
                                        <div style="font-size:clamp(10px,2.5vw,12px);color:#e91e63;letter-spacing:2px;margin-bottom:4px">${S.cover.series || 'SHOUJO MANGA'}</div>
                                        <div style="font-family:'Bangers',cursive;font-size:clamp(26px,7vw,40px);color:#333;letter-spacing:1px">${S.cover.title || 'SAKURA'}</div>
                                        <div style="font-size:clamp(10px,2.5vw,13px);color:#e91e63;font-style:italic">${S.cover.tagline || '~ A Love Story ~'}</div>
                                    </div>
                                </div>
                                <div style="padding:10px 14px;display:flex;justify-content:space-between;background:#fff;border-top:2px solid #fce4ec">
                                    <span style="font-size:9px;color:#888">${S.cover.author || 'BY: MANGAKA'}</span>
                                    <span style="font-size:10px;color:#e91e63;font-weight:700">${S.cover.price || '580'}</span>
                                </div>
                            </div>
                            
                            ` : S.cover.template==='retro' ? `
                            <!-- RETRO TEMPLATE -->
                            <div id="cover-front-content" onclick="triggerUpload('cover-front')" style="width:min(320px,46vw);height:min(480px,68vh);border-radius:2px;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,0.7);cursor:pointer;background:#f5e6d3;display:flex;flex-direction:column;border:6px solid #d4a574">
                                <div style="padding:8px 12px;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(90deg,#ffd700,#ffb300)">
                                    <span style="font-family:'Bangers',cursive;font-size:clamp(12px,3vw,16px);color:#8b0000;text-shadow:1px 1px 0 #fff">${S.cover.series || 'GOLDEN AGE'}</span>
                                    <span style="background:#8b0000;color:#ffd700;padding:4px 10px;font-size:12px;font-weight:800">${S.cover.issue || '10'}</span>
                                </div>
                                <div style="flex:1;background:${S.cover.frontImage ? 'url('+S.cover.frontImage+') center/cover' : '#e8d5b7'};position:relative;display:flex;flex-direction:column;justify-content:flex-end;border:4px solid #d4a574;margin:8px">
                                    ${!S.cover.frontImage ? `<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:#8b451360">${icon('image',56)}</div>` : ''}
                                    <div style="background:linear-gradient(transparent,rgba(245,230,211,0.95));padding:16px;text-align:center">
                                        <div style="font-family:'Bangers',cursive;font-size:clamp(24px,7vw,38px);color:#8b0000;text-shadow:2px 2px 0 #ffd700">${S.cover.title || 'CAPTAIN HERO'}</div>
                                        <div style="font-size:clamp(10px,2.5vw,13px);color:#5a3a1a">${S.cover.tagline || 'JUSTICE NEVER SLEEPS!'}</div>
                                    </div>
                                </div>
                                <div style="padding:6px 12px;display:flex;justify-content:center;background:#ffd700">
                                    <span style="font-size:10px;color:#8b0000;font-weight:700">APPROVED BY THE COMICS CODE</span>
                                </div>
                            </div>
                            
                            ` : S.cover.template==='minimal' ? `
                            <!-- MINIMAL TEMPLATE -->
                            <div id="cover-front-content" onclick="triggerUpload('cover-front')" style="width:min(320px,46vw);height:min(480px,68vh);border-radius:0;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,0.5);cursor:pointer;background:#fff;display:flex;flex-direction:column;border:2px solid #000">
                                <div style="flex:1;background:${S.cover.frontImage ? 'url('+S.cover.frontImage+') center/cover' : '#f5f5f5'};position:relative">
                                    ${!S.cover.frontImage ? `<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:#ccc">${icon('image',56)}</div>` : ''}
                                </div>
                                <div style="padding:24px;background:#fff;text-align:center">
                                    <div style="font-size:clamp(8px,2vw,10px);color:#999;letter-spacing:4px;margin-bottom:8px">${S.cover.series || 'GRAPHIC NOVEL'}</div>
                                    <div style="font-family:Georgia,serif;font-size:clamp(20px,6vw,32px);color:#000;font-weight:300">${S.cover.title || 'Untitled'}</div>
                                    <div style="font-size:clamp(10px,2.5vw,12px);color:#666;margin-top:8px">${S.cover.author || 'Author Name'}</div>
                                </div>
                                <div style="padding:10px;border-top:1px solid #eee;display:flex;justify-content:space-between">
                                    <span style="font-size:9px;color:#999">${S.cover.issue || 'ISSUE 1'}</span>
                                    <span style="font-size:9px;color:#999">${S.cover.price || '$12.99'}</span>
                                </div>
                            </div>
                            
                            ` : S.cover.template==='superhero' ? `
                            <!-- SUPERHERO TEMPLATE -->
                            <div id="cover-front-content" onclick="showImageOptions('cover-front')" style="width:min(320px,46vw);height:min(480px,68vh);border-radius:8px;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,0.7),0 0 60px rgba(255,215,0,0.3);cursor:pointer;background:linear-gradient(180deg,#1a1a4e,#0a0a2e);display:flex;flex-direction:column;border:4px solid #ffd700">
                                <div style="padding:10px;text-align:center;background:linear-gradient(90deg,#c62828,#ffd700,#c62828)">
                                    <div style="font-family:'Bangers',cursive;font-size:clamp(18px,5vw,26px);color:#fff;text-shadow:2px 2px 0 #000;letter-spacing:3px">${S.cover.series || 'HERO COMICS'}</div>
                                </div>
                                <div style="flex:1;background:${S.cover.frontImage ? 'url('+S.cover.frontImage+') center/cover' : 'radial-gradient(circle at 50% 30%,#2a2a6e,#0a0a2e)'};position:relative;display:flex;flex-direction:column;justify-content:flex-end">
                                    ${!S.cover.frontImage ? '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:#ffd700">'+icon('image',56)+'</div>' : ''}
                                    <div style="background:linear-gradient(transparent,rgba(0,0,0,0.95));padding:20px">
                                        <div style="font-family:'Bangers',cursive;font-size:clamp(28px,8vw,44px);color:#ffd700;text-shadow:3px 3px 0 #c62828;letter-spacing:2px">${S.cover.title || 'UNSTOPPABLE'}</div>
                                        <div style="font-size:clamp(11px,3vw,14px);color:#fff">${S.cover.tagline || 'THE BATTLE FOR JUSTICE BEGINS!'}</div>
                                    </div>
                                </div>
                                <div style="padding:10px 14px;display:flex;justify-content:space-between;background:#0a0a2e;border-top:2px solid #ffd700">
                                    <span style="font-size:10px;color:#ffd700;font-weight:bold">${S.cover.issue || 'ISSUE #1'}</span>
                                    <span style="font-size:10px;color:#fff">${S.cover.price || '$4.99'}</span>
                                </div>
                            </div>
                            
                            ` : S.cover.template==='noir' ? `
                            <!-- NOIR TEMPLATE -->
                            <div id="cover-front-content" onclick="showImageOptions('cover-front')" style="width:min(320px,46vw);height:min(480px,68vh);border-radius:4px;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,0.9);cursor:pointer;background:#0a0a0a;display:flex;flex-direction:column;border:2px solid #444">
                                <div style="padding:14px;text-align:center;background:#111">
                                    <div style="font-family:Georgia,serif;font-size:clamp(10px,2.5vw,12px);color:#888;letter-spacing:4px;text-transform:uppercase">${S.cover.series || 'DARK DETECTIVE'}</div>
                                </div>
                                <div style="flex:1;background:${S.cover.frontImage ? 'url('+S.cover.frontImage+') center/cover' : '#1a1a1a'};position:relative;display:flex;flex-direction:column;justify-content:flex-end;filter:${S.cover.frontImage?'grayscale(60%) contrast(1.1)':'none'}">
                                    ${!S.cover.frontImage ? '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:#444">'+icon('image',56)+'</div>' : ''}
                                    <div style="background:linear-gradient(transparent,#000);padding:24px">
                                        <div style="font-family:Georgia,serif;font-size:clamp(24px,7vw,38px);color:#fff;font-style:italic;text-shadow:2px 2px 10px #000">${S.cover.title || 'SHADOWS'}</div>
                                        <div style="font-size:clamp(10px,2.5vw,13px);color:#c62828;font-style:italic">${S.cover.tagline || 'Some secrets are better left buried...'}</div>
                                    </div>
                                </div>
                                <div style="padding:12px;display:flex;justify-content:space-between;background:#0a0a0a;border-top:1px solid #333">
                                    <span style="font-size:10px;color:#666">${S.cover.issue || 'VOL. 1'}</span>
                                    <span style="font-size:10px;color:#666">${S.cover.price || '$5.99'}</span>
                                </div>
                            </div>
                            
                            ` : S.cover.template==='fantasy' ? `
                            <!-- FANTASY TEMPLATE -->
                            <div id="cover-front-content" onclick="showImageOptions('cover-front')" style="width:min(320px,46vw);height:min(480px,68vh);border-radius:8px;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,0.7),0 0 40px rgba(147,112,219,0.3);cursor:pointer;background:linear-gradient(180deg,#1a0a2a,#2a1a4a);display:flex;flex-direction:column;border:4px solid #9370db">
                                <div style="padding:12px;text-align:center;background:linear-gradient(90deg,#4a2c7a,#9370db,#4a2c7a)">
                                    <div style="font-family:'Bangers',cursive;font-size:clamp(14px,4vw,20px);color:#ffd700;letter-spacing:3px;text-shadow:1px 1px 2px #000">${S.cover.series || 'REALM OF LEGENDS'}</div>
                                </div>
                                <div style="flex:1;background:${S.cover.frontImage ? 'url('+S.cover.frontImage+') center/cover' : 'radial-gradient(ellipse at 50% 70%,#3a2a5a,#1a0a2a)'};position:relative;display:flex;flex-direction:column;justify-content:flex-end">
                                    ${!S.cover.frontImage ? '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:#9370db">'+icon('image',56)+'</div>' : ''}
                                    <div style="background:linear-gradient(transparent,rgba(26,10,42,0.95));padding:20px">
                                        <div style="font-family:'Bangers',cursive;font-size:clamp(26px,7vw,40px);color:#ffd700;text-shadow:2px 2px 8px #9370db;letter-spacing:2px">${S.cover.title || 'DESTINY'}</div>
                                        <div style="font-size:clamp(11px,3vw,14px);color:#dda0dd">${S.cover.tagline || 'Magic awakens in the darkest hour'}</div>
                                    </div>
                                </div>
                                <div style="padding:10px 14px;display:flex;justify-content:space-between;background:#1a0a2a;border-top:2px solid #9370db">
                                    <span style="font-size:10px;color:#9370db">${S.cover.issue || 'BOOK ONE'}</span>
                                    <span style="font-size:10px;color:#ffd700">${S.cover.price || '$4.99'}</span>
                                </div>
                            </div>
                            
                            ` : S.cover.template==='western' ? `
                            <!-- WESTERN TEMPLATE -->
                            <div id="cover-front-content" onclick="showImageOptions('cover-front')" style="width:min(320px,46vw);height:min(480px,68vh);border-radius:4px;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,0.7);cursor:pointer;background:#2a1a0a;display:flex;flex-direction:column;border:6px solid #8b4513">
                                <div style="padding:10px;text-align:center;background:linear-gradient(90deg,#5a3a1a,#8b4513,#5a3a1a)">
                                    <div style="font-family:'Bangers',cursive;font-size:clamp(16px,4vw,22px);color:#ffd700;letter-spacing:4px;text-shadow:2px 2px 0 #3a1a0a">${S.cover.series || 'FRONTIER TALES'}</div>
                                </div>
                                <div style="flex:1;background:${S.cover.frontImage ? 'url('+S.cover.frontImage+') center/cover' : 'linear-gradient(180deg,#d4a574,#8b4513)'};position:relative;display:flex;flex-direction:column;justify-content:flex-end">
                                    ${!S.cover.frontImage ? '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:#5a3a1a">'+icon('image',56)+'</div>' : ''}
                                    <div style="background:linear-gradient(transparent,rgba(42,26,10,0.95));padding:20px">
                                        <div style="font-family:'Bangers',cursive;font-size:clamp(26px,7vw,40px);color:#ffd700;text-shadow:3px 3px 0 #3a1a0a;letter-spacing:2px">${S.cover.title || 'OUTLAW'}</div>
                                        <div style="font-size:clamp(11px,3vw,14px);color:#d4a574">${S.cover.tagline || 'Justice rides at high noon'}</div>
                                    </div>
                                </div>
                                <div style="padding:10px 14px;display:flex;justify-content:space-between;background:#3a1a0a;border-top:3px solid #8b4513">
                                    <span style="font-size:10px;color:#d4a574">${S.cover.issue || 'ISSUE #1'}</span>
                                    <span style="font-size:10px;color:#ffd700">${S.cover.price || '$3.99'}</span>
                                </div>
                            </div>
                            
                            ` : S.cover.template==='romance' ? `
                            <!-- ROMANCE TEMPLATE -->
                            <div id="cover-front-content" onclick="showImageOptions('cover-front')" style="width:min(320px,46vw);height:min(480px,68vh);border-radius:12px;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,0.5),0 0 40px rgba(255,105,180,0.2);cursor:pointer;background:linear-gradient(180deg,#fff5f8,#ffe4ec);display:flex;flex-direction:column;border:3px solid #ff69b4">
                                <div style="padding:12px;text-align:center;background:linear-gradient(90deg,#ff69b4,#ff1493,#ff69b4)">
                                    <div style="font-family:Georgia,serif;font-size:clamp(12px,3vw,16px);color:#fff;letter-spacing:2px;font-style:italic">${S.cover.series || 'Hearts Aflame'}</div>
                                </div>
                                <div style="flex:1;background:${S.cover.frontImage ? 'url('+S.cover.frontImage+') center/cover' : 'linear-gradient(180deg,#ffe4ec,#ffb6c1)'};position:relative;display:flex;flex-direction:column;justify-content:flex-end">
                                    ${!S.cover.frontImage ? '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:#ff69b4">'+icon('image',56)+'</div>' : ''}
                                    <div style="background:linear-gradient(transparent,rgba(255,245,248,0.95));padding:20px;text-align:center">
                                        <div style="font-family:Georgia,serif;font-size:clamp(24px,6vw,36px);color:#c71585;font-style:italic">${S.cover.title || 'Forever Yours'}</div>
                                        <div style="font-size:clamp(10px,2.5vw,13px);color:#ff69b4;margin-top:8px">${S.cover.tagline || 'A love that defies all odds...'}</div>
                                    </div>
                                </div>
                                <div style="padding:10px 14px;display:flex;justify-content:space-between;background:#fff5f8;border-top:2px solid #ffb6c1">
                                    <span style="font-size:10px;color:#ff69b4">${S.cover.issue || 'Book 1'}</span>
                                    <span style="font-size:10px;color:#c71585">${S.cover.price || '$4.99'}</span>
                                </div>
                            </div>
                            
                            ` : `
                            <!-- CLASSIC TEMPLATE (default) -->
                            <div id="cover-front-content" onclick="triggerUpload('cover-front')" style="width:min(320px,46vw);height:min(480px,68vh);border-radius:8px;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,0.6);cursor:pointer;background:${S.cover.style==='dark'?'#0a0a0a':S.cover.style==='vintage'?'#f4e4c1':'#222'};display:flex;flex-direction:column">
                                <div style="padding:12px 14px;display:flex;justify-content:space-between;align-items:center;background:${S.cover.style==='dark'?'linear-gradient(90deg,#333,#444)':S.cover.style==='vintage'?'linear-gradient(90deg,#8b4513,#a0522d)':'linear-gradient(90deg,#c62828,#e53935)'}">
                                    <span style="font-family:'${S.cover.seriesFont||'Bangers'}',cursive;font-size:clamp(14px,3.5vw,20px);color:#fff;letter-spacing:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:65%">${S.cover.series || 'PRESS START'}</span>
                                    <span style="background:#fff;color:#c62828;padding:6px 12px;border-radius:4px;font-weight:800;font-size:clamp(12px,3vw,16px)">${S.cover.issue || '#1'}</span>
                                </div>
                                <div style="flex:1;background:${S.cover.frontImage ? 'url('+S.cover.frontImage+') center/cover' : '#333'};position:relative;display:flex;flex-direction:column;justify-content:flex-end;padding:16px">
                                    ${!S.cover.frontImage ? `<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:#666">${icon('image',56)}<br><span style="font-size:13px">TAP FOR IMAGE</span></div>` : ''}
                                    <div style="font-family:'${S.cover.titleFont||'Bangers'}',cursive;font-size:clamp(22px,6vw,36px);color:#fff;text-shadow:3px 3px 10px #000;letter-spacing:2px;word-wrap:break-word;overflow-wrap:break-word;line-height:1.1">${S.cover.title || 'ADVENTURE'}</div>
                                    <div style="font-size:clamp(11px,2.5vw,14px);color:#ffd700;text-shadow:1px 1px 4px #000;margin-top:4px">${S.cover.tagline || 'THE STORY BEGINS'}</div>
                                </div>
                                <div style="padding:10px 14px;display:flex;justify-content:space-between;font-size:clamp(9px,2vw,11px);color:${S.cover.style==='vintage'?'#5a3a1a':'#888'};background:${S.cover.style==='dark'?'#111':S.cover.style==='vintage'?'#d4c4a1':'#1a1a1a'}">
                                    <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:60%"> ${S.cover.author || 'Created by YOU'}</span>
                                    <span>${S.cover.price || '$4.99'}</span>
                                </div>
                            </div>
                            `}
                        </div>
                        
                        <!-- BACK COVER - BIGGER -->
                        <div style="text-align:center">
                            <div style="font-size:11px;color:#888;margin-bottom:6px;font-weight:600"> BACK COVER</div>
                            <div id="cover-back-content" style="width:min(320px,46vw);height:min(480px,68vh);border-radius:8px;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,0.6);background:${S.cover.backBgImage ? 'url('+S.cover.backBgImage+') center/cover' : S.cover.template==='horror'?'#0a0a0a':S.cover.template==='scifi'?'#030318':S.cover.template==='manga'?'#fff':S.cover.template==='retro'?'#f5e6d3':S.cover.template==='minimal'?'#fff':S.cover.style==='dark'?'#0a0a0a':S.cover.style==='vintage'?'#f4e4c1':'#222'};display:flex;flex-direction:column;position:relative;border:${S.cover.template==='horror'?'4px solid #3a0a0a':S.cover.template==='scifi'?'3px solid #00d4ff':S.cover.template==='manga'?'3px solid #e91e63':S.cover.template==='retro'?'6px solid #d4a574':S.cover.template==='minimal'?'2px solid #000':'none'}">
                                <!-- Background overlay when bg image is set -->
                                ${S.cover.backBgImage ? `<div style="position:absolute;inset:0;background:${S.cover.template==='horror'?'rgba(10,10,10,0.85)':S.cover.template==='scifi'?'rgba(3,3,24,0.85)':S.cover.template==='manga'?'rgba(255,255,255,0.9)':S.cover.template==='retro'?'rgba(245,230,211,0.85)':S.cover.template==='minimal'?'rgba(255,255,255,0.9)':'rgba(34,34,34,0.85)'};pointer-events:none"></div>` : ''}
                                <div style="position:relative;z-index:1;padding:18px;display:flex;flex-direction:column;height:100%">
                                    <div onclick="showImageOptions('cover-back')" style="height:110px;margin-bottom:14px;background:${S.cover.backImage ? 'url('+S.cover.backImage+') center/cover' : S.cover.template==='manga'?'#fce4ec':'#1a1a2e'};border-radius:6px;display:flex;align-items:center;justify-content:center;cursor:pointer">
                                        ${!S.cover.backImage ? `<span style="color:#555;font-size:13px">${icon('image',36)} Add Image</span>` : ''}
                                    </div>
                                    <div style="flex:1;overflow:auto;font-size:clamp(11px,2.8vw,14px);color:${S.cover.template==='manga'?'#333':S.cover.template==='minimal'?'#333':S.cover.style==='vintage'||S.cover.template==='retro'?'#5a3a1a':'#ccc'};line-height:1.7">${S.cover.backText || 'Your back cover story description goes here. This is where you hook readers with an exciting synopsis of your comic!'}</div>
                                    <div style="font-size:clamp(9px,2.2vw,11px);color:${S.cover.template==='manga'?'#e91e63':S.cover.style==='vintage'||S.cover.template==='retro'?'#8b4513':'#888'};margin:12px 0;white-space:pre-line">${S.cover.credits || 'Art & Story: Your Name'}</div>
                                    <div style="display:flex;justify-content:space-between;align-items:flex-end;padding-top:12px;border-top:1px solid ${S.cover.template==='manga'?'#fce4ec':S.cover.template==='minimal'?'#eee':'rgba(255,255,255,0.1)'}">
                                        <div>
                                            <div style="font-size:clamp(9px,2.2vw,11px);color:#666">${S.cover.website || 'pscomixx.online'}</div>
                                            <div style="font-size:clamp(8px,2vw,10px);color:#555"> PRESS START CoMixx</div>
                                        </div>
                                        <div onclick="triggerUpload('cover-barcode')" style="width:50px;height:60px;background:${S.cover.barcodeImage ? 'url('+S.cover.barcodeImage+') center/cover' : '#fff'};border-radius:3px;cursor:pointer;display:flex;align-items:center;justify-content:center">
                                            ${!S.cover.barcodeImage ? `<div style="font-size:7px;color:#333;text-align:center">BARCODE</div>` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cover Toolbar -->
                    <div style="display:flex;gap:8px;padding:12px;background:var(--studio-sidebar);border-top:1px solid var(--studio-border);justify-content:center;flex-wrap:wrap">
                        <button onclick="S.activeSheet='cover-presets';render()" style="padding:10px 16px;border-radius:6px;border:1px solid var(--studio-border);background:transparent;color:var(--studio-text);font-size:12px;cursor:pointer;display:flex;align-items:center;gap:6px"> Style</button>
                        <button onclick="S.activeSheet='cover-edit';render()" style="padding:10px 16px;border-radius:6px;border:1px solid var(--studio-border);background:transparent;color:var(--studio-text);font-size:12px;cursor:pointer;display:flex;align-items:center;gap:6px">${icon('edit', 14)} Edit</button>
                        <button onclick="showImageOptions('cover-front')" style="padding:10px 16px;border-radius:6px;border:1px solid var(--studio-border);background:transparent;color:var(--studio-text);font-size:12px;cursor:pointer;display:flex;align-items:center;gap:6px">${icon('image', 14)} Photo</button>
                        <button onclick="shareToFeed()" style="padding:10px 16px;border-radius:6px;border:1px solid #f0f;background:linear-gradient(135deg,rgba(0,255,255,0.1),rgba(255,0,255,0.1));color:#fff;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:6px;box-shadow:0 0 10px rgba(255,0,255,0.3)"> Post</button>
                        <button onclick="saveToPhotos('cover')" style="padding:10px 16px;border-radius:6px;border:1px solid var(--studio-accent);background:var(--studio-accent);color:var(--studio-bg);font-size:12px;cursor:pointer;display:flex;align-items:center;gap:6px;font-weight:600">${icon('save', 14)} Save</button>
                    </div>
                </div>
                ` : ''}
                
                <div class="tab-content ${S.activeTab === 'share' ? 'active' : ''}">
                </div>
                
                ${S.activeTab === 'share' ? `
                <!-- SHARE - Full Screen Overlay -->
                <div style="position:fixed;inset:0;background:var(--studio-bg);z-index:500;display:flex;flex-direction:column;overflow:hidden">
                    
                    <!-- Close Button -->
                    <button onclick="S.activeTab='comic';render()" style="position:fixed;top:max(20px, env(safe-area-inset-top, 20px));right:16px;width:44px;height:44px;border-radius:8px;border:1px solid var(--studio-border);background:var(--studio-sidebar);color:var(--studio-text);font-size:20px;cursor:pointer;z-index:9999;display:flex;align-items:center;justify-content:center">${icon('x', 20)}</button>
                    
                    <!-- Header -->
                    <div style="display:flex;align-items:center;gap:12px;padding:16px 20px;padding-top:max(16px, env(safe-area-inset-top, 16px));background:var(--studio-sidebar);border-bottom:1px solid var(--studio-border)">
                        <div style="width:40px;height:40px;background:var(--studio-accent);border-radius:10px;display:flex;align-items:center;justify-content:center;color:var(--studio-bg)">${icon('share', 20)}</div>
                        <div>
                            <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--studio-text);letter-spacing:2px">SHARE & EXPORT</div>
                            <div style="font-size:10px;color:var(--studio-text-muted)">Publish your creation</div>
                        </div>
                    </div>
                    
                    <div style="flex:1;overflow-y:auto;padding:16px">
                        <div style="max-width:500px;margin:0 auto">
                            
                            <div style="background:var(--studio-sidebar);border:1px solid var(--studio-border);border-radius:12px;padding:16px;margin-bottom:16px">
                                <div style="font-weight:bold;color:var(--studio-text);margin-bottom:12px;display:flex;align-items:center;gap:8px">${icon('edit', 16)} Comic Details</div>
                                <div style="display:grid;gap:12px">
                                    <div>
                                        <label style="font-size:12px;color:var(--studio-text-muted);display:block;margin-bottom:4px">Comic Title</label>
                                        <input type="text" value="${S.shareTitle || S.cover.title || 'My Comic'}" onchange="S.shareTitle=this.value" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--studio-border);background:var(--studio-bg);color:var(--studio-text);font-size:16px">
                                    </div>
                                    <div>
                                        <label style="font-size:12px;color:var(--studio-text-muted);display:block;margin-bottom:4px">Creator Name</label>
                                        <input type="text" value="${S.creatorName || ''}" onchange="S.creatorName=this.value" placeholder="Your name" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--studio-border);background:var(--studio-bg);color:var(--studio-text);font-size:16px">
                                    </div>
                                    <div>
                                        <label style="font-size:12px;color:var(--studio-text-muted);display:block;margin-bottom:4px">Description</label>
                                        <textarea onchange="S.shareDesc=this.value" placeholder="Tell us about your comic..." style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--studio-border);background:var(--studio-bg);color:var(--studio-text);font-size:14px;min-height:80px;resize:none">${S.shareDesc || ''}</textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background:var(--studio-sidebar);border:1px solid var(--studio-border);border-radius:12px;padding:16px;margin-bottom:16px">
                                <div style="font-weight:bold;color:var(--studio-text);margin-bottom:12px;display:flex;align-items:center;gap:8px">${icon('layers', 16)} Comic Stats</div>
                                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;text-align:center">
                                    <div style="background:var(--studio-bg);padding:12px;border-radius:8px;border:1px solid var(--studio-border)">
                                        <div style="font-size:24px;color:var(--studio-text);font-weight:bold">${S.pages.length}</div>
                                        <div style="font-size:11px;color:var(--studio-text-muted)">Pages</div>
                                    </div>
                                    <div style="background:var(--studio-bg);padding:12px;border-radius:8px;border:1px solid var(--studio-border)">
                                        <div style="font-size:24px;color:var(--studio-text);font-weight:bold">${S.pages.reduce((t,p) => t + Object.keys(p.panelMedia || {}).length, 0)}</div>
                                        <div style="font-size:11px;color:var(--studio-text-muted)">Images</div>
                                    </div>
                                    <div style="background:var(--studio-bg);padding:12px;border-radius:8px;border:1px solid var(--studio-border)">
                                        <div style="font-size:24px;color:var(--studio-text);font-weight:bold">${S.pages.reduce((t,p) => t + (p.pageElements || []).length, 0)}</div>
                                        <div style="font-size:11px;color:var(--studio-text-muted)">Elements</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background:var(--studio-accent);border-radius:12px;padding:16px;margin-bottom:16px">
                                <div style="font-weight:bold;color:var(--studio-bg);margin-bottom:8px;display:flex;align-items:center;gap:8px">${icon('globe', 16)} Publish to Community</div>
                                <p style="font-size:13px;color:var(--studio-bg);opacity:0.8;margin-bottom:12px">Share your comic on psstreaming.online for others to read!</p>
                                <button onclick="publishToCommunity()" style="width:100%;padding:14px;background:var(--studio-bg);color:var(--studio-text);font-weight:bold;font-size:16px;border:none;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px">
                                    ${icon('upload', 20)} PUBLISH NOW
                                </button>
                            </div>
                            
                            <div style="background:var(--studio-sidebar);border:1px solid var(--studio-border);border-radius:12px;padding:16px;margin-bottom:16px">
                                <div style="font-weight:bold;color:var(--studio-text);margin-bottom:12px;display:flex;align-items:center;gap:8px">${icon('download', 16)} Export Options</div>
                                <div style="display:grid;gap:8px">
                                    <button onclick="exportAllPages()" style="width:100%;padding:12px;background:var(--studio-bg);color:var(--studio-text);border:1px solid var(--studio-border);border-radius:8px;cursor:pointer;text-align:left;display:flex;align-items:center;gap:12px">
                                        <span style="font-size:24px"></span>
                                        <div>
                                            <div style="font-weight:bold">Export All Pages</div>
                                            <div style="font-size:11px;color:var(--studio-text-muted)">Save each page as an image</div>
                                        </div>
                                    </button>
                                    <button onclick="exportFullComic()" style="width:100%;padding:12px;background:var(--studio-bg);color:var(--studio-text);border:1px solid var(--studio-border);border-radius:8px;cursor:pointer;text-align:left;display:flex;align-items:center;gap:12px">
                                        <span style="font-size:24px"></span>
                                        <div>
                                            <div style="font-weight:bold">Export Full Comic</div>
                                            <div style="font-size:11px;color:var(--studio-text-muted)">Cover + Pages + Card (in order)</div>
                                        </div>
                                    </button>
                                    <button onclick="shareToSocial()" style="width:100%;padding:12px;background:var(--studio-bg);color:var(--studio-text);border:1px solid var(--studio-border);border-radius:8px;cursor:pointer;text-align:left;display:flex;align-items:center;gap:12px">
                                        <span style="font-size:24px"></span>
                                        <div>
                                            <div style="font-weight:bold">Share to Social</div>
                                            <div style="font-size:11px;color:var(--studio-text-muted)">Instagram, TikTok, Twitter</div>
                                        </div>
                                    </button>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
                ` : ''}
            </div>
            <div class="bottom-nav">
                <div class="nav-item neon ${S.activeTab === 'comic' ? 'active' : ''}" onclick="S.activeTab='comic';render()">${icon('grid', 22)}<span>COMIC</span></div>
                <div class="nav-item neon ${S.activeTab === 'card' ? 'active' : ''}" onclick="S.activeTab='card';render()">${icon('star', 22)}<span>CARD</span></div>
                <div class="nav-item neon ${S.activeTab === 'cover' ? 'active' : ''}" onclick="S.activeTab='cover';render()">${icon('book', 22)}<span>COVER</span></div>
                <div class="nav-item neon ${S.activeTab === 'share' ? 'active' : ''}" onclick="S.activeTab='share';render()">${icon('share', 22)}<span>SHARE</span></div>
            </div>
            </div>
            ${renderSheets()}
            ${renderModal()}
            ${renderSavePreview()}
            ${renderSaveHelp()}
            ${renderUpgradeModal()}
            ${renderFullscreenPost()}
            ${renderPreviewMode()}
            ${renderMediaEditor()}
            ${renderDrawMode()}
            ${renderAnimateMode()}
            ${renderBattleMode()}
            ${renderMultiplayerLobby()}
            ${renderMultiplayerBattle()}
            ${renderPackShop()}
            ${renderPackOpening()}
            ${renderEcosystemScreens()}
            ${renderAIGenModal()}
            ${renderImageOptionsModal()}
            ${renderToast()}`;
        } catch(e) {
            console.error('Render error:', e);
            // Show error recovery UI
            const app = document.getElementById('app');
            if (app) {
                app.innerHTML = '<div style="color:#fff;padding:40px;text-align:center"><div style="font-size:48px;margin-bottom:16px"></div><h2>Something went wrong</h2><p style="color:#888;margin:16px 0">Try refreshing the page</p><button onclick="location.reload()" style="padding:12px 24px;background:#fff;color:#000;border:none;border-radius:8px;font-weight:bold;cursor:pointer">Reload</button></div>';
            }
        }
    }

    function renderSheets() {
        return `
            <div class="overlay ${S.activeSheet ? 'show' : ''}" onclick="S.activeSheet=null;render()"></div>
            
            <div class="sheet ${S.activeSheet === 'templates' ? 'show' : ''}">
                <div class="sheet-handle"></div>
                <div class="sheet-header"><span class="sheet-title">LAYOUTS</span><button class="sheet-close" onclick="S.activeSheet=null;render()">${icon('x', 18)}</button></div>
                <div class="sheet-body" style="max-height:65vh">
                    <div class="grid-3">${TEMPLATES.map(t => `
                        <div style="text-align:center">
                            <div class="template-card ${getPage().templateId === t.id ? 'selected' : ''}" onclick="applyTemplate('${t.id}')">
                                ${t.panels.map(p => `<div class="mini-panel" style="left:${p.x}%;top:${p.y}%;width:${p.w}%;height:${p.h}%;${p.skew ? 'transform:skewX('+p.skew+'deg)' : ''}"></div>`).join('')}
                            </div>
                            <div style="font-size:10px;color:#888;margin-top:4px">${t.name}</div>
                        </div>`).join('')}
                    </div>
                </div>
            </div>
            
            <div class="sheet ${S.activeSheet === 'filters' ? 'show' : ''}">
                <div class="sheet-handle"></div>
                <div class="sheet-header"><span class="sheet-title">PANEL FILTERS</span><button class="sheet-close" onclick="S.activeSheet=null;render()">${icon('x', 18)}</button></div>
                <div class="sheet-body">
                    <div class="grid-3">${FILTERS.map(f => `
                        <div class="option-btn" onclick="applyFilter('${f.id}')" style="padding:8px;${getPage().panelFilters && getPage().panelFilters[S.selectedPanel] === f.id ? 'border-color:#fff' : ''}">
                            <div style="width:100%;height:40px;background:#666;border-radius:6px;${f.css ? 'filter:'+f.css : ''};margin-bottom:4px"></div>
                            <div style="font-size:11px;color:#fff">${f.name}</div>
                        </div>`).join('')}
                    </div>
                </div>
            </div>
            
            <div class="sheet ${S.activeSheet === 'bubbles' ? 'show' : ''}">
                <div class="sheet-handle"></div>
                <div class="sheet-header"><span class="sheet-title">BUBBLES</span><button class="sheet-close" onclick="S.activeSheet=null;render()">${icon('x', 18)}</button></div>
                <div class="sheet-body">
                    <div class="grid-3">${BUBBLES.map(b => `
                        <div class="option-btn" onclick="startBubble('${b.cls}')">
                            <div class="bubble ${b.cls}" style="transform:scale(0.7);font-size:12px">${b.name}</div>
                        </div>`).join('')}
                    </div>
                </div>
            </div>
            
            <div class="sheet ${S.activeSheet === 'enter-text' ? 'show' : ''}">
                <div class="sheet-handle"></div>
                <div class="sheet-header"><span class="sheet-title">ENTER TEXT</span><button class="sheet-close" onclick="S.activeSheet=null;render()">${icon('x', 18)}</button></div>
                <div class="sheet-body">
                    <textarea class="input" rows="3" placeholder="Type your text..." oninput="S.editText=this.value">${S.editText}</textarea>
                    <button class="btn btn-primary" onclick="confirmText()">ADD TO COMIC</button>
                </div>
            </div>
            
            <div class="sheet ${S.activeSheet === 'effects' ? 'show' : ''}" style="max-height:80vh">
                <div class="sheet-handle"></div>
                <div class="sheet-header"><span class="sheet-title">EFFECTS</span><button class="sheet-close" onclick="S.activeSheet=null;render()">${icon('x', 18)}</button></div>
                <div style="display:flex;gap:4px;padding:8px 12px;overflow-x:auto;background:#111;border-bottom:1px solid #333">
                    ${[' Classic',' Action',' Impact',' Sounds',' Gen-Z'].map((cat, i) => `
                        <button onclick="S.effectCat=${i};render()" style="padding:6px 12px;border-radius:16px;border:none;background:${S.effectCat===i?'#fff':'#222'};color:${S.effectCat===i?'#000':'#888'};font-size:11px;white-space:nowrap;cursor:pointer">${cat}</button>
                    `).join('')}
                </div>
                <div class="sheet-body" style="max-height:50vh;overflow-y:auto">
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
                        ${(() => {
                            const cats = [
                                EFFECTS.slice(0, 6),    // Classic
                                EFFECTS.slice(6, 12),   // Action
                                EFFECTS.slice(12, 18),  // Impact
                                EFFECTS.slice(18, 24),  // Sounds
                                EFFECTS.slice(24, 36)   // Gen-Z
                            ];
                            const selectedCat = cats[S.effectCat || 0] || cats[0];
                            return selectedCat.map(e => 
                                e.color === 'custom' 
                                ? '<div class="effect-btn" style="background:linear-gradient(135deg,#ff0000,#ff9800,#ffeb3b,#4caf50,#2196f3,#9c27b0)" onclick="startCustomEffect()"> CUSTOM</div>'
                                : '<div class="effect-btn" style="background:' + e.color + '" onclick="addEffect(\'' + e.text + '\',\'' + e.color + '\')">' + e.text + '</div>'
                            ).join('');
                        })()}
                    </div>
                    <div style="margin-top:16px;text-align:center">
                        <button onclick="startCustomEffect()" style="padding:12px 24px;border-radius:20px;border:none;background:linear-gradient(135deg,#ff0000,#ff9800,#ffeb3b,#4caf50,#2196f3,#9c27b0);color:#fff;font-weight:700;font-size:14px;cursor:pointer"> CREATE CUSTOM EFFECT</button>
                    </div>
                </div>
            </div>
            
            <div class="sheet ${S.activeSheet === 'custom-effect' ? 'show' : ''}">
                <div class="sheet-handle"></div>
                <div class="sheet-header"><span class="sheet-title">CUSTOM EFFECT</span><button class="sheet-close" onclick="S.activeSheet=null;render()">${icon('x', 18)}</button></div>
                <div class="sheet-body">
                    <label style="font-size:12px;color:#888;margin-bottom:8px;display:block">YOUR TEXT (will be UPPERCASE)</label>
                    <input class="input" placeholder="SKIBIDI! RIZZ! NO CAP!" value="${S.editText}" oninput="S.editText=this.value" style="text-transform:uppercase;font-family:'Bangers',cursive;font-size:20px">
                    <label style="font-size:12px;color:#888;margin:12px 0 8px;display:block">PICK A COLOR</label>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px">
                        ${EFFECT_COLORS.map(c => `<div onclick="S.effectColor='${c}';render()" style="width:40px;height:40px;border-radius:10px;background:${c};cursor:pointer;border:3px solid ${S.effectColor===c?'#fff':'transparent'}"></div>`).join('')}
                    </div>
                    <div style="text-align:center;padding:20px;background:#1a1a1a;border-radius:12px;margin-bottom:16px">
                        <span style="font-family:'Bangers',cursive;font-size:28px;color:${S.effectColor};text-shadow:2px 2px 0 rgba(0,0,0,0.5)">${S.editText.toUpperCase() || 'PREVIEW'}</span>
                    </div>
                    <button class="btn btn-primary" onclick="confirmText()">ADD EFFECT</button>
                </div>
            </div>
            
            <div class="sheet ${S.activeSheet === 'emoji' ? 'show' : ''}" style="max-height:80vh">
                <div class="sheet-handle"></div>
                <div class="sheet-header"><span class="sheet-title">EMOJI</span><button class="sheet-close" onclick="S.activeSheet=null;render()">${icon('x', 18)}</button></div>
                <div style="display:flex;gap:4px;padding:8px 12px;overflow-x:auto;background:#111;border-bottom:1px solid #333">
                    ${[' Faces',' Hands',' People',' Animals',' Nature',' Food',' Sports',' Objects',' Symbols',' Special'].map((cat, i) => `
                        <button onclick="S.emojiCat=${i};render()" style="padding:6px 12px;border-radius:16px;border:none;background:${S.emojiCat===i?'#fff':'#222'};color:${S.emojiCat===i?'#000':'#888'};font-size:11px;white-space:nowrap;cursor:pointer">${cat}</button>
                    `).join('')}
                </div>
                <div class="sheet-body" style="max-height:50vh;overflow-y:auto">
                    <div style="display:grid;grid-template-columns:repeat(8,1fr);gap:4px">
                        ${(() => {
                            const cats = [
                                EMOJIS.slice(0, 93),   // Faces
                                EMOJIS.slice(93, 142), // Gestures
                                EMOJIS.slice(142, 192),// People
                                EMOJIS.slice(192, 272),// Animals
                                EMOJIS.slice(272, 320),// Nature
                                EMOJIS.slice(320, 384),// Food
                                EMOJIS.slice(384, 464),// Activities
                                EMOJIS.slice(464, 544),// Objects
                                EMOJIS.slice(544, 680),// Symbols
                                EMOJIS.slice(680)      // Special
                            ];
                            const selectedCat = cats[S.emojiCat || 0] || cats[0];
                            return selectedCat.map(e => 
                                '<div onclick="addElement(\'emoji\',{emoji:\'' + e + '\'})" style="font-size:28px;padding:8px;cursor:pointer;text-align:center;border-radius:8px;background:#1a1a1a;transition:transform 0.1s" onmouseover="this.style.transform=\'scale(1.2)\'" onmouseout="this.style.transform=\'scale(1)\'">' + e + '</div>'
                            ).join('');
                        })()}
                    </div>
                </div>
            </div>
            
            <div class="sheet ${S.activeSheet === 'card-edit' ? 'show' : ''}">
                <div class="sheet-handle"></div>
                <div class="sheet-header"><span class="sheet-title"> CARD EDITOR</span><button class="sheet-close" onclick="S.activeSheet=null;render()">${icon('x', 18)}</button></div>
                <div class="sheet-body" style="max-height:75vh;overflow-y:auto;padding-bottom:80px">
                    
                    <!-- CARD INFO -->
                    <div style="font-size:12px;color:#999;font-weight:bold;margin-bottom:10px;display:flex;align-items:center;gap:6px"> CARD INFO</div>
                    
                    <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">CARD TITLE (top banner)</label>
                    <input class="input" placeholder="HERO CARD, BATTLE CARD..." value="${S.card.title||''}" onchange="S.card.title=this.value;render()">
                    
                    <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">CHARACTER NAME</label>
                    <input class="input" placeholder="Character Name" value="${S.card.name||''}" onchange="S.card.name=this.value;render()">
                    
                    <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">REAL NAME (secret identity)</label>
                    <input class="input" placeholder="Peter Parker, Bruce Wayne..." value="${S.card.realName || ''}" onchange="S.card.realName=this.value;render()">
                    
                    <div style="display:flex;gap:8px">
                        <div style="flex:1">
                            <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">CARD NUMBER</label>
                            <input class="input" placeholder="#001, 102a..." value="${S.card.cardNumber||''}" onchange="S.card.cardNumber=this.value;render()">
                        </div>
                        <div style="flex:1">
                            <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">EDITION</label>
                            <input class="input" placeholder="1 of 25, LIMITED..." value="${S.card.edition||''}" onchange="S.card.edition=this.value;render()">
                        </div>
                    </div>
                    
                    <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">SOCIAL HANDLE</label>
                    <input class="input" placeholder="@username" value="${S.card.handle||''}" onchange="S.card.handle=this.value;render()">
                    
                    <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">AFFILIATION / TEAM</label>
                    <input class="input" placeholder="Avengers, X-Men, Villain..." value="${S.card.affiliation || ''}" onchange="S.card.affiliation=this.value;render()">
                    
                    <!-- SPORTS CARD FIELDS -->
                    <div style="font-size:12px;color:#999;font-weight:bold;margin:16px 0 10px;display:flex;align-items:center;gap:6px"> SPORTS CARD INFO</div>
                    <p style="font-size:10px;color:#666;margin:0 0 8px 0">For Sports template - leave blank if not using</p>
                    
                    <div style="display:flex;gap:8px">
                        <div style="flex:1">
                            <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">TEAM</label>
                            <input class="input" placeholder="Lakers, Warriors..." value="${S.card.team||''}" onchange="S.card.team=this.value;render()">
                        </div>
                        <div style="flex:1">
                            <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">POSITION</label>
                            <input class="input" placeholder="PG, SF, QB..." value="${S.card.position||''}" onchange="S.card.position=this.value;render()">
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:8px">
                        <div style="flex:1">
                            <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">JERSEY #</label>
                            <input class="input" placeholder="23, 30..." value="${S.card.jersey||''}" onchange="S.card.jersey=this.value;render()">
                        </div>
                        <div style="flex:1">
                            <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">SEASON</label>
                            <input class="input" placeholder="2025, 2024-25..." value="${S.card.season||''}" onchange="S.card.season=this.value;render()">
                        </div>
                    </div>
                    
                    <!-- RARITY (affects point pool) -->
                    <div style="font-size:12px;color:#999;font-weight:bold;margin:16px 0 10px;display:flex;align-items:center;gap:6px"> RARITY & POINT POOL</div>
                    
                    <div style="background:rgba(0,0,0,0.3);border-radius:12px;padding:12px;margin-bottom:12px">
                        <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px">
                            ${['COMMON','UNCOMMON','RARE','EPIC','LEGENDARY','MYTHIC'].map(r => `
                                <div onclick="setCardRarity('${r}')" style="padding:6px 12px;border-radius:16px;background:${S.card.rarity===r?getRarityGradient(r):'rgba(255,255,255,0.05)'};color:${S.card.rarity===r?(['LEGENDARY','MYTHIC'].includes(r)?'#000':'#fff'):'#666'};font-size:10px;cursor:pointer;border:2px solid ${S.card.rarity===r?'#fff':'transparent'};font-weight:600">${r}</div>
                            `).join('')}
                        </div>
                        <div style="display:flex;justify-content:space-between;font-size:11px;color:#888">
                            <span>Point Pool: <b style="color:${getRarityColor(S.card.rarity)}">${getPointPool()}</b></span>
                            <span>Used: <b style="color:${getPointsRemaining()>=0?'#fff':'#888'}">${getPointsUsed()}</b></span>
                            <span>Remaining: <b style="color:${getPointsRemaining()>0?'#fff':getPointsRemaining()<0?'#888':'#999'}">${getPointsRemaining()}</b></span>
                        </div>
                    </div>
                    
                    <!-- STATS WITH SLIDERS -->
                    <div style="font-size:12px;color:#999;font-weight:bold;margin:16px 0 10px;display:flex;align-items:center;gap:6px"> DISTRIBUTE YOUR STATS</div>
                    <p style="font-size:11px;color:#666;margin:0 0 12px 0">You have <b style="color:${getRarityColor(S.card.rarity)}">${getPointPool()}</b> points to spend. Max 100 per stat.</p>
                    
                    <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:12px">
                        <!-- STAT 1 -->
                        <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:10px">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                                <input class="input" placeholder="PWR" value="${S.card.stat1Label||'PWR'}" onchange="S.card.stat1Label=this.value;render()" style="width:60px;padding:4px 8px;font-size:11px;margin:0">
                                <span style="font-size:18px;font-weight:bold;color:#fff;min-width:40px;text-align:right">${S.card.stats?.pwr||50}</span>
                            </div>
                            <input type="range" min="0" max="100" value="${S.card.stats?.pwr||50}" onchange="updateStat('pwr',this.value)" oninput="this.nextElementSibling.style.width=this.value+'%'" style="width:100%;height:8px;border-radius:4px;appearance:none;background:linear-gradient(90deg,#fff ${S.card.stats?.pwr||50}%,#333 ${S.card.stats?.pwr||50}%);cursor:pointer">
                            <div style="height:2px;background:#fff;border-radius:2px;margin-top:-10px;pointer-events:none;width:${S.card.stats?.pwr||50}%"></div>
                        </div>
                        
                        <!-- STAT 2 -->
                        <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:10px">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                                <input class="input" placeholder="SPD" value="${S.card.stat2Label||'SPD'}" onchange="S.card.stat2Label=this.value;render()" style="width:60px;padding:4px 8px;font-size:11px;margin:0">
                                <span style="font-size:18px;font-weight:bold;color:#ddd;min-width:40px;text-align:right">${S.card.stats?.spd||50}</span>
                            </div>
                            <input type="range" min="0" max="100" value="${S.card.stats?.spd||50}" onchange="updateStat('spd',this.value)" style="width:100%;height:8px;border-radius:4px;appearance:none;background:linear-gradient(90deg,#ddd ${S.card.stats?.spd||50}%,#333 ${S.card.stats?.spd||50}%);cursor:pointer">
                        </div>
                        
                        <!-- STAT 3 -->
                        <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:10px">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                                <input class="input" placeholder="INT" value="${S.card.stat3Label||'INT'}" onchange="S.card.stat3Label=this.value;render()" style="width:60px;padding:4px 8px;font-size:11px;margin:0">
                                <span style="font-size:18px;font-weight:bold;color:#fff;min-width:40px;text-align:right">${S.card.stats?.int||50}</span>
                            </div>
                            <input type="range" min="0" max="100" value="${S.card.stats?.int||50}" onchange="updateStat('int',this.value)" style="width:100%;height:8px;border-radius:4px;appearance:none;background:linear-gradient(90deg,#fff ${S.card.stats?.int||50}%,#333 ${S.card.stats?.int||50}%);cursor:pointer">
                        </div>
                    </div>
                    
                    <!-- COLORS -->
                    <div style="font-size:12px;color:#999;font-weight:bold;margin:16px 0 10px;display:flex;align-items:center;gap:6px"> CUSTOM COLORS</div>
                    
                    <div style="display:flex;gap:8px;margin-bottom:12px">
                        <div style="flex:1">
                            <label style="font-size:10px;color:#666">BORDER COLOR</label>
                            <input type="color" value="${S.card.borderColor||'#999'}" onchange="S.card.borderColor=this.value;render()" style="width:100%;height:40px;border:none;border-radius:8px;cursor:pointer">
                        </div>
                        <div style="flex:1">
                            <label style="font-size:10px;color:#666">ACCENT COLOR</label>
                            <input type="color" value="${S.card.accentColor||'#bbb'}" onchange="S.card.accentColor=this.value;render()" style="width:100%;height:40px;border:none;border-radius:8px;cursor:pointer">
                        </div>
                        <div style="flex:1">
                            <label style="font-size:10px;color:#666">TEXT COLOR</label>
                            <input type="color" value="${S.card.textColor||'#ffffff'}" onchange="S.card.textColor=this.value;render()" style="width:100%;height:40px;border:none;border-radius:8px;cursor:pointer">
                        </div>
                    </div>
                    
                    <!-- EFFECTS -->
                    <div style="font-size:12px;color:#999;font-weight:bold;margin:16px 0 10px;display:flex;align-items:center;gap:6px"> EFFECTS</div>
                    
                    <label style="font-size:11px;color:#888;margin-bottom:8px;display:block">HOLOGRAPHIC EFFECT</label>
                    <div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap">
                        <div onclick="S.card.holoEffect='none';render()" style="padding:8px 14px;border-radius:20px;background:${!S.card.holoEffect||S.card.holoEffect==='none'?'#333':'#1a1a2e'};color:#fff;font-size:11px;cursor:pointer;border:2px solid ${!S.card.holoEffect||S.card.holoEffect==='none'?'#999':'transparent'}">None</div>
                        <div onclick="S.card.holoEffect='rainbow';render()" style="padding:8px 14px;border-radius:20px;background:${S.card.holoEffect==='rainbow'?'linear-gradient(90deg,#ff0,#0ff,#f0f)':'#1a1a2e'};color:#fff;font-size:11px;cursor:pointer;border:2px solid ${S.card.holoEffect==='rainbow'?'#fff':'transparent'}"> Rainbow</div>
                        <div onclick="S.card.holoEffect='gold';render()" style="padding:8px 14px;border-radius:20px;background:${S.card.holoEffect==='gold'?'linear-gradient(135deg,#c9a227,#f4d03f)':'#1a1a2e'};color:#000;font-size:11px;cursor:pointer;border:2px solid ${S.card.holoEffect==='gold'?'#fff':'transparent'}"> Gold Foil</div>
                        <div onclick="S.card.holoEffect='silver';render()" style="padding:8px 14px;border-radius:20px;background:${S.card.holoEffect==='silver'?'linear-gradient(135deg,#888,#ddd)':'#1a1a2e'};color:#000;font-size:11px;cursor:pointer;border:2px solid ${S.card.holoEffect==='silver'?'#fff':'transparent'}"> Silver</div>
                    </div>
                    
                    <label style="font-size:11px;color:#888;margin-bottom:8px;display:block">TEXTURE OVERLAY</label>
                    <div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap">
                        <div onclick="S.card.texture='none';render()" style="padding:8px 14px;border-radius:20px;background:${!S.card.texture||S.card.texture==='none'?'#333':'#1a1a2e'};color:#fff;font-size:11px;cursor:pointer;border:2px solid ${!S.card.texture||S.card.texture==='none'?'#999':'transparent'}">None</div>
                        <div onclick="S.card.texture='halftone';render()" style="padding:8px 14px;border-radius:20px;background:${S.card.texture==='halftone'?'#333':'#1a1a2e'};color:#fff;font-size:11px;cursor:pointer;border:2px solid ${S.card.texture==='halftone'?'#999':'transparent'}"> Halftone</div>
                        <div onclick="S.card.texture='noise';render()" style="padding:8px 14px;border-radius:20px;background:${S.card.texture==='noise'?'#333':'#1a1a2e'};color:#fff;font-size:11px;cursor:pointer;border:2px solid ${S.card.texture==='noise'?'#999':'transparent'}"> Noise</div>
                        <div onclick="S.card.texture='paper';render()" style="padding:8px 14px;border-radius:20px;background:${S.card.texture==='paper'?'#333':'#1a1a2e'};color:#fff;font-size:11px;cursor:pointer;border:2px solid ${S.card.texture==='paper'?'#999':'transparent'}"> Paper</div>
                    </div>
                    
                    <!-- BACK OF CARD -->
                    <div style="font-size:12px;color:#999;font-weight:bold;margin:16px 0 10px;display:flex;align-items:center;gap:6px"> BACK OF CARD</div>
                    
                    <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">BACK TITLE (header)</label>
                    <input class="input" placeholder="ORIGIN STORY, STATS, INFO..." value="${S.card.backTitle || ''}" onchange="S.card.backTitle=this.value;render()">
                    
                    <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">BIO / DESCRIPTION</label>
                    <textarea class="input" rows="3" placeholder="Character backstory, powers, origin..." onchange="S.card.bio=this.value;render()" style="resize:none">${S.card.bio || ''}</textarea>
                    
                    <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">ABILITIES / POWERS</label>
                    <input class="input" placeholder="Super strength, flight, telepathy..." value="${S.card.abilities || ''}" onchange="S.card.abilities=this.value;render()">
                    
                    <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">SIGNATURE QUOTE</label>
                    <input class="input" placeholder='"With great power..."' value="${S.card.quote || ''}" onchange="S.card.quote=this.value;render()">
                    
                    <!-- FONTS -->
                    <div style="font-size:12px;color:#999;font-weight:bold;margin:16px 0 10px;display:flex;align-items:center;gap:6px"> FONTS</div>
                    
                    <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">TITLE FONT</label>
                    <select class="input" onchange="S.card.titleFont=this.value;loadFont(this.value);render()" style="padding:10px">
                        ${S.FONTS.map(f => '<option value="'+f.name+'" '+(S.card.titleFont===f.name?'selected':'')+'>'+f.name+'</option>').join('')}
                    </select>
                    
                    <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">NAME FONT</label>
                    <select class="input" onchange="S.card.nameFont=this.value;loadFont(this.value);render()" style="padding:10px">
                        ${S.FONTS.map(f => '<option value="'+f.name+'" '+(S.card.nameFont===f.name?'selected':'')+'>'+f.name+'</option>').join('')}
                    </select>
                    
                    <!-- CATEGORY -->
                    <div style="font-size:12px;color:#999;font-weight:bold;margin:16px 0 10px;display:flex;align-items:center;gap:6px"> CATEGORY</div>
                    <div style="display:flex;flex-wrap:wrap;gap:6px">
                        ${S.cardCategories.map(cat => `
                            <div onclick="S.card.category='${cat.id}';render()" style="padding:8px 14px;border-radius:16px;background:${S.card.category===cat.id?cat.color:'rgba(255,255,255,0.05)'};color:${S.card.category===cat.id?'#fff':'#888'};font-size:11px;cursor:pointer;border:2px solid ${S.card.category===cat.id?'#fff':'transparent'}">${cat.icon} ${cat.name}</div>
                        `).join('')}
                    </div>
                    
                    <!-- Back Image (small image area) -->
                    <div style="margin:12px 0">
                        <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">BACK IMAGE (small area)</label>
                        ${S.card.backImage ? `
                            <div style="display:flex;gap:8px;align-items:center">
                                <img src="${S.card.backImage}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;border:2px solid #333">
                                <button class="btn btn-secondary" style="flex:1;margin:0" onclick="openMediaEditor('card-back')"> Edit</button>
                                <button class="btn btn-secondary" style="margin:0;padding:8px 12px" onclick="S.card.backImage=null;render()"></button>
                            </div>
                        ` : `
                            <button class="btn btn-secondary" style="width:100%;margin:0" onclick="showImageOptions('card-back')"> ADD BACK IMAGE</button>
                        `}
                    </div>
                    
                    <!-- Full Background Image -->
                    <div style="margin:12px 0">
                        <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">FULL BACKGROUND IMAGE</label>
                        <p style="font-size:10px;color:#666;margin:0 0 8px 0">Image behind the card template (color acts as overlay)</p>
                        ${S.card.backBgImage ? `
                            <div style="display:flex;gap:8px;align-items:center">
                                <img src="${S.card.backBgImage}" style="width:60px;height:80px;object-fit:cover;border-radius:8px;border:2px solid #333">
                                <button class="btn btn-secondary" style="flex:1;margin:0" onclick="triggerUpload('card-back-bg')"> Change</button>
                                <button class="btn btn-secondary" style="margin:0;padding:8px 12px" onclick="S.card.backBgImage=null;render()"></button>
                            </div>
                        ` : `
                            <button class="btn btn-secondary" style="width:100%;margin:0" onclick="triggerUpload('card-back-bg')"> ADD BACKGROUND IMAGE</button>
                        `}
                    </div>
                    
                    <button class="btn btn-primary" style="margin-top:16px" onclick="addCurrentCardToCollection();S.activeSheet=null;render()"> SAVE TO COLLECTION</button>
                    <button class="btn btn-secondary" style="margin-top:8px" onclick="S.activeSheet=null;render()"> DONE</button>
                </div>
            </div>
            
            <!-- BATTLE MODE SELECTION SHEET - B&W CYBER STYLE -->
            <div class="sheet ${S.activeSheet === 'battle-modes' ? 'show' : ''}" style="max-height:90vh;background:#0a0a0a">
                <div class="sheet-handle" style="background:#333"></div>
                <div class="sheet-header" style="background:#111;border-bottom:1px solid #333">
                    <span class="sheet-title" style="font-family:'Bebas Neue',sans-serif;letter-spacing:3px"> BATTLE ARENA</span>
                    <button class="sheet-close" onclick="S.activeSheet=null;render()" style="background:#222;border:1px solid #444">${icon('x', 18)}</button>
                </div>
                <div class="sheet-body" style="max-height:80vh;overflow-y:auto;padding-bottom:100px;background:#0a0a0a">
                    
                    <!-- MULTIPLAYER SECTION - B&W -->
                    <div style="background:linear-gradient(135deg,#1a1a1a,#0d0d0d);border-radius:16px;padding:20px;margin-bottom:20px;border:2px solid #444;position:relative;overflow:hidden">
                        <div style="position:absolute;top:0;right:0;width:100px;height:100px;background:radial-gradient(circle,rgba(255,255,255,0.05),transparent);pointer-events:none"></div>
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
                            <span style="font-size:28px"></span>
                            <div>
                                <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;color:#fff;letter-spacing:2px">PLAYER VS PLAYER</div>
                                <div style="font-size:11px;color:#888">Battle real opponents!</div>
                            </div>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                            <button onclick="hostMultiplayerBattle('friendly');S.activeSheet='multiplayer-lobby'" class="cyber-btn" style="padding:16px;flex-direction:column;justify-content:center;background:linear-gradient(180deg,#222,#111);border-color:#555">
                                <div style="font-size:22px;margin-bottom:6px"></div>
                                <div style="font-size:12px;font-weight:700">HOST BATTLE</div>
                                <div style="font-size:9px;opacity:0.6;margin-top:4px">Create & share code</div>
                            </button>
                            <button onclick="S.activeSheet='multiplayer-lobby';S.multiplayer.phase='joining';render()" class="cyber-btn" style="padding:16px;flex-direction:column;justify-content:center;background:linear-gradient(180deg,#222,#111);border-color:#555">
                                <div style="font-size:22px;margin-bottom:6px"></div>
                                <div style="font-size:12px;font-weight:700">JOIN BATTLE</div>
                                <div style="font-size:9px;opacity:0.6;margin-top:4px">Enter friend's code</div>
                            </button>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
                            <button onclick="hostMultiplayerBattle('keeps');S.activeSheet='multiplayer-lobby'" class="cyber-btn danger" style="padding:14px;flex-direction:column;justify-content:center">
                                <div style="font-size:12px"> FOR KEEPS</div>
                                <div style="font-size:9px;color:#888;margin-top:2px">Winner takes card!</div>
                            </button>
                            <div style="padding:14px;border-radius:8px;background:#111;border:1px solid #333;text-align:center">
                                <div style="font-size:10px;color:#666">Online Players</div>
                                <div style="font-size:16px;color:#fff;margin-top:4px"> <span style="color:#4f4">LIVE</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align:center;margin-bottom:16px;padding:12px;background:#111;border-radius:8px;border:1px solid #222">
                        <span style="font-size:11px;color:#555;letter-spacing:2px"> OR BATTLE AI </span>
                    </div>
                    
                    <!-- Card Stats Preview - B&W -->
                    <div style="background:linear-gradient(135deg,#151515,#0a0a0a);border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid #333">
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                            <div style="width:60px;height:80px;border-radius:8px;background:${S.card.frontImage?'url('+S.card.frontImage+') center/cover':'linear-gradient(135deg,#333,#111)'};border:3px solid #fff"></div>
                            <div style="flex:1">
                                <div style="font-weight:bold;color:#fff;font-size:16px">${S.card.name}</div>
                                <div style="font-size:12px;color:#aaa;margin:2px 0"> ${S.card.rarity}  Lv.${S.card.level || 0}</div>
                                <div style="font-size:11px;color:#666">XP: ${S.card.xp || 0}  ${S.card.battlesWon || 0}W/${S.card.battlesLost || 0}L</div>
                            </div>
                        </div>
                        <!-- Durability Bar - B&W -->
                        <div style="font-size:10px;color:#666;margin-bottom:4px">DURABILITY: ${S.card.durability ?? 100}%</div>
                        <div style="height:6px;background:#222;border-radius:3px;overflow:hidden">
                            <div style="width:${S.card.durability ?? 100}%;height:100%;background:linear-gradient(90deg,#888,#fff);border-radius:3px"></div>
                        </div>
                        <!-- XP Bar -->
                        <div style="font-size:10px;color:#666;margin:8px 0 4px">XP TO NEXT LEVEL: ${10 - ((S.card.xp||0) % 10)}</div>
                        <div style="height:6px;background:#222;border-radius:3px;overflow:hidden">
                            <div style="width:${((S.card.xp||0) % 10) * 10}%;height:100%;background:linear-gradient(90deg,#555,#aaa);border-radius:3px"></div>
                        </div>
                        <!-- Evolution State -->
                        <div style="margin-top:10px;padding:8px 12px;background:#111;border-radius:8px;text-align:center;border:1px solid #222">
                            <span style="font-size:11px;color:#888">Evolution:</span>
                            <span style="font-size:12px;font-weight:bold;color:${S.card.evolutionState==='MYTHIC_ASCENDED'?'cyan':S.card.evolutionState==='LEGENDARY_FORM'?'#999':S.card.evolutionState==='ENHANCED'?'#fff':S.card.evolutionState==='DAMAGED'?'#888':'#888'};margin-left:6px">${(S.card.evolutionState || 'BASE').replace('_', ' ')}</span>
                        </div>
                    </div>
                    
                    <div style="font-size:11px;color:#555;margin-bottom:12px;text-align:center;letter-spacing:2px">AI BATTLE MODES</div>
                    
                    <!-- Battle Modes Grid - B&W CYBER STYLE -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                        ${S.BATTLE_MODES.map(mode => `
                            <button onclick="startAdvancedBattle('${mode.id}');S.activeSheet=null" class="cyber-btn" style="padding:16px;flex-direction:column;align-items:flex-start;height:auto;background:${mode.id==='BASE_FOR_KEEPS'?'linear-gradient(180deg,#1a1a1a,#0a0a0a)':'linear-gradient(180deg,#151515,#080808)'};border-color:${mode.id==='BASE_FOR_KEEPS'?'#666':'#333'}">
                                <div style="font-size:24px;margin-bottom:6px">${mode.icon}</div>
                                <div style="font-size:12px;font-weight:bold;color:#fff;margin-bottom:4px;text-align:left">${mode.name}</div>
                                <div style="font-size:9px;color:#666;line-height:1.4;text-align:left;text-transform:none;letter-spacing:0">${mode.description}</div>
                                <div style="margin-top:8px;font-size:10px;color:#888;background:#222;padding:4px 8px;border-radius:4px">+${mode.reward} </div>
                            </button>
                        `).join('')}
                    </div>
                    
                    <!-- Battle Record - B&W -->
                    <div style="margin-top:20px;padding:16px;background:#111;border-radius:12px;border:1px solid #222">
                        <div style="font-size:12px;color:#888;margin-bottom:8px">BATTLE RECORD</div>
                        <div style="display:flex;justify-content:space-around;text-align:center">
                            <div>
                                <div style="font-size:24px;font-weight:bold;color:#fff">${S.battleRecord?.wins || 0}</div>
                                <div style="font-size:10px;color:#888">WINS</div>
                            </div>
                            <div>
                                <div style="font-size:24px;font-weight:bold;color:#888">${S.battleRecord?.losses || 0}</div>
                                <div style="font-size:10px;color:#888">LOSSES</div>
                            </div>
                            <div>
                                <div style="font-size:24px;font-weight:bold;color:#999">${S.card.streakBest || 0}</div>
                                <div style="font-size:10px;color:#888">BEST STREAK</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- COLLABORATION SHEET - SLEEK UI -->
            <div class="sheet ${S.activeSheet === 'collab' ? 'show' : ''}" style="max-height:100dvh;height:100dvh;border-radius:0;overflow:hidden">
                <div style="background:#000;height:100%;display:flex;flex-direction:column">
                    
                    <!-- Top Bar -->
                    <div style="display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid #222">
                        <button onclick="S.activeSheet=null;render()" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:8px"></button>
                        <div style="flex:1;text-align:center">
                            <span style="color:#fff;font-weight:bold;font-size:16px">COLLAB</span>
                        </div>
                        <div style="width:36px"></div>
                    </div>
                    
                    <div style="flex:1;overflow-y:auto;padding:20px">
                    
                    ${S.collabSession ? `
                    <!-- ACTIVE COLLAB SESSION -->
                    
                    <!-- Code Display -->
                    <div style="text-align:center;margin-bottom:24px">
                        <div style="font-size:12px;color:#666;text-transform:uppercase;letter-spacing:2px;margin-bottom:8px">Share Code</div>
                        <div style="font-family:monospace;font-size:40px;color:#fff;letter-spacing:8px;font-weight:bold">${S.collabSession.code}</div>
                        <div style="font-size:13px;color:#888;margin-top:8px">${S.collabSession.name || 'Untitled Collab'}</div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div style="display:flex;gap:12px;margin-bottom:24px">
                        <button onclick="copyCollabLink()" style="flex:1;padding:16px;background:#fff;color:#000;border:none;border-radius:12px;cursor:pointer;font-weight:bold;font-size:14px">
                             Copy Link
                        </button>
                        <button onclick="shareCollabNative()" style="flex:1;padding:16px;background:#222;color:#fff;border:none;border-radius:12px;cursor:pointer;font-weight:bold;font-size:14px">
                             Share
                        </button>
                    </div>
                    
                    <!-- Stats Grid -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px">
                        <div style="background:#111;border-radius:16px;padding:20px;text-align:center">
                            <div style="font-size:36px;color:#fff;font-weight:bold">${S.collabParticipants.length}</div>
                            <div style="font-size:12px;color:#666;margin-top:4px">of ${S.COLLAB_MAX_PARTICIPANTS} creators</div>
                            <div style="margin-top:8px;height:4px;background:#333;border-radius:2px;overflow:hidden">
                                <div style="height:100%;background:#fff;width:${(S.collabParticipants.length/S.COLLAB_MAX_PARTICIPANTS)*100}%"></div>
                            </div>
                        </div>
                        <div style="background:#111;border-radius:16px;padding:20px;text-align:center">
                            <div style="font-size:36px;color:#fff;font-weight:bold">${S.collabPages.length}</div>
                            <div style="font-size:12px;color:#666;margin-top:4px">of ${S.COLLAB_MAX_PAGES} pages</div>
                            <div style="margin-top:8px;height:4px;background:#333;border-radius:2px;overflow:hidden">
                                <div style="height:100%;background:#fff;width:${(S.collabPages.length/S.COLLAB_MAX_PAGES)*100}%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Collaborators -->
                    <div style="margin-bottom:24px">
                        <div style="font-size:12px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px">Collaborators</div>
                        <div style="display:flex;flex-wrap:wrap;gap:8px">
                            ${S.collabParticipants.map(p => `
                            <div style="display:flex;align-items:center;gap:8px;background:#111;padding:8px 14px;border-radius:24px">
                                <div style="width:24px;height:24px;border-radius:50%;background:#333;display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff">${(p.name||'?')[0].toUpperCase()}</div>
                                <span style="color:#fff;font-size:13px">${p.name}</span>
                                ${p.role === 'host' ? '<span style="font-size:10px"></span>' : ''}
                            </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Pages Preview - REAL-TIME with actual comic content -->
                    <div style="margin-bottom:24px">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                            <div style="font-size:12px;color:#666;text-transform:uppercase;letter-spacing:1px">Pages (${S.collabPages.length})</div>
                            <div style="font-size:10px;color:#22c55e"> LIVE SYNC</div>
                        </div>
                        ${S.collabPages.length === 0 ? `
                        <div style="background:#111;border-radius:16px;padding:40px;text-align:center">
                            <div style="font-size:48px;margin-bottom:8px"></div>
                            <div style="color:#888;font-size:14px">No pages yet</div>
                            <div style="color:#666;font-size:12px">Add the first page!</div>
                        </div>
                        ` : `
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">
                            ${S.collabPages.map((p, idx) => `
                            <div onclick="loadCollabPage(${idx})" style="background:#0a0a0a;border:1px solid #333;border-radius:12px;overflow:hidden;cursor:pointer;transition:transform 0.2s,border-color 0.2s" onmouseover="this.style.borderColor='#fff'" onmouseout="this.style.borderColor='#333'">
                                <!-- Mini Comic Preview -->
                                <div style="aspect-ratio:3/4;background:#111;position:relative;overflow:hidden">
                                    ${p.pageData && p.pageData.panels && p.pageData.panels.length > 0 ? `
                                    <div style="width:100%;height:100%;display:grid;grid-template-columns:repeat(${Math.min(p.pageData.panels.length, 2)},1fr);gap:2px;padding:4px;box-sizing:border-box">
                                        ${p.pageData.panels.slice(0,4).map(panel => `
                                        <div style="background:#222;border-radius:4px;overflow:hidden;position:relative">
                                            ${panel.image ? `<img src="${panel.image}" style="width:100%;height:100%;object-fit:cover">` : 
                                            panel.bgColor && panel.bgColor !== 'transparent' ? `<div style="width:100%;height:100%;background:${panel.bgColor}"></div>` :
                                            `<div style="width:100%;height:100%;background:#1a1a1a"></div>`}
                                        </div>
                                        `).join('')}
                                    </div>
                                    ` : `
                                    <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center">
                                        <span style="font-size:32px;opacity:0.3"></span>
                                    </div>
                                    `}
                                    <!-- Page number badge -->
                                    <div style="position:absolute;top:6px;left:6px;background:#000;color:#fff;font-size:10px;padding:3px 8px;border-radius:10px;font-weight:bold">${idx+1}</div>
                                    <!-- New indicator for recent pages -->
                                    ${Date.now() - (p.createdAt || 0) < 30000 ? `<div style="position:absolute;top:6px;right:6px;background:#22c55e;color:#000;font-size:9px;padding:2px 6px;border-radius:10px;font-weight:bold">NEW</div>` : ''}
                                </div>
                                <!-- Author info -->
                                <div style="padding:10px;display:flex;align-items:center;gap:8px;border-top:1px solid #222">
                                    <div style="width:24px;height:24px;border-radius:50%;background:#333;display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff">${(p.author||'?')[0].toUpperCase()}</div>
                                    <div style="flex:1;min-width:0">
                                        <div style="color:#fff;font-size:11px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.author || 'Guest'}</div>
                                        <div style="color:#666;font-size:9px">${p.createdAt ? new Date(p.createdAt).toLocaleTimeString() : 'Just now'}</div>
                                    </div>
                                    <div style="font-size:12px"></div>
                                </div>
                            </div>
                            `).join('')}
                        </div>
                        `}
                    </div>
                    
                    <!-- Add Page Button -->
                    <button onclick="addPageToCollab()" style="width:100%;padding:18px;background:#fff;color:#000;border:none;border-radius:12px;cursor:pointer;font-weight:bold;font-size:16px;margin-bottom:12px" ${S.collabPages.length >= S.COLLAB_MAX_PAGES ? 'disabled style="opacity:0.5"' : ''}>
                         Add Your Page
                    </button>
                    
                    <!-- Secondary Actions -->
                    <div style="display:flex;gap:8px;margin-bottom:24px">
                        <button onclick="exportCollab()" style="flex:1;padding:14px;background:#222;color:#fff;border:none;border-radius:12px;cursor:pointer;font-size:14px"> Export Comic</button>
                        <button onclick="shareToFeed(true)" style="flex:1;padding:14px;background:#222;color:#fff;border:none;border-radius:12px;cursor:pointer;font-size:14px"> Post to Feed</button>
                    </div>
                    
                    <!-- Leave/End -->
                    <button onclick="leaveCollab()" style="width:100%;padding:14px;background:transparent;color:#ff4444;border:1px solid #ff4444;border-radius:12px;cursor:pointer;font-size:14px">
                        ${S.collabRole==='host' ? ' End Collab for Everyone' : ' Leave Collab'}
                    </button>
                    
                    ` : `
                    <!-- START/JOIN COLLAB -->
                    
                    <!-- Hero -->
                    <div style="text-align:center;margin-bottom:32px">
                        <div style="font-size:64px;margin-bottom:16px"></div>
                        <h1 style="color:#fff;font-size:24px;font-weight:bold;margin-bottom:8px">Create Together</h1>
                        <p style="color:#888;font-size:14px;line-height:1.5">Make comics with friends in real-time.<br>Share a link and start creating!</p>
                    </div>
                    
                    <!-- Create Section -->
                    <div style="background:#111;border-radius:20px;padding:24px;margin-bottom:16px">
                        <input type="text" id="collabNameInput" placeholder="Name your collab..." style="width:100%;padding:16px;border-radius:12px;border:none;background:#000;color:#fff;font-size:16px;margin-bottom:16px;box-sizing:border-box;text-align:center">
                        <button onclick="createCollab()" style="width:100%;padding:18px;background:#fff;color:#000;border:none;border-radius:12px;cursor:pointer;font-weight:bold;font-size:16px">
                             Create Collab
                        </button>
                    </div>
                    
                    <!-- Divider -->
                    <div style="display:flex;align-items:center;gap:16px;margin:24px 0">
                        <div style="flex:1;height:1px;background:#333"></div>
                        <span style="color:#666;font-size:12px">OR JOIN</span>
                        <div style="flex:1;height:1px;background:#333"></div>
                    </div>
                    
                    <!-- Join Section -->
                    <div style="background:#111;border-radius:20px;padding:24px">
                        <div style="color:#888;font-size:12px;text-align:center;margin-bottom:12px">Enter 6-digit code</div>
                        <div style="display:flex;gap:8px">
                            <input type="text" id="collabCodeInput" placeholder="ABC123" maxlength="6" style="flex:1;padding:18px;border-radius:12px;border:none;background:#000;color:#fff;font-size:24px;letter-spacing:8px;font-family:monospace;text-align:center;text-transform:uppercase">
                            <button onclick="joinCollab(document.getElementById('collabCodeInput').value)" style="padding:18px 24px;background:#fff;color:#000;border:none;border-radius:12px;cursor:pointer;font-weight:bold;font-size:16px">Join</button>
                        </div>
                    </div>
                    
                    <!-- Info -->
                    <div style="margin-top:32px;text-align:center">
                        <div style="color:#666;font-size:12px;line-height:1.6">
                             Up to ${S.COLLAB_MAX_PARTICIPANTS} collaborators<br>
                             Up to ${S.COLLAB_MAX_PAGES} pages per collab<br>
                             Real-time sync when connected
                        </div>
                    </div>
                    `}
                    
                    </div>
                </div>
            </div>
            
            <!-- COMMUNITY FEED SHEET -->
            <div class="sheet ${S.activeSheet === 'social-feed' ? 'show' : ''}" style="max-height:100dvh;height:100dvh;border-radius:0;overflow:hidden">
                <div style="background:#000;height:100%;display:flex;flex-direction:column">
                    
                    <!-- Top Bar -->
                    <div style="display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid #222">
                        <button onclick="S.activeSheet=null;render()" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:8px"></button>
                        <div style="flex:1;text-align:center">
                            <span style="color:#fff;font-weight:bold;font-size:16px">COMMUNITY</span>
                        </div>
                        <button onclick="S.activeSheet='messages';render()" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:8px"></button>
                    </div>
                    
                    <!-- Feed Tabs -->
                    <div style="display:flex;border-bottom:1px solid #222">
                        <button onclick="S.feedTab='foryou';render()" style="flex:1;padding:14px;background:none;border:none;color:${S.feedTab==='foryou'||!S.feedTab?'#fff':'#666'};font-weight:bold;font-size:12px;cursor:pointer;border-bottom:2px solid ${S.feedTab==='foryou'||!S.feedTab?'#fff':'transparent'}">FOR YOU</button>
                        <button onclick="S.feedTab='following';render()" style="flex:1;padding:14px;background:none;border:none;color:${S.feedTab==='following'?'#fff':'#666'};font-weight:bold;font-size:12px;cursor:pointer;border-bottom:2px solid ${S.feedTab==='following'?'#fff':'transparent'}">FOLLOWING</button>
                        <button onclick="S.feedTab='collabs';render()" style="flex:1;padding:14px;background:none;border:none;color:${S.feedTab==='collabs'?'#fff':'#666'};font-weight:bold;font-size:12px;cursor:pointer;border-bottom:2px solid ${S.feedTab==='collabs'?'#fff':'transparent'}">COLLABS</button>
                    </div>
                    
                    <!-- Stories Row -->
                    <div style="padding:12px 0;border-bottom:1px solid #222;overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch">
                        <div style="display:inline-flex;gap:12px;padding:0 16px">
                            <div onclick="shareToFeed()" style="text-align:center;cursor:pointer">
                                <div style="width:60px;height:60px;border-radius:50%;background:#111;border:2px dashed #444;display:flex;align-items:center;justify-content:center">
                                    <span style="font-size:24px;color:#666">+</span>
                                </div>
                                <div style="font-size:10px;color:#888;margin-top:4px">Post</div>
                            </div>
                            ${renderStoryAvatars()}
                        </div>
                    </div>
                    
                    <!-- Feed Content -->
                    <div style="flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch">
                        ${renderFeedPosts()}
                    </div>
                    
                    <!-- Bottom Nav -->
                    <div style="display:flex;border-top:1px solid #222;background:#000;padding:6px 0;padding-bottom:max(6px,env(safe-area-inset-bottom))">
                        <button onclick="S.feedTab='foryou';render()" style="flex:1;background:none;border:none;color:${S.feedTab==='foryou'||!S.feedTab?'#fff':'#666'};font-size:22px;cursor:pointer;padding:10px" title="Home Feed"></button>
                        <button onclick="S.activeSheet='search-users';render()" style="flex:1;background:none;border:none;color:#666;font-size:22px;cursor:pointer;padding:10px" title="Search & Discover"></button>
                        <button onclick="shareToFeed()" style="flex:1;background:none;border:none;font-size:22px;cursor:pointer;padding:10px" title="Share Your Comic"></button>
                        <button onclick="S.activeSheet='notifications';render()" style="flex:1;background:none;border:none;color:#666;font-size:22px;cursor:pointer;padding:10px" title="Notifications"></button>
                        <button onclick="S.activeSheet='my-social-profile';render()" style="flex:1;background:none;border:none;color:#666;font-size:22px;cursor:pointer;padding:10px" title="My Profile"></button>
                    </div>
                </div>
            </div>
            
            <!-- POST MODAL - IMMERSIVE FULL PAGE -->
            <div class="sheet ${S.activeSheet === 'post-modal' ? 'show' : ''}" style="max-height:100dvh;height:100dvh;border-radius:0;overflow:hidden">
                <div style="background:#000;height:100%;display:flex;flex-direction:column">
                    
                    <!-- Top Bar -->
                    <div style="display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid #222;flex-shrink:0">
                        <button onclick="cancelPost()" style="background:none;border:none;color:#fff;font-size:16px;cursor:pointer;padding:8px">Cancel</button>
                        <div style="flex:1;text-align:center">
                            <span style="color:#fff;font-weight:bold;font-size:16px">Post ${S.postModal?.contentType === 'card' ? ' Card' : S.postModal?.contentType === 'cover' ? ' Cover' : ' Comic'}</span>
                        </div>
                        <button onclick="confirmPost()" style="background:linear-gradient(135deg,#0ff,#f0f);color:#000;border:none;padding:8px 16px;border-radius:8px;font-weight:bold;font-size:14px;cursor:pointer">Share</button>
                    </div>
                    
                    <!-- Full Preview -->
                    <div style="flex:1;overflow-y:auto;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;background:#0a0a0a">
                        <div style="width:100%;max-width:400px;aspect-ratio:${S.postModal?.contentType === 'card' ? '3/4.2' : '3/4'};background:#000;border-radius:12px;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,0.5),0 0 20px ${S.postModal?.contentType === 'card' ? 'rgba(255,0,255,0.2)' : 'rgba(0,255,255,0.2)'};border:1px solid #222">
                                                    ${S.postModal?.contentType === 'card' ? renderCardPreviewForPost() : S.postModal?.contentType === 'cover' ? renderCoverPreviewForPost() : renderFullPagePreview()}
                        </div>
                    </div>
                    
                    <!-- Bottom Section -->
                    <div style="border-top:1px solid #222;padding:16px;flex-shrink:0;background:#000">
                        <!-- Author Info -->
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                            <div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#0ff,#f0f);display:flex;align-items:center;justify-content:center;font-size:16px;color:#000;font-weight:bold">${(S.playerName || 'C')[0].toUpperCase()}</div>
                            <div style="flex:1">
                                <div style="color:#fff;font-weight:bold;font-size:14px">${S.playerName || 'Creator'}</div>
                                <div style="color:#888;font-size:12px">${S.postModal?.contentType === 'card' ? `${S.card?.rarity || 'Custom'} Card` : `${S.pages?.length || 1} page${(S.pages?.length || 1) > 1 ? 's' : ''}`} ${S.collabMode ? '  Collab' : ''}</div>
                            </div>
                        </div>
                        
                        <!-- Caption Input -->
                        <textarea id="postCaptionInput" placeholder="Write a caption..." style="width:100%;padding:12px;border-radius:12px;border:1px solid rgba(0,255,255,0.3);background:#111;color:#fff;font-size:14px;resize:none;height:60px;font-family:inherit">${S.postModal?.caption || ''}</textarea>
                        
                        <!-- Quick Tags -->
                        <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
                            <button onclick="addTagToCaption('#comic')" style="padding:6px 12px;background:#111;border:1px solid #333;border-radius:20px;color:#0ff;font-size:11px;cursor:pointer">#comic</button>
                            <button onclick="addTagToCaption('#art')" style="padding:6px 12px;background:#111;border:1px solid #333;border-radius:20px;color:#0ff;font-size:11px;cursor:pointer">#art</button>
                            <button onclick="addTagToCaption('#pressstart')" style="padding:6px 12px;background:#111;border:1px solid #333;border-radius:20px;color:#f0f;font-size:11px;cursor:pointer">#pressstart</button>
                            ${S.postModal?.contentType === 'card' ? `<button onclick="addTagToCaption('#tradingcard')" style="padding:6px 12px;background:#111;border:1px solid #333;border-radius:20px;color:#0ff;font-size:11px;cursor:pointer">#tradingcard</button>` : ''}
                            ${S.postModal?.contentType === 'cover' ? `<button onclick="addTagToCaption('#coverart')" style="padding:6px 12px;background:#111;border:1px solid #333;border-radius:20px;color:#0ff;font-size:11px;cursor:pointer">#coverart</button>` : ''}
                            ${S.postModal?.contentType === 'cover' ? `<button onclick="addTagToCaption('#bookcover')" style="padding:6px 12px;background:#111;border:1px solid #333;border-radius:20px;color:#0ff;font-size:11px;cursor:pointer">#bookcover</button>` : ''}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- COMMENTS SHEET -->
            <div class="sheet ${S.activeSheet === 'comments' ? 'show' : ''}" style="max-height:80vh">
                <div style="background:#000;height:100%;display:flex;flex-direction:column;border-radius:20px 20px 0 0">
                    <div class="sheet-handle" style="background:#000;padding-top:12px"><div style="width:40px;height:4px;background:#444;border-radius:2px;margin:0 auto"></div></div>
                    <div style="padding:12px 16px;border-bottom:1px solid #222;display:flex;align-items:center">
                        <span style="flex:1;color:#fff;font-weight:bold;font-size:14px">Comments</span>
                        <button onclick="S.activeSheet='social-feed';S.activePostComments=null;render()" style="background:none;border:none;color:#fff;font-size:18px;cursor:pointer"></button>
                    </div>
                    <div style="flex:1;overflow-y:auto;padding:16px">
                        ${renderComments()}
                    </div>
                    <div style="padding:12px 16px;border-top:1px solid #222;display:flex;gap:12px;align-items:center">
                        <div style="width:32px;height:32px;border-radius:50%;background:#333;display:flex;align-items:center;justify-content:center;font-size:12px;color:#fff">${(S.playerName||'U')[0].toUpperCase()}</div>
                        <input type="text" id="commentInput" placeholder="Add a comment..." style="flex:1;padding:10px 16px;border-radius:20px;border:1px solid #333;background:#111;color:#fff;font-size:14px">
                        <button onclick="postComment()" style="background:none;border:none;color:#0095f6;font-weight:bold;font-size:14px;cursor:pointer">Post</button>
                    </div>
                </div>
            </div>
            
            <!-- MESSAGES SHEET -->
            <div class="sheet ${S.activeSheet === 'messages' ? 'show' : ''}" style="max-height:100dvh;height:100dvh;border-radius:0;overflow:hidden">
                <div style="background:#000;height:100%;display:flex;flex-direction:column">
                    <div style="display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid #222">
                        <button onclick="S.activeConvo=null;S.activeSheet='social-feed';render()" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:8px"></button>
                        <div style="flex:1;text-align:center"><span style="color:#fff;font-weight:bold;font-size:16px">${S.activeConvo ? 'Chat' : 'Messages'}</span></div>
                        <button onclick="S.activeSheet='new-message';render()" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:8px"></button>
                    </div>
                    ${renderMessagesContent()}
                </div>
            </div>
            
            <!-- SEARCH USERS SHEET -->
            <div class="sheet ${S.activeSheet === 'search-users' ? 'show' : ''}" style="max-height:100dvh;height:100dvh;border-radius:0;overflow:hidden">
                <div style="background:#000;height:100%;display:flex;flex-direction:column">
                    <div style="display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid #222">
                        <button onclick="S.activeSheet='social-feed';render()" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:8px"></button>
                        <input type="text" id="searchUsersInput" placeholder="Search users..." style="flex:1;padding:10px 16px;border-radius:10px;border:none;background:#222;color:#fff;font-size:14px;margin:0 8px">
                    </div>
                    <div style="flex:1;overflow-y:auto;padding:8px 0">
                        <div style="padding:8px 16px;color:#888;font-size:12px;font-weight:bold">SUGGESTED</div>
                        ${renderSuggestedUsers()}
                    </div>
                </div>
            </div>
            
            <!-- NOTIFICATIONS SHEET -->
            <div class="sheet ${S.activeSheet === 'notifications' ? 'show' : ''}" style="max-height:100dvh;height:100dvh;border-radius:0;overflow:hidden">
                <div style="background:#000;height:100%;display:flex;flex-direction:column">
                    <div style="display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid #222">
                        <button onclick="S.activeSheet='social-feed';render()" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:8px"></button>
                        <span style="flex:1;text-align:center;color:#fff;font-weight:bold;font-size:16px">Notifications</span>
                        <button onclick="clearNotifications()" style="background:none;border:none;color:#888;font-size:12px;cursor:pointer;padding:8px">Clear</button>
                    </div>
                    <div style="flex:1;overflow-y:auto">
                        ${renderNotifications()}
                    </div>
                </div>
            </div>
            
            <!-- MY SOCIAL PROFILE SHEET -->
            <div class="sheet ${S.activeSheet === 'my-social-profile' ? 'show' : ''}" style="max-height:100dvh;height:100dvh;border-radius:0;overflow:hidden">
                <div style="background:#000;height:100%;display:flex;flex-direction:column">
                    <div style="display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid #222">
                        <button onclick="S.activeSheet='social-feed';render()" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:8px"></button>
                        <span style="flex:1;text-align:center;color:#fff;font-weight:bold;font-size:16px">${S.playerName || 'My Profile'}</span>
                        <button onclick="S.activeSheet='profile';render()" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:8px"></button>
                    </div>
                    ${renderMyProfile()}
                </div>
            </div>
            
            <!-- NEW MESSAGE SHEET -->
            <div class="sheet ${S.activeSheet === 'new-message' ? 'show' : ''}" style="max-height:100dvh;height:100dvh;border-radius:0;overflow:hidden">
                <div style="background:#000;height:100%;display:flex;flex-direction:column">
                    <div style="display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid #222">
                        <button onclick="S.activeSheet='messages';render()" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:8px" title="Back"></button>
                        <span style="flex:1;text-align:center;color:#fff;font-weight:bold;font-size:16px">New Message</span>
                        <div style="width:36px"></div>
                    </div>
                    <div style="padding:12px 16px;border-bottom:1px solid #222;display:flex;align-items:center;gap:8px">
                        <span style="color:#fff;font-size:14px">To:</span>
                        <input type="text" id="newMessageTo" placeholder="Search..." style="flex:1;padding:8px;border:none;background:transparent;color:#fff;font-size:14px">
                    </div>
                    <div style="flex:1;overflow-y:auto">
                        ${renderNewMessageContacts()}
                    </div>
                </div>
            </div>
            
            <!-- VIEW OTHER USER PROFILE SHEET -->
            <div class="sheet ${S.activeSheet === 'view-profile' ? 'show' : ''}" style="max-height:100dvh;height:100dvh;border-radius:0;overflow:hidden">
                <div style="background:#000;height:100%;display:flex;flex-direction:column">
                    <div style="display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid #222">
                        <button onclick="S.activeSheet='social-feed';S.viewingProfile=null;render()" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:8px" title="Back to Feed"></button>
                        <span style="flex:1;text-align:center;color:#fff;font-weight:bold;font-size:16px">${getViewingProfileName()}</span>
                        <button onclick="showUserOptions()" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:8px" title="Options"></button>
                    </div>
                    ${renderViewProfile()}
                </div>
            </div>
            
            <!-- USER PROFILE SHEET -->
            <div class="sheet ${S.activeSheet === 'profile' ? 'show' : ''}" style="max-height:85vh">
                <div class="sheet-handle"></div>
                <div class="sheet-header"><span class="sheet-title">PROFILE</span><button class="sheet-close" onclick="S.activeSheet=null;render()">${icon('x', 18)}</button></div>
                <div class="sheet-body" style="padding-bottom:40px;overflow-y:auto;max-height:70vh">
                    
                    <!-- SIGN IN FIRST if not signed in -->
                    ${!S.isSignedIn ? `
                    <div style="background:linear-gradient(135deg,#1a1a2e,#0f0f1a);border:2px solid #333;border-radius:12px;padding:20px;margin-bottom:20px">
                        <div style="text-align:center;margin-bottom:16px">
                            <div style="font-size:28px;margin-bottom:8px"></div>
                            <div style="font-size:14px;color:#fff;font-weight:bold">Sign in to save your progress!</div>
                            <div style="font-size:11px;color:#666;margin-top:4px">Your cards & comics sync across devices</div>
                        </div>
                        ${typeof firebase !== 'undefined' ? `
                        <button id="googleSignInBtn" ontouchend="event.preventDefault();signInWithGoogle()" onclick="signInWithGoogle()" style="width:100%;padding:16px;border-radius:12px;border:none;background:#fff;color:#000;font-size:14px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;box-shadow:0 4px 15px rgba(255,255,255,0.2);touch-action:manipulation;-webkit-user-select:none;user-select:none;position:relative;z-index:100">
                            <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                            SIGN IN WITH GOOGLE
                        </button>
                        ` : `
                        <div style="background:#2a1a1a;border:1px solid #4a2a2a;border-radius:8px;padding:16px;text-align:center">
                            <div style="color:#ff6b6b;font-size:13px;font-weight:bold;margin-bottom:8px"> Sign-in Unavailable</div>
                            <div style="color:#888;font-size:11px;line-height:1.5">Firebase couldn't load. This may be due to:<br> School network blocking Google services<br> Slow internet connection<br><br>Try refreshing the page or using a different network.</div>
                            <button onclick="location.reload()" style="margin-top:12px;padding:10px 20px;border-radius:8px;border:1px solid #444;background:#222;color:#fff;font-size:12px;cursor:pointer"> Refresh Page</button>
                        </div>
                        `}
                        <p style="font-size:10px;color:#555;text-align:center;margin-top:12px">${typeof firebase !== 'undefined' ? 'Tap button above. A Google popup will appear.' : 'Firebase Status: Not Loaded'}</p>
                    </div>
                    ` : ''}
                    
                    <!-- Profile Card -->
                    <div style="text-align:center;padding:24px 0">
                        ${S.playerPhoto ? `<img src="${S.playerPhoto}" style="width:80px;height:80px;border-radius:50%;border:3px solid #fff;margin-bottom:12px">` : `<div style="width:80px;height:80px;border-radius:50%;background:#333;margin:0 auto 12px;display:flex;align-items:center;justify-content:center;font-size:32px;color:#fff;border:3px solid #fff">${(S.playerName || 'P')[0].toUpperCase()}</div>`}
                        <div style="font-size:20px;font-weight:bold;color:#fff">${S.playerName || 'Guest Player'}</div>
                        <div style="font-size:12px;color:#666;margin-top:4px">${S.playerEmail || 'Not signed in'}</div>
                    </div>
                    
                    <!-- Stats Grid -->
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:20px">
                        <div style="background:#111;border:1px solid #333;border-radius:8px;padding:12px;text-align:center">
                            <div style="font-size:20px;font-weight:bold;color:#fff">${S.coins || 0}</div>
                            <div style="font-size:9px;color:#666">COINS</div>
                        </div>
                        <div style="background:#111;border:1px solid #333;border-radius:8px;padding:12px;text-align:center">
                            <div style="font-size:20px;font-weight:bold;color:#fff">${S.cardCollection?.length || 0}</div>
                            <div style="font-size:9px;color:#666">CARDS</div>
                        </div>
                        <div style="background:#111;border:1px solid #333;border-radius:8px;padding:12px;text-align:center">
                            <div style="font-size:20px;font-weight:bold;color:#fff">${(S.battleRecord?.wins || 0)}</div>
                            <div style="font-size:9px;color:#666">WINS</div>
                        </div>
                    </div>
                    
                    <!-- Player Name -->
                    <div style="margin-bottom:16px">
                        <label style="display:block;font-size:10px;color:#666;margin-bottom:6px;letter-spacing:1px">DISPLAY NAME</label>
                        <input type="text" value="${S.playerName || ''}" onchange="S.playerName=this.value;saveState()" placeholder="Enter your name" style="width:100%;padding:12px;border-radius:8px;border:1px solid #333;background:#111;color:#fff;font-size:14px">
                    </div>
                    
                    <!-- Actions -->
                    <div style="display:flex;flex-direction:column;gap:8px">
                        ${S.isSignedIn ? `
                            <div style="background:#0a1a0a;border:1px solid #1a3a1a;border-radius:8px;padding:12px;margin-bottom:8px">
                                <div style="display:flex;align-items:center;gap:8px;color:#4a4">
                                    <span style="font-size:16px"></span>
                                    <span style="font-size:12px">Signed in as ${S.playerEmail}</span>
                                </div>
                            </div>
                            <button onclick="signOut()" style="width:100%;padding:14px;border-radius:8px;border:1px solid #333;background:transparent;color:#888;font-size:12px;cursor:pointer">SIGN OUT</button>
                        ` : `
                            <button onclick="signInWithGoogle()" style="width:100%;padding:14px;border-radius:8px;border:none;background:#fff;color:#000;font-size:12px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px">
                                <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                                SIGN IN WITH GOOGLE
                            </button>
                            <p style="font-size:9px;color:#444;text-align:center;margin-top:8px">Having trouble? Try disabling popup blockers or use a different browser.</p>
                        `}
                        <button onclick="S.activeSheet='admin-login';render()" style="width:100%;padding:14px;border-radius:8px;border:1px solid #444;background:#111;color:#888;font-size:11px;cursor:pointer;margin-top:20px;display:flex;align-items:center;justify-content:center;gap:8px"> ADMIN ACCESS</button>
                    </div>
                </div>
            </div>
            
            <!-- ADMIN LOGIN SHEET -->
            <div class="sheet ${S.activeSheet === 'admin-login' ? 'show' : ''}" style="max-height:70vh">
                <div class="sheet-handle"></div>
                <div class="sheet-header"><span class="sheet-title">ADMIN LOGIN</span><button class="sheet-close" onclick="S.activeSheet='profile';render()">${icon('x', 18)}</button></div>
                <div class="sheet-body">
                    <div style="text-align:center;margin-bottom:20px">
                        <div style="font-size:32px;margin-bottom:8px"></div>
                        <div style="font-size:12px;color:#666">Enter admin credentials</div>
                    </div>
                    <input type="password" id="adminPass" placeholder="Admin Password" style="width:100%;padding:14px;border-radius:8px;border:1px solid #333;background:#111;color:#fff;font-size:14px;margin-bottom:12px;text-align:center;letter-spacing:4px">
                    <button onclick="verifyAdmin()" style="width:100%;padding:14px;border-radius:8px;border:none;background:#fff;color:#000;font-size:12px;font-weight:bold;cursor:pointer">ACCESS DASHBOARD</button>
                </div>
            </div>
            
            <!-- ADMIN DASHBOARD SHEET -->
            <div class="sheet ${S.activeSheet === 'admin-dashboard' ? 'show' : ''}" style="max-height:95vh;background:#0a0a0a">
                <div class="sheet-handle" style="background:#333"></div>
                <div class="sheet-header" style="background:#111;border-bottom:1px solid #333"><span class="sheet-title" style="font-family:'Bebas Neue',sans-serif;letter-spacing:3px"> ADMIN DASHBOARD</span><button class="sheet-close" onclick="S.activeSheet=null;S.adminMode=false;render()">${icon('x', 18)}</button></div>
                <div class="sheet-body" style="max-height:85vh;overflow-y:auto;padding-bottom:60px;background:#0a0a0a">
                    
                    <!-- Admin Header -->
                    <div style="background:linear-gradient(135deg,#1a1a1a,#000);border:1px solid #444;border-radius:12px;padding:16px;margin-bottom:16px">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <div>
                                <div style="font-size:10px;color:#666;letter-spacing:2px"> ADMIN MODE</div>
                                <div style="font-size:18px;font-weight:bold;color:#fff">Press Start Analytics</div>
                                <div style="font-size:10px;color:#555;margin-top:4px">${S.playerEmail || 'Not signed in'}</div>
                            </div>
                            <div style="text-align:right">
                                <div style="font-size:10px;color:#666">${new Date().toLocaleDateString()}</div>
                                <div style="font-size:9px;color:#444">${new Date().toLocaleTimeString()}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- LOCAL STATS - This User's Data -->
                    <div style="font-size:10px;color:#555;letter-spacing:2px;margin-bottom:8px;padding-left:4px"> THIS DEVICE</div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px">
                        <div style="background:#111;border:1px solid #333;border-radius:8px;padding:12px;text-align:center">
                            <div style="font-size:24px;font-weight:bold;color:#fff">${S.pages?.length || 0}</div>
                            <div style="font-size:8px;color:#666;letter-spacing:1px">PAGES</div>
                        </div>
                        <div style="background:#111;border:1px solid #333;border-radius:8px;padding:12px;text-align:center">
                            <div style="font-size:24px;font-weight:bold;color:#fff">${S.cardCollection?.length || 0}</div>
                            <div style="font-size:8px;color:#666;letter-spacing:1px">CARDS</div>
                        </div>
                        <div style="background:#111;border:1px solid #333;border-radius:8px;padding:12px;text-align:center">
                            <div style="font-size:24px;font-weight:bold;color:#fff">${S.battleRecord?.wins || 0}</div>
                            <div style="font-size:8px;color:#666;letter-spacing:1px">WINS</div>
                        </div>
                        <div style="background:#111;border:1px solid #333;border-radius:8px;padding:12px;text-align:center">
                            <div style="font-size:24px;font-weight:bold;color:#fff">${S.user?.credits || 0}</div>
                            <div style="font-size:8px;color:#666;letter-spacing:1px">CREDITS</div>
                        </div>
                        <div style="background:#111;border:1px solid #333;border-radius:8px;padding:12px;text-align:center">
                            <div style="font-size:24px;font-weight:bold;color:#fff">${S.coins || 0}</div>
                            <div style="font-size:8px;color:#666;letter-spacing:1px">COINS</div>
                        </div>
                        <div style="background:#111;border:1px solid #333;border-radius:8px;padding:12px;text-align:center">
                            <div style="font-size:24px;font-weight:bold;color:#fff">${S.battleRecord?.losses || 0}</div>
                            <div style="font-size:8px;color:#666;letter-spacing:1px">LOSSES</div>
                        </div>
                    </div>
                    
                    <!-- FIREBASE STATS - All Users -->
                    <div style="font-size:10px;color:#555;letter-spacing:2px;margin-bottom:8px;padding-left:4px"> ALL USERS (Firebase)</div>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:16px">
                        <div style="background:#111;border:1px solid #333;border-radius:8px;padding:14px">
                            <div style="font-size:24px;font-weight:bold;color:#fff">${S.adminStats?.totalUsers || ''}</div>
                            <div style="font-size:9px;color:#666;letter-spacing:1px">TOTAL USERS</div>
                        </div>
                        <div style="background:#111;border:1px solid #333;border-radius:8px;padding:14px">
                            <div style="font-size:24px;font-weight:bold;color:#fff">${S.adminStats?.activeToday || ''}</div>
                            <div style="font-size:9px;color:#666;letter-spacing:1px">ACTIVE TODAY</div>
                        </div>
                        <div style="background:#111;border:1px solid #333;border-radius:8px;padding:14px">
                            <div style="font-size:24px;font-weight:bold;color:#fff">${S.adminStats?.totalBattles || ''}</div>
                            <div style="font-size:9px;color:#666;letter-spacing:1px">TOTAL BATTLES</div>
                        </div>
                        <div style="background:#111;border:1px solid #333;border-radius:8px;padding:14px">
                            <div style="font-size:24px;font-weight:bold;color:#fff">${S.adminStats?.packsOpened || ''}</div>
                            <div style="font-size:9px;color:#666;letter-spacing:1px">PACKS OPENED</div>
                        </div>
                    </div>
                    
                    <!-- Revenue Section -->
                    <div style="background:#111;border:1px solid #333;border-radius:12px;padding:16px;margin-bottom:16px">
                        <div style="font-size:10px;color:#666;letter-spacing:1px;margin-bottom:12px"> MONETIZATION</div>
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">
                            <div>
                                <div style="font-size:28px;font-weight:bold;color:#fff">$${S.adminStats?.revenue || '0.00'}</div>
                                <div style="font-size:9px;color:#666">TOTAL REVENUE</div>
                            </div>
                            <div>
                                <div style="font-size:28px;font-weight:bold;color:#fff">${S.adminStats?.premiumUsers || '0'}</div>
                                <div style="font-size:9px;color:#666">PREMIUM USERS</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Engagement Section -->
                    <div style="background:#111;border:1px solid #333;border-radius:12px;padding:16px;margin-bottom:16px">
                        <div style="font-size:10px;color:#666;letter-spacing:1px;margin-bottom:12px"> ENGAGEMENT</div>
                        <div style="display:flex;flex-direction:column;gap:8px">
                            <div style="display:flex;justify-content:space-between;align-items:center">
                                <span style="font-size:12px;color:#888">Avg Session Time</span>
                                <span style="font-size:14px;font-weight:bold;color:#fff">${S.adminStats?.avgSession || ''} min</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;align-items:center">
                                <span style="font-size:12px;color:#888">Cards Created</span>
                                <span style="font-size:14px;font-weight:bold;color:#fff">${S.adminStats?.cardsCreated || ''}</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;align-items:center">
                                <span style="font-size:12px;color:#888">Comics Exported</span>
                                <span style="font-size:14px;font-weight:bold;color:#fff">${S.adminStats?.comicsExported || ''}</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;align-items:center">
                                <span style="font-size:12px;color:#888">Daily Logins (7d avg)</span>
                                <span style="font-size:14px;font-weight:bold;color:#fff">${S.adminStats?.dailyLogins || ''}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Admin Config Info -->
                    <div style="background:#0d0d0d;border:1px solid #222;border-radius:8px;padding:12px;margin-bottom:16px">
                        <div style="font-size:9px;color:#444;letter-spacing:1px;margin-bottom:8px"> ADMIN CONFIG</div>
                        <div style="font-size:10px;color:#555;line-height:1.6">
                            To change admin access, edit these in the code:<br>
                             <span style="color:#888">ADMIN_PASSWORD</span> = your password<br>
                             <span style="color:#888">ADMIN_EMAILS</span> = ['email1', 'email2']
                        </div>
                    </div>
                    
                    <!-- Google Analytics Info -->
                    <div style="background:#0d0d0d;border:1px solid #222;border-radius:8px;padding:12px;margin-bottom:16px">
                        <div style="font-size:9px;color:#444;letter-spacing:1px;margin-bottom:8px"> GOOGLE ANALYTICS</div>
                        <div style="font-size:10px;color:#555;line-height:1.6">
                            <span style="color:#4285F4"></span> GA4 Property: <span style="color:#888">G-HLMLY9K2FZ</span><br>
                            <span style="color:#4285F4"></span> Events tracked: session_start, page_added, card_created, battle_started, battle_complete, pack_opened, post_shared, comic_exported, login<br><br>
                            <a href="https://analytics.google.com" target="_blank" style="color:#4285F4;text-decoration:none"> View Full Analytics Dashboard</a>
                        </div>
                    </div>
                    
                    <!-- FEATURE TOGGLES - NEW! -->
                    <div style="background:linear-gradient(135deg,#0f1f0f,#0a0a0a);border:1px solid #2a5a2a;border-radius:12px;padding:16px;margin-bottom:16px">
                        <div style="font-size:10px;color:#4ade80;letter-spacing:2px;margin-bottom:12px"> FEATURE TOGGLES</div>
                        
                        <div style="display:flex;flex-direction:column;gap:10px">
                            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#111;border-radius:8px">
                                <div>
                                    <div style="font-size:12px;color:#fff"> Watermarks</div>
                                    <div style="font-size:9px;color:#666">Add watermark to free exports</div>
                                </div>
                                <button onclick="S.adminConfig.watermarksEnabled=!S.adminConfig.watermarksEnabled;saveAdminConfig();render()" style="padding:6px 12px;border-radius:20px;border:none;font-size:10px;font-weight:bold;cursor:pointer;${S.adminConfig.watermarksEnabled ? 'background:#4ade80;color:#000' : 'background:#333;color:#666'}">${S.adminConfig.watermarksEnabled ? 'ON' : 'OFF'}</button>
                            </div>
                            
                            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#111;border-radius:8px">
                                <div>
                                    <div style="font-size:12px;color:#fff"> Export Limits</div>
                                    <div style="font-size:9px;color:#666">Enforce daily export limits by tier</div>
                                </div>
                                <button onclick="S.adminConfig.exportLimitsEnabled=!S.adminConfig.exportLimitsEnabled;saveAdminConfig();render()" style="padding:6px 12px;border-radius:20px;border:none;font-size:10px;font-weight:bold;cursor:pointer;${S.adminConfig.exportLimitsEnabled ? 'background:#4ade80;color:#000' : 'background:#333;color:#666'}">${S.adminConfig.exportLimitsEnabled ? 'ON' : 'OFF'}</button>
                            </div>
                            
                            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#111;border-radius:8px">
                                <div>
                                    <div style="font-size:12px;color:#fff"> Premium Lock</div>
                                    <div style="font-size:9px;color:#666">Lock premium features for free tier</div>
                                </div>
                                <button onclick="S.adminConfig.premiumFeaturesLocked=!S.adminConfig.premiumFeaturesLocked;saveAdminConfig();render()" style="padding:6px 12px;border-radius:20px;border:none;font-size:10px;font-weight:bold;cursor:pointer;${S.adminConfig.premiumFeaturesLocked ? 'background:#4ade80;color:#000' : 'background:#333;color:#666'}">${S.adminConfig.premiumFeaturesLocked ? 'ON' : 'OFF'}</button>
                            </div>
                            
                            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#111;border-radius:8px">
                                <div>
                                    <div style="font-size:12px;color:#fff"> AI Limits</div>
                                    <div style="font-size:9px;color:#666">Enforce AI generation limits</div>
                                </div>
                                <button onclick="S.adminConfig.aiLimitsEnabled=!S.adminConfig.aiLimitsEnabled;saveAdminConfig();render()" style="padding:6px 12px;border-radius:20px;border:none;font-size:10px;font-weight:bold;cursor:pointer;${S.adminConfig.aiLimitsEnabled ? 'background:#4ade80;color:#000' : 'background:#333;color:#666'}">${S.adminConfig.aiLimitsEnabled ? 'ON' : 'OFF'}</button>
                            </div>
                            
                            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#111;border-radius:8px">
                                <div>
                                    <div style="font-size:12px;color:#fff"> Upgrade Prompts</div>
                                    <div style="font-size:9px;color:#666">Show upgrade modals</div>
                                </div>
                                <button onclick="S.adminConfig.showUpgradePrompts=!S.adminConfig.showUpgradePrompts;saveAdminConfig();render()" style="padding:6px 12px;border-radius:20px;border:none;font-size:10px;font-weight:bold;cursor:pointer;${S.adminConfig.showUpgradePrompts ? 'background:#4ade80;color:#000' : 'background:#333;color:#666'}">${S.adminConfig.showUpgradePrompts ? 'ON' : 'OFF'}</button>
                            </div>
                            
                            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:linear-gradient(90deg,#1a1a3a,#111);border:1px solid #4a4af0;border-radius:8px">
                                <div>
                                    <div style="font-size:12px;color:#fff"> Classroom Mode</div>
                                    <div style="font-size:9px;color:#8888ff">UNLOCK ALL FEATURES</div>
                                </div>
                                <button onclick="S.adminConfig.classroomMode=!S.adminConfig.classroomMode;saveAdminConfig();render()" style="padding:6px 12px;border-radius:20px;border:none;font-size:10px;font-weight:bold;cursor:pointer;${S.adminConfig.classroomMode ? 'background:#8b5cf6;color:#fff' : 'background:#333;color:#666'}">${S.adminConfig.classroomMode ? ' ACTIVE' : 'OFF'}</button>
                            </div>
                        </div>
                        
                        <div style="margin-top:12px;padding:10px;background:#0a0a0a;border-radius:8px;font-size:9px;color:#555">
                             <strong style="color:#888">Classroom Mode</strong> unlocks all features, removes watermarks, and disables limits. Perfect for classroom demos and testing.
                        </div>
                    </div>
                    
                    <!-- USER TIER TESTING -->
                    <div style="background:#111;border:1px solid #333;border-radius:12px;padding:16px;margin-bottom:16px">
                        <div style="font-size:10px;color:#666;letter-spacing:2px;margin-bottom:12px"> TEST USER TIERS</div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap">
                            <button onclick="setUserTier('free')" style="padding:8px 16px;border-radius:8px;border:2px solid ${S.userTier==='free'?'#fff':'#333'};background:${S.userTier==='free'?'#333':'transparent'};color:#fff;font-size:11px;cursor:pointer"> Free</button>
                            <button onclick="setUserTier('plus')" style="padding:8px 16px;border-radius:8px;border:2px solid ${S.userTier==='plus'?'#4ade80':'#333'};background:${S.userTier==='plus'?'#1a3a1a':'transparent'};color:#4ade80;font-size:11px;cursor:pointer"> Plus</button>
                            <button onclick="setUserTier('pro')" style="padding:8px 16px;border-radius:8px;border:2px solid ${S.userTier==='pro'?'#f59e0b':'#333'};background:${S.userTier==='pro'?'#3a2a1a':'transparent'};color:#f59e0b;font-size:11px;cursor:pointer"> Pro</button>
                            <button onclick="setUserTier('classroom')" style="padding:8px 16px;border-radius:8px;border:2px solid ${S.userTier==='classroom'?'#8b5cf6':'#333'};background:${S.userTier==='classroom'?'#2a1a3a':'transparent'};color:#8b5cf6;font-size:11px;cursor:pointer"> Classroom</button>
                        </div>
                        <div style="margin-top:10px;font-size:10px;color:#666">
                            Current: <span style="color:#fff;font-weight:bold">${getUserTier().toUpperCase()}</span>  
                            Exports today: <span style="color:#fff">${S.exportsToday}/${getTierLimits().exports}</span>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div style="display:flex;flex-direction:column;gap:8px">
                        <button onclick="refreshAdminStats()" style="width:100%;padding:12px;border-radius:8px;border:1px solid #444;background:#1a1a1a;color:#fff;font-size:11px;cursor:pointer;letter-spacing:1px"> REFRESH STATS</button>
                        <button onclick="exportAdminData()" style="width:100%;padding:12px;border-radius:8px;border:1px solid #444;background:#1a1a1a;color:#fff;font-size:11px;cursor:pointer;letter-spacing:1px"> EXPORT DATA (CSV)</button>
                        <button onclick="window.open('https://analytics.google.com','_blank')" style="width:100%;padding:12px;border-radius:8px;border:1px solid #4285F4;background:#1a1a2e;color:#4285F4;font-size:11px;cursor:pointer;letter-spacing:1px"> OPEN GOOGLE ANALYTICS</button>
                        <button onclick="S.activeSheet='admin-users';render()" style="width:100%;padding:12px;border-radius:8px;border:1px solid #444;background:#1a1a1a;color:#fff;font-size:11px;cursor:pointer;letter-spacing:1px"> VIEW ALL USERS</button>
                        <button onclick="S.adminMode=false;S.activeSheet=null;render()" style="width:100%;padding:12px;border-radius:8px;border:1px solid #333;background:transparent;color:#666;font-size:11px;cursor:pointer;margin-top:8px">EXIT ADMIN MODE</button>
                    </div>
                </div>
            </div>
            
            <!-- CARD COLLECTION SHEET -->
            <div class="sheet ${S.activeSheet === 'collection' ? 'show' : ''}" style="max-height:90vh">
                <div class="sheet-handle"></div>
                <div class="sheet-header"><span class="sheet-title">MY COLLECTION</span><button class="sheet-close" onclick="S.activeSheet=null;render()">${icon('x', 18)}</button></div>
                <div class="sheet-body" style="max-height:80vh;overflow-y:auto;padding-bottom:100px">
                    
                    <!-- Stats -->
                    <div style="background:linear-gradient(135deg,#1a1a2e,#0f0f1a);border-radius:12px;padding:16px;margin-bottom:16px">
                        <div style="display:flex;justify-content:space-around;text-align:center">
                            <div>
                                <div style="font-size:28px;font-weight:bold;color:#999">${S.cardCollection.length}</div>
                                <div style="font-size:10px;color:#888">TOTAL</div>
                            </div>
                            <div>
                                <div style="font-size:28px;font-weight:bold;color:#fff">${S.cardCollection.filter(c=>c.origin==='won_battle').length}</div>
                                <div style="font-size:10px;color:#888">WON</div>
                            </div>
                            <div>
                                <div style="font-size:28px;font-weight:bold;color:#bbb">${S.cardCollection.filter(c=>c.rarity==='LEGENDARY'||c.rarity==='MYTHIC').length}</div>
                                <div style="font-size:10px;color:#888">RARE+</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Category Filters -->
                    <div style="display:flex;gap:6px;overflow-x:auto;padding:8px 0;margin-bottom:12px">
                        <div onclick="S.collectionFilter='all';render()" style="padding:8px 14px;border-radius:20px;background:${!S.collectionFilter||S.collectionFilter==='all'?'#fff':'rgba(255,255,255,0.08)'};color:${!S.collectionFilter||S.collectionFilter==='all'?'#000':'#888'};font-size:11px;cursor:pointer;white-space:nowrap;font-weight:600"> All</div>
                        ${S.cardCategories.map(cat => `
                            <div onclick="S.collectionFilter='${cat.id}';render()" style="padding:8px 14px;border-radius:20px;background:${S.collectionFilter===cat.id?cat.color:'rgba(255,255,255,0.08)'};color:${S.collectionFilter===cat.id?'#fff':'#888'};font-size:11px;cursor:pointer;white-space:nowrap;font-weight:600">${cat.icon} ${cat.name}</div>
                        `).join('')}
                    </div>
                    
                    <!-- Card Grid -->
                    ${S.cardCollection.length === 0 ? `
                        <div style="text-align:center;padding:40px 20px;color:#666">
                            <div style="font-size:48px;margin-bottom:12px"></div>
                            <div style="font-size:14px;margin-bottom:8px">No cards in collection yet!</div>
                            <div style="font-size:12px;color:#555">Create a card and save it, or win cards in battles</div>
                        </div>
                    ` : `
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
                            ${getFilteredCollection().map((card, i) => {
                                const realIndex = S.cardCollection.indexOf(card);
                                return `
                                <div onclick="viewCollectionCard(${realIndex})" style="aspect-ratio:2.5/3.5;border-radius:8px;background:${card.frontImage?'url('+card.frontImage+') center/cover':getRarityGradient(card.rarity)};border:3px solid ${getRarityColor(card.rarity)};cursor:pointer;position:relative;overflow:hidden">
                                    <div style="position:absolute;inset:0;background:linear-gradient(transparent 50%,rgba(0,0,0,0.8));display:flex;flex-direction:column;justify-content:flex-end;padding:8px">
                                        <div style="font-size:10px;font-weight:bold;color:#fff;text-shadow:1px 1px 2px #000">${card.name || 'Card'}</div>
                                        <div style="font-size:8px;color:${getRarityColor(card.rarity)}">${card.rarity || 'COMMON'}</div>
                                    </div>
                                    ${card.locked ? '<div style="position:absolute;top:4px;right:4px;font-size:12px"></div>' : ''}
                                    ${card.origin === 'won_battle' ? '<div style="position:absolute;top:4px;left:4px;font-size:10px"></div>' : ''}
                                </div>
                            `}).join('')}
                        </div>
                    `}
                </div>
            </div>
            
            <!-- VIEW SINGLE COLLECTION CARD -->
            <div class="sheet ${S.activeSheet === 'collection-card-view' ? 'show' : ''}" style="max-height:90vh">
                <div class="sheet-handle"></div>
                <div class="sheet-header"><span class="sheet-title"> CARD DETAILS</span><button class="sheet-close" onclick="S.activeSheet='collection';render()">${icon('x', 18)}</button></div>
                <div class="sheet-body" style="max-height:80vh;overflow-y:auto;padding-bottom:100px">
                    ${S.viewingCollectionCard !== undefined && S.cardCollection[S.viewingCollectionCard] ? (() => {
                        const card = S.cardCollection[S.viewingCollectionCard];
                        return `
                            <div style="text-align:center;margin-bottom:16px">
                                <div style="width:160px;height:220px;margin:0 auto;border-radius:12px;background:${card.frontImage?'url('+card.frontImage+') center/cover':getRarityGradient(card.rarity)};border:4px solid ${getRarityColor(card.rarity)};box-shadow:0 10px 30px rgba(0,0,0,0.5)"></div>
                            </div>
                            
                            <div style="text-align:center;margin-bottom:16px">
                                <div style="font-size:22px;font-weight:bold;color:#fff">${card.name || 'Unnamed'}</div>
                                <div style="font-size:14px;color:${getRarityColor(card.rarity)};margin-top:4px"> ${card.rarity || 'COMMON'}</div>
                                ${card.origin === 'won_battle' ? '<div style="font-size:12px;color:#fff;margin-top:4px"> Won from '+card.wonFromPlayer+'</div>' : ''}
                            </div>
                            
                            <!-- Stats -->
                            <div style="background:rgba(0,0,0,0.3);border-radius:12px;padding:14px;margin-bottom:16px">
                                <div style="display:flex;justify-content:space-around;text-align:center">
                                    <div>
                                        <div style="font-size:20px;font-weight:bold;color:#fff">${card.stats?.pwr || 0}</div>
                                        <div style="font-size:10px;color:#888">${card.stat1Label || 'PWR'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size:20px;font-weight:bold;color:#ddd">${card.stats?.spd || 0}</div>
                                        <div style="font-size:10px;color:#888">${card.stat2Label || 'SPD'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size:20px;font-weight:bold;color:#fff">${card.stats?.int || 0}</div>
                                        <div style="font-size:10px;color:#888">${card.stat3Label || 'INT'}</div>
                                    </div>
                                </div>
                            </div>
                            
                            ${card.bio ? '<p style="font-size:13px;color:#ccc;line-height:1.6;margin-bottom:16px">'+card.bio+'</p>' : ''}
                            
                            <!-- Category -->
                            <div style="font-size:11px;color:#888;margin-bottom:8px">CHANGE CATEGORY:</div>
                            <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px">
                                ${S.cardCategories.map(cat => `
                                    <div onclick="setCardCategory(${S.viewingCollectionCard},'${cat.id}')" style="padding:6px 12px;border-radius:12px;background:${card.category===cat.id?cat.color:'rgba(255,255,255,0.05)'};color:${card.category===cat.id?'#fff':'#666'};font-size:10px;cursor:pointer">${cat.icon} ${cat.name}</div>
                                `).join('')}
                            </div>
                            
                            <!-- Actions -->
                            <div style="display:flex;flex-direction:column;gap:8px">
                                <button class="btn btn-primary" onclick="equipCollectionCard(${S.viewingCollectionCard})"> EQUIP THIS CARD</button>
                                <button class="btn btn-secondary" onclick="toggleCardLock(${S.viewingCollectionCard})">${card.locked ? ' UNLOCK' : ' LOCK (Protect from loss)'}</button>
                                ${!card.locked ? '<button class="btn" style="background:#888" onclick="if(confirm(\'Delete this card?\'))deleteCollectionCard('+S.viewingCollectionCard+')"> DELETE</button>' : ''}
                            </div>
                        `;
                    })() : '<div style="text-align:center;color:#666">No card selected</div>'}
                </div>
            </div>
            
            <div class="sheet ${S.activeSheet === 'cover-edit' ? 'show' : ''}">
                <div class="sheet-handle"></div>
                <div class="sheet-header"><span class="sheet-title">EDIT COVER</span><button class="sheet-close" onclick="S.activeSheet=null;render()">${icon('x', 18)}</button></div>
                <div class="sheet-body" style="max-height:70vh;overflow-y:auto;padding-bottom:80px">
                    <div style="font-size:12px;color:#ef5350;font-weight:bold;margin-bottom:10px"> FRONT COVER</div>
                    
                    <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">SERIES NAME</label>
                    <input class="input" placeholder="Series Name" value="${S.cover.series}" onchange="S.cover.series=this.value;render()">
                    
                    <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">ISSUE NUMBER</label>
                    <input class="input" placeholder="Issue #" value="${S.cover.issue}" onchange="S.cover.issue=this.value;render()">
                    
                    <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">MAIN TITLE</label>
                    <input class="input" placeholder="Title" value="${S.cover.title}" onchange="S.cover.title=this.value;render()">
                    
                    <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">TAGLINE</label>
                    <input class="input" placeholder="Tagline" value="${S.cover.tagline}" onchange="S.cover.tagline=this.value;render()">
                    
                    <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">PRICE</label>
                    <input class="input" placeholder="$4.99" value="${S.cover.price || '$4.99'}" onchange="S.cover.price=this.value;render()">
                    
                    ${S.cover.frontImage ? `
                    <button class="btn btn-secondary" style="width:100%;margin-bottom:12px" onclick="openMediaEditor('cover-front')"> EDIT COVER IMAGE</button>
                    ` : ''}
                    
                    <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">COVER STYLE</label>
                    <div style="display:flex;gap:8px;margin-bottom:12px">
                        <div onclick="S.cover.style='classic';render()" style="flex:1;padding:12px;border-radius:8px;background:#c62828;cursor:pointer;text-align:center;font-weight:bold;color:#fff;border:3px solid ${S.cover.style==='classic'||!S.cover.style?'#fff':'transparent'}">CLASSIC</div>
                        <div onclick="S.cover.style='dark';render()" style="flex:1;padding:12px;border-radius:8px;background:#1a1a2e;cursor:pointer;text-align:center;font-weight:bold;color:#fff;border:3px solid ${S.cover.style==='dark'?'#fff':'transparent'}">DARK</div>
                        <div onclick="S.cover.style='vintage';render()" style="flex:1;padding:12px;border-radius:8px;background:#d4a574;cursor:pointer;text-align:center;font-weight:bold;color:#3d2914;border:3px solid ${S.cover.style==='vintage'?'#fff':'transparent'}">VINTAGE</div>
                    </div>
                    
                    <div style="font-size:12px;color:#ef5350;font-weight:bold;margin:16px 0 10px"> BACK COVER</div>
                    
                    <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">BACK COVER TEXT</label>
                    <textarea class="input" rows="3" placeholder="Synopsis, story hook..." onchange="S.cover.backText=this.value;render()">${S.cover.backText || ''}</textarea>
                    
                    <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">CREDITS</label>
                    <textarea class="input" rows="2" placeholder="Art & Story: Your Name" onchange="S.cover.credits=this.value;render()">${S.cover.credits || ''}</textarea>
                    
                    <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">WEBSITE</label>
                    <input class="input" placeholder="yoursite.com" value="${S.cover.website || ''}" onchange="S.cover.website=this.value;render()">
                    
                    <!-- Back Cover Small Image -->
                    <div style="margin:12px 0">
                        <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">BACK IMAGE (small area)</label>
                        ${S.cover.backImage ? `
                            <div style="display:flex;gap:8px;align-items:center">
                                <img src="${S.cover.backImage}" style="width:50px;height:50px;object-fit:cover;border-radius:6px;border:2px solid #333">
                                <button class="btn btn-secondary" style="flex:1;margin:0" onclick="openMediaEditor('cover-back')"> Edit</button>
                                <button class="btn btn-secondary" style="margin:0;padding:8px 12px" onclick="S.cover.backImage=null;render()"></button>
                            </div>
                        ` : `
                            <button class="btn btn-secondary" style="width:100%;margin:0" onclick="showImageOptions('cover-back')"> ADD BACK IMAGE</button>
                        `}
                    </div>
                    
                    <!-- Full Background Image -->
                    <div style="margin:12px 0">
                        <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">FULL BACKGROUND IMAGE</label>
                        <p style="font-size:10px;color:#666;margin:0 0 8px 0">Image behind the back cover (color acts as overlay)</p>
                        ${S.cover.backBgImage ? `
                            <div style="display:flex;gap:8px;align-items:center">
                                <img src="${S.cover.backBgImage}" style="width:50px;height:70px;object-fit:cover;border-radius:6px;border:2px solid #333">
                                <button class="btn btn-secondary" style="flex:1;margin:0" onclick="triggerUpload('cover-back-bg')"> Change</button>
                                <button class="btn btn-secondary" style="margin:0;padding:8px 12px" onclick="S.cover.backBgImage=null;render()"></button>
                            </div>
                        ` : `
                            <button class="btn btn-secondary" style="width:100%;margin:0" onclick="triggerUpload('cover-back-bg')"> ADD BACKGROUND IMAGE</button>
                        `}
                    </div>
                    
                    <!-- FONTS -->
                    <div style="font-size:12px;color:#ef5350;font-weight:bold;margin:16px 0 10px"> FONTS</div>
                    
                    <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">TITLE FONT</label>
                    <select class="input" onchange="S.cover.titleFont=this.value;loadFont(this.value);render()" style="padding:10px">
                        ${S.FONTS.map(f => '<option value="'+f.name+'" '+(S.cover.titleFont===f.name?'selected':'')+'>'+f.name+'</option>').join('')}
                    </select>
                    
                    <label style="font-size:11px;color:#888;margin-bottom:4px;display:block">SERIES FONT</label>
                    <select class="input" onchange="S.cover.seriesFont=this.value;loadFont(this.value);render()" style="padding:10px">
                        ${S.FONTS.map(f => '<option value="'+f.name+'" '+(S.cover.seriesFont===f.name?'selected':'')+'>'+f.name+'</option>').join('')}
                    </select>
                    
                    <button class="btn btn-primary" onclick="S.activeSheet=null;render()">DONE</button>
                </div>
            </div>
            
            <div class="sheet ${S.activeSheet === 'card-presets' ? 'show' : ''}">
                <div class="sheet-handle"></div>
                <div class="sheet-header"><span class="sheet-title">CARD PRESETS</span><button class="sheet-close" onclick="S.activeSheet=null;render()">${icon('x', 18)}</button></div>
                <div class="sheet-body">
                    <div class="grid-3">${CARD_PRESETS.map(p => `
                        <div class="option-btn" onclick="applyCardPreset('${p.id}')" style="background:${p.style==='gold'?'linear-gradient(135deg,#c9a227,#f4d03f)':p.style==='silver'?'linear-gradient(135deg,#888,#ccc)':'linear-gradient(135deg,#ff4500,#ff8c00)'}">
                            <div style="font-size:14px;font-weight:bold;color:${p.style==='gold'?'#1a1a2e':'#fff'}">${p.name}</div>
                        </div>`).join('')}
                    </div>
                </div>
            </div>
            
            <div class="sheet ${S.activeSheet === 'cover-presets' ? 'show' : ''}">
                <div class="sheet-handle"></div>
                <div class="sheet-header"><span class="sheet-title">COVER PRESETS</span><button class="sheet-close" onclick="S.activeSheet=null;render()">${icon('x', 18)}</button></div>
                <div class="sheet-body">
                    <div class="grid-3">${COVER_PRESETS.map(p => `
                        <div class="option-btn" onclick="applyCoverPreset('${p.id}')" style="background:${p.style==='classic'?'#c62828':p.style==='dark'?'#1a1a2e':'#d4a574'}">
                            <div style="font-size:14px;font-weight:bold;color:#fff">${p.name}</div>
                        </div>`).join('')}
                    </div>
                </div>
            </div>
            
            <div class="sheet ${S.activeSheet === 'publish-success' ? 'show' : ''}">
                <div class="sheet-handle"></div>
                <div class="sheet-header"><span class="sheet-title"> READY TO PUBLISH!</span><button class="sheet-close" onclick="S.activeSheet=null;render()">${icon('x', 18)}</button></div>
                <div class="sheet-body" style="text-align:center">
                    <div style="font-size:64px;margin-bottom:16px"></div>
                    <div style="font-size:20px;font-weight:bold;color:#fff;margin-bottom:8px">Comic Package Ready!</div>
                    <p style="color:#888;margin-bottom:20px">Your comic "${S.shareTitle || S.cover.title}" by ${S.creatorName || 'Anonymous'} is ready to share!</p>
                    
                    <div style="background:#111;border-radius:8px;padding:16px;margin-bottom:20px;text-align:left">
                        <div style="font-size:12px;color:#888;margin-bottom:8px"> NEXT STEPS:</div>
                        <div style="font-size:14px;color:#fff;margin-bottom:8px">1. Export your comic pages</div>
                        <div style="font-size:14px;color:#fff;margin-bottom:8px">2. Visit psstreaming.online</div>
                        <div style="font-size:14px;color:#fff;margin-bottom:8px">3. Upload your comic!</div>
                    </div>
                    
                    <div style="display:grid;gap:8px">
                        <button onclick="exportAllPages();S.activeSheet=null" class="btn btn-primary" style="padding:14px"> EXPORT ALL PAGES</button>
                        <a href="https://www.psstreaming.online" target="_blank" style="display:block;padding:14px;background:#fff;color:#fff;text-decoration:none;border-radius:8px;font-weight:bold;text-align:center"> GO TO READER APP</a>
                        <button onclick="S.activeSheet=null;render()" class="btn btn-secondary">CLOSE</button>
                    </div>
                </div>
            </div>
            
            <div class="sheet ${S.activeSheet === 'share-options' ? 'show' : ''}">
                <div class="sheet-handle"></div>
                <div class="sheet-header"><span class="sheet-title"> SHARE OPTIONS</span><button class="sheet-close" onclick="S.activeSheet=null;render()">${icon('x', 18)}</button></div>
                <div class="sheet-body">
                    <div style="display:grid;gap:12px">
                        <a href="https://www.instagram.com" target="_blank" style="display:flex;align-items:center;gap:12px;padding:14px;background:#E4405F;color:#fff;text-decoration:none;border-radius:8px">
                            <span style="font-size:24px"></span>
                            <div>
                                <div style="font-weight:bold">Instagram</div>
                                <div style="font-size:12px;opacity:0.8">Share to Stories or Feed</div>
                            </div>
                        </a>
                        <a href="https://www.tiktok.com" target="_blank" style="display:flex;align-items:center;gap:12px;padding:14px;background:#000;color:#fff;text-decoration:none;border-radius:8px;border:2px solid #25F4EE">
                            <span style="font-size:24px"></span>
                            <div>
                                <div style="font-weight:bold">TikTok</div>
                                <div style="font-size:12px;opacity:0.8">Create a comic reveal video</div>
                            </div>
                        </a>
                        <a href="https://www.twitter.com" target="_blank" style="display:flex;align-items:center;gap:12px;padding:14px;background:#1DA1F2;color:#fff;text-decoration:none;border-radius:8px">
                            <span style="font-size:24px"></span>
                            <div>
                                <div style="font-weight:bold">Twitter/X</div>
                                <div style="font-size:12px;opacity:0.8">Post your comic panels</div>
                            </div>
                        </a>
                        <button onclick="copyShareLink()" style="display:flex;align-items:center;gap:12px;padding:14px;background:#333;color:#fff;border:none;border-radius:8px;cursor:pointer;width:100%">
                            <span style="font-size:24px"></span>
                            <div style="text-align:left">
                                <div style="font-weight:bold">Copy Link</div>
                                <div style="font-size:12px;opacity:0.8">Share anywhere</div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="sheet ${S.activeSheet === 'export-preview' ? 'show' : ''}">
                <div class="sheet-handle"></div>
                <div class="sheet-header"><span class="sheet-title"> EXPORT COMIC</span><button class="sheet-close" onclick="S.activeSheet=null;render()">${icon('x', 18)}</button></div>
                <div class="sheet-body" style="text-align:center">
                    <div style="font-size:48px;margin-bottom:12px"></div>
                    <p style="color:#888;margin-bottom:20px">This will save all pages in order:<br>Cover  Pages  Card  Back Cover</p>
                    
                    <div style="background:#111;border-radius:8px;padding:16px;margin-bottom:20px">
                        <div style="display:flex;justify-content:space-around;margin-bottom:12px">
                            <div style="text-align:center">
                                <div style="font-size:24px;color:#fff">1</div>
                                <div style="font-size:10px;color:#888">Cover</div>
                            </div>
                            <div style="text-align:center">
                                <div style="font-size:24px;color:#fff">${S.pages.length}</div>
                                <div style="font-size:10px;color:#888">Pages</div>
                            </div>
                            <div style="text-align:center">
                                <div style="font-size:24px;color:#fff">1</div>
                                <div style="font-size:10px;color:#888">Card</div>
                            </div>
                            <div style="text-align:center">
                                <div style="font-size:24px;color:#fbbf24">1</div>
                                <div style="font-size:10px;color:#888">Back</div>
                            </div>
                        </div>
                        <div style="font-size:14px;color:#fff">Total: ${S.pages.length + 3} images</div>
                    </div>
                    
                    <button onclick="exportAllPages();S.activeSheet=null" class="btn btn-primary" style="width:100%;padding:14px;font-size:16px"> START EXPORT</button>
                </div>
            </div>
            
            <div class="sheet ${S.activeSheet === 'export-animated' ? 'show' : ''}">
                <div class="sheet-handle"></div>
                <div class="sheet-header"><span class="sheet-title"> EXPORT ANIMATED</span><button class="sheet-close" onclick="S.activeSheet=null;render()">${icon('x', 18)}</button></div>
                <div class="sheet-body" style="text-align:center">
                    <div style="font-size:48px;margin-bottom:12px"></div>
                    <p style="color:#888;margin-bottom:20px">Export your animated comic page!</p>
                    
                    <div style="display:grid;gap:12px;margin-bottom:20px">
                        <button onclick="exportAnimatedGIF()" style="width:100%;padding:16px;background:linear-gradient(135deg,#fff,#fff);border:none;border-radius:12px;color:#fff;font-size:16px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:12px">
                            <span style="font-size:28px"></span>
                            <div style="text-align:left">
                                <div>Export GIF</div>
                                <div style="font-size:11px;opacity:0.8">Perfect for social media</div>
                            </div>
                        </button>
                        
                        <button onclick="exportAnimatedVideo()" style="width:100%;padding:16px;background:#fff;border:none;border-radius:12px;color:#fff;font-size:16px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:12px">
                            <span style="font-size:28px"></span>
                            <div style="text-align:left">
                                <div>Export Video (MP4)</div>
                                <div style="font-size:11px;opacity:0.8">TikTok & Reels ready</div>
                            </div>
                        </button>
                        
                        <button onclick="exportWebComic()" style="width:100%;padding:16px;background:linear-gradient(135deg,#fff,#fff);border:none;border-radius:12px;color:#fff;font-size:16px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:12px">
                            <span style="font-size:28px"></span>
                            <div style="text-align:left">
                                <div>Export Web Comic</div>
                                <div style="font-size:11px;opacity:0.8">Interactive HTML file</div>
                            </div>
                        </button>
                    </div>
                    
                    <div style="background:#111;border-radius:8px;padding:12px;font-size:12px;color:#888">
                        <strong style="color:#fff"> Tip:</strong> Add animations to panels and elements first, then export!
                    </div>
                </div>
            </div>
            
            <div class="sheet ${S.activeSheet === 'gif-preview' ? 'show' : ''}">
                <div class="sheet-handle"></div>
                <div class="sheet-header"><span class="sheet-title"> GIF PREVIEW</span><button class="sheet-close" onclick="stopGifPreview()">${icon('x', 18)}</button></div>
                <div class="sheet-body" style="text-align:center">
                    <div style="background:#000;border-radius:8px;padding:8px;margin-bottom:16px">
                        <img id="gifPreviewImg" src="${S.gifFrames ? S.gifFrames[0] : ''}" style="max-width:100%;border-radius:4px">
                    </div>
                    <p style="color:#888;font-size:12px;margin-bottom:16px">
                         <strong>To save:</strong> Long-press the image above  "Save Image"<br>
                        Or screenshot while it's animating!
                    </p>
                    <div style="display:grid;gap:8px">
                        <button onclick="stopGifPreview()" class="btn btn-primary" style="padding:14px"> Done</button>
                    </div>
                </div>
            </div>
            
            <div class="sheet ${S.activeSheet === 'web-comic-ready' ? 'show' : ''}">
                <div class="sheet-handle"></div>
                <div class="sheet-header"><span class="sheet-title"> WEB COMIC READY!</span><button class="sheet-close" onclick="S.activeSheet=null;render()">${icon('x', 18)}</button></div>
                <div class="sheet-body" style="text-align:center">
                    <div style="font-size:64px;margin-bottom:16px"></div>
                    <h3 style="color:#fff;margin-bottom:8px">Your interactive comic is ready!</h3>
                    <p style="color:#888;margin-bottom:20px">Download the HTML file and open it in any browser to see your animated comic.</p>
                    
                    <div style="display:grid;gap:12px">
                        <button onclick="downloadWebComic()" class="btn btn-primary" style="padding:16px;font-size:16px">
                             Download HTML File
                        </button>
                        <a href="${S.webComicUrl || '#'}" target="_blank" style="display:block;padding:14px;background:#333;color:#fff;text-decoration:none;border-radius:8px;font-weight:bold">
                             Preview in New Tab
                        </a>
                        <button onclick="S.activeSheet=null;render()" class="btn btn-secondary">Close</button>
                    </div>
                </div>
            </div>
            
            <div class="sheet ${S.activeSheet === 'video-coming-soon' ? 'show' : ''}">
                <div class="sheet-handle"></div>
                <div class="sheet-header"><span class="sheet-title"> VIDEO EXPORT</span><button class="sheet-close" onclick="S.activeSheet=null;render()">${icon('x', 18)}</button></div>
                <div class="sheet-body" style="text-align:center">
                    <div style="font-size:64px;margin-bottom:16px"></div>
                    <h3 style="color:#fbbf24;margin-bottom:8px">Coming Soon!</h3>
                    <p style="color:#888;margin-bottom:20px">MP4 video export is in development. For now, try these alternatives:</p>
                    
                    <div style="background:#111;border-radius:8px;padding:16px;text-align:left;margin-bottom:16px">
                        <div style="margin-bottom:12px">
                            <strong style="color:#fff"> Export as GIF</strong>
                            <div style="font-size:12px;color:#888">Works great for short animations</div>
                        </div>
                        <div style="margin-bottom:12px">
                            <strong style="color:#fff"> Export as Web Comic</strong>
                            <div style="font-size:12px;color:#888">Screen record it playing!</div>
                        </div>
                        <div>
                            <strong style="color:#fff"> Screen Record</strong>
                            <div style="font-size:12px;color:#888">Use iOS/Android screen recording</div>
                        </div>
                    </div>
                    
                    <button onclick="S.activeSheet='export-animated';render()" class="btn btn-primary"> Back to Export Options</button>
                </div>
            </div>
            
            <!-- PRICING SHEET -->
            <div class="sheet ${S.activeSheet === 'pricing' ? 'show' : ''}" style="max-height:95vh">
                <div class="sheet-handle"></div>
                <div class="sheet-header" style="background:linear-gradient(90deg,#1a1a2e,#0a0a1a)"><span class="sheet-title" style="font-family:'Bebas Neue',sans-serif;letter-spacing:3px"> UPGRADE YOUR EXPERIENCE</span><button class="sheet-close" onclick="S.activeSheet=null;render()">${icon('x', 18)}</button></div>
                <div class="sheet-body" style="max-height:85vh;overflow-y:auto;padding-bottom:60px">
                    
                    <div style="text-align:center;margin-bottom:24px">
                        <div style="font-size:14px;color:#888">Choose the plan that's right for you</div>
                    </div>
                    
                    <!-- FREE TIER -->
                    <div style="background:#111;border:2px solid #333;border-radius:16px;padding:20px;margin-bottom:12px">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px">
                            <div>
                                <div style="font-size:20px;font-weight:bold;color:#fff"> FREE</div>
                                <div style="font-size:12px;color:#666">Forever free</div>
                            </div>
                            <div style="text-align:right">
                                <div style="font-size:28px;font-weight:bold;color:#fff">$0</div>
                            </div>
                        </div>
                        <div style="font-size:12px;color:#888;line-height:1.8">
                             Comic, Card & Cover Creator<br>
                             Social Feed & Community<br>
                             Battle Mode<br>
                             3 exports/day<br>
                             Watermarked exports<br>
                             5 cloud saves
                        </div>
                        <button style="width:100%;margin-top:16px;padding:12px;border-radius:8px;border:1px solid #333;background:transparent;color:#666;font-size:12px">Current Plan</button>
                    </div>
                    
                    <!-- PLUS TIER -->
                    <div style="background:linear-gradient(135deg,#0a1a0a,#0a0a0a);border:2px solid #4ade80;border-radius:16px;padding:20px;margin-bottom:12px">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px">
                            <div>
                                <div style="font-size:20px;font-weight:bold;color:#4ade80"> PLUS</div>
                                <div style="font-size:12px;color:#666">For creators</div>
                            </div>
                            <div style="text-align:right">
                                <div style="font-size:28px;font-weight:bold;color:#4ade80">$4.99</div>
                                <div style="font-size:10px;color:#666">/month</div>
                            </div>
                        </div>
                        <div style="font-size:12px;color:#888;line-height:1.8">
                             Everything in Free<br>
                             <strong style="color:#4ade80">No watermarks</strong><br>
                             <strong style="color:#4ade80">10 exports/day</strong><br>
                             <strong style="color:#4ade80">50+ premium templates</strong><br>
                             HD exports<br>
                             10 AI generations/month<br>
                             50 cloud saves
                        </div>
                        <button onclick="toast(' Payment coming soon!')" style="width:100%;margin-top:16px;padding:14px;border-radius:8px;border:none;background:#4ade80;color:#000;font-size:13px;font-weight:bold;cursor:pointer">Subscribe to Plus</button>
                    </div>
                    
                    <!-- PRO TIER -->
                    <div style="background:linear-gradient(135deg,#1a1a0a,#0a0a0a);border:2px solid #f59e0b;border-radius:16px;padding:20px;margin-bottom:12px;position:relative;overflow:hidden">
                        <div style="position:absolute;top:12px;right:12px;background:#f59e0b;color:#000;font-size:9px;font-weight:bold;padding:4px 10px;border-radius:20px">BEST VALUE</div>
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px">
                            <div>
                                <div style="font-size:20px;font-weight:bold;color:#f59e0b"> PRO</div>
                                <div style="font-size:12px;color:#666">For professionals</div>
                            </div>
                            <div style="text-align:right">
                                <div style="font-size:28px;font-weight:bold;color:#f59e0b">$9.99</div>
                                <div style="font-size:10px;color:#666">/month</div>
                            </div>
                        </div>
                        <div style="font-size:12px;color:#888;line-height:1.8">
                             Everything in Plus<br>
                             <strong style="color:#f59e0b">Unlimited exports</strong><br>
                             <strong style="color:#f59e0b">Unlimited AI generations</strong><br>
                             <strong style="color:#f59e0b">Priority support</strong><br>
                             Early access to features<br>
                             Unlimited cloud saves
                        </div>
                        <button onclick="toast(' Payment coming soon!')" style="width:100%;margin-top:16px;padding:14px;border-radius:8px;border:none;background:linear-gradient(135deg,#f59e0b,#d97706);color:#000;font-size:13px;font-weight:bold;cursor:pointer">Subscribe to Pro</button>
                    </div>
                    
                    <!-- CLASSROOM TIER -->
                    <div style="background:linear-gradient(135deg,#1a1a2a,#0a0a1a);border:2px solid #8b5cf6;border-radius:16px;padding:20px;margin-bottom:12px">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px">
                            <div>
                                <div style="font-size:20px;font-weight:bold;color:#8b5cf6"> CLASSROOM</div>
                                <div style="font-size:12px;color:#666">For educators</div>
                            </div>
                            <div style="text-align:right">
                                <div style="font-size:28px;font-weight:bold;color:#8b5cf6">$29.99</div>
                                <div style="font-size:10px;color:#666">/month</div>
                            </div>
                        </div>
                        <div style="font-size:12px;color:#888;line-height:1.8">
                             <strong style="color:#8b5cf6">30 student seats</strong><br>
                             Teacher dashboard<br>
                             Assignment system<br>
                             Safe social (filtered)<br>
                             Progress tracking<br>
                             No ads ever
                        </div>
                        <button onclick="toast(' Contact us at edu@comixx.app')" style="width:100%;margin-top:16px;padding:14px;border-radius:8px;border:none;background:#8b5cf6;color:#fff;font-size:13px;font-weight:bold;cursor:pointer">Contact for Classroom</button>
                    </div>
                    
                    <div style="text-align:center;margin-top:20px;font-size:11px;color:#555">
                        All plans include access to the full community & social features.<br>
                        <a href="#" onclick="S.activeSheet='terms';render()" style="color:#888">Terms of Service</a>  <a href="#" onclick="S.activeSheet='privacy';render()" style="color:#888">Privacy Policy</a>
                    </div>
                </div>
            </div>
            
            <!-- TERMS OF SERVICE -->
            <div class="sheet ${S.activeSheet === 'terms' ? 'show' : ''}" style="max-height:95vh">
                <div class="sheet-handle"></div>
                <div class="sheet-header"><span class="sheet-title"> TERMS OF SERVICE</span><button class="sheet-close" onclick="S.activeSheet=null;render()">${icon('x', 18)}</button></div>
                <div class="sheet-body" style="max-height:85vh;overflow-y:auto;padding-bottom:60px">
                    <div style="font-size:12px;color:#888;line-height:1.8">
                        <p style="color:#fff;font-weight:bold;margin-bottom:16px">Last Updated: ${new Date().toLocaleDateString()}</p>
                        
                        <h3 style="color:#fff;margin:16px 0 8px">1. Acceptance of Terms</h3>
                        <p>By accessing or using CoMiXX ("the App"), you agree to be bound by these Terms of Service. If you do not agree, do not use the App.</p>
                        
                        <h3 style="color:#fff;margin:16px 0 8px">2. Description of Service</h3>
                        <p>CoMiXX is a comic creation platform that allows users to create, share, and interact with digital comics, trading cards, and related content.</p>
                        
                        <h3 style="color:#fff;margin:16px 0 8px">3. User Accounts</h3>
                        <p>You may sign in using Google authentication. You are responsible for maintaining the security of your account and all activities that occur under it.</p>
                        
                        <h3 style="color:#fff;margin:16px 0 8px">4. User Content</h3>
                        <p>You retain ownership of content you create. By posting content, you grant CoMiXX a non-exclusive license to display, distribute, and promote your content within the platform.</p>
                        
                        <h3 style="color:#fff;margin:16px 0 8px">5. Prohibited Content</h3>
                        <p>Users may not post content that is: illegal, harmful to minors, harassing, hateful, violent, sexually explicit, or infringing on intellectual property rights.</p>
                        
                        <h3 style="color:#fff;margin:16px 0 8px">6. Subscriptions & Payments</h3>
                        <p>Premium features require a paid subscription. Subscriptions auto-renew unless cancelled. Refunds are handled according to the app store's policies.</p>
                        
                        <h3 style="color:#fff;margin:16px 0 8px">7. Termination</h3>
                        <p>We reserve the right to suspend or terminate accounts that violate these terms or engage in abusive behavior.</p>
                        
                        <h3 style="color:#fff;margin:16px 0 8px">8. Disclaimer</h3>
                        <p>The App is provided "as is" without warranties of any kind. We are not liable for any damages arising from your use of the App.</p>
                        
                        <h3 style="color:#fff;margin:16px 0 8px">9. Contact</h3>
                        <p>For questions about these terms, contact us at: support@comixx.app</p>
                    </div>
                </div>
            </div>
            
            <!-- PRIVACY POLICY -->
            <div class="sheet ${S.activeSheet === 'privacy' ? 'show' : ''}" style="max-height:95vh">
                <div class="sheet-handle"></div>
                <div class="sheet-header"><span class="sheet-title"> PRIVACY POLICY</span><button class="sheet-close" onclick="S.activeSheet=null;render()">${icon('x', 18)}</button></div>
                <div class="sheet-body" style="max-height:85vh;overflow-y:auto;padding-bottom:60px">
                    <div style="font-size:12px;color:#888;line-height:1.8">
                        <p style="color:#fff;font-weight:bold;margin-bottom:16px">Last Updated: ${new Date().toLocaleDateString()}</p>
                        
                        <h3 style="color:#fff;margin:16px 0 8px">1. Information We Collect</h3>
                        <p><strong>Account Information:</strong> When you sign in with Google, we receive your name, email address, and profile picture.</p>
                        <p><strong>Usage Data:</strong> We collect analytics data about how you use the app, including features used, pages created, and session duration.</p>
                        <p><strong>User Content:</strong> Comics, cards, and other content you create and choose to share.</p>
                        
                        <h3 style="color:#fff;margin:16px 0 8px">2. How We Use Your Information</h3>
                        <p> To provide and improve our services<br>
                         To personalize your experience<br>
                         To communicate with you about your account<br>
                         To analyze usage patterns and improve the app</p>
                        
                        <h3 style="color:#fff;margin:16px 0 8px">3. Information Sharing</h3>
                        <p>We do not sell your personal information. We may share data with:<br>
                         Service providers (Firebase, Google Analytics)<br>
                         Law enforcement when required by law</p>
                        
                        <h3 style="color:#fff;margin:16px 0 8px">4. Data Storage</h3>
                        <p>Your data is stored using Firebase (Google Cloud) with industry-standard security measures. Content you create is stored locally on your device and optionally synced to the cloud.</p>
                        
                        <h3 style="color:#fff;margin:16px 0 8px">5. Children's Privacy</h3>
                        <p>CoMiXX is designed for users 13 and older. Users under 13 require parental consent. We do not knowingly collect data from children under 13 without parental consent.</p>
                        
                        <h3 style="color:#fff;margin:16px 0 8px">6. Your Rights</h3>
                        <p>You have the right to:<br>
                         Access your data<br>
                         Delete your account and data<br>
                         Opt out of analytics tracking<br>
                         Request a copy of your data</p>
                        
                        <h3 style="color:#fff;margin:16px 0 8px">7. Cookies & Tracking</h3>
                        <p>We use Google Analytics to understand app usage. You can disable tracking in your browser settings.</p>
                        
                        <h3 style="color:#fff;margin:16px 0 8px">8. Contact</h3>
                        <p>For privacy questions or data requests, contact: privacy@comixx.app</p>
                    </div>
                </div>
            </div>`;
    }

    function renderModal() {
        if (!S.editModal) return '';
        return `<div class="modal">
            <div class="modal-box">
                <div class="modal-title">EDIT TEXT</div>
                <textarea class="input" rows="3" oninput="S.editText=this.value">${S.editText}</textarea>
                <div class="modal-btns">
                    <button class="btn btn-secondary" onclick="S.editModal=null;render()">CANCEL</button>
                    <button class="btn btn-primary" onclick="saveEdit()">SAVE</button>
                </div>
            </div>
        </div>`;
    }
    
    function renderPreviewMode() {
        if (!S.previewMode) return '';
        
        const totalPages = S.pages.length + 3; // Cover front, pages, card, cover back
        const pageNum = S.previewPage;
        const transClass = S.previewTransClass ? 'trans-' + S.pageTransition : '';
        const progress = ((pageNum + 1) / totalPages) * 100;
        const uiHidden = !S.readerUIVisible;
        
        // Generate FULL-SCREEN IMMERSIVE page content
        let pageContent = '';
        let pageLabel = '';
        let pageType = '';
        
        if (pageNum === 0) {
            // FRONT COVER - FULL VIEWPORT
            pageLabel = 'COVER';
            pageType = 'Front Cover';
            const t = S.cover.frontTransform || {};
            const template = S.cover.template || 'classic';
            pageContent = `
                <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;padding:12px;box-sizing:border-box">
                    <div style="width:100%;max-width:480px;height:95%;max-height:720px;background:${template==='horror'?'#0a0a0a':template==='scifi'?'#030318':template==='manga'?'#fff':template==='retro'?'#f5e6d3':template==='minimal'?'#fff':S.cover.style==='dark'?'linear-gradient(180deg,#0a0a0a,#1a1a2e)':S.cover.style==='vintage'?'#f4e4c1':'#222'};border-radius:${template==='minimal'?'0':template==='retro'?'4px':'12px'};overflow:hidden;display:flex;flex-direction:column;box-shadow:0 30px 80px rgba(0,0,0,0.9),${template==='horror'?'0 0 60px rgba(139,0,0,0.4)':template==='scifi'?'0 0 60px rgba(0,212,255,0.3)':'0 0 40px rgba(102,126,234,0.3)'};border:${template==='horror'?'4px solid #3a0a0a':template==='scifi'?'3px solid #00d4ff':template==='manga'?'3px solid #e91e63':template==='retro'?'6px solid #d4a574':template==='minimal'?'2px solid #000':'none'}">
                        <div style="background:${template==='horror'?'linear-gradient(180deg,#1a0a0a,#0a0a0a)':template==='scifi'?'linear-gradient(90deg,#00d4ff20,transparent)':template==='manga'?'transparent':template==='retro'?'linear-gradient(90deg,#ffd700,#ffb300)':S.cover.style==='dark'?'linear-gradient(90deg,#333,#555)':S.cover.style==='vintage'?'linear-gradient(90deg,#8b4513,#a0522d)':'linear-gradient(90deg,#c62828,#e53935)'};padding:16px 20px;display:flex;justify-content:space-between;align-items:center">
                            <span style="font-family:${template==='horror'?'Creepster,cursive,':''}Bangers,cursive;color:${template==='horror'?'#8b0000':template==='scifi'?'#00d4ff':template==='manga'?'#e91e63':template==='retro'?'#8b0000':'#fff'};font-size:clamp(18px,5vw,28px);text-shadow:${template==='retro'?'1px 1px 0 #fff':'1px 1px 3px rgba(0,0,0,0.5)'}">${S.cover.series}</span>
                            <span style="background:${template==='horror'?'transparent':template==='manga'?'#e91e63':template==='retro'?'#8b0000':'#fff'};color:${template==='horror'?'#8b0000':template==='manga'?'#fff':template==='retro'?'#ffd700':'#c62828'};padding:6px 14px;font-size:clamp(14px,3vw,18px);font-weight:bold;border-radius:4px">${S.cover.issue}</span>
                        </div>
                        <div style="flex:1;${S.cover.frontImage ? 'background-image:url('+S.cover.frontImage+');background-size:'+(t.scale||1)*100+'%;background-position:center' : 'background:linear-gradient(180deg,#222,#111)'};display:flex;flex-direction:column;justify-content:flex-end;padding:28px;background-repeat:no-repeat">
                            <div style="font-family:${template==='horror'?'Creepster,cursive,':''}Bangers,cursive;font-size:clamp(36px,12vw,72px);color:${template==='horror'?'#8b0000':template==='manga'?'#333':'#fff'};text-shadow:${template==='horror'?'0 0 30px #ff0000':template==='scifi'?'0 0 40px #00d4ff':'3px 3px 8px rgba(0,0,0,0.8),0 0 40px rgba(102,126,234,0.5)'}">${S.cover.title}</div>
                            <div style="font-size:clamp(16px,4vw,24px);color:${template==='horror'?'#666':template==='manga'?'#e91e63':template==='scifi'?'#00d4ff':'#ffd700'};text-shadow:2px 2px 4px rgba(0,0,0,0.8);margin-top:8px;${template==='manga'?'font-style:italic':''}">${S.cover.tagline}</div>
                        </div>
                        <div style="display:flex;justify-content:space-between;padding:14px 20px;font-size:13px;color:${template==='retro'||template==='manga'?'#333':'#888'};background:${template==='retro'?'#ffd700':template==='manga'?'#fce4ec':'transparent'}">
                            <span> ${S.cover.author || 'PRESS START CoMixx'}</span>
                            <span style="font-weight:bold;color:${template==='horror'?'#8b0000':template==='scifi'?'#00d4ff':template==='manga'?'#e91e63':''}">${S.cover.price}</span>
                        </div>
                    </div>
                </div>`;
        } else if (pageNum <= S.pages.length) {
            // COMIC PAGES - FULL VIEWPORT
            const pageIdx = pageNum - 1;
            pageLabel = pageNum;
            pageType = 'Page ' + pageNum + ' of ' + S.pages.length;
            const page = S.pages[pageIdx];
            pageContent = `
                <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;padding:12px;box-sizing:border-box">
                    <div style="width:100%;max-width:520px;height:95%;max-height:750px;background:#fff;position:relative;overflow:hidden;border-radius:4px;box-shadow:0 30px 80px rgba(0,0,0,0.9)">
                        ${page.panels.map((p, i) => {
                            const media = page.panelMedia[i];
                            const isVideo = media && media.isVideo;
                            const panelDrawingData = page.panelDrawings && page.panelDrawings[i];
                            const panelFrames = panelDrawingData?.frames || [];
                            const panelDrawing = panelFrames[0] || null;
                            return '<div style="position:absolute;left:'+p.x+'%;top:'+p.y+'%;width:'+p.w+'%;height:'+p.h+'%;border:3px solid #222;background:'+(media ? 'url('+media.src+')' : '#f5f5f5')+';background-size:cover;background-position:center;overflow:hidden">' +
                                (isVideo ? '<video src="'+media.src+'" autoplay loop muted playsinline style="width:100%;height:100%;object-fit:cover"></video>' : '') +
                                (panelDrawing ? '<img class="panel-drawing" data-panel="'+i+'" data-frame-count="'+panelFrames.length+'" src="'+panelDrawing+'" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;mix-blend-mode:multiply">' : '') +
                            '</div>';
                        }).join('')}
                        ${page.drawingData ? '<img src="'+page.drawingData+'" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;mix-blend-mode:multiply">' : ''}
                        ${page.pageElements.map(el => {
                            if (el.type === 'bubble') {
                                const bgColor = el.cls === 'shout' ? '#ffeb3b' : el.cls === 'burst' ? '#ff5722' : '#fff';
                                return '<div style="position:absolute;left:'+el.x+'%;top:'+el.y+'%;transform:translate(-50%,-50%) scale('+(el.scale||1)+') rotate('+(el.rotation||0)+'deg);background:'+bgColor+';padding:10px 16px;border-radius:16px;border:3px solid #000;font-family:Bangers,cursive;font-size:18px;white-space:nowrap">'+el.text+'</div>';
                            } else if (el.type === 'effect') {
                                return '<div style="position:absolute;left:'+el.x+'%;top:'+el.y+'%;transform:translate(-50%,-50%) scale('+(el.scale||1)+') rotate('+(el.rotation||0)+'deg);font-family:Bangers,cursive;font-size:32px;color:'+el.color+';text-shadow:3px 3px 0 #000,-3px -3px 0 #000,3px -3px 0 #000,-3px 3px 0 #000">'+el.text+'</div>';
                            } else if (el.type === 'emoji') {
                                return '<div style="position:absolute;left:'+el.x+'%;top:'+el.y+'%;transform:translate(-50%,-50%) scale('+(el.scale||1)+') rotate('+(el.rotation||0)+'deg);font-size:48px">'+el.emoji+'</div>';
                            }
                            return '';
                        }).join('')}
                    </div>
                </div>`;
        } else if (pageNum === S.pages.length + 1) {
            // TRADING CARD - FULL VIEWPORT - BOTH SIDES
            pageLabel = '';
            pageType = 'Trading Card';
            const ft = S.card.frontTransform || {};
            const template = S.card.template || 'classic';
            const borderColor = S.card.borderColor || getRarityColor(S.card.rarity || 'LEGENDARY');
            const hasCardBgImage = S.card.backBgImage;
            
            pageContent = `
                <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;gap:16px;padding:12px;box-sizing:border-box;flex-wrap:wrap">
                    <!-- FRONT CARD -->
                    <div style="width:min(300px,44vw);height:min(440px,75vh);background:${template==='retro'?'#f5e6d3':template==='neon'?'#0a0a1a':template==='minimal'?'#fff':'linear-gradient(180deg,#1a1a2e,#0f0f1a)'};border-radius:${template==='retro'?'8px':template==='minimal'?'4px':'16px'};overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,0.8),${template==='neon'?'0 0 50px #00ffff40':''};border:${template==='retro'?'8px solid #8b4513':template==='neon'?'3px solid #00ffff':template==='tcg'?'5px solid '+borderColor:template==='minimal'?'3px solid #222':'4px solid '+borderColor}">
                        <div style="padding:10px 14px;background:${template==='retro'?'#8b4513':template==='neon'?'linear-gradient(90deg,#ff00ff40,#00ffff40)':getRarityGradient(S.card.rarity||'LEGENDARY')};text-align:center">
                            <div style="font-family:'Bebas Neue',sans-serif;font-size:clamp(12px,3vw,16px);color:${template==='retro'?'#ffd700':'#fff'};letter-spacing:2px">${S.card.title || 'HERO CARD'}</div>
                        </div>
                        <div style="height:55%;${S.card.frontImage ? 'background:url('+S.card.frontImage+');background-size:'+(ft.scale||1)*100+'%;background-position:center;background-repeat:no-repeat' : 'background:#333'}"></div>
                        <div style="padding:10px 14px;background:${template==='retro'?'#8b4513':getRarityGradient(S.card.rarity||'LEGENDARY')};text-align:center">
                            <div style="font-family:'Bebas Neue',sans-serif;font-size:clamp(16px,4vw,22px);color:${template==='retro'?'#ffd700':'#fff'}">${S.card.name || 'CHARACTER'}</div>
                        </div>
                        <div style="display:flex;justify-content:space-around;padding:12px;font-size:clamp(10px,2.5vw,14px);font-weight:bold;color:#fff;background:${template==='retro'?'#d4c4a1':'rgba(0,0,0,0.3)'}">
                            <span>${S.card.stat1Label||'PWR'} ${S.card.stats?.pwr||85}</span>
                            <span>${S.card.stat2Label||'SPD'} ${S.card.stats?.spd||70}</span>
                            <span>${S.card.stat3Label||'INT'} ${S.card.stats?.int||90}</span>
                        </div>
                    </div>
                    <!-- BACK CARD -->
                    <div style="width:min(300px,44vw);height:min(440px,75vh);background:${hasCardBgImage ? 'url('+S.card.backBgImage+') center/cover' : template==='retro'?'#f5e6d3':template==='neon'?'#0a0a1a':template==='minimal'?'#fff':'linear-gradient(180deg,#1a1a2e,#0f0f1a)'};border-radius:${template==='retro'?'8px':template==='minimal'?'4px':'16px'};overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,0.8);border:${template==='retro'?'8px solid #8b4513':template==='neon'?'3px solid #00ffff':template==='minimal'?'3px solid #222':'4px solid '+borderColor};display:flex;flex-direction:column;position:relative">
                        ${hasCardBgImage ? '<div style="position:absolute;inset:0;background:'+(template==='retro'?'rgba(245,230,211,0.85)':template==='neon'?'rgba(10,10,26,0.8)':template==='minimal'?'rgba(255,255,255,0.9)':'rgba(26,26,46,0.85)')+';pointer-events:none"></div>' : ''}
                        <div style="position:relative;z-index:1;padding:16px;display:flex;flex-direction:column;height:100%">
                            <div style="font-family:'Bebas Neue',sans-serif;font-size:clamp(14px,3.5vw,18px);color:${template==='retro'?'#8b4513':template==='neon'?'#ff00ff':borderColor};text-align:center;margin-bottom:12px;letter-spacing:2px">${S.card.name || 'CHARACTER'}</div>
                            ${S.card.backImage ? '<div style="height:100px;background:url('+S.card.backImage+');background-size:cover;background-position:center;border-radius:8px;margin-bottom:12px"></div>' : ''}
                            <div style="flex:1;overflow:auto;font-size:clamp(11px,2.5vw,14px);color:${template==='retro'?'#5a3a1a':template==='minimal'?'#333':'#ccc'};line-height:1.6">${S.card.bio || 'Character bio goes here...'}</div>
                            ${S.card.abilities ? '<div style="font-size:clamp(10px,2vw,12px);color:'+borderColor+';margin-top:8px"> '+S.card.abilities+'</div>' : ''}
                            <div style="margin-top:auto;padding-top:12px;border-top:1px solid ${template==='minimal'?'#eee':'rgba(255,255,255,0.1)'};display:flex;justify-content:space-between;align-items:center">
                                <span style="font-size:clamp(10px,2vw,13px);color:${borderColor};font-weight:bold"> ${S.card.rarity || 'LEGENDARY'}</span>
                                <span style="font-size:10px;color:#666">${S.card.cardNumber || '#001'}</span>
                            </div>
                        </div>
                    </div>
                </div>`;
        } else {
            // BACK COVER - FULL VIEWPORT
            pageLabel = '';
            pageType = 'Back Cover';
            const template = S.cover.template || 'classic';
            const hasBgImage = S.cover.backBgImage;
            pageContent = `
                <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;padding:12px;box-sizing:border-box">
                    <div style="width:100%;max-width:480px;height:95%;max-height:720px;background:${hasBgImage ? 'url('+S.cover.backBgImage+') center/cover' : template==='horror'?'#0a0a0a':template==='scifi'?'#030318':template==='manga'?'#fff':template==='retro'?'#f5e6d3':template==='minimal'?'#fff':S.cover.style==='dark'?'linear-gradient(180deg,#0a0a0a,#1a1a2e)':S.cover.style==='vintage'?'#f4e4c1':'#222'};display:flex;flex-direction:column;border-radius:${template==='minimal'?'0':'12px'};box-shadow:0 30px 80px rgba(0,0,0,0.9);border:${template==='horror'?'4px solid #3a0a0a':template==='scifi'?'3px solid #00d4ff':template==='manga'?'3px solid #e91e63':template==='retro'?'6px solid #d4a574':template==='minimal'?'2px solid #000':'none'};position:relative;overflow:hidden">
                        ${hasBgImage ? '<div style="position:absolute;inset:0;background:'+(template==='horror'?'rgba(10,10,10,0.85)':template==='scifi'?'rgba(3,3,24,0.85)':template==='manga'?'rgba(255,255,255,0.9)':template==='retro'?'rgba(245,230,211,0.85)':template==='minimal'?'rgba(255,255,255,0.9)':'rgba(34,34,34,0.85)')+';pointer-events:none"></div>' : ''}
                        <div style="position:relative;z-index:1;padding:28px;display:flex;flex-direction:column;height:100%">
                            ${S.cover.backImage ? '<div style="height:180px;margin-bottom:20px;background:url('+S.cover.backImage+');background-size:cover;background-position:center;border-radius:12px"></div>' : ''}
                            <div style="font-size:clamp(14px,4vw,18px);color:${template==='manga'||template==='minimal'?'#333':template==='retro'?'#5a3a1a':'#ccc'};line-height:1.8;flex:1;overflow:auto">${S.cover.backText}</div>
                            <div style="font-size:clamp(11px,3vw,14px);color:${template==='manga'?'#e91e63':template==='retro'?'#8b4513':'#888'};white-space:pre-line;margin:24px 0;border-top:1px solid ${template==='manga'?'#fce4ec':template==='minimal'?'#eee':'rgba(255,255,255,0.2)'};padding-top:20px">${S.cover.credits}</div>
                            <div style="display:flex;justify-content:space-between;align-items:flex-end">
                                <div style="font-size:clamp(11px,3vw,14px);color:#666">${S.cover.website}<br><span style="font-size:10px"> PRESS START CoMixx</span></div>
                                <div style="width:70px;height:85px;background:${S.cover.barcodeImage ? 'url('+S.cover.barcodeImage+')' : 'linear-gradient(135deg,#fff,#eee)'};background-size:cover;border-radius:6px"></div>
                            </div>
                        </div>
                    </div>
                </div>`;
        }
        
        // VIRAL FEATURES - Share prompts, collect counter
        const viralOverlay = pageNum === S.pages.length + 1 ? `
            <div style="position:absolute;bottom:100px;left:50%;transform:translateX(-50%);display:flex;gap:12px;z-index:100">
                <button onclick="event.stopPropagation();shareCard()" style="padding:14px 24px;background:#fff;border:none;border-radius:30px;color:#fff;font-weight:bold;font-size:14px;cursor:pointer;box-shadow:0 8px 30px rgba(255,255,255,0.1)">
                     SHARE CARD
                </button>
                <button onclick="event.stopPropagation();saveToPhotos('card')" style="padding:14px 24px;background:linear-gradient(135deg,#999,#888);border:none;border-radius:30px;color:#fff;font-weight:bold;font-size:14px;cursor:pointer;box-shadow:0 8px 30px rgba(245,158,11,0.5)">
                     COLLECT
                </button>
            </div>
        ` : '';
        
        return `
            <div class="reader ${S.readerLayout}" onclick="toggleReaderUI()" style="position:fixed;inset:0;z-index:9999;background:#000;touch-action:${S.readerLayout==='vertical'?'pan-y':'none'}">
                <div class="reader-bg" style="position:absolute;inset:0;background:radial-gradient(ellipse at 50% 30%, rgba(255,255,255,0.03) 0%, transparent 60%),#050510"></div>
                
                <!-- FIXED CLOSE BUTTON - Always accessible on iPhone -->
                <button onclick="event.stopPropagation();exitPreviewMode()" style="position:fixed;top:55px;right:16px;z-index:10001;width:48px;height:48px;border-radius:50%;border:2px solid rgba(255,255,255,0.3);background:rgba(0,0,0,0.85);color:#fff;font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(0,0,0,0.6)"></button>
                
                <!-- Header -->
                <div style="position:absolute;top:0;left:0;right:0;padding:16px 20px;padding-top:max(16px,env(safe-area-inset-top));display:flex;justify-content:space-between;align-items:center;background:linear-gradient(180deg,rgba(0,0,0,0.8),transparent);z-index:100;opacity:${uiHidden?'0':'1'};transition:opacity 0.3s;pointer-events:${uiHidden?'none':'auto'}">
                    <div>
                        <div style="font-family:'Bangers',cursive;font-size:18px;color:#fff">PRESS START</div>
                        <div style="font-size:12px;color:#888">${S.cover.title || 'MY COMIC'}</div>
                    </div>
                    <div style="display:flex;gap:8px;margin-right:56px">
                        <button onclick="event.stopPropagation();setReaderLayout('horizontal')" style="padding:10px 16px;border-radius:20px;border:none;background:${S.readerLayout==='horizontal'?'rgba(102,126,234,0.3)':'rgba(255,255,255,0.1)'};color:#fff;font-size:12px;cursor:pointer"> Tap</button>
                        <button onclick="event.stopPropagation();setReaderLayout('vertical')" style="padding:10px 16px;border-radius:20px;border:none;background:${S.readerLayout==='vertical'?'rgba(102,126,234,0.3)':'rgba(255,255,255,0.1)'};color:#fff;font-size:12px;cursor:pointer"> Scroll</button>
                    </div>
                </div>
                
                <!-- Main Content -->
                <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;${S.readerLayout==='vertical'?'overflow-y:auto;flex-direction:column;padding:80px 0':''}">
                    ${S.readerLayout === 'horizontal' ? `
                        <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center">
                            ${pageContent}
                        </div>
                        <!-- TAP ZONES -->
                        <div onclick="event.stopPropagation();prevPreviewPageAnimated()" style="position:absolute;left:0;top:0;width:30%;height:100%;cursor:pointer;z-index:50"></div>
                        <div onclick="event.stopPropagation();nextPreviewPageAnimated()" style="position:absolute;right:0;top:0;width:30%;height:100%;cursor:pointer;z-index:50"></div>
                        <!-- PAGE INDICATORS -->
                        <div style="position:absolute;left:20px;top:50%;transform:translateY(-50%);color:rgba(255,255,255,${pageNum>0?'0.6':'0.15'});font-size:48px;pointer-events:none"></div>
                        <div style="position:absolute;right:20px;top:50%;transform:translateY(-50%);color:rgba(255,255,255,${pageNum<totalPages-1?'0.6':'0.15'});font-size:48px;pointer-events:none"></div>
                    ` : `
                        <!-- VERTICAL SCROLL MODE -->
                        ${Array.from({length: totalPages}, (_, i) => {
                            const savedPage = S.previewPage;
                            S.previewPage = i;
                            const content = renderVerticalPage(i, totalPages);
                            S.previewPage = savedPage;
                            return '<div style="width:100%;min-height:90vh;display:flex;align-items:center;justify-content:center;padding:20px 0">' + content + '</div>';
                        }).join('')}
                    `}
                </div>
                
                ${viralOverlay}
                
                <!-- Footer -->
                <div style="position:absolute;bottom:0;left:0;right:0;padding:16px 20px;background:linear-gradient(0deg,rgba(0,0,0,0.9),transparent);z-index:100;opacity:${uiHidden?'0':'1'};transition:opacity 0.3s;pointer-events:${uiHidden?'none':'auto'}" onclick="event.stopPropagation()">
                    <!-- Progress Bar -->
                    <div style="height:3px;background:rgba(255,255,255,0.2);border-radius:2px;margin-bottom:16px;overflow:hidden">
                        <div style="height:100%;width:${progress}%;background:linear-gradient(90deg,#fff,#888);transition:width 0.3s"></div>
                    </div>
                    <!-- Nav -->
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <button onclick="prevPreviewPageAnimated()" style="width:50px;height:50px;border-radius:50%;border:none;background:${pageNum>0?'rgba(102,126,234,0.3)':'rgba(255,255,255,0.1)'};color:#fff;font-size:20px;cursor:pointer" ${pageNum===0?'disabled':''}></button>
                        <div style="text-align:center">
                            <div style="font-size:28px;font-weight:bold;color:#fff">${pageLabel}</div>
                            <div style="font-size:11px;color:#888">${pageType}</div>
                        </div>
                        <button onclick="nextPreviewPageAnimated()" style="width:50px;height:50px;border-radius:50%;border:none;background:${pageNum<totalPages-1?'rgba(102,126,234,0.3)':'rgba(255,255,255,0.1)'};color:#fff;font-size:20px;cursor:pointer" ${pageNum>=totalPages-1?'disabled':''}></button>
                    </div>
                    <!-- Thumbnails -->
                    <div style="display:flex;justify-content:center;gap:6px;margin-top:14px;overflow-x:auto;padding:4px 0">
                        ${Array.from({length: totalPages}, (_, i) => `
                            <div onclick="goToPreviewPage(${i})" style="min-width:36px;height:36px;border:2px solid #fff,#888)':'rgba(255,255,255,0.1)'};display:flex;align-items:center;justify-content:center;color:${i===pageNum?'#fff':'#888'};font-size:12px;cursor:pointer;font-weight:${i===pageNum?'bold':'normal'};border:2px solid ${i===pageNum?'#fff':'transparent'}">
                                ${i === 0 ? '' : i === totalPages - 1 ? '' : i === totalPages - 2 ? '' : i}
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>`;
    }
    
    function renderVerticalPage(pageNum, totalPages) {
        // Generates content for vertical scroll mode
        if (pageNum === 0) {
            return renderCoverForScroll('front');
        } else if (pageNum <= S.pages.length) {
            return renderPageForScroll(pageNum - 1);
        } else if (pageNum === S.pages.length + 1) {
            return renderCardForScroll();
        } else {
            return renderCoverForScroll('back');
        }
    }
    
    function renderCoverForScroll(side) {
        const t = side === 'front' ? S.cover.frontTransform || {} : {};
        if (side === 'front') {
            return '<div style="width:90%;max-width:400px;aspect-ratio:2/3;background:'+(S.cover.frontImage?'url('+S.cover.frontImage+') center/cover':'linear-gradient(180deg,#c62828,#222)')+';border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.8);display:flex;flex-direction:column;justify-content:flex-end;padding:24px"><div style="font-family:Bangers,cursive;font-size:32px;color:#fff;text-shadow:2px 2px 6px #000">'+S.cover.title+'</div><div style="color:#ffd700">'+S.cover.tagline+'</div></div>';
        }
        return '<div style="width:90%;max-width:400px;aspect-ratio:2/3;background:#1a1a2e;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.8);padding:24px;color:#ccc;font-size:14px;line-height:1.7">'+S.cover.backText+'</div>';
    }
    
    function renderPageForScroll(idx) {
        const page = S.pages[idx];
        if (!page) return '';
        return '<div style="width:90%;max-width:450px;aspect-ratio:8.5/11;background:#fff;border-radius:8px;box-shadow:0 20px 60px rgba(0,0,0,0.8);position:relative;overflow:hidden">' + 
            page.panels.map((p, i) => {
                const media = page.panelMedia[i];
                return '<div style="position:absolute;left:'+p.x+'%;top:'+p.y+'%;width:'+p.w+'%;height:'+p.h+'%;border:2px solid #222;background:'+(media?'url('+media.src+') center/cover':'#f5f5f5')+'"></div>';
            }).join('') +
        '</div>';
    }
    
    function renderCardForScroll() {
        return '<div style="display:flex;gap:16px;flex-wrap:wrap;justify-content:center"><div style="width:200px;height:280px;background:linear-gradient(180deg,#1a1a2e,#0f0f1a);border-radius:12px;border:3px solid #999;box-shadow:0 20px 60px rgba(0,0,0,0.8)"></div><div style="width:200px;height:280px;background:linear-gradient(180deg,#1a1a2e,#0f0f1a);border-radius:12px;border:3px solid #999;box-shadow:0 20px 60px rgba(0,0,0,0.8)"></div></div>';
    }
    
    function shareCard() {
        // Generate shareable card with unique code
        const cardCode = 'PS' + Math.random().toString(36).substr(2, 6).toUpperCase();
        S.card.shareCode = cardCode;
        
        if (navigator.share) {
            navigator.share({
                title: S.card.name + ' - Press Start Card',
                text: ' Check out my Press Start card! Code: ' + cardCode + '  Collect & trade at pscomixx.online',
                url: 'https://pscomixx.online/card/' + cardCode
            });
        } else {
            // Copy to clipboard
            navigator.clipboard.writeText(' ' + S.card.name + ' Card\\nCode: ' + cardCode + '\\n pscomixx.online/card/' + cardCode);
            showToast(' Card code copied! ' + cardCode);
        }
    }

    // ========== ECOSYSTEM SCREEN RENDERERS ==========
    
    function renderEcosystemScreens() {
        if (!S.activeScreen) return '';
        
        const screens = {
            'profile': renderProfileScreen,
            'collection': renderCollectionScreen,
            'feed': renderFeedScreen,
            'leaderboard': renderLeaderboardScreen,
            'progress': renderProgressScreen,
            'teacher': renderTeacherScreen
        };
        
        const renderer = screens[S.activeScreen];
        if (!renderer) return '';
        
        return `
            <div style="position:fixed;inset:0;background:#0a0a0f;z-index:9999;overflow-y:auto">
                <!-- Header -->
                <div style="position:sticky;top:0;background:linear-gradient(180deg,#0a0a0f,transparent);padding:16px;display:flex;justify-content:space-between;align-items:center;z-index:10">
                    <button onclick="S.activeScreen=null;render()" style="background:rgba(255,255,255,0.1);border:none;color:#fff;padding:10px 16px;border-radius:20px;cursor:pointer;font-size:13px"> Back</button>
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:18px;color:#fff;letter-spacing:2px">${S.activeScreen.toUpperCase()}</div>
                    <div style="width:70px"></div>
                </div>
                ${renderer()}
            </div>
        `;
    }
    
    function renderProfileScreen() {
        const nextUpgrade = getNextRarityCost();
        return `
            <div style="padding:0 20px 100px">
                <!-- Avatar & Name -->
                <div style="text-align:center;padding:20px 0">
                    <div style="width:100px;height:100px;background:#fff;border-radius:50%;margin:0 auto 16px;display:flex;align-items:center;justify-content:center;font-size:48px;border:4px solid #fff">
                        ${S.user.avatar || ''}
                    </div>
                    <div style="font-size:24px;color:#fff;font-weight:700">${S.user.name}</div>
                    <div style="font-size:14px;color:#888">${S.user.handle}</div>
                    <div style="margin-top:8px;display:inline-block;background:${getRarityGradient(S.card.rarity)};padding:6px 16px;border-radius:20px;font-size:12px;color:${['LEGENDARY','MYTHIC'].includes(S.card.rarity)?'#000':'#fff'};font-weight:700">${S.card.rarity}</div>
                </div>
                
                <!-- Stats Grid -->
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px">
                    <div style="background:rgba(255,255,255,0.05);padding:16px;border-radius:12px;text-align:center">
                        <div style="font-size:28px;color:#999;font-weight:800"> ${S.user.credits}</div>
                        <div style="font-size:11px;color:#888">Credits</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.05);padding:16px;border-radius:12px;text-align:center">
                        <div style="font-size:28px;color:#bbb;font-weight:800"> ${S.user.level}</div>
                        <div style="font-size:11px;color:#888">Level</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.05);padding:16px;border-radius:12px;text-align:center">
                        <div style="font-size:28px;color:#fff;font-weight:800"> ${S.cardCollection.length}</div>
                        <div style="font-size:11px;color:#888">Cards</div>
                    </div>
                </div>
                
                <!-- Battle Record -->
                <div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:16px;margin-bottom:24px">
                    <div style="font-size:14px;color:#fff;font-weight:600;margin-bottom:12px"> Battle Record</div>
                    <div style="display:flex;gap:20px">
                        <div style="flex:1;text-align:center">
                            <div style="font-size:32px;color:#fff;font-weight:800">${S.battleRecord.wins}</div>
                            <div style="font-size:11px;color:#888">Wins</div>
                        </div>
                        <div style="flex:1;text-align:center">
                            <div style="font-size:32px;color:#888;font-weight:800">${S.battleRecord.losses}</div>
                            <div style="font-size:11px;color:#888">Losses</div>
                        </div>
                        <div style="flex:1;text-align:center">
                            <div style="font-size:32px;color:#999;font-weight:800">${S.battleRecord.wins + S.battleRecord.losses > 0 ? Math.round(S.battleRecord.wins / (S.battleRecord.wins + S.battleRecord.losses) * 100) : 0}%</div>
                            <div style="font-size:11px;color:#888">Win Rate</div>
                        </div>
                    </div>
                </div>
                
                <!-- Upgrade Rarity -->
                ${nextUpgrade ? `
                    <div style="background:linear-gradient(135deg,rgba(245,158,11,0.2),rgba(139,92,246,0.2));padding:20px;border-radius:16px;margin-bottom:24px;border:1px solid rgba(245,158,11,0.3)">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                            <div>
                                <div style="font-size:14px;color:#fff;font-weight:600"> Upgrade to ${nextUpgrade.rarity}</div>
                                <div style="font-size:12px;color:#888">+${S.RARITY_POOLS[nextUpgrade.rarity] - S.RARITY_POOLS[S.card.rarity]} stat points</div>
                            </div>
                            <div style="font-size:18px;color:#999;font-weight:700"> ${nextUpgrade.cost}</div>
                        </div>
                        <button onclick="upgradeRarity()" style="width:100%;padding:14px;border-radius:30px;border:none;background:${S.user.credits >= nextUpgrade.cost ? 'linear-gradient(135deg,#999,#fbbf24)' : '#333'};color:${S.user.credits >= nextUpgrade.cost ? '#000' : '#666'};font-weight:700;cursor:${S.user.credits >= nextUpgrade.cost ? 'pointer' : 'not-allowed'};font-size:14px">
                            ${S.user.credits >= nextUpgrade.cost ? ' UPGRADE NOW' : `Need ${nextUpgrade.cost - S.user.credits} more credits`}
                        </button>
                    </div>
                ` : `
                    <div style="background:linear-gradient(135deg,rgba(236,72,153,0.2),rgba(139,92,246,0.2));padding:20px;border-radius:16px;margin-bottom:24px;text-align:center">
                        <div style="font-size:24px;margin-bottom:8px"></div>
                        <div style="font-size:16px;color:#fff;font-weight:700">MAXIMUM RARITY!</div>
                        <div style="font-size:12px;color:#888">You've reached MYTHIC status</div>
                    </div>
                `}
                
                <!-- Quick Actions -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <button onclick="S.activeScreen='collection';render()" style="padding:16px;border-radius:12px;border:none;background:rgba(255,255,255,0.08);color:#fff;cursor:pointer;text-align:left">
                        <div style="font-size:20px;margin-bottom:4px"></div>
                        <div style="font-size:13px;font-weight:600">My Collection</div>
                        <div style="font-size:11px;color:#888">${S.cardCollection.length} cards</div>
                    </button>
                    <button onclick="S.activeScreen='progress';render()" style="padding:16px;border-radius:12px;border:none;background:rgba(255,255,255,0.08);color:#fff;cursor:pointer;text-align:left">
                        <div style="font-size:20px;margin-bottom:4px"></div>
                        <div style="font-size:13px;font-weight:600">Book Progress</div>
                        <div style="font-size:11px;color:#888">${getBookProgress().completed}/${getBookProgress().total} chapters</div>
                    </button>
                </div>
            </div>
        `;
    }
    
    function renderCollectionScreen() {
        return `
            <div style="padding:0 16px 100px">
                <!-- Collection Stats -->
                <div style="display:flex;gap:12px;margin-bottom:20px">
                    <div style="flex:1;background:rgba(255,255,255,0.05);padding:12px;border-radius:12px;text-align:center">
                        <div style="font-size:24px;color:#999;font-weight:700">${S.cardCollection.length}</div>
                        <div style="font-size:10px;color:#888">Total Cards</div>
                    </div>
                    <div style="flex:1;background:rgba(255,255,255,0.05);padding:12px;border-radius:12px;text-align:center">
                        <div style="font-size:24px;color:#fff;font-weight:700">${S.cardCollection.filter(c => c.origin === 'won_battle').length}</div>
                        <div style="font-size:10px;color:#888">Won in Battle</div>
                    </div>
                    <div style="flex:1;background:rgba(255,255,255,0.05);padding:12px;border-radius:12px;text-align:center">
                        <div style="font-size:24px;color:#fff;font-weight:700">${S.cardCollection.filter(c => c.locked).length}</div>
                        <div style="font-size:10px;color:#888">Locked</div>
                    </div>
                </div>
                
                <!-- Add New Card -->
                <button onclick="saveCardToCollection()" style="width:100%;padding:14px;border-radius:12px;border:2px dashed #444;background:transparent;color:#888;cursor:pointer;margin-bottom:20px;font-size:13px">
                    + Save Current Card to Collection
                </button>
                
                <!-- Card Grid -->
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">
                    ${S.cardCollection.map((card, i) => `
                        <div style="background:linear-gradient(135deg,#1a1a2e,#0a0a1a);border-radius:12px;overflow:hidden;border:2px solid ${card.locked ? '#999' : getRarityColor(card.rarity)}">
                            <!-- Card Preview -->
                            <div style="aspect-ratio:3/4;background:#111;display:flex;align-items:center;justify-content:center;position:relative" onclick="loadCardFromCollection(${i})">
                                ${card.frontImage ? `<img src="${card.frontImage}" style="width:100%;height:100%;object-fit:cover">` : `<span style="font-size:48px"></span>`}
                                ${card.locked ? `<div style="position:absolute;top:8px;right:8px;background:#999;color:#000;padding:4px 8px;border-radius:12px;font-size:10px"></div>` : ''}
                                ${card.origin === 'won_battle' ? `<div style="position:absolute;top:8px;left:8px;background:#fff;color:#fff;padding:4px 8px;border-radius:12px;font-size:10px"></div>` : ''}
                            </div>
                            <!-- Card Info -->
                            <div style="padding:10px">
                                <div style="font-size:12px;color:#fff;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${card.name || 'Unnamed'}</div>
                                <div style="font-size:10px;color:${getRarityColor(card.rarity)}">${card.rarity}</div>
                                <div style="display:flex;gap:6px;margin-top:8px">
                                    <button onclick="event.stopPropagation();toggleCardLock(${i})" style="flex:1;padding:6px;border-radius:6px;border:none;background:rgba(255,255,255,0.1);color:#fff;cursor:pointer;font-size:10px">${card.locked ? '' : ''}</button>
                                    <button onclick="event.stopPropagation();loadCardFromCollection(${i})" style="flex:1;padding:6px;border-radius:6px;border:none;background:#ccc;color:#fff;cursor:pointer;font-size:10px">Edit</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    function renderFeedScreen() {
        return `
            <div style="padding:0 16px 100px">
                <!-- Publish Button -->
                <button onclick="publishComic()" style="width:100%;padding:16px;border-radius:12px;border:none;background:linear-gradient(135deg,#ccc,#1d4ed8);color:#fff;font-weight:700;cursor:pointer;margin-bottom:20px;font-size:14px">
                     Publish Your Comic (+25 )
                </button>
                
                <!-- Feed -->
                <div style="font-size:14px;color:#fff;font-weight:600;margin-bottom:12px"> Trending Comics</div>
                
                <div style="display:flex;flex-direction:column;gap:12px">
                    ${S.comicFeed.map(comic => `
                        <div style="background:rgba(255,255,255,0.05);border-radius:12px;overflow:hidden;display:flex">
                            <!-- Thumbnail -->
                            <div style="width:100px;height:100px;background:linear-gradient(135deg,#1a1a2e,#2a1a3a);display:flex;align-items:center;justify-content:center" onclick="readComic(${comic.id})">
                                <span style="font-size:36px"></span>
                            </div>
                            <!-- Info -->
                            <div style="flex:1;padding:12px;display:flex;flex-direction:column;justify-content:space-between">
                                <div>
                                    <div style="font-size:14px;color:#fff;font-weight:600">${comic.title}</div>
                                    <div style="font-size:11px;color:#888">${comic.creator}</div>
                                </div>
                                <div style="display:flex;gap:12px;align-items:center">
                                    <span style="font-size:11px;color:#888"> ${comic.views}</span>
                                    <button onclick="likeComic(${comic.id})" style="background:none;border:none;color:#888;cursor:pointer;font-size:11px;padding:0"> ${comic.likes}</button>
                                    <button onclick="readComic(${comic.id})" style="margin-left:auto;background:#fff;border:none;color:#fff;padding:6px 12px;border-radius:12px;cursor:pointer;font-size:11px">Read +5</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    function renderLeaderboardScreen() {
        return `
            <div style="padding:0 16px 100px">
                <!-- Your Rank -->
                <div style="background:linear-gradient(135deg,rgba(245,158,11,0.2),rgba(139,92,246,0.2));padding:16px;border-radius:12px;margin-bottom:20px;display:flex;align-items:center;gap:12px">
                    <div style="font-size:28px"></div>
                    <div style="flex:1">
                        <div style="font-size:12px;color:#888">Your Ranking</div>
                        <div style="font-size:20px;color:#fff;font-weight:700">#${S.leaderboard.length + 1}</div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-size:18px;color:#999;font-weight:700"> ${S.user.credits}</div>
                        <div style="font-size:11px;color:#888">${S.battleRecord.wins} wins</div>
                    </div>
                </div>
                
                <!-- Leaderboard -->
                <div style="font-size:14px;color:#fff;font-weight:600;margin-bottom:12px"> Top Players</div>
                
                <div style="display:flex;flex-direction:column;gap:8px">
                    ${S.leaderboard.map((player, i) => `
                        <div style="background:rgba(255,255,255,0.05);padding:14px;border-radius:12px;display:flex;align-items:center;gap:12px;${i < 3 ? 'border:1px solid ' + ['#ffd700','#c0c0c0','#cd7f32'][i] : ''}">
                            <div style="font-size:${i < 3 ? '24px' : '16px'};width:36px;text-align:center">
                                ${i === 0 ? '' : i === 1 ? '' : i === 2 ? '' : '#' + (i + 1)}
                            </div>
                            <div style="flex:1">
                                <div style="font-size:14px;color:#fff;font-weight:600">${player.name}</div>
                                <div style="font-size:11px;color:${getRarityColor(player.rarity)}">${player.rarity}  ${player.wins} wins</div>
                            </div>
                            <div style="font-size:16px;color:#999;font-weight:700"> ${player.credits}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    function renderProgressScreen() {
        const progress = getBookProgress();
        return `
            <div style="padding:0 16px 100px">
                <!-- Progress Overview -->
                <div style="background:linear-gradient(135deg,rgba(139,92,246,0.2),rgba(59,130,246,0.2));padding:20px;border-radius:16px;margin-bottom:24px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                        <div>
                            <div style="font-size:18px;color:#fff;font-weight:700"> Press Start</div>
                            <div style="font-size:12px;color:#888">Game of Life Book Series</div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-size:24px;color:#bbb;font-weight:800">${progress.percentage}%</div>
                            <div style="font-size:11px;color:#888">${progress.completed}/${progress.total}</div>
                        </div>
                    </div>
                    <div style="height:8px;background:rgba(0,0,0,0.3);border-radius:4px;overflow:hidden">
                        <div style="height:100%;width:${progress.percentage}%;background:linear-gradient(90deg,#bbb,#ccc);border-radius:4px"></div>
                    </div>
                    <div style="margin-top:12px;font-size:12px;color:#888">
                        Total earned from books: <span style="color:#999;font-weight:700"> ${S.bookProgress.totalEarned}</span>
                    </div>
                </div>
                
                <!-- Chapters -->
                <div style="font-size:14px;color:#fff;font-weight:600;margin-bottom:12px"> Chapters</div>
                
                <div style="display:flex;flex-direction:column;gap:10px">
                    ${S.bookProgress.chapters.map(ch => `
                        <div style="background:rgba(255,255,255,0.05);padding:14px;border-radius:12px;display:flex;align-items:center;gap:12px;opacity:${ch.completed ? '0.6' : '1'}">
                            <div style="width:36px;height:36px;background:${ch.completed ? '#fff' : 'rgba(139,92,246,0.3)'};border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px;font-weight:700">
                                ${ch.completed ? '' : ch.id}
                            </div>
                            <div style="flex:1">
                                <div style="font-size:13px;color:#fff;font-weight:500">${ch.title}</div>
                                <div style="font-size:11px;color:#888">Reward:  ${ch.reward}</div>
                            </div>
                            ${!ch.completed ? `
                                <button onclick="completeChapter(${ch.id})" style="padding:8px 14px;border-radius:20px;border:none;background:#bbb;color:#fff;font-size:11px;cursor:pointer;font-weight:600">Complete</button>
                            ` : `
                                <span style="color:#fff;font-size:12px"> Done</span>
                            `}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    function renderTeacherScreen() {
        return `
            <div style="padding:0 16px 100px">
                <!-- Class Code -->
                <div style="background:linear-gradient(135deg,rgba(34,197,94,0.2),rgba(59,130,246,0.2));padding:20px;border-radius:16px;margin-bottom:24px;text-align:center">
                    <div style="font-size:12px;color:#888;margin-bottom:8px">CLASS CODE</div>
                    <div style="font-size:32px;color:#fff;font-weight:800;font-family:monospace;letter-spacing:4px">${S.classroom.code}</div>
                    <div style="font-size:11px;color:#888;margin-top:8px">Share this code with students to join</div>
                </div>
                
                <!-- Class Stats -->
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px">
                    <div style="background:rgba(255,255,255,0.05);padding:14px;border-radius:12px;text-align:center">
                        <div style="font-size:24px;color:#ccc;font-weight:700">${S.classroom.students.length}</div>
                        <div style="font-size:10px;color:#888">Students</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.05);padding:14px;border-radius:12px;text-align:center">
                        <div style="font-size:24px;color:#fff;font-weight:700">${S.classroom.students.reduce((a,s) => a + s.comicsCreated, 0)}</div>
                        <div style="font-size:10px;color:#888">Comics Made</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.05);padding:14px;border-radius:12px;text-align:center">
                        <div style="font-size:24px;color:#999;font-weight:700">${S.classroom.students.reduce((a,s) => a + s.credits, 0)}</div>
                        <div style="font-size:10px;color:#888">Total Credits</div>
                    </div>
                </div>
                
                <!-- Settings -->
                <div style="background:rgba(255,255,255,0.05);padding:16px;border-radius:12px;margin-bottom:24px">
                    <div style="font-size:14px;color:#fff;font-weight:600;margin-bottom:12px"> Battle Settings</div>
                    <div style="display:flex;flex-direction:column;gap:10px">
                        <label style="display:flex;align-items:center;gap:10px;cursor:pointer">
                            <input type="checkbox" ${S.classroom.settings.allowKeepsBattles ? 'checked' : ''} onchange="S.classroom.settings.allowKeepsBattles=this.checked;render()" style="width:18px;height:18px">
                            <span style="font-size:13px;color:#fff">Allow "For Keeps" Battles</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:10px;cursor:pointer">
                            <input type="checkbox" ${S.classroom.settings.requireBattleApproval ? 'checked' : ''} onchange="S.classroom.settings.requireBattleApproval=this.checked;render()" style="width:18px;height:18px">
                            <span style="font-size:13px;color:#fff">Require Battle Approval</span>
                        </label>
                    </div>
                </div>
                
                <!-- Students -->
                <div style="font-size:14px;color:#fff;font-weight:600;margin-bottom:12px"> Students</div>
                
                <div style="display:flex;flex-direction:column;gap:10px">
                    ${S.classroom.students.map(student => `
                        <div style="background:rgba(255,255,255,0.05);padding:14px;border-radius:12px;display:flex;align-items:center;gap:12px">
                            <div style="width:40px;height:40px;background:${getRarityGradient(student.rarity)};border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px">
                                
                            </div>
                            <div style="flex:1">
                                <div style="font-size:13px;color:#fff;font-weight:600">${student.name}</div>
                                <div style="font-size:10px;color:${getRarityColor(student.rarity)}">${student.rarity}   ${student.comicsCreated} comics   ${student.comicsRead} read</div>
                            </div>
                            <div style="text-align:right">
                                <div style="font-size:14px;color:#999;font-weight:700"> ${student.credits}</div>
                                <button onclick="awardBonusCredits(${student.id}, 50, 'good work')" style="background:#fff;border:none;color:#fff;padding:4px 10px;border-radius:10px;cursor:pointer;font-size:10px;margin-top:4px">+50 Bonus</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <!-- Active Challenges -->
                <div style="font-size:14px;color:#fff;font-weight:600;margin:24px 0 12px"> Challenges</div>
                
                <div style="display:flex;flex-direction:column;gap:10px">
                    ${S.classroom.challenges.map(ch => `
                        <div style="background:rgba(255,255,255,0.05);padding:14px;border-radius:12px">
                            <div style="display:flex;justify-content:space-between;align-items:center">
                                <div style="font-size:13px;color:#fff;font-weight:600">${ch.title}</div>
                                <div style="font-size:12px;color:#999"> ${ch.reward}</div>
                            </div>
                            <div style="font-size:11px;color:#888;margin-top:4px">
                                ${ch.winner ? `Winner: ${ch.winner} ` : `Deadline: ${ch.deadline}`}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    function renderToast() {
        return `<div class="toast ${S.toast ? 'show' : ''}">${S.toast || ''}</div>`;
    }
    
    function renderSavePreview() {
        if (!S.savePreview) return '';
        var imgSrc = S.savePreview.dataUrl || '';
        if (!imgSrc) return '';
        
        var fileName = S.savePreview.type === 'card' ? (S.card.name || 'card') + '.png' : 
                       S.savePreview.type === 'comic' ? 'comic-page.png' : 
                       S.savePreview.type === 'ai-image' ? 'ai-generated.png' : 'image.png';
        
        // Show exports remaining
        var exportsMsg = S.adminConfig.exportLimitsEnabled && !S.adminConfig.classroomMode ? 
            `<div style="color:#888;font-size:11px;margin-top:12px"> ${getExportsRemaining()} exports remaining today</div>` : '';
        
        return '<div style="position:fixed;inset:0;background:#000;z-index:10002;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px">' +
            '<img src="' + imgSrc + '" style="max-height:50vh;max-width:100%;object-fit:contain;border-radius:12px;border:2px solid #333">' +
            '<div style="margin-top:24px;text-align:center">' +
                '<h3 style="color:#fff;font-size:18px;margin-bottom:16px"> SAVE YOUR IMAGE</h3>' +
                '<div style="color:#888;font-size:13px;margin-bottom:8px"><strong style="color:#fff">1.</strong> Press and hold the image above</div>' +
                '<div style="color:#888;font-size:13px;margin-bottom:20px"><strong style="color:#fff">2.</strong> Tap "Add to Photos" or "Save Image"</div>' +
                exportsMsg +
            '</div>' +
            '<div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">' +
                '<a href="' + imgSrc + '" download="' + fileName + '" style="padding:14px 24px;background:#fff;border:none;border-radius:30px;color:#000;font-weight:bold;font-size:14px;text-decoration:none;cursor:pointer"> Download</a>' +
                '<button onclick="closeSavePreview()" style="padding:14px 24px;background:transparent;border:2px solid #fff;border-radius:30px;color:#fff;font-weight:bold;font-size:14px;cursor:pointer"> DONE</button>' +
            '</div>' +
        '</div>';
    }
    
    function renderUpgradeModal() {
        if (!S.upgradeModal?.show) return '';
        
        const feature = S.upgradeModal.feature || 'premium';
        const messages = {
            exports: { title: ' Export Limit Reached', desc: "You've used all your free exports for today!", highlight: 'Upgrade for more exports' },
            ai: { title: ' AI Feature', desc: 'AI image generation is a premium feature', highlight: 'Unlock unlimited AI' },
            premium: { title: ' Premium Feature', desc: 'This feature requires a premium subscription', highlight: 'Unlock all features' },
            cloudSave: { title: ' Cloud Save', desc: 'Save your work to the cloud', highlight: 'Never lose your creations' },
            templates: { title: ' Premium Templates', desc: 'Access 50+ exclusive templates', highlight: 'Stand out from the crowd' }
        };
        
        const msg = messages[feature] || messages.premium;
        
        return `
        <div style="position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:10003;display:flex;align-items:center;justify-content:center;padding:20px" onclick="closeUpgradeModal()">
            <div style="background:linear-gradient(135deg,#1a1a2e,#0a0a1a);border:2px solid #333;border-radius:24px;padding:32px;max-width:400px;width:100%;text-align:center;position:relative" onclick="event.stopPropagation()">
                
                <!-- Glow effect -->
                <div style="position:absolute;top:-50%;left:-50%;right:-50%;bottom:-50%;background:radial-gradient(circle at center,rgba(139,92,246,0.1) 0%,transparent 70%);pointer-events:none"></div>
                
                <!-- Close button -->
                <button onclick="closeUpgradeModal()" style="position:absolute;top:16px;right:16px;background:none;border:none;color:#666;font-size:24px;cursor:pointer"></button>
                
                <!-- Icon -->
                <div style="font-size:64px;margin-bottom:16px"></div>
                
                <!-- Title -->
                <h2 style="color:#fff;font-size:24px;margin-bottom:8px;font-family:'Bebas Neue',sans-serif;letter-spacing:2px">${msg.title}</h2>
                
                <!-- Description -->
                <p style="color:#888;font-size:14px;margin-bottom:24px;line-height:1.5">${msg.desc}</p>
                
                <!-- Tiers -->
                <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:24px">
                    <div style="background:#111;border:2px solid #4ade80;border-radius:12px;padding:16px;text-align:left">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <div>
                                <div style="color:#4ade80;font-weight:bold;font-size:16px"> PLUS</div>
                                <div style="color:#888;font-size:11px">10 exports/day  No watermarks</div>
                            </div>
                            <div style="color:#4ade80;font-weight:bold;font-size:18px">$4.99<span style="font-size:10px;color:#666">/mo</span></div>
                        </div>
                    </div>
                    
                    <div style="background:linear-gradient(135deg,#1a1a0a,#0a0a0a);border:2px solid #f59e0b;border-radius:12px;padding:16px;text-align:left;position:relative;overflow:hidden">
                        <div style="position:absolute;top:0;right:0;background:#f59e0b;color:#000;font-size:9px;font-weight:bold;padding:4px 12px;border-radius:0 0 0 8px">BEST VALUE</div>
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <div>
                                <div style="color:#f59e0b;font-weight:bold;font-size:16px"> PRO</div>
                                <div style="color:#888;font-size:11px">Unlimited everything  AI access</div>
                            </div>
                            <div style="color:#f59e0b;font-weight:bold;font-size:18px">$9.99<span style="font-size:10px;color:#666">/mo</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- CTA -->
                <button onclick="S.activeSheet='pricing';closeUpgradeModal()" style="width:100%;padding:16px;background:linear-gradient(135deg,#8b5cf6,#6366f1);border:none;border-radius:12px;color:#fff;font-weight:bold;font-size:16px;cursor:pointer;margin-bottom:12px">
                    View All Plans
                </button>
                
                <button onclick="closeUpgradeModal()" style="width:100%;padding:12px;background:transparent;border:none;color:#666;font-size:13px;cursor:pointer">
                    Maybe later
                </button>
                
                <div style="margin-top:16px;font-size:10px;color:#444">
                     Educator? <a href="#" onclick="S.activeSheet='contact';closeUpgradeModal()" style="color:#8b5cf6">Contact us for classroom pricing</a>
                </div>
            </div>
        </div>
        `;
    }
    
    function renderPremiumBadge(tier) {
        try {
            if (!tier || tier === 'free') return '';
            const badges = {
                plus: '<span style="background:linear-gradient(135deg,#4ade80,#22c55e);color:#000;font-size:8px;font-weight:bold;padding:2px 6px;border-radius:4px;margin-left:6px"> PLUS</span>',
                pro: '<span style="background:linear-gradient(135deg,#f59e0b,#d97706);color:#000;font-size:8px;font-weight:bold;padding:2px 6px;border-radius:4px;margin-left:6px"> PRO</span>',
                classroom: '<span style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:#fff;font-size:8px;font-weight:bold;padding:2px 6px;border-radius:4px;margin-left:6px"> EDU</span>'
            };
            return badges[tier] || '';
        } catch(e) {
            console.error('renderPremiumBadge error:', e);
            return '';
        }
    }
    
    function renderSaveHelp() {
        if (!S.saveHelp) return '';
        
        var typeLabel = S.saveHelp === 'comic' ? 'Comic' : S.saveHelp === 'card' ? 'Card' : 'Cover';
        
        return '<div class="save-modal">' +
            '<div class="save-instructions" style="margin-top:0">' +
                '<h3> SAVE YOUR ' + typeLabel.toUpperCase() + '</h3>' +
                '<div class="save-step">' +
                    '<span class="save-step-num">1</span>' +
                    '<span>Tap <strong>DONE</strong> to close this</span>' +
                '</div>' +
                '<div class="save-step">' +
                    '<span class="save-step-num">2</span>' +
                    '<span><strong>Long-press</strong> on your ' + typeLabel.toLowerCase() + '</span>' +
                '</div>' +
                '<div class="save-step">' +
                    '<span class="save-step-num">3</span>' +
                    '<span>Tap <strong>"Copy"</strong> from the menu</span>' +
                '</div>' +
                '<div class="save-step">' +
                    '<span class="save-step-num">4</span>' +
                    '<span>Open Photos/Instagram and <strong>Paste</strong>! </span>' +
                '</div>' +
            '</div>' +
            '<button class="save-close-btn" onclick="closeSaveHelp()">DONE</button>' +
        '</div>';
    }

    // Initialize light mode from localStorage
    function initLightMode() {
        const isLight = localStorage.getItem('pscomixx_lightmode') === 'true';
        if (isLight) {
            document.body.classList.add('light-mode');
        }
        S.lightMode = isLight;
    }
    
    // ========== COLLABORATION FUNCTIONS ==========
    
    let collabListener = null;
    
    function generateCollabCode() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let code = '';
        for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
        return code;
    }
    
    function createCollab() {
        const name = document.getElementById('collabNameInput')?.value || 'Collab ' + new Date().toLocaleDateString();
        const code = generateCollabCode();
        const sessionId = 'collab_' + code;
        
        const sessionData = {
            id: sessionId,
            code: code,
            name: name,
            createdAt: Date.now(),
            hostId: S.user.id,
            hostName: S.playerName || 'Host',
            status: 'active'
        };
        
        // Try Firebase, but work locally if not available
        if (firebaseReady && firebaseDb) {
            sessionData.participants = {};
            sessionData.participants[currentUser?.uid || S.user.id] = {
                name: S.playerName || 'Host',
                role: 'host',
                joinedAt: Date.now()
            };
            sessionData.pages = {};
            
            firebaseDb.ref('collabs/' + sessionId).set(sessionData)
                .then(() => {
                    S.collabSession = sessionData;
                    S.collabMode = true;
                    S.collabRole = 'host';
                    S.collabPages = [];
                    S.collabParticipants = [{id: currentUser?.uid || S.user.id, name: S.playerName || 'Host', role: 'host'}];
                    startCollabListener(sessionId);
                    toast(' Collab created! Code: ' + code);
                    render();
                })
                .catch(err => {
                    console.error('Firebase failed, using local:', err);
                    setupLocalCollab(sessionData);
                });
        } else {
            // Local mode
            setupLocalCollab(sessionData);
        }
    }
    
    function setupLocalCollab(sessionData) {
        S.collabSession = sessionData;
        S.collabMode = true;
        S.collabRole = 'host';
        S.collabPages = [];
        S.collabParticipants = [{id: S.user.id, name: S.playerName || 'Host', role: 'host'}];
        toast(' Collab created! Code: ' + sessionData.code);
        render();
    }
    
    function joinCollab(code) {
        if (!code || code.length < 4) {
            toast('Enter a valid code');
            return;
        }
        
        const sessionId = 'collab_' + code.toUpperCase();
        
        if (firebaseReady && firebaseDb) {
            firebaseDb.ref('collabs/' + sessionId).once('value')
                .then(snapshot => {
                    if (!snapshot.exists()) {
                        toast('Session not found');
                        return;
                    }
                    const data = snapshot.val();
                    if (data.status !== 'active') {
                        toast('Session has ended');
                        return;
                    }
                    
                    const myId = currentUser?.uid || S.user.id;
                    firebaseDb.ref('collabs/' + sessionId + '/participants/' + myId).set({
                        name: S.playerName || 'Guest',
                        role: 'guest',
                        joinedAt: Date.now()
                    });
                    
                    S.collabSession = data;
                    S.collabMode = true;
                    S.collabRole = data.hostId === myId ? 'host' : 'guest';
                    S.collabPages = data.pages ? Object.values(data.pages) : [];
                    S.collabParticipants = data.participants ? Object.entries(data.participants).map(([id,p]) => ({id,...p})) : [];
                    
                    startCollabListener(sessionId);
                    toast(' Joined collab!');
                    render();
                })
                .catch(err => {
                    console.error('Join failed:', err);
                    toast('Could not find session');
                });
        } else {
            // Local mode - just show a message
            toast('Share the link directly to collaborate');
        }
    }
    
    function startCollabListener(sessionId) {
        if (collabListener) firebaseDb.ref('collabs/' + collabListener).off();
        collabListener = sessionId;
        
        let initialLoad = true;
        let lastPageCount = 0;
        
        // Listen for pages - this syncs all comic content in real-time
        firebaseDb.ref('collabs/' + sessionId + '/pages').on('value', snap => {
            if (snap.exists()) {
                const pages = Object.values(snap.val());
                // Sort by creation time
                pages.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
                
                // Check if new page was added (not on initial load)
                if (!initialLoad && pages.length > lastPageCount) {
                    const newPage = pages[pages.length - 1];
                    if (newPage.authorId !== (currentUser?.uid || S.user.id)) {
                        toast(' ' + (newPage.author || 'Someone') + ' added a new page!');
                    }
                }
                
                lastPageCount = pages.length;
                S.collabPages = pages;
                render();
            } else {
                S.collabPages = [];
                render();
            }
            initialLoad = false;
        });
        
        // Listen for participants
        firebaseDb.ref('collabs/' + sessionId + '/participants').on('value', snap => {
            if (snap.exists()) {
                const participants = Object.entries(snap.val()).map(([id, p]) => ({id, ...p}));
                
                // Notify when someone joins (not on initial load)
                if (!initialLoad && participants.length > S.collabParticipants.length) {
                    const newPerson = participants.find(p => !S.collabParticipants.find(sp => sp.id === p.id));
                    if (newPerson && newPerson.id !== (currentUser?.uid || S.user.id)) {
                        toast(' ' + (newPerson.name || 'Someone') + ' joined!');
                    }
                }
                
                S.collabParticipants = participants;
                render();
            }
        });
        
        // Listen for session status
        firebaseDb.ref('collabs/' + sessionId + '/status').on('value', snap => {
            if (snap.val() === 'ended' && S.collabRole !== 'host') {
                toast('Host ended the session');
                leaveCollab(true);
            }
        });
        
        console.log(' Live sync started for:', sessionId);
    }
    
    function copyCollabLink() {
        const link = window.location.origin + window.location.pathname + '?collab=' + S.collabSession.code;
        navigator.clipboard.writeText(link).then(() => toast(' Link copied!')).catch(() => prompt('Share code:', S.collabSession.code));
    }
    
    // Track user's live page in collab
    let collabSyncTimeout = null;
    let myCollabPageId = null;
    
    function syncPageToCollab() {
        if (!S.collabMode || !S.collabSession?.id) return;
        
        // Debounce - wait 500ms after last change before syncing
        if (collabSyncTimeout) clearTimeout(collabSyncTimeout);
        
        collabSyncTimeout = setTimeout(() => {
            const currentPage = JSON.parse(JSON.stringify(getPage()));
            
            // Check if page has any content
            const hasContent = currentPage.panelMedia?.some(m => m?.src) || 
                              currentPage.pageElements?.length > 0 ||
                              currentPage.panels?.some(p => p.text || p.image);
            
            if (!hasContent) return; // Don't sync empty pages
            
            const myId = currentUser?.uid || S.user.id;
            
            // Create or update my live page
            if (!myCollabPageId) {
                myCollabPageId = 'live_' + myId + '_' + Date.now();
            }
            
            const pageEntry = {
                id: myCollabPageId,
                author: S.playerName || 'Guest',
                authorId: myId,
                createdAt: Date.now(),
                updatedAt: Date.now(),
                isLive: true, // Mark as live/in-progress
                pageData: currentPage
            };
            
            // Sync to Firebase
            if (firebaseReady && firebaseDb) {
                firebaseDb.ref('collabs/' + S.collabSession.id + '/pages/' + myCollabPageId).set(pageEntry)
                    .then(() => {
                        console.log(' Page synced to collab');
                    })
                    .catch(err => {
                        console.error('Sync failed:', err);
                    });
            }
        }, 500);
    }
    
    // Call this when user finishes a page and wants to start fresh
    function finishCollabPage() {
        if (!S.collabMode || !S.collabSession?.id) return;
        
        // Mark current page as finished (not live)
        if (myCollabPageId && firebaseReady && firebaseDb) {
            firebaseDb.ref('collabs/' + S.collabSession.id + '/pages/' + myCollabPageId + '/isLive').set(false);
        }
        
        // Reset for new page
        myCollabPageId = null;
        S.pages[S.currentPage] = createPage();
        toast(' Page finished! Start a new one.');
        render();
    }
    
    function addPageToCollab() {
        if (!S.collabSession?.id) {
            toast('Not in a collab');
            return;
        }
        
        if (S.collabPages.length >= S.COLLAB_MAX_PAGES) {
            toast('Max pages reached!');
            return;
        }
        
        const pageId = 'page_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
        const currentPage = JSON.parse(JSON.stringify(getPage())); // Deep copy
        
        const pageEntry = {
            id: pageId,
            author: S.playerName || 'Guest',
            authorId: currentUser?.uid || S.user.id,
            createdAt: Date.now(),
            pageData: currentPage // Full page data with panels, images, elements
        };
        
        // Save to Firebase for real-time sync
        if (firebaseReady && firebaseDb) {
            firebaseDb.ref('collabs/' + S.collabSession.id + '/pages/' + pageId).set(pageEntry)
                .then(() => {
                    toast(' Page added! Others will see it now.');
                    // Clear current page for next creation
                    S.pages[S.currentPage] = createPage();
                    render();
                })
                .catch(err => {
                    console.error('Failed to add page:', err);
                    toast('Failed to sync page');
                });
        } else {
            // Local only
            S.collabPages.push(pageEntry);
            toast(' Page added (local only)');
            S.pages[S.currentPage] = createPage();
            render();
        }
    }
    
    function loadCollabPage(index) {
        // Load a collab page into the editor to view/edit
        if (S.collabPages[index] && S.collabPages[index].pageData) {
            S.pages[S.currentPage] = JSON.parse(JSON.stringify(S.collabPages[index].pageData));
            S.activeSheet = null;
            toast(' Loaded page ' + (index + 1) + ' by ' + (S.collabPages[index].author || 'Guest'));
            render();
        }
    }
    
    function leaveCollab(silent) {
        if (S.collabRole === 'host' && !silent) {
            if (!confirm('End collab for everyone?')) return;
            if (firebaseReady && S.collabSession?.id) {
                firebaseDb.ref('collabs/' + S.collabSession.id + '/status').set('ended');
            }
        }
        
        if (firebaseReady && S.collabSession?.id) {
            const myId = currentUser?.uid || S.user.id;
            firebaseDb.ref('collabs/' + S.collabSession.id + '/participants/' + myId).remove();
        }
        
        if (collabListener) {
            firebaseDb.ref('collabs/' + collabListener).off();
            collabListener = null;
        }
        
        // Reset auto-sync state
        if (collabSyncTimeout) {
            clearTimeout(collabSyncTimeout);
            collabSyncTimeout = null;
        }
        myCollabPageId = null;
        
        S.collabSession = null;
        S.collabMode = false;
        S.collabRole = null;
        S.collabPages = [];
        S.collabParticipants = [];
        if (!silent) toast('Left collab');
        render();
    }
    
    function exportCollab() {
        if (S.collabPages.length > 0) {
            S.collabPages.forEach((p, i) => {
                if (p.pageData) {
                    if (i === 0) S.pages[0] = p.pageData;
                    else S.pages.push(p.pageData);
                }
            });
            S.currentPage = 0;
            toast(' Imported ' + S.collabPages.length + ' pages!');
            
            // Offer to share to feed
            if (confirm('Share this collab to the Community Feed?')) {
                shareToFeed(true);
            }
        }
        S.activeSheet = null;
        render();
    }
    
    function checkCollabInURL() {
        const params = new URLSearchParams(window.location.search);
        const code = params.get('collab');
        if (code) {
            const tryJoin = () => {
                if (firebaseReady) {
                    joinCollab(code);
                    window.history.replaceState({}, '', window.location.pathname);
                } else setTimeout(tryJoin, 500);
            };
            setTimeout(tryJoin, 1000);
        }
    }
    
    // ========== COMMUNITY FEED FUNCTIONS ==========
    
    function shareToFeed(isCollab = false) {
        // Generate default caption based on content type
        let defaultCaption = '';
        const contentType = S.activeTab || 'comic';
        
        if (isCollab) {
            defaultCaption = ` Collab ${contentType} with ${S.collabParticipants?.length || 1} creators!`;
        } else if (contentType === 'card') {
            defaultCaption = ` Check out my ${S.card?.rarity || 'custom'} card: "${S.card?.name || 'New Card'}"!`;
        } else if (contentType === 'cover') {
            defaultCaption = ` New comic cover design!`;
        } else {
            defaultCaption = S.pages?.length > 1 ? ` ${S.pages.length}-page comic!` : ' New comic page!';
        }
        
        // Show custom caption modal
        S.postModal = {
            show: true,
            isCollab: isCollab,
            contentType: contentType,
            caption: defaultCaption
        };
        S.activeSheet = 'post-modal';
        render();
    }
    
    function confirmPost() {
        const captionInput = document.getElementById('postCaptionInput');
        const caption = captionInput?.value || '';
        const contentType = S.postModal?.contentType || S.activeTab || 'comic';
        
        const post = {
            id: 'post_' + Date.now(),
            author: S.playerName || 'Creator',
            authorId: S.user?.id || 'user_' + Date.now(),
            time: new Date().toLocaleString(),
            type: contentType,
            pageCount: contentType === 'comic' ? (S.pages?.length || 1) : 1,
            isCollab: S.postModal?.isCollab || S.collabMode,
            collabCode: S.collabSession?.code || null,
            collabParticipants: S.collabParticipants?.length || 1,
            likes: 0,
            comments: 0,
            commentsList: [],
            liked: false,
            saved: false,
            caption: caption,
            thumbnail: null,
            createdAt: Date.now(),
            // Content-specific data
            cardData: contentType === 'card' ? {
                name: S.card?.name,
                rarity: S.card?.rarity,
                stats: S.card?.stats
            } : null,
            coverData: contentType === 'cover' ? {
                title: S.cover?.title,
                template: S.cover?.template
            } : null
        };
        
        // Generate thumbnail from canvas
        generatePostThumbnail(post);
        
        // Add to local feed
        S.communityFeed.unshift(post);
        localStorage.setItem('pscomixx_feed', JSON.stringify(S.communityFeed.slice(0, 100)));
        
        // Save to Firebase if available
        if (firebaseReady && firebaseDb) {
            firebaseDb.ref('feed/' + post.id).set(post).catch(e => console.log('Feed save failed:', e));
        }
        
        S.postModal = null;
        const typeEmoji = contentType === 'card' ? '' : contentType === 'cover' ? '' : '';
        toast(`${typeEmoji} Posted to Community!`);
        
        // Track post to feed
        trackEvent('post_shared', {
            post_type: contentType,
            is_collab: post.isCollab,
            page_count: post.pageCount
        });
        
        S.activeSheet = 'social-feed';
        S.feedTab = 'foryou';
        render();
    }
    
    function cancelPost() {
        S.postModal = null;
        S.activeSheet = null;
        render();
    }
    
    function addTagToCaption(tag) {
        const input = document.getElementById('postCaptionInput');
        if (input) {
            const currentText = input.value;
            if (!currentText.includes(tag)) {
                input.value = currentText + (currentText ? ' ' : '') + tag;
            }
        }
    }
    
    function renderCardPreviewForPost() {
        if (!S.card) return '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666">No card</div>';
        
        const card = S.card;
        const rarityColors = {
            'COMMON': '#888',
            'UNCOMMON': '#4ade80',
            'RARE': '#3b82f6',
            'EPIC': '#a855f7',
            'LEGENDARY': '#f59e0b',
            'MYTHIC': '#ef4444'
        };
        const color = rarityColors[card.rarity] || '#888';
        
        return `
            <div style="width:100%;height:100%;background:linear-gradient(135deg,#1a1a2e,#0f0f1a);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px">
                <div style="width:85%;max-width:280px;aspect-ratio:2.5/3.5;background:linear-gradient(135deg,#111,#1a1a2e);border-radius:16px;border:3px solid ${color};box-shadow:0 0 30px ${color}40;overflow:hidden;display:flex;flex-direction:column">
                    <!-- Card Header -->
                    <div style="padding:12px;background:linear-gradient(90deg,${color}22,transparent);border-bottom:1px solid ${color}44">
                        <div style="font-family:'Bebas Neue',sans-serif;font-size:18px;color:#fff;letter-spacing:1px">${card.name || 'UNNAMED'}</div>
                        <div style="font-size:10px;color:${color};letter-spacing:2px">${card.rarity || 'COMMON'}</div>
                    </div>
                    <!-- Card Image -->
                    <div style="flex:1;background:#000;display:flex;align-items:center;justify-content:center;overflow:hidden">
                        ${card.frontImage ? `<img src="${card.frontImage}" style="width:100%;height:100%;object-fit:cover">` : `<div style="font-size:48px"></div>`}
                    </div>
                    <!-- Card Stats -->
                    <div style="padding:12px;background:#0a0a15;display:flex;justify-content:space-around">
                        <div style="text-align:center"><div style="font-size:18px;font-weight:bold;color:${color}">${card.stats?.power || 50}</div><div style="font-size:8px;color:#666">PWR</div></div>
                        <div style="text-align:center"><div style="font-size:18px;font-weight:bold;color:${color}">${card.stats?.speed || 50}</div><div style="font-size:8px;color:#666">SPD</div></div>
                        <div style="text-align:center"><div style="font-size:18px;font-weight:bold;color:${color}">${card.stats?.intelligence || 50}</div><div style="font-size:8px;color:#666">INT</div></div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function renderCoverPreviewForPost() {
        if (!S.cover) return '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666">No cover</div>';
        
        const cover = S.cover;
        const templateColors = {
            'classic': '#c9a227',
            'horror': '#8b0000',
            'scifi': '#00bfff',
            'manga': '#ff69b4',
            'retro': '#ff6b35',
            'minimal': '#333',
            'superhero': '#dc143c',
            'noir': '#1a1a1a',
            'fantasy': '#9370db',
            'western': '#8b4513',
            'romance': '#ff1493'
        };
        const color = templateColors[cover.template] || '#c9a227';
        
        return `
            <div style="width:100%;height:100%;background:#0a0a0a;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px">
                <div style="width:90%;max-width:300px;aspect-ratio:2/3;background:linear-gradient(180deg,#1a1a2e,#0f0f1a);border-radius:8px;border:3px solid ${color};box-shadow:0 0 30px ${color}40;overflow:hidden;display:flex;flex-direction:column">
                    <!-- Cover Header -->
                    <div style="padding:10px;text-align:center;background:linear-gradient(180deg,${color}33,transparent)">
                        <div style="font-size:10px;color:${color};letter-spacing:3px;text-transform:uppercase">${cover.series || 'PRESS START COMICS'}</div>
                    </div>
                    <!-- Cover Image -->
                    <div style="flex:1;background:${cover.frontImage ? 'url('+cover.frontImage+') center/cover' : '#111'};position:relative;display:flex;flex-direction:column;justify-content:flex-end">
                        ${!cover.frontImage ? `<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:48px;opacity:0.3"></div>` : ''}
                        <div style="background:linear-gradient(transparent,rgba(0,0,0,0.9));padding:16px">
                            <div style="font-family:'Bangers',cursive;font-size:24px;color:#fff;text-shadow:2px 2px 4px #000">${cover.title || 'UNTITLED'}</div>
                            ${cover.tagline ? `<div style="font-size:11px;color:#aaa;font-style:italic;margin-top:4px">${cover.tagline}</div>` : ''}
                        </div>
                    </div>
                    <!-- Cover Footer -->
                    <div style="padding:8px 12px;display:flex;justify-content:space-between;background:#0a0a0a;border-top:1px solid ${color}44">
                        <span style="font-size:9px;color:#666">ISSUE ${cover.issue || '#1'}</span>
                        <span style="font-size:9px;color:${color};font-weight:bold">${cover.price || '$4.99'}</span>
                    </div>
                </div>
            </div>
        `;
    }
    
    function renderFullPagePreview() {
        const page = getPage();
        if (!page) return '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666">No page</div>';
        
        const panels = page.panels || [];
        const panelMedia = page.panelMedia || {};
        const pageElements = page.pageElements || [];
        const bgColor = page.bgColor || '#000';
        
        // Check if there's any content
        const hasContent = Object.keys(panelMedia).some(k => panelMedia[k]?.src) || pageElements.length > 0;
        
        if (!hasContent && panels.length === 0) {
            return `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#666;text-align:center;padding:20px;background:${bgColor}">
                <div style="font-size:48px;margin-bottom:12px"></div>
                <div style="font-size:14px;color:#888">Your comic page is empty</div>
                <div style="font-size:12px;color:#555;margin-top:8px">Add images and elements first!</div>
            </div>`;
        }
        
        // Build full page HTML with panels
        let html = `<div style="position:relative;width:100%;height:100%;background:${bgColor};overflow:hidden">`;
        
        // Render panels
        panels.forEach((panel, i) => {
            const media = panelMedia[i];
            const hasImage = media?.src;
            const transform = media ? `scale(${media.scale || 1}) rotate(${media.rotation || 0}deg) translate(${media.offsetX || 0}px, ${media.offsetY || 0}px)` : '';
            
            html += `<div style="position:absolute;left:${panel.x}%;top:${panel.y}%;width:${panel.w}%;height:${panel.h}%;background:#111;border:2px solid #333;border-radius:${panel.r || 0}px;overflow:hidden">`;
            
            if (hasImage) {
                if (media.isVideo) {
                    html += `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#000"><span style="font-size:24px"></span></div>`;
                } else {
                    html += `<img src="${media.src}" style="width:100%;height:100%;object-fit:cover;transform:${transform}">`;
                }
            } else {
                html += `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#333;font-size:20px">+</div>`;
            }
            
            html += `</div>`;
        });
        
        // Render page elements (bubbles, effects, stickers)
        pageElements.forEach(el => {
            const x = el.x || 50;
            const y = el.y || 50;
            const scale = el.scale || 1;
            const rotation = el.rotation || 0;
            
            if (el.type === 'bubble') {
                const bubbleStyles = {
                    speech: 'background:#fff;color:#000;border-radius:20px;padding:8px 12px;',
                    thought: 'background:#fff;color:#000;border-radius:50%;padding:8px 12px;',
                    shout: 'background:#ff0;color:#000;border-radius:4px;padding:8px 12px;font-weight:bold;',
                    whisper: 'background:#ddd;color:#666;border-radius:20px;padding:8px 12px;font-style:italic;font-size:10px;',
                    narration: 'background:#000;color:#fff;border:1px solid #fff;padding:8px 12px;'
                };
                const style = bubbleStyles[el.cls] || bubbleStyles.speech;
                html += `<div style="position:absolute;left:${x}%;top:${y}%;transform:translate(-50%,-50%) scale(${scale * 0.6}) rotate(${rotation}deg);${style}font-size:10px;max-width:80px;text-align:center;white-space:pre-wrap;word-break:break-word">${el.text || ''}</div>`;
            } else if (el.type === 'effect') {
                const colors = { red: '#ff0000', blue: '#00aaff', yellow: '#ffff00', green: '#00ff00', purple: '#aa00ff', white: '#ffffff' };
                const color = colors[el.color] || el.color || '#ffff00';
                html += `<div style="position:absolute;left:${x}%;top:${y}%;transform:translate(-50%,-50%) scale(${scale * 0.6}) rotate(${rotation}deg);color:${color};font-size:14px;font-weight:bold;font-family:Impact,sans-serif;text-shadow:2px 2px 0 #000,-2px -2px 0 #000,2px -2px 0 #000,-2px 2px 0 #000">${el.text || ''}</div>`;
            } else if (el.type === 'sticker' || el.type === 'emoji') {
                html += `<div style="position:absolute;left:${x}%;top:${y}%;transform:translate(-50%,-50%) scale(${scale * 0.8}) rotate(${rotation}deg);font-size:24px">${el.emoji || el.src || ''}</div>`;
            }
        });
        
        html += `</div>`;
        
        return html;
    }
    
    // Keep simple version for feed thumbnails
    function renderPostPreview() {
        return renderFullPagePreview();
    }
    
    function generatePostThumbnail(post) {
        // Determine what element to capture based on content type
        let targetSelector = '.canvas';
        if (post.type === 'card') {
            targetSelector = '.epic-card, #card-front-content, .card-3d-wrap';
        } else if (post.type === 'cover') {
            targetSelector = '#cover-front-content';
        }
        
        // Try to capture element
        try {
            const target = document.querySelector(targetSelector);
            if (target && typeof html2canvas !== 'undefined') {
                html2canvas(target, { 
                    scale: 1.5, 
                    backgroundColor: '#000',
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    imageTimeout: 5000
                }).then(canvas => {
                    // Create properly sized thumbnail maintaining aspect ratio
                    const thumbCanvas = document.createElement('canvas');
                    const maxWidth = 1200;
                    const maxHeight = 1200;
                    
                    let width = canvas.width;
                    let height = canvas.height;
                    
                    // Scale down if needed while maintaining aspect ratio
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    if (height > maxHeight) {
                        width = (width * maxHeight) / height;
                        height = maxHeight;
                    }
                    
                    thumbCanvas.width = width;
                    thumbCanvas.height = height;
                    const ctx = thumbCanvas.getContext('2d');
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, width, height);
                    ctx.drawImage(canvas, 0, 0, width, height);
                    
                    post.thumbnail = thumbCanvas.toDataURL('image/png');
                    localStorage.setItem('pscomixx_feed', JSON.stringify(S.communityFeed.slice(0, 100)));
                    render();
                }).catch(err => {
                    console.log('Thumbnail capture failed:', err);
                    createPlaceholderThumbnail(post);
                });
            } else {
                createPlaceholderThumbnail(post);
            }
        } catch(e) {
            console.log('Thumbnail error:', e);
            createPlaceholderThumbnail(post);
        }
    }
    
    function createPlaceholderThumbnail(post) {
        // Create a canvas-based placeholder thumbnail
        const canvas = document.createElement('canvas');
        canvas.width = 800;
        canvas.height = 1000;
        const ctx = canvas.getContext('2d');
        
        // Background gradient
        const gradient = ctx.createLinearGradient(0, 0, 800, 1000);
        if (post.type === 'card') {
            gradient.addColorStop(0, '#1a1a2e');
            gradient.addColorStop(1, '#0f0f1a');
        } else if (post.type === 'cover') {
            gradient.addColorStop(0, '#1a0a1a');
            gradient.addColorStop(1, '#0a1a2a');
        } else {
            gradient.addColorStop(0, '#111');
            gradient.addColorStop(1, '#000');
        }
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 800, 1000);
        
        // Add icon
        ctx.font = '160px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(post.type === 'card' ? '' : post.type === 'cover' ? '' : '', 400, 440);
        
        // Add text
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 48px sans-serif';
        const title = post.type === 'card' ? (post.cardData?.name || 'Trading Card') :
                      post.type === 'cover' ? (post.coverData?.title || 'Comic Cover') :
                      `${post.pageCount || 1} Page Comic`;
        ctx.fillText(title, 400, 600);
        
        // Add author
        ctx.fillStyle = '#888';
        ctx.font = '32px sans-serif';
        ctx.fillText(`by ${post.author}`, 400, 680);
        
        post.thumbnail = canvas.toDataURL('image/png');
        localStorage.setItem('pscomixx_feed', JSON.stringify(S.communityFeed.slice(0, 100)));
        render();
    }
    
    function likeFeedPost(index) {
        if (S.communityFeed[index]) {
            const post = S.communityFeed[index];
            post.liked = !post.liked;
            post.likes = (post.likes || 0) + (post.liked ? 1 : -1);
            localStorage.setItem('pscomixx_feed', JSON.stringify(S.communityFeed));
            
            // Animate
            if (post.liked) {
                toast('');
            }
            render();
        }
    }
    
    function shareFeedPost(index) {
        const post = S.communityFeed[index];
        if (post) {
            const text = post.isCollab 
                ? `Check out this collab comic! Join with code: ${post.collabCode}`
                : `Check out this comic on PSCoMiXX!`;
            const url = post.isCollab && post.collabCode 
                ? `${window.location.origin}${window.location.pathname}?collab=${post.collabCode}`
                : window.location.href;
            
            if (navigator.share) {
                navigator.share({ title: 'PSCoMiXX Comic', text: text, url: url });
            } else {
                navigator.clipboard.writeText(text + ' ' + url).then(() => toast(' Link copied!')).catch(() => toast(text));
            }
        }
    }
    
    function saveFeedPost(index) {
        if (S.communityFeed[index]) {
            const post = S.communityFeed[index];
            post.saved = !post.saved;
            
            if (post.saved) {
                S.savedPosts.unshift(post);
                toast(' Saved!');
            } else {
                S.savedPosts = S.savedPosts.filter(p => p.id !== post.id);
                toast('Removed from saved');
            }
            
            localStorage.setItem('pscomixx_feed', JSON.stringify(S.communityFeed));
            localStorage.setItem('pscomixx_saved', JSON.stringify(S.savedPosts));
            render();
        }
    }
    
    function viewPost(index) {
        const post = S.communityFeed[index];
        if (post) {
            // For collab posts with active code, offer to join
            if (post.isCollab && post.collabCode) {
                if (confirm(`This is a collab comic! Join with code ${post.collabCode}?`)) {
                    joinCollab(post.collabCode);
                }
            } else {
                toast(' Full post viewer coming soon!');
            }
        }
    }
    
    function shareCollabNative() {
        if (!S.collabSession) return;
        const url = `${window.location.origin}${window.location.pathname}?collab=${S.collabSession.code}`;
        const text = `Join my collab comic "${S.collabSession.name || 'Untitled'}"! Code: ${S.collabSession.code}`;
        
        if (navigator.share) {
            navigator.share({ title: 'Join PSCoMiXX Collab', text: text, url: url });
        } else {
            navigator.clipboard.writeText(url).then(() => toast(' Link copied!')).catch(() => prompt('Share this link:', url));
        }
    }
    
    // ========== SOCIAL RENDER HELPERS ==========
    
    function renderStoryAvatars() {
        return S.following.slice(0, 8).map(u => `
            <div onclick="viewUserProfile('${u.id}')" style="text-align:center;cursor:pointer">
                <div style="width:60px;height:60px;border-radius:50%;background:linear-gradient(45deg,#833ab4,#fd1d1d,#fcb045);padding:2px">
                    <div style="width:100%;height:100%;border-radius:50%;background:#000;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff">${(u.name||'?')[0].toUpperCase()}</div>
                </div>
                <div style="font-size:10px;color:#888;margin-top:4px;max-width:60px;overflow:hidden;text-overflow:ellipsis">${(u.name||'User').split(' ')[0]}</div>
            </div>
        `).join('');
    }
    
    function renderFeedPosts() {
        let posts = S.communityFeed;
        if (S.feedTab === 'following') posts = posts.filter(p => S.following.find(f => f.id === p.authorId));
        if (S.feedTab === 'collabs') posts = posts.filter(p => p.isCollab);
        if (S.feedTab === 'friends') posts = posts.filter(p => S.friends.find(f => f.id === p.authorId));
        
        if (posts.length === 0) {
            const emojis = {collabs: '', friends: '', following: ''};
            const msgs = {following: 'Follow creators to see their posts', collabs: 'No collabs yet', friends: 'Add friends to see their posts'};
            return `<div style="text-align:center;padding:80px 20px;color:#666">
                <div style="font-size:64px;margin-bottom:16px">${emojis[S.feedTab] || ''}</div>
                <h3 style="color:#fff;margin-bottom:8px;font-size:16px">${msgs[S.feedTab] || 'No posts yet'}</h3>
                <button onclick="shareToFeed()" style="margin-top:16px;padding:12px 24px;background:#fff;color:#000;border:none;border-radius:20px;cursor:pointer;font-weight:bold;font-size:13px">Share Your Comic</button>
            </div>`;
        }
        
        return posts.map((post, i) => `
            <div style="border-bottom:1px solid #222;padding-bottom:12px;margin-bottom:8px">
                <div style="padding:10px 16px;display:flex;align-items:center;gap:10px">
                    <div onclick="viewUserProfile('${post.authorId}')" style="width:32px;height:32px;border-radius:50%;background:#333;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold;color:#fff;cursor:pointer">${(post.author||'U')[0].toUpperCase()}</div>
                    <div style="flex:1">
                        <div onclick="viewUserProfile('${post.authorId}')" style="color:#fff;font-weight:600;font-size:13px;cursor:pointer">${post.author||'Creator'}</div>
                        <div style="color:#666;font-size:10px">${post.time||'Just now'}</div>
                    </div>
                    ${post.isCollab ? '<span style="background:#222;color:#fff;padding:4px 8px;border-radius:12px;font-size:10px"> COLLAB</span>' : ''}
                    <button onclick="showPostMenu(${i})" style="background:none;border:none;color:#888;font-size:16px;cursor:pointer"></button>
                </div>
                
                <!-- PANEL THUMBNAIL - Tap to expand -->
                <div onclick="viewPostFullscreen(${i})" ondblclick="likeFeedPost(${i})" style="aspect-ratio:1/1;background:#000;position:relative;cursor:pointer;overflow:hidden">
                    ${post.thumbnail ? 
                        `<img src="${post.thumbnail}" style="width:100%;height:100%;object-fit:cover">` : 
                        `<div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,${post.type==='card'?'#1a1a2e,#0f0f1a':post.type==='cover'?'#1a0a1a,#0a1a2a':'#1a1a1a,#0a0a0a'})">
                            <div style="font-size:48px;margin-bottom:8px">${post.type==='card'?'':post.type==='cover'?'':''}</div>
                            <div style="color:#fff;font-size:14px;font-weight:bold">${post.type==='card'?(post.cardData?.name||'Card'):post.type==='cover'?(post.coverData?.title||'Cover'):(post.pageCount||1)+' Page'+(post.pageCount>1?'s':'')}</div>
                        </div>`
                    }
                    <!-- Tap to expand hint -->
                    <div style="position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,0.8);padding:4px 8px;border-radius:8px;font-size:10px;color:#fff;display:flex;align-items:center;gap:4px">
                        <span></span> Tap to view
                    </div>
                    <!-- Type badge -->
                    <div style="position:absolute;top:8px;left:8px;background:rgba(0,0,0,0.8);padding:4px 8px;border-radius:8px;font-size:10px;color:#fff">${post.type==='card'?' Card':post.type==='cover'?' Cover':' Comic'}</div>
                    ${post.isCollab && post.collabCode ? `<div style="position:absolute;bottom:8px;left:8px;background:#000;color:#fff;padding:6px 10px;border-radius:8px;font-size:10px;cursor:pointer" onclick="event.stopPropagation();joinCollab('${post.collabCode}')"> Join</div>` : ''}
                </div>
                
                <div style="padding:10px 16px;display:flex;align-items:center;gap:16px">
                    <button onclick="likeFeedPost(${i})" style="background:none;border:none;cursor:pointer;font-size:24px">${post.liked?'':''}</button>
                    <button onclick="openComments(${i})" style="background:none;border:none;cursor:pointer;font-size:24px"></button>
                    <button onclick="shareFeedPost(${i})" style="background:none;border:none;cursor:pointer;font-size:24px"></button>
                    <button onclick="saveFeedPost(${i})" style="background:none;border:none;cursor:pointer;font-size:24px;margin-left:auto">${post.saved?'':''}</button>
                </div>
                
                <div style="padding:0 16px;color:#fff;font-weight:600;font-size:12px">${post.likes||0} likes</div>
                
                ${post.caption ? `<div style="padding:4px 16px 0;font-size:12px"><span style="color:#fff;font-weight:600">${post.author}</span><span style="color:#ccc;margin-left:6px">${post.caption}</span></div>` : ''}
                
                <div onclick="openComments(${i})" style="padding:6px 16px 0;color:#888;font-size:12px;cursor:pointer">${(post.commentsList?.length||0) > 0 ? `View all ${post.commentsList.length} comments` : 'Add a comment...'}</div>
            </div>
        `).join('');
    }
    
    // Full screen post viewer
    function viewPostFullscreen(index) {
        S.fullscreenPost = index;
        render();
    }
    
    function closeFullscreenPost() {
        S.fullscreenPost = null;
        render();
    }
    
    function renderFullscreenPost() {
        if (S.fullscreenPost === null || S.fullscreenPost === undefined) return '';
        const post = S.communityFeed[S.fullscreenPost];
        if (!post) return '';
        
        return `
            <div onclick="closeFullscreenPost()" style="position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:10001;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px">
                <!-- Close button -->
                <button onclick="closeFullscreenPost()" style="position:absolute;top:16px;right:16px;background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;width:44px;height:44px;border-radius:50%;cursor:pointer;z-index:10"></button>
                
                <!-- Author info -->
                <div style="position:absolute;top:16px;left:16px;display:flex;align-items:center;gap:10px">
                    <div style="width:36px;height:36px;border-radius:50%;background:#333;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:bold;color:#fff">${(post.author||'U')[0].toUpperCase()}</div>
                    <div>
                        <div style="color:#fff;font-weight:600;font-size:14px">${post.author||'Creator'}</div>
                        <div style="color:#888;font-size:11px">${post.type==='card'?' Trading Card':post.type==='cover'?' Comic Cover':' Comic'}</div>
                    </div>
                </div>
                
                <!-- Full size image -->
                <div onclick="event.stopPropagation()" style="max-width:90vw;max-height:70vh;display:flex;align-items:center;justify-content:center">
                    ${post.thumbnail ? 
                        `<img src="${post.thumbnail}" style="max-width:100%;max-height:70vh;object-fit:contain;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.5)">` :
                        `<div style="width:300px;height:400px;background:linear-gradient(135deg,#1a1a2e,#0f0f1a);border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center">
                            <div style="font-size:64px;margin-bottom:12px">${post.type==='card'?'':post.type==='cover'?'':''}</div>
                            <div style="color:#fff;font-size:18px;font-weight:bold">${post.type==='card'?(post.cardData?.name||'Trading Card'):post.type==='cover'?(post.coverData?.title||'Comic Cover'):(post.pageCount||1)+' Page Comic'}</div>
                        </div>`
                    }
                </div>
                
                <!-- Caption -->
                ${post.caption ? `<div onclick="event.stopPropagation()" style="max-width:500px;text-align:center;margin-top:16px;padding:12px 20px;background:rgba(255,255,255,0.05);border-radius:12px">
                    <span style="color:#ccc;font-size:14px">${post.caption}</span>
                </div>` : ''}
                
                <!-- Actions -->
                <div onclick="event.stopPropagation()" style="display:flex;gap:24px;margin-top:20px">
                    <button onclick="likeFeedPost(${S.fullscreenPost});event.stopPropagation()" style="background:none;border:none;cursor:pointer;font-size:32px">${post.liked?'':''}</button>
                    <button onclick="closeFullscreenPost();openComments(${S.fullscreenPost})" style="background:none;border:none;cursor:pointer;font-size:32px"></button>
                    <button onclick="shareFeedPost(${S.fullscreenPost});event.stopPropagation()" style="background:none;border:none;cursor:pointer;font-size:32px"></button>
                </div>
                
                <div style="color:#fff;font-size:14px;margin-top:12px">${post.likes||0} likes</div>
                
                <!-- Hint -->
                <div style="position:absolute;bottom:20px;color:#666;font-size:12px">Tap anywhere to close</div>
            </div>
        `;
    }
    
    function renderComments() {
        if (S.activePostComments === null) return '<div style="text-align:center;padding:40px;color:#666">Loading...</div>';
        const post = S.communityFeed[S.activePostComments];
        if (!post) return '<div style="text-align:center;padding:40px;color:#666">Post not found</div>';
        const comments = post.commentsList || [];
        
        if (comments.length === 0) {
            return '<div style="text-align:center;padding:40px;color:#666"><div style="font-size:32px;margin-bottom:8px"></div><div>No comments yet</div><div style="font-size:12px;margin-top:4px">Be the first to comment!</div></div>';
        }
        
        return comments.map((c, ci) => `
            <div style="display:flex;gap:12px;margin-bottom:16px">
                <div style="width:32px;height:32px;border-radius:50%;background:#333;display:flex;align-items:center;justify-content:center;font-size:12px;color:#fff;flex-shrink:0">${(c.author||'?')[0].toUpperCase()}</div>
                <div style="flex:1">
                    <div><span style="color:#fff;font-weight:600;font-size:13px">${c.author||'User'}</span><span style="color:#ccc;font-size:13px;margin-left:8px">${c.text}</span></div>
                    <div style="display:flex;gap:16px;margin-top:4px;font-size:11px;color:#666">
                        <span>${c.time}</span>
                        <span onclick="likeComment(${S.activePostComments},${ci})" style="cursor:pointer">${c.likes||0} likes</span>
                        <span onclick="replyToComment(${ci})" style="cursor:pointer">Reply</span>
                    </div>
                </div>
                <button onclick="likeComment(${S.activePostComments},${ci})" style="background:none;border:none;color:#fff;font-size:12px;cursor:pointer">${c.liked?'':''}</button>
            </div>
        `).join('');
    }
    
    function renderMessagesContent() {
        if (S.activeConvo) {
            const convo = S.conversations.find(c => c.id === S.activeConvo);
            const messages = convo?.messages || [];
            return `
                <div style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:8px">
                    ${messages.length === 0 ? '<div style="text-align:center;color:#666;padding:40px">Start the conversation!</div>' : messages.map(m => `
                        <div style="display:flex;justify-content:${m.fromMe ? 'flex-end' : 'flex-start'}">
                            <div style="max-width:70%;padding:10px 14px;border-radius:18px;background:${m.fromMe ? '#0095f6' : '#333'};color:#fff;font-size:14px">${m.text}</div>
                        </div>
                    `).join('')}
                </div>
                <div style="padding:12px 16px;border-top:1px solid #222;display:flex;gap:12px">
                    <input type="text" id="messageInput" placeholder="Message..." style="flex:1;padding:10px 16px;border-radius:20px;border:1px solid #333;background:#111;color:#fff;font-size:14px">
                    <button onclick="sendMessage()" style="padding:10px 20px;background:#0095f6;color:#fff;border:none;border-radius:20px;font-weight:bold;cursor:pointer">Send</button>
                </div>
            `;
        }
        
        if (S.conversations.length === 0) {
            return `<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#666">
                <div style="font-size:48px;margin-bottom:12px"></div>
                <div style="color:#fff;font-size:16px;margin-bottom:8px">No messages yet</div>
                <button onclick="S.activeSheet='new-message';render()" style="margin-top:12px;padding:10px 20px;background:#fff;color:#000;border:none;border-radius:20px;cursor:pointer;font-weight:bold">Start a Chat</button>
            </div>`;
        }
        
        return `<div style="flex:1;overflow-y:auto">
            ${S.conversations.map(c => `
                <div onclick="openChat('${c.id}')" style="display:flex;gap:12px;padding:16px;border-bottom:1px solid #222;cursor:pointer">
                    <div style="width:48px;height:48px;border-radius:50%;background:#333;display:flex;align-items:center;justify-content:center;font-size:18px;color:#fff">${(c.name || '?')[0].toUpperCase()}</div>
                    <div style="flex:1">
                        <div style="color:#fff;font-weight:600;font-size:14px">${c.name}</div>
                        <div style="color:#888;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${c.lastMessage || 'Start chatting!'}</div>
                    </div>
                    ${c.unread ? '<div style="width:8px;height:8px;background:#0095f6;border-radius:50%;align-self:center"></div>' : ''}
                </div>
            `).join('')}
        </div>`;
    }
    
    function renderSuggestedUsers() {
        const users = getSuggestedUsers();
        if (users.length === 0) {
            return '<div style="text-align:center;padding:40px;color:#666">Share your comics to connect with others!</div>';
        }
        return users.map(u => `
            <div style="display:flex;gap:12px;padding:12px 16px;align-items:center">
                <div style="width:44px;height:44px;border-radius:50%;background:#333;display:flex;align-items:center;justify-content:center;font-size:16px;color:#fff">${(u.name || '?')[0].toUpperCase()}</div>
                <div style="flex:1">
                    <div style="color:#fff;font-weight:600;font-size:14px">${u.name}</div>
                    <div style="color:#888;font-size:12px">${u.posts || 0} posts</div>
                </div>
                <button onclick="toggleFollow('${u.id}')" style="padding:8px 16px;background:${S.following.find(f=>f.id===u.id)?'#333':'#0095f6'};color:#fff;border:none;border-radius:8px;font-weight:bold;font-size:12px;cursor:pointer">${S.following.find(f=>f.id===u.id)?'Following':'Follow'}</button>
            </div>
        `).join('');
    }
    
    function renderNotifications() {
        if (S.notifications.length === 0) {
            return `<div style="text-align:center;padding:60px 20px;color:#666">
                <div style="font-size:48px;margin-bottom:12px"></div>
                <div>No notifications yet</div>
            </div>`;
        }
        return S.notifications.map((n, ni) => `
            <div onclick="handleNotification(${ni})" style="display:flex;gap:12px;padding:12px 16px;border-bottom:1px solid #222;background:${n.read?'transparent':'#111'};cursor:pointer">
                <div style="font-size:24px">${n.type==='like'?'':n.type==='comment'?'':n.type==='follow'?'':n.type==='friend'?'':''}</div>
                <div style="flex:1">
                    <div style="color:#fff;font-size:13px">${n.text}</div>
                    <div style="color:#888;font-size:11px;margin-top:2px">${n.time}</div>
                </div>
            </div>
        `).join('');
    }
    
    function renderMyProfile() {
        const myPosts = S.communityFeed.filter(p => p.authorId === S.user.id);
        return `
            <div style="padding:20px;text-align:center;border-bottom:1px solid #222">
                ${S.playerPhoto ? `<img src="${S.playerPhoto}" style="width:80px;height:80px;border-radius:50%;border:2px solid #fff;margin-bottom:12px">` : `<div style="width:80px;height:80px;border-radius:50%;background:#333;margin:0 auto 12px;display:flex;align-items:center;justify-content:center;font-size:28px;color:#fff;border:2px solid #fff">${(S.playerName || 'U')[0].toUpperCase()}</div>`}
                <div style="color:#fff;font-size:16px;font-weight:bold">${S.playerName || 'Guest'}</div>
                <div style="display:flex;justify-content:center;gap:32px;margin-top:16px">
                    <div style="text-align:center"><div style="color:#fff;font-weight:bold;font-size:18px">${myPosts.length}</div><div style="color:#888;font-size:12px">Posts</div></div>
                    <div style="text-align:center"><div style="color:#fff;font-weight:bold;font-size:18px">${S.followers.length}</div><div style="color:#888;font-size:12px">Followers</div></div>
                    <div style="text-align:center"><div style="color:#fff;font-weight:bold;font-size:18px">${S.following.length}</div><div style="color:#888;font-size:12px">Following</div></div>
                </div>
                <div style="display:flex;gap:8px;margin-top:16px;justify-content:center">
                    <button onclick="S.activeSheet='profile';render()" style="padding:8px 24px;background:#333;color:#fff;border:none;border-radius:8px;font-weight:bold;font-size:13px;cursor:pointer">Edit Profile</button>
                    <button onclick="shareProfile()" style="padding:8px 24px;background:#333;color:#fff;border:none;border-radius:8px;font-weight:bold;font-size:13px;cursor:pointer">Share</button>
                </div>
            </div>
            <div style="flex:1;overflow-y:auto;padding:4px">
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:2px">
                    ${myPosts.length === 0 ? '<div style="grid-column:span 3;text-align:center;padding:40px;color:#666">No posts yet</div>' : myPosts.map(p => `
                        <div style="aspect-ratio:1;background:#111;display:flex;align-items:center;justify-content:center;cursor:pointer">
                            ${p.thumbnail ? `<img src="${p.thumbnail}" style="width:100%;height:100%;object-fit:cover">` : '<div style="font-size:32px"></div>'}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    function renderNewMessageContacts() {
        const contacts = [...S.friends, ...S.following].filter((u, i, arr) => arr.findIndex(x => x.id === u.id) === i);
        if (contacts.length === 0) {
            return '<div style="text-align:center;padding:40px;color:#666">Follow people to message them</div>';
        }
        return contacts.map(u => `
            <div onclick="startChat('${u.id}','${u.name}')" style="display:flex;gap:12px;padding:12px 16px;align-items:center;cursor:pointer;border-bottom:1px solid #111">
                <div style="width:44px;height:44px;border-radius:50%;background:#333;display:flex;align-items:center;justify-content:center;font-size:16px;color:#fff">${(u.name || '?')[0].toUpperCase()}</div>
                <div style="flex:1;color:#fff;font-size:14px">${u.name}</div>
            </div>
        `).join('');
    }
    
    function loadCommunityFeed() {
        // Load from Firebase if available
        if (firebaseReady && firebaseDb) {
            firebaseDb.ref('feed').orderByChild('createdAt').limitToLast(50).once('value')
                .then(snap => {
                    if (snap.exists()) {
                        const posts = [];
                        snap.forEach(child => posts.unshift(child.val()));
                        // Merge with local
                        const merged = [...posts, ...S.communityFeed].reduce((acc, post) => {
                            if (!acc.find(p => p.id === post.id)) acc.push(post);
                            return acc;
                        }, []).sort((a,b) => b.createdAt - a.createdAt).slice(0, 50);
                        S.communityFeed = merged;
                        render();
                    }
                })
                .catch(e => console.log('Feed load failed:', e));
        }
    }
    
    // ========== FULL SOCIAL FUNCTIONS ==========
    
    function openComments(postIndex) {
        S.activePostComments = postIndex;
        S.activeSheet = 'comments';
        render();
    }
    
    function postComment() {
        const input = document.getElementById('commentInput');
        const text = input?.value?.trim();
        if (!text || S.activePostComments === null) return;
        
        const post = S.communityFeed[S.activePostComments];
        if (!post) return;
        
        if (!post.commentsList) post.commentsList = [];
        
        const comment = {
            id: 'c_' + Date.now(),
            author: S.playerName || 'Guest',
            authorId: S.user.id,
            text: text,
            time: 'Just now',
            likes: 0,
            liked: false
        };
        
        post.commentsList.push(comment);
        post.comments = post.commentsList.length;
        
        // Save
        localStorage.setItem('pscomixx_feed', JSON.stringify(S.communityFeed));
        
        // Firebase sync
        if (firebaseReady && firebaseDb) {
            firebaseDb.ref('feed/' + post.id + '/commentsList').set(post.commentsList);
            firebaseDb.ref('feed/' + post.id + '/comments').set(post.comments);
        }
        
        // Add notification for post author
        addNotification(post.authorId, 'comment', S.playerName + ' commented on your post');
        
        input.value = '';
        toast(' Comment posted!');
        render();
    }
    
    function likeComment(postIndex, commentIndex) {
        const post = S.communityFeed[postIndex];
        if (!post?.commentsList?.[commentIndex]) return;
        
        const comment = post.commentsList[commentIndex];
        comment.liked = !comment.liked;
        comment.likes = (comment.likes || 0) + (comment.liked ? 1 : -1);
        
        localStorage.setItem('pscomixx_feed', JSON.stringify(S.communityFeed));
        render();
    }
    
    function replyToComment(commentIndex) {
        const input = document.getElementById('commentInput');
        if (input) {
            const post = S.communityFeed[S.activePostComments];
            const comment = post?.commentsList?.[commentIndex];
            if (comment) {
                input.value = '@' + comment.author + ' ';
                input.focus();
            }
        }
    }
    
    // Follow/Unfollow
    function toggleFollow(userId) {
        const existingIndex = S.following.findIndex(f => f.id === userId);
        
        if (existingIndex >= 0) {
            // Unfollow
            S.following.splice(existingIndex, 1);
            toast('Unfollowed');
        } else {
            // Follow - get user info from feed
            const userPost = S.communityFeed.find(p => p.authorId === userId);
            const user = {
                id: userId,
                name: userPost?.author || 'User',
                followedAt: Date.now()
            };
            S.following.push(user);
            toast(' Following ' + user.name);
            
            // Add notification
            addNotification(userId, 'follow', S.playerName + ' started following you');
        }
        
        localStorage.setItem('pscomixx_following', JSON.stringify(S.following));
        
        // Firebase sync
        if (firebaseReady && firebaseDb) {
            firebaseDb.ref('users/' + S.user.id + '/following').set(S.following);
        }
        
        render();
    }
    
    // Friends
    function addFriend(userId) {
        const userPost = S.communityFeed.find(p => p.authorId === userId);
        const friendRequest = {
            id: userId,
            name: userPost?.author || 'User',
            requestedAt: Date.now()
        };
        
        // Add notification to them
        addNotification(userId, 'friend', S.playerName + ' sent you a friend request');
        
        toast(' Friend request sent!');
    }
    
    function acceptFriend(userId) {
        const requestIndex = S.friendRequests.findIndex(r => r.id === userId);
        if (requestIndex >= 0) {
            const friend = S.friendRequests[requestIndex];
            S.friends.push(friend);
            S.friendRequests.splice(requestIndex, 1);
            
            localStorage.setItem('pscomixx_friends', JSON.stringify(S.friends));
            localStorage.setItem('pscomixx_friend_requests', JSON.stringify(S.friendRequests));
            
            addNotification(userId, 'friend', S.playerName + ' accepted your friend request');
            toast(' You are now friends!');
            render();
        }
    }
    
    // Messages
    function openChat(convoId) {
        S.activeConvo = convoId;
        
        // Mark as read
        const convo = S.conversations.find(c => c.id === convoId);
        if (convo) convo.unread = false;
        localStorage.setItem('pscomixx_convos', JSON.stringify(S.conversations));
        
        render();
    }
    
    function startChat(userId, userName) {
        // Check if conversation exists
        let convo = S.conversations.find(c => c.recipientId === userId);
        
        if (!convo) {
            convo = {
                id: 'convo_' + Date.now(),
                recipientId: userId,
                name: userName,
                messages: [],
                lastMessage: '',
                unread: false
            };
            S.conversations.unshift(convo);
            localStorage.setItem('pscomixx_convos', JSON.stringify(S.conversations));
        }
        
        S.activeConvo = convo.id;
        S.activeSheet = 'messages';
        render();
    }
    
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const text = input?.value?.trim();
        if (!text || !S.activeConvo) return;
        
        const convo = S.conversations.find(c => c.id === S.activeConvo);
        if (!convo) return;
        
        convo.messages.push({
            id: 'm_' + Date.now(),
            text: text,
            fromMe: true,
            time: new Date().toLocaleTimeString()
        });
        convo.lastMessage = text;
        
        localStorage.setItem('pscomixx_convos', JSON.stringify(S.conversations));
        
        // Firebase sync
        if (firebaseReady && firebaseDb) {
            firebaseDb.ref('messages/' + convo.recipientId + '/' + convo.id).push({
                from: S.user.id,
                fromName: S.playerName,
                text: text,
                time: Date.now()
            });
        }
        
        input.value = '';
        toast(' Sent');
        render();
    }
    
    // Notifications
    function addNotification(targetUserId, type, text) {
        // For now just store locally, in production this would go to Firebase
        const notif = {
            id: 'n_' + Date.now(),
            type: type,
            text: text,
            time: 'Just now',
            read: false,
            targetUserId: targetUserId
        };
        
        // If it's for us, add to our notifications
        if (targetUserId === S.user.id) {
            S.notifications.unshift(notif);
            localStorage.setItem('pscomixx_notifs', JSON.stringify(S.notifications));
        }
        
        // Firebase - store notification for target user
        if (firebaseReady && firebaseDb) {
            firebaseDb.ref('notifications/' + targetUserId).push(notif);
        }
    }
    
    function handleNotification(index) {
        const notif = S.notifications[index];
        if (notif) {
            notif.read = true;
            localStorage.setItem('pscomixx_notifs', JSON.stringify(S.notifications));
            
            // Navigate based on type
            if (notif.type === 'follow' || notif.type === 'friend') {
                S.activeSheet = 'my-social-profile';
            } else if (notif.type === 'like' || notif.type === 'comment') {
                S.activeSheet = 'social-feed';
            }
            render();
        }
    }
    
    function clearNotifications() {
        S.notifications = [];
        localStorage.setItem('pscomixx_notifs', JSON.stringify(S.notifications));
        toast(' Cleared');
        render();
    }
    
    // Search/Discovery
    function getSuggestedUsers() {
        // Get unique users from feed that we don't follow
        const users = [];
        S.communityFeed.forEach(post => {
            if (post.authorId && post.authorId !== S.user.id && !users.find(u => u.id === post.authorId)) {
                users.push({
                    id: post.authorId,
                    name: post.author || 'User',
                    posts: S.communityFeed.filter(p => p.authorId === post.authorId).length,
                    followers: Math.floor(Math.random() * 100) // Placeholder
                });
            }
        });
        return users.slice(0, 10);
    }
    
    function searchUsers(query) {
        // Filter suggestions based on query
        // For now just re-render, could implement actual search
        render();
    }
    
    // Profile
    function viewUserProfile(userId) {
        S.viewingProfile = userId;
        S.activeSheet = 'view-profile';
        render();
    }
    
    function getViewingProfileName() {
        if (!S.viewingProfile) return 'Profile';
        const post = S.communityFeed.find(p => p.authorId === S.viewingProfile);
        return post?.author || 'User';
    }
    
    function renderViewProfile() {
        if (!S.viewingProfile) return '<div style="padding:40px;text-align:center;color:#666">User not found</div>';
        
        const userId = S.viewingProfile;
        const userPosts = S.communityFeed.filter(p => p.authorId === userId);
        const userInfo = userPosts[0] || {};
        const isFollowing = S.following.find(f => f.id === userId);
        const isFriend = S.friends.find(f => f.id === userId);
        
        let postsGrid = userPosts.length === 0 
            ? '<div style="grid-column:span 3;text-align:center;padding:40px;color:#666">No posts yet</div>' 
            : userPosts.map(p => `
                <div onclick="viewPostDetail('${p.id}')" style="aspect-ratio:1;background:#111;display:flex;align-items:center;justify-content:center;cursor:pointer">
                    ${p.thumbnail ? `<img src="${p.thumbnail}" style="width:100%;height:100%;object-fit:cover">` : '<div style="font-size:32px"></div>'}
                </div>
            `).join('');
        
        return `
            <div style="padding:20px;text-align:center;border-bottom:1px solid #222">
                <div style="width:80px;height:80px;border-radius:50%;background:#333;margin:0 auto 12px;display:flex;align-items:center;justify-content:center;font-size:28px;color:#fff;border:2px solid #fff">${(userInfo.author || 'U')[0].toUpperCase()}</div>
                <div style="color:#fff;font-size:18px;font-weight:bold">${userInfo.author || 'User'}</div>
                <div style="display:flex;justify-content:center;gap:32px;margin-top:16px">
                    <div style="text-align:center"><div style="color:#fff;font-weight:bold;font-size:18px">${userPosts.length}</div><div style="color:#888;font-size:12px">Posts</div></div>
                    <div style="text-align:center"><div style="color:#fff;font-weight:bold;font-size:18px">${Math.floor(Math.random() * 50)}</div><div style="color:#888;font-size:12px">Followers</div></div>
                    <div style="text-align:center"><div style="color:#fff;font-weight:bold;font-size:18px">${Math.floor(Math.random() * 30)}</div><div style="color:#888;font-size:12px">Following</div></div>
                </div>
                <div style="display:flex;gap:8px;margin-top:16px;justify-content:center">
                    <button onclick="toggleFollow('${userId}')" style="padding:10px 32px;background:${isFollowing?'#333':'#0095f6'};color:#fff;border:none;border-radius:8px;font-weight:bold;font-size:14px;cursor:pointer" title="${isFollowing?'Unfollow':'Follow'} this user">${isFollowing ? 'Following' : 'Follow'}</button>
                    <button onclick="startChat('${userId}','${userInfo.author || 'User'}')" style="padding:10px 20px;background:#333;color:#fff;border:none;border-radius:8px;font-weight:bold;font-size:14px;cursor:pointer" title="Send a message">Message</button>
                    <button onclick="addFriend('${userId}')" style="padding:10px 16px;background:${isFriend?'#333':'#222'};color:#fff;border:1px solid #444;border-radius:8px;font-size:14px;cursor:pointer" title="${isFriend?'Already friends':'Add friend'}">${isFriend ? ' Friends' : ' Add Friend'}</button>
                </div>
            </div>
            <div style="flex:1;overflow-y:auto;padding:4px">
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:2px">
                    ${postsGrid}
                </div>
            </div>
        `;
    }
    
    function showUserOptions() {
        const action = prompt('Options:\\n1. Block User\\n2. Report User\\n3. Copy Profile Link\\n4. Cancel', '3');
        if (action === '3') {
            navigator.clipboard.writeText(window.location.href).then(() => toast(' Link copied!'));
        } else if (action === '1') {
            toast('User blocked');
        } else if (action === '2') {
            toast('Report submitted');
        }
    }
    
    function viewPostDetail(postId) {
        const postIndex = S.communityFeed.findIndex(p => p.id === postId);
        if (postIndex >= 0) {
            S.activeSheet = 'social-feed';
            S.viewingProfile = null;
            toast('Scroll to view post');
        }
        render();
    }
    
    function shareProfile() {
        const url = window.location.href;
        if (navigator.share) {
            navigator.share({ title: S.playerName + ' on PSCoMiXX', url: url });
        } else {
            navigator.clipboard.writeText(url).then(() => toast(' Link copied!'));
        }
    }
    
    function showPostMenu(postIndex) {
        const post = S.communityFeed[postIndex];
        if (!post) return;
        
        const isOwn = post.authorId === S.user.id;
        
        if (isOwn) {
            if (confirm('Delete this post?')) {
                S.communityFeed.splice(postIndex, 1);
                localStorage.setItem('pscomixx_feed', JSON.stringify(S.communityFeed));
                
                if (firebaseReady && firebaseDb) {
                    firebaseDb.ref('feed/' + post.id).remove();
                }
                
                toast('Post deleted');
                render();
            }
        } else {
            // Options for other's posts
            const action = prompt('Options:\\n1. Report\\n2. Copy Link\\n3. Cancel', '2');
            if (action === '2') {
                navigator.clipboard.writeText(window.location.href).then(() => toast(' Link copied!'));
            }
        }
    }
    
    // Load notifications from Firebase on init
    function loadNotifications() {
        if (firebaseReady && firebaseDb) {
            firebaseDb.ref('notifications/' + S.user.id).orderByChild('time').limitToLast(20).once('value')
                .then(snap => {
                    if (snap.exists()) {
                        const notifs = [];
                        snap.forEach(child => notifs.unshift(child.val()));
                        S.notifications = [...notifs, ...S.notifications].slice(0, 50);
                        render();
                    }
                });
        }
    }
    
    function toggleLightMode() {
        S.lightMode = !S.lightMode;
        document.body.classList.toggle('light-mode', S.lightMode);
        localStorage.setItem('pscomixx_lightmode', S.lightMode);
        render();
    }

    // Initialize Firebase and then render
    try { initFirebase(); } catch(e) { console.error('Firebase init:', e); }
    try { initLightMode(); } catch(e) {}
    try { checkCollabInURL(); } catch(e) {}
    
    setTimeout(() => {
        try { loadCommunityFeed(); } catch(e) {}
        try { loadNotifications(); } catch(e) {}
    }, 2000);
    
    // Track session start
    try {
        trackEvent('session_start', {
            platform: /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) ? 'mobile' : 'desktop',
            returning_user: !!localStorage.getItem('pscomixx_state')
        });
    } catch(e) {}
    
    // Initial render with fallback
    setTimeout(() => {
        try {
            render();
        } catch(e) {
            console.error('Render failed:', e);
            document.getElementById('app').innerHTML = '<div style="color:#fff;padding:40px;text-align:center"><h2> Error Loading</h2><p style="color:#888">Please reload</p><button onclick="location.reload()" style="margin-top:20px;padding:12px 24px;background:#fff;color:#000;border:none;border-radius:8px;font-weight:bold">Reload</button></div>';
        }
    }, 100);
    </script>
</body>
</html>
